YUI.add("router",function(g,t){function e(){e.superclass.constructor.apply(this,arguments)}var a=g.HistoryHash,r=g.QueryString,_=g.Array,l=g.Lang,n=g.Object,i=g.config.win,s=[],o=[],h="ready";g.Router=g.extend(e,g.Base,{_regexPathParam:/([:*])([\w\-]+)?/g,_regexUrlQuery:/\?([^#]*).*$/,_regexUrlOrigin:/^(?:[^\/#?:]+:\/\/|\/\/)[^\/]*/,initializer:function(t){var e=this;e._html5=e.get("html5"),e._params={},e._routes=[],e._url=e._getURL(),e._setRoutes(t&&t.routes?t.routes:e.get("routes")),e._html5?(e._history=new g.HistoryHTML5({force:!0}),e._historyEvents=g.after("history:change",e._afterHistoryChange,e)):e._historyEvents=g.on("hashchange",e._afterHistoryChange,i,e),e.publish(h,{defaultFn:e._defReadyFn,fireOnce:!0,preventable:!1}),e.once("initializedChange",function(){g.once("load",function(){setTimeout(function(){e.fire(h,{dispatched:!!e._dispatched})},20)})}),s.push(this)},destructor:function(){var t=_.indexOf(s,this);-1<t&&s.splice(t,1),this._historyEvents&&this._historyEvents.detach()},dispatch:function(){return this.once(h,function(){this._ready=!0,this.upgrade()||this._dispatch(this._getPath(),this._getURL())}),this},getPath:function(){return this._getPath()},hasRoute:function(t){return!!this._hasSameOrigin(t)&&(this._html5||(t=this._upgradeURL(t)),t=this.removeQuery(this.removeRoot(t)),!!this.match(t).length)},match:function(e){return _.filter(this._routes,function(t){return-1<e.search(t.regex)})},param:function(t,e){return this._params[t]=e,this},removeRoot:function(t){var e=this.get("root");return t=t.replace(this._regexUrlOrigin,""),"/"===(t=e&&0===t.indexOf(e)?t.substring(e.length):t).charAt(0)?t:"/"+t},removeQuery:function(t){return t.replace(/\?.*$/,"")},replace:function(t){return this._queue(t,!0)},route:function(t,e){e=_.flatten(_(arguments,1,!0));var r=[];return this._routes.push({callbacks:e,keys:r,path:t,regex:this._getRegex(t,r),callback:e[0]}),this},save:function(t){return this._queue(t)},upgrade:function(){if(!this._html5)return!1;var t=this._getHashPath();return!!t&&(this.once(h,function(){this.replace(t)}),!0)},_decode:function(t){return decodeURIComponent(t.replace(/\+/g," "))},_dequeue:function(){var t,e=this;return YUI.Env.windowLoaded?(t=o.shift())?t():this:(g.once("load",function(){e._dequeue()}),this)},_dispatch:function(r,t,e){var n,i,s,a,o=this,h=o._decode,u=o.match(r),c=[];return o._dispatching=o._dispatched=!0,u&&u.length?(s=o._getRequest(r,t,e),a=o._getResponse(s),s.next=function(t){var e;t?"route"===t?(c=[],s.next()):g.error(t):(e=c.shift())?("string"==typeof e&&((e=o[t=e])||g.error("Router: Callback not found: "+t,null,"router")),s.pendingCallbacks=c.length,e.call(o,s,a,s.next)):(e=u.shift())&&(c=e.callbacks.concat(),n=_.map(e.regex.exec(r)||[],function(t){return t&&h(t)||""}),i=!0,n.length===e.keys.length+1?(n=n.slice(1),s.params=_.hash(e.keys,n),i=_.every(e.keys,function(t,e){var r=o._params[t],e=n[e];return!r||!e||"string"!=typeof e||!(!1===(e=r instanceof RegExp?r.exec(e):r.call(o,e,t))||!l.isValue(e))&&(s.params[t]=e,!0)})):s.params=n.concat(),s.pendingRoutes=u.length,i?s.next():s.next("route"))},s.next(),o._dispatching=!1,o._dequeue()):(o._dispatching=!1,o)},_getHashPath:function(t){return(t=t||a.getHash())&&"/"===t.charAt(0)?this._joinURL(t):""},_getOrigin:function(){var t=g.getLocation();return t.origin||t.protocol+"//"+t.host},_getParams:function(){return g.merge(this._params)},_getPath:function(){var t=!this._html5&&this._getHashPath()||g.getLocation().pathname;return this.removeQuery(this.removeRoot(t))},_getPathRoot:function(){var t=g.getLocation().pathname;return"/"===t.charAt(t.length-1)?t:((t=t.split("/")).pop(),t.join("/")+"/")},_getQuery:function(){var t,e,r=g.getLocation();return this._html5?r.search.substring(1):(e=(t=a.getHash()).match(this._regexUrlQuery),t&&e?e[1]:r.search.substring(1))},_getRegex:function(t,n){return t instanceof RegExp?t:"*"===t?/.*/:(t=t.replace(this._regexPathParam,function(t,e,r){return r?(n.push(r),"*"===e?"(.*?)":"([^/#?]*)"):"*"===e?".*":t}),new RegExp("^"+t+"$"))},_getRequest:function(t,e,r){return{path:t,query:this._parseQuery(this._getQuery()),url:e,src:r}},_getResponse:function(t){function e(){return t.next.apply(this,arguments)}return e.req=t,e},_getRoutes:function(){return this._routes.concat()},_getURL:function(){var t=g.getLocation().toString();return t=!this._html5?this._upgradeURL(t):t},_hasSameOrigin:function(t){t=(t&&t.match(this._regexUrlOrigin)||[])[0];return!(t=t&&0===t.indexOf("//")?g.getLocation().protocol+t:t)||t===this._getOrigin()},_joinURL:function(t){var e=this.get("root");return"/"===(t=this.removeRoot(t)).charAt(0)&&(t=t.substring(1)),e&&"/"===e.charAt(e.length-1)?e+t:e+"/"+t},_normalizePath:function(t){var e,r,n,i,s,a,o="/";if(!t||t===o)return o;for(a=[],e=0,r=(i=t.split(o)).length;e<r;++e)".."===(s=i[e])?a.pop():s&&a.push(s);return(n=o+a.join(o))!==o&&t.charAt(t.length-1)===o&&(n+=o),n},_parseQuery:r&&r.parse?r.parse:function(t){for(var e,r=this._decode,n=t.split("&"),i=0,s=n.length,a={};i<s;++i)(e=n[i].split("="))[0]&&(a[r(e[0])]=r(e[1]||""));return a},_queue:function(){var t=arguments,e=this;return o.push(function(){return e._html5?g.UA.ios&&g.UA.ios<5?e._save.apply(e,t):setTimeout(function(){e._save.apply(e,t)},1):(e._dispatching=!0,e._save.apply(e,t)),e}),this._dispatching?this:this._dequeue()},_resolvePath:function(t){return t?("/"!==t.charAt(0)&&(t=this._getPathRoot()+t),this._normalizePath(t)):g.getLocation().pathname},_resolveURL:function(t){var e,r,n=t&&t.match(this._regexURL);return n?(r=n[1],e=n[2],t=n[3],n=n[4],r?(r=0===r.indexOf("//")?g.getLocation().protocol+r:r)+(e||"/")+(t||"")+(n||""):(r=this._getOrigin()+this._resolvePath(e),e||t?r+(t||"")+(n||""):r+((t=this._getQuery())?"?"+t:"")+(n||""))):g.getLocation().toString()},_save:function(t,e){var r,n,i,s="string"==typeof t;return s&&!this._hasSameOrigin(t)?g.error("Security error: The new URL must be of the same origin as the current URL."):(s&&(t=this._joinURL(t)),this._ready=!0,this._html5?this._history[e?"replace":"add"](null,{url:t}):(r=g.getLocation().pathname,n=this.get("root"),i=a.getHash(),s||(t=i),(t=n===r||n===this._getPathRoot()?this.removeRoot(t):t)===i?g.Router.dispatch():a[e?"replaceHash":"setHash"](t))),this},_setParams:function(t){return this._params={},n.each(t,function(t,e){this.param(e,t)},this),g.merge(this._params)},_setRoutes:function(t){return this._routes=[],_.each(t,function(t){var e=t.callbacks||t.callback;this.route(t.path,e)},this),this._routes.concat()},_upgradeURL:function(t){if(!this._hasSameOrigin(t))return t;var e,r=(t.match(/#(.*)$/)||[])[1]||"",n=g.HistoryHash.hashPrefix;return(r=n&&0===r.indexOf(n)?r.replace(n,""):r)&&(e=this._getHashPath(r))?this._resolveURL(e):t},_afterHistoryChange:function(t){var e=this,r=t.src,n=e._url,t=e._getURL();e._url=t,("popstate"!==r||e._ready&&n.replace(/#.*$/,"")!==t.replace(/#.*$/,""))&&e._dispatch(e._getPath(),t,r)},_defReadyFn:function(t){this._ready=!0}},{NAME:"router",ATTRS:{html5:{valueFn:function(){return g.Router.html5},writeOnce:"initOnly"},params:{value:{},getter:"_getParams",setter:"_setParams"},root:{value:""},routes:{value:[],getter:"_getRoutes",setter:"_setRoutes"}},html5:g.HistoryBase.html5&&(!g.UA.android||3<=g.UA.android),_instances:s,dispatch:function(){for(var t,e=0,r=s.length;e<r;e+=1)(t=s[e])&&t._dispatch(t._getPath(),t._getURL())}}),g.Controller=g.Router},"3.12.0",{optional:["querystring-parse"],requires:["array-extras","base-build","history"]});
