define(["./../../desktop/components/helper","local/common/components/nsglibCommon"],function(t,n){function e(e){this.env="PROD",this.ready=!1,this.allowedEnvironments=["PROD","DEV"],this.config={system:t.getSystem(),browser:t.getBrowser(),messagingSenderId:"211794955562",firebaseeUrl:"https://www.gstatic.com/firebasejs/4.8.1/firebase.js",DEV:{host:"onet_dev",defaultTopics:[{displayName:"Pilne",codeName:"onet_dev_pilne"}]},PROD:{host:"onet.pl",defaultTopics:[{displayName:"Pilne",codeName:"onet.pl_pilne"}]}},this.topics=null,this.watchers={},this.messaging=null;try{this.config=Object.assign(this.config,e)}catch(e){}this.setStoredEnv(),n.push.getPushDevMode()&&this.setEnv("DEV"),this.synchronizeEnvs()}return e.prototype.saveTokenToLocalStorage=function(e){return!!e&&(t.localStorage.setItem("sg.push.token",e),!0)},e.prototype.getTokenFromLocalStorage=function(){return t.localStorage.getItem("sg.push.token")},e.prototype.setEnv=function(e){e&&this.getEnv()!==e&&-1<this.allowedEnvironments.indexOf(e)&&this.config[e]&&(this.env=e)},e.prototype.getEnv=function(){return this.env},e.prototype.getStoredEnv=function(){return t.localStorage.getItem("sg.push.enviroment")},e.prototype.setStoredEnv=function(){this.getStoredEnv()||t.localStorage.setItem("sg.push.enviroment",this.getEnv())},e.prototype.resetStoredEnv=function(){t.localStorage.setItem("sg.push.enviroment",""),this.setStoredEnv()},e.prototype.synchronizeEnvs=function(){this.getStoredEnv()!==this.getEnv()&&(this.topics=null,this.clearStoredData(),this.resetStoredEnv())},e.prototype.getHostFormConfig=function(){var e=this.getEnv();return!(!this.config[e]||!this.config[e].host)&&this.config[e].host},e.prototype.isDevMode=function(){return"DEV"===this.getEnv()},e.prototype.on=function(e,t){e&&"function"==typeof t&&(this.watchers[e]||(this.watchers[e]=[]),this.watchers[e].push(t))},e.prototype.fire=function(e){var t;if(e&&this.watchers[e]){var o=0;for(this.watchers[e].length;t=this.watchers[e][o];o++)try{t.apply(this,arguments)}catch(e){console.error(e)}}},e.prototype.checkBrowserSupport=function(){var o=this.config.system,n=this.config.browser;return new Promise(function(t){if(window.navigator&&navigator.serviceWorker&&"PushManager"in window)if(!0===("Windows"===o&&("firefox"===n||"chrome"===n)||"MacOsX"===o&&("firefox"===n||"chrome"===n)||"Android"===o&&("firefox"===n||"chrome"===n)&&window.enablePush)){try{if(localStorage.setItem("sg.push.ls.test","ok"),"ok"!==localStorage.getItem("sg.push.ls.test"))return void t(!1)}catch(e){return void t(!1)}var e;"chrome"===n?(e=window.RequestFileSystem||window.webkitRequestFileSystem)?e(window.TEMPORARY,100,function(e){t(!0)},function(e){t(!1)}):t(!1):t(!0)}else t(!1);else t(!1)})},e.prototype.saveSubscribedTopicsToLocalStorage=function(e){e&&t.localStorage.setItem("sg.push.notificationTopics",JSON.stringify(e))},e.prototype.checkMigrationStatus=function(){return t.localStorage.getItem("sg.pushTokenStatus")&&"sent"===t.localStorage.getItem("sg.pushTokenStatus")},e.prototype.initFirebase=function(e){e&&(0===firebase.apps.length?(firebase.initializeApp({messagingSenderId:this.config.messagingSenderId}),this.messaging=firebase.messaging(),this.messaging.useServiceWorker(e)):messaging=firebase.messaging(firebase.apps[0]))},e.prototype.runFirebaseApp=function(){var o=this;navigator.serviceWorker.getRegistration().then(function(e){o.initFirebase(e),o.messaging.onTokenRefresh(function(){require(["local/common/push/tokenApi"],function(e){e.refreshToken()})}),o.messaging.onMessage(function(t){require(["local/common/push/notificationHandler"],function(e){e(t),o.fire("onMessage",t)})}),o.messaging.getToken().then(function(e){e?o.callOnReady(e):console.log("Messaging: Token not returned from firebase.")}).catch(function(e){console.warn(e)})})},e.prototype.clearStoredData=function(){t.localStorage.setItem("sg.push.notificationTopics","")},e.prototype.callOnReady=function(e){var o=this;function n(){o.ready=!0,o.fire("onReady")}e?(this.token=e,require(["local/common/push/topics"],function(t){o.getTokenFromLocalStorage()&&o.getTokenFromLocalStorage()===o.token&&t.getSubscribedTopics()?n():require(["local/common/push/pushPlatformApi"],function(e){e.sendTokenToServer(t.getSubscribedTopics()).then(function(e){o.saveTokenToLocalStorage(o.token),n()})})})):this.fire("onError")},e.prototype.run=function(){var t=this;function o(){var e="mobile"===n.ress.getRessVersion()?"/push-mob-service-worker4.js?V=450":"/push-service-worker4.js?V=450";navigator.serviceWorker.register(e,{scope:"/"}).then(function(){t.fire("onRegister"),t.runFirebaseApp()},function(e){console.error("Service worker registration failed: "+e.message)})}this.checkBrowserSupport().then(function(e){e&&require([t.config.firebaseeUrl],o)})},e});
