define(["OK/logger","OK/utils/vanilla","OK/utils/dom","OK/utils/delegate"],(function(e,t,i,s){"use strict";var n="ShortcutMenuReact",h=null,o=document.createElement("div");o.id="hook_Block_"+n,document.body.appendChild(o),OK.hookModel.captureBlockHook("body",o),o.addEventListener("change",(function(){h&&h.visible()&&h.positingElement()}));var l={};function a(e){this.hookId=e,this.stopClick=!0,this.ajaxRequest=null,this.showTimeout=null,this.hideTimeout=null,this.menuElement=null,this.cacheable=!0,this.loaded=!1,this.showOnClick=!0,this._hoverIn=!1}return a.getActive=function(){return h},a.setReactComponent=function(e,t){l[e]=t},a.removeReactComponent=function(e){delete l[e]},a.getReactComponent=function(e){return l[e]},a.prototype={activate:function(t){if(this.element=t,this.holder=this.getHolder(),this.blockId=this.element.getAttribute("data-blockid"),this.block=document.getElementById("hook_Block_"+this.blockId),this.inplace=this.element.getAttribute("data-inplace"),this.loaded=this.element.getAttribute("data-loaded"),this.showDelay=parseInt(this.element.getAttribute("data-show"),10)||300,this.hideDelay=parseInt(this.element.getAttribute("data-hide"),10)||100,this.cacheable=!this.element.getAttribute("data-nocache"),this.saveChanges=this.element.getAttribute("data-save-changes"),this.direction=this.element.getAttribute("data-direction"),this.position=this.element.getAttribute("data-position")||"center",this.showOnClick=this.element.getAttribute("data-onClick"),this.isShowImmediately=this.element.getAttribute("data-showImmediately"),this.showImmediatelySelector=this.element.getAttribute("data-showImmediatelySelector"),this.relatedMenu=this.getRelatedMenu(),this.hideOnClick=this.element.getAttribute("data-hideOnClick"),this.hideOnScroll=this.element.getAttribute("data-hideOnScroll"),this.ignoreDoubleHoverIn=this.element.getAttribute("data-ignore-double-hover-in"),!this.holder)return e.error("asm","noholder"),void e.success("asm","noholder",this.buildParamFingerprint());if(this.handlers={},this.boundAjaxFail=this.ajaxFail.bind(this),this.boundAjaxDone=this.ajaxDone.bind(this),this.holderDelegate=new s(this.holder),OK.device.isTouch){this.holderDelegate.on("touchstart",this.holderTouchStartListener);var n=this.holder.getElementsByTagName("a")[0];n||(n=i.traverseParents(this.holder,(function(e){return"A"===e.tagName.toUpperCase()}),document.body,!0)),n&&(this.linkDelegate=new s(n),this.linkDelegate.on("touchstart",this.touchHandle.bind(this),!0))}var h="1"===this.element.getAttribute("data-delegate-hover");h?this.holderDelegate.on("mouseleave",".js-sc-target",this.hoverOutListener.bind(this),!0):this.holderDelegate.on("mouseleave",this.hoverOutListener.bind(this)),this.showOnClick?this.oneClickListener=this.addOneTimeListener(this.holder,"click",this.showMenu):(h?this.holderDelegate.on("mouseenter",".js-sc-target",this.hoverInListener.bind(this),!0):this.holderDelegate.on("mouseenter",this.hoverInListener.bind(this)),this.hideOnClick&&this.holderDelegate.on("click",this.hoverOutListener.bind(this))),this.inplace&&this.loaded&&this.initListeners(this.getBlock()),this.isShowImmediately&&this.showImmediately()},deactivate:function(){this.holder&&(this.ajaxClose(),this.hide(),this.removeOneTimeListener(this.oneClickListener),this.removeOneTimeListener(this.oneScrollListener),this.removeOneTimeListener(this.oneBodyTouchListener),this.removeOneTimeListener(this.oneImmediatelyHandler),this.holderDelegate.destroy(),this.linkDelegate&&this.linkDelegate.destroy(),this.shortcutMenuDelegate&&this.shortcutMenuDelegate.destroy(),this.tmpReactionsActiveInstanceListener=null)},buildParamFingerprint:function(){var e=[this.inplace,this.loaded,this.cacheable,this.showOnClick,this.hideOnClick,this.hideOnScroll],t="";return e.forEach((function(e){t+=(1*!!e).toString()})),t},hoverInListener:function(e){this.ignoreDoubleHoverIn&&this._hoverIn||OK.device.isTouch&&e||e&&i.parent(e.target,"js-private-klass",null,!0)||(this._hoverIn=!0,this.clearHideTimeout(),this.showTimeout||this.visible()||(this.showTimeout=setTimeout(this.showMenu.bind(this),this.showDelay)))},checkAfterTmpReactionsDisabled:function(){this._hoverIn&&(this._hoverIn=!1,this.hoverInListener())},hoverOutListener:function(){this._hoverIn=!1,this.clearShowTimeout(),this.ajaxClose(),this.hideTimeout||h!==this||(this.hideTimeout=setTimeout(this.hideMenu.bind(this),this.hideDelay))},menuElementHoverInListener:function(){this.menuElementHoverInListenerCalled=!0,this.hideTimeout&&(this.hideTimeout=clearTimeout(this.hideTimeout))},menuElementLinkClickListener:function(e){i.parent(e.target,"js-doNotHide",this.block)||this.menuElementClickListener()},menuElementClickListener:function(){!0===this.hideTimeout&&(this.hideTimeout=null),this.hoverOutListener()},holderTouchStartListener:function(e){e.stopPropagation()},hide:function(){this.clearShowTimeout(),this.clearHideTimeout(),this.menuElement&&this.hideMenu()},getHolder:function(){var e=this.element.getAttribute("data-holder");return e?document.getElementById(e):this.element.previousElementSibling},getRelatedMenu:function(){var e,t=this.element.getAttribute("data-related");return t&&(e=OK.hookModel.getHookById(t)).getInstance?e.getInstance():null},getBlock:function(){return this.inplace?this.block:o},getHtml:function(){if(!this.block)return"";var e=this.block.innerHTML;return this.inplace&&this.cacheable||(OK.hookModel.setHookContent(this.blockId,""),this.cacheable&&(this.block.innerHTML=e)),e},initBlock:function(){if(this.element&&!this.block){for(var e=Array.prototype.slice.call(this.element.children),t=null,i=0;i<e.length;i++)if(e[i].classList.contains("posR")){t=e[i];break}if(t)this.block=t;else{var s=document.createElement("div");s.id="hook_Block_"+this.blockId,s.className="posR",this.element.appendChild(s),this.block=s,OK.hookModel.captureBlockHook(this.hookId,s)}}},initListeners:function(e){this.shortcutMenuDelegate=new s(e),this.shortcutMenuDelegate.on("click",".sc-menu a",this.menuElementLinkClickListener.bind(this)),this.shortcutMenuDelegate.on("click",".sc-menu .js-hide",this.menuElementClickListener.bind(this)),this.shortcutMenuDelegate.on("click",".js-forceHide",this.hideMenu.bind(this)),this.shortcutMenuDelegate.on("mouseenter",this.menuElementHoverInListener.bind(this)),this.shortcutMenuDelegate.on("mouseleave",this.hoverOutListener.bind(this)),OK.device.isTouch&&this.shortcutMenuDelegate.on("touchstart",this.holderTouchStartListener.bind(this))},showMenu:function(){if(clearTimeout(this.hideTimeout),this.showTimeout=null,!this.tmpReactionsDisabled){if(this.relatedMenu&&this.relatedMenu.hide&&this.relatedMenu.hide(),h){if(this.visible())return;h.hide()}if(this.showOnClick&&(this.removeOneTimeListener(this.oneClickListener),this.oneClickListener=this.addOneTimeListener(this.holder,"click",this.hideMenu)),this.hideOnScroll){var s=/(auto|scroll)/,n=i.traverseParents(this.element,(function(e){var t=window.getComputedStyle(e);return s.test(t.overflow+t.overflowY+t.overflowX)&&e.scrollHeight>e.clientHeight}));n=n||window,this.oneScrollListener=this.addOneTimeListener(n,"scroll",this.hoverOutListener)}if(this.showTimeout=null,OK.device.isTouch&&(this.oneBodyTouchListener=this.addOneTimeListener(document.body,"touchstart",this.hoverOutListener)),!this.ajaxRequest)if(this.startTime=Date.now(),this.loaded){var o=this.getHtml();this.processHTML(o,void 0,!this.inplace||!this.cacheable),e.success("asm","show","cache")}else{var l=this.element.getAttribute("data-url");this.ajaxRequest=t.ajax({url:l,dataType:"html"},(function(){})),this.ajaxRequest.then(this.boundAjaxDone,this.boundAjaxFail)}}},showImmediately:function(){var e=this;e.showImmediatelySelector&&setTimeout((function(){var t=e.showImmediatelySelector+":hover";e.showImmediatelyElement=i.traverseParents(e.holder,(function(e){return e.matches(t)})),e.showImmediatelyElement.matches(t)&&(e.showMenu(),e.oneImmediatelyHandler=this.addOneTimeListener(e.showImmediatelyElement,"mouseleave",(function(){setTimeout((function(){e.menuElementHoverInListenerCalled||e.hideMenu()}),e.hideDelay)})))}),1)},visible:function(){return h===this},hideMenu:function(){this.clearShowTimeout(),(this.visible()||this.showOnClick)&&(this.hideTimeout=null,this.stopClick=!0,this.showOnClick&&(this.removeOneTimeListener(this.oneClickListener),this.oneClickListener=this.addOneTimeListener(this.holder,"click",this.showMenu)),this.ajaxClose((function(){e.success("asm","ajax","to")})),this.menuElement&&(this.menuElement.classList.add("sc-menu__hidden"),this.getHtml(),this.saveChanges&&!this.inplace&&this.loaded&&this.cacheable&&(this.initBlock(),this.block.innerHTML=o.innerHTML),OK.hookModel.setHookContent(n,""),this.menuElement=null),this.holder.classList.remove("__vis"),this.shortcutMenuDelegate&&!this.cacheable&&this.shortcutMenuDelegate.off(),h=null,this.tmpReactionsActiveInstanceListener&&this.tmpReactionsActiveInstanceListener())},touchHandle:function(e){if(this.stopClick)return e.preventDefault(),e.stopPropagation(),this.stopClick=!1,this.showOnClick||this.hoverInListener(),!1;this.hoverOutListener()},getOffset:function(e){var t=e.getBoundingClientRect();return{left:t.left+window.pageXOffset,top:t.top+window.pageYOffset}},positingElement:function(){var e,t=i.outerSize(this.holder,!1,!0),s=this.inplace?{top:0,left:0}:this.getOffset(this.holder),n=i.outerSize(this.holder,!0,!0),h=i.outerSize(this.menuElement,!0,!0);"center"!==this.position&&"auto"!==this.position&&this.menuElement.classList.add("__noarrow");var o=i.outerSize(this.menuElement,!1,!0);e="top"===this.direction?this.getOffset(this.holder).top-window.pageYOffset-90>o:"bottom"!==this.direction&&window.innerHeight-t-this.holder.getBoundingClientRect().top<o;var l,a=s.top,r=[];e?(this.menuElement.classList.add("sc-menu__top"),this.inplace?(l=a+t,r.push("top: auto; bottom: "+Math.round(l)+"px;")):(a-=o,r.push("bottom: auto; top: "+Math.round(a)+"px;"))):(this.menuElement.classList.remove("sc-menu__top"),this.inplace||(a+=t),r.push("bottom: auto; top: "+Math.round(a)+"px;"));var u=Math.round(s.left-(h-n)),c=Math.round(s.left),d=Math.round(s.left+(n-h)/2);switch(this.position){case"left":r.push("left: "+u+"px;");break;case"right":r.push("left: "+c+"px;");break;case"auto":window.innerWidth-OK.scrollBar.width>s.left+h?(r.push("left: "+c+"px;"),this.menuElement.classList.remove("__right"),this.menuElement.classList.add("__left")):(r.push("left: "+u+"px;"),this.menuElement.classList.add("__right"),this.menuElement.classList.remove("__left"));break;default:r.push("left: "+d+"px;")}this.menuElement.setAttribute("style",r.join(""))},processHTML:function(e,s,l){var a,r=[];s&&s.getResponseHeader(OK.navigation.HEADER)&&(r=s.getResponseHeader(OK.navigation.HEADER).split(",")),this.inplace?(this.initBlock(),r[0]=this.blockId,a=this.block):(r[0]=n,a=o),l&&(t.updateBlocks(e,r),this.initListeners(this.getBlock())),this.menuElement=i.firstByClass(a,"sc-menu"),this.positingElement(),this.menuElement.classList.remove("sc-menu__hidden"),this.holder.classList.add("__vis"),h=this,this.tmpReactionsActiveInstanceListener&&this.tmpReactionsActiveInstanceListener()},ajaxDone:function(t){e.duration("asm",Date.now()-this.startTime,"ajax");var i=t.response;i&&0!==i.split(OK.navigation.SPLITER)[0].length?(e.success("asm","show","ajax"),this.cacheable&&this.element&&(this.loaded=!0,this.initBlock(),this.block.innerHTML=i.split(OK.navigation.SPLITER)[0]),this.processHTML(i,t.xhr,!0),this.menuShownListener&&this.menuShownListener(),this.ajaxClose()):e.success("asm","ajax","e")},ajaxFail:function(){this.ajaxClose((function(){e.error("asm","ajax")}))},ajaxClose:function(e){this.ajaxRequest&&(this.ajaxRequest.xhr.abort(),this.ajaxRequest=null,"function"==typeof e&&e())},isWaitingBeforeShow:function(){return this.showTimeout||this.ajaxRequest},abortWaitingBeforeShow:function(){this.clearShowTimeout(),this.ajaxClose()},clearShowTimeout:function(){this.showTimeout&&(this.showTimeout=clearTimeout(this.showTimeout))},clearHideTimeout:function(){this.hideTimeout&&(this.hideTimeout=clearTimeout(this.hideTimeout))},addOneTimeListener:function(e,t,i){var s=this,n=function t(n){e.removeEventListener(n.type,t),i.call(s,n)};return e.addEventListener(t,n),{element:e,type:t,handler:n}},removeOneTimeListener:function(e){e&&(e.element.removeEventListener(e.type,e.handler),e=null)}},a}));