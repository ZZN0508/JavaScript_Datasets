define(["PTS/webpush","OK/logger","OK/utils/utils","OK/uuid","OK/utils/vanilla"],(function(e,n,t,r,i){"use strict";var o="webpush-device-id",s="webpush-endpoint",u="notification_enabled_messenger",a="DEFAULT",c="DENIED",l="GRANTED",f="SUBSCRIBED",p="UNSUBSCRIBED",d="/web-api/webpush/sync",b=null,h=!1,g=null;function w(){return"PushManager"in window&&"serviceWorker"in navigator&&window.Notification&&"localStorage"in window}function v(){return w()&&h}function S(e){return e=e||"unknown",O("Unsubscribe from notifications"),w()?k().then((function(t){return null!==t&&t.unsubscribe().then(O),"messages"!==e&&T(!1),n.success("webpush."+e+".unsubscribe"),P(),A(p,t,e,!0)}),(function(t){throw n.error("webpush."+e+".unsubscribe"),O(t),t})):Promise.reject("Push API is not supported")}function m(){return Notification?"denied"===Notification.permission?Promise.resolve(c):"default"===Notification.permission?Promise.resolve(a):k().then((function(e){return e?f:l})):Promise.resolve(c)}function y(){return O("Register service worker"),navigator.serviceWorker.register(swPath).then((function(e){if(e.installing?O("Service worker installing. scope = "+e.scope):e.waiting?O("Service worker installed"):e.active&&O("Service worker active"),!e.showNotification)throw n.error("webpush.support.showNotifications"),new Error("Notifications aren't supported on service workers.");if("denied"===Notification.permission)throw n.error("webpush.denied"),new Error("The user has blocked notifications.");if(!("PushManager"in window))throw n.error("webpush.support.pushManager"),new Error("Push messaging isn't supported");return navigator.serviceWorker.ready}))}function N(e){return O("Subscribe to notifications"),e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:t.urlBase64ToUint8Array(b)})}function k(){var e=navigator.serviceWorker.getRegistration();return e?e.then((function(e){return e&&e.pushManager?e.pushManager.getSubscription():null})):Promise.resolve()}function A(e,n,t,r){O("Sync subscription");var o={status:e,place:t||"unknown",userAction:r};return n&&(o.subscription={deviceId:U(),endpoint:n.endpoint,auth:E(n,"auth"),p256dh:E(n,"p256dh")}),i.ajax({method:"POST",url:d,headers:{"Content-Type":"application/json"},data:JSON.stringify(o)}).then((function(){var t;return n&&(t=n.endpoint,I(s,t)),e}))}function P(){B(s)}function T(e){I(u,e?"1":"0")}function E(e,n){return btoa(String.fromCharCode.apply(null,new Uint8Array(e.getKey(n))))}function U(){var e=D(o);return e||(e=r.generate(),I(o,e)),e}function D(e,t){if(!localStorage)return null;try{return localStorage.getItem(e)}catch(e){return n.error("webpush.localStorage-get-"+(e.name||""+e)),t}}function I(e,t){if(localStorage)try{localStorage.setItem(e,t)}catch(e){n.error("webpush.localStorage-set-"+(e.name||""+e))}}function B(e){if(localStorage)try{localStorage.removeItem(e)}catch(e){n.error("webpush.localStorage-remove-"+(e.name||""+e))}}function O(){if(OK.fn.isDebug())if(arguments[0]instanceof Error)console.error.apply(console,arguments);else{var e=Array.prototype.slice.apply(arguments);e.unshift("[webpush]"),console.log.apply(console,e)}}return{STATUS_DEFAULT:a,STATUS_GRANTED:l,STATUS_DENIED:c,STATUS_SUBSCRIBED:f,STATUS_UNSUBSCRIBED:p,isSupported:w,isEnabled:v,activate:function(e){if(w()){h="true"===e.getAttribute("data-service-worker-is-enabled"),b=e.getAttribute("data-application-server-key"),g=e.getAttribute("data-server-status");var t="true"===e.getAttribute("data-message-notifications-enabled");if("true"===e.getAttribute("data-extended-settings-enabled")&&g===f&&T(t),B("webpush-activated"),!h)return O("Service worker is disabled"),void S().catch(O);m().then((function(e){return e===f?(O("Subscription is active"),k().then((function(e){g===f&&D(s)===e.endpoint||(O("Subscription has been changed"),n.success("webpush.subscription-changed"),A(f,e))}))):e!==l?(O("Permission has been revoked"),P(),T(!1),n.success("webpush.subscription-revoked"),g!==e?A(e):void 0):void(g!==e&&A(e))}),O)}},deactivate:function(){},subscribe:function(t){return t=t||"unknown",v()?m().then((function(r){if(r===c)throw new Error("User revoked permissions");return r===f?r:function(){if(Notification){if("default"===Notification.permission)return new Promise((function(e,t){Notification.requestPermission((function(r){"granted"===r?(n.success("webpush.request.granted"),e(l)):(n.success("webpush.request.denied"),t(c))}))}));if("granted"===Notification.permission)return Promise.resolve(l)}return Promise.reject(c)}().then(y).then(N).then((function(r){return"messages"!==t&&(T(!0),function(){if(!Notification)return;var n=e["notification.enabled.title"],t=e["notification.enabled.body"],r=OK.cnst.staticUrl+"res/i/html5_notif_icon.png";new Notification(n,{body:t,icon:r,tag:"messenger-enabled"})}()),n.success("webpush."+t+".subscribe"),A(f,r,t,!0)}),(function(){n.error("webpush."+t+".subscribe")}))})):Promise.reject("Module is disabled")},unsubscribe:S,getStatus:m}}));