define(["OK/logger","OK/utils/utils","OK/utils/throttle","OK/LogClicks"],function(s,o,e,n){"use strict";var a="seen",t="log.seen",i=[],h=[],r=e(150,function(){for(var e=h.length;e--;)h[e].onScroll()});function l(e,t,i){OK.logging.info(a+" "+e+" "+t),s[i?"force":"success"](a,e,t)}function m(){this.params={},this.seenStartTime=0,this.hoverStartTime=0,this.onScrollSeenTimer=null,this.logData={}}return m.prototype.activate=function(e){var t,i;return this.element=e,this.params=JSON.parse(e.getAttribute("data-seen-params")),this.params.options&&(this.seenTimeout=this.params.options.seenTimeout,this.skipVisible=this.params.options.skipVisible||!1,this.hoverTimeout=this.params.options.hoverTimeout,this.seenPartial=this.params.options.partial||.01,this.seenForce=this.params.options.force||!1,this.onScrollSeen=this.params.options.onScrollSeen||!1,this.onScrollSeenTimeout=this.params.options.onScrollSeenTimeout||1e4,this.onScrollPartial=this.params.options.onScrollPartial||.6,this.disableNullHeight=this.params.options.disableNullHeight||!1,(t=(t=n.getLogDataAsString(e))&&n.parseLogData(t))&&t.feedFeatures&&(this.params.data=this.params.data||{},this.params.data.feedFeatures=t.feedFeatures,t.feedPosition&&(this.params.data.feedPosition=Number(t.feedPosition)),t.feedLocation&&(this.params.data.feedLocation=t.feedLocation))),this.boundMouseEnter=this.mouseEnter.bind(this),this.boundMouseLeave=this.mouseLeave.bind(this),this.boundClick=this.onClick.bind(this),this.hoverTimeout&&(this.element.addEventListener("mouseenter",this.boundMouseEnter),this.element.addEventListener("mouseleave",this.boundMouseLeave)),this.seenTimeout&&this.element.addEventListener("click",this.boundClick),this.seenTimeout&&!this.skipVisible&&!1!==(i=o.isElementPartiallyInViewport(e,this.seenPartial,this.disableNullHeight))&&this.shown(this.getNullHeightLogParam(i)),this},m.prototype.deactivate=function(){this.hoverTimeout&&(this.element.removeEventListener("mouseenter",this.boundMouseEnter),this.element.removeEventListener("mouseleave",this.boundMouseLeave)),this.seenTimeout&&(this.element.removeEventListener("click",this.boundClick),this.hidden())},m.prototype.shown=function(e){this.logData=Object.assign(e,this.params.data),this.seenStartTime=Date.now()},m.prototype.shownOnScroll=function(){var e;!this.onScrollSeen||this.onScrollSeenTimer||this.logData.seen||!1!==(e=o.isElementPartiallyInViewport(this.element,this.onScrollPartial,this.disableNullHeight))&&(this.onScrollSeenTimer=setTimeout(function(){this.logData.seen||(this.logData.seen=this.onScrollSeenTimeout,this.logData.nullHeight=null===e,l(this.params.type,JSON.stringify(this.logData),this.seenForce))}.bind(this),this.onScrollSeenTimeout))},m.prototype.hidden=function(){var e;!this.seenStartTime||this.logData.seen||(e=Date.now()-this.seenStartTime)>=this.seenTimeout&&(this.logData.seen=e,l(this.params.type,JSON.stringify(this.logData),this.seenForce)),this.logData.seen=0,this.seenStartTime=0,this.onScrollSeenTimer&&(clearTimeout(this.onScrollSeenTimer),this.onScrollSeenTimer=null)},m.prototype.mouseEnter=function(){this.hoverStartTime=Date.now()},m.prototype.mouseLeave=function(){var e;!this.hoverStartTime||(e=Date.now()-this.hoverStartTime)>=this.hoverTimeout&&(this.logData.hovered=e),this.hoverStartTime=0},m.prototype.onScroll=function(){var e;this.seenTimeout&&(!1!==(e=o.isElementPartiallyInViewport(this.element,this.seenPartial,this.disableNullHeight))?(this.seenStartTime||this.shown(this.getNullHeightLogParam(e)),this.shownOnScroll()):!0!==this.disableNullHeight&&this.hidden())},m.prototype.onClick=function(){this.seenStartTime?this.logData.seen=Date.now()-this.seenStartTime:(this.skipVisible&&this.shown(this.getNullHeightLogParam(!0)),this.logData.seen=0),this.logData.seen=this.seenStartTime?Date.now()-this.seenStartTime:0,this.logData.clicked=!0,l(this.params.type,JSON.stringify(this.logData),this.seenForce),this.seenStartTime=0},m.prototype.getNullHeightLogParam=function(e){return{nullHeight:null===e}},{logError:function(e){OK.logging.alert(t+" "+e),s.error(t,e)},logSuccess:l,activate:function(e){-1===i.indexOf(e)&&(i.push(e),h.push((new m).activate(e))),1===h.length&&window.addEventListener("scroll",r,!0)},deactivate:function(e){e=i.indexOf(e);-1!==e&&(h[e].deactivate(),i.splice(e,1),h.splice(e,1)),h.length||window.removeEventListener("scroll",r,!0)}}});
