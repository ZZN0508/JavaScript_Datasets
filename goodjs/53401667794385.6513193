!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app"],e):e((t||self).firebase)}(this,function(Dp){"use strict";try{!function(){var o;Dp=Dp&&Dp.hasOwnProperty("default")?Dp.default:Dp,(gi=o=o||{})[gi.DEBUG=0]="DEBUG",gi[gi.VERBOSE=1]="VERBOSE",gi[gi.INFO=2]="INFO",gi[gi.WARN=3]="WARN",gi[gi.ERROR=4]="ERROR",gi[gi.SILENT=5]="SILENT";function e(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(!(e<t.logLevel)){var i=(new Date).toISOString();switch(e){case o.DEBUG:case o.VERBOSE:console.log.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case o.INFO:console.info.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case o.WARN:console.warn.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case o.ERROR:console.error.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;default:throw new Error("Attempted to log a message with an invalid logType (value: "+e+")")}}}var n=o.INFO,t=(Object.defineProperty(i.prototype,"logLevel",{get:function(){return this._logLevel},set:function(t){if(!(t in o))throw new TypeError("Invalid value assigned to `logLevel`");this._logLevel=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"logHandler",{get:function(){return this._logHandler},set:function(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t},enumerable:!0,configurable:!0}),i.prototype.debug=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.DEBUG].concat(t))},i.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.VERBOSE].concat(t))},i.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.INFO].concat(t))},i.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.WARN].concat(t))},i.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.ERROR].concat(t))},i),r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function i(t){this.name=t,this._logLevel=n,this._logHandler=e}function a(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function c(o,a,s,u){return new(s=s||Promise)(function(t,e){function n(t){try{i(u.next(t))}catch(t){e(t)}}function r(t){try{i(u.throw(t))}catch(t){e(t)}}function i(e){e.done?t(e.value):new s(function(t){t(e.value)}).then(n,r)}i((u=u.apply(o,a||[])).next())})}function p(n,r){var i,o,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,o&&(a=2&e[0]?o.return:e[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,e[1])).done)return a;switch(o=0,(e=a?[2&e[0],a.value]:e)[0]){case 0:case 1:a=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,o=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!a||e[1]>a[0]&&e[1]<a[3])){s.label=e[1];break}if(6===e[0]&&s.label<a[1]){s.label=a[1],a=e;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(e);break}a[2]&&s.ops.pop(),s.trys.pop();continue}e=r.call(n,s)}catch(t){e=[6,t],o=0}finally{i=a=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}var s="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},h=s;function u(t){return"string"==typeof t}function l(t){return"number"==typeof t}function f(t,e){t=t.split("."),e=e||h;for(var n=0;n<t.length;n++)if(null==(e=e[t[n]]))return null;return e}function d(){}function m(t){var e=typeof t;if("object"==e){if(!t)return"null";if(t instanceof Array)return"array";if(t instanceof Object)return e;var n=Object.prototype.toString.call(t);if("[object Window]"==n)return"object";if("[object Array]"==n||"number"==typeof t.length&&void 0!==t.splice&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("splice"))return"array";if("[object Function]"==n||void 0!==t.call&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("call"))return"function"}else if("function"==e&&void 0===t.call)return"object";return e}function y(t){return"array"==m(t)}function g(t){var e=m(t);return"array"==e||"object"==e&&"number"==typeof t.length}function v(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var b="closure_uid_"+(1e9*Math.random()>>>0),w=0;function E(t,e,n){return t.call.apply(t.bind,arguments)}function S(e,n,t){if(!e)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var t=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(t,r),e.apply(n,t)}}return function(){return e.apply(n,arguments)}}function T(t,e,n){return(T=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?E:S).apply(null,arguments)}function I(e){var n=Array.prototype.slice.call(arguments,1);return function(){var t=n.slice();return t.push.apply(t,arguments),e.apply(this,t)}}var C=Date.now||function(){return+new Date};function D(t,o){function e(){}e.prototype=o.prototype,t.N=o.prototype,t.prototype=new e,(t.prototype.constructor=t).yb=function(t,e,n){for(var r=Array(arguments.length-2),i=2;i<arguments.length;i++)r[i-2]=arguments[i];return o.prototype[e].apply(t,r)}}function N(){this.j=this.j,this.i=this.i}N.prototype.j=!1,N.prototype.la=function(){!this.j&&(this.j=!0,this.G(),0)&&(this[b]||(this[b]=++w))},N.prototype.G=function(){if(this.i)for(;this.i.length;)this.i.shift()()};var A=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if(u(t))return u(e)&&1==e.length?t.indexOf(e,0):-1;for(var n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1},k=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(t,e,n){for(var r=t.length,i=u(t)?t.split(""):t,o=0;o<r;o++)o in i&&e.call(n,i[o],o,t)};function R(){return Array.prototype.concat.apply([],arguments)}function M(t){var e=t.length;if(0<e){for(var n=Array(e),r=0;r<e;r++)n[r]=t[r];return n}return[]}function O(t){return/^[\s\xa0]*$/.test(t)}var _,P=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function L(t,e){return-1!=t.indexOf(e)}function x(t,e){return t<e?-1:e<t?1:0}t:{var q=h.navigator;if(q){q=q.userAgent;if(q){_=q;break t}}_=""}function F(t,e,n){for(var r in t)e.call(n,t[r],r,t)}function V(t){var e,n={};for(e in t)n[e]=t[e];return n}var B="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function U(t){for(var e,n,r=1;r<arguments.length;r++){for(e in n=arguments[r])t[e]=n[e];for(var i=0;i<B.length;i++)e=B[i],Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])}}function Q(t){return Q[" "](t),t}Q[" "]=d;var K,j=L(_,"Opera"),G=L(_,"Trident")||L(_,"MSIE"),W=L(_,"Edge"),z=W||G,H=L(_,"Gecko")&&!(L(_.toLowerCase(),"webkit")&&!L(_,"Edge"))&&!(L(_,"Trident")||L(_,"MSIE"))&&!L(_,"Edge"),Y=L(_.toLowerCase(),"webkit")&&!L(_,"Edge");function X(){var t=h.document;return t?t.documentMode:void 0}t:{var J="",$=($=_,H?/rv:([^\);]+)(\)|;)/.exec($):W?/Edge\/([\d\.]+)/.exec($):G?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec($):Y?/WebKit\/(\S+)/.exec($):j?/(?:Version)[ \/]?(\S+)/.exec($):void 0);if($&&(J=$?$[1]:""),G){$=X();if(null!=$&&$>parseFloat(J)){K=String($);break t}}K=J}var Z={};function tt(s){return t=s,e=function(){for(var t=0,e=P(String(K)).split("."),n=P(String(s)).split("."),r=Math.max(e.length,n.length),i=0;0==t&&i<r;i++)for(var o=e[i]||"",a=n[i]||"";o=/(\d*)(\D*)(.*)/.exec(o)||["","","",""],a=/(\d*)(\D*)(.*)/.exec(a)||["","","",""],(0!=o[0].length||0!=a[0].length)&&(t=x(0==o[1].length?0:parseInt(o[1],10),0==a[1].length?0:parseInt(a[1],10))||x(0==o[2].length,0==a[2].length)||x(o[2],a[2]),o=o[3],a=a[3],0==t););return 0<=t},n=Z,Object.prototype.hasOwnProperty.call(n,t)?n[t]:n[t]=e();var t,e,n}var et=h.document,nt=et&&G?X()||("CSS1Compat"==et.compatMode?parseInt(K,10):5):void 0,rt=!G||9<=Number(nt),it=G&&!tt("9"),ot=function(){if(!h.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{h.addEventListener("test",d,e),h.removeEventListener("test",d,e)}catch(t){}return t}();function at(t,e){this.type=t,this.a=this.target=e,this.Ja=!0}function st(t,e){if(at.call(this,t?t.type:""),this.relatedTarget=this.a=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.pointerId=0,this.pointerType="",this.c=null,t){var n=this.type=t.type,r=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.a=e,e=t.relatedTarget){if(H){t:{try{Q(e.nodeName);var i=!0;break t}catch(t){}i=!1}i||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,this.screenY=r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,r.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType=u(t.pointerType)?t.pointerType:ut[t.pointerType]||"",(this.c=t).defaultPrevented&&this.b()}}at.prototype.b=function(){this.Ja=!1},D(st,at);var ut={2:"touch",3:"pen",4:"mouse"};st.prototype.b=function(){st.N.b.call(this);var t=this.c;if(t.preventDefault)t.preventDefault();else if(t.returnValue=!1,it)try{(t.ctrlKey||112<=t.keyCode&&t.keyCode<=123)&&(t.keyCode=-1)}catch(t){}};var ct="closure_listenable_"+(1e6*Math.random()|0),ht=0;function lt(t,e,n,r,i){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!r,this.da=i,this.key=++ht,this.X=this.Z=!1}function ft(t){t.X=!0,t.listener=null,t.proxy=null,t.src=null,t.da=null}function pt(t){this.src=t,this.a={},this.b=0}function dt(t,e){var n,r,i,o=e.type;o in t.a&&(r=t.a[o],(n=0<=(i=A(r,e)))&&Array.prototype.splice.call(r,i,1),n&&(ft(e),0==t.a[o].length&&(delete t.a[o],t.b--)))}function mt(t,e,n,r){for(var i=0;i<t.length;++i){var o=t[i];if(!o.X&&o.listener==e&&o.capture==!!n&&o.da==r)return i}return-1}pt.prototype.add=function(t,e,n,r,i){var o=t.toString();(t=this.a[o])||(t=this.a[o]=[],this.b++);var a=mt(t,e,r,i);return-1<a?(e=t[a],n||(e.Z=!1)):((e=new lt(e,this.src,o,!!r,i)).Z=n,t.push(e)),e};var yt="closure_lm_"+(1e6*Math.random()|0),gt={};function vt(t,e,n,r,i){if(r&&r.once)return function t(e,n,r,i,o){if(y(n)){for(var a=0;a<n.length;a++)t(e,n[a],r,i,o);return null}return r=Dt(r),e&&e[ct]?e.Ba(n,r,v(i)?!!i.capture:!!i,o):bt(e,n,r,!0,i,o)}(t,e,n,r,i);if(y(e)){for(var o=0;o<e.length;o++)vt(t,e[o],n,r,i);return null}return n=Dt(n),t&&t[ct]?t.Aa(e,n,v(r)?!!r.capture:!!r,i):bt(t,e,n,!1,r,i)}function bt(t,e,n,r,i,o){if(!e)throw Error("Invalid event type");var a=v(i)?!!i.capture:!!i;if(a&&!rt)return null;var s,u,c=It(t);if(c||(t[yt]=c=new pt(t)),(n=c.add(e,n,r,a,o)).proxy)return n;if(s=Tt,r=u=rt?function(t){return s.call(u.src,u.listener,t)}:function(t){if(!(t=s.call(u.src,u.listener,t)))return t},(n.proxy=r).src=t,r.listener=n,t.addEventListener)void 0===(i=!ot?a:i)&&(i=!1),t.addEventListener(e.toString(),r,i);else if(t.attachEvent)t.attachEvent(Et(e.toString()),r);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(r)}return n}function wt(t){var e,n,r;l(t)||!t||t.X||((e=t.src)&&e[ct]?dt(e.c,t):(n=t.type,r=t.proxy,e.removeEventListener?e.removeEventListener(n,r,t.capture):e.detachEvent?e.detachEvent(Et(n),r):e.addListener&&e.removeListener&&e.removeListener(r),(n=It(e))?(dt(n,t),0==n.b&&(n.src=null,e[yt]=null)):ft(t)))}function Et(t){return t in gt?gt[t]:gt[t]="on"+t}function St(t,e){var n=t.listener,r=t.da||t.src;return t.Z&&wt(t),n.call(r,e)}function Tt(t,e){return!!t.X||St(t,rt?new st(e,this):e=new st(e||f("window.event"),this))}function It(t){return(t=t[yt])instanceof pt?t:null}var Ct="__closure_events_fn_"+(1e9*Math.random()>>>0);function Dt(e){return"function"==m(e)?e:(e[Ct]||(e[Ct]=function(t){return e.handleEvent(t)}),e[Ct])}function Nt(){N.call(this),this.c=new pt(this),(this.J=this).B=null}function At(t,e,n,r){if(!(e=t.c.a[String(e)]))return!0;e=e.concat();for(var i=!0,o=0;o<e.length;++o){var a,s,u=e[o];u&&!u.X&&u.capture==n&&(a=u.listener,s=u.da||u.src,u.Z&&dt(t.c,u),i=!1!==a.call(s,r)&&i)}return i&&0!=r.Ja}D(Nt,N),Nt.prototype[ct]=!0,(_i=Nt.prototype).addEventListener=function(t,e,n,r){vt(this,t,e,n,r)},_i.removeEventListener=function(t,e,n,r){!function t(e,n,r,i,o){if(y(n))for(var a=0;a<n.length;a++)t(e,n[a],r,i,o);else i=v(i)?!!i.capture:!!i,r=Dt(r),e&&e[ct]?(e=e.c,(n=String(n).toString())in e.a&&-1<(r=mt(a=e.a[n],r,i,o))&&(ft(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete e.a[n],e.b--))):(e=e&&It(e))&&(n=e.a[n.toString()],(r=(e=-1)<(e=n?mt(n,r,i,o):e)?n[e]:null)&&wt(r))}(this,t,e,n,r)},_i.dispatchEvent=function(t){var e;if(n=this.B)for(e=[];n;n=n.B)e.push(n);var n=this.J,r=t.type||t;if(u(t)?t=new at(t,n):t instanceof at?t.target=t.target||n:(a=t,U(t=new at(r,n),a)),a=!0,e)for(var i=e.length-1;0<=i;i--)var o=t.a=e[i],a=At(o,r,!0,t)&&a;if(a=At(o=t.a=n,r,!0,t)&&a,a=At(o,r,!1,t)&&a,e)for(i=0;i<e.length;i++)a=At(o=t.a=e[i],r,!1,t)&&a;return a},_i.G=function(){if(Nt.N.G.call(this),this.c){var t,e=this.c;for(t in e.a){for(var n=e.a[t],r=0;r<n.length;r++)ft(n[r]);delete e.a[t],e.b--}}this.B=null},_i.Aa=function(t,e,n,r){return this.c.add(String(t),e,!1,n,r)},_i.Ba=function(t,e,n,r){return this.c.add(String(t),e,!0,n,r)};var kt=h.JSON.stringify;function Rt(t,e){this.c=t,this.f=e,this.b=0,this.a=null}function Mt(){this.b=this.a=null}Rt.prototype.get=function(){var t;return 0<this.b?(this.b--,t=this.a,this.a=t.next,t.next=null):t=this.c(),t};var Ot,_t=new Rt(function(){return new Pt},function(t){t.reset()});function Pt(){this.next=this.b=this.a=null}function Lt(t,e){var n;Ot||(n=h.Promise.resolve(void 0),Ot=function(){n.then(Ft)}),xt||(Ot(),xt=!0),qt.add(t,e)}Mt.prototype.add=function(t,e){var n=_t.get();n.set(t,e),this.b?this.b.next=n:this.a=n,this.b=n},Pt.prototype.set=function(t,e){this.a=t,this.b=e,this.next=null};var xt=!(Pt.prototype.reset=function(){this.next=this.b=this.a=null}),qt=new Mt;function Ft(){for(var t,e;e=void 0,n=null,(e=qt).a&&(n=e.a,e.a=e.a.next,e.a||(e.b=null),n.next=null),t=n;){try{t.a.call(t.b)}catch(t){!function(t){h.setTimeout(function(){throw t},0)}(t)}var n=_t;n.f(t),n.b<100&&(n.b++,t.next=n.a,n.a=t)}xt=!1}function Vt(t,e){Nt.call(this),this.b=t||1,this.a=e||h,this.f=T(this.gb,this),this.g=C()}function Bt(t){t.ba=!1,t.L&&(t.a.clearTimeout(t.L),t.L=null)}function Ut(t,e,n){if("function"==m(t))n&&(t=T(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=T(t.handleEvent,t)}return 2147483647<Number(e)?-1:h.setTimeout(t,e||0)}function Qt(t,e,n){N.call(this),this.f=null!=n?T(t,n):t,this.c=e,this.b=T(this.ab,this),this.a=[]}function Kt(t){t.U=Ut(t.b,t.c),t.f.apply(null,t.a)}function jt(t){N.call(this),this.b=t,this.a={}}D(Vt,Nt),(_i=Vt.prototype).ba=!1,_i.L=null,_i.gb=function(){var t;this.ba&&(0<(t=C()-this.g)&&t<.8*this.b?this.L=this.a.setTimeout(this.f,this.b-t):(this.L&&(this.a.clearTimeout(this.L),this.L=null),this.dispatchEvent("tick"),this.ba&&(Bt(this),this.start())))},_i.start=function(){this.ba=!0,this.L||(this.L=this.a.setTimeout(this.f,this.b),this.g=C())},_i.G=function(){Vt.N.G.call(this),Bt(this),delete this.a},D(Qt,N),(_i=Qt.prototype).ea=!1,_i.U=null,_i.Ua=function(t){this.a=arguments,this.U?this.ea=!0:Kt(this)},_i.G=function(){Qt.N.G.call(this),this.U&&(h.clearTimeout(this.U),this.U=null,this.ea=!1,this.a=[])},_i.ab=function(){this.U=null,this.ea&&(this.ea=!1,Kt(this))},D(jt,N);var Gt=[];function Wt(t,e,n,r){y(n)||(n&&(Gt[0]=n.toString()),n=Gt);for(var i=0;i<n.length;i++){var o=vt(e,n[i],r||t.handleEvent,!1,t.b||t);if(!o)break;t.a[o.key]=o}}function zt(t){F(t.a,function(t,e){this.a.hasOwnProperty(e)&&wt(t)},t),t.a={}}function Ht(){}jt.prototype.G=function(){jt.N.G.call(this),zt(this)},jt.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var Yt=new Nt;function Xt(t){at.call(this,"serverreachability",t)}function Jt(){Yt.dispatchEvent(new Xt(Yt))}function $t(t){at.call(this,"statevent",t)}function Zt(){Yt.dispatchEvent(new $t(Yt))}function te(t){at.call(this,"timingevent",t)}function ee(t,e){if("function"!=m(t))throw Error("Fn must not be null and must be a function");return h.setTimeout(function(){t()},e)}D(Xt,at),D($t,at),D(te,at);var ne={NO_ERROR:0,hb:1,ob:2,nb:3,kb:4,mb:5,pb:6,Ma:7,TIMEOUT:8,sb:9},re={jb:"complete",wb:"success",Na:"error",Ma:"abort",ub:"ready",vb:"readystatechange",TIMEOUT:"timeout",qb:"incrementaldata",tb:"progress",lb:"downloadprogress",xb:"uploadprogress"};function ie(){}function oe(t){var e;return e=!(e=t.a)?t.a={}:e}function ae(){}ie.prototype.a=null;var se={OPEN:"a",ib:"b",Na:"c",rb:"d"};function ue(){at.call(this,"d")}function ce(){at.call(this,"c")}function he(){}function le(t,e,n){this.g=t,this.W=e,this.V=n||1,this.I=new jt(this),this.O=45e3,this.P=new Vt(t=z?125:void 0),this.h=null,this.b=!1,this.l=this.D=this.f=this.F=this.v=this.R=this.i=null,this.j=[],this.a=null,this.A=0,this.c=this.w=null,this.o=-1,this.m=!1,this.J=0,this.B=null,this.s=this.S=this.H=!1}D(ue,at),D(ce,at),D(he,ie);var fe=new he,pe={},de={};function me(t,e,n){t.F=1,t.f=Ve(Oe(e)),t.l=n,t.H=!0,ge(t,null)}function ye(t,e,n,r){t.F=1,t.f=Ve(Oe(e)),t.l=null,t.H=n,ge(t,r)}function ge(t,e){t.v=C(),be(t),t.D=Oe(t.f),Fe(t.D,"t",t.V),t.A=0,t.a=t.g.$(t.g.Y()?e:null),0<t.J&&(t.B=new Qt(T(t.Ka,t,t.a),t.J)),Wt(t.I,t.a,"readystatechange",t.eb),e=t.h?V(t.h):{},t.l?(t.w||(t.w="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.a.ca(t.D,t.w,t.l,e)):(t.w="GET",t.a.ca(t.D,t.w,null,e)),Jt()}function ve(t,e,n){for(var r,i,o,a=!0;!t.m&&t.A<n.length;){var s=(s=n,o=i=void 0,i=(r=t).A,-1==(o=s.indexOf("\n",i))?de:(i=Number(s.substring(i,o)),isNaN(i)?pe:(o+=1)+i>s.length?de:(s=s.substr(o,i),r.A=o+i,s)));if(s==de){4==e&&(t.c=4,Zt(),a=!1);break}if(s==pe){t.c=4,Zt(),a=!1;break}Ie(t,s)}4==e&&0==n.length&&(t.c=1,Zt(),a=!1),t.b=t.b&&a,a||(Te(t),Se(t))}function be(t){t.R=C()+t.O,we(t,t.O)}function we(t,e){if(null!=t.i)throw Error("WatchDog timer not null");t.i=ee(T(t.bb,t),e)}function Ee(t){t.i&&(h.clearTimeout(t.i),t.i=null)}function Se(t){t.g.Da()||t.m||t.g.na(t)}function Te(t){Ee(t);var e=t.B;e&&"function"==typeof e.la&&e.la(),t.B=null,Bt(t.P),zt(t.I),t.a&&(e=t.a,t.a=null,e.abort(),e.la())}function Ie(t,e){try{t.g.Ga(t,e),Jt()}catch(t){}}function Ce(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(g(t)||u(t))k(t,e,void 0);else{if(t.K&&"function"==typeof t.K)var n=t.K();else if(t.C&&"function"==typeof t.C)n=void 0;else if(g(t)||u(t))for(var n=[],r=t.length,i=0;i<r;i++)n.push(i);else for(i in n=[],r=0,t)n[r++]=i;for(var i=(r=function(t){if(t.C&&"function"==typeof t.C)return t.C();if(u(t))return t.split("");if(g(t)){for(var e=[],n=t.length,r=0;r<n;r++)e.push(t[r]);return e}for(r in e=[],n=0,t)e[n++]=t[r];return e}(t)).length,o=0;o<i;o++)e.call(void 0,r[o],n&&n[o],t)}}function De(t,e){this.b={},this.a=[],this.c=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(t)if(t instanceof De)for(n=t.K(),r=0;r<n.length;r++)this.set(n[r],t.get(n[r]));else for(r in t)this.set(r,t[r])}function Ne(t,e){ke(t.b,e)&&(delete t.b[e],t.c--,t.a.length>2*t.c&&Ae(t))}function Ae(t){if(t.c!=t.a.length){for(var e=0,n=0;e<t.a.length;){var r=t.a[e];ke(t.b,r)&&(t.a[n++]=r),e++}t.a.length=n}if(t.c!=t.a.length){for(var i={},n=e=0;e<t.a.length;)ke(i,r=t.a[e])||(i[t.a[n++]=r]=1),e++;t.a.length=n}}function ke(t,e){return Object.prototype.hasOwnProperty.call(t,e)}(_i=le.prototype).setTimeout=function(t){this.O=t},_i.eb=function(t){t=t.target;var e=this.B;e&&3==Rn(t)?e.Ua():this.Ka(t)},_i.Ka=function(t){try{if(t==this.a)t:{var e=Rn(this.a),n=this.a.ya();this.a.T();if(!(e<3||3==e&&!z&&!this.a.aa())){this.m||4!=e||7==n||Jt(),Ee(this);var r=this.a.T();this.o=r;var i=this.a.aa();if(this.b=200==r){if(this.S&&!this.s){e:{if(this.a){var o=Mn(this.a,"X-HTTP-Initial-Response");if(o&&!O(o)){var a=o;break e}}a=null}if(!a){this.b=!1,this.c=3,Zt(),Te(this),Se(this);break t}this.s=!0,Ie(this,a)}this.H?(ve(this,e,i),z&&this.b&&3==e&&(Wt(this.I,this.P,"tick",this.cb),this.P.start())):Ie(this,i),4==e&&Te(this),this.b&&!this.m&&(4==e?this.g.na(this):(this.b=!1,be(this)))}else 400==r&&0<i.indexOf("Unknown SID")?this.c=3:this.c=0,Zt(),Te(this),Se(this)}}}catch(t){}},_i.cb=function(){var t,e;this.a&&(t=Rn(this.a),e=this.a.aa(),this.A<e.length&&(Ee(this),ve(this,t,e),this.b&&4!=t&&be(this)))},_i.cancel=function(){this.m=!0,Te(this)},_i.bb=function(){this.i=null;var t=C();0<=t-this.R?(2!=this.F&&(Jt(),Zt()),Te(this),this.c=2,Se(this)):we(this,this.R-t)},(_i=De.prototype).C=function(){Ae(this);for(var t=[],e=0;e<this.a.length;e++)t.push(this.b[this.a[e]]);return t},_i.K=function(){return Ae(this),this.a.concat()},_i.get=function(t,e){return ke(this.b,t)?this.b[t]:e},_i.set=function(t,e){ke(this.b,t)||(this.c++,this.a.push(t)),this.b[t]=e},_i.forEach=function(t,e){for(var n=this.K(),r=0;r<n.length;r++){var i=n[r],o=this.get(i);t.call(e,o,i,this)}};var Re=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^/?#]*)@)?([^/#?]*?)(?::([0-9]+))?(?=[/#?]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function Me(t,e){var n;this.b=this.j=this.f="",this.i=null,this.g=this.a="",this.h=!1,t instanceof Me?(this.h=void 0!==e?e:t.h,_e(this,t.f),this.j=t.j,Pe(this,t.b),Le(this,t.i),this.a=t.a,xe(this,Ze(t.c)),this.g=t.g):t&&(n=String(t).match(Re))?(this.h=!!e,_e(this,n[1]||"",!0),this.j=Be(n[2]||""),Pe(this,n[3]||"",!0),Le(this,n[4]),this.a=Be(n[5]||"",!0),xe(this,n[6]||"",!0),this.g=Be(n[7]||"")):(this.h=!!e,this.c=new He(null,this.h))}function Oe(t){return new Me(t)}function _e(t,e,n){t.f=n?Be(e,!0):e,t.f&&(t.f=t.f.replace(/:$/,""))}function Pe(t,e,n){t.b=n?Be(e,!0):e}function Le(t,e){if(e){if(e=Number(e),isNaN(e)||e<0)throw Error("Bad port number "+e);t.i=e}else t.i=null}function xe(t,e,n){var r,i;e instanceof He?(t.c=e,r=t.c,(i=t.h)&&!r.f&&(Ye(r),r.c=null,r.a.forEach(function(t,e){var n=e.toLowerCase();e!=n&&(Xe(this,e),$e(this,n,t))},r)),r.f=i):(n||(e=Ue(e,We)),t.c=new He(e,t.h))}function qe(t,e,n){t.c.set(e,n)}function Fe(t,e,n){y(n)||(n=[String(n)]),$e(t.c,e,n)}function Ve(t){return qe(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^C()).toString(36)),t}function Be(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function Ue(t,e,n){return u(t)?(t=encodeURI(t).replace(e,Qe),t=n?t.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):t):null}function Qe(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}Me.prototype.toString=function(){var t=[],e=this.f;e&&t.push(Ue(e,Ke,!0),":");var n=this.b;return!n&&"file"!=e||(t.push("//"),(e=this.j)&&t.push(Ue(e,Ke,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.i)&&t.push(":",String(n))),(n=this.a)&&(this.b&&"/"!=n.charAt(0)&&t.push("/"),t.push(Ue(n,"/"==n.charAt(0)?Ge:je,!0))),(n=this.c.toString())&&t.push("?",n),(n=this.g)&&t.push("#",Ue(n,ze)),t.join("")},Me.prototype.resolve=function(t){var e=Oe(this),n=!!t.f;n?_e(e,t.f):n=!!t.j,n?e.j=t.j:n=!!t.b,n?Pe(e,t.b):n=null!=t.i;var r=t.a;if(n)Le(e,t.i);else if(n=!!t.a)if("/"!=r.charAt(0)&&(this.b&&!this.a?r="/"+r:-1!=(i=e.a.lastIndexOf("/"))&&(r=e.a.substr(0,i+1)+r)),".."==(i=r)||"."==i)r="";else if(L(i,"./")||L(i,"/.")){for(var r=0==i.lastIndexOf("/",0),i=i.split("/"),o=[],a=0;a<i.length;){var s=i[a++];"."==s?r&&a==i.length&&o.push(""):".."==s?((1<o.length||1==o.length&&""!=o[0])&&o.pop(),r&&a==i.length&&o.push("")):(o.push(s),r=!0)}r=o.join("/")}else r=i;return n?e.a=r:n=""!==t.c.toString(),n?xe(e,Ze(t.c)):n=!!t.g,n&&(e.g=t.g),e};var Ke=/[#\/\?@]/g,je=/[#\?:]/g,Ge=/[#\?]/g,We=/[#\?@]/g,ze=/#/g;function He(t,e){this.b=this.a=null,this.c=t||null,this.f=!!e}function Ye(o){o.a||(o.a=new De,o.b=0,o.c&&function(t){if(t){t=t.split("&");for(var e=0;e<t.length;e++){var n,r=t[e].indexOf("="),i=null;0<=r?(n=t[e].substring(0,r),i=t[e].substring(r+1)):n=t[e],r=n,i=i?decodeURIComponent(i.replace(/\+/g," ")):"",o.add(decodeURIComponent(r.replace(/\+/g," ")),i)}}}(o.c))}function Xe(t,e){Ye(t),e=tn(t,e),ke(t.a.b,e)&&(t.c=null,t.b-=t.a.get(e).length,Ne(t.a,e))}function Je(t,e){return Ye(t),e=tn(t,e),ke(t.a.b,e)}function $e(t,e,n){Xe(t,e),0<n.length&&(t.c=null,t.a.set(tn(t,e),M(n)),t.b+=n.length)}function Ze(t){var e=new He;return e.c=t.c,t.a&&(e.a=new De(t.a),e.b=t.b),e}function tn(t,e){return e=String(e),e=t.f?e.toLowerCase():e}function en(t){this.a=t,this.b=this.h=null,this.g=!1,this.i=null,this.c=-1,this.l=this.f=null}function nn(t){var e,n,r=t.a.F.a;null!=r?(Zt(),r?(Zt(),Kn(t.a,t,!1)):(Zt(),Kn(t.a,t,!0))):(t.b=new le(t,void 0,void 0),t.b.h=t.h,r=Hn(r=t.a,r.Y()?t.f:null,t.i),Zt(),Fe(r,"TYPE","xmlhttp"),e=t.a.j,n=t.a.I,e&&n&&qe(r,e,n),ye(t.b,r,!1,t.f))}function rn(){this.a=this.b=null}function on(){this.a=new De}function an(t){var e=typeof t;return"object"==e&&t||"function"==e?"o"+(t[b]||(t[b]=++w)):e.charAt(0)+t}function sn(t,e){this.b=t,this.a=e}function un(t){this.g=t||10,t=h.PerformanceNavigationTiming?0<(t=h.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):!!(h.ka&&h.ka.Ea&&h.ka.Ea()&&h.ka.Ea().zb),this.f=t?this.g:1,this.a=null,1<this.f&&(this.a=new on),this.b=null,this.c=[]}(_i=He.prototype).add=function(t,e){Ye(this),this.c=null,t=tn(this,t);var n=this.a.get(t);return n||this.a.set(t,n=[]),n.push(e),this.b+=1,this},_i.forEach=function(n,r){Ye(this),this.a.forEach(function(t,e){k(t,function(t){n.call(r,t,e,this)},this)},this)},_i.K=function(){Ye(this);for(var t=this.a.C(),e=this.a.K(),n=[],r=0;r<e.length;r++)for(var i=t[r],o=0;o<i.length;o++)n.push(e[r]);return n},_i.C=function(t){Ye(this);var e=[];if(u(t))Je(this,t)&&(e=R(e,this.a.get(tn(this,t))));else{t=this.a.C();for(var n=0;n<t.length;n++)e=R(e,t[n])}return e},_i.set=function(t,e){return Ye(this),this.c=null,Je(this,t=tn(this,t))&&(this.b-=this.a.get(t).length),this.a.set(t,[e]),this.b+=1,this},_i.get=function(t,e){return t&&0<(t=this.C(t)).length?String(t[0]):e},_i.toString=function(){if(this.c)return this.c;if(!this.a)return"";for(var t=[],e=this.a.K(),n=0;n<e.length;n++)for(var r=e[n],i=encodeURIComponent(String(r)),r=this.C(r),o=0;o<r.length;o++){var a=i;""!==r[o]&&(a+="="+encodeURIComponent(String(r[o]))),t.push(a)}return this.c=t.join("&")},D(function(){},function(){}),(_i=en.prototype).M=null,_i.$=function(t){return this.a.$(t)},_i.abort=function(){this.b&&(this.b.cancel(),this.b=null),this.c=-1},_i.Da=function(){return!1},_i.Ga=function(t,e){var n;if(this.c=t.o,0==this.M)if(!this.a.o&&(t=t.a)&&(n=Mn(t,"X-Client-Wire-Protocol"),this.l=n||null,this.a.j&&(t=Mn(t,"X-HTTP-Session-Id"))&&(this.a.I=t)),e){try{var r=this.a.ja.a.parse(e)}catch(t){return(e=this.a).m=this.c,void Wn(e,2)}this.f=r[0]}else(e=this.a).m=this.c,Wn(e,2);else 1==this.M&&(this.g?Zt():"11111"==e?(Zt(),this.g=!0,(!G||10<=Number(nt))&&(this.c=200,this.b.cancel(),Zt(),Kn(this.a,this,!0))):(Zt(),this.g=!1))},_i.na=function(){var t;this.c=this.b.o,this.b.b?0==this.M?(this.M=1,nn(this)):1==this.M&&(this.g?(Zt(),Kn(this.a,this,!0)):(Zt(),Kn(this.a,this,!1))):(0!=this.M&&1!=this.M||Zt(),(t=this.a).m=this.c,Wn(t,2))},_i.Y=function(){return this.a.Y()},_i.ma=function(){return this.a.ma()},on.prototype.add=function(t){this.a.set(an(t),t)},on.prototype.C=function(){return this.a.C()};function cn(t,e){!t.a&&(L(e,"spdy")||L(e,"quic")||L(e,"h2"))&&(t.f=t.g,t.a=new on,t.b&&(pn(t,t.b),t.b=null))}function hn(t){return t.b||t.a&&t.a.a.c>=t.f}function ln(t){return t.b?1:t.a?t.a.a.c:0}function fn(t,e){return t.b?t.b==e:!!t.a&&(e=an(e),ke(t.a.a.b,e))}function pn(t,e){t.a?t.a.add(e):t.b=e}function dn(t,e){var n;t.b&&t.b==e?t.b=null:((n=t.a)&&(n=an(e),n=ke(t.a.a.b,n)),n&&Ne(t.a.a,an(e)))}function mn(t){if(null!=t.b)return t.c.concat(t.b.j);if(null==t.a||0==t.a.a.c)return M(t.c);var e=t.c;return k(t.a.C(),function(t){e=e.concat(t.j)}),e}function yn(){}function gn(){this.a=new yn}function vn(t,e,n,r,i){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,i(r)}catch(t){}}un.prototype.cancel=function(){var t;this.c=mn(this),this.b?(this.b.cancel(),this.b=null):this.a&&0!=this.a.a.c&&(k(this.a.C(),function(t){t.cancel()}),(t=this.a.a).b={},t.a.length=0,t.c=0)},yn.prototype.stringify=function(t){return h.JSON.stringify(t,void 0)},yn.prototype.parse=function(t){return h.JSON.parse(t,void 0)};var bn=h.JSON.parse;function wn(t){Nt.call(this),this.headers=new De,this.H=t||null,this.b=!1,this.s=this.a=null,this.A="",this.h=0,this.f="",this.g=this.w=this.l=this.v=!1,this.o=0,this.m=null,this.I=En,this.D=this.F=!1}D(wn,Nt);var En="",Sn=/^https?$/i,Tn=["POST","PUT"];function In(t){return"content-type"==t.toLowerCase()}function Cn(t,e){t.b=!1,t.a&&(t.g=!0,t.a.abort(),t.g=!1),t.f=e,t.h=5,Dn(t),An(t)}function Dn(t){t.v||(t.v=!0,t.dispatchEvent("complete"),t.dispatchEvent("error"))}function Nn(t){if(t.b&&(!t.s[1]||4!=Rn(t)||2!=t.T()))if(t.l&&4==Rn(t))Ut(t.Fa,0,t);else if(t.dispatchEvent("readystatechange"),4==Rn(t)){t.b=!1;try{var e,n,r,i,o=t.T();t:switch(o){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var a=!0;break t;default:a=!1}(e=a)||((n=0===o)&&(!(i=String(t.A).match(Re)[1]||null)&&h.self&&h.self.location&&(i=(r=h.self.location.protocol).substr(0,r.length-1)),n=!Sn.test(i?i.toLowerCase():"")),e=n),e?(t.dispatchEvent("complete"),t.dispatchEvent("success")):(t.h=6,t.f=t.za()+" ["+t.T()+"]",Dn(t))}finally{An(t)}}}function An(t,e){if(t.a){kn(t);var n=t.a,r=t.s[0]?d:null;t.a=null,t.s=null,e||t.dispatchEvent("ready");try{n.onreadystatechange=r}catch(t){}}}function kn(t){t.a&&t.D&&(t.a.ontimeout=null),t.m&&(h.clearTimeout(t.m),t.m=null)}function Rn(t){return t.a?t.a.readyState:0}function Mn(t,e){return t.a?t.a.getResponseHeader(e):null}function On(t,e,n){t:{for(r in n){var r=!1;break t}r=!0}if(r)return t;var i,o="";return F(n,function(t,e){o+=e,o+=":",o+=t,o+="\r\n"}),n=o,u(t)?(e=encodeURIComponent(String(e)),(e+=n=null!=n?"="+encodeURIComponent(String(n)):"")&&((n=t.indexOf("#"))<0&&(n=t.length),i=(r=t.indexOf("?"))<0||n<r?(r=n,""):t.substring(r+1,n),n=(t=[t.substr(0,r),i,t.substr(n)])[1],t[1]=e?n?n+"&"+e:e:n,t=t[0]+(t[1]?"?"+t[1]:"")+t[2])):qe(t,e,n),t}function _n(t){this.f=[],this.F=new rn,this.ga=this.pa=this.B=this.ha=this.a=this.I=this.j=this.V=this.g=this.J=this.i=null,this.Ra=this.P=0,this.Pa=!!f("internalChannelParams.failFast",t),this.ia=this.w=this.s=this.l=this.h=this.c=null,this.oa=!0,this.m=this.ra=this.O=-1,this.S=this.v=this.A=0,this.Oa=f("internalChannelParams.baseRetryDelayMs",t)||5e3,this.Sa=f("internalChannelParams.retryDelaySeedMs",t)||1e4,this.Qa=f("internalChannelParams.forwardChannelMaxRetries",t)||2,this.qa=f("internalChannelParams.forwardChannelRequestTimeoutMs",t)||2e4,this.La=t&&t.Ab||void 0,this.D=void 0,this.R=t&&t.supportsCrossDomainXhr||!1,this.H="",this.b=new un(t&&t.concurrentRequestLimit),this.ja=new gn,this.o=!t||void 0===t.backgroundChannelTest||t.backgroundChannelTest,(this.W=t&&t.fastHandshake||!1)&&!this.o&&(this.o=!0),t&&t.forceLongPolling&&(this.oa=!1),this.fa=void 0}function Pn(t){var e,n;Ln(t),3==t.u&&(e=t.P++,qe(n=Oe(t.B),"SID",t.H),qe(n,"RID",e),qe(n,"TYPE","terminate"),Vn(t,n),(e=new le(t,e,void 0)).F=2,e.f=Ve(Oe(n)),n=!1,!(n=h.navigator&&h.navigator.sendBeacon?h.navigator.sendBeacon(e.f.toString(),""):n)&&h.Image&&((new Image).src=e.f,n=!0),n||(e.a=e.g.$(null),e.a.ca(e.f)),e.v=C(),be(e)),zn(t)}function Ln(t){t.w&&(t.w.abort(),t.w=null),t.a&&(t.a.cancel(),t.a=null),t.l&&(h.clearTimeout(t.l),t.l=null),jn(t),t.b.cancel(),t.h&&(l(t.h)&&h.clearTimeout(t.h),t.h=null)}function xn(t,e){t.f.push(new sn(t.Ra++,e)),3==t.u&&qn(t)}function qn(t){hn(t.b)||t.h||(t.h=!0,Lt(t.Ia,t),t.A=0)}function Fn(t,e){var n=e?e.W:t.P++,r=Oe(t.B);qe(r,"SID",t.H),qe(r,"RID",n),qe(r,"AID",t.O),Vn(t,r),t.g&&t.i&&On(r,t.g,t.i),n=new le(t,n,t.A+1),null===t.g&&(n.h=t.i),e&&(t.f=e.j.concat(t.f)),e=Bn(t,n,1e3),n.setTimeout(Math.round(.5*t.qa)+Math.round(.5*t.qa*Math.random())),pn(t.b,n),me(n,r,e)}function Vn(t,n){t.c&&Ce({},function(t,e){qe(n,e,t)})}function Bn(t,e,n){n=Math.min(t.f.length,n);var r=t.c?T(t.c.Ta,t.c,t):null;t:for(var i=t.f,o=-1;;){var a=["count="+n];-1==o?0<n?(o=i[0].b,a.push("ofs="+o)):o=0:a.push("ofs="+o);for(var s=!0,u=0;u<n;u++){var c=i[u].b,h=i[u].a;if((c-=o)<0)o=Math.max(0,i[u].b-100),s=!1;else try{!function(t,r,e){var i=e||"";try{Ce(t,function(t,e){var n=t;v(t)&&(n=kt(t)),r.push(i+e+"="+encodeURIComponent(n))})}catch(t){throw r.push(i+"type="+encodeURIComponent("_badmap")),t}}(h,a,"req"+c+"_")}catch(t){r&&r(h)}}if(s){r=a.join("&");break t}}return t=t.f.splice(0,n),e.j=t,r}function Un(t){t.a||t.l||(t.S=1,Lt(t.Ha,t),t.v=0)}function Qn(t){return!(t.a||t.l||3<=t.v)&&(t.S++,t.l=ee(T(t.Ha,t),Gn(t,t.v)),t.v++,1)}function Kn(t,e,n){var r=e.l;r&&cn(t.b,r),t.ia=t.oa&&n,t.m=e.c,t.B=Hn(t,null,t.ha),qn(t)}function jn(t){null!=t.s&&(h.clearTimeout(t.s),t.s=null)}function Gn(t,e){var n=t.Oa+Math.floor(Math.random()*t.Sa);return t.ma()||(n*=2),n*e}function Wn(t,e){var n,r,i,o;2==e?(r=null,t.c&&(r=null),o=T(t.fb,t),r||(r=new Me("//www.google.com/images/cleardot.gif"),h.location&&"http"==h.location.protocol||_e(r,"https"),Ve(r)),n=r.toString(),r=o,o=new Ht,h.Image?((i=new Image).onload=I(vn,o,i,"TestLoadImage: loaded",!0,r),i.onerror=I(vn,o,i,"TestLoadImage: error",!1,r),i.onabort=I(vn,o,i,"TestLoadImage: abort",!1,r),i.ontimeout=I(vn,o,i,"TestLoadImage: timeout",!1,r),h.setTimeout(function(){i.ontimeout&&i.ontimeout()},1e4),i.src=n):r(!1)):Zt(),t.u=0,t.c&&t.c.ta(e),zn(t),Ln(t)}function zn(t){t.u=0,t.m=-1,t.c&&(0==mn(t.b).length&&0==t.f.length||(t.b.c.length=0,M(t.f),t.f.length=0),t.c.sa())}function Hn(t,e,n){var r,i,o,a,s,u=(o=n)instanceof Me?Oe(o):new Me(o,void 0);return""!=u.b?(e&&Pe(u,e+"."+u.b),Le(u,u.i)):(s=h.location,a=e?e+"."+s.hostname:s.hostname,r=s.protocol,i=a,o=+s.port,a=n,s=new Me(null,void 0),r&&_e(s,r),i&&Pe(s,i),o&&Le(s,o),a&&(s.a=a),u=s),t.V&&F(t.V,function(t,e){qe(u,e,t)}),e=t.j,n=t.I,e&&n&&qe(u,e,n),qe(u,"VER",t.wa),Vn(t,u),u}function Yn(){}function Xn(){if(G&&!(10<=Number(nt)))throw Error("Environmental error: no available transport.")}function Jn(t,e){Nt.call(this),this.a=new _n(e),this.g=t,this.m=e&&e.testUrl?e.testUrl:function(t){for(var e=t,n=1;n<arguments.length;n++){var r,i=arguments[n];0==i.lastIndexOf("/",0)?e=i:((r=""==e)||(r=0<=(r=e.length-1)&&e.indexOf("/",r)==r),e+=r?i:"/"+i)}return e}(this.g,"test"),this.b=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.a.i=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.xa&&(t?t["X-WebChannel-Client-Profile"]=e.xa:t={"X-WebChannel-Client-Profile":e.xa}),this.a.J=t,(t=e&&e.httpHeadersOverwriteParam)&&!O(t)&&(this.a.g=t),this.l=e&&e.supportsCrossDomainXhr||!1,this.h=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!O(e)&&(this.a.j=e,null!==(t=this.b)&&e in t&&e in(t=this.b)&&delete t[e]),this.f=new tr(this)}function $n(t){ue.call(this);var e=t.__sm__;if(e){t:{for(var n in e){t=n;break t}t=void 0}(this.c=t)?(t=this.c,this.data=null!==e&&t in e?e[t]:void 0):this.data=e}else this.data=t}function Zn(){ce.call(this),this.status=1}function tr(t){this.a=t}(_i=wn.prototype).ca=function(t,e,n,r){if(this.a)throw Error("[goog.net.XhrIo] Object is active with another request="+this.A+"; newUri="+t);e=e?e.toUpperCase():"GET",this.A=t,this.f="",this.h=0,this.v=!1,this.b=!0,this.a=new XMLHttpRequest,this.s=this.H?oe(this.H):oe(fe),this.a.onreadystatechange=T(this.Fa,this);try{this.w=!0,this.a.open(e,String(t),!0),this.w=!1}catch(t){return void Cn(this,t)}t=n||"";var i,o=new De(this.headers);r&&Ce(r,function(t,e){o.set(e,t)}),r=function(t){t:{for(var e=In,n=t.length,r=u(t)?t.split(""):t,i=0;i<n;i++)if(i in r&&e.call(void 0,r[i],i,t)){e=i;break t}e=-1}return e<0?null:u(t)?t.charAt(e):t[e]}(o.K()),n=h.FormData&&t instanceof h.FormData,0<=A(Tn,e)&&!r&&!n&&o.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),o.forEach(function(t,e){this.a.setRequestHeader(e,t)},this),this.I&&(this.a.responseType=this.I),"withCredentials"in this.a&&this.a.withCredentials!==this.F&&(this.a.withCredentials=this.F);try{kn(this),0<this.o&&((this.D=(i=this.a,G&&tt(9)&&l(i.timeout)&&void 0!==i.ontimeout))?(this.a.timeout=this.o,this.a.ontimeout=T(this.Ca,this)):this.m=Ut(this.Ca,this.o,this)),this.l=!0,this.a.send(t),this.l=!1}catch(t){Cn(this,t)}},_i.Ca=function(){this.a&&(this.f="Timed out after "+this.o+"ms, aborting",this.h=8,this.dispatchEvent("timeout"),this.abort(8))},_i.abort=function(t){this.a&&this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1,this.h=t||7,this.dispatchEvent("complete"),this.dispatchEvent("abort"),An(this))},_i.G=function(){this.a&&(this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1),An(this,!0)),wn.N.G.call(this)},_i.Fa=function(){this.j||(this.w||this.l||this.g?Nn(this):this.$a())},_i.$a=function(){Nn(this)},_i.T=function(){try{return 2<Rn(this)?this.a.status:-1}catch(t){return-1}},_i.za=function(){try{return 2<Rn(this)?this.a.statusText:""}catch(t){return""}},_i.aa=function(){try{return this.a?this.a.responseText:""}catch(t){return""}},_i.Va=function(t){if(this.a){var e=this.a.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),bn(e)}},_i.ya=function(){return this.h},_i.Ya=function(){return u(this.f)?this.f:String(this.f)},(_i=_n.prototype).wa=8,_i.u=1,_i.Da=function(){return 0==this.u},_i.Ia=function(t){if(this.h)if(this.h=null,1==this.u){if(!t){this.P=Math.floor(1e5*Math.random());var e,n=new le(this,t=this.P++,void 0),r=this.i;if(this.J&&(r?U(r=V(r),this.J):r=this.J),null===this.g&&(n.h=r),this.W)t:{for(var i=e=0;i<this.f.length;i++){var o=this.f[i];if(void 0===(o="__data__"in o.a&&u(o=o.a.__data__)?o.length:void 0))break;if(4096<(e+=o)){e=i;break t}if(4096===e||i===this.f.length-1){e=i+1;break t}}e=1e3}else e=1e3;e=Bn(this,n,e),qe(i=Oe(this.B),"RID",t),qe(i,"CVER",22),this.o&&this.j&&qe(i,"X-HTTP-Session-Id",this.j),Vn(this,i),this.g&&r&&On(i,this.g,r),pn(this.b,n),this.W?(qe(i,"$req",e),qe(i,"SID","null"),n.S=!0,me(n,i,null)):me(n,i,e),this.u=2}}else 3==this.u&&(t?Fn(this,t):0==this.f.length||hn(this.b)||Fn(this))},_i.Ha=function(){this.l=null,this.a=new le(this,"rpc",this.S),null===this.g&&(this.a.h=this.i),this.a.J=0;var t=Oe(this.pa);qe(t,"RID","rpc"),qe(t,"SID",this.H),qe(t,"CI",this.ia?"0":"1"),qe(t,"AID",this.O),Vn(this,t),qe(t,"TYPE","xmlhttp"),this.g&&this.i&&On(t,this.g,this.i),this.D&&this.a.setTimeout(this.D),ye(this.a,t,!0,this.ga)},_i.Ga=function(t,e){if(0!=this.u&&(this.a==t||fn(this.b,t)))if(this.m=t.o,!t.s&&fn(this.b,t)&&3==this.u){try{var n=this.ja.a.parse(e)}catch(t){n=null}if(y(n)&&3==n.length){if(0==(e=n)[0]){t:if(!this.l){if(this.a){if(!(this.a.v+3e3<t.v))break t;jn(this),this.a.cancel(),this.a=null}Qn(this),Zt()}}else this.ra=e[1],0<this.ra-this.O&&e[2]<37500&&this.ia&&0==this.v&&!this.s&&(this.s=ee(T(this.Za,this),6e3));if(ln(this.b)<=1&&this.fa){try{this.fa()}catch(t){}this.fa=void 0}}else Wn(this,11)}else if(!t.s&&this.a!=t||jn(this),!O(e))for(e=n=this.ja.a.parse(e),n=0;n<e.length;n++){var r,i=e[n];this.O=i[0],i=i[1],2==this.u?"c"==i[0]?(this.H=i[1],this.ga=i[2],null!=(r=i[3])&&(this.wa=r),null!=(i=i[5])&&l(i)&&0<i&&(this.D=1.5*i),this.o&&(i=t.a)&&((r=Mn(i,"X-Client-Wire-Protocol"))&&cn(this.b,r),this.j&&(i=Mn(i,"X-HTTP-Session-Id")))&&(this.I=i,qe(this.B,this.j,i)),this.u=3,this.c&&this.c.va(),i=t,this.pa=Hn(this,this.Y()?this.ga:null,this.ha),i.s?(dn(this.b,i),(r=this.D)&&i.setTimeout(r),i.i&&(Ee(i),be(i)),this.a=i):Un(this),0<this.f.length&&qn(this)):"stop"!=i[0]&&"close"!=i[0]||Wn(this,7):3==this.u&&("stop"==i[0]||"close"==i[0]?"stop"==i[0]?Wn(this,7):Pn(this):"noop"!=i[0]&&this.c&&this.c.ua(i),this.v=0)}},_i.Za=function(){null!=this.s&&(this.s=null,this.a.cancel(),this.a=null,Qn(this),Zt())},_i.na=function(t){var e,n,r=null;if(this.a==t){jn(this),this.a=null;var i=2}else{if(!fn(this.b,t))return;r=t.j,dn(this.b,t),i=1}if(this.m=t.o,0!=this.u)if(t.b)1==i?(r=C()-t.v,Yt.dispatchEvent(new te(Yt,t.l&&t.l.length,this.A)),qn(this)):Un(this);else{var o=t.c;if(3==o||0==o&&0<this.m||(1!=i||(n=t,ln((e=this).b)>=e.b.f-(e.h?1:0)||(e.h?(e.f=n.j.concat(e.f),0):1==e.u||2==e.u||e.A>=(e.Pa?0:e.Qa)||(e.h=ee(T(e.Ia,e,n),Gn(e,e.A)),e.A++,0))))&&(2!=i||!Qn(this)))switch(r&&0<r.length&&(t=this.b,t.c=t.c.concat(r)),o){case 1:Wn(this,5);break;case 4:Wn(this,10);break;case 3:Wn(this,6);break;default:Wn(this,2)}}},_i.fb=function(t){Zt()},_i.$=function(t){if(t&&!this.R)throw Error("Can't create secondary domain capable XhrIo object.");return(t=new wn(this.La)).F=this.R,t},_i.ma=function(){return!!this.c&&!0},_i.Y=function(){return this.R},(_i=Yn.prototype).va=function(){},_i.ua=function(){},_i.ta=function(){},_i.sa=function(){},_i.Ta=function(){},Xn.prototype.a=function(t,e){return new Jn(t,e)},D(Jn,Nt),(_i=Jn.prototype).addEventListener=function(t,e,n,r){Jn.N.addEventListener.call(this,t,e,n,r)},_i.removeEventListener=function(t,e,n,r){Jn.N.removeEventListener.call(this,t,e,n,r)},_i.Wa=function(){this.a.c=this.f,this.l&&(this.a.R=!0);var t=this.a,e=this.m,n=this.g,r=this.b||void 0;Zt(),t.ha=n,t.V=r||{},t.o&&(t.F.b=[],t.F.a=!1),t.w=new en(t),null===t.g&&(t.w.h=t.i),n=e,t.g&&t.i&&(n=On(e,t.g,t.i)),(t=t.w).i=n,e=Hn(t.a,null,t.i),Zt(),null!=(n=t.a.F.b)?(t.f=n[0],t.M=1,nn(t)):(Fe(e,"MODE","init"),!t.a.o&&t.a.j&&Fe(e,"X-HTTP-Session-Id",t.a.j),t.b=new le(t,void 0,void 0),t.b.h=t.h,ye(t.b,e,!1,null),t.M=0)},_i.close=function(){Pn(this.a)},_i.Xa=function(t){var e;u(t)?((e={}).__data__=t,xn(this.a,e)):this.h?((e={}).__data__=kt(t),xn(this.a,e)):xn(this.a,t)},_i.G=function(){this.a.c=null,delete this.f,Pn(this.a),delete this.a,Jn.N.G.call(this)},D($n,ue),D(Zn,ce),D(tr,Yn),tr.prototype.va=function(){this.a.dispatchEvent("a")},tr.prototype.ua=function(t){this.a.dispatchEvent(new $n(t))},tr.prototype.ta=function(t){this.a.dispatchEvent(new Zn)},tr.prototype.sa=function(){this.a.dispatchEvent("b")};var er=I(function(t,e){function n(){}n.prototype=t.prototype;var r=new n;return t.apply(r,Array.prototype.slice.call(arguments,1)),r},Xn);Xn.prototype.createWebChannel=Xn.prototype.a,Jn.prototype.send=Jn.prototype.Xa,Jn.prototype.open=Jn.prototype.Wa,ne.NO_ERROR=0,ne.TIMEOUT=8,ne.HTTP_ERROR=6,re.COMPLETE="complete",(ae.EventType=se).OPEN="a",se.CLOSE="b",se.ERROR="c",se.MESSAGE="d",Nt.prototype.listen=Nt.prototype.Aa,wn.prototype.listenOnce=wn.prototype.Ba,wn.prototype.getLastError=wn.prototype.Ya,wn.prototype.getLastErrorCode=wn.prototype.ya,wn.prototype.getStatus=wn.prototype.T,wn.prototype.getStatusText=wn.prototype.za,wn.prototype.getResponseJson=wn.prototype.Va,wn.prototype.getResponseText=wn.prototype.aa,wn.prototype.send=wn.prototype.ca;var nr,rr={createWebChannelTransport:er,ErrorCode:ne,EventType:re,WebChannel:ae,XhrIo:wn},ir=rr.createWebChannelTransport,or=rr.ErrorCode,ar=rr.EventType,sr=rr.WebChannel,ur=rr.XhrIo,cr=(a(fr,nr=Error),fr),hr=(lr.prototype.create=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var r,i=e[0]||{},o=this.service+"/"+t,t=this.errors[t],t=t?(r=i,t.replace(dr,function(t,e){var n=r[e];return null!=n?n.toString():"<"+e+"?>"})):"Error",t=this.serviceName+": "+t+" ("+o+").",a=new cr(o,t),s=0,u=Object.keys(i);s<u.length;s++){var c=u[s];"_"!==c.slice(-1)&&(c in a&&console.warn('Overwriting FirebaseError base field "'+c+'" can cause unexpected behavior.'),a[c]=i[c])}return a},lr);function lr(t,e,n){this.service=t,this.serviceName=e,this.errors=n}function fr(t,e){e=nr.call(this,e)||this;return e.code=t,e.name="FirebaseError",Object.setPrototypeOf(e,fr.prototype),Error.captureStackTrace&&Error.captureStackTrace(e,hr.prototype.create),e}var pr,dr=/\{\$([^}]+)}/g,mr=Dp.SDK_VERSION,yr=new t("@firebase/firestore");function gr(){return yr.logLevel===o.DEBUG?pr.DEBUG:yr.logLevel===o.SILENT?pr.SILENT:pr.ERROR}function vr(t){switch(t){case pr.DEBUG:yr.logLevel=o.DEBUG;break;case pr.ERROR:yr.logLevel=o.ERROR;break;case pr.SILENT:yr.logLevel=o.SILENT;break;default:yr.error("Firestore ("+mr+"): Invalid value passed to `setLogLevel`")}}function br(t,e){for(var n,r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];yr.logLevel<=o.DEBUG&&(n=r.map(Er),yr.debug.apply(yr,["Firestore ("+mr+") ["+t+"]: "+e].concat(n)))}function wr(t){for(var e,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];yr.logLevel<=o.ERROR&&(e=n.map(Er),yr.error.apply(yr,["Firestore ("+mr+"): "+t].concat(e)))}function Er(t){if("string"==typeof t)return t;var e=Ir.getPlatform();try{return e.formatJSON(t)}catch(e){return t}}function Sr(t){t="FIRESTORE ("+mr+") INTERNAL ASSERTION FAILED: "+t;throw wr(t),new Error(t)}function Tr(t,e){t||Sr(e)}(Ip=pr=pr||{})[Ip.DEBUG=0]="DEBUG",Ip[Ip.ERROR=1]="ERROR",Ip[Ip.SILENT=2]="SILENT";var Ir=(Cr.setPlatform=function(t){Cr.platform&&Sr("Platform already defined"),Cr.platform=t},Cr.getPlatform=function(){return Cr.platform||Sr("Platform not set"),Cr.platform},Cr);function Cr(){}function Dr(){return Ir.getPlatform().emptyByteString}var Nr,Ar={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},kr=(a(Rr,Nr=Error),Rr);function Rr(t,e){var n=Nr.call(this,e)||this;return n.code=t,n.message=e,n.name="FirebaseError",n.toString=function(){return n.name+": [code="+n.code+"]: "+n.message},n}function Mr(t,e){function n(){var t="This constructor is private.";throw e&&(t+=" ",t+=e),new kr(Ar.INVALID_ARGUMENT,t)}for(var r in n.prototype=t.prototype,t)t.hasOwnProperty(r)&&(n[r]=t[r]);return n}function Or(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function _r(t,e){return void 0!==t?t:e}function Pr(t,e){for(var n in t){var r;Object.prototype.hasOwnProperty.call(t,n)&&(r=Number(n),isNaN(r)||e(r,t[n]))}}function Lr(t,e){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function xr(t){for(var e in Tr(null!=t&&"object"==typeof t,"isEmpty() expects object parameter."),t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}function qr(t,e){if(0!==e.length)throw new kr(Ar.INVALID_ARGUMENT,"Function "+t+"() does not support arguments, but was called with "+ti(e.length,"argument")+".")}function Fr(t,e,n){if(e.length!==n)throw new kr(Ar.INVALID_ARGUMENT,"Function "+t+"() requires "+ti(n,"argument")+", but was called with "+ti(e.length,"argument")+".")}function Vr(t,e,n){if(e.length<n)throw new kr(Ar.INVALID_ARGUMENT,"Function "+t+"() requires at least "+ti(n,"argument")+", but was called with "+ti(e.length,"argument")+".")}function Br(t,e,n,r){if(e.length<n||e.length>r)throw new kr(Ar.INVALID_ARGUMENT,"Function "+t+"() requires between "+n+" and "+r+" arguments, but was called with "+ti(e.length,"argument")+".")}function Ur(t,e,n,r){zr(t,e,Zr(n)+" argument",r)}function Qr(t,e,n,r){void 0!==r&&Ur(t,e,n,r)}function Kr(t,e,n,r){zr(t,e,n+" option",r)}function jr(t,e,n,r){void 0!==r&&Kr(t,e,n,r)}function Gr(t,e,n,r,i){void 0!==r&&function(t,e,n,r,i){if(!(r instanceof Array))throw new kr(Ar.INVALID_ARGUMENT,"Function "+t+"() requires its "+e+" option to be an array, but it was: "+Yr(r));for(var o=0;o<r.length;++o)if(!i(r[o]))throw new kr(Ar.INVALID_ARGUMENT,"Function "+t+"() requires all "+e+" elements to be "+n+", but the value at index "+o+" was: "+Yr(r[o]))}(t,e,n,r,i)}function Wr(t,e,n,r,u){void 0!==r&&function(t,e,n){for(var r=[],i=0,o=u;i<o.length;i++){var a=o[i];if(a===n)return;r.push(Yr(a))}var s=Yr(n);throw new kr(Ar.INVALID_ARGUMENT,"Invalid value "+s+" provided to function "+t+'() for option "'+e+'". Acceptable values: '+r.join(", "))}(t,n,r)}function zr(t,e,n,r){if(!("object"===e?Hr(r):"non-empty string"===e?"string"==typeof r&&""!==r:typeof r===e)){r=Yr(r);throw new kr(Ar.INVALID_ARGUMENT,"Function "+t+"() requires its "+n+" to be of type "+e+", but it was: "+r)}}function Hr(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}function Yr(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return 20<t.length&&(t=t.substring(0,20)+"..."),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"!=typeof t)return"function"==typeof t?"a function":Sr("Unknown wrong type: "+typeof t);if(t instanceof Array)return"an array";t=function(t){if(t.constructor){t=/function\s+([^\s(]+)\s*\(/.exec(t.constructor.toString());if(t&&1<t.length)return t[1]}return null}(t);return t?"a custom "+t+" object":"an object"}function Xr(t,e,n){if(void 0===n)throw new kr(Ar.INVALID_ARGUMENT,"Function "+t+"() requires a valid "+Zr(e)+" argument, but it was undefined.")}function Jr(n,t,r){Lr(t,function(t,e){if(r.indexOf(t)<0)throw new kr(Ar.INVALID_ARGUMENT,"Unknown option '"+t+"' passed to function "+n+"(). Available options: "+r.join(", "))})}function $r(t,e,n,r){r=Yr(r);return new kr(Ar.INVALID_ARGUMENT,"Function "+t+"() requires its "+Zr(n)+" argument to be a "+e+", but it was: "+r)}function Zr(t){switch(t){case 1:return"first";case 2:return"second";case 3:return"third";default:return t+"th"}}function ti(t,e){return t+" "+e+(1===t?"":"s")}var ei=(ni.newId=function(){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="",n=0;n<20;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return Tr(20===e.length,"Invalid auto ID: "+e),e},ni);function ni(){}function ri(t,e){return t<e?-1:e<t?1:0}function ii(t,e){if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(!t[n].isEqual(e[n]))return!1;return!0}function oi(t){return t+"\0"}function ai(){if("undefined"==typeof Uint8Array)throw new kr(Ar.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}function si(){if(!Ir.getPlatform().base64Available)throw new kr(Ar.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}function ui(t,e,n,r,i){this.databaseId=t,this.persistenceKey=e,this.host=n,this.ssl=r,this.forceLongPolling=i}var ci,hi,li,fi,pi,di,mi,yi=(Yi.fromBase64String=function(t){Fr("Blob.fromBase64String",arguments,1),Ur("Blob.fromBase64String","string",1,t),si();try{return new Yi(Ir.getPlatform().atob(t))}catch(t){throw new kr(Ar.INVALID_ARGUMENT,"Failed to construct Blob from Base64 string: "+t)}},Yi.fromUint8Array=function(t){if(Fr("Blob.fromUint8Array",arguments,1),ai(),!(t instanceof Uint8Array))throw $r("Blob.fromUint8Array","Uint8Array",1,t);return new Yi(Array.prototype.map.call(t,function(t){return String.fromCharCode(t)}).join(""))},Yi.prototype.toBase64=function(){return Fr("Blob.toBase64",arguments,0),si(),Ir.getPlatform().btoa(this._binaryString)},Yi.prototype.toUint8Array=function(){Fr("Blob.toUint8Array",arguments,0),ai();for(var t=new Uint8Array(this._binaryString.length),e=0;e<this._binaryString.length;e++)t[e]=this._binaryString.charCodeAt(e);return t},Yi.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},Yi.prototype.isEqual=function(t){return this._binaryString===t._binaryString},Yi.prototype._compareTo=function(t){return ri(this._binaryString,t._binaryString)},Yi),gi=Mr(yi,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead."),vi=(Object.defineProperty(Hi.prototype,"latitude",{get:function(){return this._lat},enumerable:!0,configurable:!0}),Object.defineProperty(Hi.prototype,"longitude",{get:function(){return this._long},enumerable:!0,configurable:!0}),Hi.prototype.isEqual=function(t){return this._lat===t._lat&&this._long===t._long},Hi.prototype._compareTo=function(t){return ri(this._lat,t._lat)||ri(this._long,t._long)},Hi),bi=(zi.now=function(){return zi.fromMillis(Date.now())},zi.fromDate=function(t){return zi.fromMillis(t.getTime())},zi.fromMillis=function(t){var e=Math.floor(t/1e3);return new zi(e,1e6*(t-1e3*e))},zi.prototype.toDate=function(){return new Date(this.toMillis())},zi.prototype.toMillis=function(){return 1e3*this.seconds+this.nanoseconds/1e6},zi.prototype._compareTo=function(t){return this.seconds===t.seconds?ri(this.nanoseconds,t.nanoseconds):ri(this.seconds,t.seconds)},zi.prototype.isEqual=function(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds},zi.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"},zi),wi="(default)",Ei=(Object.defineProperty(Wi.prototype,"isDefaultDatabase",{get:function(){return this.database===wi},enumerable:!0,configurable:!0}),Wi.prototype.isEqual=function(t){return t instanceof Wi&&t.projectId===this.projectId&&t.database===this.database},Wi.prototype.compareTo=function(t){return ri(this.projectId,t.projectId)||ri(this.database,t.database)},Wi),Si="__name__",s=(Gi.prototype.init=function(t,e,n){void 0===e?e=0:e>t.length&&Sr("offset "+e+" out of range "+t.length),void 0===n?n=t.length-e:n>t.length-e&&Sr("length "+n+" out of range "+(t.length-e)),this.segments=t,this.offset=e,this.len=n},Gi.prototype.construct=function(t,e,n){var r=Object.create(Object.getPrototypeOf(this));return r.init(t,e,n),r},Object.defineProperty(Gi.prototype,"length",{get:function(){return this.len},enumerable:!0,configurable:!0}),Gi.prototype.isEqual=function(t){return 0===Gi.comparator(this,t)},Gi.prototype.child=function(t){var e=this.segments.slice(this.offset,this.limit());return t instanceof Gi?t.forEach(function(t){e.push(t)}):"string"==typeof t?e.push(t):Sr("Unknown parameter type for Path.child(): "+t),this.construct(e)},Gi.prototype.limit=function(){return this.offset+this.length},Gi.prototype.popFirst=function(t){return Tr(this.length>=(t=void 0===t?1:t),"Can't call popFirst() with less segments"),this.construct(this.segments,this.offset+t,this.length-t)},Gi.prototype.popLast=function(){return Tr(!this.isEmpty(),"Can't call popLast() on empty path"),this.construct(this.segments,this.offset,this.length-1)},Gi.prototype.firstSegment=function(){return Tr(!this.isEmpty(),"Can't call firstSegment() on empty path"),this.segments[this.offset]},Gi.prototype.lastSegment=function(){return this.get(this.length-1)},Gi.prototype.get=function(t){return Tr(t<this.length,"Index out of range"),this.segments[this.offset+t]},Gi.prototype.isEmpty=function(){return 0===this.length},Gi.prototype.isPrefixOf=function(t){if(t.length<this.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},Gi.prototype.isImmediateParentOf=function(t){if(this.length+1!==t.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},Gi.prototype.forEach=function(t){for(var e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])},Gi.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())},Gi.comparator=function(t,e){for(var n=Math.min(t.length,e.length),r=0;r<n;r++){var i=t.get(r),o=e.get(r);if(i<o)return-1;if(o<i)return 1}return t.length<e.length?-1:t.length>e.length?1:0},Gi),Ti=(a(ji,mi=s),ji.prototype.canonicalString=function(){return this.toArray().join("/")},ji.prototype.toString=function(){return this.canonicalString()},ji.fromString=function(t){if(0<=t.indexOf("//"))throw new kr(Ar.INVALID_ARGUMENT,"Invalid path ("+t+"). Paths must not contain // in them.");return new ji(t.split("/").filter(function(t){return 0<t.length}))},ji.EMPTY_PATH=new ji([]),ji),Ii=/^[_a-zA-Z][_a-zA-Z0-9]*$/,Ci=(a(Ki,di=s),Ki.isValidIdentifier=function(t){return Ii.test(t)},Ki.prototype.canonicalString=function(){return this.toArray().map(function(t){return t=t.replace("\\","\\\\").replace("`","\\`"),t=!Ki.isValidIdentifier(t)?"`"+t+"`":t}).join(".")},Ki.prototype.toString=function(){return this.canonicalString()},Ki.prototype.isKeyField=function(){return 1===this.length&&this.get(0)===Si},Ki.keyField=function(){return new Ki([Si])},Ki.fromServerFormat=function(t){for(var e=[],n="",r=0,i=function(){if(0===n.length)throw new kr(Ar.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");e.push(n),n=""},o=!1;r<t.length;){var a=t[r];if("\\"===a){if(r+1===t.length)throw new kr(Ar.INVALID_ARGUMENT,"Path has trailing escape character: "+t);var s=t[r+1];if("\\"!==s&&"."!==s&&"`"!==s)throw new kr(Ar.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=s,r+=2}else"`"===a?o=!o:"."!==a||o?n+=a:i(),r++}if(i(),o)throw new kr(Ar.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new Ki(e)},Ki.EMPTY_PATH=new Ki([]),Ki),Di=(Qi.prototype.hasCollectionId=function(t){return 2<=this.path.length&&this.path.get(this.path.length-2)===t},Qi.prototype.isEqual=function(t){return null!==t&&0===Ti.comparator(this.path,t.path)},Qi.prototype.toString=function(){return this.path.toString()},Qi.comparator=function(t,e){return Ti.comparator(t.path,e.path)},Qi.isDocumentKey=function(t){return t.length%2==0},Qi.fromSegments=function(t){return new Qi(new Ti(t.slice()))},Qi.fromPathString=function(t){return new Qi(Ti.fromString(t))},Qi.EMPTY=new Qi(new Ti([])),Qi),et=(Ui.compareByKey=function(t,e){return Di.comparator(t.key,e.key)},Ui),Ni=(a(Bi,pi=et),Bi.prototype.field=function(t){return this.data.field(t)},Bi.prototype.fieldValue=function(t){t=this.field(t);return t?t.value():void 0},Bi.prototype.value=function(){return this.data.value()},Bi.prototype.isEqual=function(t){return t instanceof Bi&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.data.isEqual(t.data)&&this.hasLocalMutations===t.hasLocalMutations&&this.hasCommittedMutations===t.hasCommittedMutations},Bi.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.data.toString()+", {hasLocalMutations: "+this.hasLocalMutations+"}), {hasCommittedMutations: "+this.hasCommittedMutations+"})"},Object.defineProperty(Bi.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:!0,configurable:!0}),Bi.compareByField=function(t,e,n){e=e.field(t),t=n.field(t);return void 0!==e&&void 0!==t?e.compareTo(t):Sr("Trying to compare documents on fields that don't exist")},Bi),Ai=(a(Vi,fi=et),Vi.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"},Object.defineProperty(Vi.prototype,"hasPendingWrites",{get:function(){return this.hasCommittedMutations},enumerable:!0,configurable:!0}),Vi.prototype.isEqual=function(t){return t instanceof Vi&&t.hasCommittedMutations===this.hasCommittedMutations&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},Vi),ki=(a(Fi,li=et),Fi.prototype.toString=function(){return"UnknownDocument("+this.key+", "+this.version+")"},Object.defineProperty(Fi.prototype,"hasPendingWrites",{get:function(){return!0},enumerable:!0,configurable:!0}),Fi.prototype.isEqual=function(t){return t instanceof Fi&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},Fi),Ri=(qi.prototype.insert=function(t,e){return new qi(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,Oi.BLACK,null,null))},qi.prototype.remove=function(t){return new qi(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Oi.BLACK,null,null))},qi.prototype.get=function(t){for(var e=this.root;!e.isEmpty();){var n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:0<n&&(e=e.right)}return null},qi.prototype.indexOf=function(t){for(var e=0,n=this.root;!n.isEmpty();){var r=this.comparator(t,n.key);if(0===r)return e+n.left.size;n=r<0?n.left:(e+=n.left.size+1,n.right)}return-1},qi.prototype.isEmpty=function(){return this.root.isEmpty()},Object.defineProperty(qi.prototype,"size",{get:function(){return this.root.size},enumerable:!0,configurable:!0}),qi.prototype.minKey=function(){return this.root.minKey()},qi.prototype.maxKey=function(){return this.root.maxKey()},qi.prototype.inorderTraversal=function(t){return this.root.inorderTraversal(t)},qi.prototype.forEach=function(n){this.inorderTraversal(function(t,e){return n(t,e),!1})},qi.prototype.toString=function(){var n=[];return this.inorderTraversal(function(t,e){return n.push(t+":"+e),!1}),"{"+n.join(", ")+"}"},qi.prototype.reverseTraversal=function(t){return this.root.reverseTraversal(t)},qi.prototype.getIterator=function(){return new Mi(this.root,null,this.comparator,!1)},qi.prototype.getIteratorFrom=function(t){return new Mi(this.root,t,this.comparator,!1)},qi.prototype.getReverseIterator=function(){return new Mi(this.root,null,this.comparator,!0)},qi.prototype.getReverseIteratorFrom=function(t){return new Mi(this.root,t,this.comparator,!0)},qi),Mi=(xi.prototype.getNext=function(){Tr(0<this.nodeStack.length,"getNext() called on iterator when hasNext() is false.");var t=this.nodeStack.pop(),e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e},xi.prototype.hasNext=function(){return 0<this.nodeStack.length},xi.prototype.peek=function(){if(0===this.nodeStack.length)return null;var t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}},xi),Oi=(Li.prototype.copy=function(t,e,n,r,i){return new Li(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)},Li.prototype.isEmpty=function(){return!1},Li.prototype.inorderTraversal=function(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)},Li.prototype.reverseTraversal=function(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)},Li.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()},Li.prototype.minKey=function(){return this.min().key},Li.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},Li.prototype.insert=function(t,e,n){var r=this,i=n(t,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===i?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n))).fixUp()},Li.prototype.removeMin=function(){if(this.left.isEmpty())return Li.EMPTY;var t=this;return(t=(t=!t.left.isRed()&&!t.left.left.isRed()?t.moveRedLeft():t).copy(null,null,null,t.left.removeMin(),null)).fixUp()},Li.prototype.remove=function(t,e){var n,r=this;if(e(t,r.key)<0)r=(r=!(r.left.isEmpty()||r.left.isRed()||r.left.left.isRed())?r.moveRedLeft():r).copy(null,null,null,r.left.remove(t,e),null);else{if(0===e(t,(r=!((r=r.left.isRed()?r.rotateRight():r).right.isEmpty()||r.right.isRed()||r.right.left.isRed())?r.moveRedRight():r).key)){if(r.right.isEmpty())return Li.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp()},Li.prototype.isRed=function(){return this.color},Li.prototype.fixUp=function(){var t=this;return t=(t=(t=t.right.isRed()&&!t.left.isRed()?t.rotateLeft():t).left.isRed()&&t.left.left.isRed()?t.rotateRight():t).left.isRed()&&t.right.isRed()?t.colorFlip():t},Li.prototype.moveRedLeft=function(){var t=this.colorFlip();return t=t.right.left.isRed()?(t=(t=t.copy(null,null,null,null,t.right.rotateRight())).rotateLeft()).colorFlip():t},Li.prototype.moveRedRight=function(){var t=this.colorFlip();return t=t.left.left.isRed()?(t=t.rotateRight()).colorFlip():t},Li.prototype.rotateLeft=function(){var t=this.copy(null,null,Li.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)},Li.prototype.rotateRight=function(){var t=this.copy(null,null,Li.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)},Li.prototype.colorFlip=function(){var t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)},Li.prototype.checkMaxDepth=function(){var t=this.check();return Math.pow(2,t)<=this.size+1},Li.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw Sr("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed())throw Sr("Right child of ("+this.key+","+this.value+") is red");var t=this.left.check();if(t!==this.right.check())throw Sr("Black depths differ");return t+(this.isRed()?0:1)},Li.EMPTY=null,Li.RED=!0,Li.BLACK=!1,Li),_i=(Pi.prototype.copy=function(t,e,n,r,i){return this},Pi.prototype.insert=function(t,e,n){return new Oi(t,e)},Pi.prototype.remove=function(t,e){return this},Pi.prototype.isEmpty=function(){return!0},Pi.prototype.inorderTraversal=function(t){return!1},Pi.prototype.reverseTraversal=function(t){return!1},Pi.prototype.minKey=function(){return null},Pi.prototype.maxKey=function(){return null},Pi.prototype.isRed=function(){return!1},Pi.prototype.checkMaxDepth=function(){return!0},Pi.prototype.check=function(){return 0},Pi);function Pi(){this.size=0}function Li(t,e,n,r,i){this.key=t,this.value=e,this.color=null!=n?n:Li.RED,this.left=null!=r?r:Li.EMPTY,this.right=null!=i?i:Li.EMPTY,this.size=this.left.size+1+this.right.size}function xi(t,e,n,r){this.isReverse=r,this.nodeStack=[];for(var i=1;!t.isEmpty();)if(i=e?n(t.key,e):1,r&&(i*=-1),i<0)t=this.isReverse?t.left:t.right;else{if(0===i){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}function qi(t,e){this.comparator=t,this.root=e||Oi.EMPTY}function Fi(t,e){return li.call(this,t,e)||this}function Vi(t,e,n){e=fi.call(this,t,e)||this;return e.hasCommittedMutations=!(!n||!n.hasCommittedMutations),e}function Bi(t,e,n,r,i){e=pi.call(this,t,e)||this;return e.data=n,e.proto=i,e.hasLocalMutations=!!r.hasLocalMutations,e.hasCommittedMutations=!!r.hasCommittedMutations,e}function Ui(t,e){this.key=t,this.version=e}function Qi(t){this.path=t,Tr(Qi.isDocumentKey(t),"Invalid DocumentKey with an odd number of segments: "+t.toArray().join("/"))}function Ki(){return null!==di&&di.apply(this,arguments)||this}function ji(){return null!==mi&&mi.apply(this,arguments)||this}function Gi(t,e,n){this.init(t,e,n)}function Wi(t,e){this.projectId=t,this.database=e||wi}function zi(t,e){if(this.seconds=t,(this.nanoseconds=e)<0)throw new kr(Ar.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(1e9<=e)throw new kr(Ar.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new kr(Ar.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(253402300800<=t)throw new kr(Ar.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}function Hi(t,e){if(Fr("GeoPoint",arguments,2),Ur("GeoPoint","number",1,t),Ur("GeoPoint","number",2,e),!isFinite(t)||t<-90||90<t)throw new kr(Ar.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||180<e)throw new kr(Ar.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}function Yi(t){si(),this._binaryString=t}Oi.EMPTY=new _i,(se=ci=ci||{})[se.NullValue=0]="NullValue",se[se.BooleanValue=1]="BooleanValue",se[se.NumberValue=2]="NumberValue",se[se.TimestampValue=3]="TimestampValue",se[se.StringValue=4]="StringValue",se[se.BlobValue=5]="BlobValue",se[se.RefValue=6]="RefValue",se[se.GeoPointValue=7]="GeoPointValue",se[se.ArrayValue=8]="ArrayValue",se[se.ObjectValue=9]="ObjectValue",(er=hi=hi||{})[er.Default=0]="Default",er[er.Estimate=1]="Estimate",er[er.Previous=2]="Previous";var Xi,Ji,$i,Zi=(so.fromSnapshotOptions=function(t,e){switch(t.serverTimestamps){case"estimate":return new so(hi.Estimate,e);case"previous":return new so(hi.Previous,e);case"none":case void 0:return new so(hi.Default,e);default:return Sr("fromSnapshotOptions() called with invalid options.")}},so),ne=(ao.prototype.toString=function(){var t=this.value();return null===t?"null":t.toString()},ao.prototype.defaultCompareTo=function(t){return Tr(this.typeOrder!==t.typeOrder,"Default compareTo should not be used for values of same type."),ri(this.typeOrder,t.typeOrder)},ao),to=(a(oo,$i=ne),oo.prototype.value=function(t){return null},oo.prototype.isEqual=function(t){return t instanceof oo},oo.prototype.compareTo=function(t){return t instanceof oo?0:this.defaultCompareTo(t)},oo.INSTANCE=new oo,oo),eo=(a(io,Ji=ne),io.prototype.value=function(t){return this.internalValue},io.prototype.isEqual=function(t){return t instanceof io&&this.internalValue===t.internalValue},io.prototype.compareTo=function(t){return t instanceof io?ri(this,t):this.defaultCompareTo(t)},io.of=function(t){return t?io.TRUE:io.FALSE},io.TRUE=new io(!0),io.FALSE=new io(!1),io),no=(a(ro,Xi=ne),ro.prototype.value=function(t){return this.internalValue},ro.prototype.compareTo=function(t){return t instanceof ro?(e=this.internalValue)<(n=t.internalValue)?-1:n<e?1:e===n?0:isNaN(e)?isNaN(n)?0:-1:1:this.defaultCompareTo(t);var e,n},ro);function ro(t){var e=Xi.call(this)||this;return e.internalValue=t,e.typeOrder=ci.NumberValue,e}function io(t){var e=Ji.call(this)||this;return e.internalValue=t,e.typeOrder=ci.BooleanValue,e}function oo(){var t=$i.call(this)||this;return t.typeOrder=ci.NullValue,t.internalValue=null,t}function ao(){}function so(t,e){this.serverTimestampBehavior=t,this.timestampsInSnapshots=e}function uo(t,e){return t===e?0!==t||1/t==1/e:t!=t&&e!=e}var co,ho,lo,fo,po,mo,yo,go,vo,bo,wo=(a(Qo,bo=no),Qo.prototype.isEqual=function(t){return t instanceof Qo&&uo(this.internalValue,t.internalValue)},Qo),Eo=(a(Uo,vo=no),Uo.prototype.isEqual=function(t){return t instanceof Uo&&uo(this.internalValue,t.internalValue)},Uo.NAN=new Uo(NaN),Uo.POSITIVE_INFINITY=new Uo(1/0),Uo.NEGATIVE_INFINITY=new Uo(-1/0),Uo),So=(a(Bo,go=ne),Bo.prototype.value=function(t){return this.internalValue},Bo.prototype.isEqual=function(t){return t instanceof Bo&&this.internalValue===t.internalValue},Bo.prototype.compareTo=function(t){return t instanceof Bo?ri(this.internalValue,t.internalValue):this.defaultCompareTo(t)},Bo),To=(a(Vo,yo=ne),Vo.prototype.value=function(t){return!t||t.timestampsInSnapshots?this.internalValue:this.internalValue.toDate()},Vo.prototype.isEqual=function(t){return t instanceof Vo&&this.internalValue.isEqual(t.internalValue)},Vo.prototype.compareTo=function(t){return t instanceof Vo?this.internalValue._compareTo(t.internalValue):t instanceof Io?-1:this.defaultCompareTo(t)},Vo),Io=(a(Fo,mo=ne),Fo.prototype.value=function(t){return t&&t.serverTimestampBehavior===hi.Estimate?new To(this.localWriteTime).value(t):t&&t.serverTimestampBehavior===hi.Previous&&this.previousValue?this.previousValue.value(t):null},Fo.prototype.isEqual=function(t){return t instanceof Fo&&this.localWriteTime.isEqual(t.localWriteTime)},Fo.prototype.compareTo=function(t){return t instanceof Fo?this.localWriteTime._compareTo(t.localWriteTime):t instanceof To?1:this.defaultCompareTo(t)},Fo.prototype.toString=function(){return"<ServerTimestamp localTime="+this.localWriteTime.toString()+">"},Fo),Co=(a(qo,po=ne),qo.prototype.value=function(t){return this.internalValue},qo.prototype.isEqual=function(t){return t instanceof qo&&this.internalValue.isEqual(t.internalValue)},qo.prototype.compareTo=function(t){return t instanceof qo?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},qo),Do=(a(xo,fo=ne),xo.prototype.value=function(t){return this.key},xo.prototype.isEqual=function(t){return t instanceof xo&&this.key.isEqual(t.key)&&this.databaseId.isEqual(t.databaseId)},xo.prototype.compareTo=function(t){if(t instanceof xo){var e=this.databaseId.compareTo(t.databaseId);return 0!==e?e:Di.comparator(this.key,t.key)}return this.defaultCompareTo(t)},xo),No=(a(Lo,lo=ne),Lo.prototype.value=function(t){return this.internalValue},Lo.prototype.isEqual=function(t){return t instanceof Lo&&this.internalValue.isEqual(t.internalValue)},Lo.prototype.compareTo=function(t){return t instanceof Lo?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},Lo),Ao=(a(Po,ho=ne),Po.prototype.value=function(n){var r={};return this.internalValue.inorderTraversal(function(t,e){r[t]=e.value(n)}),r},Po.prototype.forEach=function(t){this.internalValue.inorderTraversal(t)},Po.prototype.isEqual=function(t){if(t instanceof Po){for(var e=this.internalValue.getIterator(),n=t.internalValue.getIterator();e.hasNext()&&n.hasNext();){var r=e.getNext(),i=n.getNext();if(r.key!==i.key||!r.value.isEqual(i.value))return!1}return!e.hasNext()&&!n.hasNext()}return!1},Po.prototype.compareTo=function(t){if(t instanceof Po){for(var e=this.internalValue.getIterator(),n=t.internalValue.getIterator();e.hasNext()&&n.hasNext();){var r=e.getNext(),i=n.getNext(),i=ri(r.key,i.key)||r.value.compareTo(i.value);if(i)return i}return ri(e.hasNext(),n.hasNext())}return this.defaultCompareTo(t)},Po.prototype.set=function(t,e){if(Tr(!t.isEmpty(),"Cannot set field for empty path on ObjectValue"),1===t.length)return this.setChild(t.firstSegment(),e);var n=this.child(t.firstSegment()),e=(n=!(n instanceof Po)?Po.EMPTY:n).set(t.popFirst(),e);return this.setChild(t.firstSegment(),e)},Po.prototype.delete=function(t){if(Tr(!t.isEmpty(),"Cannot delete field for empty path on ObjectValue"),1===t.length)return new Po(this.internalValue.remove(t.firstSegment()));var e=this.child(t.firstSegment());if(e instanceof Po){e=e.delete(t.popFirst());return new Po(this.internalValue.insert(t.firstSegment(),e))}return this},Po.prototype.contains=function(t){return void 0!==this.field(t)},Po.prototype.field=function(t){Tr(!t.isEmpty(),"Can't get field of empty path");var e=this;return t.forEach(function(t){e=e instanceof Po&&e.internalValue.get(t)||void 0}),e},Po.prototype.toString=function(){return this.internalValue.toString()},Po.prototype.child=function(t){return this.internalValue.get(t)||void 0},Po.prototype.setChild=function(t,e){return new Po(this.internalValue.insert(t,e))},Po.EMPTY=new Po(new Ri(ri)),Po),ko=(a(_o,co=ne),_o.prototype.value=function(e){return this.internalValue.map(function(t){return t.value(e)})},_o.prototype.forEach=function(t){this.internalValue.forEach(t)},_o.prototype.isEqual=function(t){if(t instanceof _o){if(this.internalValue.length!==t.internalValue.length)return!1;for(var e=0;e<this.internalValue.length;e++)if(!this.internalValue[e].isEqual(t.internalValue[e]))return!1;return!0}return!1},_o.prototype.compareTo=function(t){if(t instanceof _o){for(var e=Math.min(this.internalValue.length,t.internalValue.length),n=0;n<e;n++){var r=this.internalValue[n].compareTo(t.internalValue[n]);if(r)return r}return ri(this.internalValue.length,t.internalValue.length)}return this.defaultCompareTo(t)},_o.prototype.toString=function(){return"["+this.internalValue.map(function(t){return t.toString()}).join(",")+"]"},_o),re=Number,Ro=re.MIN_SAFE_INTEGER||-(Math.pow(2,53)-1),Mo=re.MAX_SAFE_INTEGER||Math.pow(2,53)-1,Oo=re.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t};function _o(t){var e=co.call(this)||this;return e.internalValue=t,e.typeOrder=ci.ArrayValue,e}function Po(t){var e=ho.call(this)||this;return e.internalValue=t,e.typeOrder=ci.ObjectValue,e}function Lo(t){var e=lo.call(this)||this;return e.internalValue=t,e.typeOrder=ci.GeoPointValue,e}function xo(t,e){var n=fo.call(this)||this;return n.databaseId=t,n.key=e,n.typeOrder=ci.RefValue,n}function qo(t){var e=po.call(this)||this;return e.internalValue=t,e.typeOrder=ci.BlobValue,e}function Fo(t,e){var n=mo.call(this)||this;return n.localWriteTime=t,n.previousValue=e,n.typeOrder=ci.TimestampValue,n}function Vo(t){var e=yo.call(this)||this;return e.internalValue=t,e.typeOrder=ci.TimestampValue,e}function Bo(t){var e=go.call(this)||this;return e.internalValue=t,e.typeOrder=ci.StringValue,e}function Uo(t){var e=vo.call(this,t)||this;return e.internalValue=t,e}function Qo(t){return bo.call(this,t)||this}function Ko(t){return null==t}function jo(t){return Oo(t)&&t<=Mo&&Ro<=t}var Go,Wo,zo,Ho,Yo=(ya.atPath=function(t){return new ya(t)},Object.defineProperty(ya.prototype,"orderBy",{get:function(){if(null===this.memoizedOrderBy){var t=this.getInequalityFilterField(),e=this.getFirstOrderByField();if(null!==t&&null===e)t.isKeyField()?this.memoizedOrderBy=[ia]:this.memoizedOrderBy=[new ra(t),ia];else{Tr(null===t||null!==e&&t.isEqual(e),"First orderBy should match inequality field.");for(var n=!(this.memoizedOrderBy=[]),r=0,i=this.explicitOrderBy;r<i.length;r++){var o=i[r];this.memoizedOrderBy.push(o),o.field.isKeyField()&&(n=!0)}n||(e=0<this.explicitOrderBy.length?this.explicitOrderBy[this.explicitOrderBy.length-1].dir:ea.ASCENDING,this.memoizedOrderBy.push(e===ea.ASCENDING?ia:oa))}}return this.memoizedOrderBy},enumerable:!0,configurable:!0}),ya.prototype.addFilter=function(t){Tr(null==this.getInequalityFilterField()||!(t instanceof $o)||!t.isInequality()||t.field.isEqual(this.getInequalityFilterField()),"Query must only have one inequality field."),Tr(!this.isDocumentQuery(),"No filtering allowed for document query");t=this.filters.concat([t]);return new ya(this.path,this.collectionGroup,this.explicitOrderBy.slice(),t,this.limit,this.startAt,this.endAt)},ya.prototype.addOrderBy=function(t){Tr(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");t=this.explicitOrderBy.concat([t]);return new ya(this.path,this.collectionGroup,t,this.filters.slice(),this.limit,this.startAt,this.endAt)},ya.prototype.withLimit=function(t){return new ya(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),t,this.startAt,this.endAt)},ya.prototype.withStartAt=function(t){return new ya(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,t,this.endAt)},ya.prototype.withEndAt=function(t){return new ya(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,t)},ya.prototype.asCollectionQueryAtPath=function(t){return new ya(t,null,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,this.endAt)},ya.prototype.canonicalId=function(){if(null===this.memoizedCanonicalId){var t=this.path.canonicalString();this.isCollectionGroupQuery()&&(t+="|cg:"+this.collectionGroup),t+="|f:";for(var e=0,n=this.filters;e<n.length;e++)t+=n[e].canonicalId(),t+=",";t+="|ob:";for(var r=0,i=this.orderBy;r<i.length;r++)t+=i[r].canonicalId(),t+=",";Ko(this.limit)||(t+="|l:",t+=this.limit),this.startAt&&(t+="|lb:",t+=this.startAt.canonicalId()),this.endAt&&(t+="|ub:",t+=this.endAt.canonicalId()),this.memoizedCanonicalId=t}return this.memoizedCanonicalId},ya.prototype.toString=function(){var t="Query("+this.path.canonicalString();return this.isCollectionGroupQuery()&&(t+=" collectionGroup="+this.collectionGroup),0<this.filters.length&&(t+=", filters: ["+this.filters.join(", ")+"]"),Ko(this.limit)||(t+=", limit: "+this.limit),0<this.explicitOrderBy.length&&(t+=", orderBy: ["+this.explicitOrderBy.join(", ")+"]"),this.startAt&&(t+=", startAt: "+this.startAt.canonicalId()),this.endAt&&(t+=", endAt: "+this.endAt.canonicalId()),t+")"},ya.prototype.isEqual=function(t){if(this.limit!==t.limit)return!1;if(this.orderBy.length!==t.orderBy.length)return!1;for(var e=0;e<this.orderBy.length;e++)if(!this.orderBy[e].isEqual(t.orderBy[e]))return!1;if(this.filters.length!==t.filters.length)return!1;for(e=0;e<this.filters.length;e++)if(!this.filters[e].isEqual(t.filters[e]))return!1;return this.collectionGroup===t.collectionGroup&&!!this.path.isEqual(t.path)&&!(null!==this.startAt?!this.startAt.isEqual(t.startAt):null!==t.startAt)&&(null!==this.endAt?this.endAt.isEqual(t.endAt):null===t.endAt)},ya.prototype.docComparator=function(t,e){for(var n=!1,r=0,i=this.orderBy;r<i.length;r++){var o=i[r],a=o.compare(t,e);if(0!==a)return a;n=n||o.field.isKeyField()}return Tr(n,"orderBy used that doesn't compare on key field"),0},ya.prototype.matches=function(t){return this.matchesPathAndCollectionGroup(t)&&this.matchesOrderBy(t)&&this.matchesFilters(t)&&this.matchesBounds(t)},ya.prototype.hasLimit=function(){return!Ko(this.limit)},ya.prototype.getFirstOrderByField=function(){return 0<this.explicitOrderBy.length?this.explicitOrderBy[0].field:null},ya.prototype.getInequalityFilterField=function(){for(var t=0,e=this.filters;t<e.length;t++){var n=e[t];if(n instanceof $o&&n.isInequality())return n.field}return null},ya.prototype.hasArrayContainsFilter=function(){return void 0!==this.filters.find(function(t){return t instanceof $o&&t.op===Jo.ARRAY_CONTAINS})},ya.prototype.isDocumentQuery=function(){return Di.isDocumentKey(this.path)&&null===this.collectionGroup&&0===this.filters.length},ya.prototype.isCollectionGroupQuery=function(){return null!==this.collectionGroup},ya.prototype.matchesPathAndCollectionGroup=function(t){var e=t.key.path;return null!==this.collectionGroup?t.key.hasCollectionId(this.collectionGroup)&&this.path.isPrefixOf(e):Di.isDocumentKey(this.path)?this.path.isEqual(e):this.path.isImmediateParentOf(e)},ya.prototype.matchesOrderBy=function(t){for(var e=0,n=this.explicitOrderBy;e<n.length;e++){var r=n[e];if(!r.field.isKeyField()&&void 0===t.field(r.field))return!1}return!0},ya.prototype.matchesFilters=function(t){for(var e=0,n=this.filters;e<n.length;e++)if(!n[e].matches(t))return!1;return!0},ya.prototype.matchesBounds=function(t){return!(this.startAt&&!this.startAt.sortsBeforeDocument(this.orderBy,t)||this.endAt&&this.endAt.sortsBeforeDocument(this.orderBy,t))},ya.prototype.assertValidBound=function(t){Tr(t.position.length<=this.orderBy.length,"Bound is longer than orderBy")},ya),Xo=(ma.create=function(t,e,n){if(n.isEqual(to.INSTANCE)){if(e!==Jo.EQUAL)throw new kr(Ar.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on null.");return new Zo(t)}if(n.isEqual(Eo.NAN)){if(e!==Jo.EQUAL)throw new kr(Ar.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on NaN.");return new ta(t)}return new $o(t,e,n)},ma),Jo=(da.fromString=function(t){switch(t){case"<":return da.LESS_THAN;case"<=":return da.LESS_THAN_OR_EQUAL;case"==":return da.EQUAL;case">=":return da.GREATER_THAN_OR_EQUAL;case">":return da.GREATER_THAN;case"array-contains":return da.ARRAY_CONTAINS;default:return Sr("Unknown relation: "+t)}},da.prototype.toString=function(){return this.name},da.prototype.isEqual=function(t){return this.name===t.name},da.LESS_THAN=new da("<"),da.LESS_THAN_OR_EQUAL=new da("<="),da.EQUAL=new da("=="),da.GREATER_THAN=new da(">"),da.GREATER_THAN_OR_EQUAL=new da(">="),da.ARRAY_CONTAINS=new da("array-contains"),da),$o=(a(pa,Ho=Xo),pa.prototype.matches=function(t){if(this.field.isKeyField()){Tr(this.value instanceof Do,"Comparing on key, but filter value not a RefValue"),Tr(this.op!==Jo.ARRAY_CONTAINS,"array-contains queries don't make sense on document keys.");var e=this.value,e=Di.comparator(t.key,e.key);return this.matchesComparison(e)}t=t.field(this.field);return void 0!==t&&this.matchesValue(t)},pa.prototype.matchesValue=function(t){var e=this;return this.op===Jo.ARRAY_CONTAINS?t instanceof ko&&void 0!==t.internalValue.find(function(t){return t.isEqual(e.value)}):this.value.typeOrder===t.typeOrder&&this.matchesComparison(t.compareTo(this.value))},pa.prototype.matchesComparison=function(t){switch(this.op){case Jo.LESS_THAN:return t<0;case Jo.LESS_THAN_OR_EQUAL:return t<=0;case Jo.EQUAL:return 0===t;case Jo.GREATER_THAN:return 0<t;case Jo.GREATER_THAN_OR_EQUAL:return 0<=t;default:return Sr("Unknown relation op"+this.op)}},pa.prototype.isInequality=function(){return this.op!==Jo.EQUAL&&this.op!==Jo.ARRAY_CONTAINS},pa.prototype.canonicalId=function(){return this.field.canonicalString()+this.op.toString()+this.value.toString()},pa.prototype.isEqual=function(t){return t instanceof pa&&this.op.isEqual(t.op)&&this.field.isEqual(t.field)&&this.value.isEqual(t.value)},pa.prototype.toString=function(){return this.field.canonicalString()+" "+this.op+" "+this.value.value()},pa),Zo=(a(fa,zo=Xo),fa.prototype.matches=function(t){t=t.field(this.field);return void 0!==t&&null===t.value()},fa.prototype.canonicalId=function(){return this.field.canonicalString()+" IS null"},fa.prototype.toString=function(){return this.field.canonicalString()+" IS null"},fa.prototype.isEqual=function(t){return t instanceof fa&&this.field.isEqual(t.field)},fa),ta=(a(la,Wo=Xo),la.prototype.matches=function(t){t=t.field(this.field),t=t&&t.value();return"number"==typeof t&&isNaN(t)},la.prototype.canonicalId=function(){return this.field.canonicalString()+" IS NaN"},la.prototype.toString=function(){return this.field.canonicalString()+" IS NaN"},la.prototype.isEqual=function(t){return t instanceof la&&this.field.isEqual(t.field)},la),ea=(ha.prototype.toString=function(){return this.name},ha.ASCENDING=new ha("asc"),ha.DESCENDING=new ha("desc"),ha),na=(ca.prototype.canonicalId=function(){for(var t=this.before?"b:":"a:",e=0,n=this.position;e<n.length;e++)t+=n[e].toString();return t},ca.prototype.sortsBeforeDocument=function(t,e){Tr(this.position.length<=t.length,"Bound has more components than query's orderBy");for(var n=0,r=0;r<this.position.length;r++){var i,o=t[r],a=this.position[r],n=o.field.isKeyField()?(Tr(a instanceof Do,"Bound has a non-key value where the key path is being used."),Di.comparator(a.key,e.key)):(Tr(void 0!==(i=e.field(o.field)),"Field should exist since document matched the orderBy already."),a.compareTo(i));if(o.dir===ea.DESCENDING&&(n*=-1),0!==n)break}return this.before?n<=0:n<0},ca.prototype.isEqual=function(t){if(null===t)return!1;if(this.before!==t.before||this.position.length!==t.position.length)return!1;for(var e=0;e<this.position.length;e++){var n=this.position[e],r=t.position[e];return n.isEqual(r)}return!0},ca),ra=(ua.prototype.compare=function(t,e){var n=this.isKeyOrderBy?Ni.compareByKey(t,e):Ni.compareByField(this.field,t,e);switch(this.dir){case ea.ASCENDING:return n;case ea.DESCENDING:return-1*n;default:return Sr("Unknown direction: "+this.dir)}},ua.prototype.canonicalId=function(){return this.field.canonicalString()+this.dir.toString()},ua.prototype.toString=function(){return this.field.canonicalString()+" ("+this.dir+")"},ua.prototype.isEqual=function(t){return this.dir===t.dir&&this.field.isEqual(t.field)},ua),ia=new ra(Ci.keyField(),ea.ASCENDING),oa=new ra(Ci.keyField(),ea.DESCENDING),aa=(sa.fromMicroseconds=function(t){var e=Math.floor(t/1e6);return new sa(new bi(e,t%1e6*1e3))},sa.fromTimestamp=function(t){return new sa(t)},sa.forDeletedDoc=function(){return sa.MIN},sa.prototype.compareTo=function(t){return this.timestamp._compareTo(t.timestamp)},sa.prototype.isEqual=function(t){return this.timestamp.isEqual(t.timestamp)},sa.prototype.toMicroseconds=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3},sa.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},sa.prototype.toTimestamp=function(){return this.timestamp},sa.MIN=new sa(new bi(0,0)),sa);function sa(t){this.timestamp=t}function ua(t,e){this.field=t,void 0===e&&(e=ea.ASCENDING),this.dir=e,this.isKeyOrderBy=t.isKeyField()}function ca(t,e){this.position=t,this.before=e}function ha(t){this.name=t}function la(t){var e=Wo.call(this)||this;return e.field=t,e}function fa(t){var e=zo.call(this)||this;return e.field=t,e}function pa(t,e,n){var r=Ho.call(this)||this;return r.field=t,r.op=e,r.value=n,r}function da(t){this.name=t}function ma(){}function ya(t,e,n,r,i,o,a){void 0===e&&(e=null),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=null),void 0===o&&(o=null),void 0===a&&(a=null),this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.startAt=o,this.endAt=a,this.memoizedCanonicalId=null,this.memoizedOrderBy=null,this.startAt&&this.assertValidBound(this.startAt),this.endAt&&this.assertValidBound(this.endAt)}(rr=Go=Go||{})[rr.Listen=0]="Listen",rr[rr.ExistenceFilterMismatch=1]="ExistenceFilterMismatch",rr[rr.LimboResolution=2]="LimboResolution";function ga(t,e){this.version=t,this.transformResults=e}var va,ba=(Aa.prototype.copy=function(t){return new Aa(this.query,this.targetId,this.purpose,(void 0===t.sequenceNumber?this:t).sequenceNumber,(void 0===t.snapshotVersion?this:t).snapshotVersion,(void 0===t.resumeToken?this:t).resumeToken)},Aa.prototype.isEqual=function(t){return this.targetId===t.targetId&&this.purpose===t.purpose&&this.sequenceNumber===t.sequenceNumber&&this.snapshotVersion.isEqual(t.snapshotVersion)&&this.resumeToken===t.resumeToken&&this.query.isEqual(t.query)},Aa),wa=(Na.fromMapKeys=function(t){var e=new Na(t.comparator);return t.forEach(function(t){e=e.add(t)}),e},Na.prototype.has=function(t){return null!==this.data.get(t)},Na.prototype.first=function(){return this.data.minKey()},Na.prototype.last=function(){return this.data.maxKey()},Object.defineProperty(Na.prototype,"size",{get:function(){return this.data.size},enumerable:!0,configurable:!0}),Na.prototype.indexOf=function(t){return this.data.indexOf(t)},Na.prototype.forEach=function(n){this.data.inorderTraversal(function(t,e){return n(t),!1})},Na.prototype.forEachInRange=function(t,e){for(var n=this.data.getIteratorFrom(t[0]);n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,t[1]))return;e(r.key)}},Na.prototype.forEachWhile=function(t,e){for(var n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return},Na.prototype.firstAfterOrEqual=function(t){t=this.data.getIteratorFrom(t);return t.hasNext()?t.getNext().key:null},Na.prototype.getIterator=function(){return new Ea(this.data.getIterator())},Na.prototype.getIteratorFrom=function(t){return new Ea(this.data.getIteratorFrom(t))},Na.prototype.add=function(t){return this.copy(this.data.remove(t).insert(t,!0))},Na.prototype.delete=function(t){return this.has(t)?this.copy(this.data.remove(t)):this},Na.prototype.isEmpty=function(){return this.data.isEmpty()},Na.prototype.unionWith=function(t){var e=this;return t.forEach(function(t){e=e.add(t)}),e},Na.prototype.isEqual=function(t){if(!(t instanceof Na))return!1;if(this.size!==t.size)return!1;for(var e=this.data.getIterator(),n=t.data.getIterator();e.hasNext();){var r=e.getNext().key,i=n.getNext().key;if(0!==this.comparator(r,i))return!1}return!0},Na.prototype.toArray=function(){var e=[];return this.forEach(function(t){e.push(t)}),e},Na.prototype.toString=function(){var e=[];return this.forEach(function(t){return e.push(t)}),"SortedSet("+e.toString()+")"},Na.prototype.copy=function(t){var e=new Na(this.comparator);return e.data=t,e},Na),Ea=(Da.prototype.getNext=function(){return this.iter.getNext().key},Da.prototype.hasNext=function(){return this.iter.hasNext()},Da),Sa=(Ca.fromSet=function(t){return new Ca(t)},Ca.fromArray=function(t){var e=new wa(Ci.comparator);return t.forEach(function(t){return e=e.add(t)}),new Ca(e)},Ca.prototype.covers=function(e){var n=!1;return this.fields.forEach(function(t){t.isPrefixOf(e)&&(n=!0)}),n},Ca.prototype.applyTo=function(n){var r=Ao.EMPTY;return this.fields.forEach(function(t){if(t.isEmpty())return n;var e=n.field(t);void 0!==e&&(r=r.set(t,e))}),r},Ca.prototype.isEqual=function(t){return this.fields.isEqual(t.fields)},Ca),Ta=(Object.defineProperty(Ia.prototype,"isIdempotent",{get:function(){return this.transform.isIdempotent},enumerable:!0,configurable:!0}),Ia.prototype.isEqual=function(t){return this.field.isEqual(t.field)&&this.transform.isEqual(t.transform)},Ia);function Ia(t,e){this.field=t,this.transform=e}function Ca(t){this.fields=t}function Da(t){this.iter=t}function Na(t){this.comparator=t,this.data=new Ri(this.comparator)}function Aa(t,e,n,r,i,o){void 0===i&&(i=aa.MIN),void 0===o&&(o=Dr()),this.query=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.resumeToken=o}(t=va=va||{})[t.Set=0]="Set",t[t.Patch=1]="Patch",t[t.Transform=2]="Transform",t[t.Delete=3]="Delete";var ka,Ra,Ma,Oa,_a=($a.exists=function(t){return new $a(void 0,t)},$a.updateTime=function(t){return new $a(t)},Object.defineProperty($a.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!0,configurable:!0}),$a.prototype.isValidFor=function(t){return void 0!==this.updateTime?t instanceof Ni&&t.version.isEqual(this.updateTime):void 0!==this.exists?this.exists===t instanceof Ni:(Tr(this.isNone,"Precondition should be empty"),!0)},$a.prototype.isEqual=function(t){return e=this.updateTime,n=t.updateTime,(null!=e?!(!n||!e.isEqual(n)):e===n)&&this.exists===t.exists;var e,n},$a.NONE=new $a,$a),Pa=(Ja.prototype.verifyKeyMatches=function(t){null!=t&&Tr(t.key.isEqual(this.key),"Can only apply a mutation to a document with the same key")},Ja.getPostMutationVersion=function(t){return t instanceof Ni?t.version:aa.MIN},Ja),La=(a(Xa,Oa=Pa),Xa.prototype.applyToRemoteDocument=function(t,e){this.verifyKeyMatches(t),Tr(null==e.transformResults,"Transform results received by SetMutation.");e=e.version;return new Ni(this.key,e,this.value,{hasCommittedMutations:!0})},Xa.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;t=Pa.getPostMutationVersion(t);return new Ni(this.key,t,this.value,{hasLocalMutations:!0})},Object.defineProperty(Xa.prototype,"isIdempotent",{get:function(){return!0},enumerable:!0,configurable:!0}),Object.defineProperty(Xa.prototype,"fieldMask",{get:function(){return null},enumerable:!0,configurable:!0}),Xa.prototype.isEqual=function(t){return t instanceof Xa&&this.key.isEqual(t.key)&&this.value.isEqual(t.value)&&this.precondition.isEqual(t.precondition)},Xa),xa=(a(Ya,Ma=Pa),Ya.prototype.applyToRemoteDocument=function(t,e){if(this.verifyKeyMatches(t),Tr(null==e.transformResults,"Transform results received by PatchMutation."),!this.precondition.isValidFor(t))return new ki(this.key,e.version);t=this.patchDocument(t);return new Ni(this.key,e.version,t,{hasCommittedMutations:!0})},Ya.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=Pa.getPostMutationVersion(t),t=this.patchDocument(t);return new Ni(this.key,r,t,{hasLocalMutations:!0})},Object.defineProperty(Ya.prototype,"isIdempotent",{get:function(){return!0},enumerable:!0,configurable:!0}),Ya.prototype.isEqual=function(t){return t instanceof Ya&&this.key.isEqual(t.key)&&this.fieldMask.isEqual(t.fieldMask)&&this.precondition.isEqual(t.precondition)},Ya.prototype.patchDocument=function(t){t=t instanceof Ni?t.data:Ao.EMPTY;return this.patchObject(t)},Ya.prototype.patchObject=function(n){var r=this;return this.fieldMask.fields.forEach(function(t){var e;t.isEmpty()||(e=r.data.field(t),n=void 0!==e?n.set(t,e):n.delete(t))}),n},Ya),qa=(a(Ha,Ra=Pa),Ha.prototype.applyToRemoteDocument=function(t,e){if(this.verifyKeyMatches(t),Tr(null!=e.transformResults,"Transform results missing for TransformMutation."),!this.precondition.isValidFor(t))return new ki(this.key,e.version);var n=this.requireDocument(t),t=this.serverTransformResults(t,e.transformResults),e=e.version,t=this.transformObject(n.data,t);return new Ni(this.key,e,t,{hasCommittedMutations:!0})},Ha.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;t=this.requireDocument(t),e=this.localTransformResults(n,e),e=this.transformObject(t.data,e);return new Ni(this.key,t.version,e,{hasLocalMutations:!0})},Object.defineProperty(Ha.prototype,"isIdempotent",{get:function(){for(var t=0,e=this.fieldTransforms;t<e.length;t++)if(!e[t].isIdempotent)return!1;return!0},enumerable:!0,configurable:!0}),Object.defineProperty(Ha.prototype,"fieldMask",{get:function(){var e=new wa(Ci.comparator);return this.fieldTransforms.forEach(function(t){return e=e.add(t.field)}),new Sa(e)},enumerable:!0,configurable:!0}),Ha.prototype.isEqual=function(t){return t instanceof Ha&&this.key.isEqual(t.key)&&ii(this.fieldTransforms,t.fieldTransforms)&&this.precondition.isEqual(t.precondition)},Ha.prototype.requireDocument=function(t){Tr(t instanceof Ni,"Unknown MaybeDocument type "+t);return Tr(t.key.isEqual(this.key),"Can only transform a document with the same key"),t},Ha.prototype.serverTransformResults=function(t,e){var n=[];Tr(this.fieldTransforms.length===e.length,"server transform result count ("+e.length+") should match field transform count ("+this.fieldTransforms.length+")");for(var r=0;r<e.length;r++){var i=this.fieldTransforms[r],o=i.transform,a=null;t instanceof Ni&&(a=t.field(i.field)||null),n.push(o.applyToRemoteDocument(a,e[r]))}return n},Ha.prototype.localTransformResults=function(t,e){for(var n=[],r=0,i=this.fieldTransforms;r<i.length;r++){var o=i[r],a=o.transform,s=null;e instanceof Ni&&(s=e.field(o.field)||null),n.push(a.applyToLocalView(s,t))}return n},Ha.prototype.transformObject=function(t,e){Tr(e.length===this.fieldTransforms.length,"TransformResults length mismatch.");for(var n=0;n<this.fieldTransforms.length;n++){var r=this.fieldTransforms[n].field;t=t.set(r,e[n])}return t},Ha),Fa=(a(za,ka=Pa),za.prototype.applyToRemoteDocument=function(t,e){return this.verifyKeyMatches(t),Tr(null==e.transformResults,"Transform results received by DeleteMutation."),new Ai(this.key,e.version,{hasCommittedMutations:!0})},za.prototype.applyToLocalView=function(t,e,n){return this.verifyKeyMatches(t),this.precondition.isValidFor(t)?(t&&Tr(t.key.isEqual(this.key),"Can only apply mutation to document with same key"),new Ai(this.key,aa.forDeletedDoc())):t},za.prototype.isEqual=function(t){return t instanceof za&&this.key.isEqual(t.key)&&this.precondition.isEqual(t.precondition)},Object.defineProperty(za.prototype,"isIdempotent",{get:function(){return!0},enumerable:!0,configurable:!0}),Object.defineProperty(za.prototype,"fieldMask",{get:function(){return null},enumerable:!0,configurable:!0}),za),Va=(Wa.prototype.applyToLocalView=function(t,e){return new Io(e,t)},Wa.prototype.applyToRemoteDocument=function(t,e){return e},Wa.prototype.isEqual=function(t){return t instanceof Wa},Wa.instance=new Wa,Wa),Ba=(Ga.prototype.applyToLocalView=function(t,e){return this.apply(t)},Ga.prototype.applyToRemoteDocument=function(t,e){return this.apply(t)},Ga.prototype.apply=function(t){for(var n=Za(t),e=0,r=this.elements;e<r.length;e++)!function(e){n.find(function(t){return t.isEqual(e)})||n.push(e)}(r[e]);return new ko(n)},Ga.prototype.isEqual=function(t){return t instanceof Ga&&ii(t.elements,this.elements)},Ga),Ua=(ja.prototype.applyToLocalView=function(t,e){return this.apply(t)},ja.prototype.applyToRemoteDocument=function(t,e){return this.apply(t)},ja.prototype.apply=function(t){for(var n=Za(t),e=0,r=this.elements;e<r.length;e++)!function(e){n=n.filter(function(t){return!t.isEqual(e)})}(r[e]);return new ko(n)},ja.prototype.isEqual=function(t){return t instanceof ja&&ii(t.elements,this.elements)},ja),Qa=(Ka.prototype.applyToLocalView=function(t,e){if(t instanceof wo&&this.operand instanceof wo){var n=t.internalValue+this.operand.internalValue;return new wo(n)}return t instanceof no?(n=t.internalValue+this.operand.internalValue,new Eo(n)):this.operand},Ka.prototype.applyToRemoteDocument=function(t,e){return Tr(null!==e,"Didn't receive transformResult for NUMERIC_ADD transform"),e},Ka.prototype.isEqual=function(t){return t instanceof Ka&&this.operand.isEqual(t.operand)},Ka);function Ka(t){this.operand=t,this.isIdempotent=!1}function ja(t){this.elements=t,this.isIdempotent=!0}function Ga(t){this.elements=t,this.isIdempotent=!0}function Wa(){this.isIdempotent=!0}function za(t,e){var n=ka.call(this)||this;return n.key=t,n.precondition=e,n.type=va.Delete,n}function Ha(t,e){var n=Ra.call(this)||this;return n.key=t,n.fieldTransforms=e,n.type=va.Transform,n.precondition=_a.exists(!0),n}function Ya(t,e,n,r){var i=Ma.call(this)||this;return i.key=t,i.data=e,i.fieldMask=n,i.precondition=r,i.type=va.Patch,i}function Xa(t,e,n){var r=Oa.call(this)||this;return r.key=t,r.value=e,r.precondition=n,r.type=va.Set,r}function Ja(){}function $a(t,e){this.updateTime=t,this.exists=e,Tr(void 0===t||void 0===e,'Precondition can specify "exists" or "updateTime" but not both')}function Za(t){return t instanceof ko?t.internalValue.slice():[]}var ts,es=(ns.prototype.isEqual=function(t){return t&&t.count===this.count},ns);function ns(t){this.count=t}function rs(t){switch(t){case Ar.OK:return Sr("Treated status OK as error"),0;case Ar.CANCELLED:case Ar.UNKNOWN:case Ar.DEADLINE_EXCEEDED:case Ar.RESOURCE_EXHAUSTED:case Ar.INTERNAL:case Ar.UNAVAILABLE:case Ar.UNAUTHENTICATED:return;case Ar.INVALID_ARGUMENT:case Ar.NOT_FOUND:case Ar.ALREADY_EXISTS:case Ar.PERMISSION_DENIED:case Ar.FAILED_PRECONDITION:case Ar.ABORTED:case Ar.OUT_OF_RANGE:case Ar.UNIMPLEMENTED:case Ar.DATA_LOSS:return 1;default:return Sr("Unknown status code: "+t),0}}function is(t){if(void 0===t)return wr("GRPC error has no .code"),Ar.UNKNOWN;switch(t){case ts.OK:return Ar.OK;case ts.CANCELLED:return Ar.CANCELLED;case ts.UNKNOWN:return Ar.UNKNOWN;case ts.DEADLINE_EXCEEDED:return Ar.DEADLINE_EXCEEDED;case ts.RESOURCE_EXHAUSTED:return Ar.RESOURCE_EXHAUSTED;case ts.INTERNAL:return Ar.INTERNAL;case ts.UNAVAILABLE:return Ar.UNAVAILABLE;case ts.UNAUTHENTICATED:return Ar.UNAUTHENTICATED;case ts.INVALID_ARGUMENT:return Ar.INVALID_ARGUMENT;case ts.NOT_FOUND:return Ar.NOT_FOUND;case ts.ALREADY_EXISTS:return Ar.ALREADY_EXISTS;case ts.PERMISSION_DENIED:return Ar.PERMISSION_DENIED;case ts.FAILED_PRECONDITION:return Ar.FAILED_PRECONDITION;case ts.ABORTED:return Ar.ABORTED;case ts.OUT_OF_RANGE:return Ar.OUT_OF_RANGE;case ts.UNIMPLEMENTED:return Ar.UNIMPLEMENTED;case ts.DATA_LOSS:return Ar.DATA_LOSS;default:return Sr("Unknown status code: "+t)}}(Ip=ts=ts||{})[Ip.OK=0]="OK",Ip[Ip.CANCELLED=1]="CANCELLED",Ip[Ip.UNKNOWN=2]="UNKNOWN",Ip[Ip.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Ip[Ip.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Ip[Ip.NOT_FOUND=5]="NOT_FOUND",Ip[Ip.ALREADY_EXISTS=6]="ALREADY_EXISTS",Ip[Ip.PERMISSION_DENIED=7]="PERMISSION_DENIED",Ip[Ip.UNAUTHENTICATED=16]="UNAUTHENTICATED",Ip[Ip.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Ip[Ip.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Ip[Ip.ABORTED=10]="ABORTED",Ip[Ip.OUT_OF_RANGE=11]="OUT_OF_RANGE",Ip[Ip.UNIMPLEMENTED=12]="UNIMPLEMENTED",Ip[Ip.INTERNAL=13]="INTERNAL",Ip[Ip.UNAVAILABLE=14]="UNAVAILABLE",Ip[Ip.DATA_LOSS=15]="DATA_LOSS";var os=new Ri(Di.comparator);var as=new Ri(Di.comparator);var ss=new Ri(Di.comparator);var us=new wa(Di.comparator);function cs(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=us,r=0,i=t;r<i.length;r++)var o=i[r],n=n.add(o);return n}var hs=new wa(ri);var ls,fs,ps=(ds.emptySet=function(t){return new ds(t.comparator)},ds.prototype.has=function(t){return null!=this.keyedMap.get(t)},ds.prototype.get=function(t){return this.keyedMap.get(t)},ds.prototype.first=function(){return this.sortedSet.minKey()},ds.prototype.last=function(){return this.sortedSet.maxKey()},ds.prototype.isEmpty=function(){return this.sortedSet.isEmpty()},ds.prototype.indexOf=function(t){t=this.keyedMap.get(t);return t?this.sortedSet.indexOf(t):-1},Object.defineProperty(ds.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!0,configurable:!0}),ds.prototype.forEach=function(n){this.sortedSet.inorderTraversal(function(t,e){return n(t),!1})},ds.prototype.add=function(t){var e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))},ds.prototype.delete=function(t){var e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this},ds.prototype.isEqual=function(t){if(!(t instanceof ds))return!1;if(this.size!==t.size)return!1;for(var e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();e.hasNext();){var r=e.getNext().key,i=n.getNext().key;if(!r.isEqual(i))return!1}return!0},ds.prototype.toString=function(){var e=[];return this.forEach(function(t){e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"},ds.prototype.copy=function(t,e){var n=new ds;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n},ds);function ds(n){this.comparator=n?function(t,e){return n(t,e)||Di.comparator(t.key,e.key)}:function(t,e){return Di.comparator(t.key,e.key)},this.keyedMap=as,this.sortedSet=new Ri(this.comparator)}(s=ls=ls||{})[s.Added=0]="Added",s[s.Removed=1]="Removed",s[s.Modified=2]="Modified",s[s.Metadata=3]="Metadata",(et=fs=fs||{})[et.Local=0]="Local",et[et.Synced=1]="Synced";function ms(t,e,n,r){this.updatedTargetIds=t,this.removedTargetIds=e,this.key=n,this.newDoc=r}function ys(t,e){this.targetId=t,this.existenceFilter=e}var gs,vs=(Cs.prototype.track=function(t){var e=t.doc.key,n=this.changeMap.get(e);!n||t.type!==ls.Added&&n.type===ls.Metadata?this.changeMap=this.changeMap.insert(e,t):t.type===ls.Metadata&&n.type!==ls.Removed?this.changeMap=this.changeMap.insert(e,{type:n.type,doc:t.doc}):t.type===ls.Modified&&n.type===ls.Modified?this.changeMap=this.changeMap.insert(e,{type:ls.Modified,doc:t.doc}):t.type===ls.Modified&&n.type===ls.Added?this.changeMap=this.changeMap.insert(e,{type:ls.Added,doc:t.doc}):t.type===ls.Removed&&n.type===ls.Added?this.changeMap=this.changeMap.remove(e):t.type===ls.Removed&&n.type===ls.Modified?this.changeMap=this.changeMap.insert(e,{type:ls.Removed,doc:n.doc}):t.type===ls.Added&&n.type===ls.Removed?this.changeMap=this.changeMap.insert(e,{type:ls.Modified,doc:t.doc}):Sr("unsupported combination of changes: "+JSON.stringify(t)+" after "+JSON.stringify(n))},Cs.prototype.getChanges=function(){var n=[];return this.changeMap.inorderTraversal(function(t,e){n.push(e)}),n},Cs),bs=(Is.fromInitialDocuments=function(t,e,n,r){var i=[];return e.forEach(function(t){i.push({type:ls.Added,doc:t})}),new Is(t,e,ps.emptySet(e),i,n,r,!0,!1)},Object.defineProperty(Is.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:!0,configurable:!0}),Is.prototype.isEqual=function(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&this.query.isEqual(t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;var e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(var r=0;r<e.length;r++)if(e[r].type!==n[r].type||!e[r].doc.isEqual(n[r].doc))return!1;return!0},Is),ws=(Ts.createSynthesizedRemoteEventForCurrentChange=function(t,e){var n=((n={})[t]=Es.createSynthesizedTargetChangeForCurrentChange(t,e),n);return new Ts(aa.MIN,n,hs,os,cs())},Ts),Es=(Ss.createSynthesizedTargetChangeForCurrentChange=function(t,e){return new Ss(Dr(),e,cs(),cs(),cs())},Ss);function Ss(t,e,n,r,i){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}function Ts(t,e,n,r,i){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}function Is(t,e,n,r,i,o,a,s){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=s}function Cs(){this.changeMap=new Ri(Di.comparator)}(_i=gs=gs||{})[_i.NoChange=0]="NoChange",_i[_i.Added=1]="Added",_i[_i.Removed=2]="Removed",_i[_i.Current=3]="Current",_i[_i.Reset=4]="Reset";function Ds(t,e,n,r){void 0===n&&(n=Dr()),void 0===r&&(r=null),this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r}var Ns=(Object.defineProperty(Rs.prototype,"current",{get:function(){return this._current},enumerable:!0,configurable:!0}),Object.defineProperty(Rs.prototype,"resumeToken",{get:function(){return this._resumeToken},enumerable:!0,configurable:!0}),Object.defineProperty(Rs.prototype,"isPending",{get:function(){return 0!==this.pendingResponses},enumerable:!0,configurable:!0}),Object.defineProperty(Rs.prototype,"hasPendingChanges",{get:function(){return this._hasPendingChanges},enumerable:!0,configurable:!0}),Rs.prototype.updateResumeToken=function(t){0<t.length&&(this._hasPendingChanges=!0,this._resumeToken=t)},Rs.prototype.toTargetChange=function(){var n=cs(),r=cs(),i=cs();return this.documentChanges.forEach(function(t,e){switch(e){case ls.Added:n=n.add(t);break;case ls.Modified:r=r.add(t);break;case ls.Removed:i=i.add(t);break;default:Sr("Encountered invalid change type: "+e)}}),new Es(this._resumeToken,this._current,n,r,i)},Rs.prototype.clearPendingChanges=function(){this._hasPendingChanges=!1,this.documentChanges=Os()},Rs.prototype.addDocumentChange=function(t,e){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.insert(t,e)},Rs.prototype.removeDocumentChange=function(t){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.remove(t)},Rs.prototype.recordPendingTargetRequest=function(){this.pendingResponses+=1},Rs.prototype.recordTargetResponse=function(){--this.pendingResponses},Rs.prototype.markCurrent=function(){this._hasPendingChanges=!0,this._current=!0},Rs),As=(ks.prototype.handleDocumentChange=function(t){for(var e=0,n=t.updatedTargetIds;e<n.length;e++){var r=n[e];t.newDoc instanceof Ni?this.addDocumentToTarget(r,t.newDoc):t.newDoc instanceof Ai&&this.removeDocumentFromTarget(r,t.key,t.newDoc)}for(var i=0,o=t.removedTargetIds;i<o.length;i++)r=o[i],this.removeDocumentFromTarget(r,t.key,t.newDoc)},ks.prototype.handleTargetChange=function(n){var r=this;this.forEachTarget(n,function(t){var e=r.ensureTargetState(t);switch(n.state){case gs.NoChange:r.isActiveTarget(t)&&e.updateResumeToken(n.resumeToken);break;case gs.Added:e.recordTargetResponse(),e.isPending||e.clearPendingChanges(),e.updateResumeToken(n.resumeToken);break;case gs.Removed:e.recordTargetResponse(),e.isPending||r.removeTarget(t),Tr(!n.cause,"WatchChangeAggregator does not handle errored targets");break;case gs.Current:r.isActiveTarget(t)&&(e.markCurrent(),e.updateResumeToken(n.resumeToken));break;case gs.Reset:r.isActiveTarget(t)&&(r.resetTarget(t),e.updateResumeToken(n.resumeToken));break;default:Sr("Unknown target watch change state: "+n.state)}})},ks.prototype.forEachTarget=function(t,e){0<t.targetIds.length?t.targetIds.forEach(e):Pr(this.targetStates,e)},ks.prototype.handleExistenceFilter=function(t){var e=t.targetId,n=t.existenceFilter.count,t=this.queryDataForActiveTarget(e);t&&((t=t.query).isDocumentQuery()?0===n?(t=new Di(t.path),this.removeDocumentFromTarget(e,t,new Ai(t,aa.forDeletedDoc()))):Tr(1===n,"Single document existence filter with count: "+n):this.getCurrentDocumentCountForTarget(e)!==n&&(this.resetTarget(e),this.pendingTargetResets=this.pendingTargetResets.add(e)))},ks.prototype.createRemoteEvent=function(r){var i=this,o={};Pr(this.targetStates,function(t,e){var n=i.queryDataForActiveTarget(t);n&&(e.current&&n.query.isDocumentQuery()&&(n=new Di(n.query.path),null!==i.pendingDocumentUpdates.get(n)||i.targetContainsDocument(t,n)||i.removeDocumentFromTarget(t,n,new Ai(n,r))),e.hasPendingChanges&&(o[t]=e.toTargetChange(),e.clearPendingChanges()))});var a=cs();this.pendingDocumentTargetMapping.forEach(function(t,e){var n=!0;e.forEachWhile(function(t){t=i.queryDataForActiveTarget(t);return!t||t.purpose===Go.LimboResolution||(n=!1)}),n&&(a=a.add(t))});var t=new ws(r,o,this.pendingTargetResets,this.pendingDocumentUpdates,a);return this.pendingDocumentUpdates=os,this.pendingDocumentTargetMapping=Ms(),this.pendingTargetResets=new wa(ri),t},ks.prototype.addDocumentToTarget=function(t,e){var n;this.isActiveTarget(t)&&(n=this.targetContainsDocument(t,e.key)?ls.Modified:ls.Added,this.ensureTargetState(t).addDocumentChange(e.key,n),this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(e.key,e),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e.key,this.ensureDocumentTargetMapping(e.key).add(t)))},ks.prototype.removeDocumentFromTarget=function(t,e,n){var r;this.isActiveTarget(t)&&(r=this.ensureTargetState(t),this.targetContainsDocument(t,e)?r.addDocumentChange(e,ls.Removed):r.removeDocumentChange(e),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e,this.ensureDocumentTargetMapping(e).delete(t)),n&&(this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(e,n)))},ks.prototype.removeTarget=function(t){delete this.targetStates[t]},ks.prototype.getCurrentDocumentCountForTarget=function(t){var e=this.ensureTargetState(t).toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size},ks.prototype.recordPendingTargetRequest=function(t){this.ensureTargetState(t).recordPendingTargetRequest()},ks.prototype.ensureTargetState=function(t){return this.targetStates[t]||(this.targetStates[t]=new Ns),this.targetStates[t]},ks.prototype.ensureDocumentTargetMapping=function(t){var e=this.pendingDocumentTargetMapping.get(t);return e||(e=new wa(ri),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(t,e)),e},ks.prototype.isActiveTarget=function(t){return null!==this.queryDataForActiveTarget(t)},ks.prototype.queryDataForActiveTarget=function(t){var e=this.targetStates[t];return e&&e.isPending?null:this.metadataProvider.getQueryDataForTarget(t)},ks.prototype.resetTarget=function(e){var n=this;Tr(!this.targetStates[e].isPending,"Should only reset active targets"),this.targetStates[e]=new Ns,this.metadataProvider.getRemoteKeysForTarget(e).forEach(function(t){n.removeDocumentFromTarget(e,t,null)})},ks.prototype.targetContainsDocument=function(t,e){return this.metadataProvider.getRemoteKeysForTarget(t).has(e)},ks);function ks(t){this.metadataProvider=t,this.targetStates={},this.pendingDocumentUpdates=os,this.pendingDocumentTargetMapping=Ms(),this.pendingTargetResets=new wa(ri)}function Rs(){this.pendingResponses=0,this.documentChanges=Os(),this._resumeToken=Dr(),this._current=!1,this._hasPendingChanges=!0}function Ms(){return new Ri(Di.comparator)}function Os(){return new Ri(Di.comparator)}var _s=((se={})[ea.ASCENDING.name]="ASCENDING",se[ea.DESCENDING.name]="DESCENDING",se),Ps=((er={})[Jo.LESS_THAN.name]="LESS_THAN",er[Jo.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL",er[Jo.GREATER_THAN.name]="GREATER_THAN",er[Jo.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL",er[Jo.EQUAL.name]="EQUAL",er[Jo.ARRAY_CONTAINS.name]="ARRAY_CONTAINS",er),Ls=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function xs(t,e){Tr(!Ko(t),e+" is missing")}function qs(t){return"number"==typeof t?t:"string"==typeof t?Number(t):Sr("can't parse "+t)}var Fs=($s.prototype.emptyByteString=function(){return this.options.useProto3Json?"":new Uint8Array(0)},$s.prototype.unsafeCastProtoByteString=function(t){return t},$s.prototype.fromRpcStatus=function(t){var e=void 0===t.code?Ar.UNKNOWN:is(t.code);return new kr(e,t.message||"")},$s.prototype.toInt32Value=function(t){return Ko(t)?void 0:{value:t}},$s.prototype.fromInt32Value=function(t){return Ko(t="object"==typeof t?t.value:t)?null:t},$s.prototype.toTimestamp=function(t){return{seconds:""+t.seconds,nanos:t.nanoseconds}},$s.prototype.fromTimestamp=function(t){if("string"==typeof t)return this.fromIso8601String(t);Tr(!!t,"Cannot deserialize null or undefined timestamp.");var e=qs(t.seconds||"0"),t=t.nanos||0;return new bi(e,t)},$s.prototype.fromIso8601String=function(t){var e=0,n=Ls.exec(t);Tr(!!n,"invalid timestamp: "+t),n[1]&&(n=((n=n[1])+"000000000").substr(0,9),e=Number(n));t=new Date(t),t=Math.floor(t.getTime()/1e3);return new bi(t,e)},$s.prototype.toBytes=function(t){return this.options.useProto3Json?t.toBase64():this.unsafeCastProtoByteString(t.toUint8Array())},$s.prototype.fromBlob=function(t){return"string"==typeof t?(Tr(this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),yi.fromBase64String(t)):(Tr(!this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),yi.fromUint8Array(t))},$s.prototype.toVersion=function(t){return this.toTimestamp(t.toTimestamp())},$s.prototype.fromVersion=function(t){return Tr(!!t,"Trying to deserialize version that isn't set"),aa.fromTimestamp(this.fromTimestamp(t))},$s.prototype.toResourceName=function(t,e){return this.fullyQualifiedPrefixPath(t).child("documents").child(e).canonicalString()},$s.prototype.fromResourceName=function(t){t=Ti.fromString(t);return Tr(this.isValidResourceName(t),"Tried to deserialize invalid key "+t.toString()),t},$s.prototype.toName=function(t){return this.toResourceName(this.databaseId,t.path)},$s.prototype.fromName=function(t){t=this.fromResourceName(t);return Tr(t.get(1)===this.databaseId.projectId,"Tried to deserialize key from different project: "+t.get(1)+" vs "+this.databaseId.projectId),Tr(!t.get(3)&&!this.databaseId.database||t.get(3)===this.databaseId.database,"Tried to deserialize key from different database: "+t.get(3)+" vs "+this.databaseId.database),new Di(this.extractLocalPathFromResourceName(t))},$s.prototype.toQueryPath=function(t){return this.toResourceName(this.databaseId,t)},$s.prototype.fromQueryPath=function(t){t=this.fromResourceName(t);return 4===t.length?Ti.EMPTY_PATH:this.extractLocalPathFromResourceName(t)},Object.defineProperty($s.prototype,"encodedDatabaseId",{get:function(){return new Ti(["projects",this.databaseId.projectId,"databases",this.databaseId.database]).canonicalString()},enumerable:!0,configurable:!0}),$s.prototype.fullyQualifiedPrefixPath=function(t){return new Ti(["projects",t.projectId,"databases",t.database])},$s.prototype.extractLocalPathFromResourceName=function(t){return Tr(4<t.length&&"documents"===t.get(4),"tried to deserialize invalid key "+t.toString()),t.popFirst(5)},$s.prototype.isValidResourceName=function(t){return 4<=t.length&&"projects"===t.get(0)&&"databases"===t.get(2)},$s.prototype.toValue=function(t){if(t instanceof to)return{nullValue:"NULL_VALUE"};if(t instanceof eo)return{booleanValue:t.value()};if(t instanceof wo)return{integerValue:""+t.value()};if(t instanceof Eo){var e=t.value();if(this.options.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:t.value()}}return t instanceof So?{stringValue:t.value()}:t instanceof Ao?{mapValue:this.toMapValue(t)}:t instanceof ko?{arrayValue:this.toArrayValue(t)}:t instanceof To?{timestampValue:this.toTimestamp(t.internalValue)}:t instanceof No?{geoPointValue:{latitude:t.value().latitude,longitude:t.value().longitude}}:t instanceof Co?{bytesValue:this.toBytes(t.value())}:t instanceof Do?{referenceValue:this.toResourceName(t.databaseId,t.key.path)}:Sr("Unknown FieldValue "+JSON.stringify(t))},$s.prototype.fromValue=function(t){var e=this;if("nullValue"in t)return to.INSTANCE;if("booleanValue"in t)return eo.of(t.booleanValue);if("integerValue"in t)return new wo(qs(t.integerValue));if("doubleValue"in t){if(this.options.useProto3Json){if("NaN"===t.doubleValue)return Eo.NAN;if("Infinity"===t.doubleValue)return Eo.POSITIVE_INFINITY;if("-Infinity"===t.doubleValue)return Eo.NEGATIVE_INFINITY}return new Eo(t.doubleValue)}if("stringValue"in t)return new So(t.stringValue);if("mapValue"in t)return this.fromFields(t.mapValue.fields||{});if("arrayValue"in t){xs(t.arrayValue,"arrayValue");var n=t.arrayValue.values||[];return new ko(n.map(function(t){return e.fromValue(t)}))}if("timestampValue"in t)return xs(t.timestampValue,"timestampValue"),new To(this.fromTimestamp(t.timestampValue));if("geoPointValue"in t){xs(t.geoPointValue,"geoPointValue");var n=t.geoPointValue.latitude||0,r=t.geoPointValue.longitude||0;return new No(new vi(n,r))}if("bytesValue"in t){xs(t.bytesValue,"bytesValue");var i=this.fromBlob(t.bytesValue);return new Co(i)}if("referenceValue"in t){xs(t.referenceValue,"referenceValue");r=this.fromResourceName(t.referenceValue),i=new Ei(r.get(1),r.get(3)),r=new Di(this.extractLocalPathFromResourceName(r));return new Do(i,r)}return Sr("Unknown Value proto "+JSON.stringify(t))},$s.prototype.toMutationDocument=function(t,e){return{name:this.toName(t),fields:this.toFields(e)}},$s.prototype.toDocument=function(t){return Tr(!t.hasLocalMutations,"Can't serialize documents with mutations."),{name:this.toName(t.key),fields:this.toFields(t.data),updateTime:this.toTimestamp(t.version.toTimestamp())}},$s.prototype.fromDocument=function(t,e){return new Ni(this.fromName(t.name),this.fromVersion(t.updateTime),this.fromFields(t.fields||{}),{hasCommittedMutations:!!e})},$s.prototype.toFields=function(t){var n=this,r={};return t.forEach(function(t,e){r[t]=n.toValue(e)}),r},$s.prototype.fromFields=function(t){var n=this,r=Ao.EMPTY;return Lr(t,function(t,e){r=r.set(new Ci([t]),n.fromValue(e))}),r},$s.prototype.toMapValue=function(t){return{fields:this.toFields(t)}},$s.prototype.toArrayValue=function(t){var e=this,n=[];return t.forEach(function(t){n.push(e.toValue(t))}),{values:n}},$s.prototype.fromFound=function(t){Tr(!!t.found,"Tried to deserialize a found document from a missing document."),xs(t.found.name,"doc.found.name"),xs(t.found.updateTime,"doc.found.updateTime");var e=this.fromName(t.found.name),n=this.fromVersion(t.found.updateTime),r=this.fromFields(t.found.fields||{});return new Ni(e,n,r,{},t.found)},$s.prototype.fromMissing=function(t){Tr(!!t.missing,"Tried to deserialize a missing document from a found document."),Tr(!!t.readTime,"Tried to deserialize a missing document without a read time.");var e=this.fromName(t.missing),t=this.fromVersion(t.readTime);return new Ai(e,t)},$s.prototype.fromMaybeDocument=function(t){return"found"in t?this.fromFound(t):"missing"in t?this.fromMissing(t):Sr("invalid batch get response: "+JSON.stringify(t))},$s.prototype.toWatchTargetChangeState=function(t){switch(t){case gs.Added:return"ADD";case gs.Current:return"CURRENT";case gs.NoChange:return"NO_CHANGE";case gs.Removed:return"REMOVE";case gs.Reset:return"RESET";default:return Sr("Unknown WatchTargetChangeState: "+t)}},$s.prototype.toTestWatchChange=function(t){if(t instanceof ys)return{filter:{count:t.existenceFilter.count,targetId:t.targetId}};if(t instanceof ms){if(t.newDoc instanceof Ni){var e=t.newDoc;return{documentChange:{document:{name:this.toName(e.key),fields:this.toFields(e.data),updateTime:this.toVersion(e.version)},targetIds:t.updatedTargetIds,removedTargetIds:t.removedTargetIds}}}if(t.newDoc instanceof Ai)return e=t.newDoc,{documentDelete:{document:this.toName(e.key),readTime:this.toVersion(e.version),removedTargetIds:t.removedTargetIds}};if(null===t.newDoc)return{documentRemove:{document:this.toName(t.key),removedTargetIds:t.removedTargetIds}}}if(t instanceof Ds){e=void 0;return t.cause&&(e={code:function(t){if(void 0===t)return ts.OK;switch(t){case Ar.OK:return ts.OK;case Ar.CANCELLED:return ts.CANCELLED;case Ar.UNKNOWN:return ts.UNKNOWN;case Ar.DEADLINE_EXCEEDED:return ts.DEADLINE_EXCEEDED;case Ar.RESOURCE_EXHAUSTED:return ts.RESOURCE_EXHAUSTED;case Ar.INTERNAL:return ts.INTERNAL;case Ar.UNAVAILABLE:return ts.UNAVAILABLE;case Ar.UNAUTHENTICATED:return ts.UNAUTHENTICATED;case Ar.INVALID_ARGUMENT:return ts.INVALID_ARGUMENT;case Ar.NOT_FOUND:return ts.NOT_FOUND;case Ar.ALREADY_EXISTS:return ts.ALREADY_EXISTS;case Ar.PERMISSION_DENIED:return ts.PERMISSION_DENIED;case Ar.FAILED_PRECONDITION:return ts.FAILED_PRECONDITION;case Ar.ABORTED:return ts.ABORTED;case Ar.OUT_OF_RANGE:return ts.OUT_OF_RANGE;case Ar.UNIMPLEMENTED:return ts.UNIMPLEMENTED;case Ar.DATA_LOSS:return ts.DATA_LOSS;default:return Sr("Unknown status code: "+t)}}(t.cause.code),message:t.cause.message}),{targetChange:{targetChangeType:this.toWatchTargetChangeState(t.state),targetIds:t.targetIds,resumeToken:this.unsafeCastProtoByteString(t.resumeToken),cause:e}}}return Sr("Unrecognized watch change: "+JSON.stringify(t))},$s.prototype.fromWatchChange=function(t){if("targetChange"in t){xs(t.targetChange,"targetChange");var e=this.fromWatchTargetChangeState(t.targetChange.targetChangeType||"NO_CHANGE"),n=t.targetChange.targetIds||[],r=t.targetChange.resumeToken||this.emptyByteString(),i=t.targetChange.cause,i=i&&this.fromRpcStatus(i),i=new Ds(e,n,r,i||null)}else if("documentChange"in t){xs(t.documentChange,"documentChange"),xs(t.documentChange.document,"documentChange.name"),xs(t.documentChange.document.name,"documentChange.document.name"),xs(t.documentChange.document.updateTime,"documentChange.document.updateTime");var o=t.documentChange,a=this.fromName(o.document.name),s=this.fromVersion(o.document.updateTime),u=this.fromFields(o.document.fields||{}),c=new Ni(a,s,u,{},o.document),u=o.targetIds||[],o=o.removedTargetIds||[];i=new ms(u,o,c.key,c)}else if("documentDelete"in t){xs(t.documentDelete,"documentDelete"),xs(t.documentDelete.document,"documentDelete.document");u=t.documentDelete,a=this.fromName(u.document),s=u.readTime?this.fromVersion(u.readTime):aa.forDeletedDoc(),c=new Ai(a,s),o=u.removedTargetIds||[];i=new ms([],o,c.key,c)}else if("documentRemove"in t){xs(t.documentRemove,"documentRemove"),xs(t.documentRemove.document,"documentRemove");c=t.documentRemove;a=this.fromName(c.document),o=c.removedTargetIds||[],i=new ms([],o,a,null)}else{if(!("filter"in t))return Sr("Unknown change type "+JSON.stringify(t));xs(t.filter,"filter"),xs(t.filter.targetId,"filter.targetId");a=t.filter,t=a.count||0,t=new es(t),a=a.targetId;i=new ys(a,t)}return i},$s.prototype.fromWatchTargetChangeState=function(t){return"NO_CHANGE"===t?gs.NoChange:"ADD"===t?gs.Added:"REMOVE"===t?gs.Removed:"CURRENT"===t?gs.Current:"RESET"===t?gs.Reset:Sr("Got unexpected TargetChange.state: "+t)},$s.prototype.versionFromListenResponse=function(t){if(!("targetChange"in t))return aa.MIN;t=t.targetChange;return(!t.targetIds||!t.targetIds.length)&&t.readTime?this.fromVersion(t.readTime):aa.MIN},$s.prototype.toMutation=function(t){var e,n=this;if(t instanceof La)e={update:this.toMutationDocument(t.key,t.value)};else if(t instanceof Fa)e={delete:this.toName(t.key)};else if(t instanceof xa)e={update:this.toMutationDocument(t.key,t.data),updateMask:this.toDocumentMask(t.fieldMask)};else{if(!(t instanceof qa))return Sr("Unknown mutation type "+t.type);e={transform:{document:this.toName(t.key),fieldTransforms:t.fieldTransforms.map(function(t){return n.toFieldTransform(t)})}}}return t.precondition.isNone||(e.currentDocument=this.toPrecondition(t.precondition)),e},$s.prototype.fromMutation=function(t){var e=this,n=t.currentDocument?this.fromPrecondition(t.currentDocument):_a.NONE;if(t.update){xs(t.update.name,"name");var r=this.fromName(t.update.name),i=this.fromFields(t.update.fields||{});if(t.updateMask){var o=this.fromDocumentMask(t.updateMask);return new xa(r,i,o,n)}return new La(r,i,n)}if(t.delete)return r=this.fromName(t.delete),new Fa(r,n);if(t.transform){r=this.fromName(t.transform.document),i=t.transform.fieldTransforms.map(function(t){return e.fromFieldTransform(t)});return Tr(!0===n.exists,'Transforms only support precondition "exists == true"'),new qa(r,i)}return Sr("unknown mutation proto: "+JSON.stringify(t))},$s.prototype.toPrecondition=function(t){return Tr(!t.isNone,"Can't serialize an empty precondition"),void 0!==t.updateTime?{updateTime:this.toVersion(t.updateTime)}:void 0!==t.exists?{exists:t.exists}:Sr("Unknown precondition")},$s.prototype.fromPrecondition=function(t){return void 0!==t.updateTime?_a.updateTime(this.fromVersion(t.updateTime)):void 0!==t.exists?_a.exists(t.exists):_a.NONE},$s.prototype.fromWriteResult=function(t,e){var n=this,r=t.updateTime?this.fromVersion(t.updateTime):this.fromVersion(e),e=null;return t.transformResults&&0<t.transformResults.length&&(e=t.transformResults.map(function(t){return n.fromValue(t)})),new ga(r,e)},$s.prototype.fromWriteResults=function(t,e){var n=this;return t&&0<t.length?(Tr(void 0!==e,"Received a write result without a commit time"),t.map(function(t){return n.fromWriteResult(t,e)})):[]},$s.prototype.toFieldTransform=function(t){var e=this,n=t.transform;if(n instanceof Va)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof Ba)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements.map(function(t){return e.toValue(t)})}};if(n instanceof Ua)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements.map(function(t){return e.toValue(t)})}};if(n instanceof Qa)return{fieldPath:t.field.canonicalString(),increment:this.toValue(n.operand)};throw Sr("Unknown transform: "+t.transform)},$s.prototype.fromFieldTransform=function(t){var e,n=this,r=null;"setToServerValue"in t?(Tr("REQUEST_TIME"===t.setToServerValue,"Unknown server value transform proto: "+JSON.stringify(t)),r=Va.instance):"appendMissingElements"in t?(e=t.appendMissingElements.values||[],r=new Ba(e.map(function(t){return n.fromValue(t)}))):"removeAllFromArray"in t?(e=t.removeAllFromArray.values||[],r=new Ua(e.map(function(t){return n.fromValue(t)}))):"increment"in t?(Tr((e=this.fromValue(t.increment))instanceof no,"NUMERIC_ADD transform requires a NumberValue"),r=new Qa(e)):Sr("Unknown transform proto: "+JSON.stringify(t));t=Ci.fromServerFormat(t.fieldPath);return new Ta(t,r)},$s.prototype.toDocumentsTarget=function(t){return{documents:[this.toQueryPath(t.path)]}},$s.prototype.fromDocumentsTarget=function(t){var e=t.documents.length;Tr(1===e,"DocumentsTarget contained other than 1 document: "+e);t=t.documents[0];return Yo.atPath(this.fromQueryPath(t))},$s.prototype.toQueryTarget=function(t){var e={structuredQuery:{}},n=t.path;null!==t.collectionGroup?(Tr(n.length%2==0,"Collection Group queries should be within a document path or root."),e.parent=this.toQueryPath(n),e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(Tr(n.length%2!=0,"Document queries with filters are not supported."),e.parent=this.toQueryPath(n.popLast()),e.structuredQuery.from=[{collectionId:n.lastSegment()}]);n=this.toFilter(t.filters);n&&(e.structuredQuery.where=n);n=this.toOrder(t.orderBy);n&&(e.structuredQuery.orderBy=n);n=this.toInt32Value(t.limit);return void 0!==n&&(e.structuredQuery.limit=n),t.startAt&&(e.structuredQuery.startAt=this.toCursor(t.startAt)),t.endAt&&(e.structuredQuery.endAt=this.toCursor(t.endAt)),e},$s.prototype.fromQueryTarget=function(t){var e=this.fromQueryPath(t.parent),n=t.structuredQuery,r=n.from?n.from.length:0,i=null;0<r&&(Tr(1===r,"StructuredQuery.from with more than one collection is not supported."),(s=n.from[0]).allDescendants?i=s.collectionId:e=e.child(s.collectionId));var o=[];n.where&&(o=this.fromFilter(n.where));var a=[];n.orderBy&&(a=this.fromOrder(n.orderBy));t=null;n.limit&&(t=this.fromInt32Value(n.limit));r=null;n.startAt&&(r=this.fromCursor(n.startAt));var s=null;return n.endAt&&(s=this.fromCursor(n.endAt)),new Yo(e,i,a,o,t,r,s)},$s.prototype.toListenRequestLabels=function(t){t=this.toLabel(t.purpose);return null==t?null:{"goog-listen-tags":t}},$s.prototype.toLabel=function(t){switch(t){case Go.Listen:return null;case Go.ExistenceFilterMismatch:return"existence-filter-mismatch";case Go.LimboResolution:return"limbo-document";default:return Sr("Unrecognized query purpose: "+t)}},$s.prototype.toTarget=function(t){var e=t.query;return(e=e.isDocumentQuery()?{documents:this.toDocumentsTarget(e)}:{query:this.toQueryTarget(e)}).targetId=t.targetId,0<t.resumeToken.length&&(e.resumeToken=this.unsafeCastProtoByteString(t.resumeToken)),e},$s.prototype.toFilter=function(t){var e=this;if(0!==t.length){t=t.map(function(t){return t instanceof $o?e.toRelationFilter(t):e.toUnaryFilter(t)});return 1===t.length?t[0]:{compositeFilter:{op:"AND",filters:t}}}},$s.prototype.fromFilter=function(t){var e=this;return t?void 0!==t.unaryFilter?[this.fromUnaryFilter(t)]:void 0!==t.fieldFilter?[this.fromRelationFilter(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map(function(t){return e.fromFilter(t)}).reduce(function(t,e){return t.concat(e)}):Sr("Unknown filter: "+JSON.stringify(t)):[]},$s.prototype.toOrder=function(t){var e=this;if(0!==t.length)return t.map(function(t){return e.toPropertyOrder(t)})},$s.prototype.fromOrder=function(t){var e=this;return t.map(function(t){return e.fromPropertyOrder(t)})},$s.prototype.toCursor=function(t){var e=this;return{before:t.before,values:t.position.map(function(t){return e.toValue(t)})}},$s.prototype.fromCursor=function(t){var e=this,n=!!t.before,t=t.values.map(function(t){return e.fromValue(t)});return new na(t,n)},$s.prototype.toDirection=function(t){return _s[t.name]},$s.prototype.fromDirection=function(t){switch(t){case"ASCENDING":return ea.ASCENDING;case"DESCENDING":return ea.DESCENDING;default:return}},$s.prototype.toOperatorName=function(t){return Ps[t.name]},$s.prototype.fromOperatorName=function(t){switch(t){case"EQUAL":return Jo.EQUAL;case"GREATER_THAN":return Jo.GREATER_THAN;case"GREATER_THAN_OR_EQUAL":return Jo.GREATER_THAN_OR_EQUAL;case"LESS_THAN":return Jo.LESS_THAN;case"LESS_THAN_OR_EQUAL":return Jo.LESS_THAN_OR_EQUAL;case"ARRAY_CONTAINS":return Jo.ARRAY_CONTAINS;case"OPERATOR_UNSPECIFIED":return Sr("Unspecified relation");default:return Sr("Unknown relation")}},$s.prototype.toFieldPathReference=function(t){return{fieldPath:t.canonicalString()}},$s.prototype.fromFieldPathReference=function(t){return Ci.fromServerFormat(t.fieldPath)},$s.prototype.toPropertyOrder=function(t){return{field:this.toFieldPathReference(t.field),direction:this.toDirection(t.dir)}},$s.prototype.fromPropertyOrder=function(t){return new ra(this.fromFieldPathReference(t.field),this.fromDirection(t.direction))},$s.prototype.toRelationFilter=function(t){return t instanceof $o?{fieldFilter:{field:this.toFieldPathReference(t.field),op:this.toOperatorName(t.op),value:this.toValue(t.value)}}:Sr("Unrecognized filter: "+JSON.stringify(t))},$s.prototype.fromRelationFilter=function(t){return new $o(this.fromFieldPathReference(t.fieldFilter.field),this.fromOperatorName(t.fieldFilter.op),this.fromValue(t.fieldFilter.value))},$s.prototype.toUnaryFilter=function(t){return t instanceof ta?{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NAN"}}:t instanceof Zo?{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NULL"}}:Sr("Unrecognized filter: "+JSON.stringify(t))},$s.prototype.fromUnaryFilter=function(t){switch(t.unaryFilter.op){case"IS_NAN":var e=this.fromFieldPathReference(t.unaryFilter.field);return new ta(e);case"IS_NULL":e=this.fromFieldPathReference(t.unaryFilter.field);return new Zo(e);case"OPERATOR_UNSPECIFIED":return Sr("Unspecified filter");default:return Sr("Unknown filter")}},$s.prototype.toDocumentMask=function(t){var e=[];return t.fields.forEach(function(t){return e.push(t.canonicalString())}),{fieldPaths:e}},$s.prototype.fromDocumentMask=function(t){t=(t.fieldPaths||[]).map(function(t){return Ci.fromServerFormat(t)});return Sa.fromArray(t)},$s),Vs=(Js.prototype.addCallback=function(t){},Js.prototype.shutdown=function(){},Js),Bs="ConnectivityMonitor",Us=(Xs.prototype.addCallback=function(t){this.callbacks.push(t)},Xs.prototype.shutdown=function(){window.removeEventListener("online",this.networkAvailableListener),window.removeEventListener("offline",this.networkUnavailableListener)},Xs.prototype.configureNetworkMonitoring=function(){window.addEventListener("online",this.networkAvailableListener),window.addEventListener("offline",this.networkUnavailableListener)},Xs.prototype.onNetworkAvailable=function(){br(Bs,"Network connectivity changed: AVAILABLE");for(var t=0,e=this.callbacks;t<e.length;t++)(0,e[t])(0)},Xs.prototype.onNetworkUnavailable=function(){br(Bs,"Network connectivity changed: UNAVAILABLE");for(var t=0,e=this.callbacks;t<e.length;t++)(0,e[t])(1)},Xs),Qs=(Ys.prototype.onOpen=function(t){Tr(!this.wrappedOnOpen,"Called onOpen on stream twice!"),this.wrappedOnOpen=t},Ys.prototype.onClose=function(t){Tr(!this.wrappedOnClose,"Called onClose on stream twice!"),this.wrappedOnClose=t},Ys.prototype.onMessage=function(t){Tr(!this.wrappedOnMessage,"Called onMessage on stream twice!"),this.wrappedOnMessage=t},Ys.prototype.close=function(){this.closeFn()},Ys.prototype.send=function(t){this.sendFn(t)},Ys.prototype.callOnOpen=function(){Tr(void 0!==this.wrappedOnOpen,"Cannot call onOpen because no callback was set"),this.wrappedOnOpen()},Ys.prototype.callOnClose=function(t){Tr(void 0!==this.wrappedOnClose,"Cannot call onClose because no callback was set"),this.wrappedOnClose(t)},Ys.prototype.callOnMessage=function(t){Tr(void 0!==this.wrappedOnMessage,"Cannot call onMessage because no callback was set"),this.wrappedOnMessage(t)},Ys),Ks="Connection",js={BatchGetDocuments:"batchGet",Commit:"commit"},Gs="gl-js/ fire/"+mr,Ws=(Hs.prototype.modifyHeadersForRequest=function(t,e){if(e)for(var n in e.authHeaders)e.authHeaders.hasOwnProperty(n)&&(t[n]=e.authHeaders[n]);t["X-Goog-Api-Client"]=Gs},Hs.prototype.invokeRPC=function(o,a,s){var u=this,c=this.makeUrl(o);return new Promise(function(n,r){var i=new ur;i.listenOnce(ar.COMPLETE,function(){try{switch(i.getLastErrorCode()){case or.NO_ERROR:var t=i.getResponseJson();br(Ks,"XHR received:",JSON.stringify(t)),n(t);break;case or.TIMEOUT:br(Ks,'RPC "'+o+'" timed out'),r(new kr(Ar.DEADLINE_EXCEEDED,"Request time out"));break;case or.HTTP_ERROR:var e=i.getStatus();br(Ks,'RPC "'+o+'" failed with status:',e,"response text:",i.getResponseText()),0<e?r(new kr(function(t){switch(t){case 200:return Ar.OK;case 400:return Ar.INVALID_ARGUMENT;case 401:return Ar.UNAUTHENTICATED;case 403:return Ar.PERMISSION_DENIED;case 404:return Ar.NOT_FOUND;case 409:return Ar.ABORTED;case 416:return Ar.OUT_OF_RANGE;case 429:return Ar.RESOURCE_EXHAUSTED;case 499:return Ar.CANCELLED;case 500:return Ar.UNKNOWN;case 501:return Ar.UNIMPLEMENTED;case 503:return Ar.UNAVAILABLE;case 504:return Ar.DEADLINE_EXCEEDED;default:return 200<=t&&t<300?Ar.OK:400<=t&&t<500?Ar.FAILED_PRECONDITION:500<=t&&t<600?Ar.INTERNAL:Ar.UNKNOWN}}(e),"Server responded with status "+i.getStatusText())):(br(Ks,'RPC "'+o+'" failed'),r(new kr(Ar.UNAVAILABLE,"Connection failed.")));break;default:Sr('RPC "'+o+'" failed with unanticipated webchannel error '+i.getLastErrorCode()+": "+i.getLastError()+", giving up.")}}finally{br(Ks,'RPC "'+o+'" completed.')}});var t=JSON.stringify(a);br(Ks,"XHR sending: ",c+" "+t);var e={"Content-Type":"text/plain"};u.modifyHeadersForRequest(e,s),i.send(c,"POST",t,e,15)})},Hs.prototype.invokeStreamingRPC=function(t,e,n){return this.invokeRPC(t,e,n)},Hs.prototype.openStream=function(t,e){var n=[this.baseUrl,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=ir(),t={backgroundChannelTest:!0,httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling};this.modifyHeadersForRequest(t.initMessageHeaders,e),"object"==typeof navigator&&"ReactNative"===navigator.product||(t.httpHeadersOverwriteParam="$httpHeaders");n=n.join("");br(Ks,"Creating WebChannel: "+n+" "+t);var o=r.createWebChannel(n,t),i=!1,a=!1,s=new Qs({sendFn:function(t){a?br(Ks,"Not sending because WebChannel is closed:",t):(i||(br(Ks,"Opening WebChannel transport."),o.open(),i=!0),br(Ks,"WebChannel sending:",t),o.send(t))},closeFn:function(){return o.close()}}),t=function(t,e){o.listen(t,function(t){try{e(t)}catch(t){setTimeout(function(){throw t},0)}})};return t(sr.EventType.OPEN,function(){a||br(Ks,"WebChannel transport opened.")}),t(sr.EventType.CLOSE,function(){a||(a=!0,br(Ks,"WebChannel transport closed"),s.callOnClose())}),t(sr.EventType.ERROR,function(t){a||(a=!0,br(Ks,"WebChannel transport errored:",t),s.callOnClose(new kr(Ar.UNAVAILABLE,"The operation could not be completed")))}),t(sr.EventType.MESSAGE,function(t){var e,n,r,i;a||(Tr(!!(e=t.data[0]),"Got a webchannel message without data."),(n=e.error||e[0]&&e[0].error)?(br(Ks,"WebChannel received error:",n),r=n.status,i=function(){var t=ts[r];if(void 0!==t)return is(t)}(),t=n.message,void 0===i&&(i=Ar.INTERNAL,t="Unknown error status: "+r+" with message "+n.message),a=!0,s.callOnClose(new kr(i,t)),o.close()):(br(Ks,"WebChannel received:",e),s.callOnMessage(e)))}),setTimeout(function(){s.callOnOpen()},0),s},Hs.prototype.makeUrl=function(t){var e=js[t];Tr(void 0!==e,"Unknown REST mapping for: "+t);t=[this.baseUrl,"/","v1"];return t.push("/projects/"),t.push(this.databaseId.projectId),t.push("/databases/"),t.push(this.databaseId.database),t.push("/documents"),t.push(":"),t.push(e),t.join("")},Hs),ne=(Object.defineProperty(zs.prototype,"document",{get:function(){return"undefined"!=typeof document?document:null},enumerable:!0,configurable:!0}),Object.defineProperty(zs.prototype,"window",{get:function(){return"undefined"!=typeof window?window:null},enumerable:!0,configurable:!0}),zs.prototype.loadConnection=function(t){return Promise.resolve(new Ws(t))},zs.prototype.newConnectivityMonitor=function(){return new(void 0!==this.window?Us:Vs)},zs.prototype.newSerializer=function(t){return new Fs(t,{useProto3Json:!0})},zs.prototype.formatJSON=function(t){return JSON.stringify(t)},zs.prototype.atob=function(t){return atob(t)},zs.prototype.btoa=function(t){return btoa(t)},zs);function zs(){this.emptyByteString="",this.base64Available="undefined"!=typeof atob}function Hs(t){this.databaseId=t.databaseId;var e=t.ssl?"https":"http";this.baseUrl=e+"://"+t.host,this.forceLongPolling=t.forceLongPolling}function Ys(t){this.sendFn=t.sendFn,this.closeFn=t.closeFn}function Xs(){var t=this;this.networkAvailableListener=function(){return t.onNetworkAvailable()},this.networkUnavailableListener=function(){return t.onNetworkUnavailable()},this.callbacks=[],this.configureNetworkMonitoring()}function Js(){}function $s(t,e){this.databaseId=t,this.options=e}Ir.setPlatform(new ne);function Zs(){var n=this;this.promise=new Promise(function(t,e){n.resolve=t,n.reject=e})}var tu,eu=(nu.prototype.setPreviousValue=function(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue},nu.prototype.next=function(){var t=++this.previousValue;return this.writeNewSequenceNumber&&this.writeNewSequenceNumber(t),t},nu.INVALID=-1,nu);function nu(t,e){var n=this;this.previousValue=t,e&&(e.sequenceNumberHandler=function(t){return n.setPreviousValue(t)},this.writeNewSequenceNumber=function(t){return e.writeSequenceNumber(t)})}(re=tu=tu||{}).All="all",re.ListenStreamIdle="listen_stream_idle",re.ListenStreamConnectionBackoff="listen_stream_connection_backoff",re.WriteStreamIdle="write_stream_idle",re.WriteStreamConnectionBackoff="write_stream_connection_backoff",re.OnlineStateTimeout="online_state_timeout",re.ClientMetadataRefresh="client_metadata_refresh",re.LruGarbageCollection="lru_garbage_collection";var ru=(hu.createAndSchedule=function(t,e,n,r,i){i=new hu(t,e,Date.now()+n,r,i);return i.start(n),i},hu.prototype.start=function(t){var e=this;this.timerHandle=setTimeout(function(){return e.handleDelayElapsed()},t)},hu.prototype.skipDelay=function(){return this.handleDelayElapsed()},hu.prototype.cancel=function(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new kr(Ar.CANCELLED,"Operation cancelled"+(t?": "+t:""))))},hu.prototype.handleDelayElapsed=function(){var e=this;this.asyncQueue.enqueueAndForget(function(){return null!==e.timerHandle?(e.clearTimeout(),e.op().then(function(t){return e.deferred.resolve(t)})):Promise.resolve()})},hu.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)},hu),iu=(cu.prototype.enqueueAndForget=function(t){this.enqueue(t)},cu.prototype.enqueue=function(t){var n=this;this.verifyNotFailed();var e=this.tail.then(function(){return n.operationInProgress=!0,t().catch(function(t){n.failure=t,n.operationInProgress=!1;var e=t.stack||t.message||"";throw wr("INTERNAL UNHANDLED ERROR: ",e),e.indexOf("Firestore Test Simulated Error")<0&&setTimeout(function(){throw t},0),t}).then(function(t){return n.operationInProgress=!1,t})});return this.tail=e},cu.prototype.enqueueAfterDelay=function(t,e,n){var r=this;this.verifyNotFailed(),Tr(0<=e,"Attempted to schedule an operation with a negative delay of "+e),Tr(!this.containsDelayedOperation(t),"Attempted to schedule multiple operations with timer id "+t+".");n=ru.createAndSchedule(this,t,e,n,function(t){return r.removeDelayedOperation(t)});return this.delayedOperations.push(n),n},cu.prototype.verifyNotFailed=function(){this.failure&&Sr("AsyncQueue is already failed: "+(this.failure.stack||this.failure.message))},cu.prototype.verifyOperationInProgress=function(){Tr(this.operationInProgress,"verifyOpInProgress() called when no op in progress on this queue.")},cu.prototype.drain=function(){return this.enqueue(function(){return Promise.resolve()})},cu.prototype.containsDelayedOperation=function(t){for(var e=0,n=this.delayedOperations;e<n.length;e++)if(n[e].timerId===t)return!0;return!1},cu.prototype.runDelayedOperationsEarly=function(r){var i=this;return this.drain().then(function(){Tr(r===tu.All||i.containsDelayedOperation(r),"Attempted to drain to missing operation "+r),i.delayedOperations.sort(function(t,e){return t.targetTimeMs-e.targetTimeMs});for(var t=0,e=i.delayedOperations;t<e.length;t++){var n=e[t];if(n.skipDelay(),r!==tu.All&&n.timerId===r)break}return i.drain()})},cu.prototype.removeDelayedOperation=function(t){t=this.delayedOperations.indexOf(t);Tr(0<=t,"Delayed operation not found."),this.delayedOperations.splice(t,1)},cu),ou="",au="",su="",uu="";function cu(){this.tail=Promise.resolve(),this.delayedOperations=[],this.operationInProgress=!1}function hu(t,e,n,r,i){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new Zs,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.catch=this.deferred.promise.catch.bind(this.deferred.promise),this.deferred.promise.catch(function(t){})}function lu(t){for(var e="",n=0;n<t.length;n++)0<e.length&&(e=fu(e)),e=function(t,e){for(var n=e,r=t.length,i=0;i<r;i++){var o=t.charAt(i);switch(o){case"\0":n+=ou+su;break;case ou:n+=ou+uu;break;default:n+=o}}return n}(t.get(n),e);return fu(e)}function fu(t){return t+ou+au}function pu(t){var e=t.length;if(Tr(2<=e,"Invalid path "+t),2===e)return Tr(t.charAt(0)===ou&&t.charAt(1)===au,"Non-empty path "+t+" had length 2"),Ti.EMPTY_PATH;for(var n=e-2,r=[],i="",o=0;o<e;){var a=t.indexOf(ou,o);switch((a<0||n<a)&&Sr('Invalid encoded resource path: "'+t+'"'),t.charAt(a+1)){case au:var s=t.substring(o,a),u=void 0;0===i.length?u=s:(u=i+=s,i=""),r.push(u);break;case su:i+=t.substring(o,a),i+="\0";break;case uu:i+=t.substring(o,a+1);break;default:Sr('Invalid encoded resource path: "'+t+'"')}o=a+2}return new Ti(r)}var du,mu=(Su.prototype.applyToRemoteDocument=function(t,e,n){e&&Tr(e.key.isEqual(t),"applyToRemoteDocument: key "+t+" should match maybeDoc key\n        "+e.key);var r=n.mutationResults;Tr(r.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+r.length+").");for(var i=0;i<this.mutations.length;i++){var o,a=this.mutations[i];a.key.isEqual(t)&&(o=r[i],e=a.applyToRemoteDocument(e,o))}return e},Su.prototype.applyToLocalView=function(t,e){e&&Tr(e.key.isEqual(t),"applyToLocalDocument: key "+t+" should match maybeDoc key\n        "+e.key);for(var n=0,r=this.baseMutations;n<r.length;n++)(i=r[n]).key.isEqual(t)&&(e=i.applyToLocalView(e,e,this.localWriteTime));for(var i,o=e,a=0,s=this.mutations;a<s.length;a++)(i=s[a]).key.isEqual(t)&&(e=i.applyToLocalView(e,o,this.localWriteTime));return e},Su.prototype.applyToLocalDocumentSet=function(n){var r=this,i=n;return this.mutations.forEach(function(t){var e=r.applyToLocalView(t.key,n.get(t.key));e&&(i=i.insert(t.key,e))}),i},Su.prototype.keys=function(){return this.mutations.reduce(function(t,e){return t.add(e.key)},cs())},Su.prototype.isEqual=function(t){return this.batchId===t.batchId&&ii(this.mutations,t.mutations)&&ii(this.baseMutations,t.baseMutations)},Su),yu=(Eu.from=function(t,e,n,r){Tr(t.mutations.length===n.length,"Mutations sent "+t.mutations.length+" must equal results received "+n.length);for(var i=ss,o=t.mutations,a=0;a<o.length;a++)i=i.insert(o[a].key,n[a].version);return new Eu(t,e,n,r,i)},Eu),gu=(wu.prototype.catch=function(t){return this.next(void 0,t)},wu.prototype.next=function(r,i){var o=this;return this.callbackAttached&&Sr("Called next() or catch() twice for PersistencePromise"),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(i,this.error):this.wrapSuccess(r,this.result):new wu(function(e,n){o.nextCallback=function(t){o.wrapSuccess(r,t).next(e,n)},o.catchCallback=function(t){o.wrapFailure(i,t).next(e,n)}})},wu.prototype.toPromise=function(){var n=this;return new Promise(function(t,e){n.next(t,e)})},wu.prototype.wrapUserFunction=function(t){try{var e=t();return e instanceof wu?e:wu.resolve(e)}catch(t){return wu.reject(t)}},wu.prototype.wrapSuccess=function(t,e){return t?this.wrapUserFunction(function(){return t(e)}):wu.resolve(e)},wu.prototype.wrapFailure=function(t,e){return t?this.wrapUserFunction(function(){return t(e)}):wu.reject(e)},wu.resolve=function(n){return new wu(function(t,e){t(n)})},wu.reject=function(n){return new wu(function(t,e){e(n)})},wu.waitFor=function(t){return new wu(function(e,n){var r=0,i=0,o=!1;t.forEach(function(t){++r,t.next(function(){++i,o&&i===r&&e()},function(t){return n(t)})}),o=!0,i===r&&e()})},wu.or=function(t){for(var n=wu.resolve(!1),e=0,r=t;e<r.length;e++)!function(e){n=n.next(function(t){return t?wu.resolve(t):e()})}(r[e]);return n},wu.forEach=function(t,n){var r=this,i=[];return t.forEach(function(t,e){i.push(n.call(r,t,e))}),this.waitFor(i)},wu),vu=(bu.forUser=function(t,e,n,r){return Tr(""!==t.uid,"UserID must not be an empty string."),new bu(t.isAuthenticated()?t.uid:"",e,n,r)},bu.prototype.checkEmpty=function(t){var r=!0,e=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Du(t).iterate({index:vc.userMutationsIndex,range:e},function(t,e,n){r=!1,n.done()}).next(function(){return r})},bu.prototype.acknowledgeBatch=function(e,t,n){return this.getMutationQueueMetadata(e).next(function(t){return t.lastStreamToken=Cu(n),Au(e).put(t)})},bu.prototype.getLastStreamToken=function(t){return this.getMutationQueueMetadata(t).next(function(t){return t.lastStreamToken})},bu.prototype.setLastStreamToken=function(e,n){return this.getMutationQueueMetadata(e).next(function(t){return t.lastStreamToken=Cu(n),Au(e).put(t)})},bu.prototype.addMutationBatch=function(u,c,h,l){var f=this,p=Nu(u),d=Du(u);return d.add({}).next(function(t){Tr("number"==typeof t,"Auto-generated key is not a number");var e=new mu(t,c,h,l),n=f.serializer.toDbMutationBatch(f.userId,e);f.documentKeysByBatchId[t]=e.keys();for(var r=[],i=0,o=l;i<o.length;i++){var a=o[i],s=Ec.key(f.userId,a.key.path,t);r.push(d.put(n)),r.push(p.put(s,Ec.PLACEHOLDER)),r.push(f.indexManager.addToCollectionParentIndex(u,a.key.path.popLast()))}return gu.waitFor(r).next(function(){return e})})},bu.prototype.lookupMutationBatch=function(t,e){var n=this;return Du(t).get(e).next(function(t){return t?(Tr(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),n.serializer.fromDbMutationBatch(t)):null})},bu.prototype.lookupMutationKeys=function(t,e){var n=this;return this.documentKeysByBatchId[e]?gu.resolve(this.documentKeysByBatchId[e]):this.lookupMutationBatch(t,e).next(function(t){if(t){t=t.keys();return n.documentKeysByBatchId[e]=t}return null})},bu.prototype.getNextMutationBatchAfterBatchId=function(n,o){var a=this;return this.getMutationQueueMetadata(n).next(function(t){var r=o+1,e=IDBKeyRange.lowerBound([a.userId,r]),i=null;return Du(n).iterate({index:vc.userMutationsIndex,range:e},function(t,e,n){e.userId===a.userId&&(Tr(e.batchId>=r,"Should have found mutation after "+r),i=a.serializer.fromDbMutationBatch(e)),n.done()}).next(function(){return i})})},bu.prototype.getAllMutationBatches=function(t){var e=this,n=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Du(t).loadAll(vc.userMutationsIndex,n).next(function(t){return t.map(function(t){return e.serializer.fromDbMutationBatch(t)})})},bu.prototype.getAllMutationBatchesAffectingDocumentKey=function(a,s){var u=this,t=Ec.prefixForPath(this.userId,s.path),t=IDBKeyRange.lowerBound(t),c=[];return Nu(a).iterate({range:t},function(e,t,n){var r=e[0],i=e[1],o=e[2],i=pu(i);if(r===u.userId&&s.path.isEqual(i))return Du(a).get(o).next(function(t){if(!t)throw Sr("Dangling document-mutation reference found: "+e+" which points to "+o);Tr(t.userId===u.userId,"Unexpected user '"+t.userId+"' for mutation batch "+o),c.push(u.serializer.fromDbMutationBatch(t))});n.done()}).next(function(){return c})},bu.prototype.getAllMutationBatchesAffectingDocumentKeys=function(e,t){var a=this,s=new wa(ri),n=[];return t.forEach(function(o){var t=Ec.prefixForPath(a.userId,o.path),t=IDBKeyRange.lowerBound(t),t=Nu(e).iterate({range:t},function(t,e,n){var r=t[0],i=t[1],t=t[2],i=pu(i);r===a.userId&&o.path.isEqual(i)?s=s.add(t):n.done()});n.push(t)}),gu.waitFor(n).next(function(){return a.lookupMutationBatches(e,s)})},bu.prototype.getAllMutationBatchesAffectingQuery=function(t,e){var o=this;Tr(!e.isDocumentQuery(),"Document queries shouldn't go down this path"),Tr(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var a=e.path,s=a.length+1,e=Ec.prefixForPath(this.userId,a),e=IDBKeyRange.lowerBound(e),u=new wa(ri);return Nu(t).iterate({range:e},function(t,e,n){var r=t[0],i=t[1],t=t[2],i=pu(i);r===o.userId&&a.isPrefixOf(i)?i.length===s&&(u=u.add(t)):n.done()}).next(function(){return o.lookupMutationBatches(t,u)})},bu.prototype.lookupMutationBatches=function(t,e){var n=this,r=[],i=[];return e.forEach(function(e){i.push(Du(t).get(e).next(function(t){if(null===t)throw Sr("Dangling document-mutation reference found, which points to "+e);Tr(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),r.push(n.serializer.fromDbMutationBatch(t))}))}),gu.waitFor(i).next(function(){return r})},bu.prototype.removeMutationBatch=function(e,n){var r=this;return Iu(e.simpleDbTransaction,this.userId,n).next(function(t){return r.removeCachedMutationKeys(n.batchId),gu.forEach(t,function(t){return r.referenceDelegate.removeMutationReference(e,t)})})},bu.prototype.removeCachedMutationKeys=function(t){delete this.documentKeysByBatchId[t]},bu.prototype.performConsistencyCheck=function(e){var i=this;return this.checkEmpty(e).next(function(t){if(!t)return gu.resolve();var t=IDBKeyRange.lowerBound(Ec.prefixForUser(i.userId)),r=[];return Nu(e).iterate({range:t},function(t,e,n){t[0]===i.userId?(t=pu(t[1]),r.push(t)):n.done()}).next(function(){Tr(0===r.length,"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+r.map(function(t){return t.canonicalString()}))})})},bu.prototype.containsKey=function(t,e){return Tu(t,this.userId,e)},bu.prototype.getMutationQueueMetadata=function(t){var e=this;return Au(t).get(this.userId).next(function(t){return t||new gc(e.userId,-1,"")})},bu);function bu(t,e,n,r){this.userId=t,this.serializer=e,this.indexManager=n,this.referenceDelegate=r,this.documentKeysByBatchId={}}function wu(t){var e=this;this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(function(t){e.isDone=!0,e.result=t,e.nextCallback&&e.nextCallback(t)},function(t){e.isDone=!0,e.error=t,e.catchCallback&&e.catchCallback(t)})}function Eu(t,e,n,r,i){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.streamToken=r,this.docVersions=i}function Su(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,Tr(0<(this.mutations=r).length,"Cannot create an empty mutation batch")}function Tu(t,o,e){var e=Ec.prefixForPath(o,e.path),a=e[1],e=IDBKeyRange.lowerBound(e),s=!1;return Nu(t).iterate({range:e,keysOnly:!0},function(t,e,n){var r=t[0],i=t[1];t[2],r===o&&i===a&&(s=!0),n.done()}).next(function(){return s})}function Iu(t,e,n){var r=t.store(vc.store),i=t.store(Ec.store),o=[],t=IDBKeyRange.only(n.batchId),a=0,t=r.iterate({range:t},function(t,e,n){return a++,n.delete()});o.push(t.next(function(){Tr(1===a,"Dangling document-mutation reference found: Missing batch "+n.batchId)}));for(var s=[],u=0,c=n.mutations;u<c.length;u++){var h=c[u],l=Ec.key(e,h.key.path,n.batchId);o.push(i.delete(l)),s.push(h.key)}return gu.waitFor(o).next(function(){return s})}function Cu(t){return t instanceof Uint8Array?(Tr("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence."),t.toString()):t}function Du(t){return oh.getStore(t,vc.store)}function Nu(t){return oh.getStore(t,Ec.store)}function Au(t){return oh.getStore(t,gc.store)}(rr=du=du||{})[rr.QueryCache=0]="QueryCache",rr[rr.SyncEngine=1]="SyncEngine";var ku=(Vu.prototype.next=function(){var t=this.nextId;return this.nextId+=2,t},Vu.prototype.after=function(t){return this.seek(t+2),this.next()},Vu.prototype.seek=function(t){Tr((1&t)===this.generatorId,"Cannot supply target ID from different generator ID"),this.nextId=t},Vu.forQueryCache=function(){return new Vu(du.QueryCache,2)},Vu.forSyncEngine=function(){return new Vu(du.SyncEngine)},Vu),Ru="SimpleDb",Mu=(Fu.openOrCreate=function(i,t,o){return Tr(Fu.isAvailable(),"IndexedDB not supported in current environment."),br(Ru,"Opening database:",i),new gu(function(e,n){var r=window.indexedDB.open(i,t);r.onsuccess=function(t){t=t.target.result;e(new Fu(t))},r.onblocked=function(){n(new kr(Ar.FAILED_PRECONDITION,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=function(t){t=t.target.error;"VersionError"===t.name?n(new kr(Ar.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):n(t)},r.onupgradeneeded=function(t){br(Ru,'Database "'+i+'" requires upgrade from version:',t.oldVersion);var e=t.target.result,n=new _u(r.transaction);o.createOrUpgrade(e,n,t.oldVersion,cc).next(function(){br(Ru,"Database upgrade to version "+cc+" complete")})}}).toPromise()},Fu.delete=function(t){return br(Ru,"Removing database:",t),Bu(window.indexedDB.deleteDatabase(t)).toPromise()},Fu.isAvailable=function(){if("undefined"==typeof window||null==window.indexedDB)return!1;if(void 0===window.navigator)return"YES"===process.env.USE_MOCK_PERSISTENCE;var t=window.navigator.userAgent,e=Fu.getIOSVersion(t),n=0<e&&e<10,e=Fu.getAndroidVersion(t),e=0<e&&e<4.5;return!(0<t.indexOf("MSIE ")||0<t.indexOf("Trident/")||0<t.indexOf("Edge/")||n||e)},Fu.getStore=function(t,e){return t.store(e)},Fu.getIOSVersion=function(t){t=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),t=t?t[1].split("_")[0]:"-1";return Number(t)},Fu.getAndroidVersion=function(t){t=t.match(/Android ([\d.]+)/i),t=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(t)},Fu.prototype.setVersionChangeListener=function(e){this.db.onversionchange=function(t){return e(t)}},Fu.prototype.runTransaction=function(t,e,n){var r=_u.open(this.db,t,e),i=n(r).catch(function(t){return r.abort(t),gu.reject(t)}).toPromise();return i.catch(function(){}),r.completionPromise.then(function(){return i})},Fu.prototype.close=function(){this.db.close()},Fu),Ou=(Object.defineProperty(qu.prototype,"isDone",{get:function(){return this.shouldStop},enumerable:!0,configurable:!0}),Object.defineProperty(qu.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:!0,configurable:!0}),Object.defineProperty(qu.prototype,"cursor",{set:function(t){this.dbCursor=t},enumerable:!0,configurable:!0}),qu.prototype.done=function(){this.shouldStop=!0},qu.prototype.skip=function(t){this.nextKey=t},qu.prototype.delete=function(){return Bu(this.dbCursor.delete())},qu),_u=(xu.open=function(t,e,n){return new xu(t.transaction(n,e))},Object.defineProperty(xu.prototype,"completionPromise",{get:function(){return this.completionDeferred.promise},enumerable:!0,configurable:!0}),xu.prototype.abort=function(t){t&&this.completionDeferred.reject(t),this.aborted||(br(Ru,"Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())},xu.prototype.store=function(t){var e=this.transaction.objectStore(t);return Tr(!!e,"Object store not part of transaction: "+t),new Pu(e)},xu),Pu=(Lu.prototype.put=function(t,e){return Bu(void 0!==e?(br(Ru,"PUT",this.store.name,t,e),this.store.put(e,t)):(br(Ru,"PUT",this.store.name,"<auto-key>",t),this.store.put(t)))},Lu.prototype.add=function(t){return br(Ru,"ADD",this.store.name,t,t),Bu(this.store.add(t))},Lu.prototype.get=function(e){var n=this;return Bu(this.store.get(e)).next(function(t){return br(Ru,"GET",n.store.name,e,t=void 0===t?null:t),t})},Lu.prototype.delete=function(t){return br(Ru,"DELETE",this.store.name,t),Bu(this.store.delete(t))},Lu.prototype.count=function(){return br(Ru,"COUNT",this.store.name),Bu(this.store.count())},Lu.prototype.loadAll=function(t,e){var e=this.cursor(this.options(t,e)),n=[];return this.iterateCursor(e,function(t,e){n.push(e)}).next(function(){return n})},Lu.prototype.deleteAll=function(t,e){br(Ru,"DELETE ALL",this.store.name);e=this.options(t,e);e.keysOnly=!1;e=this.cursor(e);return this.iterateCursor(e,function(t,e,n){return n.delete()})},Lu.prototype.iterate=function(t,e){e?n=t:(n={},e=t);var n=this.cursor(n);return this.iterateCursor(n,e)},Lu.prototype.iterateSerial=function(r){var t=this.cursor({});return new gu(function(n,e){t.onerror=function(t){e(t.target.error)},t.onsuccess=function(t){var e=t.target.result;e?r(e.primaryKey,e.value).next(function(t){t?e.continue():n()}):n()}})},Lu.prototype.iterateCursor=function(t,i){var o=[];return new gu(function(r,e){t.onerror=function(t){e(t.target.error)},t.onsuccess=function(t){var e,n=t.target.result;n?(e=new Ou(n),(t=i(n.primaryKey,n.value,e))instanceof gu&&(t=t.catch(function(t){return e.done(),gu.reject(t)}),o.push(t)),e.isDone?r():null===e.skipToKey?n.continue():n.continue(e.skipToKey)):r()}}).next(function(){return gu.waitFor(o)})},Lu.prototype.options=function(t,e){var n=void 0;return void 0!==t&&("string"==typeof t?n=t:(Tr(void 0===e,"3rd argument must not be defined if 2nd is a range."),e=t)),{index:n,range:e}},Lu.prototype.cursor=function(t){var e="next";if(t.reverse&&(e="prev"),t.index){var n=this.store.index(t.index);return t.keysOnly?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)},Lu);function Lu(t){this.store=t}function xu(t){var e=this;this.transaction=t,this.aborted=!1,this.completionDeferred=new Zs,this.transaction.oncomplete=function(){e.completionDeferred.resolve()},this.transaction.onabort=function(){t.error?e.completionDeferred.reject(t.error):e.completionDeferred.resolve()},this.transaction.onerror=function(t){e.completionDeferred.reject(t.target.error)}}function qu(t){this.dbCursor=t,this.shouldStop=!1,this.nextKey=null}function Fu(t){this.db=t}function Vu(t,e){Tr((1&(this.generatorId=t))===t,"Generator ID "+t+" contains more than 1 reserved bits"),this.seek(void 0!==e?e:this.generatorId)}function Bu(t){return new gu(function(e,n){t.onsuccess=function(t){t=t.target.result;e(t)},t.onerror=function(t){n(t.target.error)}})}var Uu=(Qu.prototype.allocateTargetId=function(e){var n=this;return this.retrieveMetadata(e).next(function(t){return t.highestTargetId=n.targetIdGenerator.after(t.highestTargetId),n.saveMetadata(e,t).next(function(){return t.highestTargetId})})},Qu.prototype.getLastRemoteSnapshotVersion=function(t){return this.retrieveMetadata(t).next(function(t){return aa.fromTimestamp(new bi(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))})},Qu.prototype.getHighestSequenceNumber=function(t){return Gu(t.simpleDbTransaction)},Qu.prototype.setTargetsMetadata=function(e,n,r){var i=this;return this.retrieveMetadata(e).next(function(t){return t.highestListenSequenceNumber=n,r&&(t.lastRemoteSnapshotVersion=r.toTimestamp()),n>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=n),i.saveMetadata(e,t)})},Qu.prototype.addQueryData=function(e,n){var r=this;return this.saveQueryData(e,n).next(function(){return r.retrieveMetadata(e).next(function(t){return t.targetCount+=1,r.updateMetadataFromQueryData(n,t),r.saveMetadata(e,t)})})},Qu.prototype.updateQueryData=function(t,e){return this.saveQueryData(t,e)},Qu.prototype.removeQueryData=function(e,t){var n=this;return this.removeMatchingKeysForTargetId(e,t.targetId).next(function(){return Ku(e).delete(t.targetId)}).next(function(){return n.retrieveMetadata(e)}).next(function(t){return Tr(0<t.targetCount,"Removing from an empty query cache"),--t.targetCount,n.saveMetadata(e,t)})},Qu.prototype.removeTargets=function(n,r,i){var o=this,a=0,s=[];return Ku(n).iterate(function(t,e){e=o.serializer.fromDbTarget(e);e.sequenceNumber<=r&&void 0===i[e.targetId]&&(a++,s.push(o.removeQueryData(n,e)))}).next(function(){return gu.waitFor(s)}).next(function(){return a})},Qu.prototype.forEachTarget=function(t,n){var r=this;return Ku(t).iterate(function(t,e){e=r.serializer.fromDbTarget(e);n(e)})},Qu.prototype.retrieveMetadata=function(t){return ju(t.simpleDbTransaction)},Qu.prototype.saveMetadata=function(t,e){return oh.getStore(t,Mc.store).put(Mc.key,e)},Qu.prototype.saveQueryData=function(t,e){return Ku(t).put(this.serializer.toDbTarget(e))},Qu.prototype.updateMetadataFromQueryData=function(t,e){var n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n},Qu.prototype.getQueryCount=function(t){return this.retrieveMetadata(t).next(function(t){return t.targetCount})},Qu.prototype.getQueryData=function(t,r){var i=this,e=r.canonicalId(),e=IDBKeyRange.bound([e,Number.NEGATIVE_INFINITY],[e,Number.POSITIVE_INFINITY]),o=null;return Ku(t).iterate({range:e,index:kc.queryTargetsIndexName},function(t,e,n){e=i.serializer.fromDbTarget(e);r.isEqual(e.query)&&(o=e,n.done())}).next(function(){return o})},Qu.prototype.addMatchingKeys=function(n,t,r){var i=this,o=[],a=Wu(n);return t.forEach(function(t){var e=lu(t.path);o.push(a.put(new Rc(r,e))),o.push(i.referenceDelegate.addReference(n,t))}),gu.waitFor(o)},Qu.prototype.removeMatchingKeys=function(n,t,r){var i=this,o=Wu(n);return gu.forEach(t,function(t){var e=lu(t.path);return gu.waitFor([o.delete([r,e]),i.referenceDelegate.removeReference(n,t)])})},Qu.prototype.removeMatchingKeysForTargetId=function(t,e){t=Wu(t),e=IDBKeyRange.bound([e],[e+1],!1,!0);return t.delete(e)},Qu.prototype.getMatchingKeysForTargetId=function(t,e){var e=IDBKeyRange.bound([e],[e+1],!1,!0),t=Wu(t),r=cs();return t.iterate({range:e,keysOnly:!0},function(t,e,n){t=pu(t[1]),t=new Di(t);r=r.add(t)}).next(function(){return r})},Qu.prototype.containsKey=function(t,e){var e=lu(e.path),e=IDBKeyRange.bound([e],[oi(e)],!1,!0),i=0;return Wu(t).iterate({index:Rc.documentTargetsIndex,keysOnly:!0,range:e},function(t,e,n){var r=t[0];t[1],0!==r&&(i++,n.done())}).next(function(){return 0<i})},Qu.prototype.getQueryDataForTarget=function(t,e){var n=this;return Ku(t).get(e).next(function(t){return t?n.serializer.fromDbTarget(t):null})},Qu);function Qu(t,e){this.referenceDelegate=t,this.serializer=e,this.targetIdGenerator=ku.forQueryCache()}function Ku(t){return oh.getStore(t,kc.store)}function ju(t){return Mu.getStore(t,Mc.store).get(Mc.key).next(function(t){return Tr(null!==t,"Missing metadata row."),t})}function Gu(t){return ju(t).next(function(t){return t.highestListenSequenceNumber})}function Wu(t){return oh.getStore(t,Rc.store)}var zu=($u.prototype.get=function(t){var e=this.mapKeyFn(t),e=this.inner[e];if(void 0!==e)for(var n=0,r=e;n<r.length;n++){var i=r[n],o=i[0],i=i[1];if(o.isEqual(t))return i}},$u.prototype.has=function(t){return void 0!==this.get(t)},$u.prototype.set=function(t,e){var n=this.mapKeyFn(t),r=this.inner[n];if(void 0!==r){for(var i=0;i<r.length;i++)if(r[i][0].isEqual(t))return void(r[i]=[t,e]);r.push([t,e])}else this.inner[n]=[[t,e]]},$u.prototype.delete=function(t){var e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(var r=0;r<n.length;r++)if(n[r][0].isEqual(t))return 1===n.length?delete this.inner[e]:n.splice(r,1),!0;return!1},$u.prototype.forEach=function(a){Lr(this.inner,function(t,e){for(var n=0,r=e;n<r.length;n++){var i=r[n],o=i[0],i=i[1];a(o,i)}})},$u.prototype.isEmpty=function(){return xr(this.inner)},$u),t=(Ju.prototype.addEntry=function(t){var e=this.assertChanges();this.changes=e.insert(t.key,t)},Ju.prototype.getEntry=function(t,e){var n=this,r=this.assertChanges().get(e);return r?gu.resolve(r):this.getFromCache(t,e).next(function(t){return null===t?(n.documentSizes.set(e,0),null):(n.documentSizes.set(e,t.size),t.maybeDocument)})},Ju.prototype.getEntries=function(t,e){var n=this;return this.getAllFromCache(t,e).next(function(t){var e=t.maybeDocuments;return t.sizeMap.forEach(function(t,e){n.documentSizes.set(t,e)}),e})},Ju.prototype.apply=function(t){t=this.applyChanges(t);return this.changes=null,t},Ju.prototype.assertChanges=function(){return Tr(null!==this.changes,"Changes have already been applied."),this.changes},Ju),Hu="The remote document changelog no longer contains all changes for all local query views. It may be necessary to rebuild these views.",Yu=(Object.defineProperty(Xu.prototype,"lastProcessedDocumentChangeId",{get:function(){return this._lastProcessedDocumentChangeId},enumerable:!0,configurable:!0}),Xu.prototype.start=function(t){t=Mu.getStore(t,Fc.store);return this.synchronizeLastDocumentChangeId(t)},Xu.prototype.addEntries=function(t,e,n){var r=[];if(0<e.length){for(var i=rc(t),o=cs(),a=0,s=e;a<s.length;a++){var u=s[a],c=u.key,u=u.doc;r.push(i.put(oc(c),u)),o=o.add(c),r.push(this.indexManager.addToCollectionParentIndex(t,c.path.popLast()))}this.keepDocumentChangeLog&&r.push(ic(t).put({changes:this.serializer.toDbResourcePaths(o)})),r.push(this.updateSize(t,n))}return gu.waitFor(r)},Xu.prototype.removeEntry=function(t,e){var n=rc(t),r=oc(e);return n.get(r).next(function(t){return t?n.delete(r).next(function(){return ac(t)}):gu.resolve(0)})},Xu.prototype.getEntry=function(t,e){var n=this;return rc(t).get(oc(e)).next(function(t){return t?n.serializer.fromDbRemoteDocument(t):null})},Xu.prototype.getSizedEntry=function(t,e){var n=this;return rc(t).get(oc(e)).next(function(t){return t?{maybeDocument:n.serializer.fromDbRemoteDocument(t),size:ac(t)}:null})},Xu.prototype.getEntries=function(t,e){var n=this,r=os;return this.forEachDbEntry(t,e,function(t,e){r=e?r.insert(t,n.serializer.fromDbRemoteDocument(e)):r.insert(t,null)}).next(function(){return r})},Xu.prototype.getSizedEntries=function(t,e){var n=this,r=os,i=new Ri(Di.comparator);return this.forEachDbEntry(t,e,function(t,e){i=e?(r=r.insert(t,n.serializer.fromDbRemoteDocument(e)),i.insert(t,ac(e))):(r=r.insert(t,null),i.insert(t,0))}).next(function(){return{maybeDocuments:r,sizeMap:i}})},Xu.prototype.forEachDbEntry=function(t,e,i){if(e.isEmpty())return gu.resolve();var n=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),o=e.getIterator(),a=o.getNext();return rc(t).iterate({range:n},function(t,e,n){for(var r=Di.fromSegments(t);a&&Di.comparator(a,r)<0;)i(a,null),a=o.getNext();a&&a.isEqual(r)&&(i(a,e),a=o.hasNext()?o.getNext():null),a?n.skip(a.path.toArray()):n.done()}).next(function(){for(;a;)i(a,null),a=o.hasNext()?o.getNext():null})},Xu.prototype.getDocumentsMatchingQuery=function(t,r){var i=this;Tr(!r.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var o=as,a=r.path.length+1,e=r.path.toArray(),e=IDBKeyRange.lowerBound(e);return rc(t).iterate({range:e},function(t,e,n){t.length===a&&(e=i.serializer.fromDbRemoteDocument(e),r.path.isPrefixOf(e.key.path)?e instanceof Ni&&r.matches(e)&&(o=o.insert(e.key,e)):n.done())}).next(function(){return o})},Xu.prototype.getNewDocumentChanges=function(n){var r=this;Tr(this.keepDocumentChangeLog,"Can only call getNewDocumentChanges() when document change log is enabled");var i=cs(),o=os,t=IDBKeyRange.lowerBound(this._lastProcessedDocumentChangeId+1),a=!0,s=ic(n);return s.iterate({range:t},function(t,e){return a&&(a=!1,r._lastProcessedDocumentChangeId+1!==e.id)?r.synchronizeLastDocumentChangeId(s).next(function(){return gu.reject(new kr(Ar.DATA_LOSS,Hu))}):(i=i.unionWith(r.serializer.fromDbResourcePaths(e.changes)),void(r._lastProcessedDocumentChangeId=e.id))}).next(function(){var t=[];return i.forEach(function(e){t.push(r.getEntry(n,e).next(function(t){t=t||new Ai(e,aa.forDeletedDoc());o=o.insert(e,t)}))}),gu.waitFor(t)}).next(function(){return o})},Xu.prototype.removeDocumentChangesThroughChangeId=function(t,e){e=IDBKeyRange.upperBound(e);return ic(t).delete(e)},Xu.prototype.synchronizeLastDocumentChangeId=function(t){var r=this;return this._lastProcessedDocumentChangeId=0,t.iterate({keysOnly:!0,reverse:!0},function(t,e,n){r._lastProcessedDocumentChangeId=t,n.done()})},Xu.prototype.newChangeBuffer=function(){return new ec(this)},Xu.prototype.getSize=function(t){return this.getMetadata(t).next(function(t){return t.byteSize})},Xu.prototype.getMetadata=function(t){return Zu(t).get(Dc.key).next(function(t){return Tr(!!t,"Missing document cache metadata"),t})},Xu.prototype.setMetadata=function(t,e){return Zu(t).put(Dc.key,e)},Xu.prototype.updateSize=function(e,n){var r=this;return this.getMetadata(e).next(function(t){return t.byteSize+=n,r.setMetadata(e,t)})},Xu);function Xu(t,e,n){this.serializer=t,this.indexManager=e,this.keepDocumentChangeLog=n,this._lastProcessedDocumentChangeId=0}function Ju(){this.changes=os,this.documentSizes=new zu(function(t){return t.toString()})}function $u(t){this.mapKeyFn=t,this.inner={}}function Zu(t){return oh.getStore(t,Dc.store)}var tc,ec=(a(nc,tc=t),nc.prototype.applyChanges=function(t){var i=this,e=this.assertChanges(),o=0,a=[];return e.forEach(function(t,e){var n=i.documentCache.serializer.toDbRemoteDocument(e),r=i.documentSizes.get(t);Tr(void 0!==r,"Attempting to change document "+t.toString()+" without having read it first");e=ac(n);o+=e-r,a.push({key:t,doc:n})}),this.documentCache.addEntries(t,a,o)},nc.prototype.getFromCache=function(t,e){return this.documentCache.getSizedEntry(t,e)},nc.prototype.getAllFromCache=function(t,e){return this.documentCache.getSizedEntries(t,e)},nc);function nc(t){var e=tc.call(this)||this;return e.documentCache=t,e}function rc(t){return oh.getStore(t,Cc.store)}function ic(t){return oh.getStore(t,Fc.store)}function oc(t){return t.path.toArray()}function ac(t){var e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw Sr("Unknown remote document type");e=t.noDocument}return JSON.stringify(e).length}var sc=(pc.prototype.addToCollectionParentIndex=function(t,e){return this.collectionParentIndex.add(e),gu.resolve()},pc.prototype.getCollectionParents=function(t,e){return gu.resolve(this.collectionParentIndex.getEntries(e))},pc),uc=(fc.prototype.add=function(t){Tr(t.length%2==1,"Expected a collection path.");var e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new wa(Ti.comparator),t=!r.has(n);return this.index[e]=r.add(n),t},fc.prototype.getEntries=function(t){return(this.index[t]||new wa(Ti.comparator)).toArray()},fc),cc=8,hc=(lc.prototype.createOrUpgrade=function(t,i,e,n){var r=this;Tr(e<n&&0<=e&&n<=cc,"Unexpected schema upgrade from v"+e+" to v{toVersion}."),e<1&&1<=n&&(t.createObjectStore(mc.store),(o=t).createObjectStore(gc.store,{keyPath:gc.keyPath}),o.createObjectStore(vc.store,{keyPath:vc.keyPath,autoIncrement:!0}).createIndex(vc.userMutationsIndex,vc.userMutationsKeyPath,{unique:!0}),o.createObjectStore(Ec.store),qc(t),t.createObjectStore(Cc.store));var o,a=gu.resolve();return e<3&&3<=n&&(0!==e&&((o=t).deleteObjectStore(Rc.store),o.deleteObjectStore(kc.store),o.deleteObjectStore(Mc.store),qc(t)),a=a.next(function(){return t=i.store(Mc.store),e=new Mc(0,0,aa.MIN.toTimestamp(),0),t.put(Mc.key,e);var t,e})),e<4&&4<=n&&(a=(a=0!==e?a.next(function(){return n=t,(r=i).store(vc.store).loadAll().next(function(t){n.deleteObjectStore(vc.store),n.createObjectStore(vc.store,{keyPath:vc.keyPath,autoIncrement:!0}).createIndex(vc.userMutationsIndex,vc.userMutationsKeyPath,{unique:!0});var e=r.store(vc.store),t=t.map(function(t){return e.put(t)});return gu.waitFor(t)});var n,r}):a).next(function(){t.createObjectStore(Bc.store,{keyPath:Bc.keyPath}),t.createObjectStore(Fc.store,{keyPath:"id",autoIncrement:!0})})),e<5&&5<=n&&(a=a.next(function(){return r.removeAcknowledgedMutations(i)})),e<6&&6<=n&&(a=a.next(function(){return t.createObjectStore(Dc.store),r.addDocumentGlobal(i)})),e<7&&7<=n&&(a=a.next(function(){return r.ensureSequenceNumbers(i)})),a=e<8&&8<=n?a.next(function(){return r.createCollectionParentIndex(t,i)}):a},lc.prototype.addDocumentGlobal=function(e){var n=0;return e.store(Cc.store).iterate(function(t,e){n+=ac(e)}).next(function(){var t=new Dc(n);return e.store(Dc.store).put(Dc.key,t)})},lc.prototype.removeAcknowledgedMutations=function(n){var r=this,t=n.store(gc.store),i=n.store(vc.store);return t.loadAll().next(function(t){return gu.forEach(t,function(e){var t=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return i.loadAll(vc.userMutationsIndex,t).next(function(t){return gu.forEach(t,function(t){Tr(t.userId===e.userId,"Cannot process batch "+t.batchId+" from unexpected user");t=r.serializer.fromDbMutationBatch(t);return Iu(n,e.userId,t).next(function(){})})})})})},lc.prototype.ensureSequenceNumbers=function(t){var o=t.store(Rc.store),e=t.store(Cc.store);return Gu(t).next(function(r){var i=[];return e.iterate(function(t,e){var n=new Ti(t),t=[0,lu(n)];i.push(o.get(t).next(function(t){return t?gu.resolve():o.put(new Rc(0,lu(n),r))}))}).next(function(){return gu.waitFor(i)})})},lc.prototype.createCollectionParentIndex=function(t,e){t.createObjectStore(Oc.store,{keyPath:Oc.keyPath});function r(t){if(i.add(t)){var e=t.lastSegment(),t=t.popLast();return n.put({collectionId:e,parent:lu(t)})}}var n=e.store(Oc.store),i=new uc;return e.store(Cc.store).iterate({keysOnly:!0},function(t,e){t=new Ti(t);return r(t.popLast())}).next(function(){return e.store(Ec.store).iterate({keysOnly:!0},function(t,e){t[0];var n=t[1],n=(t[2],pu(n));return r(n.popLast())})})},lc);function lc(t){this.serializer=t}function fc(){this.index={}}function pc(){this.collectionParentIndex=new uc}function dc(t,e){this.seconds=t,this.nanoseconds=e}var mc=(yc.store="owner",yc.key="owner",yc);function yc(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}var gc=(wc.store="mutationQueues",wc.keyPath="userId",wc),vc=(bc.store="mutations",bc.keyPath="batchId",bc.userMutationsIndex="userMutationsIndex",bc.userMutationsKeyPath=["userId","batchId"],bc);function bc(t,e,n,r,i){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=i}function wc(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}var Ec=(Sc.prefixForUser=function(t){return[t]},Sc.prefixForPath=function(t,e){return[t,lu(e)]},Sc.key=function(t,e,n){return[t,lu(e),n]},Sc.store="documentMutations",Sc.PLACEHOLDER=new Sc,Sc);function Sc(){}function Tc(t,e){this.path=t,this.readTime=e}function Ic(t,e){this.path=t,this.version=e}var Cc=(Ac.store="remoteDocuments",Ac),Dc=(Nc.store="remoteDocumentGlobal",Nc.key="remoteDocumentGlobalKey",Nc);function Nc(t){this.byteSize=t}function Ac(t,e,n,r){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=r}var kc=(xc.store="targets",xc.keyPath="targetId",xc.queryTargetsIndexName="queryTargetsIndex",xc.queryTargetsKeyPath=["canonicalId","targetId"],xc),Rc=(Lc.store="targetDocuments",Lc.keyPath=["targetId","path"],Lc.documentTargetsIndex="documentTargetsIndex",Lc.documentTargetsKeyPath=["path","targetId"],Lc),Mc=(Pc.key="targetGlobalKey",Pc.store="targetGlobal",Pc),Oc=(_c.store="collectionParents",_c.keyPath=["collectionId","parent"],_c);function _c(t,e){this.collectionId=t,this.parent=e}function Pc(t,e,n,r){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=r}function Lc(t,e,n){this.targetId=t,this.path=e,Tr(0===t==(void 0!==(this.sequenceNumber=n)),"A target-document row must either have targetId == 0 and a defined sequence number, or a non-zero targetId and no sequence number")}function xc(t,e,n,r,i,o){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=i,this.query=o}function qc(t){t.createObjectStore(Rc.store,{keyPath:Rc.keyPath}).createIndex(Rc.documentTargetsIndex,Rc.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(kc.store,{keyPath:kc.keyPath}).createIndex(kc.queryTargetsIndexName,kc.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(Mc.store)}var Fc=(Vc.store="remoteDocumentChanges",Vc.keyPath="id",Vc);function Vc(t){this.changes=t}var Bc=(Uc.store="clientMetadata",Uc.keyPath="clientId",Uc);function Uc(t,e,n,r,i){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=r,this.lastProcessedDocumentChangeId=i}var Qc=[gc.store,vc.store,Ec.store,Cc.store,kc.store,mc.store,Mc.store,Rc.store].concat([Bc.store,Fc.store]).concat([Dc.store]).concat([Oc.store]),Kc=(jc.prototype.addToCollectionParentIndex=function(t,e){if(Tr(e.length%2==1,"Expected a collection path."),this.collectionParentsCache.add(e)){Tr(1<=e.length,"Invalid collection path.");var n=e.lastSegment(),e=e.popLast();return Gc(t).put({collectionId:n,parent:lu(e)})}return gu.resolve()},jc.prototype.getCollectionParents=function(t,i){var o=[],e=IDBKeyRange.bound([i,""],[oi(i),""],!1,!0);return Gc(t).loadAll(e).next(function(t){for(var e=0,n=t;e<n.length;e++){var r=n[e];if(r.collectionId!==i)break;o.push(pu(r.parent))}return o})},jc);function jc(){this.collectionParentsCache=new uc}function Gc(t){return oh.getStore(t,Oc.store)}var Wc=(zc.prototype.fromDbRemoteDocument=function(t){if(t.document)return this.remoteSerializer.fromDocument(t.document,!!t.hasCommittedMutations);if(t.noDocument){var e=Di.fromSegments(t.noDocument.path),n=this.fromDbTimestamp(t.noDocument.readTime);return new Ai(e,n,{hasCommittedMutations:!!t.hasCommittedMutations})}return t.unknownDocument?(e=Di.fromSegments(t.unknownDocument.path),n=this.fromDbTimestamp(t.unknownDocument.version),new ki(e,n)):Sr("Unexpected DbRemoteDocument")},zc.prototype.toDbRemoteDocument=function(t){if(t instanceof Ni){var e=t.proto||this.remoteSerializer.toDocument(t),n=t.hasCommittedMutations;return new Cc(null,null,e,n)}if(t instanceof Ai){var r=t.key.path.toArray(),i=this.toDbTimestamp(t.version),n=t.hasCommittedMutations;return new Cc(null,new Tc(r,i),null,n)}return t instanceof ki?(r=t.key.path.toArray(),i=this.toDbTimestamp(t.version),new Cc(new Ic(r,i),null,null,!0)):Sr("Unexpected MaybeDocumment")},zc.prototype.toDbTimestamp=function(t){t=t.toTimestamp();return new dc(t.seconds,t.nanoseconds)},zc.prototype.fromDbTimestamp=function(t){t=new bi(t.seconds,t.nanoseconds);return aa.fromTimestamp(t)},zc.prototype.toDbMutationBatch=function(t,e){var n=this,r=e.baseMutations.map(function(t){return n.remoteSerializer.toMutation(t)}),i=e.mutations.map(function(t){return n.remoteSerializer.toMutation(t)});return new vc(t,e.batchId,e.localWriteTime.toMillis(),r,i)},zc.prototype.fromDbMutationBatch=function(t){var e=this,n=(t.baseMutations||[]).map(function(t){return e.remoteSerializer.fromMutation(t)}),r=t.mutations.map(function(t){return e.remoteSerializer.fromMutation(t)}),i=bi.fromMillis(t.localWriteTimeMs);return new mu(t.batchId,i,n,r)},zc.prototype.toDbResourcePaths=function(t){var e=[];return t.forEach(function(t){e.push(lu(t.path))}),e},zc.prototype.fromDbResourcePaths=function(t){for(var e=cs(),n=0,r=t;n<r.length;n++)var i=r[n],e=e.add(new Di(pu(i)));return e},zc.prototype.fromDbTarget=function(t){var e=this.fromDbTimestamp(t.readTime),n=void 0!==t.query.documents?this.remoteSerializer.fromDocumentsTarget(t.query):this.remoteSerializer.fromQueryTarget(t.query);return new ba(n,t.targetId,Go.Listen,t.lastListenSequenceNumber,e,t.resumeToken)},zc.prototype.toDbTarget=function(t){Tr(Go.Listen===t.purpose,"Only queries with purpose "+Go.Listen+" may be stored, got "+t.purpose);var e=this.toDbTimestamp(t.snapshotVersion),n=t.query.isDocumentQuery()?this.remoteSerializer.toDocumentsTarget(t.query):this.remoteSerializer.toQueryTarget(t.query),r=t.resumeToken instanceof Uint8Array?(Tr("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence ."),t.resumeToken.toString()):t.resumeToken;return new kc(t.targetId,t.query.canonicalId(),e,r,t.sequenceNumber,n)},zc);function zc(t){this.remoteSerializer=t}function Hc(t,e){var n=t[0],r=t[1],t=e[0],e=e[1],t=ri(n,t);return 0===t?ri(r,e):t}var Yc,Xc=(lh.prototype.nextIndex=function(){return++this.previousIndex},lh.prototype.addElement=function(t){var e=[t,this.nextIndex()];this.buffer.size<this.maxElements?this.buffer=this.buffer.add(e):Hc(e,t=this.buffer.last())<0&&(this.buffer=this.buffer.delete(t).add(e))},Object.defineProperty(lh.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!0,configurable:!0}),lh),Jc={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},$c=(hh.withCacheSize=function(t){return new hh(t,hh.DEFAULT_COLLECTION_PERCENTILE,hh.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)},hh.COLLECTION_DISABLED=-1,hh.MINIMUM_CACHE_SIZE_BYTES=1048576,hh.DEFAULT=new hh(hh.DEFAULT_CACHE_SIZE_BYTES=41943040,hh.DEFAULT_COLLECTION_PERCENTILE=10,hh.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3),hh.DISABLED=new hh(hh.COLLECTION_DISABLED,0,0),hh),Zc=(ch.prototype.start=function(){Tr(null===this.gcTask,"Cannot start an already started LruScheduler"),this.garbageCollector.params.cacheSizeCollectionThreshold!==$c.COLLECTION_DISABLED&&this.scheduleGC()},ch.prototype.stop=function(){this.gcTask&&(this.gcTask.cancel(),this.gcTask=null)},Object.defineProperty(ch.prototype,"started",{get:function(){return null!==this.gcTask},enumerable:!0,configurable:!0}),ch.prototype.scheduleGC=function(){var t=this;Tr(null===this.gcTask,"Cannot schedule GC while a task is pending");var e=this.hasRun?3e5:6e4;br("LruGarbageCollector","Garbage collection scheduled in "+e+"ms"),this.gcTask=this.asyncQueue.enqueueAfterDelay(tu.LruGarbageCollection,e,function(){return t.gcTask=null,t.hasRun=!0,t.localStore.collectGarbage(t.garbageCollector).then(function(){return t.scheduleGC()}).catch(fh)})},ch),th=(uh.prototype.calculateTargetCount=function(t,e){return this.delegate.getSequenceNumberCount(t).next(function(t){return Math.floor(e/100*t)})},uh.prototype.nthSequenceNumber=function(t,e){var n=this;if(0===e)return gu.resolve(eu.INVALID);var r=new Xc(e);return this.delegate.forEachTarget(t,function(t){return r.addElement(t.sequenceNumber)}).next(function(){return n.delegate.forEachOrphanedDocumentSequenceNumber(t,function(t){return r.addElement(t)})}).next(function(){return r.maxValue})},uh.prototype.removeTargets=function(t,e,n){return this.delegate.removeTargets(t,e,n)},uh.prototype.removeOrphanedDocuments=function(t,e){return this.delegate.removeOrphanedDocuments(t,e)},uh.prototype.collect=function(e,n){var r=this;return this.params.cacheSizeCollectionThreshold===$c.COLLECTION_DISABLED?(br("LruGarbageCollector","Garbage collection skipped; disabled"),gu.resolve(Jc)):this.getCacheSize(e).next(function(t){return t<r.params.cacheSizeCollectionThreshold?(br("LruGarbageCollector","Garbage collection skipped; Cache size "+t+" is lower than threshold "+r.params.cacheSizeCollectionThreshold),Jc):r.runGarbageCollection(e,n)})},uh.prototype.getCacheSize=function(t){return this.delegate.getCacheSize(t)},uh.prototype.runGarbageCollection=function(e,n){var r,i,o,a,s,u,c,h=this,l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(function(t){return i=t>h.params.maximumSequenceNumbersToCollect?(br("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of "+h.params.maximumSequenceNumbersToCollect+" from "+t),h.params.maximumSequenceNumbersToCollect):t,a=Date.now(),h.nthSequenceNumber(e,i)}).next(function(t){return r=t,s=Date.now(),h.removeTargets(e,r,n)}).next(function(t){return o=t,u=Date.now(),h.removeOrphanedDocuments(e,r)}).next(function(t){return c=Date.now(),gr()<=pr.DEBUG&&br("LruGarbageCollector","LRU Garbage Collection\n\tCounted targets in "+(a-l)+"ms\n\tDetermined least recently used "+i+" in "+(s-a)+"ms\n\tRemoved "+o+" targets in "+(u-s)+"ms\n\tRemoved "+t+" documents in "+(c-u)+"ms\nTotal Duration: "+(c-l)+"ms"),gu.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:o,documentsRemoved:t})})},uh),eh="IndexedDbPersistence",nh="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",rh="Another tab has exclusive access to the persistence layer. To allow shared access, make sure to invoke `enablePersistence()` with `synchronizeTabs:true` in all tabs.",ih=(a(sh,Yc=function(){}),sh),oh=(ah.getStore=function(t,e){if(t instanceof ih)return Mu.getStore(t.simpleDbTransaction,e);throw Sr("IndexedDbPersistence must use instances of IndexedDbTransaction")},ah.createIndexedDbPersistence=function(n,r,i,o,a,s){return c(this,void 0,void 0,function(){var e;return p(this,function(t){switch(t.label){case 0:return[4,(e=new ah(n,r,i,o,a,s)).start()];case 1:return t.sent(),[2,e]}})})},ah.createMultiClientIndexedDbPersistence=function(n,r,i,o,a,s,u){return c(this,void 0,void 0,function(){var e;return p(this,function(t){switch(t.label){case 0:return[4,(e=new ah(n,r,i,o,a,s,u)).start()];case 1:return t.sent(),[2,e]}})})},ah.prototype.start=function(){var n=this;return Tr(!this.started,"IndexedDbPersistence double-started!"),Tr(null!==this.window,"Expected 'window' to be defined"),Mu.openOrCreate(this.dbName,cc,new hc(this.serializer)).then(function(t){return n.simpleDb=t,n.updateClientMetadataAndTryBecomePrimary()}).then(function(){return n.attachVisibilityHandler(),n.attachWindowUnloadHook(),n.scheduleClientMetadataAndPrimaryLeaseRefreshes(),n.startRemoteDocumentCache()}).then(function(){return n.simpleDb.runTransaction("readonly",[Mc.store],function(t){return Gu(t).next(function(t){var e=n.multiClientParams?n.multiClientParams.sequenceNumberSyncer:void 0;n.listenSequence=new eu(t,e)})})}).then(function(){n._started=!0}).catch(function(t){return n.simpleDb&&n.simpleDb.close(),Promise.reject(t)})},ah.prototype.startRemoteDocumentCache=function(){var e=this;return this.simpleDb.runTransaction("readonly",Qc,function(t){return e.remoteDocumentCache.start(t)})},ah.prototype.setPrimaryStateListener=function(n){var t=this;return this.primaryStateListener=function(e){return c(t,void 0,void 0,function(){return p(this,function(t){return this.started?[2,n(e)]:[2]})})},n(this.isPrimary)},ah.prototype.setDatabaseDeletedListener=function(n){var t=this;this.simpleDb.setVersionChangeListener(function(e){return c(t,void 0,void 0,function(){return p(this,function(t){switch(t.label){case 0:return null!==e.newVersion?[3,2]:[4,n()];case 1:t.sent(),t.label=2;case 2:return[2]}})})})},ah.prototype.setNetworkEnabled=function(t){var e=this;this.networkEnabled!==t&&(this.networkEnabled=t,this.queue.enqueueAndForget(function(){return c(e,void 0,void 0,function(){return p(this,function(t){switch(t.label){case 0:return this.started?[4,this.updateClientMetadataAndTryBecomePrimary()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})}))},ah.prototype.updateClientMetadataAndTryBecomePrimary=function(){var r=this;return this.simpleDb.runTransaction("readwrite",Qc,function(n){return dh(n).put(new Bc(r.clientId,Date.now(),r.networkEnabled,r.inForeground,r.remoteDocumentCache.lastProcessedDocumentChangeId)).next(function(){if(r.isPrimary)return r.verifyPrimaryLease(n).next(function(t){t||(r.isPrimary=!1,r.queue.enqueueAndForget(function(){return r.primaryStateListener(!1)}))})}).next(function(){return r.canActAsPrimary(n)}).next(function(t){var e=r.isPrimary;return r.isPrimary=t,e!==r.isPrimary&&r.queue.enqueueAndForget(function(){return r.primaryStateListener(r.isPrimary)}),e&&!r.isPrimary?r.releasePrimaryLeaseIfHeld(n):r.isPrimary?r.acquireOrExtendPrimaryLease(n):void 0})})},ah.prototype.verifyPrimaryLease=function(t){var e=this;return ph(t).get(mc.key).next(function(t){return gu.resolve(e.isLocalClient(t))})},ah.prototype.removeClientMetadata=function(t){return dh(t).delete(this.clientId)},ah.prototype.maybeGarbageCollectMultiClientState=function(){return c(this,void 0,void 0,function(){var r,i,o=this;return p(this,function(t){switch(t.label){case 0:return!this.isPrimary||this.isWithinAge(this.lastGarbageCollectionTime,18e5)?[3,2]:(this.lastGarbageCollectionTime=Date.now(),i=[],[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",function(e){var n=ah.getStore(e,Bc.store);return n.loadAll().next(function(t){r=o.filterActiveClients(t,18e5),i=t.filter(function(t){return-1===r.indexOf(t)})}).next(function(){return gu.forEach(i,function(t){return n.delete(t.clientId)})}).next(function(){if(0<(r=r.filter(function(t){return t.clientId!==o.clientId})).length){var t=r.map(function(t){return t.lastProcessedDocumentChangeId||0}),t=Math.min.apply(Math,t);return o.remoteDocumentCache.removeDocumentChangesThroughChangeId(e,t)}})})]);case 1:t.sent(),i.forEach(function(t){o.window.localStorage.removeItem(o.zombiedClientLocalStorageKey(t.clientId))}),t.label=2;case 2:return[2]}})})},ah.prototype.scheduleClientMetadataAndPrimaryLeaseRefreshes=function(){var t=this;this.clientMetadataRefresher=this.queue.enqueueAfterDelay(tu.ClientMetadataRefresh,4e3,function(){return t.updateClientMetadataAndTryBecomePrimary().then(function(){return t.maybeGarbageCollectMultiClientState()}).then(function(){return t.scheduleClientMetadataAndPrimaryLeaseRefreshes()})})},ah.prototype.isLocalClient=function(t){return!!t&&t.ownerId===this.clientId},ah.prototype.canActAsPrimary=function(e){var r=this;return ph(e).get(mc.key).next(function(t){if(null!==t&&r.isWithinAge(t.leaseTimestampMs,5e3)&&!r.isClientZombied(t.ownerId)){if(r.isLocalClient(t)&&r.networkEnabled)return!0;if(!r.isLocalClient(t)){if(!t.allowTabSynchronization)throw new kr(Ar.FAILED_PRECONDITION,rh);return!1}}return!(!r.networkEnabled||!r.inForeground)||dh(e).loadAll().next(function(t){return void 0===r.filterActiveClients(t,5e3).find(function(t){if(r.clientId!==t.clientId){var e=!r.networkEnabled&&t.networkEnabled,n=!r.inForeground&&t.inForeground,t=r.networkEnabled===t.networkEnabled;if(e||n&&t)return!0}return!1})})}).next(function(t){return r.isPrimary!==t&&br(eh,"Client "+(t?"is":"is not")+" eligible for a primary lease."),t})},ah.prototype.shutdown=function(){return c(this,void 0,void 0,function(){var e=this;return p(this,function(t){switch(t.label){case 0:return this._started=!1,this.markClientZombied(),this.clientMetadataRefresher&&this.clientMetadataRefresher.cancel(),this.detachVisibilityHandler(),this.detachWindowUnloadHook(),[4,this.simpleDb.runTransaction("readwrite",[mc.store,Bc.store],function(t){return e.releasePrimaryLeaseIfHeld(t).next(function(){return e.removeClientMetadata(t)})})];case 1:return t.sent(),this.simpleDb.close(),this.removeClientZombiedEntry(),[2]}})})},ah.prototype.filterActiveClients=function(t,e){var n=this;return t.filter(function(t){return n.isWithinAge(t.updateTimeMs,e)&&!n.isClientZombied(t.clientId)})},ah.prototype.getActiveClients=function(){var e=this;return this.simpleDb.runTransaction("readonly",[Bc.store],function(t){return dh(t).loadAll().next(function(t){return e.filterActiveClients(t,18e5).map(function(t){return t.clientId})})})},ah.clearPersistence=function(n){return c(this,void 0,void 0,function(){var e;return p(this,function(t){switch(t.label){case 0:return ah.isAvailable()?(e=n+ah.MAIN_DATABASE,[4,Mu.delete(e)]):[2,Promise.resolve()];case 1:return t.sent(),[2]}})})},Object.defineProperty(ah.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),ah.prototype.getMutationQueue=function(t){return Tr(this.started,"Cannot initialize MutationQueue before persistence is started."),vu.forUser(t,this.serializer,this.indexManager,this.referenceDelegate)},ah.prototype.getQueryCache=function(){return Tr(this.started,"Cannot initialize QueryCache before persistence is started."),this.queryCache},ah.prototype.getRemoteDocumentCache=function(){return Tr(this.started,"Cannot initialize RemoteDocumentCache before persistence is started."),this.remoteDocumentCache},ah.prototype.getIndexManager=function(){return Tr(this.started,"Cannot initialize IndexManager before persistence is started."),this.indexManager},ah.prototype.runTransaction=function(n,t,r){var i=this;return br(eh,"Starting transaction:",n),this.simpleDb.runTransaction("readonly"===t?"readonly":"readwrite",Qc,function(e){return"readwrite-primary"===t?i.verifyPrimaryLease(e).next(function(t){if(!t)throw wr("Failed to obtain primary lease for action '"+n+"'."),i.isPrimary=!1,i.queue.enqueueAndForget(function(){return i.primaryStateListener(!1)}),new kr(Ar.FAILED_PRECONDITION,nh);return r(new ih(e,i.listenSequence.next()))}).next(function(t){return i.acquireOrExtendPrimaryLease(e).next(function(){return t})}):i.verifyAllowTabSynchronization(e).next(function(){return r(new ih(e,i.listenSequence.next()))})})},ah.prototype.verifyAllowTabSynchronization=function(t){var e=this;return ph(t).get(mc.key).next(function(t){if(null!==t&&e.isWithinAge(t.leaseTimestampMs,5e3)&&!e.isClientZombied(t.ownerId)&&!e.isLocalClient(t)&&!t.allowTabSynchronization)throw new kr(Ar.FAILED_PRECONDITION,rh)})},ah.prototype.acquireOrExtendPrimaryLease=function(t){var e=new mc(this.clientId,this.allowTabSynchronization,Date.now());return ph(t).put(mc.key,e)},ah.isAvailable=function(){return Mu.isAvailable()},ah.buildStoragePrefix=function(t){var e=t.databaseId.projectId;return t.databaseId.isDefaultDatabase||(e+="."+t.databaseId.database),"firestore/"+t.persistenceKey+"/"+e+"/"},ah.prototype.releasePrimaryLeaseIfHeld=function(t){var e=this,n=ph(t);return n.get(mc.key).next(function(t){return e.isLocalClient(t)?(br(eh,"Releasing primary lease."),n.delete(mc.key)):gu.resolve()})},ah.prototype.isWithinAge=function(t,e){var n=Date.now();return!(t<n-e||n<t&&(wr("Detected an update time that is in the future: "+t+" > "+n),1))},ah.prototype.attachVisibilityHandler=function(){var t=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.documentVisibilityHandler=function(){t.queue.enqueueAndForget(function(){return t.inForeground="visible"===t.document.visibilityState,t.updateClientMetadataAndTryBecomePrimary()})},this.document.addEventListener("visibilitychange",this.documentVisibilityHandler),this.inForeground="visible"===this.document.visibilityState)},ah.prototype.detachVisibilityHandler=function(){this.documentVisibilityHandler&&(Tr(null!==this.document&&"function"==typeof this.document.addEventListener,"Expected 'document.addEventListener' to be a function"),this.document.removeEventListener("visibilitychange",this.documentVisibilityHandler),this.documentVisibilityHandler=null)},ah.prototype.attachWindowUnloadHook=function(){var t=this;"function"==typeof this.window.addEventListener&&(this.windowUnloadHandler=function(){t.markClientZombied(),t.queue.enqueueAndForget(function(){return t.shutdown()})},this.window.addEventListener("unload",this.windowUnloadHandler))},ah.prototype.detachWindowUnloadHook=function(){this.windowUnloadHandler&&(Tr("function"==typeof this.window.removeEventListener,"Expected 'window.removeEventListener' to be a function"),this.window.removeEventListener("unload",this.windowUnloadHandler),this.windowUnloadHandler=null)},ah.prototype.isClientZombied=function(t){try{var e=null!==this.webStorage.getItem(this.zombiedClientLocalStorageKey(t));return br(eh,"Client '"+t+"' "+(e?"is":"is not")+" zombied in LocalStorage"),e}catch(t){return wr(eh,"Failed to get zombied client id.",t),!1}},ah.prototype.markClientZombied=function(){try{this.webStorage.setItem(this.zombiedClientLocalStorageKey(this.clientId),String(Date.now()))}catch(t){wr("Failed to set zombie client id.",t)}},ah.prototype.removeClientZombiedEntry=function(){try{this.webStorage.removeItem(this.zombiedClientLocalStorageKey(this.clientId))}catch(t){}},ah.prototype.zombiedClientLocalStorageKey=function(t){return"firestore_zombie_"+this.persistenceKey+"_"+t},ah.MAIN_DATABASE="main",ah);function ah(t,e,n,r,i,o,a){if(this.persistenceKey=t,this.clientId=e,this.queue=r,this.multiClientParams=a,this._started=!1,this.isPrimary=!1,this.networkEnabled=!0,this.inForeground=!1,this.lastGarbageCollectionTime=Number.NEGATIVE_INFINITY,this.primaryStateListener=function(t){return Promise.resolve()},!ah.isAvailable())throw new kr(Ar.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");if(this.referenceDelegate=new mh(this,o),this.dbName=t+ah.MAIN_DATABASE,this.serializer=new Wc(i),this.document=n.document,this.allowTabSynchronization=void 0!==a,this.queryCache=new Uu(this.referenceDelegate,this.serializer),this.indexManager=new Kc,this.remoteDocumentCache=new Yu(this.serializer,this.indexManager,this.allowTabSynchronization),!n.window||!n.window.localStorage)throw new kr(Ar.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");this.window=n.window,this.webStorage=this.window.localStorage}function sh(t,e){var n=Yc.call(this)||this;return n.simpleDbTransaction=t,n.currentSequenceNumber=e,n}function uh(t,e){this.delegate=t,this.params=e}function ch(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.gcTask=null}function hh(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}function lh(t){this.maxElements=t,this.buffer=new wa(Hc),this.previousIndex=0}function fh(e){return c(this,void 0,void 0,function(){return p(this,function(t){if(e.code!==Ar.FAILED_PRECONDITION||e.message!==nh)throw e;return br(eh,"Unexpectedly lost primary lease"),[2]})})}function ph(t){return t.store(mc.store)}function dh(t){return t.store(Bc.store)}var mh=(yh.prototype.getSequenceNumberCount=function(t){var n=this.orphanedDocmentCount(t);return this.db.getQueryCache().getQueryCount(t).next(function(e){return n.next(function(t){return e+t})})},yh.prototype.orphanedDocmentCount=function(t){var e=0;return this.forEachOrphanedDocumentSequenceNumber(t,function(t){e++}).next(function(){return e})},yh.prototype.forEachTarget=function(t,e){return this.db.getQueryCache().forEachTarget(t,e)},yh.prototype.forEachOrphanedDocumentSequenceNumber=function(t,n){return this.forEachOrphanedDocument(t,function(t,e){return n(e)})},yh.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},yh.prototype.addReference=gh,yh.prototype.removeReference=gh,yh.prototype.removeTargets=function(t,e,n){return this.db.getQueryCache().removeTargets(t,e,n)},yh.prototype.removeMutationReference=gh,yh.prototype.isPinned=function(t,e){return this.inMemoryPins.containsKey(e)?gu.resolve(!0):(r=e,i=!1,Au(n=t).iterateSerial(function(t){return Tu(n,t,r).next(function(t){return t&&(i=!0),gu.resolve(!t)})}).next(function(){return i}));var n,r,i},yh.prototype.removeOrphanedDocuments=function(n,r){var i=this,o=0,a=0,s=[];return this.forEachOrphanedDocument(n,function(e,t){t<=r&&(t=i.isPinned(n,e).next(function(t){if(!t)return o++,i.removeOrphanedDocument(n,e).next(function(t){a+=t})}),s.push(t))}).next(function(){return gu.waitFor(s)}).next(function(){return i.db.getRemoteDocumentCache().updateSize(n,-a)}).next(function(){return o})},yh.prototype.removeOrphanedDocument=function(t,e){var n=0,r=this.db.getRemoteDocumentCache();return gu.waitFor([Wu(t).delete([0,lu(e.path)]),r.removeEntry(t,e).next(function(t){n+=t})]).next(function(){return n})},yh.prototype.removeTarget=function(t,e){e=e.copy({sequenceNumber:t.currentSequenceNumber});return this.db.getQueryCache().updateQueryData(t,e)},yh.prototype.updateLimboDocument=gh,yh.prototype.forEachOrphanedDocument=function(t,r){var i,t=Wu(t),o=eu.INVALID;return t.iterate({index:Rc.documentTargetsIndex},function(t,e){var n=t[0],t=(t[1],e.path),e=e.sequenceNumber;0===n?(o!==eu.INVALID&&r(new Di(pu(i)),o),o=e,i=t):o=eu.INVALID}).next(function(){o!==eu.INVALID&&r(new Di(pu(i)),o)})},yh.prototype.getCacheSize=function(t){return this.db.getRemoteDocumentCache().getSize(t)},yh);function yh(t,e){this.db=t,this.garbageCollector=new th(this,e)}function gh(t,e){return Wu(t).put((t=t.currentSequenceNumber,new Rc(0,lu(e.path),t)))}var vh=(kh.prototype.getDocument=function(e,n){var r=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(e,n).next(function(t){return r.getDocumentInternal(e,n,t)})},kh.prototype.getDocumentInternal=function(t,r,i){return this.remoteDocumentCache.getEntry(t,r).next(function(t){for(var e=0,n=i;e<n.length;e++)t=n[e].applyToLocalView(r,t);return t})},kh.prototype.applyLocalMutationsToDocuments=function(t,e,i){var o=os;return e.forEach(function(t,e){for(var n=0,r=i;n<r.length;n++)e=r[n].applyToLocalView(t,e);o=o.insert(t,e)}),o},kh.prototype.getDocuments=function(e,t){var n=this;return this.remoteDocumentCache.getEntries(e,t).next(function(t){return n.getLocalViewOfDocuments(e,t)})},kh.prototype.getLocalViewOfDocuments=function(e,r){var i=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,r).next(function(t){var t=i.applyLocalMutationsToDocuments(e,r,t),n=os;return t.forEach(function(t,e){e=e||new Ai(t,aa.forDeletedDoc()),n=n.insert(t,e)}),n})},kh.prototype.getDocumentsMatchingQuery=function(t,e){return e.isDocumentQuery()?this.getDocumentsMatchingDocumentQuery(t,e.path):e.isCollectionGroupQuery()?this.getDocumentsMatchingCollectionGroupQuery(t,e):this.getDocumentsMatchingCollectionQuery(t,e)},kh.prototype.getDocumentsMatchingDocumentQuery=function(t,e){return this.getDocument(t,new Di(e)).next(function(t){var e=as;return e=t instanceof Ni?as.insert(t.key,t):e})},kh.prototype.getDocumentsMatchingCollectionGroupQuery=function(e,n){var r=this;Tr(n.path.isEmpty(),"Currently we only support collection group queries at the root.");var i=n.collectionGroup,o=as;return this.indexManager.getCollectionParents(e,i).next(function(t){return gu.forEach(t,function(t){t=n.asCollectionQueryAtPath(t.child(i));return r.getDocumentsMatchingCollectionQuery(e,t).next(function(t){t.forEach(function(t,e){o=o.insert(t,e)})})}).next(function(){return o})})},kh.prototype.getDocumentsMatchingCollectionQuery=function(e,c){var h,n=this;return this.remoteDocumentCache.getDocumentsMatchingQuery(e,c).next(function(t){return h=t,n.mutationQueue.getAllMutationBatchesAffectingQuery(e,c)}).next(function(t){for(var e=0,n=t;e<n.length;e++)for(var r=n[e],i=0,o=r.mutations;i<o.length;i++){var a,s=o[i],u=s.key;c.path.isImmediateParentOf(u.path)&&(a=h.get(u),a=s.applyToLocalView(a,a,r.localWriteTime),h=a instanceof Ni?h.insert(u,a):h.remove(u))}}).next(function(){return h.forEach(function(t,e){c.matches(e)||(h=h.remove(t))}),h})},kh),bh=(Ah.prototype.isEmpty=function(){return this.refsByKey.isEmpty()},Ah.prototype.addReference=function(t,e){e=new wh(t,e);this.refsByKey=this.refsByKey.add(e),this.refsByTarget=this.refsByTarget.add(e)},Ah.prototype.addReferences=function(t,e){var n=this;t.forEach(function(t){return n.addReference(t,e)})},Ah.prototype.removeReference=function(t,e){this.removeRef(new wh(t,e))},Ah.prototype.removeReferences=function(t,e){var n=this;t.forEach(function(t){return n.removeReference(t,e)})},Ah.prototype.removeReferencesForId=function(t){var e=this,n=Di.EMPTY,r=new wh(n,t),t=new wh(n,t+1),i=[];return this.refsByTarget.forEachInRange([r,t],function(t){e.removeRef(t),i.push(t.key)}),i},Ah.prototype.removeAllReferences=function(){var e=this;this.refsByKey.forEach(function(t){return e.removeRef(t)})},Ah.prototype.removeRef=function(t){this.refsByKey=this.refsByKey.delete(t),this.refsByTarget=this.refsByTarget.delete(t)},Ah.prototype.referencesForId=function(t){var e=Di.EMPTY,n=new wh(e,t),t=new wh(e,t+1),r=cs();return this.refsByTarget.forEachInRange([n,t],function(t){r=r.add(t.key)}),r},Ah.prototype.containsKey=function(t){var e=new wh(t,0),e=this.refsByKey.firstAfterOrEqual(e);return null!==e&&t.isEqual(e.key)},Ah),wh=(Nh.compareByKey=function(t,e){return Di.comparator(t.key,e.key)||ri(t.targetOrBatchId,e.targetOrBatchId)},Nh.compareByTargetId=function(t,e){return ri(t.targetOrBatchId,e.targetOrBatchId)||Di.comparator(t.key,e.key)},Nh),Eh=(Dh.prototype.handleUserChange=function(e){var y=this;return this.persistence.runTransaction("Handle user change","readonly",function(d){var m;return y.mutationQueue.getAllMutationBatches(d).next(function(t){return m=t,y.mutationQueue=y.persistence.getMutationQueue(e),y.localDocuments=new vh(y.remoteDocuments,y.mutationQueue,y.persistence.getIndexManager()),y.mutationQueue.getAllMutationBatches(d)}).next(function(t){for(var e=[],n=[],r=cs(),i=0,o=m;i<o.length;i++){var a=o[i];e.push(a.batchId);for(var s=0,u=a.mutations;s<u.length;s++)var c=u[s],r=r.add(c.key)}for(var h=0,l=t;h<l.length;h++){a=l[h],n.push(a.batchId);for(var f=0,p=a.mutations;f<p.length;f++)c=p[f],r=r.add(c.key)}return y.localDocuments.getDocuments(d,r).next(function(t){return{affectedDocuments:t,removedBatchIds:e,addedBatchIds:n}})})})},Dh.prototype.localWrite=function(u){var c=this,h=bi.now(),t=u.reduce(function(t,e){return t.add(e.key)},cs());return this.persistence.runTransaction("Locally write mutations","readwrite",function(s){return c.localDocuments.getDocuments(s,t).next(function(n){for(var t=[],e=0,r=u;e<r.length;e++){var i,o=r[e],a=n.get(o.key);o.isIdempotent||(i=o.fieldMask)&&(a=a instanceof Ni?i.applyTo(a.data):Ao.EMPTY,t.push(new xa(o.key,a,i,_a.exists(!0))))}return c.mutationQueue.addMutationBatch(s,h,t,u).next(function(t){var e=t.applyToLocalDocumentSet(n);return{batchId:t.batchId,changes:e}})})})},Dh.prototype.lookupMutationDocuments=function(t){var n=this;return this.persistence.runTransaction("Lookup mutation documents","readonly",function(e){return n.mutationQueue.lookupMutationKeys(e,t).next(function(t){return t?n.localDocuments.getDocuments(e,t):gu.resolve(null)})})},Dh.prototype.acknowledgeBatch=function(r){var i=this;return this.persistence.runTransaction("Acknowledge batch","readwrite-primary",function(t){var e=r.batch.keys(),n=i.remoteDocuments.newChangeBuffer();return i.mutationQueue.acknowledgeBatch(t,r.batch,r.streamToken).next(function(){return i.applyWriteToRemoteDocuments(t,r,n)}).next(function(){return n.apply(t)}).next(function(){return i.mutationQueue.performConsistencyCheck(t)}).next(function(){return i.localDocuments.getDocuments(t,e)})})},Dh.prototype.rejectBatch=function(t){var r=this;return this.persistence.runTransaction("Reject batch","readwrite-primary",function(e){var n;return r.mutationQueue.lookupMutationBatch(e,t).next(function(t){return Tr(null!==t,"Attempt to reject nonexistent batch!"),n=t.keys(),r.mutationQueue.removeMutationBatch(e,t)}).next(function(){return r.mutationQueue.performConsistencyCheck(e)}).next(function(){return r.localDocuments.getDocuments(e,n)})})},Dh.prototype.getLastStreamToken=function(){var e=this;return this.persistence.runTransaction("Get last stream token","readonly",function(t){return e.mutationQueue.getLastStreamToken(t)})},Dh.prototype.setLastStreamToken=function(e){var n=this;return this.persistence.runTransaction("Set last stream token","readwrite-primary",function(t){return n.mutationQueue.setLastStreamToken(t,e)})},Dh.prototype.getLastRemoteSnapshotVersion=function(){var e=this;return this.persistence.runTransaction("Get last remote snapshot version","readonly",function(t){return e.queryCache.getLastRemoteSnapshotVersion(t)})},Dh.prototype.applyRemoteEvent=function(u){var c=this,h=this.remoteDocuments.newChangeBuffer();return this.persistence.runTransaction("Apply remote event","readwrite-primary",function(o){var a=[],s=cs();Pr(u.targetChanges,function(t,e){var n,r,i=c.queryDataByTarget[t];i&&(e.addedDocuments.forEach(function(t){s=s.add(t)}),e.modifiedDocuments.forEach(function(t){s=s.add(t)}),a.push(c.queryCache.removeMatchingKeys(o,e.removedDocuments,t).next(function(){return c.queryCache.addMatchingKeys(o,e.addedDocuments,t)})),0<(n=e.resumeToken).length&&(i=(r=i).copy({resumeToken:n,snapshotVersion:u.snapshotVersion}),c.queryDataByTarget[t]=i,Dh.shouldPersistQueryData(r,i,e)&&a.push(c.queryCache.updateQueryData(o,i))))});var i=os,n=cs();u.documentUpdates.forEach(function(t,e){n=n.add(t)}),a.push(h.getEntries(o,n).next(function(r){u.documentUpdates.forEach(function(t,e){var n=r.get(t);null==n||e.version.isEqual(aa.MIN)||s.has(e.key)&&!n.hasPendingWrites||0<=e.version.compareTo(n.version)?(h.addEntry(e),i=i.insert(t,e)):br("LocalStore","Ignoring outdated watch update for ",t,". Current version:",n.version," Watch version:",e.version),u.resolvedLimboDocuments.has(t)&&a.push(c.persistence.referenceDelegate.updateLimboDocument(o,t))})}));var t,e=u.snapshotVersion;return e.isEqual(aa.MIN)||(t=c.queryCache.getLastRemoteSnapshotVersion(o).next(function(t){return Tr(0<=e.compareTo(t),"Watch stream reverted to previous snapshot?? "+e+" < "+t),c.queryCache.setTargetsMetadata(o,o.currentSequenceNumber,e)}),a.push(t)),gu.waitFor(a).next(function(){return h.apply(o)}).next(function(){return c.localDocuments.getLocalViewOfDocuments(o,i)})})},Dh.shouldPersistQueryData=function(t,e,n){return 0!==e.resumeToken.length&&(0===t.resumeToken.length||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=this.RESUME_TOKEN_MAX_AGE_MICROS||0<n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size)},Dh.prototype.notifyLocalViewChanges=function(t){var n=this;return this.persistence.runTransaction("notifyLocalViewChanges","readwrite",function(e){return gu.forEach(t,function(t){return n.localViewReferences.addReferences(t.addedKeys,t.targetId),n.localViewReferences.removeReferences(t.removedKeys,t.targetId),gu.forEach(t.removedKeys,function(t){return n.persistence.referenceDelegate.removeReference(e,t)})})})},Dh.prototype.nextMutationBatch=function(e){var n=this;return this.persistence.runTransaction("Get next mutation batch","readonly",function(t){return void 0===e&&(e=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(t,e)})},Dh.prototype.readDocument=function(e){var n=this;return this.persistence.runTransaction("read document","readonly",function(t){return n.localDocuments.getDocument(t,e)})},Dh.prototype.allocateQuery=function(r){var i=this;return this.persistence.runTransaction("Allocate query","readwrite",function(e){var n;return i.queryCache.getQueryData(e,r).next(function(t){return t?(n=t,gu.resolve()):i.queryCache.allocateTargetId(e).next(function(t){return n=new ba(r,t,Go.Listen,e.currentSequenceNumber),i.queryCache.addQueryData(e,n)})}).next(function(){return Tr(!i.queryDataByTarget[n.targetId],"Tried to allocate an already allocated query: "+r),i.queryDataByTarget[n.targetId]=n})})},Dh.prototype.releaseQuery=function(i,o){var a=this;return this.persistence.runTransaction("Release query",o?"readwrite":"readwrite-primary",function(r){return a.queryCache.getQueryData(r,i).next(function(t){Tr(null!=t,"Tried to release nonexistent query: "+i);var e=t.targetId,n=a.queryDataByTarget[e],t=a.localViewReferences.removeReferencesForId(e);return delete a.queryDataByTarget[e],o?gu.resolve():gu.forEach(t,function(t){return a.persistence.referenceDelegate.removeReference(r,t)}).next(function(){return a.persistence.referenceDelegate.removeTarget(r,n)})})})},Dh.prototype.executeQuery=function(e){var n=this;return this.persistence.runTransaction("Execute query","readonly",function(t){return n.localDocuments.getDocumentsMatchingQuery(t,e)})},Dh.prototype.remoteDocumentKeys=function(e){var n=this;return this.persistence.runTransaction("Remote document keys","readonly",function(t){return n.queryCache.getMatchingKeysForTargetId(t,e)})},Dh.prototype.getActiveClients=function(){return this.persistence.getActiveClients()},Dh.prototype.removeCachedMutationBatchMetadata=function(t){this.mutationQueue.removeCachedMutationKeys(t)},Dh.prototype.setNetworkEnabled=function(t){this.persistence.setNetworkEnabled(t)},Dh.prototype.applyWriteToRemoteDocuments=function(t,i,o){var e=this,a=i.batch,n=a.keys(),s=gu.resolve();return n.forEach(function(r){s=s.next(function(){return o.getEntry(t,r)}).next(function(t){var e=t,n=i.docVersions.get(r);Tr(null!==n,"ackVersions should contain every doc in the write."),(!e||e.version.compareTo(n)<0)&&((e=a.applyToRemoteDocument(r,e,i))?o.addEntry(e):Tr(!t,"Mutation batch "+a+" applied to document "+t+" resulted in null"))})}),s.next(function(){return e.mutationQueue.removeMutationBatch(t,a)})},Dh.prototype.collectGarbage=function(e){var n=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary",function(t){return e.collect(t,n.queryDataByTarget)})},Dh.prototype.getQueryForTarget=function(e){var n=this;return this.queryDataByTarget[e]?Promise.resolve(this.queryDataByTarget[e].query):this.persistence.runTransaction("Get query data","readonly",function(t){return n.queryCache.getQueryDataForTarget(t,e).next(function(t){return t?t.query:null})})},Dh.prototype.getNewDocumentChanges=function(){var e=this;return this.persistence.runTransaction("Get new document changes","readonly",function(t){return e.remoteDocuments.getNewDocumentChanges(t)})},Dh.RESUME_TOKEN_MAX_AGE_MICROS=3e8,Dh),Sh=(Ch.prototype.checkEmpty=function(t){return gu.resolve(0===this.mutationQueue.length)},Ch.prototype.acknowledgeBatch=function(t,e,n){var r=e.batchId,e=this.indexOfExistingBatchId(r,"acknowledged");Tr(0===e,"Can only acknowledge the first batch in the mutation queue");e=this.mutationQueue[e];return Tr(r===e.batchId,"Queue ordering failure: expected batch "+r+", got batch "+e.batchId),this.lastStreamToken=n,gu.resolve()},Ch.prototype.getLastStreamToken=function(t){return gu.resolve(this.lastStreamToken)},Ch.prototype.setLastStreamToken=function(t,e){return this.lastStreamToken=e,gu.resolve()},Ch.prototype.addMutationBatch=function(t,e,n,r){Tr(0!==r.length,"Mutation batches should not be empty");var i=this.nextBatchId;this.nextBatchId++,0<this.mutationQueue.length&&Tr(this.mutationQueue[this.mutationQueue.length-1].batchId<i,"Mutation batchIDs must be monotonically increasing order");n=new mu(i,e,n,r);this.mutationQueue.push(n);for(var o=0,a=r;o<a.length;o++){var s=a[o];this.batchesByDocumentKey=this.batchesByDocumentKey.add(new wh(s.key,i)),this.indexManager.addToCollectionParentIndex(t,s.key.path.popLast())}return gu.resolve(n)},Ch.prototype.lookupMutationBatch=function(t,e){return gu.resolve(this.findMutationBatch(e))},Ch.prototype.lookupMutationKeys=function(t,e){e=this.findMutationBatch(e);return Tr(null!=e,"Failed to find local mutation batch."),gu.resolve(e.keys())},Ch.prototype.getNextMutationBatchAfterBatchId=function(t,e){e=this.indexOfBatchId(e+1),e=e<0?0:e;return gu.resolve(this.mutationQueue.length>e?this.mutationQueue[e]:null)},Ch.prototype.getAllMutationBatches=function(t){return gu.resolve(this.mutationQueue.slice())},Ch.prototype.getAllMutationBatchesAffectingDocumentKey=function(t,e){var n=this,r=new wh(e,0),i=new wh(e,Number.POSITIVE_INFINITY),o=[];return this.batchesByDocumentKey.forEachInRange([r,i],function(t){Tr(e.isEqual(t.key),"Should only iterate over a single key's batches");t=n.findMutationBatch(t.targetOrBatchId);Tr(null!==t,"Batches in the index must exist in the main table"),o.push(t)}),gu.resolve(o)},Ch.prototype.getAllMutationBatchesAffectingDocumentKeys=function(t,e){var r=this,i=new wa(ri);return e.forEach(function(e){var t=new wh(e,0),n=new wh(e,Number.POSITIVE_INFINITY);r.batchesByDocumentKey.forEachInRange([t,n],function(t){Tr(e.isEqual(t.key),"For each key, should only iterate over a single key's batches"),i=i.add(t.targetOrBatchId)})}),gu.resolve(this.findMutationBatches(i))},Ch.prototype.getAllMutationBatchesAffectingQuery=function(t,e){Tr(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var n=e.path,r=n.length+1,e=n;Di.isDocumentKey(e)||(e=e.child(""));var e=new wh(new Di(e),0),i=new wa(ri);return this.batchesByDocumentKey.forEachWhile(function(t){var e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(i=i.add(t.targetOrBatchId)),!0)},e),gu.resolve(this.findMutationBatches(i))},Ch.prototype.findMutationBatches=function(t){var e=this,n=[];return t.forEach(function(t){t=e.findMutationBatch(t);null!==t&&n.push(t)}),n},Ch.prototype.removeMutationBatch=function(n,r){var i=this;Tr(0===this.indexOfExistingBatchId(r.batchId,"removed"),"Can only remove the first entry of the mutation queue"),this.mutationQueue.shift();var o=this.batchesByDocumentKey;return gu.forEach(r.mutations,function(t){var e=new wh(t.key,r.batchId);return o=o.delete(e),i.referenceDelegate.removeMutationReference(n,t.key)}).next(function(){i.batchesByDocumentKey=o})},Ch.prototype.removeCachedMutationKeys=function(t){},Ch.prototype.containsKey=function(t,e){var n=new wh(e,0),n=this.batchesByDocumentKey.firstAfterOrEqual(n);return gu.resolve(e.isEqual(n&&n.key))},Ch.prototype.performConsistencyCheck=function(t){return 0===this.mutationQueue.length&&Tr(this.batchesByDocumentKey.isEmpty(),"Document leak -- detected dangling mutation references when queue is empty."),gu.resolve()},Ch.prototype.indexOfExistingBatchId=function(t,e){t=this.indexOfBatchId(t);return Tr(0<=t&&t<this.mutationQueue.length,"Batches must exist to be "+e),t},Ch.prototype.indexOfBatchId=function(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId},Ch.prototype.findMutationBatch=function(t){var e=this.indexOfBatchId(t);if(e<0||e>=this.mutationQueue.length)return null;e=this.mutationQueue[e];return Tr(e.batchId===t,"If found batch must match"),e},Ch),Th=(Ih.prototype.getTargetCount=function(t){return gu.resolve(this.targetCount)},Ih.prototype.forEachTarget=function(t,n){return this.queries.forEach(function(t,e){return n(e)}),gu.resolve()},Ih.prototype.getLastRemoteSnapshotVersion=function(t){return gu.resolve(this.lastRemoteSnapshotVersion)},Ih.prototype.getHighestSequenceNumber=function(t){return gu.resolve(this.highestSequenceNumber)},Ih.prototype.allocateTargetId=function(t){var e=this.targetIdGenerator.after(this.highestTargetId);return this.highestTargetId=e,gu.resolve(e)},Ih.prototype.setTargetsMetadata=function(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.highestSequenceNumber&&(this.highestSequenceNumber=e),gu.resolve()},Ih.prototype.saveQueryData=function(t){this.queries.set(t.query,t);var e=t.targetId;e>this.highestTargetId&&(this.highestTargetId=e),t.sequenceNumber>this.highestSequenceNumber&&(this.highestSequenceNumber=t.sequenceNumber)},Ih.prototype.addQueryData=function(t,e){return Tr(!this.queries.has(e.query),"Adding a query that already exists"),this.saveQueryData(e),this.targetCount+=1,gu.resolve()},Ih.prototype.updateQueryData=function(t,e){return Tr(this.queries.has(e.query),"Updating a non-existent query"),this.saveQueryData(e),gu.resolve()},Ih.prototype.removeQueryData=function(t,e){return Tr(0<this.targetCount,"Removing a target from an empty cache"),Tr(this.queries.has(e.query),"Removing a non-existent target from the cache"),this.queries.delete(e.query),this.references.removeReferencesForId(e.targetId),--this.targetCount,gu.resolve()},Ih.prototype.removeTargets=function(n,r,i){var o=this,a=0,s=[];return this.queries.forEach(function(t,e){e.sequenceNumber<=r&&!i[e.targetId]&&(o.queries.delete(t),s.push(o.removeMatchingKeysForTargetId(n,e.targetId)),a++)}),gu.waitFor(s).next(function(){return a})},Ih.prototype.getQueryCount=function(t){return gu.resolve(this.targetCount)},Ih.prototype.getQueryData=function(t,e){e=this.queries.get(e)||null;return gu.resolve(e)},Ih.prototype.getQueryDataForTarget=function(t,e){return Sr("Not yet implemented.")},Ih.prototype.addMatchingKeys=function(e,t,n){this.references.addReferences(t,n);var r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(function(t){i.push(r.addReference(e,t))}),gu.waitFor(i)},Ih.prototype.removeMatchingKeys=function(e,t,n){this.references.removeReferences(t,n);var r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(function(t){i.push(r.removeReference(e,t))}),gu.waitFor(i)},Ih.prototype.removeMatchingKeysForTargetId=function(t,e){return this.references.removeReferencesForId(e),gu.resolve()},Ih.prototype.getMatchingKeysForTargetId=function(t,e){e=this.references.referencesForId(e);return gu.resolve(e)},Ih.prototype.containsKey=function(t,e){return gu.resolve(this.references.containsKey(e))},Ih);function Ih(t){this.persistence=t,this.queries=new zu(function(t){return t.canonicalId()}),this.lastRemoteSnapshotVersion=aa.MIN,this.highestTargetId=0,this.highestSequenceNumber=0,this.references=new bh,this.targetCount=0,this.targetIdGenerator=ku.forQueryCache()}function Ch(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.nextBatchId=1,this.lastStreamToken=Dr(),this.batchesByDocumentKey=new wa(wh.compareByKey)}function Dh(t,e){this.persistence=t,this.localViewReferences=new bh,this.queryDataByTarget={},Tr(t.started,"LocalStore was passed an unstarted persistence implementation"),this.persistence.referenceDelegate.setInMemoryPins(this.localViewReferences),this.mutationQueue=t.getMutationQueue(e),this.remoteDocuments=t.getRemoteDocumentCache(),this.queryCache=t.getQueryCache(),this.localDocuments=new vh(this.remoteDocuments,this.mutationQueue,this.persistence.getIndexManager())}function Nh(t,e){this.key=t,this.targetOrBatchId=e}function Ah(){this.refsByKey=new wa(wh.compareByKey),this.refsByTarget=new wa(wh.compareByTargetId)}function kh(t,e,n){this.remoteDocumentCache=t,this.mutationQueue=e,this.indexManager=n}var Rh,Mh,Oh=(Gh.prototype.addEntries=function(t,e,n){for(var r=[],i=0,o=e;i<o.length;i++){var a=o[i],s=a.maybeDocument.key;this.docs=this.docs.insert(s,a),this.newDocumentChanges=this.newDocumentChanges.add(s),r.push(this.indexManager.addToCollectionParentIndex(t,s.path.popLast()))}return this.size+=n,gu.waitFor(r)},Gh.prototype.removeEntry=function(t,e){var n=this.docs.get(e);return n?(this.docs=this.docs.remove(e),this.size-=n.size,gu.resolve(n.size)):gu.resolve(0)},Gh.prototype.getEntry=function(t,e){e=this.docs.get(e);return gu.resolve(e?e.maybeDocument:null)},Gh.prototype.getSizedEntry=function(t,e){return gu.resolve(this.docs.get(e))},Gh.prototype.getEntries=function(t,e){var n=this,r=os;return e.forEach(function(t){var e=n.docs.get(t);r=r.insert(t,e?e.maybeDocument:null)}),gu.resolve(r)},Gh.prototype.getSizedEntries=function(t,e){var n=this,r=os,i=new Ri(Di.comparator);return e.forEach(function(t){var e=n.docs.get(t);r=r.insert(t,e?e.maybeDocument:null),i=i.insert(t,e?e.size:0)}),gu.resolve({maybeDocuments:r,sizeMap:i})},Gh.prototype.getDocumentsMatchingQuery=function(t,e){Tr(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");for(var n=as,r=new Di(e.path.child("")),i=this.docs.getIteratorFrom(r);i.hasNext();){var o=i.getNext(),a=o.key,o=o.value.maybeDocument;if(!e.path.isPrefixOf(a.path))break;o instanceof Ni&&e.matches(o)&&(n=n.insert(o.key,o))}return gu.resolve(n)},Gh.prototype.forEachDocumentKey=function(t,e){return gu.forEach(this.docs,function(t){return e(t)})},Gh.prototype.getNewDocumentChanges=function(t){var n=this,r=os;return this.newDocumentChanges.forEach(function(t){var e=n.docs.get(t),e=e?e.maybeDocument:new Ai(t,aa.forDeletedDoc());r=r.insert(t,e)}),this.newDocumentChanges=cs(),gu.resolve(r)},Gh.prototype.newChangeBuffer=function(){return new _h(this.sizer,this)},Gh.prototype.getSize=function(t){return gu.resolve(this.size)},Gh),_h=(a(jh,Mh=t),jh.prototype.applyChanges=function(t){var r=this,e=this.assertChanges(),i=0,o=[];return e.forEach(function(t,e){var n=r.documentSizes.get(t);Tr(void 0!==n,"Attempting to change document "+t.toString()+" without having read it first");t=r.sizer(e);i+=t-n,o.push({maybeDocument:e,size:t})}),this.documentCache.addEntries(t,o,i)},jh.prototype.getFromCache=function(t,e){return this.documentCache.getSizedEntry(t,e)},jh.prototype.getAllFromCache=function(t,e){return this.documentCache.getSizedEntries(t,e)},jh),Ph=(Kh.createLruPersistence=function(t,e,n){return new Kh(t,function(t){return new qh(t,new Wc(e),n)})},Kh.createEagerPersistence=function(t){return new Kh(t,function(t){return new xh(t)})},Kh.prototype.shutdown=function(){return this._started=!1,Promise.resolve()},Object.defineProperty(Kh.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),Kh.prototype.getActiveClients=function(){return c(this,void 0,void 0,function(){return p(this,function(t){return[2,[this.clientId]]})})},Kh.prototype.setPrimaryStateListener=function(t){return t(!0)},Kh.prototype.setDatabaseDeletedListener=function(){},Kh.prototype.setNetworkEnabled=function(t){},Kh.prototype.getIndexManager=function(){return this.indexManager},Kh.prototype.getMutationQueue=function(t){var e=this.mutationQueues[t.toKey()];return e||(e=new Sh(this.indexManager,this.referenceDelegate),this.mutationQueues[t.toKey()]=e),e},Kh.prototype.getQueryCache=function(){return this.queryCache},Kh.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache},Kh.prototype.runTransaction=function(t,e,n){var r=this;br("MemoryPersistence","Starting transaction:",t);var i=new Lh(this.listenSequence.next());return this.referenceDelegate.onTransactionStarted(),n(i).next(function(t){return r.referenceDelegate.onTransactionCommitted(i).next(function(){return t})}).toPromise()},Kh.prototype.mutationQueuesContainKey=function(e,n){return gu.or((t=this.mutationQueues,r=[],Lr(t,function(t,e){return r.push(e)}),r.map(function(t){return function(){return t.containsKey(e,n)}})));var t,r},Kh),Lh=function(t){this.currentSequenceNumber=t},xh=(Qh.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},Qh.prototype.addReference=function(t,e){return this.orphanedDocuments.delete(e),gu.resolve()},Qh.prototype.removeReference=function(t,e){return this.orphanedDocuments.add(e),gu.resolve()},Qh.prototype.removeMutationReference=function(t,e){return this.orphanedDocuments.add(e),gu.resolve()},Qh.prototype.removeTarget=function(t,e){var n=this,r=this.persistence.getQueryCache();return r.getMatchingKeysForTargetId(t,e.targetId).next(function(t){t.forEach(function(t){return n.orphanedDocuments.add(t)})}).next(function(){return r.removeQueryData(t,e)})},Qh.prototype.onTransactionStarted=function(){this.orphanedDocuments=new Set},Qh.prototype.onTransactionCommitted=function(n){var t=this,r=this.persistence.getRemoteDocumentCache();return gu.forEach(this.orphanedDocuments,function(e){return t.isReferenced(n,e).next(function(t){return t?gu.resolve():r.removeEntry(n,e).next(function(){})})})},Qh.prototype.updateLimboDocument=function(t,e){var n=this;return this.isReferenced(t,e).next(function(t){t?n.orphanedDocuments.delete(e):n.orphanedDocuments.add(e)})},Qh.prototype.documentSize=function(t){return 0},Qh.prototype.isReferenced=function(t,e){var n=this;return gu.or([function(){return n.persistence.getQueryCache().containsKey(t,e)},function(){return n.persistence.mutationQueuesContainKey(t,e)},function(){return gu.resolve(n.inMemoryPins.containsKey(e))}])},Qh),qh=(Uh.prototype.onTransactionStarted=function(){},Uh.prototype.onTransactionCommitted=function(t){return gu.resolve()},Uh.prototype.forEachTarget=function(t,e){return this.persistence.getQueryCache().forEachTarget(t,e)},Uh.prototype.getSequenceNumberCount=function(t){var n=this.orphanedDocumentCount(t);return this.persistence.getQueryCache().getTargetCount(t).next(function(e){return n.next(function(t){return e+t})})},Uh.prototype.orphanedDocumentCount=function(t){var e=0;return this.forEachOrphanedDocumentSequenceNumber(t,function(t){e++}).next(function(){return e})},Uh.prototype.forEachOrphanedDocumentSequenceNumber=function(n,r){var i=this;return gu.forEach(this.orphanedSequenceNumbers,function(t,e){return i.isPinned(n,t,e).next(function(t){return t?gu.resolve():r(e)})})},Uh.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},Uh.prototype.removeTargets=function(t,e,n){return this.persistence.getQueryCache().removeTargets(t,e,n)},Uh.prototype.removeOrphanedDocuments=function(n,t){var r=this,i=0,o=this.persistence.getRemoteDocumentCache();return o.forEachDocumentKey(n,function(e){return r.isPinned(n,e,t).next(function(t){return t?gu.resolve():(i++,o.removeEntry(n,e).next())})}).next(function(){return i})},Uh.prototype.removeMutationReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),gu.resolve()},Uh.prototype.removeTarget=function(t,e){e=e.copy({sequenceNumber:t.currentSequenceNumber});return this.persistence.getQueryCache().updateQueryData(t,e)},Uh.prototype.addReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),gu.resolve()},Uh.prototype.removeReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),gu.resolve()},Uh.prototype.updateLimboDocument=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),gu.resolve()},Uh.prototype.documentSize=function(t){var e,t=this.serializer.toDbRemoteDocument(t);if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw Sr("Unknown remote document type");e=t.noDocument}return JSON.stringify(e).length},Uh.prototype.isPinned=function(t,e,n){var r=this;return gu.or([function(){return r.persistence.mutationQueuesContainKey(t,e)},function(){return gu.resolve(r.inMemoryPins.containsKey(e))},function(){return r.persistence.getQueryCache().containsKey(t,e)},function(){var t=r.orphanedSequenceNumbers.get(e);return gu.resolve(void 0!==t&&n<t)}])},Uh.prototype.getCacheSize=function(t){return this.persistence.getRemoteDocumentCache().getSize(t)},Uh),Fh=(Bh.prototype.reset=function(){this.currentBaseMs=0},Bh.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs},Bh.prototype.backoffAndRun=function(t){var e=this;this.cancel();var n=Math.floor(this.currentBaseMs+this.jitterDelayMs()),r=Math.max(0,Date.now()-this.lastAttemptTime),i=Math.max(0,n-r);0<this.currentBaseMs&&br("ExponentialBackoff","Backing off for "+i+" ms (base delay: "+this.currentBaseMs+" ms, delay with jitter: "+n+" ms, last attempt: "+r+" ms ago)"),this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,i,function(){return e.lastAttemptTime=Date.now(),t()}),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<this.initialDelayMs&&(this.currentBaseMs=this.initialDelayMs),this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs)},Bh.prototype.cancel=function(){null!==this.timerPromise&&(this.timerPromise.cancel(),this.timerPromise=null)},Bh.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs},Bh),Vh="PersistentStream";function Bh(t,e,n,r,i){this.queue=t,this.timerId=e,this.initialDelayMs=n,this.backoffFactor=r,this.maxDelayMs=i,this.timerPromise=null,this.lastAttemptTime=Date.now(),this.reset()}function Uh(t,e,n){this.persistence=t,this.serializer=e,this.orphanedSequenceNumbers=new zu(function(t){return lu(t.path)}),this.garbageCollector=new th(this,n)}function Qh(t){this.persistence=t}function Kh(t,e){var n=this;this.clientId=t,this.mutationQueues={},this.listenSequence=new eu(0),this._started=!1,this._started=!0,this.referenceDelegate=e(this),this.queryCache=new Th(this),this.indexManager=new sc,this.remoteDocumentCache=new Oh(this.indexManager,function(t){return n.referenceDelegate.documentSize(t)})}function jh(t,e){var n=Mh.call(this)||this;return n.sizer=t,n.documentCache=e,n}function Gh(t,e){this.indexManager=t,this.sizer=e,this.docs=new Ri(Di.comparator),this.newDocumentChanges=cs(),this.size=0}(Ip=Rh=Rh||{})[Ip.Initial=0]="Initial",Ip[Ip.Starting=1]="Starting",Ip[Ip.Open=2]="Open",Ip[Ip.Error=3]="Error",Ip[Ip.Backoff=4]="Backoff";var Wh,zh,Hh,Yh,s=(il.prototype.isStarted=function(){return this.state===Rh.Starting||this.state===Rh.Open||this.state===Rh.Backoff},il.prototype.isOpen=function(){return this.state===Rh.Open},il.prototype.start=function(){this.state!==Rh.Error?(Tr(this.state===Rh.Initial,"Already started"),this.auth()):this.performBackoff()},il.prototype.stop=function(){return c(this,void 0,void 0,function(){return p(this,function(t){switch(t.label){case 0:return this.isStarted()?[4,this.close(Rh.Initial)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},il.prototype.inhibitBackoff=function(){Tr(!this.isStarted(),"Can only inhibit backoff in a stopped state"),this.state=Rh.Initial,this.backoff.reset()},il.prototype.markIdle=function(){var t=this;this.isOpen()&&null===this.idleTimer&&(this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,6e4,function(){return t.handleIdleCloseTimer()}))},il.prototype.sendRequest=function(t){this.cancelIdleCheck(),this.stream.send(t)},il.prototype.handleIdleCloseTimer=function(){return c(this,void 0,void 0,function(){return p(this,function(t){return this.isOpen()?[2,this.close(Rh.Initial)]:[2]})})},il.prototype.cancelIdleCheck=function(){this.idleTimer&&(this.idleTimer.cancel(),this.idleTimer=null)},il.prototype.close=function(e,n){return c(this,void 0,void 0,function(){return p(this,function(t){switch(t.label){case 0:return Tr(this.isStarted(),"Only started streams should be closed."),Tr(e===Rh.Error||Ko(n),"Can't provide an error when not in an error state."),this.cancelIdleCheck(),this.backoff.cancel(),this.closeCount++,e!==Rh.Error?this.backoff.reset():n&&n.code===Ar.RESOURCE_EXHAUSTED?(wr(n.toString()),wr("Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()):n&&n.code===Ar.UNAUTHENTICATED&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=e,[4,this.listener.onClose(n)];case 1:return t.sent(),[2]}})})},il.prototype.tearDown=function(){},il.prototype.auth=function(){var n=this;Tr(this.state===Rh.Initial,"Must be in initial state to auth"),this.state=Rh.Starting;var t=this.getCloseGuardedDispatcher(this.closeCount),e=this.closeCount;this.credentialsProvider.getToken().then(function(t){n.closeCount===e&&n.startStream(t)},function(e){t(function(){var t=new kr(Ar.UNKNOWN,"Fetching auth token failed: "+e.message);return n.handleStreamClose(t)})})},il.prototype.startStream=function(t){var e=this;Tr(this.state===Rh.Starting,"Trying to start stream in a non-starting state");var n=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(t),this.stream.onOpen(function(){n(function(){return Tr(e.state===Rh.Starting,"Expected stream to be in state Starting, but was "+e.state),e.state=Rh.Open,e.listener.onOpen()})}),this.stream.onClose(function(t){n(function(){return e.handleStreamClose(t)})}),this.stream.onMessage(function(t){n(function(){return e.onMessage(t)})})},il.prototype.performBackoff=function(){var t=this;Tr(this.state===Rh.Error,"Should only perform backoff when in Error state"),this.state=Rh.Backoff,this.backoff.backoffAndRun(function(){return c(t,void 0,void 0,function(){return p(this,function(t){return Tr(this.state===Rh.Backoff,"Backoff elapsed but state is now: "+this.state),this.state=Rh.Initial,this.start(),Tr(this.isStarted(),"PersistentStream should have started"),[2]})})})},il.prototype.handleStreamClose=function(t){return Tr(this.isStarted(),"Can't handle server close on non-started stream"),br(Vh,"close with error: "+t),this.stream=null,this.close(Rh.Error,t)},il.prototype.getCloseGuardedDispatcher=function(e){var n=this;return function(t){n.queue.enqueueAndForget(function(){return n.closeCount===e?t():(br(Vh,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())})}},il),Xh=(a(rl,Yh=s),rl.prototype.startRpc=function(t){return this.connection.openStream("Listen",t)},rl.prototype.onMessage=function(t){this.backoff.reset();var e=this.serializer.fromWatchChange(t),t=this.serializer.versionFromListenResponse(t);return this.listener.onWatchChange(e,t)},rl.prototype.watch=function(t){var e={};e.database=this.serializer.encodedDatabaseId,e.addTarget=this.serializer.toTarget(t);t=this.serializer.toListenRequestLabels(t);t&&(e.labels=t),this.sendRequest(e)},rl.prototype.unwatch=function(t){var e={};e.database=this.serializer.encodedDatabaseId,e.removeTarget=t,this.sendRequest(e)},rl),Jh=(a(nl,Hh=s),Object.defineProperty(nl.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:!0,configurable:!0}),nl.prototype.start=function(){this.handshakeComplete_=!1,Hh.prototype.start.call(this)},nl.prototype.tearDown=function(){this.handshakeComplete_&&this.writeMutations([])},nl.prototype.startRpc=function(t){return this.connection.openStream("Write",t)},nl.prototype.onMessage=function(t){if(Tr(!!t.streamToken,"Got a write response without a stream token"),this.lastStreamToken=t.streamToken,this.handshakeComplete_){this.backoff.reset();var e=this.serializer.fromWriteResults(t.writeResults,t.commitTime),n=this.serializer.fromVersion(t.commitTime);return this.listener.onMutationResult(n,e)}return Tr(!t.writeResults||0===t.writeResults.length,"Got mutation results for handshake"),this.handshakeComplete_=!0,this.listener.onHandshakeComplete()},nl.prototype.writeHandshake=function(){Tr(this.isOpen(),"Writing handshake requires an opened stream"),Tr(!this.handshakeComplete_,"Handshake already completed");var t={};t.database=this.serializer.encodedDatabaseId,this.sendRequest(t)},nl.prototype.writeMutations=function(t){var e=this;Tr(this.isOpen(),"Writing mutations requires an opened stream"),Tr(this.handshakeComplete_,"Handshake must be complete before writing mutations"),Tr(0<this.lastStreamToken.length,"Trying to write mutation without a token");t={streamToken:this.lastStreamToken,writes:t.map(function(t){return e.serializer.toMutation(t)})};this.sendRequest(t)},nl),$h=(el.prototype.newPersistentWriteStream=function(t){return new Jh(this.queue,this.connection,this.credentials,this.serializer,t)},el.prototype.newPersistentWatchStream=function(t){return new Xh(this.queue,this.connection,this.credentials,this.serializer,t)},el.prototype.commit=function(t){var e=this,t={database:this.serializer.encodedDatabaseId,writes:t.map(function(t){return e.serializer.toMutation(t)})};return this.invokeRPC("Commit",t).then(function(t){return e.serializer.fromWriteResults(t.writeResults,t.commitTime)})},el.prototype.lookup=function(e){var i=this,t={database:this.serializer.encodedDatabaseId,documents:e.map(function(t){return i.serializer.toName(t)})};return this.invokeStreamingRPC("BatchGetDocuments",t).then(function(t){var n=os;t.forEach(function(t){t=i.serializer.fromMaybeDocument(t);n=n.insert(t.key,t)});var r=[];return e.forEach(function(t){var e=n.get(t);Tr(!!e,"Missing entity in write response for "+t),r.push(e)}),r})},el.prototype.invokeRPC=function(e,n){var r=this;return this.credentials.getToken().then(function(t){return r.connection.invokeRPC(e,n,t)}).catch(function(t){throw t.code===Ar.UNAUTHENTICATED&&r.credentials.invalidateToken(),t})},el.prototype.invokeStreamingRPC=function(e,n){var r=this;return this.credentials.getToken().then(function(t){return r.connection.invokeStreamingRPC(e,n,t)}).catch(function(t){throw t.code===Ar.UNAUTHENTICATED&&r.credentials.invalidateToken(),t})},el),Zh=(tl.prototype.recordVersion=function(t){var e;if(t instanceof Ni)e=t.version;else{if(!(t instanceof Ai))throw Sr("Document in a transaction was a "+t.constructor.name);e=aa.forDeletedDoc()}var n=this.readVersions.get(t.key);if(null!==n){if(!e.isEqual(n))throw new kr(Ar.ABORTED,"Document version changed between two reads.")}else this.readVersions=this.readVersions.insert(t.key,e)},tl.prototype.lookup=function(t){var e=this;return this.committed?Promise.reject("Transaction has already completed."):0<this.mutations.length?Promise.reject("Transactions lookups are invalid after writes."):this.datastore.lookup(t).then(function(t){return t.forEach(function(t){t instanceof Ai||t instanceof Ni?e.recordVersion(t):Sr("Document in a transaction was a "+t.constructor.name)}),t})},tl.prototype.write=function(t){if(this.committed)throw new kr(Ar.FAILED_PRECONDITION,"Transaction has already completed.");this.mutations=this.mutations.concat(t)},tl.prototype.precondition=function(t){t=this.readVersions.get(t);return t?_a.updateTime(t):_a.NONE},tl.prototype.preconditionForUpdate=function(t){t=this.readVersions.get(t);if(t&&t.isEqual(aa.forDeletedDoc()))throw new kr(Ar.FAILED_PRECONDITION,"Can't update a document that doesn't exist.");return t?_a.updateTime(t):_a.exists(!0)},tl.prototype.set=function(t,e){this.write(e.toMutations(t,this.precondition(t)))},tl.prototype.update=function(t,e){this.write(e.toMutations(t,this.preconditionForUpdate(t)))},tl.prototype.delete=function(t){this.write([new Fa(t,this.precondition(t))]),this.readVersions=this.readVersions.insert(t,aa.forDeletedDoc())},tl.prototype.commit=function(){var t=this,e=this.readVersions;return this.mutations.forEach(function(t){e=e.remove(t.key)}),e.isEmpty()?this.datastore.commit(this.mutations).then(function(){t.committed=!0}):Promise.reject(Error("Every document read in a transaction must also be written."))},tl);function tl(t){this.datastore=t,this.readVersions=ss,this.mutations=[],this.committed=!1}function el(t,e,n,r){this.queue=t,this.connection=e,this.credentials=n,this.serializer=r}function nl(t,e,n,r,i){i=Hh.call(this,t,tu.WriteStreamConnectionBackoff,tu.WriteStreamIdle,e,n,i)||this;return i.serializer=r,i.handshakeComplete_=!1,i}function rl(t,e,n,r,i){i=Yh.call(this,t,tu.ListenStreamConnectionBackoff,tu.ListenStreamIdle,e,n,i)||this;return i.serializer=r,i}function il(t,e,n,r,i,o){this.queue=t,this.idleTimerId=n,this.connection=r,this.credentialsProvider=i,this.listener=o,this.state=Rh.Initial,this.closeCount=0,this.idleTimer=null,this.stream=null,this.backoff=new Fh(t,e,1e3,1.5,6e4)}(et=Wh=Wh||{})[et.Unknown=0]="Unknown",et[et.Online=1]="Online",et[et.Offline=2]="Offline",(_i=zh=zh||{})[_i.RemoteStore=0]="RemoteStore",_i[_i.SharedClientState=1]="SharedClientState";function ol(){this.listeners=[]}function al(t){this.key=t}function sl(t){this.key=t}var ul=(wl.prototype.handleWatchStreamStart=function(){var t=this;0===this.watchStreamFailures&&(this.setAndBroadcast(Wh.Unknown),Tr(null===this.onlineStateTimer,"onlineStateTimer shouldn't be started yet"),this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay(tu.OnlineStateTimeout,1e4,function(){return t.onlineStateTimer=null,Tr(t.state===Wh.Unknown,"Timer should be canceled if we transitioned to a different state."),t.logClientOfflineWarningIfNecessary("Backend didn't respond within 10 seconds."),t.setAndBroadcast(Wh.Offline),Promise.resolve()}))},wl.prototype.handleWatchStreamFailure=function(t){this.state===Wh.Online?(this.setAndBroadcast(Wh.Unknown),Tr(0===this.watchStreamFailures,"watchStreamFailures must be 0"),Tr(null===this.onlineStateTimer,"onlineStateTimer must be null")):(this.watchStreamFailures++,1<=this.watchStreamFailures&&(this.clearOnlineStateTimer(),this.logClientOfflineWarningIfNecessary("Connection failed 1 times. Most recent error: "+t.toString()),this.setAndBroadcast(Wh.Offline)))},wl.prototype.set=function(t){this.clearOnlineStateTimer(),this.watchStreamFailures=0,t===Wh.Online&&(this.shouldWarnClientIsOffline=!1),this.setAndBroadcast(t)},wl.prototype.setAndBroadcast=function(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))},wl.prototype.logClientOfflineWarningIfNecessary=function(t){t="Could not reach Cloud Firestore backend. "+t+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.shouldWarnClientIsOffline?(wr(t),this.shouldWarnClientIsOffline=!1):br("OnlineStateTracker",t)},wl.prototype.clearOnlineStateTimer=function(){null!==this.onlineStateTimer&&(this.onlineStateTimer.cancel(),this.onlineStateTimer=null)},wl),cl="RemoteStore",hl=(bl.prototype.start=function(){return this.enableNetwork()},bl.prototype.enableNetwork=function(){return c(this,void 0,void 0,function(){var e;return p(this,function(t){switch(t.label){case 0:return this.networkEnabled=!0,this.canUseNetwork()?(e=this.writeStream,[4,this.localStore.getLastStreamToken()]):[3,3];case 1:return e.lastStreamToken=t.sent(),this.shouldStartWatchStream()?this.startWatchStream():this.onlineStateTracker.set(Wh.Unknown),[4,this.fillWritePipeline()];case 2:t.sent(),t.label=3;case 3:return[2]}})})},bl.prototype.disableNetwork=function(){return c(this,void 0,void 0,function(){return p(this,function(t){switch(t.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(Wh.Offline),[2]}})})},bl.prototype.disableNetworkInternal=function(){return c(this,void 0,void 0,function(){return p(this,function(t){switch(t.label){case 0:return[4,this.writeStream.stop()];case 1:return t.sent(),[4,this.watchStream.stop()];case 2:return t.sent(),0<this.writePipeline.length&&(br(cl,"Stopping write stream with "+this.writePipeline.length+" pending writes"),this.writePipeline=[]),this.cleanUpWatchStreamState(),[2]}})})},bl.prototype.shutdown=function(){return c(this,void 0,void 0,function(){return p(this,function(t){switch(t.label){case 0:return br(cl,"RemoteStore shutting down."),this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.connectivityMonitor.shutdown(),this.onlineStateTracker.set(Wh.Unknown),[2]}})})},bl.prototype.listen=function(t){Tr(!Or(this.listenTargets,t.targetId),"listen called with duplicate targetId!"),this.listenTargets[t.targetId]=t,this.shouldStartWatchStream()?this.startWatchStream():this.watchStream.isOpen()&&this.sendWatchRequest(t)},bl.prototype.unlisten=function(t){Tr(Or(this.listenTargets,t),"unlisten called without assigned target ID!"),delete this.listenTargets[t],this.watchStream.isOpen()&&this.sendUnwatchRequest(t),xr(this.listenTargets)&&(this.watchStream.isOpen()?this.watchStream.markIdle():this.canUseNetwork()&&this.onlineStateTracker.set(Wh.Unknown))},bl.prototype.getQueryDataForTarget=function(t){return this.listenTargets[t]||null},bl.prototype.getRemoteKeysForTarget=function(t){return this.syncEngine.getRemoteKeysForTarget(t)},bl.prototype.sendWatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t.targetId),this.watchStream.watch(t)},bl.prototype.sendUnwatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t),this.watchStream.unwatch(t)},bl.prototype.startWatchStream=function(){Tr(this.shouldStartWatchStream(),"startWatchStream() called when shouldStartWatchStream() is false."),this.watchChangeAggregator=new As(this),this.watchStream.start(),this.onlineStateTracker.handleWatchStreamStart()},bl.prototype.shouldStartWatchStream=function(){return this.canUseNetwork()&&!this.watchStream.isStarted()&&!xr(this.listenTargets)},bl.prototype.canUseNetwork=function(){return this.isPrimary&&this.networkEnabled},bl.prototype.cleanUpWatchStreamState=function(){this.watchChangeAggregator=null},bl.prototype.onWatchStreamOpen=function(){return c(this,void 0,void 0,function(){var n=this;return p(this,function(t){return Pr(this.listenTargets,function(t,e){n.sendWatchRequest(e)}),[2]})})},bl.prototype.onWatchStreamClose=function(e){return c(this,void 0,void 0,function(){return p(this,function(t){return void 0===e&&Tr(!this.shouldStartWatchStream(),"Watch stream was stopped gracefully while still needed."),this.cleanUpWatchStreamState(),this.shouldStartWatchStream()?(this.onlineStateTracker.handleWatchStreamFailure(e),this.startWatchStream()):this.onlineStateTracker.set(Wh.Unknown),[2]})})},bl.prototype.onWatchStreamChange=function(n,r){return c(this,void 0,void 0,function(){var e;return p(this,function(t){switch(t.label){case 0:return this.onlineStateTracker.set(Wh.Online),n instanceof Ds&&n.state===gs.Removed&&n.cause?[2,this.handleTargetError(n)]:(n instanceof ms?this.watchChangeAggregator.handleDocumentChange(n):n instanceof ys?this.watchChangeAggregator.handleExistenceFilter(n):(Tr(n instanceof Ds,"Expected watchChange to be an instance of WatchTargetChange"),this.watchChangeAggregator.handleTargetChange(n)),r.isEqual(aa.MIN)?[3,3]:[4,this.localStore.getLastRemoteSnapshotVersion()]);case 1:return e=t.sent(),0<=r.compareTo(e)?[4,this.raiseWatchSnapshot(r)]:[3,3];case 2:t.sent(),t.label=3;case 3:return[2]}})})},bl.prototype.raiseWatchSnapshot=function(r){var i=this;Tr(!r.isEqual(aa.MIN),"Can't raise event for unknown SnapshotVersion");var t=this.watchChangeAggregator.createRemoteEvent(r);return Pr(t.targetChanges,function(t,e){var n;0<e.resumeToken.length&&((n=i.listenTargets[t])&&(i.listenTargets[t]=n.copy({resumeToken:e.resumeToken,snapshotVersion:r})))}),t.targetMismatches.forEach(function(t){var e=i.listenTargets[t];e&&(i.listenTargets[t]=e.copy({resumeToken:Dr()}),i.sendUnwatchRequest(t),e=new ba(e.query,t,Go.ExistenceFilterMismatch,e.sequenceNumber),i.sendWatchRequest(e))}),this.syncEngine.applyRemoteEvent(t)},bl.prototype.handleTargetError=function(t){var n=this;Tr(!!t.cause,"Handling target error without a cause");var r=t.cause,i=Promise.resolve();return t.targetIds.forEach(function(e){i=i.then(function(){return c(n,void 0,void 0,function(){return p(this,function(t){return Or(this.listenTargets,e)?(delete this.listenTargets[e],this.watchChangeAggregator.removeTarget(e),[2,this.syncEngine.rejectListen(e,r)]):[2]})})})}),i},bl.prototype.fillWritePipeline=function(){return c(this,void 0,void 0,function(){var e,n;return p(this,function(t){switch(t.label){case 0:return this.canAddToWritePipeline()?(e=0<this.writePipeline.length?this.writePipeline[this.writePipeline.length-1].batchId:-1,[4,this.localStore.nextMutationBatch(e)]):[3,4];case 1:return null!==(n=t.sent())?[3,2]:(0===this.writePipeline.length&&this.writeStream.markIdle(),[3,4]);case 2:return this.addToWritePipeline(n),[4,this.fillWritePipeline()];case 3:t.sent(),t.label=4;case 4:return this.shouldStartWriteStream()&&this.startWriteStream(),[2]}})})},bl.prototype.canAddToWritePipeline=function(){return this.canUseNetwork()&&this.writePipeline.length<10},bl.prototype.outstandingWrites=function(){return this.writePipeline.length},bl.prototype.addToWritePipeline=function(t){Tr(this.canAddToWritePipeline(),"addToWritePipeline called when pipeline is full"),this.writePipeline.push(t),this.writeStream.isOpen()&&this.writeStream.handshakeComplete&&this.writeStream.writeMutations(t.mutations)},bl.prototype.shouldStartWriteStream=function(){return this.canUseNetwork()&&!this.writeStream.isStarted()&&0<this.writePipeline.length},bl.prototype.startWriteStream=function(){Tr(this.shouldStartWriteStream(),"startWriteStream() called when shouldStartWriteStream() is false."),this.writeStream.start()},bl.prototype.onWriteStreamOpen=function(){return c(this,void 0,void 0,function(){return p(this,function(t){return this.writeStream.writeHandshake(),[2]})})},bl.prototype.onWriteHandshakeComplete=function(){var r=this;return this.localStore.setLastStreamToken(this.writeStream.lastStreamToken).then(function(){for(var t=0,e=r.writePipeline;t<e.length;t++){var n=e[t];r.writeStream.writeMutations(n.mutations)}}).catch(fh)},bl.prototype.onMutationResult=function(t,e){var n=this;Tr(0<this.writePipeline.length,"Got result for empty write pipeline");var r=this.writePipeline.shift(),e=yu.from(r,t,e,this.writeStream.lastStreamToken);return this.syncEngine.applySuccessfulWrite(e).then(function(){return n.fillWritePipeline()})},bl.prototype.onWriteStreamClose=function(n){return c(this,void 0,void 0,function(){var e=this;return p(this,function(t){return void 0===n&&Tr(!this.shouldStartWriteStream(),"Write stream was stopped gracefully while still needed."),n&&0<this.writePipeline.length?[2,(this.writeStream.handshakeComplete?this.handleWriteError(n):this.handleHandshakeError(n)).then(function(){e.shouldStartWriteStream()&&e.startWriteStream()})]:[2]})})},bl.prototype.handleHandshakeError=function(e){return c(this,void 0,void 0,function(){return p(this,function(t){return rs(e.code)?(br(cl,"RemoteStore error before completed handshake; resetting stream token: ",this.writeStream.lastStreamToken),this.writeStream.lastStreamToken=Dr(),[2,this.localStore.setLastStreamToken(Dr()).catch(fh)]):[2]})})},bl.prototype.handleWriteError=function(i){return c(this,void 0,void 0,function(){var n,r=this;return p(this,function(t){return rs(e=i.code)&&e!==Ar.ABORTED?(n=this.writePipeline.shift(),this.writeStream.inhibitBackoff(),[2,this.syncEngine.rejectFailedWrite(n.batchId,i).then(function(){return r.fillWritePipeline()})]):[2];var e})})},bl.prototype.createTransaction=function(){return new Zh(this.datastore)},bl.prototype.restartNetwork=function(){return c(this,void 0,void 0,function(){return p(this,function(t){switch(t.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(Wh.Unknown),[4,this.enableNetwork()];case 2:return t.sent(),[2]}})})},bl.prototype.handleCredentialChange=function(){return c(this,void 0,void 0,function(){return p(this,function(t){switch(t.label){case 0:return this.canUseNetwork()?(br(cl,"RemoteStore restarting streams for new credential"),[4,this.restartNetwork()]):[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},bl.prototype.applyPrimaryState=function(e){return c(this,void 0,void 0,function(){return p(this,function(t){switch(t.label){case 0:return(this.isPrimary=e)&&this.networkEnabled?[4,this.enableNetwork()]:[3,2];case 1:return t.sent(),[3,4];case 2:return e?[3,4]:[4,this.disableNetworkInternal()];case 3:t.sent(),this.onlineStateTracker.set(Wh.Unknown),t.label=4;case 4:return[2]}})})},bl),ll=(vl.prototype.listen=function(t){var e=t.query,n=!1,r=this.queries.get(e);return r||(n=!0,r=new ol,this.queries.set(e,r)),r.listeners.push(t),t.applyOnlineStateChange(this.onlineState),r.viewSnap&&t.onViewSnapshot(r.viewSnap),n?this.syncEngine.listen(e).then(function(t){return r.targetId=t}):Promise.resolve(r.targetId)},vl.prototype.unlisten=function(o){return c(this,void 0,void 0,function(){var e,n,r,i;return p(this,function(t){return e=o.query,n=!1,(r=this.queries.get(e))&&0<=(i=r.listeners.indexOf(o))&&(r.listeners.splice(i,1),n=0===r.listeners.length),n?(this.queries.delete(e),[2,this.syncEngine.unlisten(e)]):[2]})})},vl.prototype.onWatchChange=function(t){for(var e=0,n=t;e<n.length;e++){var r=n[e],i=r.query,i=this.queries.get(i);if(i){for(var o=0,a=i.listeners;o<a.length;o++)a[o].onViewSnapshot(r);i.viewSnap=r}}},vl.prototype.onWatchError=function(t,e){var n=this.queries.get(t);if(n)for(var r=0,i=n.listeners;r<i.length;r++)i[r].onError(e);this.queries.delete(t)},vl.prototype.onOnlineStateChange=function(i){this.onlineState=i,this.queries.forEach(function(t,e){for(var n=0,r=e.listeners;n<r.length;n++)r[n].applyOnlineStateChange(i)})},vl),fl=(gl.prototype.onViewSnapshot=function(t){if(Tr(0<t.docChanges.length||t.syncStateChanged,"We got a new snapshot with no changes?"),!this.options.includeMetadataChanges){for(var e=[],n=0,r=t.docChanges;n<r.length;n++){var i=r[n];i.type!==ls.Metadata&&e.push(i)}t=new bs(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}this.raisedInitialEvent?this.shouldRaiseEvent(t)&&this.queryObserver.next(t):this.shouldRaiseInitialEvent(t,this.onlineState)&&this.raiseInitialEvent(t),this.snap=t},gl.prototype.onError=function(t){this.queryObserver.error(t)},gl.prototype.applyOnlineStateChange=function(t){this.onlineState=t,this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,t)&&this.raiseInitialEvent(this.snap)},gl.prototype.shouldRaiseInitialEvent=function(t,e){if(Tr(!this.raisedInitialEvent,"Determining whether to raise first event but already had first event"),!t.fromCache)return!0;var n=e!==Wh.Offline;return this.options.waitForSyncWhenOnline&&n?(Tr(t.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!t.docs.isEmpty()||e===Wh.Offline},gl.prototype.shouldRaiseEvent=function(t){if(0<t.docChanges.length)return!0;var e=this.snap&&this.snap.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges},gl.prototype.raiseInitialEvent=function(t){Tr(!this.raisedInitialEvent,"Trying to raise initial events for second time"),t=bs.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.raisedInitialEvent=!0,this.queryObserver.next(t)},gl),pl=(yl.fromSnapshot=function(t,e){for(var n=cs(),r=cs(),i=0,o=e.docChanges;i<o.length;i++){var a=o[i];switch(a.type){case ls.Added:n=n.add(a.doc.key);break;case ls.Removed:r=r.add(a.doc.key)}}return new yl(t,n,r)},yl),dl=(Object.defineProperty(ml.prototype,"syncedDocuments",{get:function(){return this._syncedDocuments},enumerable:!0,configurable:!0}),ml.prototype.computeDocChanges=function(t,e){var a=this,s=e?e.changeSet:new vs,u=(e||this).documentSet,c=(e||this).mutatedKeys,h=u,l=!1,f=this.query.hasLimit()&&u.size===this.query.limit?u.last():null;if(t.inorderTraversal(function(t,e){var n=u.get(t),r=e instanceof Ni?e:null;r&&(Tr(t.isEqual(r.key),"Mismatching keys found in document changes: "+t+" != "+r.key),r=a.query.matches(r)?r:null);var i=!!n&&a.mutatedKeys.has(n.key),o=!!r&&(r.hasLocalMutations||a.mutatedKeys.has(r.key)&&r.hasCommittedMutations),e=!1;n&&r?n.data.isEqual(r.data)?i!==o&&(s.track({type:ls.Metadata,doc:r}),e=!0):a.shouldWaitForSyncedDocument(n,r)||(s.track({type:ls.Modified,doc:r}),e=!0,f&&0<a.query.docComparator(r,f)&&(l=!0)):!n&&r?(s.track({type:ls.Added,doc:r}),e=!0):n&&!r&&(s.track({type:ls.Removed,doc:n}),e=!0,f&&(l=!0)),e&&(c=r?(h=h.add(r),o?c.add(t):c.delete(t)):(h=h.delete(t),c.delete(t)))}),this.query.hasLimit())for(;h.size>this.query.limit;){var n=h.last(),h=h.delete(n.key),c=c.delete(n.key);s.track({type:ls.Removed,doc:n})}return Tr(!l||!e,"View was refilled using docs that themselves needed refilling."),{documentSet:h,changeSet:s,needsRefill:l,mutatedKeys:c}},ml.prototype.shouldWaitForSyncedDocument=function(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations},ml.prototype.applyChanges=function(t,e,n){var o=this;Tr(!t.needsRefill,"Cannot apply changes that need a refill");var r=this.documentSet;this.documentSet=t.documentSet,this.mutatedKeys=t.mutatedKeys;var i=t.changeSet.getChanges();i.sort(function(t,e){return n=t.type,r=e.type,(i=function(t){switch(t){case ls.Added:return 1;case ls.Modified:case ls.Metadata:return 2;case ls.Removed:return 0;default:return Sr("Unknown ChangeType: "+t)}})(n)-i(r)||o.query.docComparator(t.doc,e.doc);var n,r,i}),this.applyTargetChange(n);var a=e?this.updateLimboDocuments():[],n=0===this.limboDocuments.size&&this.current?fs.Synced:fs.Local,e=n!==this.syncState;return this.syncState=n,0!==i.length||e?{snapshot:new bs(this.query,t.documentSet,r,i,t.mutatedKeys,n===fs.Local,e,!1),limboChanges:a}:{limboChanges:a}},ml.prototype.applyOnlineStateChange=function(t){return this.current&&t===Wh.Offline?(this.current=!1,this.applyChanges({documentSet:this.documentSet,changeSet:new vs,mutatedKeys:this.mutatedKeys,needsRefill:!1},!1)):{limboChanges:[]}},ml.prototype.shouldBeInLimbo=function(t){return!this._syncedDocuments.has(t)&&!!this.documentSet.has(t)&&!this.documentSet.get(t).hasLocalMutations},ml.prototype.applyTargetChange=function(t){var e=this;t&&(t.addedDocuments.forEach(function(t){return e._syncedDocuments=e._syncedDocuments.add(t)}),t.modifiedDocuments.forEach(function(t){return Tr(e._syncedDocuments.has(t),"Modified document "+t+" not found in view.")}),t.removedDocuments.forEach(function(t){return e._syncedDocuments=e._syncedDocuments.delete(t)}),this.current=t.current)},ml.prototype.updateLimboDocuments=function(){var e=this;if(!this.current)return[];var n=this.limboDocuments;this.limboDocuments=cs(),this.documentSet.forEach(function(t){e.shouldBeInLimbo(t.key)&&(e.limboDocuments=e.limboDocuments.add(t.key))});var r=[];return n.forEach(function(t){e.limboDocuments.has(t)||r.push(new sl(t))}),this.limboDocuments.forEach(function(t){n.has(t)||r.push(new al(t))}),r},ml.prototype.synchronizeWithPersistedState=function(t,e){this._syncedDocuments=e,this.limboDocuments=cs();t=this.computeDocChanges(t);return this.applyChanges(t,!0)},ml.prototype.computeInitialSnapshot=function(){return bs.fromInitialDocuments(this.query,this.documentSet,this.mutatedKeys,this.syncState===fs.Local)},ml);function ml(t,e){this.query=t,this._syncedDocuments=e,this.syncState=null,this.current=!1,this.limboDocuments=cs(),this.mutatedKeys=cs(),this.documentSet=new ps(t.docComparator.bind(t))}function yl(t,e,n){this.targetId=t,this.addedKeys=e,this.removedKeys=n}function gl(t,e,n){this.query=t,this.queryObserver=e,this.raisedInitialEvent=!1,this.onlineState=Wh.Unknown,this.options=n||{}}function vl(t){this.syncEngine=t,this.queries=new zu(function(t){return t.canonicalId()}),this.onlineState=Wh.Unknown,this.syncEngine.subscribe(this)}function bl(t,e,n,r,i){var o=this;this.localStore=t,this.datastore=e,this.writePipeline=[],this.listenTargets={},this.watchChangeAggregator=null,this.networkEnabled=!1,this.isPrimary=!1,this.connectivityMonitor=i,this.connectivityMonitor.addCallback(function(t){n.enqueueAndForget(function(){return c(o,void 0,void 0,function(){return p(this,function(t){switch(t.label){case 0:return this.canUseNetwork()?(br(cl,"Restarting streams for network reachability change."),[4,this.restartNetwork()]):[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})})}),this.onlineStateTracker=new ul(n,r),this.watchStream=this.datastore.newPersistentWatchStream({onOpen:this.onWatchStreamOpen.bind(this),onClose:this.onWatchStreamClose.bind(this),onWatchChange:this.onWatchStreamChange.bind(this)}),this.writeStream=this.datastore.newPersistentWriteStream({onOpen:this.onWriteStreamOpen.bind(this),onClose:this.onWriteStreamClose.bind(this),onHandshakeComplete:this.onWriteHandshakeComplete.bind(this),onMutationResult:this.onMutationResult.bind(this)})}function wl(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state=Wh.Unknown,this.watchStreamFailures=0,this.onlineStateTimer=null,this.shouldWarnClientIsOffline=!0}function El(t,e,n){this.query=t,this.targetId=e,this.view=n}function Sl(t){this.key=t}var Tl="SyncEngine",Il=(Object.defineProperty(Kl.prototype,"isPrimaryClient",{get:function(){return!0===this.isPrimary},enumerable:!0,configurable:!0}),Kl.prototype.subscribe=function(t){Tr(null!==t,"SyncEngine listener cannot be null"),Tr(null===this.syncEngineListener,"SyncEngine already has a subscriber."),this.syncEngineListener=t},Kl.prototype.listen=function(o){return c(this,void 0,void 0,function(){var e,n,r,i;return p(this,function(t){switch(t.label){case 0:return this.assertSubscribed("listen()"),(i=this.queryViewsByQuery.get(o))?(e=i.targetId,this.sharedClientState.addLocalQueryTarget(e),n=i.view.computeInitialSnapshot(),[3,4]):[3,1];case 1:return[4,this.localStore.allocateQuery(o)];case 2:return r=t.sent(),i=this.sharedClientState.addLocalQueryTarget(r.targetId),e=r.targetId,[4,this.initializeViewAndComputeSnapshot(r,"current"===i)];case 3:n=t.sent(),this.isPrimary&&this.remoteStore.listen(r),t.label=4;case 4:return this.syncEngineListener.onWatchChange([n]),[2,e]}})})},Kl.prototype.initializeViewAndComputeSnapshot=function(i,o){var a=this,s=i.query;return this.localStore.executeQuery(s).then(function(r){return a.localStore.remoteDocumentKeys(i.targetId).then(function(t){var e=new dl(s,t),n=e.computeDocChanges(r),t=Es.createSynthesizedTargetChangeForCurrentChange(i.targetId,o&&a.onlineState!==Wh.Offline),t=e.applyChanges(n,!0===a.isPrimary,t);Tr(0===t.limboChanges.length,"View returned limbo docs before target ack from the server."),Tr(!!t.snapshot,"applyChanges for new view should always return a snapshot");e=new El(s,i.targetId,e);return a.queryViewsByQuery.set(s,e),a.queryViewsByTarget[i.targetId]=e,t.snapshot})})},Kl.prototype.synchronizeViewAndComputeSnapshot=function(i){var t=this;return this.localStore.executeQuery(i.query).then(function(r){return t.localStore.remoteDocumentKeys(i.targetId).then(function(n){return c(t,void 0,void 0,function(){var e;return p(this,function(t){return e=i.view.synchronizeWithPersistedState(r,n),this.isPrimary&&this.updateTrackedLimbos(i.targetId,e.limboChanges),[2,e]})})})})},Kl.prototype.unlisten=function(r){return c(this,void 0,void 0,function(){var e,n=this;return p(this,function(t){switch(t.label){case 0:return this.assertSubscribed("unlisten()"),Tr(!!(e=this.queryViewsByQuery.get(r)),"Trying to unlisten on query not found:"+r),this.isPrimary?(this.sharedClientState.removeLocalQueryTarget(e.targetId),this.sharedClientState.isActiveQueryTarget(e.targetId)?[3,2]:[4,this.localStore.releaseQuery(r,!1).then(function(){n.sharedClientState.clearQueryState(e.targetId),n.remoteStore.unlisten(e.targetId),n.removeAndCleanupQuery(e)}).catch(fh)]):[3,3];case 1:t.sent(),t.label=2;case 2:return[3,5];case 3:return this.removeAndCleanupQuery(e),[4,this.localStore.releaseQuery(r,!0)];case 4:t.sent(),t.label=5;case 5:return[2]}})})},Kl.prototype.write=function(t,e){var n=this;return this.assertSubscribed("write()"),this.localStore.localWrite(t).then(function(t){return n.sharedClientState.addPendingMutation(t.batchId),n.addMutationCallback(t.batchId,e),n.emitNewSnapsAndNotifyLocalStore(t.changes)}).then(function(){return n.remoteStore.fillWritePipeline()})},Kl.prototype.wrapUpdateFunctionError=function(t){return t},Kl.prototype.runTransaction=function(e,n){var r=this;Tr(0<=(n=void 0===n?5:n),"Got negative number of retries for transaction.");var i=this.remoteStore.createTransaction();return function(){try{var t=e(i);return!Ko(t)&&t.catch&&t.then?t.catch(function(t){return Promise.reject(r.wrapUpdateFunctionError(t))}):Promise.reject(Error("Transaction callback must return a Promise"))}catch(t){return Promise.reject(r.wrapUpdateFunctionError(t))}}().then(function(t){return i.commit().then(function(){return t}).catch(function(t){return 0===n?Promise.reject(t):r.runTransaction(e,n-1)})})},Kl.prototype.applyRemoteEvent=function(e){var n=this;return this.assertSubscribed("applyRemoteEvent()"),this.localStore.applyRemoteEvent(e).then(function(t){return Lr(e.targetChanges,function(t,e){t=n.limboResolutionsByTarget[t];t&&(Tr(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1,"Limbo resolution for single document contains multiple changes."),0<e.addedDocuments.size?t.receivedDocument=!0:0<e.modifiedDocuments.size?Tr(t.receivedDocument,"Received change for limbo target document without add."):0<e.removedDocuments.size&&(Tr(t.receivedDocument,"Received remove for limbo target document without add."),t.receivedDocument=!1))}),n.emitNewSnapsAndNotifyLocalStore(t,e)}).catch(fh)},Kl.prototype.applyOnlineStateChange=function(n,t){var r;(this.isPrimary&&t===zh.RemoteStore||!this.isPrimary&&t===zh.SharedClientState)&&(r=[],this.queryViewsByQuery.forEach(function(t,e){e=e.view.applyOnlineStateChange(n);Tr(0===e.limboChanges.length,"OnlineState should not affect limbo documents."),e.snapshot&&r.push(e.snapshot)}),this.syncEngineListener.onOnlineStateChange(n),this.syncEngineListener.onWatchChange(r),this.onlineState=n,this.isPrimary&&this.sharedClientState.setOnlineState(n))},Kl.prototype.rejectListen=function(o,a){return c(this,void 0,void 0,function(){var e,n,r,i=this;return p(this,function(t){switch(t.label){case 0:return this.assertSubscribed("rejectListens()"),this.sharedClientState.updateQueryState(o,"rejected",a),e=this.limboResolutionsByTarget[o],(n=e&&e.key)?(this.limboTargetsByKey=this.limboTargetsByKey.remove(n),delete this.limboResolutionsByTarget[o],e=(e=new Ri(Di.comparator)).insert(n,new Ai(n,aa.forDeletedDoc())),n=cs().add(n),n=new ws(aa.MIN,{},new wa(ri),e,n),[2,this.applyRemoteEvent(n)]):[3,1];case 1:return Tr(!!(r=this.queryViewsByTarget[o]),"Unknown targetId: "+o),[4,this.localStore.releaseQuery(r.query,!1).then(function(){return i.removeAndCleanupQuery(r)}).catch(fh)];case 2:t.sent(),this.syncEngineListener.onWatchError(r.query,a),t.label=3;case 3:return[2]}})})},Kl.prototype.applyBatchState=function(n,r,i){return c(this,void 0,void 0,function(){var e;return p(this,function(t){switch(t.label){case 0:return this.assertSubscribed("applyBatchState()"),[4,this.localStore.lookupMutationDocuments(n)];case 1:return null===(e=t.sent())?(br(Tl,"Cannot apply mutation batch with id: "+n),[2]):"pending"!==r?[3,3]:[4,this.remoteStore.fillWritePipeline()];case 2:return t.sent(),[3,4];case 3:"acknowledged"===r||"rejected"===r?(this.processUserCallback(n,i||null),this.localStore.removeCachedMutationBatchMetadata(n)):Sr("Unknown batchState: "+r),t.label=4;case 4:return[4,this.emitNewSnapsAndNotifyLocalStore(e)];case 5:return t.sent(),[2]}})})},Kl.prototype.applySuccessfulWrite=function(t){var e=this;this.assertSubscribed("applySuccessfulWrite()");var n=t.batch.batchId;return this.processUserCallback(n,null),this.localStore.acknowledgeBatch(t).then(function(t){return e.sharedClientState.updateMutationState(n,"acknowledged"),e.emitNewSnapsAndNotifyLocalStore(t)}).catch(fh)},Kl.prototype.rejectFailedWrite=function(e,n){var r=this;return this.assertSubscribed("rejectFailedWrite()"),this.processUserCallback(e,n),this.localStore.rejectBatch(e).then(function(t){return r.sharedClientState.updateMutationState(e,"rejected",n),r.emitNewSnapsAndNotifyLocalStore(t)}).catch(fh)},Kl.prototype.addMutationCallback=function(t,e){var n=this.mutationUserCallbacks[this.currentUser.toKey()];n=(n=n||new Ri(ri)).insert(t,e),this.mutationUserCallbacks[this.currentUser.toKey()]=n},Kl.prototype.processUserCallback=function(t,e){var n,r=this.mutationUserCallbacks[this.currentUser.toKey()];r&&((n=r.get(t))&&(Tr(t===r.minKey(),"Mutation callbacks processed out-of-order?"),e?n.reject(e):n.resolve(),r=r.remove(t)),this.mutationUserCallbacks[this.currentUser.toKey()]=r)},Kl.prototype.removeAndCleanupQuery=function(t){var e,n=this;this.sharedClientState.removeLocalQueryTarget(t.targetId),this.queryViewsByQuery.delete(t.query),delete this.queryViewsByTarget[t.targetId],this.isPrimary&&(e=this.limboDocumentRefs.referencesForId(t.targetId),this.limboDocumentRefs.removeReferencesForId(t.targetId),e.forEach(function(t){n.limboDocumentRefs.containsKey(t)||n.removeLimboTarget(t)}))},Kl.prototype.removeLimboTarget=function(t){var e=this.limboTargetsByKey.get(t);null!==e&&(this.remoteStore.unlisten(e),this.limboTargetsByKey=this.limboTargetsByKey.remove(t),delete this.limboResolutionsByTarget[e])},Kl.prototype.updateTrackedLimbos=function(t,e){for(var n=0,r=e;n<r.length;n++){var i=r[n];i instanceof al?(this.limboDocumentRefs.addReference(i.key,t),this.trackLimboChange(i)):i instanceof sl?(br(Tl,"Document no longer in limbo: "+i.key),this.limboDocumentRefs.removeReference(i.key,t),this.limboDocumentRefs.containsKey(i.key)||this.removeLimboTarget(i.key)):Sr("Unknown limbo change: "+JSON.stringify(i))}},Kl.prototype.trackLimboChange=function(t){var e,n=t.key;this.limboTargetsByKey.get(n)||(br(Tl,"New document in limbo: "+n),e=this.limboTargetIdGenerator.next(),t=Yo.atPath(n.path),this.limboResolutionsByTarget[e]=new Sl(n),this.remoteStore.listen(new ba(t,e,Go.LimboResolution,eu.INVALID)),this.limboTargetsByKey=this.limboTargetsByKey.insert(n,e))},Kl.prototype.currentLimboDocs=function(){return this.limboTargetsByKey},Kl.prototype.emitNewSnapsAndNotifyLocalStore=function(a,s){return c(this,void 0,void 0,function(){var r,i,e,o=this;return p(this,function(t){switch(t.label){case 0:return r=[],i=[],e=[],this.queryViewsByQuery.forEach(function(t,n){e.push(Promise.resolve().then(function(){var e=n.view.computeDocChanges(a);return e.needsRefill?o.localStore.executeQuery(n.query).then(function(t){return n.view.computeDocChanges(t,e)}):e}).then(function(t){var e=s&&s.targetChanges[n.targetId],e=n.view.applyChanges(t,!0===o.isPrimary,e);o.updateTrackedLimbos(n.targetId,e.limboChanges),e.snapshot&&(o.isPrimary&&o.sharedClientState.updateQueryState(n.targetId,e.snapshot.fromCache?"not-current":"current"),r.push(e.snapshot),e=pl.fromSnapshot(n.targetId,e.snapshot),i.push(e))}))}),[4,Promise.all(e)];case 1:return t.sent(),this.syncEngineListener.onWatchChange(r),[4,this.localStore.notifyLocalViewChanges(i)];case 2:return t.sent(),[2]}})})},Kl.prototype.assertSubscribed=function(t){Tr(null!==this.syncEngineListener,"Trying to call "+t+" before calling subscribe().")},Kl.prototype.handleCredentialChange=function(n){return c(this,void 0,void 0,function(){var e;return p(this,function(t){switch(t.label){case 0:return e=!this.currentUser.isEqual(n),this.currentUser=n,e?[4,this.localStore.handleUserChange(n)]:[3,3];case 1:return e=t.sent(),this.sharedClientState.handleUserChange(n,e.removedBatchIds,e.addedBatchIds),[4,this.emitNewSnapsAndNotifyLocalStore(e.affectedDocuments)];case 2:t.sent(),t.label=3;case 3:return[4,this.remoteStore.handleCredentialChange()];case 4:return t.sent(),[2]}})})},Kl.prototype.applyPrimaryState=function(u){return c(this,void 0,void 0,function(){var e,n,r,i,o,a,s=this;return p(this,function(t){switch(t.label){case 0:return!0!==u||!0===this.isPrimary?[3,3]:(this.isPrimary=!0,[4,this.remoteStore.applyPrimaryState(!0)]);case 1:return t.sent(),e=this.sharedClientState.getAllActiveQueryTargets(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(e.toArray())];case 2:for(e=t.sent(),n=0,r=e;n<r.length;n++)i=r[n],this.remoteStore.listen(i);return[3,7];case 3:return!1!==u||!1===this.isPrimary?[3,7]:(this.isPrimary=!1,o=[],a=Promise.resolve(),Pr(this.queryViewsByTarget,function(t,e){s.sharedClientState.isLocalQueryTarget(t)?o.push(t):a=a.then(function(){return s.unlisten(e.query)}),s.remoteStore.unlisten(e.targetId)}),[4,a]);case 4:return t.sent(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(o)];case 5:return t.sent(),this.resetLimboDocuments(),[4,this.remoteStore.applyPrimaryState(!1)];case 6:t.sent(),t.label=7;case 7:return[2]}})})},Kl.prototype.resetLimboDocuments=function(){var e=this;Pr(this.limboResolutionsByTarget,function(t){e.remoteStore.unlisten(t)}),this.limboDocumentRefs.removeAllReferences(),this.limboResolutionsByTarget=[],this.limboTargetsByKey=new Ri(Di.comparator)},Kl.prototype.synchronizeQueryViewsAndRaiseSnapshots=function(t){for(var e=this,n=Promise.resolve(),o=[],a=[],r=0,i=t;r<i.length;r++)!function(i){n=n.then(function(){return c(e,void 0,void 0,function(){var e,n,r;return p(this,function(t){switch(t.label){case 0:return(n=this.queryViewsByTarget[i])?[4,this.localStore.releaseQuery(n.query,!0)]:[3,4];case 1:return t.sent(),[4,this.localStore.allocateQuery(n.query)];case 2:return e=t.sent(),[4,this.synchronizeViewAndComputeSnapshot(n)];case 3:return(r=t.sent()).snapshot&&a.push(r.snapshot),[3,8];case 4:return Tr(!0===this.isPrimary,"A secondary tab should never have an active query without an active view."),[4,this.localStore.getQueryForTarget(i)];case 5:return Tr(!!(r=t.sent()),"Query data for target "+i+" not found"),[4,this.localStore.allocateQuery(r)];case 6:return e=t.sent(),[4,this.initializeViewAndComputeSnapshot(e,!1)];case 7:t.sent(),t.label=8;case 8:return o.push(e),[2]}})})})}(i[r]);return n.then(function(){return e.syncEngineListener.onWatchChange(a),o})},Kl.prototype.getActiveClients=function(){return this.localStore.getActiveClients()},Kl.prototype.applyTargetState=function(i,o,n){return c(this,void 0,void 0,function(){var e,r=this;return p(this,function(t){switch(t.label){case 0:if(this.isPrimary)return br(Tl,"Ignoring unexpected query state notification."),[2];if(!this.queryViewsByTarget[i])return[3,5];switch(o){case"current":case"not-current":return[3,1];case"rejected":return[3,2]}return[3,4];case 1:return[2,this.localStore.getNewDocumentChanges().then(function(n){return c(r,void 0,void 0,function(){var e;return p(this,function(t){switch(t.label){case 0:return e=ws.createSynthesizedRemoteEventForCurrentChange(i,"current"===o),[4,this.emitNewSnapsAndNotifyLocalStore(n,e)];case 1:return t.sent(),[2]}})})},function(n){return c(r,void 0,void 0,function(){var e;return p(this,function(t){switch(t.label){case 0:return n.code!==Ar.DATA_LOSS||n.message!==Hu?[3,2]:(e=[],Pr(this.queryViewsByTarget,function(t){return e.push(t)}),[4,this.synchronizeQueryViewsAndRaiseSnapshots(e)]);case 1:return t.sent(),[3,3];case 2:throw n;case 3:return[2]}})})})];case 2:return e=this.queryViewsByTarget[i],this.removeAndCleanupQuery(e),[4,this.localStore.releaseQuery(e.query,!0)];case 3:return t.sent(),this.syncEngineListener.onWatchError(e.query,n),[3,5];case 4:Sr("Unexpected target state: "+o),t.label=5;case 5:return[2]}})})},Kl.prototype.applyActiveTargetsChange=function(l,f){return c(this,void 0,void 0,function(){var e,n,r,i,o,a,s,u,c,h=this;return p(this,function(t){switch(t.label){case 0:if(!this.isPrimary)return[2];e=0,n=l,t.label=1;case 1:return e<n.length?(c=n[e],Tr(!this.queryViewsByTarget[c],"Trying to add an already active target"),[4,this.localStore.getQueryForTarget(c)]):[3,6];case 2:return Tr(!!(r=t.sent()),"Query data for active target "+c+" not found"),[4,this.localStore.allocateQuery(r)];case 3:return i=t.sent(),[4,this.initializeViewAndComputeSnapshot(i,!1)];case 4:t.sent(),this.remoteStore.listen(i),t.label=5;case 5:return e++,[3,1];case 6:o=function(e){var n;return p(this,function(t){switch(t.label){case 0:return(n=a.queryViewsByTarget[e])?[4,a.localStore.releaseQuery(n.query,!1).then(function(){h.remoteStore.unlisten(e),h.removeAndCleanupQuery(n)}).catch(fh)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})},a=this,s=0,u=f,t.label=7;case 7:return s<u.length?(c=u[s],[5,o(c)]):[3,10];case 8:t.sent(),t.label=9;case 9:return s++,[3,7];case 10:return[2]}})})},Kl.prototype.enableNetwork=function(){return this.localStore.setNetworkEnabled(!0),this.remoteStore.enableNetwork()},Kl.prototype.disableNetwork=function(){return this.localStore.setNetworkEnabled(!1),this.remoteStore.disableNetwork()},Kl.prototype.getRemoteKeysForTarget=function(t){var e=this.limboResolutionsByTarget[t];return e&&e.receivedDocument?cs().add(e.key):this.queryViewsByTarget[t]?this.queryViewsByTarget[t].view.syncedDocuments:cs()},Kl),Cl=(Ql.prototype.isAuthenticated=function(){return null!=this.uid},Ql.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"},Ql.prototype.isEqual=function(t){return t.uid===this.uid},Ql.UNAUTHENTICATED=new Ql(null),Ql.GOOGLE_CREDENTIALS=new Ql("google-credentials-uid"),Ql.FIRST_PARTY=new Ql("first-party-uid"),Ql),Dl="SharedClientState",Nl="firestore_clients",Al="firestore_mutations",kl="firestore_targets",Rl=(Ul.fromWebStorageEntry=function(t,e,n){var r=JSON.parse(n),i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error),o=void 0;return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(o=new kr(r.error.code,r.error.message)),i?new Ul(t,e,r.state,o):(wr(Dl,"Failed to parse mutation state for ID '"+e+"': "+n),null)},Ul.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},Ul),Ml=(Bl.fromWebStorageEntry=function(t,e){var n=JSON.parse(e),r="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error),i=void 0;return r&&n.error&&(r="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(i=new kr(n.error.code,n.error.message)),r?new Bl(t,n.state,i):(wr(Dl,"Failed to parse target state for ID '"+t+"': "+e),null)},Bl.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},Bl),Ol=(Vl.fromWebStorageEntry=function(t,e){for(var n=JSON.parse(e),r="object"==typeof n&&n.activeTargetIds instanceof Array,i=hs,o=0;r&&o<n.activeTargetIds.length;++o)r=jo(n.activeTargetIds[o]),i=i.add(n.activeTargetIds[o]);return r?new Vl(t,i):(wr(Dl,"Failed to parse client data for instance '"+t+"': "+e),null)},Vl),_l=(Fl.fromWebStorageEntry=function(t){var e=JSON.parse(t);return"object"==typeof e&&void 0!==Wh[e.onlineState]&&"string"==typeof e.clientId?new Fl(e.clientId,Wh[e.onlineState]):(wr(Dl,"Failed to parse online state: "+t),null)},Fl),Pl=(ql.prototype.addQueryTarget=function(t){Tr(!this.activeTargetIds.has(t),"Target with ID '"+t+"' already active."),this.activeTargetIds=this.activeTargetIds.add(t)},ql.prototype.removeQueryTarget=function(t){this.activeTargetIds=this.activeTargetIds.delete(t)},ql.prototype.toWebStorageJSON=function(){var t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)},ql),Ll=(xl.isAvailable=function(t){return!(!t.window||null==t.window.localStorage)},xl.prototype.start=function(){return c(this,void 0,void 0,function(){var e,n,r,i,o,a,s,u,c,h,l=this;return p(this,function(t){switch(t.label){case 0:return Tr(!this.started,"WebStorageSharedClientState already started"),Tr(null!==this.syncEngine,"syncEngine property must be set before calling start()"),Tr(null!==this.onlineStateHandler,"onlineStateHandler property must be set before calling start()"),[4,this.syncEngine.getActiveClients()];case 1:for(a=t.sent(),e=0,n=a;e<n.length;e++)(r=n[e])!==this.localClientId&&(i=this.getItem(this.toWebStorageClientStateKey(r)))&&(o=Ol.fromWebStorageEntry(r,i))&&(this.activeClients[o.clientId]=o);for(this.persistClientState(),(a=this.storage.getItem(this.onlineStateKey))&&(s=this.fromWebStorageOnlineState(a))&&this.handleOnlineStateEvent(s),u=0,c=this.earlyEvents;u<c.length;u++)h=c[u],this.handleWebStorageEvent(h);return this.earlyEvents=[],this.platform.window.addEventListener("unload",function(){return l.shutdown()}),this.started=!0,[2]}})})},xl.prototype.writeSequenceNumber=function(t){this.setItem(this.sequenceNumberKey,JSON.stringify(t))},xl.prototype.getAllActiveQueryTargets=function(){var n=hs;return Lr(this.activeClients,function(t,e){n=n.unionWith(e.activeTargetIds)}),n},xl.prototype.isActiveQueryTarget=function(t){for(var e in this.activeClients)if(this.activeClients.hasOwnProperty(e)&&this.activeClients[e].activeTargetIds.has(t))return!0;return!1},xl.prototype.addPendingMutation=function(t){this.persistMutationState(t,"pending")},xl.prototype.updateMutationState=function(t,e,n){this.persistMutationState(t,e,n),this.removeMutationState(t)},xl.prototype.addLocalQueryTarget=function(t){var e,n="not-current";return this.isActiveQueryTarget(t)&&(!(e=this.storage.getItem(this.toWebStorageQueryTargetMetadataKey(t)))||(e=Ml.fromWebStorageEntry(t,e))&&(n=e.state)),this.localClientState.addQueryTarget(t),this.persistClientState(),n},xl.prototype.removeLocalQueryTarget=function(t){this.localClientState.removeQueryTarget(t),this.persistClientState()},xl.prototype.isLocalQueryTarget=function(t){return this.localClientState.activeTargetIds.has(t)},xl.prototype.clearQueryState=function(t){this.removeItem(this.toWebStorageQueryTargetMetadataKey(t))},xl.prototype.updateQueryState=function(t,e,n){this.persistQueryTargetState(t,e,n)},xl.prototype.handleUserChange=function(t,e,n){var r=this;e.forEach(function(t){r.removeMutationState(t)}),this.currentUser=t,n.forEach(function(t){r.addPendingMutation(t)})},xl.prototype.setOnlineState=function(t){this.persistOnlineState(t)},xl.prototype.shutdown=function(){this.started&&(this.platform.window.removeEventListener("storage",this.storageListener),this.removeItem(this.localClientStorageKey),this.started=!1)},xl.prototype.getItem=function(t){var e=this.storage.getItem(t);return br(Dl,"READ",t,e),e},xl.prototype.setItem=function(t,e){br(Dl,"SET",t,e),this.storage.setItem(t,e)},xl.prototype.removeItem=function(t){br(Dl,"REMOVE",t),this.storage.removeItem(t)},xl.prototype.handleWebStorageEvent=function(o){var t=this;o.storageArea===this.storage&&(br(Dl,"EVENT",o.key,o.newValue),o.key!==this.localClientStorageKey?this.queue.enqueueAndForget(function(){return c(t,void 0,void 0,function(){var e,n,r,i;return p(this,function(t){if(!this.started)return this.earlyEvents.push(o),[2];if(null===o.key)return[2];if(this.clientStateKeyRe.test(o.key)){if(null==o.newValue)return i=this.fromWebStorageClientStateKey(o.key),[2,this.handleClientStateEvent(i,null)];if(i=this.fromWebStorageClientState(o.key,o.newValue))return[2,this.handleClientStateEvent(i.clientId,i)]}else if(this.mutationBatchKeyRe.test(o.key)){if(null!==o.newValue&&(e=this.fromWebStorageMutationMetadata(o.key,o.newValue)))return[2,this.handleMutationBatchEvent(e)]}else if(this.queryTargetKeyRe.test(o.key)){if(null!==o.newValue&&(n=this.fromWebStorageQueryTargetMetadata(o.key,o.newValue)))return[2,this.handleQueryTargetEvent(n)]}else if(o.key===this.onlineStateKey){if(null!==o.newValue&&(r=this.fromWebStorageOnlineState(o.newValue)))return[2,this.handleOnlineStateEvent(r)]}else o.key===this.sequenceNumberKey&&(Tr(!!this.sequenceNumberHandler,"Missing sequenceNumberHandler"),(i=function(t){var e=eu.INVALID;if(null!=t)try{var n=JSON.parse(t);Tr("number"==typeof n,"Found non-numeric sequence number"),e=n}catch(t){wr(Dl,"Failed to read sequence number from WebStorage",t)}return e}(o.newValue))!==eu.INVALID&&this.sequenceNumberHandler(i));return[2]})})}):wr("Received WebStorage notification for local change. Another client might have garbage-collected our state"))},Object.defineProperty(xl.prototype,"localClientState",{get:function(){return this.activeClients[this.localClientId]},enumerable:!0,configurable:!0}),xl.prototype.persistClientState=function(){this.setItem(this.localClientStorageKey,this.localClientState.toWebStorageJSON())},xl.prototype.persistMutationState=function(t,e,n){n=new Rl(this.currentUser,t,e,n),t=this.toWebStorageMutationBatchKey(t);this.setItem(t,n.toWebStorageJSON())},xl.prototype.removeMutationState=function(t){t=this.toWebStorageMutationBatchKey(t);this.removeItem(t)},xl.prototype.persistOnlineState=function(t){t={clientId:this.localClientId,onlineState:Wh[t]};this.storage.setItem(this.onlineStateKey,JSON.stringify(t))},xl.prototype.persistQueryTargetState=function(t,e,n){var r=this.toWebStorageQueryTargetMetadataKey(t),n=new Ml(t,e,n);this.setItem(r,n.toWebStorageJSON())},xl.prototype.toWebStorageClientStateKey=function(t){return Tr(-1===t.indexOf("_"),"Client key cannot contain '_', but was '"+t+"'"),Nl+"_"+this.persistenceKey+"_"+t},xl.prototype.toWebStorageQueryTargetMetadataKey=function(t){return kl+"_"+this.persistenceKey+"_"+t},xl.prototype.toWebStorageMutationBatchKey=function(t){t=Al+"_"+this.persistenceKey+"_"+t;return this.currentUser.isAuthenticated()&&(t+="_"+this.currentUser.uid),t},xl.prototype.fromWebStorageClientStateKey=function(t){t=this.clientStateKeyRe.exec(t);return t?t[1]:null},xl.prototype.fromWebStorageClientState=function(t,e){var n=this.fromWebStorageClientStateKey(t);return Tr(null!==n,"Cannot parse client state key '"+t+"'"),Ol.fromWebStorageEntry(n,e)},xl.prototype.fromWebStorageMutationMetadata=function(t,e){var n=this.mutationBatchKeyRe.exec(t);Tr(null!==n,"Cannot parse mutation batch key '"+t+"'");t=Number(n[1]),n=void 0!==n[2]?n[2]:null;return Rl.fromWebStorageEntry(new Cl(n),t,e)},xl.prototype.fromWebStorageQueryTargetMetadata=function(t,e){var n=this.queryTargetKeyRe.exec(t);Tr(null!==n,"Cannot parse query target key '"+t+"'");n=Number(n[1]);return Ml.fromWebStorageEntry(n,e)},xl.prototype.fromWebStorageOnlineState=function(t){return _l.fromWebStorageEntry(t)},xl.prototype.handleMutationBatchEvent=function(e){return c(this,void 0,void 0,function(){return p(this,function(t){return e.user.uid!==this.currentUser.uid?(br(Dl,"Ignoring mutation for non-active user "+e.user.uid),[2]):[2,this.syncEngine.applyBatchState(e.batchId,e.state,e.error)]})})},xl.prototype.handleQueryTargetEvent=function(t){return this.syncEngine.applyTargetState(t.targetId,t.state,t.error)},xl.prototype.handleClientStateEvent=function(t,e){var n=this,r=this.getAllActiveQueryTargets();e?this.activeClients[t]=e:delete this.activeClients[t];var i=this.getAllActiveQueryTargets(),o=[],a=[];return i.forEach(function(e){return c(n,void 0,void 0,function(){return p(this,function(t){return r.has(e)||o.push(e),[2]})})}),r.forEach(function(e){return c(n,void 0,void 0,function(){return p(this,function(t){return i.has(e)||a.push(e),[2]})})}),this.syncEngine.applyActiveTargetsChange(o,a)},xl.prototype.handleOnlineStateEvent=function(t){this.activeClients[t.clientId]&&this.onlineStateHandler(t.onlineState)},xl);function xl(t,e,n,r,i){if(this.queue=t,this.platform=e,this.persistenceKey=n,this.localClientId=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.activeClients={},this.storageListener=this.handleWebStorageEvent.bind(this),this.started=!1,this.earlyEvents=[],!xl.isAvailable(this.platform))throw new kr(Ar.UNIMPLEMENTED,"LocalStorage is not available on this platform.");r=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.platform.window.localStorage,this.currentUser=i,this.localClientStorageKey=this.toWebStorageClientStateKey(this.localClientId),this.sequenceNumberKey="firestore_sequence_number_"+n,this.activeClients[this.localClientId]=new Pl,this.clientStateKeyRe=new RegExp("^"+Nl+"_"+r+"_([^_]*)$"),this.mutationBatchKeyRe=new RegExp("^"+Al+"_"+r+"_(\\d+)(?:_(.*))?$"),this.queryTargetKeyRe=new RegExp("^"+kl+"_"+r+"_(\\d+)$"),this.onlineStateKey="firestore_online_state_"+n,this.platform.window.addEventListener("storage",this.storageListener)}function ql(){this.activeTargetIds=hs}function Fl(t,e){this.clientId=t,this.onlineState=e}function Vl(t,e){this.clientId=t,this.activeTargetIds=e}function Bl(t,e,n){this.targetId=t,this.state=e,Tr(void 0!==(this.error=n)==("rejected"===e),"QueryTargetMetadata must contain an error iff state is 'rejected'")}function Ul(t,e,n,r){this.user=t,this.batchId=e,this.state=n,Tr(void 0!==(this.error=r)==("rejected"===n),"MutationMetadata must contain an error iff state is 'rejected'")}function Ql(t){this.uid=t}function Kl(t,e,n,r){this.localStore=t,this.remoteStore=e,this.sharedClientState=n,this.currentUser=r,this.syncEngineListener=null,this.queryViewsByQuery=new zu(function(t){return t.canonicalId()}),this.queryViewsByTarget={},this.limboTargetsByKey=new Ri(Di.comparator),this.limboResolutionsByTarget={},this.limboDocumentRefs=new bh,this.mutationUserCallbacks={},this.limboTargetIdGenerator=ku.forSyncEngine(),this.isPrimary=void 0,this.onlineState=Wh.Unknown}function jl(){}var Gl=(nf.prototype.addPendingMutation=function(t){},nf.prototype.updateMutationState=function(t,e,n){},nf.prototype.addLocalQueryTarget=function(t){return this.localState.addQueryTarget(t),this.queryState[t]||"not-current"},nf.prototype.updateQueryState=function(t,e,n){this.queryState[t]=e},nf.prototype.removeLocalQueryTarget=function(t){this.localState.removeQueryTarget(t)},nf.prototype.isLocalQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},nf.prototype.clearQueryState=function(t){delete this.queryState[t]},nf.prototype.getAllActiveQueryTargets=function(){return this.localState.activeTargetIds},nf.prototype.isActiveQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},nf.prototype.start=function(){return this.localState=new Pl,Promise.resolve()},nf.prototype.handleUserChange=function(t,e,n){},nf.prototype.setOnlineState=function(t){},nf.prototype.shutdown=function(){},nf.prototype.writeSequenceNumber=function(t){},nf),Wl="FirestoreClient",zl=(ef.prototype.lruParams=function(){return $c.withCacheSize(this.cacheSizeBytes)},ef),Hl=(tf.prototype.start=function(t){var n=this;this.verifyNotShutdown();var r=new Zs,i=new Zs,o=!1;return this.credentials.setChangeListener(function(e){o?n.asyncQueue.enqueueAndForget(function(){return n.handleCredentialChange(e)}):(o=!0,n.initializePersistence(t,i,e).then(function(t){return n.initializeRest(e,t)}).then(r.resolve,r.reject))}),this.asyncQueue.enqueueAndForget(function(){return r.promise}),i.promise},tf.prototype.enableNetwork=function(){var t=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return t.syncEngine.enableNetwork()})},tf.prototype.initializePersistence=function(t,e,n){var r=this;return t instanceof zl?this.startIndexedDbPersistence(n,t).then(function(t){return e.resolve(),t}).catch(function(t){if(e.reject(t),!r.canFallback(t))throw t;return console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),r.startMemoryPersistence()}):(e.resolve(),this.startMemoryPersistence())},tf.prototype.canFallback=function(t){return t instanceof kr?t.code===Ar.FAILED_PRECONDITION||t.code===Ar.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code},tf.prototype.verifyNotShutdown=function(){if(this._clientShutdown)throw new kr(Ar.FAILED_PRECONDITION,"The client has already been shutdown.")},tf.prototype.startIndexedDbPersistence=function(r,i){var t=this,o=oh.buildStoragePrefix(this.databaseInfo),a=new Fs(this.databaseInfo.databaseId,{useProto3Json:!0});return Promise.resolve().then(function(){return c(t,void 0,void 0,function(){var e,n;return p(this,function(t){switch(t.label){case 0:if(i.synchronizeTabs&&!Ll.isAvailable(this.platform))throw new kr(Ar.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");return n=i.lruParams(),i.synchronizeTabs?(this.sharedClientState=new Ll(this.asyncQueue,this.platform,o,this.clientId,r),[4,oh.createMultiClientIndexedDbPersistence(o,this.clientId,this.platform,this.asyncQueue,a,n,{sequenceNumberSyncer:this.sharedClientState})]):[3,2];case 1:return e=t.sent(),[3,4];case 2:return this.sharedClientState=new Gl,[4,oh.createIndexedDbPersistence(o,this.clientId,this.platform,this.asyncQueue,a,n)];case 3:e=t.sent(),t.label=4;case 4:return[2,(this.persistence=e).referenceDelegate.garbageCollector]}})})})},tf.prototype.startMemoryPersistence=function(){return this.persistence=Ph.createEagerPersistence(this.clientId),this.sharedClientState=new Gl,Promise.resolve(null)},tf.prototype.initializeRest=function(s,u){var t=this;return br(Wl,"Initializing. user=",s.uid),this.platform.loadConnection(this.databaseInfo).then(function(a){return c(t,void 0,void 0,function(){var e,n,r,i,o=this;return p(this,function(t){switch(t.label){case 0:return this.localStore=new Eh(this.persistence,s),u&&(this.lruScheduler=new Zc(u,this.asyncQueue,this.localStore)),e=this.platform.newConnectivityMonitor(),i=this.platform.newSerializer(this.databaseInfo.databaseId),n=new $h(this.asyncQueue,a,this.credentials,i),r=function(t){return o.syncEngine.applyOnlineStateChange(t,zh.RemoteStore)},i=function(t){return o.syncEngine.applyOnlineStateChange(t,zh.SharedClientState)},this.remoteStore=new hl(this.localStore,n,this.asyncQueue,r,e),this.syncEngine=new Il(this.localStore,this.remoteStore,this.sharedClientState,s),this.sharedClientState.onlineStateHandler=i,this.remoteStore.syncEngine=this.syncEngine,this.sharedClientState.syncEngine=this.syncEngine,this.eventMgr=new ll(this.syncEngine),[4,this.sharedClientState.start()];case 1:return t.sent(),[4,this.remoteStore.start()];case 2:return t.sent(),[4,this.persistence.setPrimaryStateListener(function(e){return c(o,void 0,void 0,function(){return p(this,function(t){switch(t.label){case 0:return[4,this.syncEngine.applyPrimaryState(e)];case 1:return t.sent(),this.lruScheduler&&(e&&!this.lruScheduler.started?this.lruScheduler.start():e||this.lruScheduler.stop()),[2]}})})})];case 3:return t.sent(),[4,this.persistence.setDatabaseDeletedListener(function(){return c(o,void 0,void 0,function(){return p(this,function(t){switch(t.label){case 0:return[4,this.shutdown()];case 1:return t.sent(),[2]}})})})];case 4:return t.sent(),[2]}})})})},tf.prototype.handleCredentialChange=function(t){return this.asyncQueue.verifyOperationInProgress(),br(Wl,"Credential Changed. Current user: "+t.uid),this.syncEngine.handleCredentialChange(t)},tf.prototype.disableNetwork=function(){var t=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return t.syncEngine.disableNetwork()})},tf.prototype.shutdown=function(){var t=this;return this.asyncQueue.enqueue(function(){return c(t,void 0,void 0,function(){return p(this,function(t){switch(t.label){case 0:return this._clientShutdown?[3,4]:(this.lruScheduler&&this.lruScheduler.stop(),[4,this.remoteStore.shutdown()]);case 1:return t.sent(),[4,this.sharedClientState.shutdown()];case 2:return t.sent(),[4,this.persistence.shutdown()];case 3:t.sent(),this.credentials.removeChangeListener(),this._clientShutdown=!0,t.label=4;case 4:return[2]}})})})},tf.prototype.listen=function(t,e,n){var r=this;this.verifyNotShutdown();var i=new fl(t,e,n);return this.asyncQueue.enqueueAndForget(function(){return r.eventMgr.listen(i)}),i},tf.prototype.unlisten=function(t){var e=this;this.verifyNotShutdown(),this.asyncQueue.enqueueAndForget(function(){return e.eventMgr.unlisten(t)})},tf.prototype.getDocumentFromLocalCache=function(t){var e=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return e.localStore.readDocument(t)}).then(function(t){if(t instanceof Ni)return t;if(t instanceof Ai)return null;throw new kr(Ar.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")})},tf.prototype.getDocumentsFromLocalCache=function(n){var t=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return t.localStore.executeQuery(n)}).then(function(t){var e=cs(),e=new dl(n,e),t=e.computeDocChanges(t);return e.applyChanges(t,!1).snapshot})},tf.prototype.write=function(t){var e=this;this.verifyNotShutdown();var n=new Zs;return this.asyncQueue.enqueueAndForget(function(){return e.syncEngine.write(t,n)}),n.promise},tf.prototype.databaseId=function(){return this.databaseInfo.databaseId},Object.defineProperty(tf.prototype,"clientShutdown",{get:function(){return this._clientShutdown},enumerable:!0,configurable:!0}),tf.prototype.transaction=function(t){var e=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return c(e,void 0,void 0,function(){return p(this,function(t){return[2]})})}).then(function(){return e.syncEngine.runTransaction(t)})},tf),Yl=(Zl.prototype.next=function(t){this.scheduleEvent(this.observer.next,t)},Zl.prototype.error=function(t){this.scheduleEvent(this.observer.error,t)},Zl.prototype.mute=function(){this.muted=!0},Zl.prototype.scheduleEvent=function(t,e){var n=this;this.muted||setTimeout(function(){n.muted||t(e)},0)},Zl),Xl=($l.documentId=function(){return $l._DOCUMENT_ID},$l.prototype.isEqual=function(t){if(!(t instanceof $l))throw $r("isEqual","FieldPath",1,t);return this._internalPath.isEqual(t._internalPath)},$l._DOCUMENT_ID=new $l(Ci.keyField().canonicalString()),$l),Jl=new RegExp("[~\\*/\\[\\]]");function $l(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];!function(){if(!(t instanceof Array)||t.length<1)throw new kr(Ar.INVALID_ARGUMENT,"Function FieldPath() requires its fieldNames argument to be an array with at least 1 element.")}();for(var n=0;n<t.length;++n)if(Ur("FieldPath","string",n,t[n]),0===t[n].length)throw new kr(Ar.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Ci(t)}function Zl(t){this.observer=t,this.muted=!1}function tf(t,e,n,r){this.platform=t,this.databaseInfo=e,this.credentials=n,this.asyncQueue=r,this.clientId=ei.newId(),this._clientShutdown=!1}function ef(t,e){this.cacheSizeBytes=t,this.synchronizeTabs=e}function nf(){this.localState=new Pl,this.queryState={},this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null}function rf(t,e){this.user=e,this.type="OAuth",this.authHeaders={Authorization:"Bearer "+t}}var of=(ff.prototype.getToken=function(){return Promise.resolve(null)},ff.prototype.invalidateToken=function(){},ff.prototype.setChangeListener=function(t){Tr(!this.changeListener,"Can only call setChangeListener() once."),(this.changeListener=t)(Cl.UNAUTHENTICATED)},ff.prototype.removeChangeListener=function(){Tr(null!==this.changeListener,"removeChangeListener() when no listener registered"),this.changeListener=null},ff),af=(lf.prototype.getToken=function(){var e=this;Tr(null!=this.tokenListener,"getToken cannot be called after listener removed.");var n=this.tokenCounter,t=this.forceRefresh;return this.forceRefresh=!1,this.app.INTERNAL.getToken(t).then(function(t){if(e.tokenCounter!==n)throw new kr(Ar.ABORTED,"getToken aborted due to token change.");return t?(Tr("string"==typeof t.accessToken,"Invalid tokenData returned from getToken():"+t),new rf(t.accessToken,e.currentUser)):null})},lf.prototype.invalidateToken=function(){this.forceRefresh=!0},lf.prototype.setChangeListener=function(t){Tr(!this.changeListener,"Can only call setChangeListener() once."),this.changeListener=t,this.currentUser&&t(this.currentUser)},lf.prototype.removeChangeListener=function(){Tr(null!=this.tokenListener,"removeChangeListener() called twice"),Tr(null!==this.changeListener,"removeChangeListener() called when no listener registered"),this.app.INTERNAL.removeAuthTokenListener(this.tokenListener),this.tokenListener=null,this.changeListener=null},lf.prototype.getUser=function(){var t=this.app.INTERNAL.getUid();return Tr(null===t||"string"==typeof t,"Received invalid UID: "+t),new Cl(t)},lf),sf=(Object.defineProperty(hf.prototype,"authHeaders",{get:function(){var t={"X-Goog-AuthUser":this.sessionIndex},e=this.gapi.auth.getAuthHeaderValueForFirstParty([]);return e&&(t.Authorization=e),t},enumerable:!0,configurable:!0}),hf),uf=(cf.prototype.getToken=function(){return Promise.resolve(new sf(this.gapi,this.sessionIndex))},cf.prototype.setChangeListener=function(t){t(Cl.FIRST_PARTY)},cf.prototype.removeChangeListener=function(){},cf.prototype.invalidateToken=function(){},cf);function cf(t,e){this.gapi=t,this.sessionIndex=e}function hf(t,e){this.gapi=t,this.sessionIndex=e,this.type="FirstParty",this.user=Cl.FIRST_PARTY}function lf(t){var e=this;this.app=t,this.tokenListener=null,this.tokenCounter=0,this.changeListener=null,this.forceRefresh=!1,this.tokenListener=function(){e.tokenCounter++,e.currentUser=e.getUser(),e.changeListener&&e.changeListener(e.currentUser)},this.tokenCounter=0,this.app.INTERNAL.addAuthTokenListener(this.tokenListener)}function ff(){this.changeListener=null}function pf(i){return function(){if("object"==typeof i&&null!==i)for(var t=i,e=0,n=["next","error","complete"];e<n.length;e++){var r=n[e];if(r in t&&"function"==typeof t[r])return 1}}()}var df,mf,yf,gf,vf,bf,wf=(xf.delete=function(){return qr("FieldValue.delete",arguments),Ef.instance},xf.serverTimestamp=function(){return qr("FieldValue.serverTimestamp",arguments),Sf.instance},xf.arrayUnion=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return Vr("FieldValue.arrayUnion",arguments,1),new Tf(t)},xf.arrayRemove=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return Vr("FieldValue.arrayRemove",arguments,1),new If(t)},xf.increment=function(t){return Ur("FieldValue.increment","number",1,t),Fr("FieldValue.increment",arguments,1),new Cf(t)},xf.prototype.isEqual=function(t){return this===t},xf),Ef=(a(Lf,bf=wf),Lf.instance=new Lf,Lf),Sf=(a(Pf,vf=wf),Pf.instance=new Pf,Pf),Tf=(a(_f,gf=wf),_f),If=(a(Of,yf=wf),Of),Cf=(a(Mf,mf=wf),Mf),se=Mr(wf,"Use FieldValue.<field>() instead."),Df=/^__.*__$/,Nf=(Rf.prototype.toMutations=function(t,e){var n=[];return null!==this.fieldMask?n.push(new xa(t,this.data,this.fieldMask,e)):n.push(new La(t,this.data,e)),0<this.fieldTransforms.length&&n.push(new qa(t,this.fieldTransforms)),n},Rf),Af=(kf.prototype.toMutations=function(t,e){e=[new xa(t,this.data,this.fieldMask,e)];return 0<this.fieldTransforms.length&&e.push(new qa(t,this.fieldTransforms)),e},kf);function kf(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}function Rf(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}function Mf(t){var e=mf.call(this,"FieldValue.increment")||this;return e._operand=t,e}function Of(t){var e=yf.call(this,"FieldValue.arrayRemove")||this;return e._elements=t,e}function _f(t){var e=gf.call(this,"FieldValue.arrayUnion")||this;return e._elements=t,e}function Pf(){return vf.call(this,"FieldValue.serverTimestamp")||this}function Lf(){return bf.call(this,"FieldValue.delete")||this}function xf(t){this._methodName=t}function qf(t){switch(t){case df.Set:case df.MergeSet:case df.Update:return 1;case df.Argument:return;default:throw Sr("Unexpected case for UserDataSource: "+t)}}(er=df=df||{})[er.Set=0]="Set",er[er.Update=1]="Update",er[er.MergeSet=2]="MergeSet",er[er.Argument=3]="Argument";var Ff=(Qf.prototype.childContextForField=function(t){var e=null==this.path?null:this.path.child(t),e=new Qf(this.dataSource,this.methodName,e,!1,this.fieldTransforms,this.fieldMask);return e.validatePathSegment(t),e},Qf.prototype.childContextForFieldPath=function(t){t=null==this.path?null:this.path.child(t),t=new Qf(this.dataSource,this.methodName,t,!1,this.fieldTransforms,this.fieldMask);return t.validatePath(),t},Qf.prototype.childContextForArray=function(t){return new Qf(this.dataSource,this.methodName,null,!0,this.fieldTransforms,this.fieldMask)},Qf.prototype.createError=function(t){var e=null===this.path||this.path.isEmpty()?"":" (found in field "+this.path.toString()+")";return new kr(Ar.INVALID_ARGUMENT,"Function "+this.methodName+"() called with invalid data. "+t+e)},Qf.prototype.contains=function(e){return void 0!==this.fieldMask.find(function(t){return e.isPrefixOf(t)})||void 0!==this.fieldTransforms.find(function(t){return e.isPrefixOf(t.field)})},Qf.prototype.validatePath=function(){if(null!==this.path)for(var t=0;t<this.path.length;t++)this.validatePathSegment(this.path.get(t))},Qf.prototype.validatePathSegment=function(t){if(qf(this.dataSource)&&Df.test(t))throw this.createError("Document fields cannot begin and end with __")},Qf),Vf=function(t,e){this.databaseId=t,this.key=e},Bf=(Uf.prototype.parseSetData=function(t,e){t=new Ff(df.Set,t,Ci.EMPTY_PATH);jf("Data must be an object, but it was:",t,e);e=this.parseData(e,t);return new Nf(e,null,t.fieldTransforms)},Uf.prototype.parseMergeData=function(t,e,n){var r=new Ff(df.MergeSet,t,Ci.EMPTY_PATH);jf("Data must be an object, but it was:",r,e);var i,o,e=this.parseData(e,r);if(n){for(var a=new wa(Ci.comparator),s=0,u=n;s<u.length;s++){var c=u[s],h=void 0;if(c instanceof Xl)h=c._internalPath;else{if("string"!=typeof c)throw Sr("Expected stringOrFieldPath to be a string or a FieldPath");h=Wf(t,c)}if(!r.contains(h))throw new kr(Ar.INVALID_ARGUMENT,"Field '"+h+"' is specified in your field mask but missing from your input data.");a=a.add(h)}i=Sa.fromSet(a),o=r.fieldTransforms.filter(function(t){return i.covers(t.field)})}else i=Sa.fromArray(r.fieldMask),o=r.fieldTransforms;return new Nf(e,i,o)},Uf.prototype.parseUpdateData=function(r,t){var i=this,o=new Ff(df.Update,r,Ci.EMPTY_PATH);jf("Data must be an object, but it was:",o,t);var a=new wa(Ci.comparator),s=Ao.EMPTY;Lr(t,function(t,e){var n=Wf(r,t),t=o.childContextForFieldPath(n);(e=i.runPreConverter(e,t))instanceof Ef?a=a.add(n):null!=(t=i.parseData(e,t))&&(a=a.add(n),s=s.set(n,t))});t=Sa.fromSet(a);return new Af(s,t,o.fieldTransforms)},Uf.prototype.parseUpdateVarargs=function(t,e,n,r){var i=new Ff(df.Update,t,Ci.EMPTY_PATH),o=[Gf(t,e)],a=[n];if(r.length%2!=0)throw new kr(Ar.INVALID_ARGUMENT,"Function "+t+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var s=0;s<r.length;s+=2)o.push(Gf(t,r[s])),a.push(r[s+1]);for(var u=new wa(Ci.comparator),c=Ao.EMPTY,s=0;s<o.length;++s){var h=o[s],l=i.childContextForFieldPath(h),f=this.runPreConverter(a[s],l);f instanceof Ef?u=u.add(h):null!=(l=this.parseData(f,l))&&(u=u.add(h),c=c.set(h,l))}n=Sa.fromSet(u);return new Af(c,n,i.fieldTransforms)},Uf.prototype.parseQueryValue=function(t,e){t=new Ff(df.Argument,t,Ci.EMPTY_PATH),e=this.parseData(e,t);return Tr(null!=e,"Parsed data should not be null."),Tr(0===t.fieldTransforms.length,"Field transforms should have been disallowed."),e},Uf.prototype.runPreConverter=function(t,e){try{return this.preConverter(t)}catch(t){var n=zf(t);throw e.createError(n)}},Uf.prototype.parseData=function(t,e){if(Kf(t=this.runPreConverter(t,e)))return jf("Unsupported field value:",e,t),this.parseObject(t,e);if(t instanceof wf)return this.parseSentinelFieldValue(t,e),null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.arrayElement)throw e.createError("Nested arrays are not supported");return this.parseArray(t,e)}return this.parseScalarValue(t,e)},Uf.prototype.parseObject=function(t,n){var r=this,i=new Ri(ri);return xr(t)?n.path&&0<n.path.length&&n.fieldMask.push(n.path):Lr(t,function(t,e){e=r.parseData(e,n.childContextForField(t));null!=e&&(i=i.insert(t,e))}),new Ao(i)},Uf.prototype.parseArray=function(t,e){for(var n=[],r=0,i=0,o=t;i<o.length;i++){var a=o[i],a=this.parseData(a,e.childContextForArray(r));null==a&&(a=to.INSTANCE),n.push(a),r++}return new ko(n)},Uf.prototype.parseSentinelFieldValue=function(t,e){if(!qf(e.dataSource))throw e.createError(t._methodName+"() can only be used with update() and set()");if(null===e.path)throw e.createError(t._methodName+"() is not currently supported inside arrays");if(t instanceof Ef){if(e.dataSource!==df.MergeSet)throw e.dataSource===df.Update?(Tr(0<e.path.length,"FieldValue.delete() at the top level should have already been handled."),e.createError("FieldValue.delete() can only appear at the top level of your update data")):e.createError("FieldValue.delete() cannot be used with set() unless you pass {merge:true}");e.fieldMask.push(e.path)}else{var n,r,i;t instanceof Sf?e.fieldTransforms.push(new Ta(e.path,Va.instance)):t instanceof Tf?(r=this.parseArrayTransformElements(t._methodName,t._elements),n=new Ba(r),e.fieldTransforms.push(new Ta(e.path,n))):t instanceof If?(r=this.parseArrayTransformElements(t._methodName,t._elements),i=new Ua(r),e.fieldTransforms.push(new Ta(e.path,i))):t instanceof Cf?(i=this.parseQueryValue("FieldValue.increment",t._operand),i=new Qa(i),e.fieldTransforms.push(new Ta(e.path,i))):Sr("Unknown FieldValue type: "+t)}},Uf.prototype.parseScalarValue=function(t,e){if(null===t)return to.INSTANCE;if("number"==typeof t)return new(jo(t)?wo:Eo)(t);if("boolean"==typeof t)return eo.of(t);if("string"==typeof t)return new So(t);if(t instanceof Date)return new To(bi.fromDate(t));if(t instanceof bi)return new To(new bi(t.seconds,1e3*Math.floor(t.nanoseconds/1e3)));if(t instanceof vi)return new No(t);if(t instanceof yi)return new Co(t);if(t instanceof Vf)return new Do(t.databaseId,t.key);throw e.createError("Unsupported field value: "+Yr(t))},Uf.prototype.parseArrayTransformElements=function(r,t){var i=this;return t.map(function(t,e){var n=new Ff(df.Argument,r,Ci.EMPTY_PATH);return i.parseData(t,n.childContextForArray(e))})},Uf);function Uf(t){this.preConverter=t}function Qf(t,e,n,r,i,o){this.dataSource=t,this.methodName=e,this.path=n,this.arrayElement=r,void 0===i&&this.validatePath(),this.arrayElement=void 0!==r&&r,this.fieldTransforms=i||[],this.fieldMask=o||[]}function Kf(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof bi||t instanceof vi||t instanceof yi||t instanceof Vf||t instanceof wf)}function jf(t,e,n){if(!Kf(n)||!Hr(n)){n=Yr(n);throw"an object"===n?e.createError(t+" a custom object"):e.createError(t+" "+n)}}function Gf(t,e){if(e instanceof Xl)return e._internalPath;if("string"==typeof e)return Wf(t,e);throw new kr(Ar.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. Field path arguments must be of type string or FieldPath.")}function Wf(t,e){try{return function(e){if(0<=e.search(Jl))throw new kr(Ar.INVALID_ARGUMENT,"Invalid field path ("+e+"). Paths must not contain '~', '*', '/', '[', or ']'");try{return new(Xl.bind.apply(Xl,[void 0].concat(e.split("."))))}catch(t){throw new kr(Ar.INVALID_ARGUMENT,"Invalid field path ("+e+"). Paths must not be empty, begin with '.', end with '.', or contain '..'")}}(e)._internalPath}catch(e){var n=zf(e);throw new kr(Ar.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. "+n)}}function zf(t){return t instanceof Error?t.message:t.toString()}function Hf(){}var Yf,Xf=$c.COLLECTION_DISABLED,Jf=(yp.prototype.isEqual=function(t){return this.host===t.host&&this.ssl===t.ssl&&this.timestampsInSnapshots===t.timestampsInSnapshots&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.forceLongPolling===t.forceLongPolling},yp),$f=(mp.prototype.settings=function(t){if(Fr("Firestore.settings",arguments,1),Ur("Firestore.settings","object",1,t),Or(t,"persistence"))throw new kr(Ar.INVALID_ARGUMENT,'"persistence" is now specified with a separate call to firestore.enablePersistence().');t=new Jf(t);if(this._firestoreClient&&!this._config.settings.isEqual(t))throw new kr(Ar.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only call settings() before calling any other methods on a Firestore object.");void 0!==(this._config.settings=t).credentials&&(this._config.credentials=function(t){if(!t)return new of;switch(t.type){case"gapi":var e=t.client;return Tr(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty),"unexpected gapi interface"),new uf(e,t.sessionIndex||"0");case"provider":return t.client;default:throw new kr(Ar.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}(t.credentials))},mp.prototype.enableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.enableNetwork()},mp.prototype.disableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.disableNetwork()},mp.prototype.enablePersistence=function(t){if(this._firestoreClient)throw new kr(Ar.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only call enablePersistence() before calling any other methods on a Firestore object.");var e=!1;return t&&(void 0!==t.experimentalTabSynchronization&&wr("The 'experimentalTabSynchronization' setting has been renamed to 'synchronizeTabs'. In a future release, the setting will be removed and it is recommended that you update your firestore.enablePersistence() call to use 'synchronizeTabs'."),e=_r(void 0!==t.synchronizeTabs?t.synchronizeTabs:t.experimentalTabSynchronization,!1)),this.configureClient(new zl(this._config.settings.cacheSizeBytes,e))},mp.prototype._clearPersistence=function(){var t=this,n=oh.buildStoragePrefix(this.makeDatabaseInfo()),r=new Zs;return this._queue.enqueueAndForget(function(){return c(t,void 0,void 0,function(){var e;return p(this,function(t){switch(t.label){case 0:if(t.trys.push([0,2,,3]),void 0!==this._firestoreClient&&!this._firestoreClient.clientShutdown)throw new kr(Ar.FAILED_PRECONDITION,"Persistence cannot be cleared while this firestore instance is running.");return[4,oh.clearPersistence(n)];case 1:return t.sent(),r.resolve(),[3,3];case 2:return e=t.sent(),r.reject(e),[3,3];case 3:return[2]}})})}),r.promise},mp.prototype.ensureClientConfigured=function(){return this._firestoreClient||this.configureClient(new jl),this._firestoreClient},mp.prototype.makeDatabaseInfo=function(){return new ui(this._config.databaseId,this._config.persistenceKey,this._config.settings.host,this._config.settings.ssl,this._config.settings.forceLongPolling)},mp.prototype.configureClient=function(t){var r=this;Tr(!!this._config.settings.host,"FirestoreSettings.host cannot be falsey"),Tr(!this._firestoreClient,"configureClient() called multiple times");var e=this.makeDatabaseInfo();return this._dataConverter=new Bf(function(t){if(t instanceof ep){var e=r._config.databaseId,n=t.firestore._config.databaseId;if(!n.isEqual(e))throw new kr(Ar.INVALID_ARGUMENT,"Document reference is for database "+n.projectId+"/"+n.database+" but should be for database "+e.projectId+"/"+e.database);return new Vf(r._config.databaseId,t._key)}return t}),this._firestoreClient=new Hl(Ir.getPlatform(),e,this._config.credentials,this._queue),this._firestoreClient.start(t)},mp.databaseIdFromApp=function(t){t=t.options;if(!Or(t,"projectId"))throw new kr(Ar.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');t=t.projectId;if(!t||"string"!=typeof t)throw new kr(Ar.INVALID_ARGUMENT,"projectId must be a string in FirebaseApp.options");return new Ei(t)},Object.defineProperty(mp.prototype,"app",{get:function(){if(!this._config.firebaseApp)throw new kr(Ar.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._config.firebaseApp},enumerable:!0,configurable:!0}),mp.prototype.collection=function(t){return Fr("Firestore.collection",arguments,1),Ur("Firestore.collection","non-empty string",1,t),this.ensureClientConfigured(),new vp(Ti.fromString(t),this)},mp.prototype.doc=function(t){return Fr("Firestore.doc",arguments,1),Ur("Firestore.doc","non-empty string",1,t),this.ensureClientConfigured(),ep.forPath(Ti.fromString(t),this)},mp.prototype.collectionGroup=function(t){if(Fr("Firestore.collectionGroup",arguments,1),Ur("Firestore.collectionGroup","non-empty string",1,t),0<=t.indexOf("/"))throw new kr(Ar.INVALID_ARGUMENT,"Invalid collection ID '"+t+"' passed to function Firestore.collectionGroup(). Collection IDs must not contain '/'.");return this.ensureClientConfigured(),new op(new Yo(Ti.EMPTY_PATH,t),this)},mp.prototype.runTransaction=function(e){var n=this;return Fr("Firestore.runTransaction",arguments,1),Ur("Firestore.runTransaction","function",1,e),this.ensureClientConfigured().transaction(function(t){return e(new Zf(n,t))})},mp.prototype.batch=function(){return this.ensureClientConfigured(),new tp(this)},Object.defineProperty(mp,"logLevel",{get:function(){switch(gr()){case pr.DEBUG:return"debug";case pr.ERROR:return"error";case pr.SILENT:return"silent";default:return Sr("Unknown log level: "+gr())}},enumerable:!0,configurable:!0}),mp.setLogLevel=function(t){switch(Fr("Firestore.setLogLevel",arguments,1),Ur("Firestore.setLogLevel","non-empty string",1,t),t){case"debug":vr(pr.DEBUG);break;case"error":vr(pr.ERROR);break;case"silent":vr(pr.SILENT);break;default:throw new kr(Ar.INVALID_ARGUMENT,"Invalid log level: "+t)}},mp.prototype._areTimestampsInSnapshotsEnabled=function(){return this._config.settings.timestampsInSnapshots},mp),Zf=(dp.prototype.get=function(t){var e=this;Fr("Transaction.get",arguments,1);var n=Tp("Transaction.get",t,this._firestore);return this._transaction.lookup([n._key]).then(function(t){if(!t||1!==t.length)return Sr("Mismatch in docs returned from document lookup.");t=t[0];if(t instanceof Ai)return new rp(e._firestore,n._key,null,!1,!1);if(t instanceof Ni)return new rp(e._firestore,n._key,t,!1,!1);throw Sr("BatchGetDocumentsRequest returned unexpected document type: "+t.constructor.name)})},dp.prototype.set=function(t,e,n){Br("Transaction.set",arguments,2,3);t=Tp("Transaction.set",t,this._firestore),e=(n=wp("Transaction.set",n)).merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("Transaction.set",e,n.mergeFields):this._firestore._dataConverter.parseSetData("Transaction.set",e);return this._transaction.set(t._key,e),this},dp.prototype.update=function(t,e,n){for(var r,i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return e="string"==typeof e||e instanceof Xl?(Vr("Transaction.update",arguments,3),r=Tp("Transaction.update",t,this._firestore),this._firestore._dataConverter.parseUpdateVarargs("Transaction.update",e,n,i)):(Fr("Transaction.update",arguments,2),r=Tp("Transaction.update",t,this._firestore),this._firestore._dataConverter.parseUpdateData("Transaction.update",e)),this._transaction.update(r._key,e),this},dp.prototype.delete=function(t){Fr("Transaction.delete",arguments,1);t=Tp("Transaction.delete",t,this._firestore);return this._transaction.delete(t._key),this},dp),tp=(pp.prototype.set=function(t,e,n){Br("WriteBatch.set",arguments,2,3),this.verifyNotCommitted();t=Tp("WriteBatch.set",t,this._firestore),e=(n=wp("WriteBatch.set",n)).merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("WriteBatch.set",e,n.mergeFields):this._firestore._dataConverter.parseSetData("WriteBatch.set",e);return this._mutations=this._mutations.concat(e.toMutations(t._key,_a.NONE)),this},pp.prototype.update=function(t,e,n){for(var r,i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return this.verifyNotCommitted(),e="string"==typeof e||e instanceof Xl?(Vr("WriteBatch.update",arguments,3),r=Tp("WriteBatch.update",t,this._firestore),this._firestore._dataConverter.parseUpdateVarargs("WriteBatch.update",e,n,i)):(Fr("WriteBatch.update",arguments,2),r=Tp("WriteBatch.update",t,this._firestore),this._firestore._dataConverter.parseUpdateData("WriteBatch.update",e)),this._mutations=this._mutations.concat(e.toMutations(r._key,_a.exists(!0))),this},pp.prototype.delete=function(t){Fr("WriteBatch.delete",arguments,1),this.verifyNotCommitted();t=Tp("WriteBatch.delete",t,this._firestore);return this._mutations=this._mutations.concat(new Fa(t._key,_a.NONE)),this},pp.prototype.commit=function(){return c(this,void 0,void 0,function(){return p(this,function(t){return this.verifyNotCommitted(),this._committed=!0,0<this._mutations.length?[2,this._firestore.ensureClientConfigured().write(this._mutations)]:[2]})})},pp.prototype.verifyNotCommitted=function(){if(this._committed)throw new kr(Ar.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},pp),ep=(fp.forPath=function(t,e){if(t.length%2!=0)throw new kr(Ar.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+t.canonicalString()+" has "+t.length);return new fp(new Di(t),e)},Object.defineProperty(fp.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(fp.prototype,"parent",{get:function(){return new vp(this._key.path.popLast(),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(fp.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!0,configurable:!0}),fp.prototype.collection=function(t){if(Fr("DocumentReference.collection",arguments,1),Ur("DocumentReference.collection","non-empty string",1,t),!t)throw new kr(Ar.INVALID_ARGUMENT,"Must provide a non-empty collection name to collection()");t=Ti.fromString(t);return new vp(this._key.path.child(t),this.firestore)},fp.prototype.isEqual=function(t){if(!(t instanceof fp))throw $r("isEqual","DocumentReference",1,t);return this.firestore===t.firestore&&this._key.isEqual(t._key)},fp.prototype.set=function(t,e){Br("DocumentReference.set",arguments,1,2);t=(e=wp("DocumentReference.set",e)).merge||e.mergeFields?this.firestore._dataConverter.parseMergeData("DocumentReference.set",t,e.mergeFields):this.firestore._dataConverter.parseSetData("DocumentReference.set",t);return this._firestoreClient.write(t.toMutations(this._key,_a.NONE))},fp.prototype.update=function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];return t="string"==typeof t||t instanceof Xl?(Vr("DocumentReference.update",arguments,2),this.firestore._dataConverter.parseUpdateVarargs("DocumentReference.update",t,e,n)):(Fr("DocumentReference.update",arguments,1),this.firestore._dataConverter.parseUpdateData("DocumentReference.update",t)),this._firestoreClient.write(t.toMutations(this._key,_a.exists(!0)))},fp.prototype.delete=function(){return Fr("DocumentReference.delete",arguments,0),this._firestoreClient.write([new Fa(this._key,_a.NONE)])},fp.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];Br("DocumentReference.onSnapshot",arguments,1,4);var n={includeMetadataChanges:!1},r=0;"object"!=typeof t[r]||pf(t[r])||(Jr("DocumentReference.onSnapshot",n=t[r],["includeMetadataChanges"]),jr("DocumentReference.onSnapshot","boolean","includeMetadataChanges",n.includeMetadataChanges),r++);n={includeMetadataChanges:n.includeMetadataChanges},r=pf(t[r])?t[r]:(Ur("DocumentReference.onSnapshot","function",r,t[r]),Qr("DocumentReference.onSnapshot","function",r+1,t[r+1]),Qr("DocumentReference.onSnapshot","function",r+2,t[r+2]),{next:t[r],error:t[r+1],complete:t[r+2]});return this.onSnapshotInternal(n,r)},fp.prototype.onSnapshotInternal=function(t,n){var r=this,e=function(t){console.error("Uncaught Error in onSnapshot:",t)};n.error&&(e=n.error.bind(n));var i=new Yl({next:function(t){var e;n.next&&(Tr(t.docs.size<=1,"Too many documents returned on a document query"),e=t.docs.get(r._key),n.next(new rp(r.firestore,r._key,e,t.fromCache,t.hasPendingWrites)))},error:e}),o=this._firestoreClient.listen(Yo.atPath(this._key.path),i,t);return function(){i.mute(),r._firestoreClient.unlisten(o)}},fp.prototype.get=function(n){var r=this;return Br("DocumentReference.get",arguments,0,1),Sp("DocumentReference.get",n),new Promise(function(e,t){n&&"cache"===n.source?r.firestore.ensureClientConfigured().getDocumentFromLocalCache(r._key).then(function(t){e(new rp(r.firestore,r._key,t,!0,t instanceof Ni&&t.hasLocalMutations))},t):r.getViaSnapshotListener(e,t,n)})},fp.prototype.getViaSnapshotListener=function(e,n,r){var i=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(t){i(),!t.exists&&t.metadata.fromCache?n(new kr(Ar.UNAVAILABLE,"Failed to get document because the client is offline.")):t.exists&&t.metadata.fromCache&&r&&"server"===r.source?n(new kr(Ar.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):e(t)},error:n})},fp),np=(lp.prototype.isEqual=function(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache},lp),rp=(hp.prototype.data=function(t){return Br("DocumentSnapshot.data",arguments,0,1),t=Ep("DocumentSnapshot.data",t),this._document?this.convertObject(this._document.data,Zi.fromSnapshotOptions(t,this._firestore._areTimestampsInSnapshotsEnabled())):void 0},hp.prototype.get=function(t,e){if(Br("DocumentSnapshot.get",arguments,1,2),e=Ep("DocumentSnapshot.get",e),this._document){t=this._document.data.field(Gf("DocumentSnapshot.get",t));if(void 0!==t)return this.convertValue(t,Zi.fromSnapshotOptions(e,this._firestore._areTimestampsInSnapshotsEnabled()))}},Object.defineProperty(hp.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(hp.prototype,"ref",{get:function(){return new ep(this._key,this._firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(hp.prototype,"exists",{get:function(){return null!==this._document},enumerable:!0,configurable:!0}),Object.defineProperty(hp.prototype,"metadata",{get:function(){return new np(this._hasPendingWrites,this._fromCache)},enumerable:!0,configurable:!0}),hp.prototype.isEqual=function(t){if(!(t instanceof hp))throw $r("isEqual","DocumentSnapshot",1,t);return this._firestore===t._firestore&&this._fromCache===t._fromCache&&this._key.isEqual(t._key)&&(null===this._document?null===t._document:this._document.isEqual(t._document))},hp.prototype.convertObject=function(t,n){var r=this,i={};return t.forEach(function(t,e){i[t]=r.convertValue(e,n)}),i},hp.prototype.convertValue=function(t,e){if(t instanceof Ao)return this.convertObject(t,e);if(t instanceof ko)return this.convertArray(t,e);if(t instanceof Do){var n=t.value(e),r=this._firestore.ensureClientConfigured().databaseId();return t.databaseId.isEqual(r)||wr("Document "+this._key.path+" contains a document reference within a different database ("+t.databaseId.projectId+"/"+t.databaseId.database+") which is not supported. It will be treated as a reference in the current database ("+r.projectId+"/"+r.database+") instead."),new ep(n,this._firestore)}return t.value(e)},hp.prototype.convertArray=function(t,e){var n=this;return t.internalValue.map(function(t){return n.convertValue(t,e)})},hp),ip=(a(cp,Yf=rp),cp.prototype.data=function(t){t=Yf.prototype.data.call(this,t);return Tr("object"==typeof t,"Document in a QueryDocumentSnapshot should exist"),t},cp),op=(up.prototype.where=function(t,e,n){Fr("Query.where",arguments,3),Xr("Query.where",3,n),function(t,e){if(!t.some(function(t){return t===e}))throw new kr(Ar.INVALID_ARGUMENT,"Invalid value "+Yr(e)+" provided to function Query.where() for its "+Zr(2)+" argument. Acceptable values: "+t.join(", "))}(["<","<=","==",">=",">","array-contains"],e);t=Gf("Query.where",t),e=Jo.fromString(e);if(t.isKeyField()){if(e===Jo.ARRAY_CONTAINS)throw new kr(Ar.INVALID_ARGUMENT,"Invalid Query. You can't perform array-contains queries on FieldPath.documentId() since document IDs are not arrays.");if("string"==typeof n){if(""===n)throw new kr(Ar.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a valid document ID if the first parameter is FieldPath.documentId(), but it was an empty string.");if(!this._query.isCollectionGroupQuery()&&-1!==n.indexOf("/"))throw new kr(Ar.INVALID_ARGUMENT,"Invalid third parameter to Query.where(). When querying a collection by FieldPath.documentId(), the value provided must be a plain document ID, but '"+n+"' contains a slash.");var r=this._query.path.child(Ti.fromString(n));if(!Di.isDocumentKey(r))throw new kr(Ar.INVALID_ARGUMENT,"Invalid third parameter to Query.where(). When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '"+r+"' is not because it has an odd number of segments ("+r.length+").");r=new Do(this.firestore._databaseId,new Di(r))}else{if(!(n instanceof ep))throw new kr(Ar.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a string or a DocumentReference if the first parameter is FieldPath.documentId(), but it was: "+Yr(n)+".");r=new Do(this.firestore._databaseId,n._key)}}else r=this.firestore._dataConverter.parseQueryValue("Query.where",n);r=Xo.create(t,e,r);return this.validateNewFilter(r),new up(this._query.addFilter(r),this.firestore)},up.prototype.orderBy=function(t,e){if(Br("Query.orderBy",arguments,1,2),Qr("Query.orderBy","non-empty string",2,e),void 0===e||"asc"===e)n=ea.ASCENDING;else{if("desc"!==e)throw new kr(Ar.INVALID_ARGUMENT,"Function Query.orderBy() has unknown direction '"+e+"', expected 'asc' or 'desc'.");n=ea.DESCENDING}if(null!==this._query.startAt)throw new kr(Ar.INVALID_ARGUMENT,"Invalid query. You must not call Query.startAt() or Query.startAfter() before calling Query.orderBy().");if(null!==this._query.endAt)throw new kr(Ar.INVALID_ARGUMENT,"Invalid query. You must not call Query.endAt() or Query.endBefore() before calling Query.orderBy().");var t=Gf("Query.orderBy",t),n=new ra(t,n);return this.validateNewOrderBy(n),new up(this._query.addOrderBy(n),this.firestore)},up.prototype.limit=function(t){if(Fr("Query.limit",arguments,1),Ur("Query.limit","number",1,t),t<=0)throw new kr(Ar.INVALID_ARGUMENT,"Invalid Query. Query limit ("+t+") is invalid. Limit must be positive.");return new up(this._query.withLimit(t),this.firestore)},up.prototype.startAt=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];Vr("Query.startAt",arguments,1);t=this.boundFromDocOrFields("Query.startAt",t,e,!0);return new up(this._query.withStartAt(t),this.firestore)},up.prototype.startAfter=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];Vr("Query.startAfter",arguments,1);t=this.boundFromDocOrFields("Query.startAfter",t,e,!1);return new up(this._query.withStartAt(t),this.firestore)},up.prototype.endBefore=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];Vr("Query.endBefore",arguments,1);t=this.boundFromDocOrFields("Query.endBefore",t,e,!0);return new up(this._query.withEndAt(t),this.firestore)},up.prototype.endAt=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];Vr("Query.endAt",arguments,1);t=this.boundFromDocOrFields("Query.endAt",t,e,!1);return new up(this._query.withEndAt(t),this.firestore)},up.prototype.isEqual=function(t){if(!(t instanceof up))throw $r("isEqual","Query",1,t);return this.firestore===t.firestore&&this._query.isEqual(t._query)},up.prototype.boundFromDocOrFields=function(t,e,n,r){if(Xr(t,1,e),e instanceof rp){if(0<n.length)throw new kr(Ar.INVALID_ARGUMENT,"Too many arguments provided to "+t+"().");var i=e;if(!i.exists)throw new kr(Ar.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+t+"().");return this.boundFromDocument(t,i._document,r)}n=[e].concat(n);return this.boundFromFields(t,n,r)},up.prototype.boundFromDocument=function(t,e,n){for(var r=[],i=0,o=this._query.orderBy;i<o.length;i++){var a=o[i];if(a.field.isKeyField())r.push(new Do(this.firestore._databaseId,e.key));else{var s=e.field(a.field);if(s instanceof Io)throw new kr(Ar.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+a.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(void 0===s){a=a.field.canonicalString();throw new kr(Ar.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+a+"' (used as the orderBy) does not exist.")}r.push(s)}}return new na(r,n)},up.prototype.boundFromFields=function(t,e,n){var r=this._query.explicitOrderBy;if(e.length>r.length)throw new kr(Ar.INVALID_ARGUMENT,"Too many arguments provided to "+t+"(). The number of arguments must be less than or equal to the number of Query.orderBy() clauses");for(var i=[],o=0;o<e.length;o++){var a=e[o];if(r[o].field.isKeyField()){if("string"!=typeof a)throw new kr(Ar.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+t+"(), but got a "+typeof a);if(!this._query.isCollectionGroupQuery()&&-1!==a.indexOf("/"))throw new kr(Ar.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to "+t+"() must be a plain document ID, but '"+a+"' contains a slash.");var s=this._query.path.child(Ti.fromString(a));if(!Di.isDocumentKey(s))throw new kr(Ar.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to "+t+"() must result in a valid document path, but '"+s+"' is not because it contains an odd number of segments.");s=new Di(s);i.push(new Do(this.firestore._databaseId,s))}else{a=this.firestore._dataConverter.parseQueryValue(t,a);i.push(a)}}return new na(i,n)},up.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];Br("Query.onSnapshot",arguments,1,4);var n={},r=0;return"object"!=typeof t[r]||pf(t[r])||(Jr("Query.onSnapshot",n=t[r],["includeMetadataChanges"]),jr("Query.onSnapshot","boolean","includeMetadataChanges",n.includeMetadataChanges),r++),r=pf(t[r])?t[r]:(Ur("Query.onSnapshot","function",r,t[r]),Qr("Query.onSnapshot","function",r+1,t[r+1]),Qr("Query.onSnapshot","function",r+2,t[r+2]),{next:t[r],error:t[r+1],complete:t[r+2]}),this.onSnapshotInternal(n,r)},up.prototype.onSnapshotInternal=function(t,e){var n=this,r=function(t){console.error("Uncaught Error in onSnapshot:",t)};e.error&&(r=e.error.bind(e));var i=new Yl({next:function(t){e.next&&e.next(new ap(n.firestore,n._query,t))},error:r}),o=this.firestore.ensureClientConfigured(),a=o.listen(this._query,i,t);return function(){i.mute(),o.unlisten(a)}},up.prototype.get=function(n){var r=this;return Br("Query.get",arguments,0,1),Sp("Query.get",n),new Promise(function(e,t){n&&"cache"===n.source?r.firestore.ensureClientConfigured().getDocumentsFromLocalCache(r._query).then(function(t){e(new ap(r.firestore,r._query,t))},t):r.getViaSnapshotListener(e,t,n)})},up.prototype.getViaSnapshotListener=function(e,n,r){var i=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(t){i(),t.metadata.fromCache&&r&&"server"===r.source?n(new kr(Ar.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):e(t)},error:n})},up.prototype.validateNewFilter=function(t){if(t instanceof $o)if(t.isInequality()){var e=this._query.getInequalityFilterField();if(null!==e&&!e.isEqual(t.field))throw new kr(Ar.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, >, or >=) must be on the same field. But you have inequality filters on '"+e.toString()+"' and '"+t.field.toString()+"'");e=this._query.getFirstOrderByField();null!==e&&this.validateOrderByAndInequalityMatch(t.field,e)}else if(t.op===Jo.ARRAY_CONTAINS&&this._query.hasArrayContainsFilter())throw new kr(Ar.INVALID_ARGUMENT,"Invalid query. Queries only support a single array-contains filter.")},up.prototype.validateNewOrderBy=function(t){var e;null!==this._query.getFirstOrderByField()||null!==(e=this._query.getInequalityFilterField())&&this.validateOrderByAndInequalityMatch(e,t.field)},up.prototype.validateOrderByAndInequalityMatch=function(t,e){if(!e.isEqual(t))throw new kr(Ar.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, >, or >=) on field '"+t.toString()+"' and so you must also use '"+t.toString()+"' as your first Query.orderBy(), but your first Query.orderBy() is on field '"+e.toString()+"' instead.")},up),ap=(Object.defineProperty(sp.prototype,"docs",{get:function(){var e=[];return this.forEach(function(t){return e.push(t)}),e},enumerable:!0,configurable:!0}),Object.defineProperty(sp.prototype,"empty",{get:function(){return this._snapshot.docs.isEmpty()},enumerable:!0,configurable:!0}),Object.defineProperty(sp.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!0,configurable:!0}),sp.prototype.forEach=function(e,n){var r=this;Br("QuerySnapshot.forEach",arguments,1,2),Ur("QuerySnapshot.forEach","function",1,e),this._snapshot.docs.forEach(function(t){e.call(n,r.convertToDocumentImpl(t))})},Object.defineProperty(sp.prototype,"query",{get:function(){return new op(this._originalQuery,this._firestore)},enumerable:!0,configurable:!0}),sp.prototype.docChanges=function(t){t&&(Jr("QuerySnapshot.docChanges",t,["includeMetadataChanges"]),jr("QuerySnapshot.docChanges","boolean","includeMetadataChanges",t.includeMetadataChanges));t=!(!t||!t.includeMetadataChanges);if(t&&this._snapshot.excludesMetadataChanges)throw new kr(Ar.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(i,e,o){if(o.oldDocs.isEmpty()){var n,r=0;return o.docChanges.map(function(t){var e=new ip(i,t.doc.key,t.doc,o.fromCache,o.mutatedKeys.has(t.doc.key));return Tr(t.type===ls.Added,"Invalid event type for first snapshot"),Tr(!n||o.query.docComparator(n,t.doc)<0,"Got added events in wrong order"),n=t.doc,{type:"added",doc:e,oldIndex:-1,newIndex:r++}})}var a=o.oldDocs;return o.docChanges.filter(function(t){return e||t.type!==ls.Metadata}).map(function(t){var e=new ip(i,t.doc.key,t.doc,o.fromCache,o.mutatedKeys.has(t.doc.key)),n=-1,r=-1;return t.type!==ls.Added&&(Tr(0<=(n=a.indexOf(t.doc.key)),"Index for document not found"),a=a.delete(t.doc.key)),t.type!==ls.Removed&&(r=(a=a.add(t.doc)).indexOf(t.doc.key)),{type:function(t){switch(t){case ls.Added:return"added";case ls.Modified:case ls.Metadata:return"modified";case ls.Removed:return"removed";default:return Sr("Unknown change type: "+t)}}(t.type),doc:e,oldIndex:n,newIndex:r}})}(this._firestore,t,this._snapshot),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges},sp.prototype.isEqual=function(t){if(!(t instanceof sp))throw $r("isEqual","QuerySnapshot",1,t);return this._firestore===t._firestore&&this._originalQuery.isEqual(t._originalQuery)&&this._snapshot.isEqual(t._snapshot)},sp.prototype.convertToDocumentImpl=function(t){return new ip(this._firestore,t.key,t,this.metadata.fromCache,this._snapshot.mutatedKeys.has(t.key))},sp);function sp(t,e,n){this._firestore=t,this._originalQuery=e,this._snapshot=n,this._cachedChanges=null,this._cachedChangesIncludeMetadataChanges=null,this.metadata=new np(n.hasPendingWrites,n.fromCache)}function up(t,e){this._query=t,this.firestore=e}function cp(t,e,n,r,i){return Yf.call(this,t,e,n,r,i)||this}function hp(t,e,n,r,i){this._firestore=t,this._key=e,this._document=n,this._fromCache=r,this._hasPendingWrites=i}function lp(t,e){this.hasPendingWrites=t,this.fromCache=e}function fp(t,e){this._key=t,this.firestore=e,this._firestoreClient=this.firestore.ensureClientConfigured()}function pp(t){this._firestore=t,this._mutations=[],this._committed=!1}function dp(t,e){this._firestore=t,this._transaction=e}function mp(t){var e=this;this._queue=new iu,this.INTERNAL={delete:function(){return c(e,void 0,void 0,function(){return p(this,function(t){switch(t.label){case 0:return this.ensureClientConfigured(),[4,this._firestoreClient.shutdown()];case 1:return t.sent(),[2]}})})}};var n=new Hf;if("object"==typeof t.options){var r=t;n.firebaseApp=r,n.databaseId=mp.databaseIdFromApp(r),n.persistenceKey=n.firebaseApp.name,n.credentials=new af(r)}else{t=t;if(!t.projectId)throw new kr(Ar.INVALID_ARGUMENT,"Must provide projectId");n.databaseId=new Ei(t.projectId,t.database),n.persistenceKey="[DEFAULT]",n.credentials=new of}n.settings=new Jf({}),this._config=n,this._databaseId=n.databaseId}function yp(t){if(void 0===t.host){if(void 0!==t.ssl)throw new kr(Ar.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else Kr("settings","non-empty string","host",t.host),this.host=t.host,jr("settings","boolean","ssl",t.ssl),this.ssl=_r(t.ssl,!0);if(Jr("settings",t,["host","ssl","credentials","timestampsInSnapshots","cacheSizeBytes","experimentalForceLongPolling"]),jr("settings","object","credentials",t.credentials),this.credentials=t.credentials,jr("settings","boolean","timestampsInSnapshots",t.timestampsInSnapshots),!0===t.timestampsInSnapshots?wr("\n  The timestampsInSnapshots setting now defaults to true and you no\n  longer need to explicitly set it. In a future release, the setting\n  will be removed entirely and so it is recommended that you remove it\n  from your firestore.settings() call now."):!1===t.timestampsInSnapshots&&wr("\n  The timestampsInSnapshots setting will soon be removed. YOU MUST UPDATE\n  YOUR CODE.\n\n  To hide this warning, stop using the timestampsInSnapshots setting in your\n  firestore.settings({ ... }) call.\n\n  Once you remove the setting, Timestamps stored in Cloud Firestore will be\n  read back as Firebase Timestamp objects instead of as system Date objects.\n  So you will also need to update code expecting a Date to instead expect a\n  Timestamp. For example:\n\n  // Old:\n  const date = snapshot.get('created_at');\n  // New:\n  const timestamp = snapshot.get('created_at'); const date =\n  timestamp.toDate();\n\n  Please audit all existing usages of Date when you enable the new\n  behavior."),this.timestampsInSnapshots=_r(t.timestampsInSnapshots,!0),jr("settings","number","cacheSizeBytes",t.cacheSizeBytes),void 0===t.cacheSizeBytes)this.cacheSizeBytes=$c.DEFAULT_CACHE_SIZE_BYTES;else{if(t.cacheSizeBytes!==Xf&&t.cacheSizeBytes<$c.MINIMUM_CACHE_SIZE_BYTES)throw new kr(Ar.INVALID_ARGUMENT,"cacheSizeBytes must be at least "+$c.MINIMUM_CACHE_SIZE_BYTES);this.cacheSizeBytes=t.cacheSizeBytes}jr("settings","boolean","experimentalForceLongPolling",t.experimentalForceLongPolling),this.forceLongPolling=void 0!==t.experimentalForceLongPolling&&t.experimentalForceLongPolling}["length","forEach","map"].concat("undefined"!=typeof Symbol?[Symbol.iterator]:[]).forEach(function(t){try{Object.defineProperty(ap.prototype.docChanges,t,{get:function(){throw new kr(Ar.INVALID_ARGUMENT,'QuerySnapshot.docChanges has been changed from a property into a method, so usages like "querySnapshot.docChanges" should become "querySnapshot.docChanges()"')}})}catch(t){}});var gp,vp=(a(bp,gp=op),Object.defineProperty(bp.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(bp.prototype,"parent",{get:function(){var t=this._query.path.popLast();return t.isEmpty()?null:new ep(new Di(t),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(bp.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!0,configurable:!0}),bp.prototype.doc=function(t){if(Br("CollectionReference.doc",arguments,0,1),Ur("CollectionReference.doc","non-empty string",1,t=0===arguments.length?ei.newId():t),""===t)throw new kr(Ar.INVALID_ARGUMENT,"Document path must be a non-empty string");t=Ti.fromString(t);return ep.forPath(this._query.path.child(t),this.firestore)},bp.prototype.add=function(t){Fr("CollectionReference.add",arguments,1),Ur("CollectionReference.add","object",1,t);var e=this.doc();return e.set(t).then(function(){return e})},bp);function bp(t,e){e=gp.call(this,Yo.atPath(t),e)||this;if(t.length%2!=1)throw new kr(Ar.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+t.canonicalString()+" has "+t.length);return e}function wp(t,e){if(void 0===e)return{merge:!1};if(Jr(t,e,["merge","mergeFields"]),jr(t,"boolean","merge",e.merge),Gr(t,"mergeFields","a string or a FieldPath",e.mergeFields,function(t){return"string"==typeof t||t instanceof Xl}),void 0!==e.mergeFields&&void 0!==e.merge)throw new kr(Ar.INVALID_ARGUMENT,"Invalid options passed to function "+t+'(): You cannot specify both "merge" and "mergeFields".');return e}function Ep(t,e){return void 0===e?{}:(Jr(t,e,["serverTimestamps"]),Wr(t,0,"serverTimestamps",e.serverTimestamps,["estimate","previous","none"]),e)}function Sp(t,e){Qr(t,"object",1,e),e&&(Jr(t,e,["source"]),Wr(t,0,"source",e.source,["default","server","cache"]))}function Tp(t,e,n){if(e instanceof ep){if(e.firestore!==n)throw new kr(Ar.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}throw $r(t,"DocumentReference",1,e)}var ne=Mr($f,"Use firebase.firestore() instead."),re=Mr(Zf,"Use firebase.firestore().runTransaction() instead."),rr=Mr(tp,"Use firebase.firestore().batch() instead."),t=Mr(ep,"Use firebase.firestore().doc() instead."),Ip=Mr(rp),s=Mr(ip),et=Mr(op),_i=Mr(ap),er=Mr(vp,"Use firebase.firestore().collection() instead."),Cp={Firestore:ne,GeoPoint:vi,Timestamp:bi,Blob:gi,Transaction:re,WriteBatch:rr,DocumentReference:t,DocumentSnapshot:Ip,Query:et,QueryDocumentSnapshot:s,QuerySnapshot:_i,CollectionReference:er,FieldPath:Xl,FieldValue:se,setLogLevel:$f.setLogLevel,CACHE_SIZE_UNLIMITED:Xf};Dp.INTERNAL.registerService("firestore",function(t){return new $f(t)},function(t){Tr("object"==typeof t,"shallowCopy() expects object parameter.");var e,n={};for(e in t)Object.prototype.hasOwnProperty.call(t,e)&&(n[e]=t[e]);return n}(Cp))}.apply(this,arguments)}catch(t){throw console.error(t),new Error("Cannot instantiate firebase-firestore - be sure to load firebase-app.js first.")}});
