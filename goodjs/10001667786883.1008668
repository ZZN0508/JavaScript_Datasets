define(["jquery","OK/utils/throttle"],function(c,u){"use strict";var h=[];function v(t,e){this.el=t[0],this.lockDelay=e,this._onLockTimeout=this._onLockTimeout.bind(this)}function t(){this.interval=null}return v.prototype={hide:function(){this.locked||(this.lockDelay?this.lock():this.setHidden(!0))},setHidden:function(t){this.el&&this.el.classList.toggle("hidden",t)},setLocked:function(t){this.locked=t,this.el&&this.el.classList.toggle("__lock",t)},lock:function(){this.setLocked(!0),this.lockTimeout=setTimeout(this._onLockTimeout,this.lockDelay)},unlock:function(){this.locked&&(this.setLocked(!1),this.lockTimeout&&(clearTimeout(this.lockTimeout),this.lockTimeout=0))},_onLockTimeout:function(){this.lockTimeout=0,this.unlock(),this.setHidden(!0)},show:function(){this.locked&&this.unlock(),this.setHidden(!1)},onClick:function(t){this.el&&(this.callback=t,this.el.addEventListener("click",this))},handleEvent:function(t){"click"===t.type&&!this.locked&&this.callback&&this.callback()},destroy:function(){this.el&&(this.callback&&(this.el.removeEventListener("click",this),this.callback=null),this.el=null)}},t.prototype={activate:function(t){var i=this,e=i.$el=c(t);i.$content=e.find(".uslider_cnt");var l=e.attr("data-type");i.isCarousel=null!=l&&"carousel"==l;var s=e.attr("data-play");i.autoplay=null!=s&&"auto"==s;var o=e.attr("data-customEvent");i.customEvent=null!=o&&"true"==o;var n=e.attr("data-delete-enabled");i.intervalTime=e.attr("data-interval");var a=+e.attr("data-lock-delay-of-scrolling-end")||0,l=e.attr("data-in-layer");i.inLayer=null!=l&&"true"==l;s=e.attr("data-loop");i.loop=null!=s&&"true"==s,i.autoPlayForward=!0;o=e.attr("data-gap");i.options={gap:o?parseInt(o):6},i.isCarousel&&(i.options.gap=0);var l=i.$nextBtn=new v(e.find(".uslider_ctrl.__next"),a),s=i.$prevBtn=new v(e.find(".uslider_ctrl.__prev"),a),r=i.$container=e.find(".uslider_hld"),o=e.attr("data-slide-width"),a=r.children();i.slideWidth=o||c(a[0]).outerWidth(!0);o=e.attr("data-visibleSlides");i.maxVisibleSlides=i.calcVisibleSlides(),i.visibleSlides=o?parseInt(o):i.maxVisibleSlides,e.attr("data-visibleSlides",i.visibleSlides);o=e.attr("data-ring");i.ring=null!=o&&"true"==o&&a.length>=4*i.visibleSlides;o=e.attr("data-ring-manual-init-transform");i.ringManualInitTransform=null!=o&&"true"==o;o=e.attr("data-resizable");i.resizable=void 0!==o&&"true"===o;o=e.attr("data-manualButtonOffset");if(i.buttonOffset=o?parseInt(o):Math.floor((i.$content.outerWidth()-i.visibleSlides*i.slideWidth)/2),i.totalSlides=a.length,i.offset=0,i.ring){if(l.show(),s.show(),i.offset=i.visibleSlides,!i.ringManualInitTransform){r.addClass("__noanim");for(var d=Math.min(Math.floor((i.totalSlides-i.visibleSlides)/3),i.visibleSlides),f=r[0];0<d--;)f.insertBefore(f.lastChild,f.firstChild);i.setTransalateX(i.offset*i.slideWidth-i.buttonOffset),setTimeout(function(){r.removeClass("__noanim")},50)}}else i.scrollToOffset();l.onClick(function(){i.handleClick(!0),i.resetAutoPlayInterval()}),s.onClick(function(){i.handleClick(!1),i.resetAutoPlayInterval()}),e.on("uSliderUpdateCount",function(t){var e=t.originalEvent.detail;switch(e.type){case"remove":i.deleteItem(!0);break;case"append":i.updateCount(),void 0!==e.offset?i.setOffset(e.offset):i.scrollToOffset()}}),e.on("uSliderClick",function(t){i.handleClick(t.originalEvent.detail.forward),i.resetAutoPlayInterval()}),r.on("transitionend.slider",function(t){t.target===r[0]&&i.createCustomSlideEvent("slideend")}),i.autoplay&&1<i.totalSlides&&(e.hover(function(){clearInterval(i.interval)},function(){i.autoPlay()}),i.autoPlay()),n&&r.on("click.slide",".js-delete-item",function(){i.deleteItem(!1)}),i.resizable&&(i.isOldLayoutIsSmall=c(window).width()<1274,c(window).on("resize.slider",u(200,function(){i.resizeHandler()}))),-1===h.indexOf(t)&&h.push(t)},calcVisibleSlides:function(){return Math.floor((this.$content.outerWidth()+2*this.options.gap)/this.slideWidth)},updateCount:function(){this.totalSlides=this.$container.children().length},setOffset:function(t){var e,i=this.totalSlides-this.visibleSlides;switch(t){case"start":e=0;break;case"end":e=i;break;default:(e=(e=t)>i?i:e)<0&&(e=0)}this.offset=e,this.scrollToOffset()},deactivate:function(t){var e=this.$el;e.find(".uslider_ctrl").off(".slider"),e.off("uSliderUpdateCount"),e.off("uSliderClick"),clearInterval(this.interval),this.$nextBtn&&(this.$nextBtn.destroy(),this.$nextBtn=null),this.$prevBtn&&(this.$prevBtn.destroy(),this.$prevBtn=null);t=h.indexOf(t);-1!==t&&h.splice(t,1),h.length||this.resizable&&c(window).off("resize.slider")},setTransalateX:function(t){t="translateX(-"+t+"px)";this.$container[0].style.cssText="transform: "+t+"; -webkit-transform: "+t+"; -moz-transform: "+t+"; -ms-transform: "+t+";"},createCustomSlideEvent:function(t,e){var i=this;i.customEvent&&"function"==typeof CustomEvent&&i.$el[0].dispatchEvent(new CustomEvent("uSliderAction",{bubbles:!0,detail:{offset:i.offset,totalSlides:i.totalSlides,visibleSlides:i.visibleSlides,container:i.$container[0],action:t,data:e||null}}))},handleClick:function(t){var e=this;e.isCarousel&&e.offset==e.totalSlides-1&&t?e.offset=0:t?e.offset+=e.offset+e.visibleSlides<e.totalSlides-e.visibleSlides?e.visibleSlides:e.totalSlides-(e.offset+e.visibleSlides):e.offset-=0<e.offset-e.visibleSlides?e.visibleSlides:e.offset,e.scrollToOffset(),e.createCustomSlideEvent("slide")},scrollToOffset:function(){var t=this,e=t.$container,i=t.$nextBtn,l=t.$prevBtn;if(t.ring&&(t.offset<1||t.offset>=t.totalSlides-t.visibleSlides)){e.addClass("__noanim");var s=e[0],o=Math.min(Math.floor((t.totalSlides-t.visibleSlides)/3),t.visibleSlides),n=o;if(t.offset<1)for(;0<n--;)t.createCustomSlideEvent("moveFromRightToLeft",s.lastChild),s.insertBefore(s.lastChild,s.firstChild);else for(o=-o;0<n--;)t.createCustomSlideEvent("moveFromLeftToRight",s.firstChild),s.appendChild(s.removeChild(s.firstChild));return t.offset+=o,t.setTransalateX((t.offset+o)*t.slideWidth-t.buttonOffset),void setTimeout(function(){e.removeClass("__noanim"),t.setTransalateX(t.offset*t.slideWidth-t.buttonOffset)},50)}t.offset<1?(l.hide(),!(t.visibleSlides<t.totalSlides)||t.maxVisibleSlides>t.visibleSlides&&t.maxVisibleSlides>=t.totalSlides?i.hide():i.show(),t.setTransalateX(t.offset*t.slideWidth+t.options.gap)):t.offset<t.totalSlides-t.visibleSlides?(l.show(),i.show(),t.setTransalateX(t.offset*t.slideWidth-t.buttonOffset)):(l.show(),i.hide(),t.setTransalateX(t.offset*t.slideWidth-2*t.buttonOffset-t.options.gap))},autoPlay:function(){var e=this;e.interval=setInterval(function(){var t=e.$content.offset().top;OK.Layers.isAnyLayerOpened()&&!e.inLayer||c(window).scrollTop()>t||(e.loop?(t=e.offset,e.handleClick(e.autoPlayForward),t===e.offset&&e.handleClick(e.autoPlayForward=!e.autoPlayForward)):e.handleClick(!0))},e.intervalTime)},resetAutoPlayInterval:function(){this.autoplay&&clearInterval(this.interval)},deleteItem:function(t){var e=this;e.totalSlides=t?e.$container.children().length:e.$container.children().length-1;t=e.offset;e.offset+e.visibleSlides>e.totalSlides&&(e.offset=0<e.offset?--t:t),e.scrollToOffset(),e.createCustomSlideEvent("remove")},resizeHandler:function(){var t=this,e=c(window).width()<1274;if(t.isOldLayoutIsSmall===e)return!1;t.isOldLayoutIsSmall=e,t.offset=0,t.visibleSlides=Math.floor((t.$content.outerWidth()+2*t.options.gap)/t.slideWidth);e=t.$el.attr("data-manualButtonOffset");t.buttonOffset=e?parseInt(e):Math.floor((t.$content.outerWidth()-t.visibleSlides*t.slideWidth)/2),t.scrollToOffset()}},t});
