(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{470:function(e,n,t){function i(e){if(s[e])return s[e].exports;var n=s[e]={i:e,l:!1,exports:{}};return r[e].call(n.exports,n,n.exports,i),n.l=!0,n.exports}var r,s;e.exports=(r=[function(e,n){e.exports=t(3)},function(e,n){e.exports=t(1)},function(e,n){e.exports=t(204)},function(e,n){e.exports=t(206)},function(e,n){e.exports=t(181)},function(e,n){e.exports=t(130)},function(e,n){e.exports=t(92)},function(e,n){e.exports=t(469)},function(e,n){e.exports=t(468)},function(e,n){e.exports=t(179)},function(e,n){e.exports=t(205)},function(e,n){e.exports=t(203)},function(e,n){e.exports=t(212)},function(e,n){e.exports=t(180)},function(e,n){e.exports=t(117)},function(e,n){e.exports=t(242)},function(e,n){e.exports=t(213)},function(e,n,t){"use strict";t.r(n);function f(){var i=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;o()(this,f),u()(this,"unseenMailsNumber",void 0),u()(this,"isInterrupted",void 0),u()(this,"subscribers",void 0),u()(this,"lastId",void 0),u()(this,"pollIntervalId",void 0),u()(this,"timeoutIntervalId",void 0),u()(this,"ws",void 0),u()(this,"isRms",void 0),u()(this,"load",p()(m.a.mark(function e(){var n,t,r;return m.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,i.fetchMailboxFolders();case 3:t=e.sent,r=t.mailbox,n=r.unseen_incoming,t=r.rms,r=r.ws,i.isRms=Boolean(t),i.isInterrupted||(i.unseenMailsNumber=n,i.emit(),null===i.timeoutIntervalId&&(i.timeoutIntervalId=setInterval(i.load,t?36e5:3e5)),r&&!i.ws&&(i.connectToWS(),i.clearPollInterval())),e.next=16;break;case 12:e.prev=12,e.t0=e.catch(0),i.isInterrupted||(i.unseenMailsNumber=0),null===i.pollIntervalId&&(i.pollIntervalId=setInterval(i.load,12e4));case 16:case"end":return e.stop()}},e,null,[[0,12]])}))),u()(this,"subscribe",function(e){return i.lastId+=1,i.subscribers[i.lastId]=e,function(){return delete i.subscribers[i.lastId]}}),u()(this,"emit",function(){var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:i.unseenMailsNumber;i.unseenMailsNumber=n,Object.keys(i.subscribers).forEach(function(e){return i.subscribers[e](n)})}),u()(this,"interrupt",function(){i.unsubscribe(),i.isInterrupted=!0}),u()(this,"unsubscribe",function(){i.ws&&i.ws.close(),i.clearPollInterval(),i.clearTimeoutInterval()}),u()(this,"onmessage",function(e){e=JSON.parse(e.data).payload;e&&"object"===s()(e)&&O.includes(e.box)||e.dst&&O.includes(e.dst.box)||(i.isRms?i.unseenMailsNumber+=e.unseen_delta||0:i.load(),i.emit(i.unseenMailsNumber))}),u()(this,"connectToWS",function(){i.ws&&i.ws.close(),i.ws=E("wss://mail.rambler.ru/ws",i.onmessage,function(e){i.ws=e})}),u()(this,"clearPollInterval",function(){null!==i.pollIntervalId&&(clearInterval(i.pollIntervalId),i.pollIntervalId=null)}),u()(this,"clearTimeoutInterval",function(){null!==i.pollIntervalId&&(clearInterval(i.timeoutIntervalId),i.timeoutIntervalId=null)}),u()(this,"fetchMailboxFolders",p()(m.a.mark(function e(){var n,t;return m.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch("https://mail.rambler.ru/rpc",{method:"POST",credentials:"include",headers:{"x-rambler-mail-client-version":"1.0.0","x-rambler-mail-client-type":"unseen_mails_counter","x-rambler-mail-method":"Rambler::Mail::get_mailbox_folders","content-type":"application/json; charset=utf-8"},body:JSON.stringify({jsonrpc:"2.0",method:"Rambler::Mail::get_mailbox_folders",params:[{create_system_folders:!1}],id:d()})});case 2:return n=e.sent,e.next=5,n.json();case 5:if(t=e.sent,(t=t.result).error)throw new Error;e.next=9;break;case 9:return e.abrupt("return",t);case 10:case"end":return e.stop()}},e)}))),this.unseenMailsNumber=e,this.subscribers={},this.lastId=0,this.pollIntervalId=null,this.timeoutIntervalId=null,this.ws=null,this.isInterrupted=!1}var l,r=t(2),m=t.n(r),r=(t(4),t(3)),p=t.n(r),r=t(6),b=t.n(r),w=t(1),I=t.n(w),r=(t(9),t(10),t(11),t(5),t(12),t(13),t(7)),s=t.n(r),r=t(8),o=t.n(r),r=t(0),u=t.n(r),i=(t(14),t(15),t(16),Math.random().toString(36).slice(2)),a=0,c=0,d=function(){var e=Date.now();return c<e&&(c=e,a=0),"".concat(i,"-").concat(c,"-").concat(a)},v={FIRST_CONNECTION_DELAY:1e3,REJECTION_CODE:1008,GROWTH_FACTOR:1.5,MAX_ATTEMPTS:5},h=v.FIRST_CONNECTION_DELAY,x=!0,M=0,E=function e(n,t){function r(){x&&(l=setTimeout(function(){i(e(n,t,i,s)),(M+=1)>=s.MAX_ATTEMPTS&&(x=!1),h*=s.GROWTH_FACTOR},h))}var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:function(){},s=3<arguments.length&&void 0!==arguments[3]?arguments[3]:v,o=new WebSocket(n);return o.onopen=function(){return clearTimeout(l)},o.onclose=function(e){e.code===s.REJECTION_CODE&&(x=!1),r()},o.onerror=r,o.onmessage=t,o},O=["Spam","SentBox","DraftBox","Trash"];n.default=function(e){var n=e.style,t=e.collapseBigNumbers,r=e.renderZero,i=e.className,s=e.renderString,o=e.onChange,l=e.children,u=e.unseenMailsNumber,e=Object(w.useState)(null),e=b()(e,2),a=e[0],c=e[1],d=Object(w.useRef)();Object(w.useEffect)(function(){function e(){return(e=p()(m.a.mark(function e(){var n,t;return m.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=!window.unseenMailsEmitter,t=!!u,n?window.unseenMailsEmitter=new f(u):t&&window.unseenMailsEmitter.interrupt(),!t){e.next=7;break}window.unseenMailsEmitter.emit(u),e.next=14;break;case 7:if(n)return e.next=10,window.unseenMailsEmitter.load();e.next=10;break;case 10:d.current=window.unseenMailsEmitter.subscribe(c),c(window.unseenMailsEmitter.unseenMailsNumber),window.ramblerIdHelper=window.ramblerIdHelper||[],window.ramblerIdHelper.push(function(){window.ramblerIdHelper.addListener("login",window.unseenMailsEmitter.load),window.ramblerIdHelper.addListener("oauthlogin",window.unseenMailsEmitter.load)});case 14:case"end":return e.stop()}},e)}))).apply(this,arguments)}return function(){e.apply(this,arguments)}(),function(){u?(window.unseenMailsEmitter.isInterrupted=!1,window.unseenMailsEmitter.load()):(d.current&&d.current(),window.ramblerIdHelper.push(function(){window.ramblerIdHelper.removeListener("login",window.unseenMailsEmitter.load),window.ramblerIdHelper.removeListener("oauthlogin",window.unseenMailsEmitter.load)}))}},[]),Object(w.useEffect)(function(){window.unseenMailsEmitter.emit(u)},[u]),Object(w.useEffect)(function(){o&&null!==a&&o(a)},[o,a]);e=u||a;if(null===e)return null;if(Object(w.isValidElement)(l))return I.a.cloneElement(l,{counter:e});if(!r&&0===e)return null;e=t&&99<e?"99+":"".concat(e);return s?I.a.createElement(I.a.Fragment,null,e):I.a.createElement("span",{className:i||"",style:n},e)}}],s={},i.m=r,i.c=s,i.d=function(e,n,t){i.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:t})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(n,e){if(1&e&&(n=i(n)),8&e)return n;if(4&e&&"object"==typeof n&&n&&n.__esModule)return n;var t=Object.create(null);if(i.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:n}),2&e&&"string"!=typeof n)for(var r in n)i.d(t,r,function(e){return n[e]}.bind(null,r));return t},i.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(n,"a",n),n},i.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},i.p="",i(i.s=17))}}]);
