define(["OK/utils/utils"],(function(n){"use strict";var e=n.deferred(),i=[];return{activate:function(n){e.resolve(n)},listen:function(n,i,t){e.promise.then((function(e){e.addListener(n,i,t)}))},add:function(n,t){e.promise.then((function(e){var r,o={},u={ui:n,online:t||0};o[n]=u,e.updateUserCache(o),r=[u],i.forEach((function(n){n(r)}))}))},remove:function(n){e.promise.then((function(e){e.removeRefFromCache(n)}))},ifOnline:function(n){return new Promise((function(i,t){e.promise.then((function(e){var r=e.getFromUserCache(n);r&&(1===r.online||4===r.online||5===r.online)?i():t()}))}))},registerOnAddListener:function(n){i.push(n)},unregisterOnAddListener:function(n){var e=i.indexOf(n);e>-1&&i.splice(e,1)}}}));