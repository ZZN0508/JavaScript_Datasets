define("OK/feedback/Settings",["OK/utils/utils","OK/utils/dom"],function(o,i){function t(e){this.element=e,this.count=parseInt(e.getAttribute("data-count"),10)}function s(e,t){var n=0===(e.count=t),t=i.firstByClass(e.element,"js-empty");t&&t.classList.toggle("invisible",!n),a.setGroupsIsEmpty(n),i.firstByClass(e.element,"sc-menu_h").classList.toggle("invisible",n),i.firstByClass(e.element,"feedback_settings_cnt").classList.toggle("invisible",n)}function e(e){var t=this;e.preventDefault(),require(["OK/feedback/FeedbackLayerController"],function(i){var e=i.getNextUnreadTime();i.hideLabel(),o.ajax({url:t.getAttribute("data-href"),data:{"st.f.let":e}}).done(function(e,t,n){i.reset(n),o.updateBlockModelCallback(e,t,n)})})}function n(e){this.element=e,this.parent=i.parent(this.element,"js-deleteAll")}function r(e){this.element=e}var a,l,c;return t.prototype.activate=function(){s(this,this.count)},t.prototype.add=function(e){var t=OK.util.nextId(),n=this;this.remove(e),o.ajax({url:"/dk?cmd=FeedbackGroup",data:{"st.b.gId":e,"st.b.cId":t}}).done(function(e){s(n,n.count+1);var t=i.firstByClass(n.element,"js-list");t.insertAdjacentHTML("afterBegin",e),OK.hookModel.captureBlockHook(OK.hookModel.getNearestBlockHookId(t),t.firstChild)})},t.prototype.remove=function(e){e=document.getElementById("feedbackGroup"+e);e&&(i.remove(e),s(this,this.count-1))},n.prototype.activate=function(){this.element.addEventListener("click",e),a.setMenuIsEmpty(this.parent.classList.contains("invisible"))},n.prototype.deactivate=function(){this.element.removeEventListener("click",e)},n.prototype.show=function(){this.parent.classList.remove("invisible"),a.setMenuIsEmpty(!1)},n.prototype.hide=function(){this.parent.classList.add("invisible"),a.setMenuIsEmpty(!0)},r.prototype={setGroupsIsEmpty:function(e){this.groupsIsEmpty=e,this.toggleStub()},setMenuIsEmpty:function(e){this.menuIsEmpty=e,this.toggleStub()},toggleStub:function(){i.firstByClass(this.element,"js-empty").classList.toggle("invisible",!this.groupsIsEmpty||!this.menuIsEmpty)}},{activate:function(e){a=new r(e)},list:function(e){(l=new t(e)).activate()},showDeleteAllButton:function(){c&&c.show()},initDeleteButton:function(e){(c=new n(e)).activate()},addGroup:function(e){l&&(e=e.getAttribute("data-gid"),l.add(e))},removeGroup:function(e){l&&(e=e.getAttribute("data-gid"),l.remove(e))},getDeleteAllButton:function(){return c}}}),define("OK/HookModel",["OK/utils/utils"],function(e){var r={},i=e.deferred();return{init:function(e){i.resolve(e)},hookActivated:function(i){var o,s,e=r[i],t=new Promise(function(e,t){var n=OK.hookModel.getHookById(i);n?e(n.getInstance?n.getInstance():void 0):(o=e,s=t)});return o&&s&&(t.resolve=o,t.reject=s,e&&e.length||(r[i]=e=[]),e.push(t)),t},removeObserver:function(e,t){t=r[t];t&&t.length&&(-1!=(e=t.indexOf(e))&&t.splice(e,1))},activatedCallback:function(e,t){var n=r[e];n&&(delete r[e],n.forEach(function(e){e.resolve(t)}))},extractHookId:function(e){return e.substring(e.lastIndexOf("_")+1)},createHook:function(t,n){return i.promise.then(function(e){e.createHook(t,n)})}}}),define("OK/feedback/ListController",["OK/utils/utils","OK/utils/dom","jquery","OK/logger","OK/feedback/Settings","OK/HookModel"],function(c,e,p,m,a,g){function d(e,t,n,i){var o=this;this.layer=e,this.el=t,this.element=p(t),this.pageSize=i,this.loaded=p.Deferred(),this.empty=!0,this.scrollController=n,this.latest=void 0,this.element.on("click",".js-expand",function(t){var n=this,o=p(t.target),s=o.closest(".notif").data("href");o.closest(".notif_w").each(function(e,i){i.expanded?(i.expanded=!1,i.classList.remove("__expanded"),t.target.getAttribute("data-scroll")&&(n.scrollController.scrollTop(i.listScrollTop),delete i.listScrollTop)):(i.listScrollTop=n.scrollController.element.scrollTop,i.expanded=!0,i.loaded?i.classList.add("__expanded"):(i.loaded=!0,c.ajax({url:s}).done(function(e,t,n){c.updateBlockModelCallback(e,t,n),i.classList.add("__expanded")}).fail(function(){i.loaded=!1,o.removeClass("__active")})))}),t.preventDefault()}.bind(this)).on("click",".js-reply",function(e){o.toggleReply(p(e.target).closest(".notif")),e.preventDefault(),e.stopPropagation()}).on("click",".comments_text_more",function(t){require(["OK/discussions/Reveal"],function(e){p(t.target).closest(".comments_current_cnt").each(function(){e.expand(this)})})}.bind(this))}function n(s,e,t){var t={url:"/dk",data:p.extend({cmd:"FeedbackLayerContent"},e),beforeSend:t},r=p.Deferred(),t=c.ajax(t,function(){m.success("feedbackLayer","load.redirect")},7);return t.always(s.layer.hideProgress.bind(s.layer)),t.done(function(e,t,n){var i=n.getResponseHeader("Last-Time-Micros"),o=n.getResponseHeader("Last-Access-Time-Micros");"true"===n.getResponseHeader("Inconsistent")?r.reject(n):(o&&(s.lastAccessTime=parseInt(o,10)),i&&(s.lastTime=parseInt(i,10),require(["OK/feedback/FeedbackLayerController"],function(e){e.markAsRead(s.lastTime)})),(s.empty="true"===n.getResponseHeader("Block-Empty"))||(a.showDeleteAllButton(),(i=n.getResponseHeader("firstelem"))&&(s.marker=i)),clearTimeout(n.showProcess),s.layer.hideError(),r.resolve(e,t,n))}),t.fail(function(e){r.reject(e)}),r.fail(function(e){clearTimeout(e.showProcess)}),r}return d.prototype={getListContainer:function(){return e.firstByClass(this.el,"js-feedback-list")},load:function(i,e){var o=this,e=Math.max(5,e||Math.floor(window.innerHeight/85));n(o,{"st.f.ps":e},function(e){e.showProcess=setTimeout(o.layer.showProgress.bind(o.layer,e),500)}).done(function(e,t,n){try{c.updateBlockModelCallback(n.responseText,t,n),m.success("feedbackLayer","load.empty",0===e.length)}catch(e){m.error("feedbackLayer","load.insert")}o.loaded.resolve();n="true"===n.getResponseHeader("Has-Unread");i.resolve(o.lastTime,o.empty,n)}).fail(function(e,t,n){o.layer.showError(),m.error("feedbackLayer","load.fail"),m.clob("error",JSON.stringify({textStatus:t,errorThrown:n}),"feedbackLayer","load.fail")})},isEmpty:function(){return this.empty},update:function(f,t){var h=this;return"resolved"!==h.loaded.state()||this.isEmpty()?this.load(f):h.loaded.done(function(){var u=t.getCount();if(u>h.pageSize)return h.load(f,h.pageSize),f;var e=h.getLatest(),e={"st.firstelem":h.marker,"st.fwd":"off","st.f.ps":h.pageSize,"st.f.lat":h.lastAccessTime||(isNaN(h.lastTime)?void 0:h.lastTime),"st.f.fio":e?e.options:void 0,fetch:!0};n(h,e).done(function(e,t,n){var i=parseInt(n.getResponseHeader("Last-Time-Micros"),10),n="true"===n.getResponseHeader("Block-Empty");if(isNaN(i))return f.resolve(h.lastTime,n),void m.clob("error",JSON.stringify({marker:h.marker,countToLoad:u,loaded:p(".notif",h.element).length}),"feedbackLayer","update.null");try{var o=h.getListContainer(),s=p(o),r=OK.hookModel.getNearestBlockHookId(o),a=document.createElement("div");a.innerHTML=e,m.success("feedbackLayer","update.empty",0===e.length);for(var l=Array.prototype.slice.call(a.childNodes),c=l.length-1;0<=c;c--){var d=l[c];d.getAttribute("id"),s.prepend(d),h.scrollController.scroll(d.clientHeight),g.createHook(r,d)}}catch(e){throw m.error("feedbackLayer","update.insert"),m.clob("error",e.stack,"feedbackLayer","update.insert"),e}f.resolve(h.lastTime,n)}).fail(function(){m.error("feedbackLayer","update.fail")})}),f},getLatest:function(){for(var e=this.latest;e&&e.isHidden();)e=e.next;return e},markAllAsRead:function(){this.layer.controller.unreadItemsCount=0,p(".feedback_seen",this.element).remove(),this.forEach(function(e){e.markAsRead(),e.deleted&&e.toggle(!1)}),void 0===this.latest&&(this.empty=!0,this.load(p.Deferred()))},getItemById:function(e){return p("[data-id="+e+"]",this.element)},toggleReply:function(a){var l=this;p(a).each(function(e,t){var i,o,s,n,r;t.reply?(t.reply=!1,t.classList.remove("__reply"),delete l.activeForm):(t.reply=!0,t.form||(t.form=(i=l,o=t,s=p.Deferred(),n=p(".js-reply",o).data("href"),r=c.ajax({url:n}).done(function(e,t,n){c.updateBlockModelCallback(e,t,n)}),require(["OK/feedback/FeedbackDiscussion"],function(n){r.done(function(){var e=d.prototype.toggleReply.bind(i,o),t=o.getElementsByClassName("comment_status")[0],e=new n(i.layer,p(".comment-form",o),t,e);e.init(),s.resolve(e)})}),s)),t.form.done(function(e){l.activeForm&&l.toggleReply(l.activeForm),l.activeForm=a,t.classList.add("__reply"),e.form.focus()}))})},addItem:function(e){if(void 0===this.latest)this.latest=e;else{var t=this.latest;if(0<e.compareTo(t))e.next=t,this.latest=e;else{for(;t.next&&e.compareTo(t)<0;)t=t.next;t.next=e}}},removeItem:function(e){e.prev?(e.prev.next=e.next,e.next.prev=e.prev):(this.latest=e.next,e.next&&(e.next.prev=void 0))},forEach:function(e){for(var t=this.latest;t;){if(!e.call(t,t))return;t=t.next}},getItems:function(){var t=[];return this.forEach(function(e){t.push(e)}),t}},d}),define("OK/feedback/FeedbackLayer",["jquery","OK/utils/utils","OK/utils/vanilla","OK/feedback/ListController","OK/NewsFetchCoordinator","OK/ToolbarGrowl","OK/discussions/ScrollController","OK/logger","OK/utils/dom"],function(r,e,t,o,s,n,a,l,c){function d(e){e!==OK.historyManager.getState()&&OK.historyManager.pushState(e)}function i(e,t){var n=this;this.controller=t,this.el=e,this.element=r(e);var i=document.getElementById("hook_Block_FeedbackLayerContent"),e=e.getElementsByClassName("notifs_lst")[0];this.scroller=new a({scrollingContainer:e,stickyContainer:r()}),this.list=new o(this,i,this.scroller,this.element.attr("data-pagesize"),t),this.label=r(".js-newTip",this.element),this.initialized=r.Deferred(),this.opened=!1,this.inProgress=!1,this.scrollTop=0,this.header=c.firstByClass(this.el,"toolbar-layer_h"),this.banner=document.getElementById("hook_Block_FeedbackLayerBanner"),this.bannerLoading=!1,s.addBlock("FeedbackGrowl"),this.element.on("click",".js-reload",function(){n.list.load(n.initialized)})}return i.prototype={toggle:function(){this.opened?this.hide():this.open()},open:function(i){var o=r.Deferred();try{var s=this;this.opened=!0,this.lastState=OK.historyManager.getState();var e=this.hide.bind(this,this);if(OK.loader.use("OKCustomJs",function(){OK.Layers.unregisterAll(),OK.Layers.register("feedback",e)}),d("/marks"),this.element.removeClass("invisible"),OK.loader.use("OKCustomJs",function(){OK.Layers.onLayerShown()}),n.destroyByLayerId("feedback"),o.done(function(){s.element.triggerHandler("show",i)}),this.inProgress||this.isInitialized())return this.banner&&!this.bannerLoading&&(this.bannerLoading=!0,this.loadBanner().then(function(){s.bannerLoading=!1},function(){s.bannerLoading=!1})),o.resolve(),o.promise();this.inProgress=!0;var t=r.Deferred().done(function(e,t,n){o.resolve(),t||s.initialized.resolve(e,t,n)}).always(function(){s.inProgress=!1});return this.list.load(t),this.initialized.done(function(e,t,n){s.toggleHeader(n),i&&i.resolve(e)}),o.promise()}catch(e){return this.showError(),l.error("feedbackLayer","open"),l.clob("error",e.stack,"feedbackLayer","open"),o.reject().promise()}},loadBanner:function(){return t.ajax({url:"/dk?cmd=FeedbackLayerBanner"}).then(t.updateBlockModelCallback)},hide:function(){this.opened&&(this.opened=!1,OK.loader.use("OKCustomJs",function(){OK.Layers.remove("feedback"),OK.Layers.onLayerHidden()}),d(this.lastState&&0===this.lastState.indexOf("/marks")?"/":this.lastState),this.scrollTop=this.list.scrollController.element.scrollTop,this.element.addClass("invisible"),this.element.triggerHandler("hide"),this.list.markAllAsRead(),this.toggleHeader(!1),this.banner&&OK.hookModel.setHookContent("FeedbackLayerBanner",""))},on:function(e,t){return this.element.on(e,t),this},off:function(e,t){return this.element.off(e,t),this},isOpened:function(){return this.opened},isInitialized:function(){return"resolved"===this.initialized.state()},focusItem:function(e){var t=this;this.list.getItemById(e).each(function(){t.scroller.scrollToCenter(this),r(".js-reply",this).each(t.list.toggleReply.bind(t.list,this))})},showProgress:function(){var e=this.el.getElementsByClassName("notifs_wrap");Array.prototype.slice.call(e).forEach(function(e){e.classList.add("__process")})},hideProgress:function(){var e=this.el.getElementsByClassName("notifs_wrap");Array.prototype.slice.call(e).forEach(function(e){e.classList.remove("__process")})},showError:function(){var e=document.getElementById("feedbackErrorStub");e&&e.classList.remove("invisible")},hideError:function(){var e=document.getElementById("feedbackErrorStub");e&&e.classList.add("invisible")},applyConf:function(e){r(".toolbar-layer",this.element).toggleClass("__unavailable",!e.enabled)},toggleHeader:function(e){this.header.classList.toggle("__has-unread",!0===e)}},i}),define("OK/feedback/FeedbackLayerController",["jquery","OK/feedback/FeedbackLayer","OK/logger","OK/utils/utils"],function(l,t,c,n){function d(e,t){this.element=e,this.onClick=t.bind(this),this.visible=!1}function s(e){this.createTime=e.counter.counterCreateTime.timeMicros,this.lastEventTime=e.counter.lastEventTime?parseInt(e.counter.lastEventTime.timeMicros,10):void 0,this.count=e.counter.count,this.next=void 0}function e(e){this.capacity=e,this.queue=[]}d.prototype={show:function(){this.visible||(this.visible=!0,this.element.off("click.label").on("click.label",this.onClick),this.element.removeClass("__hidden").addClass("__active"))},hide:function(e){e&&this.element.addClass("__hidden"),this.element.removeClass("__active"),this.element.off("click.label",this.onClick),this.visible=!1}},s.prototype={isLater:function(e){return this.createTime>e.createTime},getCount:function(){return Math.max(this.count,this.next?this.next.getCount():0)},process:function(t,n){var i=this;if(this.lastEventTime)try{var e,o,s,r,a=parseInt(this.lastEventTime,10);0<this.count&&t<a?(e=u.list.scrollController,o=e.scrollToTop.bind(e,function(e){l(this.element).animate({scrollTop:this.element.scrollTop+e},700)}),s=function(e,t){r.hide(!0),u.off("show",s),u.list.update(n,i).done(o),t&&n.done(t.resolve.bind(t))},r=new d(u.label,function(){u.off("show",s);var e=u.list.update(n,i);e.done(this.hide.bind(this,!0)),e.done(o)}),u.list.isEmpty()?u.isOpened()?u.list.update(n,i):u.on("show",s):(r.show(),u.on("show",s))):n.resolve(t)}catch(e){n.resolve(t),c.error("feedbackLayer","processNotification"),c.clob("error",e.stack,"feedbackLayer","processNotification")}else n.resolve(t)}},e.prototype={offer:function(e){if(0!==e.length&&this.size()!==this.capacity){var t=e.shift();try{var n=this.queue[this.size()-1];(this.isEmpty()||t.isLater(n)&&t.count!=n.count)&&(this.isEmpty()||(n.next=t),h||(h=t.lastEventTime),this.queue.push(t))}catch(e){c.error("feedbackLayer","offer"),c.clob("error",e.stack,"feedbackLayer","offer")}return this.offer(e)}},size:function(){return this.queue.length},isEmpty:function(){return 0===this.size()},poll:function(){return this.queue.shift()},peek:function(){return this.queue[0]}};var u,i,r=new e(100),a={autoScroll:!1,devMode:!1,isEnabled:!0},o=0,f=0,h=void 0;return{unreadItemsCount:0,reset:function(e){r.queue=[],(u.list.empty="true"===e.getResponseHeader("Block-Empty"))||(e=e.getResponseHeader("firstelem"))&&(u.list.marker=e)},activate:function(e){u=new t(e,this),e.getAttribute("data-opened")&&this.open()},setNewContent:function(e){try{var t=JSON.parse(e),n=t.notifications,i=t.conf;if((a=i?i:a).devMode&&(console.log("Got notifications: ",n),console.log("Queue: ",r),console.log("Configuraton",a)),!n||0===n.length)return;var o=r.isEmpty();r.offer(l.map(n,function(e){e=new s(e);if(0===e.count)require(["OK/ToolbarGrowl"],function(t){try{t.destroyByLayerId("feedback")}catch(e){c.error("feedbackLayer","destroyByLayerId"),c.clob("error",Function.prototype.toString(t),"feedbackLayer","destroyByLayerId")}});else if(u&&u.isInitialized())return e})),o&&function o(s,e){var t=l.Deferred();try{if(s.isEmpty())return h=void 0,t.resolve(e);s.peek().process(e||0,t)}catch(e){c.error("feedbackLayer","processNotifications"),c.clob("error",e.stack,"feedbackLayer","processNotifications")}return t.then(function(e,t,n,i){return s.poll(),f=e,u.toggleHeader(!t),o(s,e)})}(r),u&&u.applyConf(a)}catch(e){c.error("feedbackLayer","setNewContent"),c.clob("error",e.stack,"feedbackLayer","setNewContent")}},toggle:function(){u&&u.toggle()},open:function(t){var e;u&&((e=l.Deferred()).done(function(e){f=e,t&&u.focusItem(t)}),u.open(e))},hide:function(){u&&u.hide()},on:function(e,t){return u&&u.on(e,t),this},off:function(e,t){return u&&u.off(e,t),this},isOpened:function(){return!!u&&u.isOpened()},bindButton:function(e){i=e},markAsRead:function(e){f=e,o=0,n.ajax({url:"/web-api/feedback/mark/"+e}).done(function(){i.updateCounter(0)})},uncount:function(e){o+=e,i&&i.updateCounter(i.counter-o)},getUncountable:function(){return o},getLastEventTime:function(){return f},getNextUnreadTime:function(){return h},hideLabel:function(){u&&u.label.addClass("__hidden").removeClass("__active")},addItem:function(e){this.unreadItemsCount+=e.isUnread?1:0,u.list.addItem(e.bind(u))},removeItem:function(e){this.unreadItemsCount-=e.isUnread?1:0,u.list.removeItem(e)},forEach:function(e){u.list.forEach(e)},getList:function(){return u.list}}}),define("OK/feedback/FeedbackButton",["require","jquery","OK/feedback/FeedbackLayerController","OK/NewsFetchCoordinator"],function(e){var n=e("jquery"),t=e("OK/feedback/FeedbackLayerController");function i(e,t){this.hookId=e,this.el=t,this.element=n(t),this.toggleOn=o.bind(this,this,!0),this.toggleOff=o.bind(this,this,!1),this.lastTime=parseInt(this.element.attr("data-time"),10),this.counter=parseInt(this.element.attr("data-counter"),10)}function o(e,t){e.element.toggleClass("toolbar_nav_a__feedback__active",t)}function s(e,t){t=Math.max(t,0);n(".counterText",e.element).text(99<t?"99+":t),n(".toolbar_nav_notif, .new-marker",e.element).toggleClass("invisible",0===t)}return e("OK/NewsFetchCoordinator"),i.prototype={activate:function(){s(this,this.counter-t.getUncountable()),t.bindButton(this),o(this,t.isOpened()),t.on("show",this.toggleOn).on("hide",this.toggleOff),this.element.on("click",function(e){t.toggle(),e.stopPropagation()})},deactivate:function(){this.element.off("click"),t.off("show",this.toggleOn).off("hide",this.toggleOff)},updateCounter:function(e,t){(t=t||1e3*Date.now())>this.lastTime&&(this.lastTime=t,s(this,e))},setNewContent:function(e){var t=n(e);parseInt(t.attr("data-time"),10)>this.lastTime&&OK.hookModel.setHookContent("HeaderTopNewFeedbackInToolbarWrapper",e)}},i}),define("OK/feedback/FeedbackDiscussion",["jquery","OK/Discussion","OK/discussions/CommentForm","OK/discussions/LinkAttachController","OK/utils/utils"],function(i,s,o,r,a){function t(e,t,n,i){o.call(this,t,n,i),this.onCancelFn=e,this.linksController=new r(this.objectId,{isSmall:!0})}((t.prototype=Object.create(o.prototype)).constructor=t).prototype.onCancel=function(e){this.deactivate(!0),e.preventDefault()},t.prototype.focus=function(){o.prototype.focus.call(this),this.discussion.statusElement.classList.add("invisible")},t.prototype.deactivate=function(e){return o.prototype.deactivate.call(this,e),this.onCancelFn(),this};function e(e,t,n,i){var o=a.parseJson(document.getElementById(t.data("params")).innerHTML);s.call(this,t,t.data("id"),t.data("type"),0,o),this.layer=e,this.onCancel=i,this.statusElement=n}return((e.prototype=Object.create(s.prototype)).constructor=e).prototype.init=function(){var e=this.form=new t(this.onCancel,this.elements.commentArea,this,i.extend({},this.elements,{collapsable:!1}));return e.init(),e.changeState(o.states.cancelable),this},e.prototype.destroy=function(){this.form.destroy(),this.elements.container.off()},e.prototype.post=function(e,t){this.statusElement.classList.remove("invisible");var n=this.statusElement.getAttribute("id"),n=n.substring(n.lastIndexOf("_")+1);return OK.hookModel.setHookContent(n,t),this.updateCount(1),this.onCancel(),i.Deferred().resolve()},e.prototype.replyMode=function(){},e.prototype.editMode=function(e,t){},e}),define("OK/discussions/Reveal",["OK/utils/dom"],function(o){return{expand:function(e){o.firstByClass(e,"comments_text").classList.remove("__reveal-2","__reveal-3"),o.firstByClass(e,"comments_text_more").classList.add("invisible")},activate:function(e){var t,n,i=o.firstByClass(e,"comments_text");i&&(t=parseInt(i.getAttribute("data-max-lines"),10),isNaN(t)||(n=o.firstByClass(e,"comments_text_more"),e=parseInt(window.getComputedStyle(i)["line-height"],10)||21,i.firstChild.clientHeight/e>t+1?n.classList.remove("invisible"):i.classList.remove("__reveal-2","__reveal-3")))}}}),define("OK/feedback/FeedbackItem",["jquery","OK/discussions/Reveal","OK/utils/dom","OK/feedback/FeedbackLayerController","OK/utils/utils"],function(t,n,i,o,s){function r(e,t,n){this.id=e,this.type=t,this.isGroup=n}function e(e,t){this.element=t,this.bound=s.deferred(),this.options=parseInt(t.getAttribute("data-options"),10),this.isUnread=!(!this.options||!0&this.options),this.next=void 0,this.prev=void 0}return r.fromElement=function(e){return new r(e.getAttribute("data-sid"),e.getAttribute("data-st"),null!==e.getAttribute("data-sig"))},r.prototype={equals:function(e){return this.id===e.id&&this.type===e.type&&this.isGroup===e.isGroup}},e.prototype={activate:function(e){n.activate(this.element),o.addItem(this)},deactivate:function(){i.remove(this.element),o.removeItem(this)},bind:function(e){return this.bound.resolve(e),this},remove:function(e){this.deleted=!0,t(e).offsetParent(".notif").addClass("__blur __deleted")},blur:function(e){var t=e.getElementsByClassName("notif_disabled_tx")[0],n=i.parent(e,"notif");t.clientHeight>e.clientHeight&&(n.style.height=i.innerHeight(t)),n.classList.add("__blur"),n.classList.remove("show-on-hover")},unblur:function(e){var t=i.parent(this.element,"notif");t.classList.remove("__blur"),t.classList.add("show-on-hover"),t.style.height="",this.element.classList.add("invisible")},toggle:function(e){return this.element.parentNode.classList.toggle("invisible",this.hidden=!e),this.bound.promise.then(function(e){e.scroller.trigger()}),e},isHidden:function(){return this.hidden},markAsRead:function(){this.options=1|this.options,this.isUnread=!1},getSubject:function(){return this.subject||(this.subject=r.fromElement(this.element))},getGroupId:function(){return this.groupId||(this.groupId=this.element.getAttribute("data-gid"))},getLatestActorId:function(){return this.actorId||(this.actorId=this.element.getAttribute("data-aid"))},getTime:function(){return this.time||(this.time=new Date(parseInt(this.element.getAttribute("data-time"),10)/1e3))},compareTo:function(e){return(this.getTime()>e.getTime())-(this.getTime()<e.getTime())}},e}),define("OK/feedback/TotalLink",[],function(e){function t(e,t){this.element=t,this.hookId=e,this.key=t.getAttribute("data-key")}var n={};return t.prototype={activate:function(){for(var e=(e=n[this.key])||(n[this.key]=[]),t=0;t<e.length;t++)OK.hookModel.setHookContent(e[t],this.element.innerHTML);e.push(this.hookId)},deactivate:function(){n[this.key].splice(n[this.key].indexOf(this.hookId),1)},setNewContent:function(e){this.element.innerHTML=e}},t}),define("OK/feedback/FeedbackActions",["OK/utils/dom","OK/feedback/FeedbackLayerController"],function(n,f){function e(e,t){this.hookId=e,this.element=t,this.stack=[],this.notifElement=n.parent(this.element,"notif"),this.wrapper=n.parent(this.notifElement,"notif_w")}return e.prototype={activate:function(){},deactivate:function(){},setNewContent:function(e,t,n){var i=this;function o(e){n(),i.element.innerHTML=e,t()}var s=document.createElement("div");s.innerHTML=e;var r,a,l,c=OK.util.parseJSON(s.firstChild.innerHTML),d=c.currentAction,u=c.revert;0===this.stack.length&&(this.expanded=this.wrapper.classList.contains("__expanded")),u?0<this.stack.length&&(o(this.stack.pop()),0===this.stack.length&&((s=(l=i).notifElement).classList.remove("__blur"),s.classList.add("show-on-hover"),l.expanded&&l.wrapper.classList.add("__expanded"))):(this.stack.push(this.element.innerHTML),o(e),(e=i).notifElement.classList.add("__blur"),e.notifElement.classList.remove("show-on-hover"),e.expanded&&e.wrapper.classList.remove("__expanded")),"UNSUBSCRIBE"===d?r=function(e){return e.getSubject().equals(c.subject)}:"TURN_OFF_GROUP"===d?r=function(e){return e.getGroupId()&&e.getGroupId()===c.groupId}:"BLOCK"===d&&(r=function(e){return e.getLatestActorId()&&e.getLatestActorId()===c.latestActorId}),f.forEach(function(e){if(e.element.contains(i.element)){if("FORCE_DELETE"===d)return e.toggle(!1),!1;e.deleted=0<i.stack.length}else r&&r.call(this,e)&&(e.toggle(u),!u&&e.isUnread&&(a=(a||0)+1));return!0}),a&&a===f.unreadItemsCount&&f.getList().markAllAsRead()}},e}),define("OK/feedback/RestoreLink",["OK/utils/dom","OK/utils/utils"],function(e,o){function t(e){var t=this.getAttribute("href")||this.getAttribute("data-href");o.ajax({url:t}).done(function(e,t,n){var i=parseInt(n.getResponseHeader("Last-Time-Micros"),10);o.updateBlockModelCallback(e,t,n),require(["OK/feedback/FeedbackLayerController"],function(e){e.markAsRead(i)})}),e.preventDefault()}return{activate:function(e){e.addEventListener("click",t)},deactivate:function(e){e.removeEventListener("click",t)}}}),define("b/feedback",["OK/feedback/FeedbackButton","OK/feedback/FeedbackDiscussion","OK/feedback/FeedbackLayer","OK/feedback/FeedbackLayerController","OK/feedback/FeedbackItem","OK/feedback/ListController","OK/feedback/Settings","OK/feedback/TotalLink","OK/feedback/FeedbackActions","OK/feedback/RestoreLink"],function(){});
