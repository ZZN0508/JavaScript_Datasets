define(["OK/capture","OK/logger","OK/NewsFetchCoordinator","OK/utils/utils","OK/utils/dom"],(function(t,e,i,n,r){"use strict";function a(t,e){var i=t.getBoundingClientRect(),n=Math.min(i.bottom,window.innerHeight)-Math.max(0,i.top),r=Math.min(i.right,window.innerWidth)-Math.max(0,i.left),a=t.offsetHeight,s=t.offsetWidth;return n>0&&r>0&&a*e<=n&&s*e<=r}function s(t){var e=t.getAttribute("data-seen-params");if(!e&&t.firstElementChild&&(e=t.firstElementChild.getAttribute("data-seen-params")),e){var i=JSON.parse(e);if(i.data)return i.data.gId}return null}function f(t){var e=t.getAttribute("data-seen-params");if(!e&&t.firstElementChild&&(e=t.firstElementChild.getAttribute("data-seen-params")),e){var i=JSON.parse(e);if(i.data)return i.data.created}return null}return{activate:function(t){this.parent=r.parent(t,"feed-list"),this.offset=parseInt(t.getAttribute("data-offset"),10)||200,this.unsubscribe="true"===t.getAttribute("data-unsubscribe"),this.checkMore=parseInt(t.getAttribute("data-check-more"),10)||5,this.minCreated=parseInt(t.getAttribute("data-min-created"),10)||0,i.addBlock("MainFeedsNewFeedPush")},deactivate:function(){this.unsubscribe&&n.ajax({type:"POST",url:"/web-api/feed/markAsInactive"}).fail((function(){e.error("Failed to mark as inactive in feed")}))},setNewContent:function(e){var i=document.createElement("div");i.innerHTML=e;var n=i.childNodes;if(0!==n.length){var r=function(t,e){for(var i={},n=!1,r=t.length-1;r>=0;r--){var a=t[r];if(e>0){var d=f(a);if(d&&d<e)continue}var o=s(a);o&&(i[o]=a,n=!0)}if(!n)return null;return i}(n,this.minCreated);if(r){var d,o,u=this.parent.childNodes;if(0!==u.length){for(var h,c,l,g=!0,v=u.length,m=0;m<v;m++){var p=u[m];if(p.className.indexOf("feed")>=0){var b=s(p);if(b&&delete r[b],!g)continue;if(h=p,c=this.offset,l=void 0,(l=h.getBoundingClientRect()).top>window.innerHeight-c&&l.left>0&&l.top<window.innerHeight&&l.right<window.innerWidth?d=p:d?g=!1:a(p,.2)?o=p:o&&(g=!1),!g){if(0==this.checkMore)break;m+this.checkMore<v&&(v=m+this.checkMore)}}}for(var w in r)if(r.hasOwnProperty(w)){var C=r[w];if(C){if(d)this.parent.insertBefore(C,d);else{if(!o)continue;this.parent.insertBefore(C,o.nextSibling)}t.activate(C)}}}}}}}}));