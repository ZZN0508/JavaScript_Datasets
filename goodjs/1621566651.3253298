define(["OK/utils/md5"],(function(e){function t(){i.initialized=!0,window.fapi_success(i.mode)}var i={initialized:!1,mode:"",init:function(e,t,n){var o=e||{},a=t,r=n,s=null==e||i.Util.isString(e);s&&(o={},a=arguments[2],r=arguments[3]),window.fapi_success=i.Util.isFunc(a)?a:function(){},window.fapi_failure=i.Util.isFunc(r)?r:function(){};var l=i.Util.getRequestParameters(o.location_search||window.location.search),c=i.Util.getRequestParameters(o.location_hash||window.location.hash),d=l.api_server||(s?arguments[0]:null),f=l.apiconnection||(s?arguments[1]:null);if(i.Client.initialize(l,c,o),d)this.mode=f?"W":"M","W"==this.mode?i.Util.isFunc(window.postMessage)?(this.invokeUIMethod=i.HTML5.invokeUIMethod,i.HTML5.init(d,f,l)):(this.mode="F",this.invokeUIMethod=i.FLASH.invokeUIMethod,i.FLASH.init(d,f,l)):i.MOBILE.init();else{if(!o.app_id||!o.app_key)return void window.fapi_failure("FAPI was unable to detect launch platform. URL parameters and app_id/app_key not detected.");this.mode="O",i.OAUTH.init(o,l,c)}},invokeUIMethod:function(){API_callback(arguments[0],"error",{error_code:-1,error_message:"UI methods are available only for apps running on OK portal"})},HTML5:{webServerUrl:"",serverUrl:"",apiConnectionName:"",attachRetryCounter:0,init:function(e,t,n){this.serverUrl=e,this.apiConnectionName=t,this.attachRetryCounter=0,i.initialized||(this.webServerUrl=n.web_server,-1==this.webServerUrl.indexOf("://")&&(this.webServerUrl="http://"+this.webServerUrl),i.Util.isFunc(window.addEventListener)?window.addEventListener("message",this.onPostMessage,!1):window.attachEvent("onmessage",this.onPostMessage),this.doAttach())},doAttach:function(){i.initialized||(i.HTML5.attachRetryCounter++<20?(i.HTML5.invokeUIMethod("attach"),setTimeout(i.HTML5.doAttach,500)):window.fapi_failure("Failed to init."))},onPostMessage:function(e){if(i.HTML5.webServerUrl==e.origin){var n=e.data.split("$");if(3==n.length){var o=decodeURIComponent(n[0]);"attach"==o?t():API_callback(o,decodeURIComponent(n[1]),decodeURIComponent(n[2]))}}},invokeUIMethod:function(){for(var e="",t=0;t<arguments.length;t++){var n=arguments[t];t>0&&(e+="$"),null!=n&&(e+=encodeURIComponent(String(n)))}parent.postMessage("__FAPI__"+e,i.HTML5.webServerUrl)}},FLASH:{flash:null,swfCallback:function(e){e.success?i.FLASH.flash=document.getElementById("FAPI_Flash"):window.fapi_failure("Failed  to embed flash")},embedFlash:function(){var e=document.createElement("span");e.id="FAPI_Flash_wrap",e.style.position="absolute",e.style.marginTop="-10px",document.body.appendChild(e);var t={apiconnection:this.apiConnectionName},i=function(){var e,t,n,o,a,r,s="undefined",l="object",c="Shockwave Flash",d="application/x-shockwave-flash",f="SWFObjectExprInst",u="onreadystatechange",h=window,p=document,v=navigator,y=!1,m=[function(){y?function(){var e=p.getElementsByTagName("body")[0],t=z(l);t.setAttribute("type",d);var i=e.appendChild(t);if(i){var n=0;!function(){if(typeof i.GetVariable!=s){var o=i.GetVariable("$version");o&&(o=o.split(" ")[1].split(","),k.pv=[parseInt(o[0],10),parseInt(o[1],10),parseInt(o[2],10)])}else if(n<10)return n++,void setTimeout(arguments.callee,10);e.removeChild(t),i=null,F()}()}else F()}():F()}],w=[],g=[],b=[],S=!1,I=!1,C=!0,k=function(){var e=typeof p.getElementById!=s&&typeof p.getElementsByTagName!=s&&typeof p.createElement!=s,t=v.userAgent.toLowerCase(),i=v.platform.toLowerCase(),n=/win/.test(i||t),o=/mac/.test(i||t),a=!!/webkit/.test(t)&&parseFloat(t.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")),r=!1,f=[0,0,0],u=null;if(typeof v.plugins!=s&&typeof v.plugins[c]==l)!(u=v.plugins[c].description)||typeof v.mimeTypes!=s&&v.mimeTypes[d]&&!v.mimeTypes[d].enabledPlugin||(y=!0,r=!1,u=u.replace(/^.*\s+(\S+\s+\S+$)/,"$1"),f[0]=parseInt(u.replace(/^(.*)\..*$/,"$1"),10),f[1]=parseInt(u.replace(/^.*\.(.*)\s.*$/,"$1"),10),f[2]=/[a-zA-Z]/.test(u)?parseInt(u.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0);else if(typeof h.ActiveXObject!=s)try{var m=new ActiveXObject("ShockwaveFlash.ShockwaveFlash");m&&(u=m.GetVariable("$version"))&&(r=!0,u=u.split(" ")[1].split(","),f=[parseInt(u[0],10),parseInt(u[1],10),parseInt(u[2],10)])}catch(e){}return{w3:e,pv:f,wk:a,ie:r,win:n,mac:o}}();k.w3&&((typeof p.readyState!=s&&"complete"==p.readyState||typeof p.readyState==s&&(p.getElementsByTagName("body")[0]||p.body))&&U(),S||(typeof p.addEventListener!=s&&p.addEventListener("DOMContentLoaded",U,!1),k.ie&&k.win&&(p.attachEvent(u,(function(){"complete"==p.readyState&&(p.detachEvent(u,arguments.callee),U())})),h==top&&function(){if(!S){try{p.documentElement.doScroll("left")}catch(e){return void setTimeout(arguments.callee,0)}U()}}()),k.wk&&function(){S||(/loaded|complete/.test(p.readyState)?U():setTimeout(arguments.callee,0))}(),A(U)));function U(){if(!S){try{var e=p.getElementsByTagName("body")[0].appendChild(z("span"));e.parentNode.removeChild(e)}catch(e){return}S=!0;for(var t=m.length,i=0;i<t;i++)m[i]()}}function _(e){S?e():m[m.length]=e}function A(e){if(typeof h.addEventListener!=s)h.addEventListener("load",e,!1);else if(typeof p.addEventListener!=s)p.addEventListener("load",e,!1);else if(typeof h.attachEvent!=s)!function(e,t,i){e.attachEvent(t,i),b[b.length]=[e,t,i]}(h,"onload",e);else if("function"==typeof h.onload){var t=h.onload;h.onload=function(){t(),e()}}else h.onload=e}function F(){var e=w.length;if(e>0)for(var t=0;t<e;t++){var i=w[t].id,n=w[t].callbackFn,o={success:!1,id:i};if(k.pv[0]>0){var a=H(i);if(a)if(!R(w[t].swfVersion)||k.wk&&k.wk<312)if(w[t].expressInstall&&M()){var r={};r.data=w[t].expressInstall,r.width=a.getAttribute("width")||"0",r.height=a.getAttribute("height")||"0",a.getAttribute("class")&&(r.styleclass=a.getAttribute("class")),a.getAttribute("align")&&(r.align=a.getAttribute("align"));for(var l={},c=a.getElementsByTagName("param"),d=c.length,f=0;f<d;f++)"movie"!=c[f].getAttribute("name").toLowerCase()&&(l[c[f].getAttribute("name")]=c[f].getAttribute("value"));E(r,l,i,n)}else P(a),n&&n(o);else $(i,!0),n&&(o.success=!0,o.ref=T(i),n(o))}else if($(i,!0),n){var u=T(i);u&&typeof u.SetVariable!=s&&(o.success=!0,o.ref=u),n(o)}}}function T(e){var t=null,i=H(e);if(i&&"OBJECT"==i.nodeName)if(typeof i.SetVariable!=s)t=i;else{var n=i.getElementsByTagName(l)[0];n&&(t=n)}return t}function M(){return!I&&R("6.0.65")&&(k.win||k.mac)&&!(k.wk&&k.wk<312)}function E(i,a,r,l){I=!0,n=l||null,o={success:!1,id:r};var c=H(r);if(c){"OBJECT"==c.nodeName?(e=L(c),t=null):(e=c,t=r),i.id=f,(typeof i.width==s||!/%$/.test(i.width)&&parseInt(i.width,10)<310)&&(i.width="310"),(typeof i.height==s||!/%$/.test(i.height)&&parseInt(i.height,10)<137)&&(i.height="137"),p.title=p.title.slice(0,47)+" - Flash Player Installation";var d=k.ie&&k.win?"ActiveX":"PlugIn",u="MMredirectURL="+h.location.toString().replace(/&/g,"%26")+"&MMplayerType="+d+"&MMdoctitle="+p.title;if(typeof a.flashvars!=s?a.flashvars+="&"+u:a.flashvars=u,k.ie&&k.win&&4!=c.readyState){var v=z("div");r+="SWFObjectNew",v.setAttribute("id",r),c.parentNode.insertBefore(v,c),c.style.display="none",function(){4==c.readyState?c.parentNode.removeChild(c):setTimeout(arguments.callee,10)}()}N(i,a,r)}}function P(e){if(k.ie&&k.win&&4!=e.readyState){var t=z("div");e.parentNode.insertBefore(t,e),t.parentNode.replaceChild(L(e),t),e.style.display="none",function(){4==e.readyState?e.parentNode.removeChild(e):setTimeout(arguments.callee,10)}()}else e.parentNode.replaceChild(L(e),e)}function L(e){var t=z("div");if(k.win&&k.ie)t.innerHTML=e.innerHTML;else{var i=e.getElementsByTagName(l)[0];if(i){var n=i.childNodes;if(n)for(var o=n.length,a=0;a<o;a++)1==n[a].nodeType&&"PARAM"==n[a].nodeName||8==n[a].nodeType||t.appendChild(n[a].cloneNode(!0))}}return t}function N(e,t,i){var n,o=H(i);if(k.wk&&k.wk<312)return n;if(o)if(typeof e.id==s&&(e.id=i),k.ie&&k.win){var a="";for(var r in e)e[r]!=Object.prototype[r]&&("data"==r.toLowerCase()?t.movie=e[r]:"styleclass"==r.toLowerCase()?a+=' class="'+e[r]+'"':"classid"!=r.toLowerCase()&&(a+=" "+r+'="'+e[r]+'"'));var c="";for(var f in t)t[f]!=Object.prototype[f]&&(c+='<param name="'+f+'" value="'+t[f]+'" />');o.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+a+">"+c+"</object>",g[g.length]=e.id,n=H(e.id)}else{var u=z(l);for(var h in u.setAttribute("type",d),e)e[h]!=Object.prototype[h]&&("styleclass"==h.toLowerCase()?u.setAttribute("class",e[h]):"classid"!=h.toLowerCase()&&u.setAttribute(h,e[h]));for(var p in t)t[p]!=Object.prototype[p]&&"movie"!=p.toLowerCase()&&O(u,p,t[p]);o.parentNode.replaceChild(u,o),n=u}return n}function O(e,t,i){var n=z("param");n.setAttribute("name",t),n.setAttribute("value",i),e.appendChild(n)}function B(e){var t=H(e);t&&"OBJECT"==t.nodeName&&(k.ie&&k.win?(t.style.display="none",function(){4==t.readyState?j(e):setTimeout(arguments.callee,10)}()):t.parentNode.removeChild(t))}function j(e){var t=H(e);if(t){for(var i in t)"function"==typeof t[i]&&(t[i]=null);t.parentNode.removeChild(t)}}function H(e){var t=null;try{t=p.getElementById(e)}catch(e){}return t}function z(e){return p.createElement(e)}function R(e){var t=k.pv,i=e.split(".");return i[0]=parseInt(i[0],10),i[1]=parseInt(i[1],10)||0,i[2]=parseInt(i[2],10)||0,t[0]>i[0]||t[0]==i[0]&&t[1]>i[1]||t[0]==i[0]&&t[1]==i[1]&&t[2]>=i[2]}function x(e,t,i,n){if(!k.ie||!k.mac){var o=p.getElementsByTagName("head")[0];if(o){var c=i&&"string"==typeof i?i:"screen";if(n&&(a=null,r=null),!a||r!=c){var d=z("style");d.setAttribute("type","text/css"),d.setAttribute("media",c),a=o.appendChild(d),k.ie&&k.win&&typeof p.styleSheets!=s&&p.styleSheets.length>0&&(a=p.styleSheets[p.styleSheets.length-1]),r=c}k.ie&&k.win?a&&typeof a.addRule==l&&a.addRule(e,t):a&&typeof p.createTextNode!=s&&a.appendChild(p.createTextNode(e+" {"+t+"}"))}}}function $(e,t){if(C){var i=t?"visible":"hidden";S&&H(e)?H(e).style.visibility=i:x("#"+e,"visibility:"+i)}}function K(e){return null!=/[\\\"<>\.;]/.exec(e)&&typeof encodeURIComponent!=s?encodeURIComponent(e):e}k.ie&&k.win&&window.attachEvent("onunload",(function(){for(var e=b.length,t=0;t<e;t++)b[t][0].detachEvent(b[t][1],b[t][2]);for(var n=g.length,o=0;o<n;o++)B(g[o]);for(var a in k)k[a]=null;for(var r in k=null,i)i[r]=null;i=null}));return{registerObject:function(e,t,i,n){if(k.w3&&e&&t){var o={};o.id=e,o.swfVersion=t,o.expressInstall=i,o.callbackFn=n,w[w.length]=o,$(e,!1)}else n&&n({success:!1,id:e})},getObjectById:function(e){if(k.w3)return T(e)},embedSWF:function(e,t,i,n,o,a,r,c,d,f){var u={success:!1,id:t};k.w3&&!(k.wk&&k.wk<312)&&e&&t&&i&&n&&o?($(t,!1),_((function(){i+="",n+="";var h={};if(d&&typeof d===l)for(var p in d)h[p]=d[p];h.data=e,h.width=i,h.height=n;var v={};if(c&&typeof c===l)for(var y in c)v[y]=c[y];if(r&&typeof r===l)for(var m in r)typeof v.flashvars!=s?v.flashvars+="&"+m+"="+r[m]:v.flashvars=m+"="+r[m];if(R(o)){var w=N(h,v,t);h.id==t&&$(t,!0),u.success=!0,u.ref=w}else{if(a&&M())return h.data=a,void E(h,v,t,f);$(t,!0)}f&&f(u)}))):f&&f(u)},switchOffAutoHideShow:function(){C=!1},ua:k,getFlashPlayerVersion:function(){return{major:k.pv[0],minor:k.pv[1],release:k.pv[2]}},hasFlashPlayerVersion:R,createSWF:function(e,t,i){return k.w3?N(e,t,i):void 0},showExpressInstall:function(e,t,i,n){k.w3&&M()&&E(e,t,i,n)},removeSWF:function(e){k.w3&&B(e)},createCSS:function(e,t,i,n){k.w3&&x(e,t,i,n)},addDomLoadEvent:_,addLoadEvent:A,getQueryParamValue:function(e){var t=p.location.search||p.location.hash;if(t){if(/\?/.test(t)&&(t=t.split("?")[1]),null==e)return K(t);for(var i=t.split("&"),n=0;n<i.length;n++)if(i[n].substring(0,i[n].indexOf("="))==e)return K(i[n].substring(i[n].indexOf("=")+1))}return""},expressInstallCallback:function(){if(I){var i=H(f);i&&e&&(i.parentNode.replaceChild(e,i),t&&($(t,!0),k.ie&&k.win&&(e.style.display="block")),n&&n(o)),I=!1}}}}();i.embedSWF(this.serverUrl+"flash/ForticomAPIJS.swf?v=19","FAPI_Flash_wrap","1","1","9.0.0",this.serverUrl+"flash/expressInstall.swf",t,{menu:"false",scale:"noScale",allowScriptAccess:"always",bgcolor:"#FFFFFF"},{id:"FAPI_Flash"},this.swfCallback)},init:function(e,i){this.serverUrl=e,this.apiConnectionName=i,this.flash=document.getElementById("FAPI_Flash"),null==this.flash?this.embedFlash():t()},isFunc:function(e){return"[object Function]"===Object.prototype.toString.call(e)},getFlash:function(){if(!i.initialized)throw"Forticom API was not initialized properly";return this.flash},invokeUIMethod:function(){for(var e=0;e<arguments.length;e++){var t=arguments[e];null!=t&&(arguments[e]=String(t))}i.FLASH.getFlash().FAPI_send.apply(i.FLASH.getFlash(),arguments)}},UI:{showInvite:function(e,t,n){i.invokeUIMethod("showInvite",e,t,n)},showNotification:function(e,t,n){i.invokeUIMethod("showNotification",e,t,n)},showPermissions:function(e,t){Array.isArray(e)&&(e=JSON.stringify(e)),i.invokeUIMethod("showPermissions",e,t)},showPayment:function(e,t,n,o,a,r,s,l,c){i.invokeUIMethod("showPayment",e,t,n,o,a,r,s,l,c)},showPortalPayment:function(){i.invokeUIMethod("showPortalPayment")},showConfirmation:function(e,t,n){i.invokeUIMethod("showConfirmation",e,t,n)},setWindowSize:function(e,t){i.invokeUIMethod("setWindowSize",e,t)},changeHistory:function(e){i.invokeUIMethod("changeHistory",e)},scrollToTop:function(){i.invokeUIMethod("scrollToTop")},scrollTo:function(e,t){i.invokeUIMethod("scrollTo",e,t)},getPageInfo:function(){i.invokeUIMethod("getPageInfo")},navigateTo:function(e){i.invokeUIMethod("navigateTo",e)},postMediatopic:function(e,t,n){i.invokeUIMethod("postMediatopic",JSON.stringify(e),t?"on":"off",n?n.join(","):"")},showPromoPayment:function(e,t){i.invokeUIMethod("showPromoPayment",e,t)},isSupported:function(){return"W"==i.mode||"F"==i.mode}},MOBILE:{init:function(){t()}},OAUTH:{init:function(e,i,n){null!=n.access_token||null!=n.error?null==n.error?t():window.fapi_failure("Error with OAUTH authorization: "+n.error):window.location="https://connect.ok.ru/oauth/authorize?client_id="+e.app_id+"&scope="+(e.oauth_scope||"VALUABLE_ACCESS")+"&response_type=token&redirect_uri="+(e.oauth_url||window.location.href)+"&layout=a&state="+(e.oauth_state||"")}},Util:{isFunc:function(e){return"[object Function]"===Object.prototype.toString.call(e)},isString:function(e){return"[object String]"===Object.prototype.toString.call(e)},calcSignature:function(t,i){var n,o,a=[];for(n in t)a.push(n.toString());for(a.sort(),o="",n=0;n<a.length;n++){var r=a[n];"sig"!=r&&"resig"!=r&&"access_token"!=r&&(o+=a[n]+"="+t[a[n]])}return o+=i,o=this.encodeUtf8(o),e(o)},encodeUtf8:function(e){for(var t="",i=0;i<e.length;i++){var n=e.charCodeAt(i);n<128?t+=String.fromCharCode(n):n>127&&n<2048?(t+=String.fromCharCode(n>>6|192),t+=String.fromCharCode(63&n|128)):(t+=String.fromCharCode(n>>12|224),t+=String.fromCharCode(n>>6&63|128),t+=String.fromCharCode(63&n|128))}return t},getRequestParameters:function(e){var t={},i=e||window.location.search;if(i)for(var n=(i=i.substr(1)).split("&"),o=0;o<n.length;o++){var a=n[o].split("="),r=a[0],s=a[1];void 0!==r&&void 0!==s&&(s=decodeURIComponent(s.replace(/\+/g," ")),t[r]=s)}return t}},Client:{counter:0,window:this,head:null,applicationKey:null,sessionKey:null,accessToken:null,sessionSecretKey:null,apiServer:null,baseUrl:null,uid:null,format:"JSON",initialized:!1,load:function(e){var t=document.createElement("script"),i=!1;t.src=e,t.async=!0,t.onload=t.onreadystatechange=function(){i||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(i=!0,t.onload=t.onreadystatechange=null,t&&t.parentNode&&t.parentNode.removeChild(t))},this.head||(this.head=document.getElementsByTagName("head")[0]),this.head.appendChild(t)},call:function(e,t,n){this.initialized||this.initialize();var o="?";for(var a in(e=this.fillParams(e)).sig=i.Util.calcSignature(e,this.sessionSecretKey),null!=n&&(e.resig=n),e)e.hasOwnProperty(a)&&(o+=a+"="+encodeURIComponent(e[a])+"&");var r="__fapi__callback_"+ ++this.counter;return this.window[r]=function(e,i,n){t(e,i,n),window[r]=null;try{delete window[r]}catch(e){}},this.load(this.baseUrl+o+"js_callback="+r),r},callWithPromise:function(e,t,i){var n=this;return new Promise((function(o,a){n.call(Object.assign({method:e},t),(function(e,t,i){"ok"===e?o(t):a(i)}),i)}))},calcSignature:function(e){return this.initialized||this.initialize(),e=this.fillParams(e),i.Util.calcSignature(e,this.sessionSecretKey)},fillParams:function(e){return this.initialized||this.initialize(),(e=e||{}).application_key=this.applicationKey,this.sessionKey?e.session_key=this.sessionKey:e.access_token=this.accessToken,e.format=this.format,e},initialize:function(e,t,n){e=e||i.Util.getRequestParameters(),t=t||{},n=n||{},this.uid=e.logged_user_id,this.applicationKey=e.application_key||n.app_key,this.sessionKey=e.session_key,this.accessToken=t.access_token,this.sessionSecretKey=e.session_secret_key||t.session_secret_key,this.apiServer=e.api_server||"https://api.ok.ru/",this.baseUrl=this.apiServer+"fb.do",this.initialized=!0}}};return i}));