define("OK/notifications/LayerController",["OK/utils/utils","OK/logger","OK/ToolbarGrowl","OK/ToolbarBubble"],function(r,t,i,e){"use strict";var a="layer_notifications",c=null,n=e.wrap("counter_Notifications"),s=j("ntf_toolbar_button"),l="toolbar_nav_a__notif__active",o=!1,d="/",f=0,u=1,y=!1,g=!1;return{show:function(o){o=o||{},g||(h(),k(),j("hook_Block_NotificationsLayer").innerHTML?OK.loader.use(["OKCustomJs"],_):(OK.loader.use(["OKCustomJs"],L),s.classList.add(l),C(I()),g=!0,r.ajax({url:s.getAttribute("data-link"),data:{"st.ntf.cat":o.category||c||"All","st.ntf.reset":0<f?"off":"on","st.ntf.page":u}}).fail(function(){s.classList.add(l),g=!1,t.error("ll","ntf"),v(I()),O()}).done(function(t,e,n){g=!1,k(),i.destroyByLayerId(a),r.updateBlockModelCallback(t,e,n),OK.loader.use(["OKCustomJs"],_.bind(window,o.callback))})))},hide:m,reset:K,showContent:function(t,e){var n;h(),N().classList.remove("__process"),t&&(c=t,y=!1,e)&&(n=j("ntf_layer_menu_link_"+t))&&p(n.getAttribute("href"))},toggleContent:function(){N().getElementsByClassName("notif").length?(C(w()),v(B())):(v(w()),C(B()))},showLoader:function(){b(0),N().classList.add("__process")},category:function(){return o?c:null},shouldCheckNews:function(){y=!0}};function h(){var t=j("ntf_layer_close");!o&&t&&(t.addEventListener("click",m),o=!0)}function _(t){h(),OK.Layers.register(a,m),v(I()),s.classList.add(l),d=OK.historyManager.getState(),C(E()),b(f),n.hide(),t&&t()}function m(){var t,e,n;o&&((n=w())&&(f=n.scrollTop),!(t=j("ntf_layer_content_inner"))||(n=t.parentNode)&&n.getAttribute&&(t=t.parentNode.getAttribute("data-page"),u=parseInt(t,10)||u),p(d&&0===d.indexOf("/notifications")?"/":d),k(),O(),o&&((e=j("ntf_layer_close"))&&e.removeEventListener("click",m),o=!1),e=(e=j("ntf_layer_left_menu"))&&null!==e.getAttribute("data-unread"),(y||e)&&(y=!1,e&&K(),r.ajax({url:"/dk?cmd=NotificationsController&st.checkNews=on"}).done(function(t,e,n){r.updateBlockModelCallback(t,e,n)})))}function O(){v(E()),s.classList.remove(l),OK.hookModel.setHookContent("NotificationsLayer",""),OK.Layers&&OK.Layers.remove&&(OK.Layers.remove(a),OK.Layers.onLayerHidden())}function k(){i.destroyByLayerId(a)}function K(t){c=t||"All",f=0,u=1}function L(){OK.Layers.unregisterAll(),OK.Layers.onLayerShown()}function p(t){t!==OK.historyManager.getState()&&OK.historyManager.pushState(t)}function v(t){t&&t.classList.add("invisible")}function C(t){t&&t.classList.remove("invisible")}function b(t){var e=w();e&&(e.scrollTop=t)}function B(){return j("ntf_layer_content_stub")}function N(){return j("hook_Block_NotificationsLayerContent")}function w(){return j("ntf_layer_content_scroll")}function E(){return j("ntf_layer")}function I(){return j("ntf_toolbar_layer_loader")}function j(t){return document.getElementById(t)}}),define("OK/notifications/ActionsController",["OK/logger","OK/ToolbarGrowl","OK/ToolbarBubble"],function(r,s,t){"use strict";var l,d="layer_notifications",i=t.wrap("counter_Notifications"),e={confirm:function(i){var t,e;i.json.massOperationRemoved&&(e=document.getElementById("ntf_mass_operation"))&&(t=e.parentNode)&&t.removeChild(e),!l.category()&&i.html?(l.reset(i.json.category),l.show({callback:function(){var t,e,n,o,r;for((e=document.createElement("div")).innerHTML=i.html,t=document.getElementById("ntf_layer_content_inner");!e.id;)e=e.firstChild;o=e.id.replace("hook_Block_",""),(r=OK.hookModel.getHookById(o))?(OK.hookModel.setHookContent(o,e.innerHTML),n=r.element,o=document.getElementById("ntf_layer_content_scroll"),0<(r=n.offsetTop-20)&&(o.scrollTop=r,n.firstChild.classList.add("__anim-highlight"))):(e=t.insertBefore(e,t.firstChild),OK.hookModel.captureBlockHook("NotificationsLayerContent",e),l.toggleContent()),i.json.redirectAfterNtfLayerLoaded&&i.performRedirect()}})):(a(i.json.nid,i.html,!1,i.json.counter),i.json.redirectAfterNtfLayerLoaded&&i.performRedirect()),i.json.redirectAfterNtfLayerLoaded||i.performRedirect()},news:function(t){var e=l.category(),n=t.json.totalUnread,o=t.json.removed,t=t.json.closed;!function(t){if(t)for(var e=0;e<t.length;e++)a(t[e],null,!0,!0)}(o),function(t){var e,n=s.getByLayerId(d);if(n&&t&&t.length)for(e=0;e<t.length;e++)if(n.id===t[e]){n.destroy(!0);break}}(t),e?n&&(l.shouldCheckNews(),r.success("ntf","push.open",n)):(i.update(n),0<n&&l.reset(),0===n&&s.destroyByLayerId(d))}};return{init:function(t){l=t,OK.util.extend(OK.ntf,{close:function(t){a(t,null,!1,!1)},lock:function(t){t=OK.hookModel.getHookById("Ntf_"+t);t&&t.element.setAttribute("data-locked","true")}})},handle:function(t){t.action&&e[t.action]&&e[t.action](t),void 0===(t=t.json.totalUnread)||l.category()||i.update(t)}};function a(t,e,n,o){var r,i,a,c=document.getElementById("ne-"+t);c&&(r=OK.hookModel.getNearestBlockHookId(c),i=OK.hookModel.getHookById(r))&&(i=i.element,n&&"true"===i.getAttribute("data-locked")||(l.category()?(e?OK.hookModel.setHookContent(r,e):(OK.hookModel.setHookContent(r,""),(r=i.parentNode)&&r.removeChild(i),l.toggleContent(),setTimeout(f,500)),o&&(a=c.getAttribute("data-category"),!(c=document.getElementById("ntf_counter_"+a))||0<(a=parseInt(c.innerHTML,10)||0)&&(c.classList.toggle("__empty",0==(a=a-1)),c.innerHTML=a))):(a=s.getByLayerId(d))&&t===a.id&&a.destroy(!0)))}function f(){var t,e=document.getElementById("ntf_layer_content_inner");document.createEvent?((t=document.createEvent("Event")).initEvent("scroll",!0,!0),e.dispatchEvent(t)):document.createEventObject&&(t=document.createEventObject(),e.fireEvent("onscroll",t))}}),define("OK/notifications/ContentData",[],function(){"use strict";function t(t){t&&(t=t.split("&&&%%%"),this.json=OK.util.parseJSON(t[0]),this.action=this.json.action,2===t.length&&(this.html=t[1]))}return t.prototype={performRedirect:function(){var t;this.json.redirect&&(0===(t=decodeURIComponent(this.json.redirect).replace(/&amp;/g,"&")).indexOf("http://")||0===t.indexOf("https://")?window.open(t,"_blank"):navigateOnUrlFromJS(t))}},t}),define("OK/Notifications",["require","OK/notifications/LayerController","OK/notifications/ActionsController","OK/notifications/ContentData","OK/NewsFetchCoordinator","OK/logger"],function(t){"use strict";var e=t("OK/notifications/LayerController"),n=t("OK/notifications/ActionsController"),o=t("OK/notifications/ContentData"),r=t("OK/NewsFetchCoordinator"),i=t("OK/logger");function a(t){t.stopPropagation(),e.category()?e.hide():e.show()}return{LayerController:e,activate:function(t){document.getElementById("ntf_layer")&&(i.success("ntf","short-link"),e.show()),t.parentNode.addEventListener("click",a),n.init(e),r.addBlock("NTF")},setNewContent:function(e){try{n.handle(new o(e))}catch(t){i.clob("ntf",e+"\n"+t.stack,"fail","actions")}},showContent:function(t){setTimeout(function(){e.showContent(t.getAttribute("data-category"),"on"===t.getAttribute("data-history"))})}}});
