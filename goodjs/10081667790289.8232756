define(["OK/utils/md5"],function(r){function i(){c.initialized=!0,window.fapi_success(c.mode)}var c={initialized:!1,mode:"",init:function(e,t,n){var i=e||{},o=t,a=n,r=null==e||c.Util.isString(e);r&&(i={},o=n,a=arguments[3]),window.fapi_success=c.Util.isFunc(o)?o:function(){},window.fapi_failure=c.Util.isFunc(a)?a:function(){};var s=c.Util.getRequestParameters(i.location_search||window.location.search),o=c.Util.getRequestParameters(i.location_hash||window.location.hash),a=s.api_server||(r?e:null),r=s.apiconnection||(r?t:null);c.Client.initialize(s,o,i),a?(this.mode=r?"W":"M","W"==this.mode?c.Util.isFunc(window.postMessage)?(this.invokeUIMethod=c.HTML5.invokeUIMethod,c.HTML5.init(a,r,s)):(this.mode="F",this.invokeUIMethod=c.FLASH.invokeUIMethod,c.FLASH.init(a,r,s)):c.MOBILE.init()):i.app_id&&i.app_key?(this.mode="O",c.OAUTH.init(i,s,o)):window.fapi_failure("FAPI was unable to detect launch platform. URL parameters and app_id/app_key not detected.")},invokeUIMethod:function(){API_callback(arguments[0],"error",{error_code:-1,error_message:"UI methods are available only for apps running on OK portal"})},HTML5:{webServerUrl:"",serverUrl:"",apiConnectionName:"",attachRetryCounter:0,init:function(e,t,n){this.serverUrl=e,this.apiConnectionName=t,this.attachRetryCounter=0,c.initialized||(this.webServerUrl=n.web_server,-1==this.webServerUrl.indexOf("://")&&(this.webServerUrl="http://"+this.webServerUrl),c.Util.isFunc(window.addEventListener)?window.addEventListener("message",this.onPostMessage,!1):window.attachEvent("onmessage",this.onPostMessage),this.doAttach())},doAttach:function(){c.initialized||(c.HTML5.attachRetryCounter++<20?(c.HTML5.invokeUIMethod("attach"),setTimeout(c.HTML5.doAttach,500)):window.fapi_failure("Failed to init."))},onPostMessage:function(e){var t;c.HTML5.webServerUrl!=e.origin||3==(t=e.data.split("$")).length&&("attach"==(e=decodeURIComponent(t[0]))?i():API_callback(e,decodeURIComponent(t[1]),decodeURIComponent(t[2])))},invokeUIMethod:function(){for(var e="",t=0;t<arguments.length;t++){var n=arguments[t];0<t&&(e+="$"),null!=n&&(e+=encodeURIComponent(String(n)))}parent.postMessage("__FAPI__"+e,c.HTML5.webServerUrl)}},FLASH:{flash:null,swfCallback:function(e){e.success?c.FLASH.flash=document.getElementById("FAPI_Flash"):window.fapi_failure("Failed  to embed flash")},embedFlash:function(){var e=document.createElement("span");e.id="FAPI_Flash_wrap",e.style.position="absolute",e.style.marginTop="-10px",document.body.appendChild(e);var a,r,s,l,c,d,m,w,u,y,h,t,f,p,v,g,i,b,S,I,o,C,n,k,e={apiconnection:this.apiConnectionName},U=(m="undefined",w="object",u="Shockwave Flash",y="application/x-shockwave-flash",h="SWFObjectExprInst",t="onreadystatechange",f=window,p=document,v=navigator,g=!1,i=[function(){(g?function(){var t=p.getElementsByTagName("body")[0],n=j(w);n.setAttribute("type",y);var i,o=t.appendChild(n);o?(i=0,function(){if(typeof o.GetVariable!=m){var e=o.GetVariable("$version");e&&(e=e.split(" ")[1].split(","),k.pv=[parseInt(e[0],10),parseInt(e[1],10),parseInt(e[2],10)])}else if(i<10)return i++,setTimeout(arguments.callee,10);t.removeChild(n),o=null,T()}()):T()}:T)()}],b=[],S=[],n=!(C=o=!(I=[])),(k=function(){var e=typeof p.getElementById!=m&&typeof p.getElementsByTagName!=m&&typeof p.createElement!=m,t=v.userAgent.toLowerCase(),n=v.platform.toLowerCase(),i=/win/.test(n||t),o=/mac/.test(n||t),a=!!/webkit/.test(t)&&parseFloat(t.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")),r=!1,n=[0,0,0],t=null;if(typeof v.plugins!=m&&typeof v.plugins[u]==w)!(t=v.plugins[u].description)||typeof v.mimeTypes!=m&&v.mimeTypes[y]&&!v.mimeTypes[y].enabledPlugin||(r=!(g=!0),t=t.replace(/^.*\s+(\S+\s+\S+$)/,"$1"),n[0]=parseInt(t.replace(/^(.*)\..*$/,"$1"),10),n[1]=parseInt(t.replace(/^.*\.(.*)\s.*$/,"$1"),10),n[2]=/[a-zA-Z]/.test(t)?parseInt(t.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0);else if(typeof f.ActiveXObject!=m)try{var s=new ActiveXObject("ShockwaveFlash.ShockwaveFlash");s&&(t=s.GetVariable("$version"))&&(r=!0,t=t.split(" ")[1].split(","),n=[parseInt(t[0],10),parseInt(t[1],10),parseInt(t[2],10)])}catch(e){}return{w3:e,pv:n,wk:a,ie:r,win:i,mac:o}}()).w3&&((typeof p.readyState!=m&&"complete"==p.readyState||typeof p.readyState==m&&(p.getElementsByTagName("body")[0]||p.body))&&_(),o||(typeof p.addEventListener!=m&&p.addEventListener("DOMContentLoaded",_,!1),k.ie&&k.win&&(p.attachEvent(t,function(){"complete"==p.readyState&&(p.detachEvent(t,arguments.callee),_())}),f==top&&function(){if(!o){try{p.documentElement.doScroll("left")}catch(e){return setTimeout(arguments.callee,0)}_()}}()),k.wk&&function(){o||(/loaded|complete/.test(p.readyState)?_():setTimeout(arguments.callee,0))}(),F(_))),k.ie&&k.win&&window.attachEvent("onunload",function(){for(var e=I.length,t=0;t<e;t++)I[t][0].detachEvent(I[t][1],I[t][2]);for(var n,i,o=S.length,a=0;a<o;a++)O(S[a]);for(n in k)k[n]=null;for(i in k=null,U)U[i]=null;U=null}),{registerObject:function(e,t,n,i){var o;k.w3&&e&&t?((o={}).id=e,o.swfVersion=t,o.expressInstall=n,o.callbackFn=i,b[b.length]=o,R(e,!1)):i&&i({success:!1,id:e})},getObjectById:function(e){if(k.w3)return M(e)},embedSWF:function(r,s,l,c,d,u,h,f,p,v){var y={success:!1,id:s};k.w3&&!(k.wk&&k.wk<312)&&r&&s&&l&&c&&d?(R(s,!1),A(function(){l+="",c+="";var e={};if(p&&typeof p===w)for(var t in p)e[t]=p[t];e.data=r,e.width=l,e.height=c;var n={};if(f&&typeof f===w)for(var i in f)n[i]=f[i];if(h&&typeof h===w)for(var o in h)typeof n.flashvars!=m?n.flashvars+="&"+o+"="+h[o]:n.flashvars=o+"="+h[o];if(H(d)){var a=N(e,n,s);e.id==s&&R(s,!0),y.success=!0,y.ref=a}else{if(u&&E())return e.data=u,void P(e,n,s,v);R(s,!0)}v&&v(y)})):v&&v(y)},switchOffAutoHideShow:function(){n=!1},ua:k,getFlashPlayerVersion:function(){return{major:k.pv[0],minor:k.pv[1],release:k.pv[2]}},hasFlashPlayerVersion:H,createSWF:function(e,t,n){return k.w3?N(e,t,n):void 0},showExpressInstall:function(e,t,n,i){k.w3&&E()&&P(e,t,n,i)},removeSWF:function(e){k.w3&&O(e)},createCSS:function(e,t,n,i){k.w3&&z(e,t,n,i)},addDomLoadEvent:A,addLoadEvent:F,getQueryParamValue:function(e){var t=p.location.search||p.location.hash;if(t){if(/\?/.test(t)&&(t=t.split("?")[1]),null==e)return x(t);for(var n=t.split("&"),i=0;i<n.length;i++)if(n[i].substring(0,n[i].indexOf("="))==e)return x(n[i].substring(n[i].indexOf("=")+1))}return""},expressInstallCallback:function(){var e;C&&((e=B(h))&&a&&(e.parentNode.replaceChild(a,e),r&&(R(r,!0),k.ie&&k.win&&(a.style.display="block")),s&&s(l)),C=!1)}});function _(){if(!o){try{var e=p.getElementsByTagName("body")[0].appendChild(j("span"));e.parentNode.removeChild(e)}catch(e){return}o=!0;for(var t=i.length,n=0;n<t;n++)i[n]()}}function A(e){o?e():i[i.length]=e}function F(e){var t,n,i;typeof f.addEventListener!=m?f.addEventListener("load",e,!1):typeof p.addEventListener!=m?p.addEventListener("load",e,!1):typeof f.attachEvent!=m?(i=e,(n=f).attachEvent("onload",i),I[I.length]=[n,"onload",i]):"function"==typeof f.onload?(t=f.onload,f.onload=function(){t(),e()}):f.onload=e}function T(){var e=b.length;if(0<e)for(var t=0;t<e;t++){var n=b[t].id,i=b[t].callbackFn,o={success:!1,id:n};if(0<k.pv[0]){var a=B(n);if(a)if(!H(b[t].swfVersion)||k.wk&&k.wk<312)if(b[t].expressInstall&&E()){var r={};r.data=b[t].expressInstall,r.width=a.getAttribute("width")||"0",r.height=a.getAttribute("height")||"0",a.getAttribute("class")&&(r.styleclass=a.getAttribute("class")),a.getAttribute("align")&&(r.align=a.getAttribute("align"));for(var s={},l=a.getElementsByTagName("param"),c=l.length,d=0;d<c;d++)"movie"!=l[d].getAttribute("name").toLowerCase()&&(s[l[d].getAttribute("name")]=l[d].getAttribute("value"));P(r,s,n,i)}else(function(e){{var t;k.ie&&k.win&&4!=e.readyState?(t=j("div"),e.parentNode.insertBefore(t,e),t.parentNode.replaceChild(L(e),t),e.style.display="none",function(){4==e.readyState?e.parentNode.removeChild(e):setTimeout(arguments.callee,10)}()):e.parentNode.replaceChild(L(e),e)}})(a),i&&i(o);else R(n,!0),i&&(o.success=!0,o.ref=M(n),i(o))}else R(n,!0),i&&((n=M(n))&&typeof n.SetVariable!=m&&(o.success=!0,o.ref=n),i(o))}}function M(e){var t=null,e=B(e);return e&&"OBJECT"==e.nodeName&&(typeof e.SetVariable!=m?t=e:(e=e.getElementsByTagName(w)[0])&&(t=e)),t}function E(){return!C&&H("6.0.65")&&(k.win||k.mac)&&!(k.wk&&k.wk<312)}function P(e,t,n,i){s=i||null,l={success:!(C=!0),id:n};var o=B(n);o&&(r="OBJECT"==o.nodeName?(a=L(o),null):(a=o,n),e.id=h,(typeof e.width==m||!/%$/.test(e.width)&&parseInt(e.width,10)<310)&&(e.width="310"),(typeof e.height==m||!/%$/.test(e.height)&&parseInt(e.height,10)<137)&&(e.height="137"),p.title=p.title.slice(0,47)+" - Flash Player Installation",i=k.ie&&k.win?"ActiveX":"PlugIn",i="MMredirectURL="+f.location.toString().replace(/&/g,"%26")+"&MMplayerType="+i+"&MMdoctitle="+p.title,typeof t.flashvars!=m?t.flashvars+="&"+i:t.flashvars=i,k.ie&&k.win&&4!=o.readyState&&((i=j("div")).setAttribute("id",n+="SWFObjectNew"),o.parentNode.insertBefore(i,o),o.style.display="none",function(){4==o.readyState?o.parentNode.removeChild(o):setTimeout(arguments.callee,10)}()),N(e,t,n))}function L(e){var t=j("div");if(k.win&&k.ie)t.innerHTML=e.innerHTML;else{e=e.getElementsByTagName(w)[0];if(e){var n=e.childNodes;if(n)for(var i=n.length,o=0;o<i;o++)1==n[o].nodeType&&"PARAM"==n[o].nodeName||8==n[o].nodeType||t.appendChild(n[o].cloneNode(!0))}}return t}function N(e,t,n){var i,o,a,r,s,l=B(n);if(k.wk&&k.wk<312)return i;if(l)if(typeof e.id==m&&(e.id=n),k.ie&&k.win){var c,d="";for(c in e)e[c]!=Object.prototype[c]&&("data"==c.toLowerCase()?t.movie=e[c]:"styleclass"==c.toLowerCase()?d+=' class="'+e[c]+'"':"classid"!=c.toLowerCase()&&(d+=" "+c+'="'+e[c]+'"'));var u,h="";for(u in t)t[u]!=Object.prototype[u]&&(h+='<param name="'+u+'" value="'+t[u]+'" />');l.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+d+">"+h+"</object>",S[S.length]=e.id,i=B(e.id)}else{var f,p,v=j(w);for(f in v.setAttribute("type",y),e)e[f]!=Object.prototype[f]&&("styleclass"==f.toLowerCase()?v.setAttribute("class",e[f]):"classid"!=f.toLowerCase()&&v.setAttribute(f,e[f]));for(p in t)t[p]!=Object.prototype[p]&&"movie"!=p.toLowerCase()&&(o=v,a=p,r=t[p],s=void 0,s=j("param"),s.setAttribute("name",a),s.setAttribute("value",r),o.appendChild(s));l.parentNode.replaceChild(v,l),i=v}return i}function O(e){var t=B(e);t&&"OBJECT"==t.nodeName&&(k.ie&&k.win?(t.style.display="none",function(){4==t.readyState?function(e){var t=B(e);if(t){for(var n in t)"function"==typeof t[n]&&(t[n]=null);t.parentNode.removeChild(t)}}(e):setTimeout(arguments.callee,10)}()):t.parentNode.removeChild(t))}function B(e){var t=null;try{t=p.getElementById(e)}catch(e){}return t}function j(e){return p.createElement(e)}function H(e){var t=k.pv,e=e.split(".");return e[0]=parseInt(e[0],10),e[1]=parseInt(e[1],10)||0,e[2]=parseInt(e[2],10)||0,t[0]>e[0]||t[0]==e[0]&&t[1]>e[1]||t[0]==e[0]&&t[1]==e[1]&&t[2]>=e[2]}function z(e,t,n,i){var o;k.ie&&k.mac||(o=p.getElementsByTagName("head")[0])&&(n=n&&"string"==typeof n?n:"screen",i&&(d=c=null),c&&d==n||((i=j("style")).setAttribute("type","text/css"),i.setAttribute("media",n),c=o.appendChild(i),k.ie&&k.win&&typeof p.styleSheets!=m&&0<p.styleSheets.length&&(c=p.styleSheets[p.styleSheets.length-1]),d=n),k.ie&&k.win?c&&typeof c.addRule==w&&c.addRule(e,t):c&&typeof p.createTextNode!=m&&c.appendChild(p.createTextNode(e+" {"+t+"}")))}function R(e,t){n&&(t=t?"visible":"hidden",o&&B(e)?B(e).style.visibility=t:z("#"+e,"visibility:"+t))}function x(e){return null!=/[\\\"<>\.;]/.exec(e)&&typeof encodeURIComponent!=m?encodeURIComponent(e):e}U.embedSWF(this.serverUrl+"flash/ForticomAPIJS.swf?v=19","FAPI_Flash_wrap","1","1","9.0.0",this.serverUrl+"flash/expressInstall.swf",e,{menu:"false",scale:"noScale",allowScriptAccess:"always",bgcolor:"#FFFFFF"},{id:"FAPI_Flash"},this.swfCallback)},init:function(e,t){this.serverUrl=e,this.apiConnectionName=t,this.flash=document.getElementById("FAPI_Flash"),null==this.flash?this.embedFlash():i()},isFunc:function(e){return"[object Function]"===Object.prototype.toString.call(e)},getFlash:function(){if(!c.initialized)throw"Forticom API was not initialized properly";return this.flash},invokeUIMethod:function(){for(var e=0;e<arguments.length;e++){var t=arguments[e];null!=t&&(arguments[e]=String(t))}c.FLASH.getFlash().FAPI_send.apply(c.FLASH.getFlash(),arguments)}},UI:{showInvite:function(e,t,n){c.invokeUIMethod("showInvite",e,t,n)},showNotification:function(e,t,n){c.invokeUIMethod("showNotification",e,t,n)},showPermissions:function(e,t){Array.isArray(e)&&(e=JSON.stringify(e)),c.invokeUIMethod("showPermissions",e,t)},showPayment:function(e,t,n,i,o,a,r,s,l){c.invokeUIMethod("showPayment",e,t,n,i,o,a,r,s,l)},showPortalPayment:function(){c.invokeUIMethod("showPortalPayment")},showConfirmation:function(e,t,n){c.invokeUIMethod("showConfirmation",e,t,n)},setWindowSize:function(e,t){c.invokeUIMethod("setWindowSize",e,t)},changeHistory:function(e){c.invokeUIMethod("changeHistory",e)},scrollToTop:function(){c.invokeUIMethod("scrollToTop")},scrollTo:function(e,t){c.invokeUIMethod("scrollTo",e,t)},getPageInfo:function(){c.invokeUIMethod("getPageInfo")},navigateTo:function(e){c.invokeUIMethod("navigateTo",e)},postMediatopic:function(e,t,n){c.invokeUIMethod("postMediatopic",JSON.stringify(e),t?"on":"off",n?n.join(","):"")},showPromoPayment:function(e,t){c.invokeUIMethod("showPromoPayment",e,t)},isSupported:function(){return"W"==c.mode||"F"==c.mode}},MOBILE:{init:function(){i()}},OAUTH:{init:function(e,t,n){null!=n.access_token||null!=n.error?null==n.error?i():window.fapi_failure("Error with OAUTH authorization: "+n.error):window.location="https://connect.ok.ru/oauth/authorize?client_id="+e.app_id+"&scope="+(e.oauth_scope||"VALUABLE_ACCESS")+"&response_type=token&redirect_uri="+(e.oauth_url||window.location.href)+"&layout=a&state="+(e.oauth_state||"")}},Util:{isFunc:function(e){return"[object Function]"===Object.prototype.toString.call(e)},isString:function(e){return"[object String]"===Object.prototype.toString.call(e)},calcSignature:function(e,t){var n,i,o=[];for(n in e)o.push(n.toString());for(o.sort(),i="",n=0;n<o.length;n++){var a=o[n];"sig"!=a&&"resig"!=a&&"access_token"!=a&&(i+=o[n]+"="+e[o[n]])}return i=this.encodeUtf8(i+=t),r(i)},encodeUtf8:function(e){for(var t="",n=0;n<e.length;n++){var i=e.charCodeAt(n);i<128?t+=String.fromCharCode(i):(127<i&&i<2048?t+=String.fromCharCode(i>>6|192):(t+=String.fromCharCode(i>>12|224),t+=String.fromCharCode(i>>6&63|128)),t+=String.fromCharCode(63&i|128))}return t},getRequestParameters:function(e){var t={},e=e||window.location.search;if(e)for(var n=(e=e.substr(1)).split("&"),i=0;i<n.length;i++){var o=n[i].split("="),a=o[0],o=o[1];void 0!==a&&void 0!==o&&(o=decodeURIComponent(o.replace(/\+/g," ")),t[a]=o)}return t}},Client:{counter:0,window:this,head:null,applicationKey:null,sessionKey:null,accessToken:null,sessionSecretKey:null,apiServer:null,baseUrl:null,uid:null,format:"JSON",initialized:!1,load:function(e){var t=document.createElement("script"),n=!1;t.src=e,t.async=!0,t.onload=t.onreadystatechange=function(){n||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(n=!0,t.onload=t.onreadystatechange=null,t&&t.parentNode&&t.parentNode.removeChild(t))},this.head||(this.head=document.getElementsByTagName("head")[0]),this.head.appendChild(t)},call:function(e,i,t){this.initialized||this.initialize();var n,o="?";for(n in(e=this.fillParams(e)).sig=c.Util.calcSignature(e,this.sessionSecretKey),null!=t&&(e.resig=t),e)e.hasOwnProperty(n)&&(o+=n+"="+encodeURIComponent(e[n])+"&");var a="__fapi__callback_"+ ++this.counter;return this.window[a]=function(e,t,n){i(e,t,n),window[a]=null;try{delete window[a]}catch(e){}},this.load(this.baseUrl+o+"js_callback="+a),a},callWithPromise:function(e,t,n){var a=this;return new Promise(function(i,o){a.call(Object.assign({method:e},t),function(e,t,n){"ok"===e?i(t):o(n)},n)})},calcSignature:function(e){return this.initialized||this.initialize(),e=this.fillParams(e),c.Util.calcSignature(e,this.sessionSecretKey)},fillParams:function(e){return this.initialized||this.initialize(),(e=e||{}).application_key=this.applicationKey,this.sessionKey?e.session_key=this.sessionKey:e.access_token=this.accessToken,e.format=this.format,e},initialize:function(e,t,n){e=e||c.Util.getRequestParameters(),t=t||{},n=n||{},this.uid=e.logged_user_id,this.applicationKey=e.application_key||n.app_key,this.sessionKey=e.session_key,this.accessToken=t.access_token,this.sessionSecretKey=e.session_secret_key||t.session_secret_key,this.apiServer=e.api_server||"https://api.ok.ru/",this.baseUrl=this.apiServer+"fb.do",this.initialized=!0}}};return c});
