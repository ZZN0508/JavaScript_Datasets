define("lofty/alicn/suggestion/3.0/history",["lofty/lang/observer","lofty/util/storage/2.0/storage","jquery"],function(e,t,i){function o(e){return String(e).replace(/[&<>"'\/]/g,function(e){return c[e]})}function s(e){return String(e).replace(/&amp;|&lt;|&gt;|&quot;|&#39;|&#x2F;/g,function(e){return m[e]})}function n(){I.setJson("historyKeys",l),I.setItem("historyModify",+new Date),j.sycnToStorage()}function r(){l=I.getJson("historyKeys"),l||(l={objKeyItems:{},historyItems:[]}),isNaN(h)&&(h=0)}function y(e){for(var t,i=e;i--;)t=l.historyItems.shift(),delete l.objKeyItems[t.key];f()}function a(e){if(l.length>=d&&y(),e.key in l.objKeyItems)i.isPlainObject(l.historyItems[l.objKeyItems[e.key]])&&l.historyItems[l.objKeyItems[e.key]].key===e.key||i.each(l.historyItems,function(t,o){i.isPlainObject(o)&&o.key===e.key&&(l.objKeyItems[e.key]=t)}),l.historyItems.push(l.historyItems.splice(l.objKeyItems[e.key],1)[0]),f(l.objKeyItems[e.key]),n();else{if(!e.value)return!1;l.historyItems.push(e),l.objKeyItems[e.key]=l.historyItems.length-1,n()}}function u(e,t){i.ajax({url:k,dataType:"script",data:"type=pinyin&q="+e.replace(/%/g,"%25").replace(/&/g,"%26"),success:function(){var e=window._suggest_result_,i=e.result;if(i){var o="string"==typeof i[0]?i[0]:i[0].q;"function"==typeof t&&t(o)}}})}function f(e){e=e||0;for(var t=e;t<l.historyItems.length;t++)i.isPlainObject(l.historyItems[t])&&(l.objKeyItems[l.historyItems[t].key]=t)}var c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},m={};i.each(c,function(e,t){m[t]=e});var l,h,I,g,d=50,k="//suggest.1688.com/bin/suggest",v=!1,p=!1,b=0,K=!1,j={loaded:!1,init:function(){if(!v){v=!0;var e=this;I=new t,g=new t({crossDomain:!0});var i=0,o=function(){2===i&&e.sycnFromStorage(function(){p=!0,e.loaded=!0,r(),e.trigger("ready")})};if(!I.isSupport())return!1;g.ready(function(){i++,o()}),I.ready(function(){i++,o()})}},sycnToStorage:function(){g.setItem("historyKeys",I.getItem("historyKeys")),g.setItem("historyModify",I.getItem("historyModify"))},sycnFromStorage:function(e){var t,i;g.getItem("historyKeys",function(o){t=o.data,g.getItem("historyModify",function(o){i=o.data,I.setItem("historyKeys",t),I.setItem("historyModify",i),e&&e()})})},enableHtmlEscape:function(e){K=!!e},escapeHtml:o,unescapeHtml:s,query:function(e,t){if(!p)return!1;t=t||10;var s=parseInt(I.getItem("historyModify"),10);(0===b||s>b)&&r();var n,y=l.historyItems,a=[];if(!y)return[];if(e)for(var u=y.length;u--;){var f=y[u];if(i.isPlainObject(f)&&((0===f.key.indexOf(e)||0===f.value.indexOf(e))&&(n={},n.key=f.key,n.value=f.value,n.htmlKey=n.key,K&&(n.key=o(n.key)),a.push(n)),a.length>=t))break}else for(var u=y.length;u--&&!(i.isPlainObject(y[u])&&(n={},y[u].key&&(n.key=y[u].key,n.value=y[u].value,n.htmlKey=n.key,K&&(n.key=o(n.key)),a.push(n)),a.length>=t)););return a},remove:function(e){if(!p)return!1;var t=parseInt(l.objKeyItems[e]),i=l.historyItems;if(isNaN(t))return!1;if(void 0===i[t]||i[t].key!==e){do t--;while(t>=i.length);if(i[t].key!==e)return!1}return i.splice(t,1),f(0),delete l.objKeyItems[e],n(),!0},add:function(e){return p&&e?void(e in l.objKeyItems?a({key:e}):u(e,function(t){a({key:e,value:t})})):!1},clear:function(){return p?(I.removeItem("historyKeys"),I.removeItem("historyModify"),l={objKeyItems:{},historyItems:[]},void this.sycnToStorage()):!1}};return e.mixTo(j),j});;