_fsDefine(["fs",_fsNormalizeUrl("$fs.utils.js"),_fsNormalizeUrl("$fs.compress.js"),"exports"],function(E,D,i,e){var P={loadedEmitter:new D.FSEvent,initializedEmitter:new D.FSEvent,inviteShownEmitter:new D.FSEvent,inviteAcceptedEmitter:new D.FSEvent,inviteAbandonedEmitter:new D.FSEvent,inviteDeclinedEmitter:new D.FSEvent,trackerShownEmitter:new D.FSEvent,customInvitationRequested:new D.FSEvent,CPPS:null,_triggerResetLock:null,state:{didInvite:!1},inviteSetup:null},R=window,t=((w=n.prototype).calcReplayPoolStatus=function(e){var t,i=this.cfg.config,r=i.replay_pools,s=R.location.toString();if(!r||0===r.length||!0===this.pooloverride)return e(!0);var n=this.stg.get("pl");if(!E.isDefined(n))for(t=0;t<r.length;t++)D.testAgainstSearch(r[t].path,s)&&(n=100*Math.random()<r[t].sp?1:0,this.stg.set("pl",n,144e5));var o=i.replay_repools;if(0===n&&o&&0<o.length)for(t=0;t<o.length;t++)D.testAgainstSearch(o[t].path,s)&&(n=100*Math.random()<o[t].sp?1:0,this.stg.set("pl",n,144e5));return e(!!n)},w.optoutCheck=function(e,t){var i=this;this.stg.ready.subscribe(function(){(!0===i.stg.get("optout")?t:e)()},!0,!0)},w.browserCheck=function(e,t){return!(!e.isMobile&&t.config.browser_cutoff[e.browser.name]&&e.browser.actualVersion<t.config.browser_cutoff[e.browser.name])},w.featureCheck=function(e,t){return!(t.config.persistence==D.storageTypes.DS&&!e.supportsLocalStorage)},w.platformCheck=function(e,t){return!(t.config.platform_cutoff[e.os.name]&&e.os.version<t.config.platform_cutoff[e.os.name])},w.checkDeviceBlacklist=function(e,t){for(var i=0;i<t.config.device_blacklist.length;i++)if(-1<E.toLowerCase(e.agent).indexOf(E.toLowerCase(t.config.device_blacklist[i])))return!1;return!0},w._match=function(e,t,i){var r=e.include,i=e[i||"globalExclude"];if(e.criteria){if(!e.criteria.supportsSmartPhones&&!t.isTablet&&t.isMobile)return!1;if(!e.criteria.supportsTablets&&t.isTablet)return!1;if(!e.criteria.supportsDesktop&&!t.isMobile)return!1}return(!i||!this.runAllTests(i,t,!1,!0))&&(!r||this.runAllTests(r,t,!1,!0))},w.runAllTests=function(e,t,i,r){var s,n,o=new D.Cookie({}),a={urls:R.location.href.toString(),referrers:document.referrer.toString(),userAgents:R.navigator.userAgent};for(n in e){var c=e[n];if(0<c.length){if(s=!1,a[n])s=function(e,t){for(var i=0,r=(t=!Array.isArray(t)?[t]:t).length;i<r;i++)if("string"==typeof t[i]&&(t[i]=t[i].replace(/-_DS_-/gi,"$$")),D.testAgainstSearch(t[i],e))return!0;return!1}(a[n],c);else if("browsers"==n)for(var l=t.browser.name,f=t.browser.actualVersion,g=0;g<c.length;g++)-1<E.toLowerCase(l).indexOf(E.toLowerCase(c[g].name))&&(!c[g].comparison||"lt"==c[g].comparison&&f<c[g].version||"eq"==c[g].comparison&&f==c[g].version||"gt"==c[g].comparison&&f>c[g].version)&&(s=!0);else if("cookies"==n)for(var u=0;u<c.length;u++){var d=c[u],h=o.get(d.name);(E.isDefined(d.value)&&h==d.value||!E.isDefined(d.value)&&h)&&(s=!0)}else if("variables"==n)for(var p=0;p<c.length;p++){var v=c[p],m=(m=D.retrieveNestedVariable(R,v.name))||"boolean"!=typeof m&&"",b=E.isDefined(v.value);(b&&m===v.value||b&&D.testAgainstSearch(v.value,m)||!b&&m)&&(s=!0)}if(!s&&i)return!0;if(s&&r)return!0}}return!1},n),f=((w=s.prototype).decideModernSurvey=function(){var e=this.cfg.config.abSurveyType,e=e&&e.shouldTest&&this.globalConfig.modernSurveyUrl&&r(e,this.def);return this.cfg.config.onlyModernSurvey?{modernChosen:!0,modernPercentage:100}:e?{modernChosen:e.modernPercentage>=Math.floor(100*Math.random()),modernPercentage:e.modernPercentage}:{modernChosen:!1,modernPercentage:0}},w.getMeasureId=function(){return[this.def.name,this.def.site,this.def.section,this.locale,this.qual?this.qual.qualifiesValue:null].filter(function(e){return e}).join("-")},w.getUrl=function(){var e=this.decideModernSurvey();if(e.modernChosen)return this._buildUrl(this.globalConfig.modernSurveyUrl,this._getParams({}));var t=D.now()+"_"+Math.round(1e13*Math.random()),e=this._getParams({a:t,b:D.hash(t),c:864e5,mp:e.modernPercentage});return this._buildUrl(this.globalConfig.surveyUrl,e)},w._getParams=function(e){return E.ext({sid:this.getMeasureId(),cid:this.globalConfig.customerId,pattern:this.cpps.get(this.def.pattern)||this.def.pattern},e||{},!1)},w._buildUrl=function(e,t){var i,r=e+"?";for(i in t)r+=E.enc(i)+"="+E.enc(t[i])+"&";return r+this.cpps.toQueryString(["browser","os"])},w.getShortSurveyUrl=function(e){var t=e.pageView,i=e.paginationType,e=e.midOverride;try{if(1===t&&sessionStorage.removeItem("FSR_SSURL"),1<t){var r=sessionStorage.getItem("FSR_SSURL");if(r)return r}}catch(e){}r=this.globalConfig.modernSurveyUrl,i=this._getParams({template:"contextual",pv:t,paginationType:i});return e&&(delete i.cid,delete i.sid,i.mid=e),i.paginationType||delete i.paginationType,this._buildUrl(r,i)},w.getShortSurveyOrigin=function(){return E.globalConfig.modernSurveyUrl.replace(/\/sv$/,"")},s),r=function(e,t){var i,r,s,n=t.name||"";for(n+="-"+(t.section||""),n+="-"+(t.site||""),i=0;i<e.defs.length;i++)if(r=(s=e.defs[i]).name||"",r+="-"+(s.section||""),(r+="-"+(s.site||""))==n)return s;return null};function s(e,t,i,r){this.cfg=e,this.globalConfig=e.globalConfig||E.globalConfig,this.cpps=t,this.def=i,this.locale=t.get("locale")||"en",this.qual=r}function n(e,t){this.stg=e,this.cfg=t}function o(e,t,i,r,s,n){var o,a={width:700,height:350,left:50,top:50,resizable:"no",scrollbar:"1",scrollbars:"1",toolbar:"no",menubar:"no",location:"0",directories:"no",status:"no"},n=n?function(e,t){var i=void 0!==window.screenLeft?window.screenLeft:screen.left,r=void 0!==window.screenTop?window.screenTop:screen.top,s=window.innerWidth;window.innerWidth||(s=document.documentElement.clientWidth||screen.width);var n=window.innerHeight;return{left:s/2-e/2+i,top:(n=!window.innerHeight?document.documentElement.clientHeight||screen.Height:n)/2-t/2+r}}(i.width||a.width,i.height||a.height):{},c=E.ext(a,i,n),l="";for(o in c)l+=o+"="+c[o]+",";var f=this._win=R.open(e,t,l);return f&&s&&(f.blur(),f.opener.window.focus(),R.focus(),"Firefox"==r.browser.name?((s=R.open("about:blank")).focus(),s.close()):r.isIE&&setTimeout(function(){f.blur(),f.opener.window.focus(),R.focus()},1e3)),f}function A(e,t,i,r,s,n,o,a){return P.inviteSetup?a.call(P.inviteSetup):P.inviteSetup=new L(e,t,i,r,s,n,o,a),P.inviteSetup}var x=((w=d.prototype)._sendDefinition=function(){var e={method:"init",cfg:E.ext({active_surveydef:null},this.cfg,{globalConfig:E.globalConfig}),hb_i:this.hbi,cpps:this.cpps.all()};this.disp&&(e.display=this.disp),this.template&&(e.template=this.template),this.stg.set("page_hb",D.now(),this.cfg.config.trackerHeartbeatTimeout,!1),this.stg.set("trackerinfo",e,6e4,!1);e=D.getGeneralStorage(this.br).get("ipt");this.stg.set("ipt",e),this.stg.set("ckcpps",this.cpps.all(),2e5,!1)},w.show=function(e){this.wref=o(this._url,"fsTracker",{width:700,height:450},e,!0,this.cfg.config.centerTrackerPopup)},w.applyExisting=function(e,t){(this.wref=t).location=this._url},w.dispose=function(){for(var e=0;e<this._fcBindings.length;e++)this._fcBindings[e].unsubscribe();D.getGeneralStorage(this.br)===this.stg&&this.stg.dispose(),this.stg=null,clearInterval(this._heartbeat)},d),a={mobileOnExitInitialize:{path:"/e",url:"/initialize"},mobileOnExitHeartbeat:{path:"/e",url:"/recordHeartbeat"}},c=function(e,t,i,r){var s=new D.ImageTransport,e="https://"+E.globalConfig.mobileOnExitUrl+e.path+(e.url||"");s.send({url:e,success:i||function(){},failure:r||function(){},data:t})},l=((w=u.prototype).init=function(e,t){t=t||function(){};var i=new f(this.cfg,this.cpps,this.def,null).decideModernSurvey(),r=D.now()+"_"+Math.round(1e13*Math.random()),r={a:r,notify:e,b:D.hash(r),c:864e5,cid:E.globalConfig.customerId,sid:this._measureName,rid:this.rid,uid:D.now(),support:"SMSEMAIL"==this.itype?"b":"EMAIL"==this.itype?"e":"s",cpps:"version="+encodeURIComponent(E.globalConfig.codeVer)+"&"+this.cpps.toQueryString()};i.modernChosen&&(r=E.ext({fs_renderer:"modern"},r)),c(a.mobileOnExitInitialize,r,t,t)},w.beginHeartbeat=function(){var e=this;this._timer&&(clearTimeout(this._timer),this._timer=null);function t(){c(a.mobileOnExitHeartbeat,{cid:E.globalConfig.customerId,sid:e._measureName,rid:e.rid,uid:D.now()},function(){},function(){})}this._timer=setInterval(t,this.cfg.config.onExitMobileHeartbeatInterval),t()},u),L=((w=g.prototype).initialize=function(){var r=E.getProductConfig("trigger"),s=this.trig,n=this.stg,o=this.cpps,a=this.invite,c=this.jrny;this.didInitialize||(this.didInitialize=!0,c.addEventsDefault("properties",{fs_defName:[s.surveydef.name],fs_section:[s.surveydef.section],fs_displayName:[a.display.displayname],fs_displayTemplate:[a.display.template],fs_pvInvited:[s.pageViewCount],fs_language:[a.locale],fs_samplePercentage:[s.surveydef.criteria.sp.reg],fs_loyaltyFactor:[s.surveydef.criteria.lf],fs_environment:[E.isProduction?"production":"staging"],fs_deployType:[E.isSelfHosted?"on-prem":"cloud"],fs_inviteType:["intercept"],fs_triggerMethod:[this.triggerMethod]}),o.set("TriggerMethod",this.triggerMethod),o.set("dn",a.display.displayname),o.set("dt",a.display.template),a.loadResources(this.resourcesready),a.declined.subscribe(function(e){var t=(E.isDefined(r.active_surveydef)&&E.isDefined(r.active_surveydef.repeatDays)?r.active_surveydef:r.config).repeatDays;n.set("i","d"),n.setMaxKeyExpiration(24*t.decline*60*60*1e3),c.addEventObj({name:"fs_inviteDeclined",properties:{action:[e]}}),P.inviteDeclinedEmitter.fire(s.surveydef,n,r,o),s.surveydef.cxRecord&&P.rec&&"y"!=n.get("fbr")&&(P.rec.cancelRecord(),s.recordController=P.rec=null),P.state.inviteSituation="DECLINED"}),a.abandoned.subscribe(function(){c.addEventString("fs_inviteAbandoned"),n.set("i","a"),P.state.inviteSituation="ABANDONED",P.inviteAbandonedEmitter.fire(s.surveydef,n,r,o),n.set("rw",D.now()+r.config.reinviteDelayAfterInviteAbandon)}),a.accepted.subscribe(function(e,t){var i=(E.isDefined(r.active_surveydef)&&E.isDefined(r.active_surveydef.repeatDays)?r.active_surveydef:r.config).repeatDays;switch(n.setMaxKeyExpiration(24*i.accept*60*60*1e3),P.inviteAcceptedEmitter.fire(s.surveydef,n,r,o),s.surveydef.cxRecord&&P.rec&&P.rec.recorder&&P.rec.beginTransmitting(),c.initPopupId(),c.addEventString("fs_inviteAccepted"),n.set("i","x"),P.state.inviteSituation="ACCEPTED",n.set("ixw",D.now()),e){case"TRACKER":s.popTracker(a);break;case"INSESSION":s.popSurvey();break;case"SMS":case"EMAIL":case"SMSEMAIL":M(s,t,e),s.stg.set("mhbi",{ui:t,it:e});break;case"SHORTSURVEY":break;default:throw new Error("Unknown inviteType: "+e)}}))},w.present=function(){var t=this,i=E.getProductConfig("trigger"),r=this.invite,s=this.stg,n=this.jrny,o=this.trig,a=this.cpps;P.state.didInvite||(P.state.didInvite=!0,this.resourcesready.subscribe(function(){var e=i.config.inviteDelay;null!=r.display.inviteDelay&&(e=r.display.inviteDelay);e=Math.max(0,e-(D.now()-E.startTS));"SHORTSURVEY"===r.display.inviteType&&(e="p"===s.i?0:e),setTimeout(function(){t.invite.present(t.browser),"p"!==s.get("i")&&n.addEvent("fs_inviteShown"),s.set("ipt",D.now()),s.set("i","p"),P.state.inviteSituation="PRESENTED",P.inviteShownEmitter.fire(o.surveydef,s,i,a)},e)},!0,!0))},w.abTestShortSurvey=function(e){var t,i;"SHORTSURVEY"===e.inviteType&&e.shortSurvey&&e.shortSurvey.abTestPercent&&e.shortSurvey.abTestPercent<100&&0<e.shortSurvey.abTestPercent&&(t=new f(this.config,this.cpps,this.trig.surveydef).getMeasureId()+"-"+e.displayname+"-AB",null==(i=this.stg.get(t))&&(i=100*Math.random()<=e.shortSurvey.abTestPercent?1:0,this.stg.set(t,i)),i||(e.inviteType="TRACKER"))},g),M=function(e,t,i){var r=e.stg.get("ipt"),r=(D.now()-r)/1e3;e.cpps.set("invite_presented_interval",r);var s=new l(i,E.getProductConfig("trigger"),e.surveydef,e.cpps,e.stg.get("rid"),e.locale);e.stg.get("mhbi")?s.beginHeartbeat():s.init(t,function(){s.beginHeartbeat()})};function g(r,t,s,n,o,e,i,a){var c=this;this.trig=r,this.browser=t,this.stg=s,this.cpps=n,this.displayoverride=o,this.jrny=e,this.resourcesready=new D.FSEvent,this.triggerMethod=i;var l=E.getProductConfig("trigger");if(this.config=l,E.isDefined(this.trig.surveydef.inviteExclude)&&E.isDefined(this.trig.crit)&&this.trig.crit.runAllTests(this.trig.surveydef.inviteExclude,this.browser,!1,!0))return!1;R.fsReady(function(){var e;if(r.invite&&r.invite.dispose(),t.isMobile&&r.cfg.config.pagesInviteAvailable)if(null===(e=s.get("pia")))s.set("pia",r.cfg.config.pagesInviteAvailable-1);else if(0<e)s.set("pia",--e);else if(0===e)return;var i=g.getFittingDisplay(r.surveydef,o,n.get("locale"),t);s.set("dn",i.displayname),c.abTestShortSurvey(i),"SHORTSURVEY"!==i.inviteType?R._fsRequire([E.makeURI("$fs.invite.js")],function(e){c.invite=r.invite=new e(l,r.surveydef,t,i,n,P),a&&a.call(c)}):R._fsRequire([E.makeURI("$fs.shortsurvey.js")],function(e){var t=new f(l,n,r.surveydef);c.invite=r.invite=new e(l,r.surveydef,i,n,s,t),a&&a.call(c)})})}function u(e,t,i,r,s,n){this.itype=e,this.cfg=t,this.def=i,this.cpps=r,this.rid=s,this._measureName=this.def.name+"-"+(E.isDefined(this.def.site)?this.def.site+"-":"")+(E.isDefined(this.def.section)?this.def.section+"-":"")+(n||this.def.language.locale)}function d(e,t,i,r,s,n,o){var a=this;P.tracker&&(P.tracker.dispose(),P.tracker=null),P.tracker=this,E.ext(this,{template:e,def:t,cfg:i,disp:n,_fcBindings:[]},!1),this.cpps=s,this.br=o,this.stg=r;n=0;window.performance&&window.performance.timing&&(n=window.performance.timing.domComplete-window.performance.timing.navigationStart),this.hbi=3*Math.max(i.config.trackerHeartbeatTimeout,P.pageLoadTime,n),e&&P.trackerShownEmitter.fire(t,r,i,s),E.globalConfig.storage!==D.storageTypes.MC&&this.stg._readyState.subscribe(function(){var e;0<r._serverFails&&((e=D.getGeneralStorage(o)).set("i","f"),P.state.inviteSituation="BRAINFAILED",e.set("fw",D.now()+432e5))},!0,!1),this.stg.ready.subscribe(function(){a.stg.set("tracker_hb",D.now(),a.hbi,!1);function e(e){a.stg.set("page_hb",D.now(),a.hbi,!!e)}var t=a.stg.onCommit.subscribe(function(){null===r.get("tracker_hb")?D.now()-a.lastTimeSeenTracker>a.cfg.config.trackerHeartbeatTimeout&&(t.unsubscribe(),delete a.lastTimeSeenTracker,a.dispose()):a.lastTimeSeenTracker=D.now()},!1,!1);a._heartbeat=setInterval(e,Math.round(.5*a.cfg.config.trackerHeartbeatTimeout)),e(!0)},!0,!0),D.Bind(R,"unload",function(){a.hbi=a.cfg.config.trackerHeartbeatLongTimeout,a.stg.set("page_hb",D.now(),a.hbi,!0)});i=E.enc;this._url=E.makeURI(["$fs.tracker.html?uid=",i(r.uid||""),"&sitekey=",i(E.globalConfig.siteKey),"&domain=",i(D.getRootDomain()),"&gw=",i(E.makeURI("trigger/__gwtest__")),"&brain_url=",i(E.globalConfig.brainUrl),"&fsrlocale=",i(s.get("locale")||"en"),"&_svu_=",i(E.globalConfig.surveyUrl),"&_cv_=",i(E.globalConfig.codeVer),"&_issh_=",i(E.isSelfHosted),"&_vt_=",i(E.tagVersion),"&_au_=",i(E.globalConfig.analyticsUrl),"&_pa_=",i(E.assetLocation),E.codeLocation?"&_cl_="+i(E.codeLocation):""].join("")),this.cpps.onSet.subscribe(function(e,t){var i={};i[e]=t,a.stg.set("ckcpps",i,2e5,!1)}),this.stg.set("ckcpps",this.cpps.all(),2e5,!1),this._sendDefinition()}L.getFittingDisplay=function(e,t,i,r){i=i||P.CPPS.get("locale")||"en";var s,n,o,a,c={};if(s=(r=r||P.browser).isMobile&&e.display.mobile?e.display.mobile:e.display.desktop)for(o=0;o<s.length;o++)a=c.dialog||{},c=E.ext({},c),c=E.ext(c,s[o]),s[o].dialog&&c.dialog&&(c.dialog=E.ext(E.ext({},a),s[o].dialog)),s[o]=c;if(t){for(o=0;o<s.length;o++)if(s[o].displayname==t){n=s[o];break}}else n=s[Math.round(999999999999*Math.random())%s.length];return n.dialog.locales&&n.dialog.locales[i]&&(i=n.dialog.locales[i],n.dialog=E.ext(n.dialog,i),i.localeImages&&(n=E.ext(n,i.localeImages))),E.ext({inviteLogo:"",trackerLogo:"",siteLogoAlt:""},n)};var O=((w=v.prototype)._bindToLink=function(e,t){for(var i=document.querySelectorAll(e.selector),r=0;r<i.length;r++){var s=i[r],n=!0,o=void 0;if(e.attribute&&(n=!1,(o=s.getAttribute(e.attribute))&&(n=!0,e.patterns&&0<e.patterns.length)))for(var n=!1,a=0;a<e.patterns.length;a++)if(-1<E.toLowerCase(o).indexOf(E.toLowerCase(e.patterns[a]))){n=!0;break}n&&D.Bind(s,"trigger:click",function(t,i,r){return function(e){i.preventDefault&&D.preventDefault(e),r.call(t,i)}}(this,e,t))}},w.performBindings=function(e){if(e&&this.cfg){var t=this.cfg;if(t.cancel&&0<t.cancel.length){function i(){e.cancelTracker(),e.jrny.addEventString("fs_linksCancel")}for(var r=0;r<t.cancel.length;r++)this._bindToLink(t.cancel[r],i)}if(t.survey&&0<t.survey.length){function s(){e.popSurvey()}for(r=0;r<t.survey.length;r++)this._bindToLink(t.survey[r],s)}if(!e.browser.isMobile&&t.tracker&&0<t.tracker.length){function n(){e.popTracker()}for(r=0;r<t.tracker.length;r++)this._bindToLink(t.tracker[r],n)}}},v),h=((w=p.prototype).doesPassCriteria=function(){var e=this.crit,t=this.cfg,i=P.state,r="DIDNOTPASSCRITERIA";if(e.platformCheck(this.browser,t))if(e.browserCheck(this.browser,t))if(e.checkDeviceBlacklist(this.browser,t)){if(e.featureCheck(this.browser,t))return!0;i.inviteStatus=r,i.reason="BROWSER"}else i.inviteStatus=r,i.reason="DEVICE";else i.inviteStatus=r,i.reason="BROWSER";else i.inviteStatus=r,i.reason="PLATFORM";return!1},w.popTracker=function(e){var t,i=this;this.stg.set("i","x"),P.state.inviteSituation="ACCEPTED",this.didPopTrackerAlready="y"==this.stg.get("tp"),P.state.didInvite=!0,this.didPopTrackerAlready||(this.stg.set("tp","y"),e?(i.tracker=new x(e.template,i.surveydef,this.cfg,D.getBrainStorage(i.browser,i.stg.uid),i.cpps,e.display,i.browser),i.tracker.show(i.browser)):(t=o("about:blank","fsTracker",{width:700,height:400},this.browser,!0,this.cfg.config.centerTrackerPopup),A(this,i.browser,i.stg,i.cpps,!1,i.jrny,"Traditional",function(){i.tracker=new x(this.invite.template,i.surveydef,this.cfg,D.getBrainStorage(i.browser,i.stg.uid),i.cpps,this.invite.display,i.browser),i.tracker.applyExisting(i.browser,t),i.surveydef.cxRecord&&P.rec&&P.rec.recorder&&P.rec.beginTransmitting()})))},w.canDisplayInvitation=function(){if(!this.crit._match(this.cfg.config,this.browser,"inviteExclude"))return!1;var e=L.getFittingDisplay(this.cfg.active_surveydef);if("SHORTSURVEY"===e.inviteType&&e.shortSurvey&&0<e.shortSurvey.idleViewsBeforeStop){var t=new f(this.cfg,this.cpps,this.surveydef).getMeasureId(),i=this.stg.get(t+"pv");if(!this.stg.get(t+"li")&&e.shortSurvey.idleViewsBeforeStop<i)return!1}return!0},w.popSurvey=function(e){this.stg.set("i","x"),P.state.inviteSituation="ACCEPTED",this.didPopTrackerAlready="y"==this.stg.get("tp"),P.state.didInvite=!0,this.didPopTrackerAlready?this.stg&&this.stg.get("page_hb")&&D.getBrainStorage(this.browser,this.stg.uid).set("trackercmd",{method:"survey"},6e4,!0):(this.stg.set("tp","y"),o(new f(this.cfg,this.cpps,this.surveydef,null,e).getUrl(),"acsSurvey",{width:700,height:400},this.browser,!1,this.cfg.config.centerTrackerPopup))},w.init=function(){for(var e,t,i,r,s=this.cfg.surveydefs,n=function(e,t){if(!E.isDefined(e))return null;var i=null;return"number"==typeof e&&0<=e&&e<t.length?i=t[e].uid:"string"!=typeof e||(i=e),i}(this.stg.get("def"),s),o=0;o<s.length;o++){if(!(i=s[o]).uid||"string"!=typeof i.uid)throw new Error('All survey definitions need a "uid" string property.');E.isDefined(n)&&i.uid==n&&(t=o,e=i),r&&(i=E.ext(r,i),!s[o].site&&r.site&&delete i.site,!s[o].section&&r.section&&delete i.section,s[o]=i),r=E.ext({},i)}if(e&&"default"!=e.selectMode&&"pin"!=e.selectMode){if(e)return this.cfg.active_surveydef=e,this.surveydef=e,this.locale=this._initLocale(),this.cpps.set("locale",this.locale),e.section&&this.cpps.set("section",e.section),e}else for(var a,c=e&&"pin"==e.selectMode?t+1:s.length,l=0;l<c;l++)if(a=s[l],t==l&&"pin"==e.selectMode||this.crit._match(a,this.browser))return"x"===this.stg.get("i")&&this.stg.set("def",a.uid,this.cfg.config.surveyDefResetTimeout||864e5),this.cfg.active_surveydef=a,this.surveydef=a,this.locale=this._initLocale(),this.cpps.set("locale",this.locale),a.section&&this.cpps.set("section",a.section),a;return e&&this.isTrackerAlive()?(this.tracker=new x(null,e,this.cfg,D.getBrainStorage(this.browser,this.stg.uid),this.cpps,null,this.browser),e):null},w._initLocale=function(){var e,t=this.surveydef,i=t.language;if(E.isDefined(i.src)&&E.isDefined(i.locales)){switch(i.src){case"variable":E.isDefined(i.name)&&(e=D.retrieveNestedVariable(window,i.name));break;case"cookie":E.isDefined(i.name)&&(e=new D.Cookie({}).get(i.name));break;case"url":var r=i.locales;if(E.isDefined(r))for(var s=0,n=r.length;s<n;s++)if(E.isDefined(r[s].locale)&&E.isDefined(r[s].match)&&location.href.match(r[s].match))return this.locale=r[s].locale,r[s].criteria&&E.ext(this.surveydef.criteria,r[s].criteria),this.locale!==t.language.locale&&(t.language.locale=this.locale),r[s].locale;break;default:throw new Error("Unknown locale src: "+i.src)}if(e)for(var o=0;o<i.locales.length;o++)if(i.locales[o].match==e)return i.locale=i.locales[o].locale,i.locales[o].criteria&&E.ext(this.surveydef.criteria,i.locales[o].criteria),i.locale}return i.locale||"en"},w.isTrackerAlive=function(){return E.isDefined(this.stg.get("tracker_hb"))},w.cancelTracker=function(){D.getBrainStorage(this.browser,this.stg.uid).set("trackercmd",{method:"close"},6e4,!0),this.stg.set("i","a"),P.state.inviteSituation="ABANDONED",E.isDefined(this.tracker)&&clearInterval(this.tracker._heartbeat)},w.logState=function(){this.pageViewCount=(this.stg.get("pv")||0)+1,this.stg.set("pv",this.pageViewCount,this.cfg.config.pageViewsResetTimeout||864e5)},w.logDefState=function(){var e;this.surveydef&&(e=new f(this.cfg,this.cpps,this.surveydef).getMeasureId(),this.defPageViewCount=(this.stg.get(e+"pv")||0)+1,this.stg.set(e+"pv",this.defPageViewCount,this.cfg.config.pageViewsResetTimeout||864e5))},w.evalLoyaltySampling=function(e){var t=this.surveydef,i=t[e]||t.criteria,e=this.stg.get("pl"),t=E.isDefined(e)&&1!=e?i.sp.outreplaypool||0:i.sp.reg||0,e=100*Math.random();return this.defPageViewCount>=i.lf&&e<=t},w.dispose=function(){this.disposed||(this.stg.save(!0),this.disposed=!0,this.invite&&this.invite.dispose(),delete P.inviteSetup,this.mouseoff&&this.mouseoff.dispose(),P.rec&&(P.RecordController.disposeInstance(),P.RecordController=null,P.rec=null),D.Unbind("trigger:*"))},p);function p(e,t,i,r,s,n){var o,a;this.stg=e,this.cfg=t,this.browser=i,this.crit=r,this.cpps=s,this.jrny=n;n=E.globalConfig.adobeRsid;if(!e.get("pv")){for(a in o={browser:i.browser.name+" "+i.browser.version,os:i.os.name,referrer:document.referrer.toString(),site:D.getRootDomain(),sitekey:E.globalConfig.siteKey||""})E.hasProp(o,a)&&s.set(a,o[a]);D.INT.GA.has()&&D.INT.GA.uid(function(e){e&&s.set("GA_UID",e)});i=function(e){s.set(e.name,e.value)};D.INT.OM.uid(n,i),D.INT.OM.mcid(n,i),D.INT.OM.beacon(function(e){s.set("OMTR_BEACON",e)})}this.heartbeatExpired=new D.FSEvent}function v(e){this.cfg=e}function U(e,t,i,r,s,n){return new h(e,t,i,r,s,n)}var m,b,y=new D.FSEvent;E.API.expose("CPPS",{set:function(e,t){y.subscribe(function(){P.CPPS.set(e,t)},!0,!0)},get:function(e,t){t=t||console.log,y.subscribe(function(){t(P.CPPS.get(e))},!0,!0)},all:function(e){e=e||console.table||console.log,y.subscribe(function(){e(P.CPPS.all())},!0,!0)}}),E.API.expose("clearState",function(){y.subscribe(function(){P.tracker&&P.tracker._heartbeat&&clearInterval(P.tracker._heartbeat),P.stg.reset(),E.supportsDomStorage&&sessionStorage.removeItem("acsFeedbackSubmitted"),P.rec&&P.rec.recorder&&P.rec.recorder.clearState()},!0,!0)}),E.API.expose("dispose",function(){y.subscribe(function(){P.trig&&P.trig.dispose()},!0,!0)}),E.API.expose("getState",function(e){e=e||console.log,y.subscribe(function(){e(P.state)},!0,!0)}),E.API.expose("getConfig",function(){return E.ext({},E.getProductConfig("trigger"),{global:E.globalConfig})}),E.API.expose("getConfigFormatted",function(){var e=E.getProductConfig("trigger");if(console&&console.info&&(console.info("************************** Trigger Configuration **************************"),console.info("Config: ",e.config),e.surveydefs&&e.surveydefs.length)){console.info("************************** Surveydefs Configuration **************************");for(var t=0;t<e.surveydefs.length;t++)console.info("************************** Surveydef "+(t+1)+" **************************"),console.info("Config: ",e.surveydefs[t])}}),E.API.expose("optOut",function(){var e=R.location.toString();R.location=-1<e.indexOf("#")?e+"&fscommand=fsoptout":e+"#fscommand=fsoptout",R.location.reload()}),E.API.expose("test",function(){var e=R.location.toString();R.location=-1<e.indexOf("#")?e+"&fscommand=fstest":e+"#fscommand=fstest",R.location.reload()});var w=function(){y.subscribe(function(){m&&(clearTimeout(m),m=null),m=setTimeout(function(){var e;m=null,P._triggerResetLock||(P._triggerResetLock=!0,(e=P.trig)&&(e.dispose(),P.trig=null),E.resetStartTS(),E.nextTick(b))},250)},!0,!0)};E.API.expose("run",w),E.API.expose("pageReset",w),E.API.expose("showInvite",function(t){y.subscribe(function(){var e;document.getElementById("fsrInvite")||document.getElementById("acsMainInvite")||(e=P.trig||U(P.stg,E.getProductConfig("trigger"),P.browser,P.crit,P.CPPS)).init()&&e.doesPassCriteria()&&e.surveydef&&(P.state.didInvite=!1,A(e,P.browser,P.stg,P.CPPS,t,P.jrny,"Traditional",function(){this.initialize(),this.present()}))},!0,!0)}),E.API.expose("onLoaded",P.loadedEmitter),E.API.expose("onInitialized",P.initializedEmitter),E.API.expose("onInviteShown",P.inviteShownEmitter),E.API.expose("onInviteAccepted",P.inviteAcceptedEmitter),E.API.expose("onInviteAbandoned",P.inviteAbandonedEmitter),E.API.expose("onInviteDeclined",P.inviteDeclinedEmitter),E.API.expose("onTrackerShown",P.trackerShownEmitter),E.API.expose("customInvitationRequested",P.customInvitationRequested),E.API.expose("Journey",{addEvent:function(e){y.subscribe(function(){P.jrny.addEvent(e)},!0,!0)},addEventObj:function(e){y.subscribe(function(){P.jrny.addEventObj(e)},!0,!0)},addEventString:function(e){y.subscribe(function(){P.jrny.addEventString(e)},!0,!0)}}),E.API.expose("Storage",{get:function(e,t){t=t||console.log,y.subscribe(function(){t(P.stg.get(e))},!0,!0)},all:function(r){r=r||console.table||console.log,y.subscribe(function(){var e,t=P.stg.all(),i={};for(e in t)1!==t[e].d&&(i[e]=t[e]);r(i)},!0,!0)}});var S=new D.Cookie({path:"/",secure:!1,encode:!0});E.API.expose("Cookie",{get:function(t,e){e=e||console.log||function(){},y.subscribe(function(){try{return e("_4c_"===t?JSON.parse(i.decompress(decodeURIComponent(S.get(t)))):S.get(t))}catch(e){console.error("trigger: couldn't read cookie",t)}},!0,!0)}});function N(i,e,r,t,s,n){e&&t&&E.globalConfig.products.record&&R._fsRequire([E.makeURI("$fs.record.js")],function(e){r.set("rc","true");var t={id:E.globalConfig.customerId||D.getRootDomain()||"record_customerId"};P.RecordController=e,P.rec=e.getInstance(i,R,r,t,s),n&&(n.recordController=P.rec)})}var _={hash:R.location.hash,href:R.location.href,pathname:R.location.pathname},B=window!=R.top;function k(){var C,T=E.getProductConfig("trigger");P._triggerResetLock=!0,-1<_.href.indexOf("fs.tracker.html")?P._triggerResetLock=!1:(C=new D.Browser).ready.subscribe(function(){var _=D.getGeneralStorage(C),k=new t(_,T),I=new D.CPPS(_,T.config.cppsResetTimeout);I.set("url",R.location.toString().replace(/(\?|&)(cpp\[[^&#]+\]+)=([^&#]*)/g,"")),_.ready.subscribe(function(){_.upgradeOldStorage(function(){P.pageLoadTime=D.now()-E.startTS,D.initBehavioralData(E.globalConfig.customerId||D.getRootDomain()||"trigger_customerId",_,C,I);var e,w=P._journey=new D.Journey({customerId:E.globalConfig.customerId||D.getRootDomain()||"trigger_customerId",appId:D.APPID.TRIGGER,stg:_,browser:C,useSessionId:!0,usePopupId:!1});w.addEventsDefault("properties",{fs_site:[D.getRootDomain()],fs_repeatDaysAccept:[T.config.repeatDays.accept],fs_repeatDaysDecline:[T.config.repeatDays.decline],fs_reinviteDelayAfterInviteAbandon:[T.config.reinviteDelayAfterInviteAbandon]}),e=k,E.ext(P,{CPPS:I,crit:e,stg:_,jrny:w,browser:C},!1),y.fire();var S=_.get("i");setTimeout(function(){I.set("code",E.globalConfig.codeVer),I.set("tz",-(new Date).getTimezoneOffset()),I.set("product_type","web sdk");var e,t,i=D.getScreenResolution();if(I.set("device_width",i.w),I.set("device_height",i.h),I.set("dpr",window.devicePixelRatio||1),C.isMobile?(I.set("window_width",i.w),I.set("window_height",i.h)):(t=D.getSize(window),I.set("window_width",t.w),I.set("window_height",t.h)),T.config.cpps){var r,s=T.config.cpps;for(r in s){var n,o=s[r];if(E.isObject(o))switch(o.source){case"param":var a,c,l,f=E.getParam(o.val)||o.init||null;E.isDefined(o.mode)&&"append"==o.mode?(a=o.delimiter||",",l=void 0,(c=(c=I.get(r))?c.split(a):[])[c.length-1]!==(f=f||"")&&(c.push(f),l=c.join(a),I.set(r,l))):E.isDefined(f)&&null!==f?I.set(r,f):I.get(r)||I.set(r,"");break;case"variable":E.isDefined(o.name)&&(n=o.exists,g=D.retrieveNestedVariable(R,o.name),E.isDefined(n)?I.get(r)!==n.success&&I.set(r,g?n.success:n.init):g?I.set(r,g):I.get(r)||I.set(r,o.init||""));break;case"cookie":var f=new D.Cookie({path:"/",secure:!1,encode:!0}).get(o.val),g=E.isDefined(f);n=o.exists,E.isDefined(n)?I.get(r)!==n.success&&I.set(r,g?n.success:n.init):E.isDefined(f)&&null!==f?I.set(r,f):I.get(r)||I.set(r,o.init||"");break;case"url":for(var u=0,d=o.patterns.length;u<d;u++){var h=o.patterns[u].regex||o.patterns[u].match,p=o.patterns[u].value;E.isString(location.href)&&D.testAgainstSearch(h,location.href)?I.set(r,p):I.get(r)||I.set(r,o.init||"")}break;default:throw new Error("Unknown CPP source: "+o.source)}else I.set(r,o)}}if(e=_.get("ovr")?JSON.parse(_.get("ovr")):e){for(var v=0;v<T.surveydefs.length;v++){var m=T.surveydefs[v].name;e.sp[m]&&(T.surveydefs[v].criteria.sp=e.sp[m]),e.lf[m]&&(T.surveydefs[v].criteria.lf=e.lf[m])}!0===e.pooloverride&&(k.pooloverride=!0)}if(P.state.codeVer=E.globalConfig.codeVer,P.state.siteKey=E.globalConfig.siteKey,P.state.didInvite=-1<"xda".indexOf(S),P.state.inviteSituation={x:"ACCEPTED",d:"DECLINED",a:"ABANDONED",p:"PRESENTED",f:"BRAINFAILED"}[S],"a"==S&&parseInt(_.get("rw"),10)<D.now()&&(_.erase("i"),_.erase("rw"),S=P.state.didInvite=null),"f"==S&&parseInt(_.get("fw"),10)<D.now()&&(_.erase("f"),_.erase("fw"),S=P.state.didInvite=null),"runRecordOnly"===T.config.workInIframes&&B){for(var b=!1,y=0;y<T.surveydefs.length;y++)if(T.surveydefs[y].cxRecord){b=!0;break}return N(C,b,_,!0,I),void(P._triggerResetLock=!1)}"d"!=S&&"a"!=S&&"f"!=S?k.calcReplayPoolStatus(function(i){i&&(P.state.isinpool=i),k.optoutCheck(function(){var t,e;k._match(T.config,C,"globalExclude")&&"y"!=_.get("gx")?null===_.selectCookieDomain(E.globalConfig.cookieDomain,window.location.toString())?P._triggerResetLock=!1:((t=P.trig=U(_,T,C,k,I,w)).logState(),I.set("pv",t.pageViewCount,T.config.pageViewsResetTimeout||864e5),t.init()?(P.initializedEmitter.fire(),(t.isTrackerAlive()||t.doesPassCriteria())&&t.surveydef?(t.logDefState(),N(C,t.surveydef.cxRecord,_,i,I),"x"!=S?(C.isMobile||C.isTablet||!t.surveydef.mouseoff||"off"===t.surveydef.mouseoff.mode||1!=_.get("pv")||_.set("sst",D.now()),t.canDisplayInvitation()?t.evalLoyaltySampling("criteria")?(_.set("def",t.surveydef.uid,t.cfg.config.surveyDefResetTimeout||864e5),A(t,C,_,I,!1,w,"Traditional",function(){this.initialize(),this.present()})):_.get("sst")&&t.evalLoyaltySampling("mouseoff")?(_.set("def",t.surveydef.uid,t.cfg.config.surveyDefResetTimeout||864e5),R._fsRequire([E.makeURI("$fs.mouseoff.js")],function(e){P._triggerResetLock=!1;e=t.mouseoff=new e(t,t.surveydef,C,_,w);e.initialize(),e.startListening(function(){this.inviteSetup=A(t,C,_,I,!1,w,"MouseOff",function(){this.initialize()})},function(){this.inviteSetup.present()})})):P._triggerResetLock=!1:P._triggerResetLock=!1):((e=t.stg.get("mhbi"))?M(t,e.ui,e.it):t.isTrackerAlive()&&(e=L.getFittingDisplay(t.surveydef),t.tracker=new x(e.template,t.surveydef,T,D.getBrainStorage(C,_.uid),I,e,C)),P._triggerResetLock=!1),t.surveydef.links&&new O(t.surveydef.links).performBindings(t)):P._triggerResetLock=!1):P._triggerResetLock=!1):(_.set("gx","y"),P._triggerResetLock=!1)},function(){P._triggerResetLock=!1})}):("a"==S&&(t="true"==_.get("rc")||!0===_.get("rc"),N(C,t,_,t,I)),P._triggerResetLock=!1)},Math.max(0,T.config.triggerDelay-(D.now()-E.startTS)))})},!0,!0)},!0,!0)}return e.startup=function(){var s,n=E.getProductConfig("trigger");if(!(n&&n.config&&n.surveydefs&&n.config.browser_cutoff))throw new Error("Looks like the trigger config is missing or broken. Please push a trigger config to fix this error.");if(n.surveydefs.length&&"string"==typeof n.surveydefs[0])throw new Error("Looks like an old trigger config from pre-19.9.0. Please re-push the trigger settings with 19.9.0+ to fix this error.");D.registerProduct("foresee",n),P.loadedEmitter.fire(),("dontRunOtherIframes"!==n.config.workInIframes&&n.config.workInIframes||!B)&&(R.__fsrtracker||-1<R.location.toString().indexOf("survey.foreseeresults.com")||(E.fsCmd("fstest")?R._fsRequire([E.makeURI("$fs.svadmin.js")],function(){}):E.fsCmd("fsoptout")?R._fsRequire([E.makeURI("$fs.optout.js")],function(){}):(E.domReady(k),b=k,n.config.ignoreNavigationEvents||D.pageNavEvent.subscribe(function(){var e=R.location,t=R[n.config.publicApiName||"FSR"],i=function(e){var t=e.split("#");return 2<t.length?t[0]+t[1]:e.replace(/#/gi,"")},r=i(_.hash),i=i(e.hash);D.now()-D.startTime<(n.config.pageLoadUrlChangeBlackout||0)||(t&&r!=i||_.pathname!=e.pathname)&&R.fsReady(function(){clearTimeout(s),s=setTimeout(function(){_={hash:R.location.hash,href:R.location.href,pathname:R.location.pathname},t.pageReset()},1e3)})},!1,!1))))},e});
