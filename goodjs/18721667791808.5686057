function speedtest(t){this._p={callback:"object"==typeof t&&"function"==typeof t.callback?t.callback:null,context:"object"==typeof t&&"object"==typeof t.context?t.context:{},timeout:"object"==typeof t&&"number"==typeof t.timeout&&1e3<=t.timeout&&t.timeout<=1e4?t.timeout:7500,ratio:"object"==typeof t&&"number"==typeof t.ratio&&.5<=t.ratio&&t.ratio<=10?t.ratio:1,socket:null,connected:!1,timer:-1,ping:{index:0,count:0,values:[]},rtt:0,download:{start:0,duration:0,values:[]},upload:{start:0,duration:0,values:[],payload:null}}}speedtest.prototype._callback=function(t){try{this._p.callback(t,this._p.context)}catch(t){}},speedtest.prototype._send=function(t){try{this._p.socket.send(t)}catch(t){}},speedtest.prototype._percentile=function(t,e){return 0<t.length?1==t.length?t[0]:(t.sort(function(t,e){return t-e}),e=(e=99<(e=e<0?0:e)?99:e)/100*t.length,Math.ceil(e)!=e?t[Math.ceil(e)-1]:(t[e-1]+t[e])/2):0},speedtest.prototype.callback=function(t){return this._p.callback="function"==typeof t?t:null,this},speedtest.prototype.context=function(t){return this._p.context="object"==typeof t?t:{},this},speedtest.prototype.connect=function(t){if(null==this._p.socket)try{var e=this;this._p.socket=new WebSocket(t,"speedtest"),this._p.timer=setTimeout(function(t){if(!e._p.connected)try{e._p.socket.close()}catch(t){}},this._p.timeout),(this._p.socket._st=this)._p.socket.binaryType="arraybuffer",this._p.socket.onopen=function(t){clearTimeout(this._st._p.timer),this._st._p.connected||(this._st._p.connected=!0,this._st._callback({type:"connect"}))},this._p.socket.onclose=function(t){clearTimeout(this._st._p.timer),this._st._p.connected?(this._st._p.connected=!1,this._st._p.socket=null,this._st._callback({type:"close",value:t.code})):(this._st._p.socket=null,this._st._callback({type:"error",value:"connection error ("+t.code+")"}))},this._p.socket.onmessage=function(t){if("string"==typeof t.data)try{switch((n=JSON.parse(t.data)).method){case"config":this._st._callback({type:"config",value:n.params});break;case"ping":n.params.index==this._st._p.ping.index+1?(this._st._p.ping.values.push(Math.max(1,Math.floor(((new Date).getTime()-n.params.ctime)*this._st._p.ratio))),n.params.index<2*this._st._p.ping.count&&(this._st._p.ping.index+=2,this._st.ping(0,n.params.stime)),this._st._callback({type:"ping",value:this._st._percentile(this._st._p.ping.values,50),last:n.params.index>=2*this._st._p.ping.count-2}),n.params.index>=2*this._st._p.ping.count-2&&(this._st._p.rtt=this._st._percentile(this._st._p.ping.values,50),this._st._p.ping.index=0)):this._st._p.ping.index=0;break;case"upload":if(0!=this._st._p.upload.start){var e=n.params.size,s=Math.max(1,Date.now()-n.params.ctime-this._st._p.rtt),o=8*e/(1e3*s);this._st._p.upload.values.push(o),e<64<<20&&s<330&&(e*=2),Date.now()-this._st._p.upload.start>=this._st._p.upload.duration&&(this._st._p.upload.start=0),n=JSON.stringify({ctime:Date.now(),bandwidth:o,last:0==this._st._p.upload.start});for(var a=0;a<n.length;a++)this._st._p.upload.payload[a]=n.charCodeAt(a);this._st._send(this._st._p.upload.payload.slice(0,e)),this._st._callback({type:"upload",value:this._st._percentile(this._st._p.upload.values,50),max:this._st._percentile(this._st._p.upload.values,80),last:0==this._st._p.upload.start})}}}catch(t){}else if(0!=this._st._p.download.start&&128<=t.data.byteLength){var i=new Uint8Array(t.data.slice(0,128)),n="";if(123==i[0]){for(a=0;a<i.byteLength&&(n+=String.fromCharCode(i[a]),125!=i[a]);a++);n=JSON.parse(n),Date.now()-this._st._p.download.start>=this._st._p.download.duration&&(this._st._p.download.start=0),this._st._send(JSON.stringify({method:"download",params:{size:t.data.byteLength,stime:n.stime,last:0==this._st._p.download.start}})),this._st._p.download.values.push(n.bandwidth),this._st._callback({type:"download",value:this._st._percentile(this._st._p.download.values,50),max:this._st._percentile(this._st._p.download.values,85),last:0==this._st._p.download.start})}}}}catch(t){this._p.connected=!1,this._p.socket=null,this._callback({type:"error",action:"connect",status:1006})}else this._callback({type:"connect"});return this},speedtest.prototype.close=function(){if(this._p.connected)try{this._p.socket.close()}catch(t){}return this},speedtest.prototype.config=function(){return this._send(JSON.stringify({method:"config"})),this},speedtest.prototype.ping=function(t,e){return 0==this._p.ping.index&&(this._p.ping.values=[],this._p.ping.count=t),this._send(JSON.stringify({method:"ping",params:{index:this._p.ping.index,count:this._p.ping.count,ctime:(new Date).getTime(),stime:e}})),this},speedtest.prototype.download=function(t){return 0==this._p.download.start&&(this._p.download.start=Date.now(),this._p.download.duration=1e3*t,this._p.download.values=[],this._send(JSON.stringify({method:"download"}))),this},speedtest.prototype.upload=function(t){if(0==this._p.upload.start){this._p.upload.start=Date.now(),this._p.upload.duration=1e3*t,this._p.upload.values=[],this._p.upload.payload=new Uint8Array(64<<20);for(var e=JSON.stringify({ctime:Date.now()}),s=0;s<e.length;s++)this._p.upload.payload[s]=e.charCodeAt(s);this._send(this._p.upload.payload.slice(0,262144))}return this},Uint8Array.prototype.slice||Object.defineProperty(Uint8Array.prototype,"slice",{value:function(t,e){return new Uint8Array(Array.prototype.slice.call(this,t,e))}});try{function check(t,e){switch(t.type){case"connect":endpoints[e.name].ping(12,0);break;case"ping":t.last&&endpoints[e.name].close()}}var endpoints={},bootstrap=new speedtest({callback:function(t){switch(t.type){case"connect":bootstrap.config();break;case"config":for(var e=0;e<t.value.endpoints.length;e++){var s=t.value.endpoints[e];s.name==t.value.self?(bootstrap.context({name:s.name}).callback(check),endpoints[s.name]=bootstrap):endpoints[s.name]=new speedtest({context:{name:s.name},callback:check}),endpoints[s.name].connect("wss://"+s.remote+"/speedtest")}}}});setTimeout(function(){try{if("object"==typeof localStorage){var t=localStorage.getItem("stlast"),e=Date.now();if(null!=t&&e-t<15e4)return;localStorage.setItem("stlast",e)}bootstrap.connect("wss://speedtest.dailymotion.com/speedtest")}catch(t){}},5e3+Math.floor(5e3*Math.random()))}catch(t){}
