window.EV=window.EV||{},function(c){"use strict";function l(e){for(var t=(t=document.cookie).split("; "),n={},o=0;o<t.length;o++){var i=t[o].split("=");n[i[0]]=i[1]}return n[e]||""}function u(e,t,n){if(!h.sidCookieDomain)throw new Error("Please specify sidCookieDomain in the config!",!0);var o=new Date;n=1460,o.setDate(o.getDate()+n),document.cookie=e+"="+escape(t)+";expires="+o.toUTCString()+";path=/; domain="+h.sidCookieDomain,console.log(e+"="+escape(t)+";expires="+o.toUTCString()+";path=/; domain="+h.sidCookieDomain)}function v(e){return""!==l(e)&&"undefined"!==l(e)&&l(e)}function m(e){return""!==f(e,"localStorage")&&"undefined"!==f(e,"localStorage")&&f(e,"localStorage")}function f(e,t){var n=document.cookie.indexOf(e+"=");if("localStorage"==t){if("undefined"==typeof localStorage)return 0<document.cookie.length&&-1!==n?getCookieSubstring(n,e):"";try{return localStorage.getItem(e)}catch(e){return console.warn("Could not retrieve the cookie in local storage - maybe the browser's running on an environment with restricted access to localStorage?"),"undefined"}}if("sessionStorage"==t){if("undefined"==typeof sessionStorage)return n=document.cookie.indexOf(e+"="),0<document.cookie.length&&-1!==n?getCookieSubstring(n,e):"";console.log(sessionStorage.getItem(e));try{return sessionStorage.getItem(e)}catch(e){return console.warn("Could not retrieve the cookie in session storage - maybe the browser's running on an environment with restricted access to sessionStorage?"),"undefined"}}}function g(e,t,n,o){var i=new Date;if("localStorage"==o)if(i.setDate(i.getDate()+n),"undefined"!=typeof localStorage)try{localStorage.setItem(e,t)}catch(e){console.warn("Could not store the cookie in local storage - maybe the browser's running on an environment with restricted access to localStorage?")}else document.cookie=e+"="+escape(t)+(null===n?"":";expires="+i.toUTCString());if("sessionStorage"==o)if(i.setDate(i.getDate()+n),"undefined"!=typeof sessionStorage)try{sessionStorage.setItem(e,t)}catch(e){console.warn("Could not store the cookie in session storage - maybe the browser's running on an environment with restricted access to sessionStorage?")}else document.cookie=e+"="+escape(t)+(null===n?"":";expires="+i.toUTCString())}function p(e){var t,n="";for(t in e=JSON.parse(e))""!==n&&(n+="&"),n+=t+"="+encodeURIComponent(e[t]);return n}function w(e,t){!function(){if(!h)throw"Evolok Metering library is not initialised!"}();var n=h.url;if(!n)throw new Error("Evolok Metering host url is not configured!");return"/"===n.charAt(n.length-1)&&"/"===e.charAt(0)?n+=e.substring(1,e.length):n+=e,t?n+"?"+t:n}function t(){var n=this;this.promise=new Promise(function(e,t){n.reject=t,n.resolve=e})}var h,_,E,S=new t,s=new t,y=!1,o=0,i=0,C={};window.addEventListener("ev.widgets.dwelltime.enabled",function(e){e.detail.dwellTimeTrackingEnabled&&(y=!0,i=e.detail.maxDwellTimeRequests||3,setTimeout(function(){c.Em.initDwellTimeRequests(C.authorizeData)},1e3))}),c.Em={init:function(e){if(!e.url)throw"Configuration must specify the url property!";e.hasOwnProperty("brand")&&(this.brand=e.brand),h=e},getAuthResponse:function(){return S.promise},getSegmentResponse:function(){return s.promise},authorize:function(e,t,n){c.Em.assert(e,"Parameters should not be empty!"),c.Em.assert(t,"Success callback should not be empty!"),c.Em.assert(n,"Error callback should not be empty!");var o=p(e),i="",s="",r="";-1===o.indexOf("referrer")&&document.referrer&&(o+="&referrer="+encodeURIComponent(document.referrer)),-1===o.indexOf("title")&&document.title&&(o+="&title="+encodeURIComponent(document.title)),-1===o.indexOf("article_url")&&window.location.href&&(o+="&article_url="+encodeURIComponent(window.location.href)),h.brand?o+="&brand="+encodeURIComponent(h.brand):e.site&&(o+="&brand="+encodeURIComponent(e.site)),v("ev_sid")?(s="&ev_sid="+l("ev_sid"),g("ev_sid",l("ev_sid"),0,"localStorage")):m("ev_sid")&&(h.meterHD?!0===h.meterHD&&(u("ev_sid",f("ev_sid","localStorage")),s="&ev_sid="+f("ev_sid","localStorage"),h.meterHD):u("ev_sid",f("ev_sid","localStorage"))),v("ev_did")?(r="&ev_did="+l("ev_did"),g("ev_did",l("ev_did"),0,"localStorage")):m("ev_did")&&(h.meterHD?!0===h.meterHD&&(u("ev_did",f("ev_did","localStorage")),r="&ev_did="+f("ev_did","localStorage")):u("ev_did",f("ev_did","localStorage"))),""!==l("ev_ss")&&(i+="&ev_ss="+l("ev_ss"));var a,o=w("/authorize/json",o=o+(i=i==="&ev_ss="+l("ev_ss")?"&ev_ss="+l("ev_ss"):"&ev_ss=")+(s=s==="&ev_sid="+l("ev_sid")?"&ev_sid="+l("ev_sid"):"&ev_sid=")+(r=r==="&ev_did="+l("ev_did")?"&ev_did="+l("ev_did"):"&ev_did=")),d=new XMLHttpRequest;d.open("GET",o,!0),d.withCredentials=!0,d.onload=function(){var e;200<=d.status&&d.status<400?(e=JSON.parse(d.responseText),S.resolve(e),(C.authorizeData=e).sessionKeys?(e.sessionKeys.ev_sid&&(_=e.sessionKeys.ev_sid),e.sessionKeys.ev_did&&(E=e.sessionKeys.ev_did,e.deviceId=e.sessionKeys.ev_did)):e.deviceId=l("ev_did"),c.Em.paywallAndNotifierEvents(e),"REQUIRE_LOGIN"===e.result&&(""!==l("ev_ss")&&c.Event.publish("session.cleanup","Session has expired"),c.Event.publish("login.required","Login is required")),"ALLOW_ACCESS"!=e.result&&c.Em.hideMeteredContent(),t(e)):n&&n(d.status,d.responseText)},d.onerror=function(e){e?n(e):n(0,"unknown connection error")},d.send(),y||("function"==typeof CustomEvent?a=new CustomEvent("ev.ad.dwelltime.check"):(a=document.createEvent("CustomEvent")).initCustomEvent("ev.ad.dwelltime.check",!1,!1,{}),window.dispatchEvent(a))},initDwellTimeRequests:function(t){var n=window.setInterval(function(){var e;document.hidden||(e=30*o+30,t.dwellTimeInterval=e,c.Em.paywallAndNotifierEvents(t),o++),o==i&&clearInterval(n)},3e4)},paywallAndNotifierEvents:function(e){function t(e){var t;"function"==typeof CustomEvent?t=new CustomEvent("ev.ad.authorize",{detail:e}):(t=document.createEvent("CustomEvent")).initCustomEvent("ev.ad.authorize",!1,!1,e),window.dispatchEvent(t)}t(e),window.addEventListener("ev.widgets.paywall.load",function(){t(e)}),window.addEventListener("ev.widgets.notifier.load",function(){t(e)})},pretty_print:function(e){e=JSON.stringify(e,null,3).replace(/&/g,"&amp;").replace(/\\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/^( *)("[\w]+": )?("[^"]*"|[\w.+-]*)?([,[{])?$/gm,c.Em.replacer);return"<pre>"+e+"</pre>"},replacer:function(e,t,n,o,i){t=t||"";return n&&(t=t+"<span class=json-key>"+n.replace(/[": ]/g,"")+"</span>: "),(t=o?t+('"'==o[0]?"<span class=json-string>":"<span class=json-value>")+o+"</span>":t)+(i||"")},segment:function(t,n,o){c.Em.assert(t,"Parameters should not be empty!"),c.Em.assert(n,"Success callback should not be empty!"),c.Em.assert(o,"Error callback should not be empty!");var t=w("/segment",p(t)),i=new XMLHttpRequest;i.open("GET",t,!0),i.withCredentials=!0,i.onload=function(){var e;200<=i.status&&i.status<400?(e=JSON.parse(i.responseText),s.resolve(e),n(e)):o&&o(i.status,i.responseText)},i.onerror=function(){e?o(e):o(0,"unknown connection error")},i.send()},assert:function(e,t){if(!e){if(t=t||"Assertion failed","undefined"!=typeof Error)throw new Error(t);throw t}},getUrl:function(){return h.url},showMeteredContent:function(){var e=document.getElementsByClassName("ev-meter-content");[].forEach.call(e,function(e){e.style.display="block"})},hideMeteredContent:function(){var e=document.getElementsByClassName("ev-meter-content");[].forEach.call(e,function(e){e.style.display="none"})}},setTimeout(function(){_&&l("ev_sid")!=_&&(u("ev_sid",_),g("ev_sid",_,0,"localStorage"),0),E&&l("ev_did")!=E&&(u("ev_did",E),g("ev_did",E,0,"localStorage"),0)},4e3)}(window.EV);
