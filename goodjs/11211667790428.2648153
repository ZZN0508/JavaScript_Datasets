define(["require","exports","tslib","react","modules/core/i18n","modules/core/browser","modules/core/exception","modules/clean/deprecated_ajax/ajax_jquery","modules/clean/auth/common/types","modules/clean/auth/common/utils","modules/clean/auth/register/types","modules/clean/auth/register/view","modules/clean/marketing_tracker","modules/clean/profile_services/auth_callback_handler","modules/clean/profile_services/profile_services_constants","modules/clean/profile_services/profile_services_link","modules/clean/react/components/css","modules/clean/web_timing_logger","modules/clean/web_register_logging_data","modules/clean/auth/common/stats","api_v2/noauth_client","modules/core/notify"],function(e,t,m,c,r,g,o,l,d,u,p,h,i,_,f,S,s,n,E,v,a,R){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestOnlyRegisterFormComponent=t.RegisterForm=t.handleInviteResendImpl=void 0,c=m.__importDefault(c),g=m.__importStar(g),o=m.__importStar(o),l=m.__importStar(l),f=m.__importDefault(f);var C,y=(C=c.default.Component,m.__extends(w,C),w.prototype.handleServerErrors=function(e){var t,i,s=this;this.mounted&&(v.AuthAMPLogger.logSignupResponse(v.AuthType.CREDENTIALS,!1,e.funcaptcha_response?"funcaptcha_response":"form_error"),this.viewComponent.handleCaptchaErrors(e)?setTimeout(function(){s.isCaptchaReady||u.notifyCaptchaNotLoaded()},1e4):(v.EmailAuthUXAnalyticsLogger.logSignupError(),t=m.__assign({},this.state.localErrors),i=Date.now(),e.email&&(t.email=e.email,t.email.clientTimestamp=i),e.password&&(t.password=e.password,t.password.clientTimestamp=i),e.fname&&(t.fname=e.fname,t.fname.clientTimestamp=i),e.tos_agree&&(t.tos=e.tos_agree,t.tos.clientTimestamp=i),this.setState({localErrors:t}),this.setState({isSubmitting:!1})))},w.prototype.handleSuccess=function(e){var t,i;this.mounted&&(i={id:(t=JSON.parse(e)).id,email:t.email,display_name:t.display_name},v.AuthAMPLogger.logSignupResponse(v.AuthType.CREDENTIALS,!0,null),v.EmailAuthUXAnalyticsLogger.logSignupResponse(),this.handleRegisterFormEvent(p.RegisterFormEvent.REGISTER_IMMEDIATE_SUCCESS,{userInfo:i}),!1!==this.props.canRedirect?(e=t.force_redirect_url?t.redirect_url:this.props.continuationUrlForNonGoogleSignup||t.redirect_url||"/",g.redirect(e)):this.props.onRegisterSuccess&&this.props.onRegisterSuccess(i,t),this.setState({isSubmitting:!1}))},w.prototype.trackSuccessfulRegister=function(e,t){e!==p.RegisterFormEvent.GOOGLE_REGISTER_SUCCESS&&e!==p.RegisterFormEvent.REGISTER_IMMEDIATE_SUCCESS||(e=i.getGAViewData(i.MARKETING_REGISTER_EVENT,"ga_register_pageview","/virtual/ga_register_pageview"),i.MarketingTracker.tryPushEvent(i.MARKETING_REGISTER_EVENT,i.EventTypeEnum.View,e))},w.prototype.handleRegisterFormEvent=function(e,t){this.trackSuccessfulRegister(e,t),this.props.onRegisterFormEvent&&this.props.onRegisterFormEvent(e,t)},w.prototype.registerData=function(){var e=u.getFormattedName(this.state.fname,this.state.lname,this.props.combinedName),t=e[0],i=e[1],s=g.get_uri().getQuery(),n=this.state,r=n.email,o=n.password,a=n.tosAgree,l=n.marketingOptIn,p=n.inlineThirdPartySignupState,e=this.props,n=e.additionalParams,e=e.thirdPartyInitiatedSignupData,o=m.__assign({fname:t,lname:i,email:r,tos_agree:a},this.thirdPartySignupInitiated?{}:{password:o}),n=m.__assign(m.__assign(m.__assign(m.__assign(m.__assign({cont:this.props.continuationUrlForNonGoogleSignup,signup_endpoint:this.props.signupEndpoint,demandbase_override:s.demandbase_override,marketing_opt_in:l},o),e||{}),p||{}),this.viewComponent&&this.viewComponent.getCaptchaResponses()||{}),n);return E.setWebRegisterLoggingData(n)},w.prototype.clearFormErrors=function(e){var t=this.state.localErrors;e.fname&&(t.fname={}),e.email&&(t.email={}),e.password&&(t.password={}),e.tosAgree&&(t.tos={}),this.setState({localErrors:t})},w.prototype.getFormErrors=function(){var e={};if(!this.props.validateClientSide)return e;var t=Date.now();return this.state.fname?e.fname=void 0:e.fname={message_text:r.intl.formatMessage({id:"GlyhO1",defaultMessage:"Please enter your name"}),clientTimestamp:t},this.state.email?e.email=void 0:e.email={message_text:r.intl.formatMessage({id:"I7g4FQ",defaultMessage:"Please enter an email address"}),clientTimestamp:t},this.state.password||this.thirdPartySignupInitiated?e.password=void 0:e.password={message_text:r.intl.formatMessage({id:"LhlWCW",defaultMessage:"Please enter a password"}),clientTimestamp:t},this.state.tosAgree?e.tos=void 0:e.tos={message_text:r.intl.formatMessage({id:"yw3Lbd",defaultMessage:"Please agree to the terms of service"}),clientTimestamp:t},e},Object.defineProperty(w.prototype,"thirdPartySignupInitiated",{get:function(){return!!this.props.thirdPartyInitiatedSignupData||!!this.state.inlineThirdPartySignupState},enumerable:!1,configurable:!0}),w.prototype.componentDidMount=function(){this.setState({shouldDisableForm:!1}),this.props.markTti&&n.mark_time_to_interactive(),this.mounted=!0,v.AuthAMPLogger.logSignupIntent(),document.addEventListener("click",this.handleResendClick)},w.prototype.componentWillUnmount=function(){this.mounted=!1,document.removeEventListener("click",this.handleResendClick)},Object.defineProperty(w.prototype,"shouldDisableForm",{get:function(){return!!this.props.disabled||this.state.shouldDisableForm},enumerable:!1,configurable:!0}),w.prototype.render=function(){var e=this.props,t=e.marketingOptInProps,i=e.variant,s=e.emailProps,n=e.maestroStyle,r=e.className,o=e.combinedName,a=e.fnameProps,l=e.lnameProps,p=e.passwordProps,m=e.tosCheckboxProps,g=e.submitButtonProps,u=e.googleRegisterProps,e=e.showSplitSignupFlow;return c.default.createElement(h.RegisterFormView,{ref:this.setViewComponent,variant:i||d.AuthFormVariant.STANDARD,maestroStyle:!!n,disabled:this.shouldDisableForm,className:r,combinedName:!!o,fnameProps:a||{},fnameValue:this.state.fname,fnameError:this.state.localErrors.fname,lnameProps:l||{},lnameValue:this.state.lname,emailProps:s||{},emailValue:this.state.email,emailError:this.state.localErrors.email,passwordProps:p||{},passwordValue:this.state.password,passwordError:this.state.localErrors.password,tosCheckboxProps:m||{},tosChecked:this.state.tosAgree,tosError:this.state.localErrors.tos,submitButtonProps:g||{},googleRegisterProps:u,thirdPartyInitiatedSignup:this.thirdPartySignupInitiated,isSubmitting:this.state.isSubmitting,onClickSignUp:this.onClickSignUp,onInputChange:this.onInputChange,onSubmit:this.onSubmit,onCaptchaReady:this.onCaptchaReady,onGoogleRegisterClick:this.onGoogleRegisterClick,showMarketingOptIn:!!(void 0===t?{}:t).show,marketingOptInChecked:this.state.marketingOptIn,splitSignupEnabled:e})},w);function w(e){var a=C.call(this,e)||this;a.testOnlyGetViewComponent=function(){return a.viewComponent},a.setViewComponent=function(e){a.viewComponent=e},a.onClickSignUp=function(e){e.preventDefault(),a.handleRegisterFormEvent(p.RegisterFormEvent.REGISTER_CLICK),v.AuthAMPLogger.logSignupAttempt(v.AuthType.CREDENTIALS),v.EmailAuthUXAnalyticsLogger.logSignupStart();e=a.getFormErrors();e.fname||e.email||e.password||e.tos?a.setState({localErrors:e}):a.viewComponent.getCaptchaComponent().getWrappedComponent().submit()},a.onSubmit=function(){a.setState({isSubmitting:!0});var e=a.registerData(),t=a.props.signupUrl||(a.thirdPartySignupInitiated?"/ajax_thirdparty_register":"/ajax_register");l.WebRequest({url:t,type:"POST",data:e,success:function(e,t,i){a.handleSuccess(e)},error:function(e,t,i){a.handleServerErrors(JSON.parse(i))}})},a.handleGoogleCallback=function(e){v.AuthAMPLogger.logSignupResponse(v.AuthType.GOOGLE,e.success,e.err_msg),v.GoogleUXAnalyticsLogger.logSignupResponse(e);var t=a.props,i=t.additionalParams,s=void 0===i?{}:i,n=t.marketingOptInProps,r=void 0===n?{}:n,i=t.canRedirect,n=a.props.googleRegisterProps||{},t=n.signupContinuationUrl||"/",o=n.optimisticLoginContinuationUrl||t,n=E.getWebRegisterLoggingData();_.handleRegisterResponse(e,m.__assign({showMarketingOptIn:!!r.show,registerCont:t,loginCont:o,signupTag:s.signup_tag||"",canRedirect:!1!==i,k:s.k,eh:s.eh,signupEndpoint:a.props.signupEndpoint,inlineRedirect:i?void 0:function(e){var t=e.fname,i=e.lname,s=e.email,e=m.__rest(e,["fname","lname","email"]);a.setState({fname:t,lname:i,email:s,inlineThirdPartySignupState:e})}},n),void 0,function(){a.handleRegisterFormEvent(p.RegisterFormEvent.GOOGLE_REGISTER_SUCCESS)},function(e){if(a.handleRegisterFormEvent(p.RegisterFormEvent.REGISTER_IMMEDIATE_SUCCESS,{userInfo:e}),!1!==a.props.canRedirect)g.redirect(o);else if(a.props.onRegisterSuccess)return a.props.onRegisterSuccess(e,e)})},a.onGoogleRegisterClick=function(){a.handleRegisterFormEvent(p.RegisterFormEvent.REGISTER_CLICK),v.AuthAMPLogger.logSignupAttempt(v.AuthType.GOOGLE),v.GoogleUXAnalyticsLogger.logSignupStart();var e=new S.ProfileServicesLinkingHandler,t=a.props.googleRegisterProps||{},i=void 0===t.popup||t.popup?S.AuthWindowOption.POP_UP:S.AuthWindowOption.REDIRECT,t=t.signupContinuationUrl?{kind:"web",cont:t.signupContinuationUrl,remember_me:!1,pair_user:!1}:null;e.auth_service_create_user_if_needed(f.default.GOOGLE,a.handleGoogleCallback,"register_form",i,t)},a.onInputChange=function(e){var t={},i=e.currentTarget,s=i.name,e=i.value,i=i.checked;"fname"===s?t.fname=e:"lname"===s?t.lname=e:"email"===s?t.email=e:"password"===s?t.password=e:"tos_agree"===s?t.tosAgree=i:"marketing_opt_in"===s&&(t.marketingOptIn=i),a.setState(t),a.clearFormErrors(t)},a.handleResendClick=function(e){var t=e.target,i=a.state,s=i.email,i=i.isSendingInvite;"login-register-resend-invite"===t.className&&I(e,i,s,function(){return a.setState({isSendingInvite:!0})},function(){return a.setState({isSendingInvite:!1})})},a.onCaptchaReady=function(){a.isCaptchaReady=!0},o.assert(!1!==e.canRedirect||!!e.onRegisterSuccess,"Need an on register success handler if we cannot redirect the user",{tags:["react-register-form"]});var t=e.fnameProps,i=e.lnameProps,s=e.emailProps,n=e.tosCheckboxProps,e=e.marketingOptInProps,e=void 0===e?{}:e,e=!e.show||!!e.checked;return a.state={localErrors:{},isSubmitting:!1,fname:(void 0===t?{}:t).initialValue||"",lname:(void 0===i?{}:i).initialValue||"",email:(void 0===s?{}:s).initialValue||"",password:"",tosAgree:!!(void 0===n?{}:n).checked,isSendingInvite:!1,marketingOptIn:e,shouldDisableForm:!0},a.mounted=!1,a.isCaptchaReady=!1,a}function I(e,t,i,s,n){!0!==t&&(t=new a.NoAuthApiV2Client,s(),t.ns("team").rpc("logged_out_resend_pending_invite_email",{email:i},{}).then(function(){R.Notify.success(r.intl.formatMessage({id:"un5VKD",defaultMessage:"Invite resent to {email}"},{email:i})),n()}).catch(function(e){R.Notify.error(r.intl.formatMessage({id:"yqLGvW",defaultMessage:"Failed to resend invite."})),n()})),e.preventDefault()}t.TestOnlyRegisterFormComponent=y,t.handleInviteResendImpl=I,t.RegisterForm=s.requireCssWithComponent(y,["/static/css/login_or_register-vfln_xSQk.css","/static/css/components/login_form-vflqjm7yP.css","/static/css/components/button-vfllw60O5.css"])});
