define(["jquery","OK/logger","OK/utils/utils","OK/OKVideo","OK/tmr","jquery.okTags"],function(p,f,g,n,e){"use strict";function d(e){var a=e.data("fetchtype"),e=e.data("enabled-sortable");return("ALBUM"===a||"album"===a)&&e}var r="video.related",m="groups.video-dnd",s={revert:"invalid",scroll:!0,scrollSpeed:50,cursor:"move",cursorAt:{top:48,left:82},opacity:.8,zIndex:20,helper:function(e,a){var t=(a=a||p(e.currentTarget)).find(".video-card_img"),e=a.find(".video-card_img-w"),a=p("<div/>",{class:"draggable-item __video",width:Math.floor(e.width()/2)+"px",height:Math.floor(e.height()/2)+"px",data:{id:a.find(".video-card").data("id")}});return t.attr("src")&&p("<img/>",{class:"draggable-item_img",src:t.attr("src")}).appendTo(a),a},start:function(){f.success(m,"gv-drag")}};function b(e,a){var t=p(this),i=t.children(".tip");i.length||(i=p("<div/>",{class:"tip __mid"}),a&&i.addClass(a),i.appendTo(t),p("<div/>",{class:"tip_cnt",text:e}).appendTo(i));e=i.data("timeout");e?(clearTimeout(e),i.removeData("timeout")):setTimeout(p.fn.addClass.bind(i,"__active"),10),i.data("timeout",setTimeout(function(){i.removeClass("__active").removeData("timeout"),setTimeout(p.fn.remove.bind(i),150)},2e3))}function h(e){var d=e.data("albumid");require(["jquery.ui.sortable"],function(){e.sortable(p.extend(s,{items:".js-sortable",revert:!1,placeholder:"ugrid_i sortable-placeholder __video",update:function(e,a){if(a.item.dropped)return!1;var t=a.item.find(".video-card").data("id"),i=a.item.prev().find(".video-card").data("id"),a=a.item.next().find(".video-card").data("id");p.ajax({url:"/dk?cmd=videoCommand&a=changeAlbumMoviePosition",headers:{TKN:OK.tkn.get()},type:"POST",dataType:"json",data:{"st.vv_albumId":d,"st.vv_movieId":t,"st.vv_prevMovieId":i,"st.vv_nextMovieId":a}}).always(function(e){e.result?f.success(m,"gv-sort-success"):f.error(m,"gv-sort-error")})},start:function(){f.success(m,"gv-sort-start")}})).disableSelection()})}function a(e){e.sortable("disable")}return{extractScrollDelta:function(e,a,t){var i,e=e.originalEvent;return e.detail&&(i=e.detail),e.wheelDelta&&(i=-1*e.wheelDelta),e.wheelDeltaY&&(i=-1*e.wheelDeltaY),(i=e.deltaY?e.deltaY:i)?(!0===t&&(e.deltaMode&&1===e.deltaMode?i*=parseInt(p(a).css("fontSize"),10):e.deltaMode&&2===e.deltaMode&&(i*=p(a).height())),i):0},removeWrapperComponent:function(e){p(e).closest(".ugrid_i").remove()},activateSubscribeButton:function(e){var e=p(e),s=e.find(".js-action-subscribe"),n=e.find(".js-action-unsubscribe"),a=s.data("subscribe"),t=n.data("unsubscribe");e.find(".js-subscribe").on("click",function(){var e=!s.length||s.hasClass("invisible");return g.ajax({url:e?t:a}).done(function(e,a,t){var i=e.split(OK.navigation.SPLITER),d=i[0];"unSubscribed"===d?(s.removeClass("invisible"),n.addClass("invisible")):"subscribed"===d&&(s.addClass("invisible"),n.removeClass("invisible")),1<i.length&&g.updateBlockModelCallback(e,a,t)}),!1})},deactivateSubscribeButton:function(e){p(e).find(".js-subscribe").off()},activateDnd:function(e){var a,t,o,l,c,u,v,i=p(e),e=i.hasClass("js-dnd-child-cnt"),i=e?i.closest(".js-dnd-cnt"):i;d(i)?e?i.sortable("refresh"):h(i):(a=i,require(["jquery.ui.draggable"],function(){a.find(".js-draggable:not(.ui-draggable)").draggable(s)}),a.off("dragstart"),a.on("dragstart",".video-card_cnt:not(.ui-draggable)",function(e){e.preventDefault()})),o=(t=i).data("ownertype"),l=t.data("refid"),c=t.data("albumid"),u=t.data("fetchtype"),v=p(".video-page"),require(["jquery.ui.droppable"],function(){t.find(".js-droppable:not(.ui-droppable)").droppable({tolerance:"pointer",hoverClass:"__hover",drop:function(e,a){a.draggable.dropped=!0;var t=p(this),i=a.draggable.find(".video-card"),d=t.data("id"),a=i.data("id"),i=i.data("bid")||a,s=t.hasClass("nav-side_i"),n=v.data("video-moved-msg"),r=v.data("video-moved-error-msg"),t=v.data("video-move-url")||"/dk?cmd=AltGroupAlbumCardBlock&st.cmd=altGroupVideoAll",i={"st.mc.albumId":d,"st.mc.id":a,"st.mc.bid":i,"st.mc.action":"DRAG_N_DROP"};"GROUP"==o&&(i["st.groupId"]=l,i["st.fetchType"]=u,c.length&&(i["st.albumId"]=c)),g.ajax({url:t,data:i}).done(function(e,a,t){g.updateBlockModelCallback(e,a,t),200===t.status?(b.call(v,n,"__fixed"),f.success(m,s?"gv-drop-left-menu":"gv-drop-album")):(b.call(v,r,"__fixed"),f.error(m,"gv-error-drop"))}.bind(this))}})})},deactivateDnd:function(e){e=p(e);e.hasClass("js-dnd-child-cnt")||(e.find(".js-droppable.ui-droppable").droppable("disable"),e.off("dragstart"),d(e)?a(e):e.find(".js-draggable.ui-draggable").draggable("disable"))},activateSortable:h,deactivateSortable:a,showTip:b,activateRelatedVideo:function(e){function a(e){var a=n.getPlayerId();if(e.detail&&d===a&&-1!==i.indexOf(e.detail.name)&&!s){if("pause"===e.detail.name&&"auto"===e.detail.data.statType&&n.isSilent())return!1;g.ajax({url:"/dk?cmd=RelatedFeedMovies",data:{"st.rm.movieId":e.detail.data.movieId,"st.rm.blockId":t}}).done(function(e,a,t){g.updateBlockModelCallback(e,a,t),s=!0,f.success(r,"success")}).fail(function(){f.error(r,"fail")})}}var e=p(e),t=e.data("blockid"),i=e.data("checkpoints"),d=e.closest(".feed_cnt").find(".vid-card_cnt").data("player-element-id"),s=!1;document.addEventListener("__videoPlayerEvent",a),e.data("deactivateMethod",function(){document.removeEventListener("__videoPlayerEvent",a)})},deactivateRelatedVideo:function(e){var a=p(e),e=a.data("deactivateMethod");e&&e(),a.remove()},activateHideLinkedElementOnChange:function(e){var a=p(e),e=a.data("linked-id"),t=p("#"+e);a.on("change",function(){t.toggleClass("invisible",p(this).attr("checked"))})},deactivateHideLinkedElementOnChange:function(e){p(e).off()},activateOkTags:function(e){var a=Object.assign({inputCssSelector:"",wrapperCssSelector:"",tagCssClassName:"movie-tag-field",newTagInputCssClass:"tag_it",listClass:"tags it vl_it vl_tags",textRemoveTagTitle:"РЈРґР°Р»РёС‚СЊ РєР»СЋС‡РµРІРѕРµ СЃР»РѕРІРѕ"},e||{});if(a.inputCssSelector&&a.wrapperCssSelector){var t=document.querySelector(a.inputCssSelector);if(t){e=p(a.wrapperCssSelector);if(e.length){var i=t.name,d=[];""!==t.value&&(d=t.value.split(",").map(function(e){return e.trim()})),e.on("addedNewTag","."+a.newTagInputCssClass,function(e,a){d.push(a),t.value=d.join(",")}),e.on("removedTag","."+a.newTagInputCssClass,function(e,a){a=d.indexOf(a);0<=a&&d.splice(a,1),t.value=d.join(",")});for(var s=document.createDocumentFragment(),n=d.length||1;n--;){var r=document.createElement("input");r.name=i+"[]",r.className=a.tagCssClassName,r.value=d[n]||"",s.appendChild(r)}t.parentNode.insertBefore(s,t.nextSibling),p("."+a.tagCssClassName).okTags({listClass:a.listClass,inputClass:a.newTagInputCssClass,textRemoveLinkTitle:a.textRemoveTagTitle})}}}},deactivateOkTags:function(e){e&&e.wrapperCssSelector&&((e=p(e.wrapperCssSelector)).length&&e.off())},trackVideoPage:function(){"/video/sport"===window.location.pathname&&e.trackCustomGoal("open_sport_page_broadcast")}}});
