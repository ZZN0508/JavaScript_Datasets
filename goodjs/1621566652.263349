define(["OK/logger","OK/utils/utils","OK/utils/throttle","OK/LogClicks"],(function(e,t,i,s){"use strict";var o="seen",n="log.seen",a=[],r=[],h=i(150,(function(){for(var e=r.length;e--;)r[e].onScroll()}));function l(t,i,s){OK.logging.info(o+" "+t+" "+i),e[s?"force":"success"](o,t,i)}function m(){this.params={},this.seenStartTime=0,this.hoverStartTime=0,this.onScrollSeenTimer=null,this.logData={}}return m.prototype.activate=function(e){if(this.element=e,this.params=JSON.parse(e.getAttribute("data-seen-params")),this.params.options){this.seenTimeout=this.params.options.seenTimeout,this.skipVisible=this.params.options.skipVisible||!1,this.hoverTimeout=this.params.options.hoverTimeout,this.seenPartial=this.params.options.partial||.01,this.seenForce=this.params.options.force||!1,this.onScrollSeen=this.params.options.onScrollSeen||!1,this.onScrollSeenTimeout=this.params.options.onScrollSeenTimeout||1e4,this.onScrollPartial=this.params.options.onScrollPartial||.6,this.disableNullHeight=this.params.options.disableNullHeight||!1;var i=s.getLogDataAsString(e),o=i&&s.parseLogData(i);o&&o.feedFeatures&&(this.params.data=this.params.data||{},this.params.data.feedFeatures=o.feedFeatures,o.feedPosition&&(this.params.data.feedPosition=Number(o.feedPosition)),o.feedLocation&&(this.params.data.feedLocation=o.feedLocation))}if(this.boundMouseEnter=this.mouseEnter.bind(this),this.boundMouseLeave=this.mouseLeave.bind(this),this.boundClick=this.onClick.bind(this),this.hoverTimeout&&(this.element.addEventListener("mouseenter",this.boundMouseEnter),this.element.addEventListener("mouseleave",this.boundMouseLeave)),this.seenTimeout&&this.element.addEventListener("click",this.boundClick),this.seenTimeout&&!this.skipVisible){var n=t.isElementPartiallyInViewport(e,this.seenPartial,this.disableNullHeight);!1!==n&&this.shown(this.getNullHeightLogParam(n))}return this},m.prototype.deactivate=function(){this.hoverTimeout&&(this.element.removeEventListener("mouseenter",this.boundMouseEnter),this.element.removeEventListener("mouseleave",this.boundMouseLeave)),this.seenTimeout&&(this.element.removeEventListener("click",this.boundClick),this.hidden())},m.prototype.shown=function(e){this.logData=Object.assign(e,this.params.data),this.seenStartTime=Date.now()},m.prototype.shownOnScroll=function(){if(this.onScrollSeen&&!this.onScrollSeenTimer&&!this.logData.seen){var e=t.isElementPartiallyInViewport(this.element,this.onScrollPartial,this.disableNullHeight);!1!==e&&(this.onScrollSeenTimer=setTimeout(function(){this.logData.seen||(this.logData.seen=this.onScrollSeenTimeout,this.logData.nullHeight=null===e,l(this.params.type,JSON.stringify(this.logData),this.seenForce))}.bind(this),this.onScrollSeenTimeout))}},m.prototype.hidden=function(){if(this.seenStartTime&&!this.logData.seen){var e=Date.now()-this.seenStartTime;e>=this.seenTimeout&&(this.logData.seen=e,l(this.params.type,JSON.stringify(this.logData),this.seenForce))}this.logData.seen=0,this.seenStartTime=0,this.onScrollSeenTimer&&(clearTimeout(this.onScrollSeenTimer),this.onScrollSeenTimer=null)},m.prototype.mouseEnter=function(){this.hoverStartTime=Date.now()},m.prototype.mouseLeave=function(){if(this.hoverStartTime){var e=Date.now()-this.hoverStartTime;e>=this.hoverTimeout&&(this.logData.hovered=e)}this.hoverStartTime=0},m.prototype.onScroll=function(){if(this.seenTimeout){var e=t.isElementPartiallyInViewport(this.element,this.seenPartial,this.disableNullHeight);!1!==e?(this.seenStartTime||this.shown(this.getNullHeightLogParam(e)),this.shownOnScroll()):!0!==this.disableNullHeight&&this.hidden()}},m.prototype.onClick=function(){this.seenStartTime?this.logData.seen=Date.now()-this.seenStartTime:(this.skipVisible&&this.shown(this.getNullHeightLogParam(!0)),this.logData.seen=0),this.logData.seen=this.seenStartTime?Date.now()-this.seenStartTime:0,this.logData.clicked=!0,l(this.params.type,JSON.stringify(this.logData),this.seenForce),this.seenStartTime=0},m.prototype.getNullHeightLogParam=function(e){return{nullHeight:null===e}},{logError:function(t){OK.logging.alert(n+" "+t),e.error(n,t)},logSuccess:l,activate:function(e){-1===a.indexOf(e)&&(a.push(e),r.push((new m).activate(e))),1===r.length&&window.addEventListener("scroll",h,!0)},deactivate:function(e){var t=a.indexOf(e);-1!==t&&(r[t].deactivate(),a.splice(t,1),r.splice(t,1)),r.length||window.removeEventListener("scroll",h,!0)}}}));