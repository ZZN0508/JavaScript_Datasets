define("idcta-v2/analytics",["idcta-v2/config"],function(e){function r(t,n,r){return function(){var e=a[t]&&a[t][n];o&&i&&!e&&document.dispatchEvent(new CustomEvent("bbc-user-event",{detail:{container:"id_cta_client_side",label:n,source:t}})),o=!1;e=[].slice.apply(arguments),e=r.apply(this,e);return o=!0,e}}var t={},i=!0,o=!0,a={"idcta-1":{addUserOrigin:!0,getCookieInstance:!0,getIdFromCookie:!0,getUserDetailsFromCookie:!0,hasCookie:!0,initiateTokenRefresh:!0,Cta:!0,modifyPtrt:!0},"id-config":{getConfigAsync:!0},idCookie:{getInstance:!0},statusbar:{Statusbar:!0}};return t.setLoggingEnabled=function(e){i=e},t.withAnalytics=r,t.wrapModuleWithAnalytics=function(t,n){e&&e.features.clientAnalytics&&Object.keys&&Object.keys(t).forEach(function(e){"function"==typeof t[e]&&(t[e]=r(n,e,t[e]))})},t}),define("idcta-v2/logger",["idcta-v2/analytics"],function(e){var t={logCaughtError:function(e){window.console&&e.message&&console.log(e)},logMessage:function(e){document.cookie.match(new RegExp("ckns_debugtoken=([^;]+)"))&&(window.tokenRefeshLog=window.tokenRefeshLog||[],window.tokenRefeshLog.push(e))}};return e.wrapModuleWithAnalytics(t,"logger"),t}),define("idcta-v2/apiUtils",["idcta-v2/es6-promise","idcta-v2/logger"],function(e,u){function o(e,t){var n=t.substring(0,t.indexOf("=")+1);if(-1<e.indexOf(n))return e;var r=e.split("#"),n=-1<e.indexOf("?")?"&":"?";return 1<r.length?r[0]+n+t+"#"+r[1]:e+n+t}var g={verifyEndpointUrl:function(e,t){try{if(!1!==t&&(t=!0),/https?:\/\/(((www|ssl)(\.int|\.test|\.stage)?)|(pal\.sandbox\.dev))\.bbc\.(co\.uk|com)/.test(e))return e=/(\.com|\.co\.uk)\/.+/.test(e)?e.split(/(\.com|\.co\.uk)\/.+/)[0]+e.split(/(\.com|\.co\.uk)\/.+/)[1]:e;var n="";"https"==e.slice(0,5)?(n+=(t?"https://":"")+"ssl.",-1<e.indexOf(".sandbox.")&&(n+="sandbox.dev.")):(n+=t?"http://":"",-1<e.indexOf(".sandbox.")?n+="pal.sandbox.dev.":n+="www.");for(var r=["int","test","stage"],i=0;i<r.length;i++)-1<e.indexOf("."+r[i]+".")&&(n+=r[i]+".");return/\.co\.uk/.test(e)?n+="bbc.co.uk":n+="bbc.com",n}catch(e){u.logCaughtError(e)}},alignTldWithHostname:function(e,t){try{var n=(t||window.location.hostname).split(/(\.com|\.co\.uk)$/)[1],r=e.split(/(\.com|\.co\.uk)\/.+/)[1];return e=r!==n&&void 0!==n?e.replace(r,n):e}catch(e){u.logCaughtError(e)}},appendProductToCtaElement:function(n){var r,i,e=n.getAttribute("href");if(e&&(-1===e.indexOf("userOrigin=")||-1===e.indexOf("context=")))return g.getProductNameAsync().then(function(e){var t;void 0!==e&&""!==e&&(r="userOrigin="+e.userOrigin,i="context="+e.context,t=n.getAttribute("href"),(e=g.parseUrl(t))&&(g.parseQueryString(e.search),t=e.pathname,-1===e.pathname.indexOf("/")&&(t="/"+e.pathname),n.setAttribute("href",e.protocol+"//"+e.host+t+o(o(e.search,r),i)+e.hash)))})},appendQueryParameters:function(e,t){var n=(i=e.split("#"))[0],e=i[1],n=(n=(i=n.split("?"))[1])?n.split("&").reduce(function(e,t){var n=t.split("="),t=n[0],n=n[1];return e[t]=n,e},{}):{},r=Object.assign({},n,t),i=(t=Object.keys(r).map(function(e){return e+"="+r[e]}).join("&"))?i[0]+"?"+t:i[0];return e?i+"#"+e:i}};return g.addQueryParameter=o,g.getProductNameAsync=function(){var t={context:"",userOrigin:""};return window.bbcpage&&window.bbcpage.getDestination?window.bbcpage.getDestination().then(function(e){return e?{context:e.replace(/_TEST$/i,"").replace(/_PS$/i,"").replace(/_GNL$/i,"").toLowerCase(),userOrigin:e}:t}):g.Promise.resolve(t)},g.Promise=function(){try{return"undefined"!=typeof Promise?Promise:e.Promise}catch(e){u.logCaughtError(e)}}(),g.loadUrlInHiddenIframe=function(a,s,c){try{return new g.Promise(function(n,e){u.logMessage('Creating iframe {src: "'+a+'", timeout: '+s+(c?', expectedPostMessages: ["'+c.join('", "')+'"]}':"}"));var t=document.createElement("iframe");t.scrolling="no",t.frameborder="0",t.width="0px",t.height="0px",t.border="0px",t.style.display="none",t.style.frameBorder="0px",t.style.borderStyle="none";function r(){i&&clearTimeout(i),c&&g.removeEventListener("message",o),document.body.removeChild(t)}var i=null,o=function(e){var t=e.message?"message":"data";return e.origin.match(/\.bbc\.(co\.uk|com)(:[0-9]+)*$/)&&-1!=c.indexOf(e[t])?(u.logMessage('Iframe received message "'+e[t]+'", resolving'),r(),n(e[t])):void u.logMessage('Iframe received unexpected message "'+e[t]+'", ignoring')};c?g.addEventListener("message",o):t.onload=function(){return u.logMessage('Iframe with src "'+a+'" loading complete'),r(),n()},s&&(i=setTimeout(function(){return u.logMessage("Iframe with src "+a+" timed out after "+s+" milli seconds"),r(),e()},s)),t.src=a,document.body.appendChild(t)})}catch(a){u.logCaughtError(a)}},g.addEventListener=function(e,t,n){g.addEventListenerTo(window,e,t,n)},g.addEventListenerTo=function(e,t,n,r){try{return e.addEventListener?e.addEventListener(t,n,r):(t="message"==t?"onmessage":t,e.attachEvent(t,n))}catch(e){u.logCaughtError(e)}},g.removeEventListener=function(e,t){g.removeEventListenerFrom(window,e,t)},g.removeEventListenerFrom=function(e,t,n){try{return e.removeEventListener?e.removeEventListener(t,n):(t="message"==t?"onmessage":t,e.detachEvent(t,n))}catch(e){u.logCaughtError(e)}},g.getEnvFromUrl=function(){try{var e=window.location.href;return-1<e.indexOf(".sandbox.")?".sandbox.dev":-1<e.indexOf(".int.")?".int":-1<e.indexOf(".test.")?".test":-1<e.indexOf(".stage.")?".stage":""}catch(e){u.logCaughtError(e)}},g.parseUrl=function(e){try{var t=document.createElement("a");return t.href=e,t.query=t.search?g.parseQueryString(t.search):{},t}catch(e){u.logCaughtError(e)}},g.parseQueryString=function(e){try{"?"===e.charAt(0)&&(e=e.substring(1));for(var t={},n=e.split("&"),r=0;r<n.length;r++){var i=n[r].split("=");t[decodeURIComponent(i[0])]=decodeURIComponent(i[1]||"")}return t}catch(e){u.logCaughtError(e)}},g.timestampInFuture=function(e){try{return e>(new Date).getTime()}catch(e){u.logCaughtError(e)}},g.timestampExpired=function(e){try{return e<(new Date).getTime()}catch(e){u.logCaughtError(e)}},g.generateFutureTimestamp=function(e){try{e=e||36e5;var t=new Date;return t.setTime(t.getTime()+e),t.getTime()}catch(e){u.logCaughtError(e)}},u.logCaughtError=function(e){window.console&&e.message&&console.log(e)},u.logMessage=function(e){document.cookie.match(new RegExp("ckns_debugtoken=([^;]+)"))&&(window.tokenRefeshLog=window.tokenRefeshLog||[],window.tokenRefeshLog.push(e))},g}),define("idcta-v2/id-config",["idcta-v2/config","idcta-v2/apiUtils","idcta-v2/analytics"],function(n,r,e){var t,i="co"===(t=window.location.host.split("."))[t.length-2]&&"uk"===t[t.length-1]?t[t.length-3]+".co.uk":t[t.length-2]+"."+t[t.length-1],t={},o=r.getProductNameAsync().then(function(e){var t={context:e.context,userOrigin:e.userOrigin};return{get announce_url(){return r.alignTldWithHostname(n.announce_url)},get"bbcid-v5"(){return n["bbcid-v5"]},get child_parent_linking_url(){return n.child_parent_linking_url},get"id-availability"(){return n["id-availability"]},get identity(){return{cookieAgeDays:n.identity.cookieAgeDays,accessTokenCookieName:n.identity.accessTokenCookieName,idSignedInCookieName:n.identity.idSignedInCookieName}},get identityTokenExchangeUrl(){return r.alignTldWithHostname(n.identityTokenExchangeUrl)},get privacy_settings_url(){return n.privacy_settings_url},get profiles_create_url(){return n.profiles.create},get profiles_list_url(){return n.profiles.list},get ptrt(){return window.location.href},get register_url(){return r.appendQueryParameters(r.alignTldWithHostname(n.register_url),t)},get settings_url(){return r.appendQueryParameters(n.settings_url,t)},get signin_url(){return r.appendQueryParameters(r.alignTldWithHostname(n.signin_url),t)},get signout_url(){return r.appendQueryParameters(n.signout_url,t)},get status_url(){return r.appendQueryParameters(n.status_url,t)},get tld(){return i},get tokenRefresh(){return n.tokenRefresh||!1},get tokenRefresh_signout_url(){return r.alignTldWithHostname(n.tokenRefresh_signout_url)},get tokenRefresh_url(){return r.alignTldWithHostname(n.tokenRefresh_url)},get translation_signedin(){return n.translations.statusbarSignedIn},get translation_signedout(){return n.translations.statusbarSignedOut}}});return t.getConfigAsync=function(){return o},t.getDomain=function(){return i},t.getIdentity=function(){return n.identity},t.getFeatureDecisions=function(){return n.features},t.getUsiDestinationWhitelist=function(){return n.usiDestinationWhitelist},t.getExperiments=function(){return n.experiments},e.wrapModuleWithAnalytics(t,"id-config"),t}),define("idcta-v2/idCookie",["idcta-v2/id-config","idcta-v2/logger","idcta-v2/analytics"],function(e,a,t){function s(e){try{var t=window.atob(e),n=t.lastIndexOf("}"),r=t.substring(0,n+1);return JSON.parse(r)}catch(e){return null}}function n(){function e(){var e=new RegExp(g+"=([\\w]+)"),t=document.cookie.match(e);if(!t)return i(),0;var n=s(t[1]);if(!n||!r(n)||(e=n,t=(new Date).getTime(),(e["jwt-exp"]||0)<=t))return i(),0;o.valid=!0,o.displayname=n.dn,o.timestamp=n["jwt-exp"]}function r(e){return e.hasOwnProperty("ps")&&e.hasOwnProperty("jwt-exp")&&e.hasOwnProperty("tkn-exp")&&(e.hy||e.hasOwnProperty("ses-exp"))}function i(){o.valid=!1,o.id="",o.username="~",o.displayname="",o.timestamp=""}var o=this;this.valid=!1,this.id="",this.username="~",this.displayname="",this.timestamp="",this.cookieAgeDays=d,this.isIdv5On=!0,this.refreshCookie=function(){try{e()}catch(e){a.logCaughtError(e)}},this.hasCookie=function(){try{return e=o.cookieAgeDays*c,(new Date).getTime()-o.timestamp>=e&&i(),o.valid}catch(e){a.logCaughtError(e)}var e},this.hasAccessTokenExpired=function(){try{var e=this.getUserDetailsFromCookie();if(!e)return!0;var t=(new Date).getTime();return(e["tkn-exp"]||0)<=t}catch(e){a.logCaughtError(e)}},this.hasJwtTokenExpired=function(){try{var e=this.getUserDetailsFromCookie();if(!e)return!0;var t=(new Date).getTime();return(e["jwt-exp"]||0)<=t}catch(e){a.logCaughtError(e)}},this.isHybridApp=function(){try{var e=this.getUserDetailsFromCookie();return!!e&&(e.hy||!1)}catch(e){a.logCaughtError(e)}},this.getError=function(){try{var e=this.getUserDetailsFromCookie();return e&&e.ec||null}catch(e){a.logCaughtError(e)}},this.getIdFromCookie=function(){try{var e=this.getUserDetailsFromCookie();return e?e.ps:null}catch(e){a.logCaughtError(e)}},this.getHidFromCookie=function(){return this.getCookie(h)||this.getCookie(m)},this.isPersonalisationEnabled=function(){try{var e=this.getUserDetailsFromCookie();return e&&e.ep}catch(e){return a.logCaughtError(e),!1}},this.getUserDetailsFromCookie=function(){try{if(!this.hasCookie())return null;var e=new RegExp(g+"=([\\w]+)"),t=document.cookie.match(e);if(!t)return null;var n=s(decodeURIComponent(t[1]).split("|").toString());return n&&r(n)?n:null}catch(e){a.logCaughtError(e)}},this.getNameFromCookie=function(){try{return this.hasCookie()&&o.displayname&&""!==o.displayname?o.displayname.replace(/\+/g," "):null}catch(e){a.logCaughtError(e)}},this.getRealmFromCookie=function(){try{return this.hasCookie()?this.getUserDetailsFromCookie().realm||"/":null}catch(e){a.logCaughtError(e)}},this.getAccessToken=function(){try{if(!this.hasCookie())return null;var e=new RegExp(l+"=([^;]*)"),t=document.cookie.match(e);return null!==t?t[1]:null}catch(e){a.logCaughtError(e)}},this.getCookie=function(e,t){try{var n=new RegExp(e+"=([^\\s;]*)"),r=document.cookie.match(n);return r?!0!==t?r[1]:s(decodeURIComponent(r[1])):null}catch(e){a.logCaughtError(e)}},this.setCknsIdCookieProperty=function(e,t){try{var n=this.getUserDetailsFromCookie();if(!n)return;t?n[e]=t:delete n[e];var r=n["jwt-exp"]||c*d;!function(e,t,n,r){try{t=t||"";var i,o="";n&&((i=new Date).setTime(i.getTime()+n),o="Expires="+i.toUTCString()+"; "),t=r?window.btoa(t):t,document.cookie=e+"="+t+"; "+o+"Domain="+u+"; Path=/"}catch(e){a.logCaughtError(e)}}(g,JSON.stringify(n),r,!0)}catch(e){a.logCaughtError(e)}},this.unsetCookie=function(e){try{document.cookie=e+"=; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Domain="+u+"; Path=/"}catch(e){a.logCaughtError(e)}},e()}var r={},c=864e5;t.setLoggingEnabled(!1);var i,u=e.getDomain(),g=e.getIdentity()&&e.getIdentity().idSignedInCookieName?e.getIdentity().idSignedInCookieName:"ckns_id",d=e.getIdentity()&&e.getIdentity().cookieAgeDays?e.getIdentity().cookieAgeDays:730,l=e.getIdentity()&&e.getIdentity().accessTokenCookieName?e.getIdentity().accessTokenCookieName:"ckns_atkn",h="ckns_sylphid",m="ckpf_sylphid";return t.setLoggingEnabled(!0),r.getInstance=function(){try{return i?i.refreshCookie():(i=new n,t.wrapModuleWithAnalytics(i,"idCookieInstance")),i}catch(e){a.logCaughtError(e)}},r.setInstance=function(e){try{i=e}catch(e){a.logCaughtError(e)}},t.wrapModuleWithAnalytics(r,"idCookie"),r}),define("idcta-v2/tokenRefresh",["idcta-v2/id-config","idcta-v2/idCookie","idcta-v2/apiUtils","idcta-v2/logger","idcta-v2/analytics"],function(o,a,s,c,e){function u(e,t){this.name="TokenRefreshError",this.message=e,this.retryAfter=t}var g={};u.prototype=Error.prototype;var t={};return t.refreshAccessToken=function(e,n){var t=a.getInstance();try{if(!t.hasCookie()){var r="ckns_id cookie is missing, invalid or expired";return s.Promise.reject(new u(r))}if(t.isHybridApp()){r="hybrid app detected";return s.Promise.reject(new u(r))}var i=t.getError();if(i&&s.timestampInFuture(i.retryAfter)){r="retry period has not passed";return s.Promise.reject(new u(r,i.retryAfter))}if(!0!==e&&!t.hasAccessTokenExpired())return s.Promise.resolve();return void 0===g[n]&&(g[n]=o.getConfigAsync().then(function(e){e=e.tokenRefresh_url,e=n?s.alignTldWithHostname(e,n):e;return fetch(e,{credentials:"include",headers:{"Content-Type":"application/json"}})})),g[n].then(function(){g[n]=void 0}).catch(function(e){return g[n]=void 0,t=e,o.getConfigAsync().then(function(e){e=(new Date).getTime()+(e.tokenRefresh?15e3:36e5);throw t.retryAfter=e,a.getInstance().setCknsIdCookieProperty("ec",t),t});var t})}catch(e){c.logCaughtError(e)}},e.wrapModuleWithAnalytics(t,"tokenRefresh"),t}),define("idcta-v2/idcta-1",["idcta-v2/idCookie","idcta-v2/apiUtils","idcta-v2/tokenRefresh","idcta-v2/logger","idcta-v2/id-config","idcta-v2/es6-promise","idcta-v2/analytics"],function(s,c,n,u,g,e,t){function r(o,a){requirejs(["idcta-v2/signInPrompt","idcta-v2/mvt"],function(e,t){var n=s.getInstance().hasCookie(),r=e.hasInitialised(),i=g.getExperiments();n&&!r||(t.bucketUser(i.usiApiName),t.sendEvent("page_view")),n&&r?t.sendEvent("page_view_signed_in"):n||(i=t.getVariantName(i.usi),t.sendEvent("page_view_signed_out"),e.initialise(o,a,i))})}var i={signals:{},ctas:{}};t.setLoggingEnabled(!1);var o,a,d=g.getFeatureDecisions();return t.setLoggingEnabled(!0),window.bbcpage&&window.bbcpage.getDestination&&window.bbcpage.getContentType&&window.bbcpage.getAdditionalProperties&&d.showUsiModal&&(o=["index-correspondent","index-home","index-section"],a=["article","article-correspondent","article-media-asset","article-photo-gallery","oppm","sports-data"],e.all([window.bbcpage.getDestination(),window.bbcpage.getContentType(),window.bbcpage.getAdditionalProperties()]).then(function(e){var t=e[0]&&e[0].toLowerCase(),n=e[1],e=e[2]&&e[2].app_type;if(-1!==g.getUsiDestinationWhitelist().indexOf(t)&&"mobile-app"!==e)return 0<=o.indexOf(n)?r(t,"index"):0<=a.indexOf(n)?r(t,"article"):void 0}).catch(function(e){console.error("Caught USI initialisation error in IDCTA idcta-1 module",e)})),i.Cta=function(e){try{this.id=e.id,this.element=document.getElementById(e.id),this.states=e.states;var t=this;i.ctas[t.id]=t,!0===e.publiclyCacheable&&(s.getInstance().hasCookie()?function(e){{var t,n;e.states.authorised?(t=s.getInstance().getNameFromCookie(),n=e.states.authorised.anonymous,t&&(n=e.states.authorised.name.replace("{name}",t)),e.element.getElementsByTagName("span")[0].innerText=n):e.element.parentNode&&e.element.parentNode.removeChild(e.element)}}(t):t.element.getElementsByTagName("span")[0].innerText=t.states.unauthorised.signedout)}catch(e){u.logCaughtError(e)}},i.modifyCta=function(e,t,n){try{var r=document.querySelector("#"+e+" span");-1<["small","medium","large"].indexOf(t)&&(r.className=r.className.replace(/small|medium|large/g,t)),-1<["blue","white"].indexOf(n)&&(r.className=r.className.replace(/blue|white/g,n));var i,o=document.querySelectorAll("#"+e+" span a");for(i in o)o.hasOwnProperty(i)&&c.appendProductToCtaElement(o[i])}catch(e){u.logCaughtError(e)}},i.modifyPtrt=function(e,t){try{var n,r,i,o,a,s=document.querySelectorAll("#"+e+" a");if(!s.length)throw"No cta elements found with provided Id";for(n in s)s.hasOwnProperty(n)&&(r=s[n].getAttribute("href"),i=decodeURIComponent(r).match(/ptrt\=([a-zA-Z:\/\/\_\\0-9.-]*)&?/).pop(),i=encodeURIComponent(i),o=r.substring(0,r.indexOf(i)),a=r.substring(r.indexOf(i)+i.length),s[n].setAttribute("href",o+t+a),c.appendProductToCtaElement(s[n]))}catch(e){u.logCaughtError(e)}},i.addUserOrigin=function(e){function t(){c.appendProductToCtaElement(this)}var n=document.querySelectorAll("#"+e);if(n.length)for(var r=0;r<n.length;r++)for(var i=n[r].getElementsByTagName("a"),o=0;o<i.length;o++)c.addEventListenerTo(i[o],"click",t,!1)},i.initiateTokenRefresh=function(e,t){try{return e=!0===e,n.refreshAccessToken(e,t)}catch(e){u.logCaughtError(e)}},i.initiateUserUplift=function(){try{return i.initiateTokenRefresh().then(function(){return!0},function(){throw!1})}catch(e){u.logCaughtError(e)}},i.hasCookie=function(){return s.getInstance().hasCookie()},i.getCookieInstance=function(){return s.getInstance()},i.getIdFromCookie=function(){return s.getInstance().getIdFromCookie()},i.getUserDetailsFromCookie=function(){return s.getInstance().getUserDetailsFromCookie()},i.getNameFromCookie=function(){return s.getInstance().getNameFromCookie()},i.getAccessToken=function(e){return s.getInstance().getAccessToken(e)},t.wrapModuleWithAnalytics(i,"idcta-1"),i});
