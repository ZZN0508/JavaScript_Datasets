define(["OK/logger","OK/utils/dom","OK/ViewportTracker"],function(n,o,h){"use strict";var m="hover";function e(e,t){e.style.backgroundImage="url("+t+")"}function t(){this.isPaused=!0,this.lastFrameTime=0,this.frameID=0,this.bgPos=0,this.lastPos=0,this.active=0}return t.prototype={activate:function(i){var s,e,a=this,t=i.getAttribute("data-framerepeats"),r=t?JSON.parse(t):{};return a.element=i,a.mode=i.getAttribute("data-mode")||"standard",a.width=(e=i,(t=getComputedStyle(e).width)?parseFloat(t.replace("px","")):e.clientWidth||0),a.fps=parseInt(i.getAttribute("data-fps"),10)||24,a.replayDelay=parseInt(i.getAttribute("data-replaydelay"),10)||0,a.frameDuration=1e3/this.fps+1,a.bindedRender=this.render.bind(this),a.previewImage=this.element.style.backgroundImage,a.spriteImage=i.getAttribute("data-image"),s=a.spriteImage,new Promise(function(e,t){var i=new Image;i.onload=e,i.onerror=t,i.src=s}).then(function(e){var t=e.target,e="auto"===(e=i.getAttribute("data-frames"))?Math.round(t.width/a.width):parseInt(e,10)||60;a.frames=function(e,t,i){for(var s,a,r,n=[],o=0;o<e;o++)if(s=-Math.round(o*i)+"px 0",t[o])for(a=t[o],r=0;r<a;r++)n.push(s);else n.push(s);return n}(e,r,a.width),a.mode===m?(e=o.parent(a.element,"js-hover-container"))&&e!==document&&(e.addEventListener("mouseover",a),e.addEventListener("mouseout",a),a.hoverElement=e):h.add(a.element,function(e){e?a.play():a.pause()})},function(e){throw n.clob("error",a.spriteImage,"prefetch","sprite"),e})},setSpriteImage:function(){e(this.element,this.spriteImage)},setPreviewImage:function(){e(this.element,this.previewImage)},deactivate:function(){this.stop(),this.hoverElement&&(this.hoverElement.removeEventListener("mouseover",this),this.hoverElement.removeEventListener("mouseout",this)),this.mode!==m&&h.remove(this.element)},handleEvent:function(e){"mouseout"===e.type?this.pause():"mouseover"===e.type&&this.play()},play:function(){this.setSpriteImage(),this.frameID||(this.isPaused=!1,this.frameID=requestAnimationFrame(this.bindedRender))},pause:function(){this.isPaused||(cancelAnimationFrame(this.frameID),this.frameID=0,this.lastFrameTime=0,this.isPaused=!0)},stop:function(){this.pause(),this.setPreviewImage(),this.active=0},render:function(){this.frameID=requestAnimationFrame(this.bindedRender);var e=Date.now();this.fps<60&&this.lastFrameTime&&this.lastFrameTime+this.frameDuration>e||(this.lastFrameTime=e,this.tick(),this.bgPos=this.frames[this.active],this.bgPos!==this.lastPos&&(this.element.style.backgroundPosition=this.lastPos=this.bgPos))},tick:function(){var e,t;this.active++,this.active>=this.frames.length&&(e=this.replayDelay,t=this,0!==e&&(this.pause(),setTimeout(function(){t.play()},e)),this.active=0)}},t});
