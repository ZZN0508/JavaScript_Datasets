var CrossStorageHub={init:function(e){var r=!0;try{window.localStorage||(r=!1)}catch(e){r=!1}if(!r)try{return window.parent.postMessage("unavailable","*")}catch(e){return}CrossStorageHub._permissions=e||[],CrossStorageHub._installListener(),window.parent.postMessage("ready","*")},_installListener:function(){var e=CrossStorageHub._listener;window.addEventListener?window.addEventListener("message",e,!1):window.attachEvent("onmessage",e)},_listener:function(e){var r,t,n;if("poll"===e.data)return window.parent.postMessage("ready",e.origin);if("ready"!==e.data){if(r=JSON.parse(e.data),CrossStorageHub._permitted(e.origin,r.method))try{n=CrossStorageHub["_"+r.method](r.params)}catch(e){t=e.message}else t="Invalid permissions for "+r.method;n=JSON.stringify({id:r.id,error:t,result:n}),window.parent.postMessage(n,e.origin)}},_permitted:function(e,r){var t,n;if(!CrossStorageHub._inArray(r,["get","set","del","clear","getKeys"]))return!1;for(t=0;t<CrossStorageHub._permissions.length;t++)if((n=CrossStorageHub._permissions[t]).origin instanceof RegExp&&n.allow instanceof Array&&(n.origin.test(e)&&CrossStorageHub._inArray(r,n.allow)))return!0;return!1},_set:function(e){var r,t=e.ttl;if(t&&parseInt(t,10)!==t)throw new Error("ttl must be a number");r={value:e.value},t&&(r.expire=CrossStorageHub._now()+t),window.localStorage.setItem(e.key,JSON.stringify(r))},_get:function(e){for(var r,t,n=window.localStorage,o=[],a=0;a<e.keys.length;a++)t=e.keys[a],null===(r=JSON.parse(n.getItem(t)))?o.push(null):r.expire&&r.expire<CrossStorageHub._now()?(n.removeItem(t),o.push(null)):o.push(r.value);return 1<o.length?o:o[0]},_del:function(e){for(var r=0;r<e.keys.length;r++)window.localStorage.removeItem(e.keys[r])},_clear:function(){window.localStorage.clear()},_getKeys:function(){for(var e=[],r=window.localStorage.length,t=0;t<r;t++)e.push(window.localStorage.key(t));return e},_inArray:function(e,r){for(var t=0;t<r.length;t++)if(e===r[t])return!0;return!1},_now:function(){return"function"==typeof Date.now?Date.now():(new Date).getTime()}};
