define(["require","exports","OK/utils/dom"],function(t,e,v){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var C="__full",I="invisible";function i(){this.linesLimit=null}var n={textCnt:{configurable:!0}};i.prototype.activate=function(t){var e,i,n=v.firstByClass(t,"media-text_cnt_tx");n&&(this.onlyCrop="1"===t.getAttribute("data-only-crop"),(e=t.nextSibling)&&e.classList.contains("media_more")&&(this.moreInfo=e,this.onlyCrop&&e&&e.classList.remove(I),this.el=t,this.expandable="1"===t.getAttribute("data-expandable"),this.hasStyleTokens="1"===t.getAttribute("data-has-style-tokens"),this.expandable&&this.moreInfo&&this.moreInfo.addEventListener("click",this),null!==(i=t.getAttribute("data-lines-limit"))?(this.linesLimit=+i,this.threshold=(e=this.textCnt,i=this.linesLimit,e=window.getComputedStyle(e),parseInt(e.lineHeight,10)*i)):this.threshold=t.classList.contains("__compact")?63:105,n.clientHeight>this.threshold?this.collapse():this.expand()))},i.prototype.handleEvent=function(t){this.onClick(t)},i.prototype.deactivate=function(){this.expandable&&this.moreInfo&&this.moreInfo.removeEventListener("click",this),this.el=null,this.moreInfo=null,this.onClick=null},i.prototype.isFull=function(){return this.el.classList.contains(C)},i.prototype.expand=function(){this.el.classList.add(C),this.onlyCrop||this.moreInfo&&this.moreInfo.classList.add(I),this.hasStyleTokens&&(this.textCnt.style.maxHeight="none")},n.textCnt.get=function(){return this._textCnt||(this._textCnt=v.firstByClass(this.el,"media-text_cnt")),this._textCnt},i.prototype.collapse=function(){if(this.el.classList.remove(C),this.moreInfo&&this.moreInfo.classList.remove(I),this.hasStyleTokens||null!==this.linesLimit){for(var t,e=this.textCnt,i=window.getComputedStyle(this.textCnt),n=parseInt(i.lineHeight,10),s=v.byClass(e,"media-text-token"),o=e.getBoundingClientRect(),l=this.threshold,r=0;r<s.length;r++){var a=s[r],h=a.getBoundingClientRect();if(!(h.bottom-o.top<=l)){var p=window.getComputedStyle(a),d=h.top-o.top,c=parseInt(p.marginTop,10);if(l<d-c){for(var u=d-c;0<u;){var m=u;if(m<=this.threshold)return void(e.style.maxHeight=m+"px");u-=n}return}var f=parseInt(p.paddingTop,10),h=parseInt(p.paddingBottom,10),g=parseInt(p.lineHeight,10),h=a.clientHeight-f-h;if(!g)return;for(var x=h;0<x;){var y=d+x+f;if(y<=l)return void(e.style.maxHeight=y+"px");x-=g}return void(e.style.maxHeight=d-c+"px")}}s.length?(i=(t=s[s.length-1]).getBoundingClientRect(),t=window.getComputedStyle(t),t=parseInt(t.marginBottom,10),i=i.bottom-o.top+t,(t=this.threshold-i)<=0||(t=Math.floor(t/n),e.style.maxHeight=i+t*n+"px")):e.style.maxHeight=l+"px"}},i.prototype.onClick=function(t){this.isFull()||(this.expand(),t.preventDefault())},Object.defineProperties(i.prototype,n),e.default=i});
