define(["OK/utils/utils","OK/utils/dom","OK/autofocus"],(function(t,e,s){"use strict";function i(t){t.wrapper.classList.add("search-input_searching")}function a(t,e){(e||function(t){return t.input.value.trim()!==t.previous}(t))&&(t.previous=t.input.value.trim(),t.timer&&clearTimeout(t.timer),i(t),t.timer=setTimeout(t.onChange.bind(t),t.timeout))}function r(t,e){for(var s=e.substring(Math.max(0,e.indexOf("?")+1)).split("&"),i=0;i<s.length;i++){var a=s[i];if(0===a.indexOf(t+"="))return a.substr(t.length+1)}return""}var n=function(){this.loading=!1};return n.prototype={onFinish:function(){this.wrapper.classList.remove("search-input_searching")},onChange:function(){var e={};if(e[this.input.name]=this.input.value.trim(),this.dynamicParamsNames)for(var s=0;s<this.dynamicParamsNames.length;s++){var i=this.dynamicParamsNames[s];this.input.hasAttribute(i)&&(e[i]=this.input.getAttribute(i))}if(this.request&&this.cancelRequests&&this.request.xhr.abort(),this.request=t.ajax({type:"GET",url:this.url,data:e}).done(function(e,s,i){this.onFinish(),t.updateBlockModelCallback(e,s,i),this.input.dispatchEvent(new CustomEvent("searchEnd",{bubbles:!0}))}.bind(this)),"altGroupAdvertsPage"==r("st.cmd",this.url)&&"on"==r("st.search",this.url)){var a=OK.historyManager.getState();-1==a.indexOf("/search",a.length-"/search".length)&&("/"==a[a.length-1]&&(a=a.slice(0,-1)),""==r("st.selection",this.url)&&(a=a.replace(/\/[0-9]+$/,"")),OK.historyManager.pushState(a+"/search"))}},clear:function(){this.input.value="",this.previous="",this.wrapper.classList.remove("search-input_active"),this.toggleNeighbours(!0),i(this),this.onChange();var t=this.wrapper.querySelector(".js-search-parameters:not(.js-grid)");(t&&t.classList.add("invisible"),this.advertsBack)&&this.wrapper.querySelector(".js-search-parameters.js-grid").classList.remove("invisible")},isEmpty:function(){return 0===this.input.value.trim().length},handleEvent:function(t){var e=t.type;if("click"!==e){if("keydown"===e)switch(t.which){case 13:a(this,!0);break;case 27:this.isEmpty()?this.input.blur():this.clear(),t.stopPropagation()}else a(this,!1);this.isEmpty()?(this.wrapper.classList.remove("search-input_active"),this.toggleNeighbours(!0)):(this.wrapper.classList.add("search-input_active"),this.toggleNeighbours(!1))}else this.clear()},toggleNeighbours:function(t){var e=this.hideOnSearchClass;this.hideOnSearchEls&&this.hideOnSearchEls.forEach((function(s){s.classList.toggle(e,!t)}))},activate:function(t){var i;this.input=t,this.previous=this.input.value.trim(),this.wrapper=t.parentNode.parentNode,this.url=t.getAttribute("data-url"),this.cancelRequests="true"===t.getAttribute("data-cancel-requests"),this.timeout=parseInt(t.getAttribute("data-searchtimeout"),10),this.advertsBack="true"===t.getAttribute("data-adverts-back");var a=t.getAttribute("data-dynamic_params_names");a&&(this.dynamicParamsNames=a.split(",").filter((function(t){return t.length>0}))),t.addEventListener("keydown",this,!1),t.addEventListener("keyup",this,!1),t.addEventListener("keypress",this,!1),t.addEventListener("paste",this,!1),1===(i=this.wrapper.getElementsByClassName("ic_close-g")).length&&(this.close=i[0],this.close.addEventListener("click",this,!1));var r=e.parent(t,"js-hide-on-search-wr");r&&(this.hideOnSearchEls=e.byClass(r,"js-hide-on-search"),this.hideOnSearchClass=t.getAttribute("data-hide-on-search-class")||"anim_shrink"),"true"===t.getAttribute("data-autofocus")&&s.activate(t)},deactivate:function(t){t.removeEventListener("keydown",this,!1),t.removeEventListener("keyup",this,!1),t.removeEventListener("keypress",this,!1),t.removeEventListener("paste",this,!1),this.close&&this.close.removeEventListener("click",this,!1)}},n}));