define(["jquery","OK/utils/vanilla","OK/utils/utils","OK/utils/dom","OK/alf"],function(n,t,h,r,d){function o(){}var c={},l=!1;function k(t,o){l=!0;try{var i=c[t];if(!i||0==i.length)return;for(var e=[],s=0;s<i.length;s++)e.push(i[s].blockHookId);for(s=0;s<e.length;s++)OK.hookModel.setHookContent(e[s],o)}finally{l=!1}}function u(t){return t.type+"_"+t.id1+"_"+t.id2}function f(a){var o,t,n=u(this),l=this.isReshare,i=this.resharesRestricted,e=!1;if(this.hookElem.data("clickFromVideo")&&(i="on"),this.hookElem.removeData("clickFromVideo"),l){if(!a)return;o={}}else o={"st.v.refId1":this.id1,"st.v.refId2":this.id2,"st.v.type":this.type,"st.v.owner":this.owner,"st.v.count":this.count,"st.v.resharesRestricted":i},this.idStr&&(o["st.v.refIdStr"]=this.idStr),o["st.v.hookId"]=this.blockHookId,this.blockHook.hasClass("__vis")&&(o["st.v.hookId"]=this.blockHookId),a&&(o["st.v.like"]=this.like);function s(){h.ajax({type:"POST",url:this.url,data:o}).done(function(t,o,i){var e,s;null!=t&&0!=t.length&&(a&&c[n].forEach(function(t){t._haveDataToSave=!1}),l?h.updateBlockModelCallback(t,o,i):((s=t.indexOf(OK.navigation.SPLITER))<0?e=t:(e=t.substring(0,s),h.updateBlockModelCallback(t.substring(s),o,i)),k(n,e)))})}(e=a&&"on"===o["st.v.like"]?!0:e)?(i=this.hookElem.get(0),((t=(e=r.parent(i,"js-video-scope"))?e.getAttribute("data-impression-id"):t)?Promise.resolve(t):d.findAdv(i).then(function(t){return t.getImpressionId()})).then(function(t){t&&(o["st.v.impressionId"]=t),s()},s)):s()}return o.prototype={activate:function(t){var o=n(t);this.hookElem=o,this.blockHookId=OK.hookModel.getNearestBlockHookId(t),this.blockHook=n("#hook_Block_"+this.blockHookId),this.url=this.blockHook.attr("data-url"),this.wideCnt=!1,this.noCnt=!1;var i=this.blockHook.attr("data-flags"),t=this.hookElem.attr("data-flags");if(i||t)for(var e=(i+","+t).split(","),s=0;s<e.length;s++)switch(e[s]){case"wideCnt":this.wideCnt=!0;break;case"noCnt":this.noCnt=!0}this.id1=o.data("id1"),this.id2=o.data("id2")||0,this.idStr=o.data("idStr"),this.type=o.data("type"),this.owner=o.data("owner"),void 0===this.owner&&(this.owner=null),this.like=o.data("like")||"on",this.count=o.data("count")||0,this.isReshare="RESHARE"==this.type,this.resharesRestricted=this.blockHook.data("resharesrestricted");t="off"!=o.attr("data-canlike");this.url&&t&&(t&&o.click(function(t){t=t.target.getAttribute("uid"),OK.isStopped()||t||f.call(this,!0)}.bind(this)),this.isReshare||o.mouseenter(function(){f.call(this,!1)}.bind(this)));t=n(".widget",this.blockHook);t.toggleClass("__compact","true"==this.blockHook.attr("data-compact")),t.toggleClass("__no-count",this.noCnt),t.toggleClass("__wide-count",this.wideCnt),t.toggleClass("__null","true"==o.attr("data-null")),t.toggleClass("__only-icon","true"==this.blockHook.attr("data-only-icon")),this.isReshare&&0==this.count&&o.mouseleave(),"true"!==(t=this).blockHook.attr("data-no-push")&&(o=u(t),(a=c[o])||(c[o]=a=[]),-1<t.count&&0<a.length&&!l&&k(o,t.blockHook.html()),a.push(t));var a=this.blockHook.data("player-id");a&&(t="off"==this.like,runLinkedVideoCallbackFromJS({callbackId:a,liked:t,likeCount:this.count}))},deactivate:function(t){var o=n(t);o.off(),o.removeData(),o=u(t=this),!(o=c[o])||0==o.length||-1<(t=o.indexOf(t))&&o.splice(t,1)}},o});
