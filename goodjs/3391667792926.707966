YUI.add("af-applet-init",function(r,o){"use strict";var s=r.Af,l=s.AppletDom,c=s.Utils,e=s.Config,f=r.Lang,d=s.Bootstrap,u=r.Object,h=r.DOM,g=s.Beacon,w="appletinit",v="data-applet-init",y="appletsinit",A="viewport",b="js-appletiniting",m=c.perfStart,k=c.perfStop,z=e.isDev();function t(){this._defInit=e.getContext("default_appletinit")||A}t.prototype={name:"applet.init",execute:function(t,e,i){switch(e.action){case"page.init":this.initApplets(t),t.after("*:initapplet",function(e){e=e.initapplet;this.initApplet(t,e)},this);break;case"applet.init":this.initApplet(t,e.params)}e.callback&&e.callback(),i()},initApplets:function(a){var e,t=this,i=[],n=c.screenTouchable()?"touchstart":"mouseenter",p=this._scan(a),i=(i=(i=i.concat(u.keys(p.now))).concat(u.keys(p.lazy))).concat(u.keys(p.viewport));d.load(i,{},function(){u.each(p.now,function(e){r.later(5,t,function(){this.initApplet(a,{node:e})})})}),u.each(p.lazy,function(e){e.once(n,function(){this.initApplet(a,{node:e})},this)},this),u.size(p.viewport)&&(u.each(p.viewport,function(e,t){e.once(n,function(){delete p.viewport[t],this.initApplet(a,{node:e})},this)},this),e=r.one(window).after("scroll",c.throttle(function(){var i=h.viewportRegion();u.each(p.viewport,function(e,t){h.inRegion(e.getDOMNode(),i,!1)&&(delete p.viewport[t],r.later(5,this,function(){this.initApplet(a,{node:e})}))},t),e&&0===u.size(p.viewport)&&e.detach()},200))),r.publish(y,{fireOnce:!0,async:!0}),r.fire(y,{applets:a})},_scan:function(n){var p,o=this,e="aptsScanDOM",s={deferred:{},now:{},viewport:{},lazy:{}};return m(e),l.all(r.one("body"),function(e){var t=e.getData(),i=t["applet-defer"],t=t["applet-init"],a=l.getGuid(e);if(!f.isValue(i))switch(t||o._defInit){case"critical":o.initApplet(n,{node:e});break;case"now":s.now[a]=e;break;case"lazy":s.lazy[a]=e;break;case A:p=p||h.viewportRegion(),h.inRegion(e.getDOMNode(),p,!1)?s.now[a]=e:s.viewport[a]=e}}),k(e),s},initApplet:function(e,t){!(t=t||{}).node&&t.guid&&(t.node=l.getNode(t.guid));var i,a,n,p=t.node;if(!p||!p._node||p.hasClass(b))return null;if(i=l.getGuid(p),a=l.getType(p),e.applets[i]){if(!t.replace)return e.applets[i];try{e.applets[i].destroy()}catch(e){if(z)throw e;g.error(o,{},{code:"appdestroy",message:e.stack||e.message,appletType:a})}delete e.applets[i]}if(p.addClass(b),m(n=a+"_aptNew",!0),t={guid:i,type:a,container:"#"+p.get("id")},z)return e.applets[i]=new s.Applet(t),e.applets[i].addTarget(e),k(n,!0),e.fire(w,{applet:{guid:i,type:a}}),p.removeClass(b),p.removeAttribute(v),e.applets[i];try{return e.applets[i]=new s.Applet(t),e.applets[i].addTarget(e),k(n,!0),e.fire(w,{applet:{guid:i,type:a}}),p.removeAttribute(v),e.applets[i]}catch(e){return g.error(o,{},{code:"appinit",message:e.stack||e.message,appletType:a}),null}finally{p.removeClass(b)}}},r.namespace("Af").AppletInit=t},"@VERSION@",{requires:["af-applet","af-beacon","af-bootstrap","af-config","af-utils","event-touch","oop"]});
