define("lofty/util/storage/2.0/userdata-storage",["jquery","lofty/lang/class","lofty/lang/base"],function(r,t,i){"use strict";var s=location.protocol||document.protocol,l=document.domain,e=t(i,{option:{storeName:"localStorage"},fixKey:function(t){var e=new RegExp("[!\"#$%&'()*+,/\\\\:;<=>?@[\\]^`{|}~]","g");return t.replace(/^d/,"___$&").replace(e,"___")},appendChild:function(t,e){t.insertBefore(e,t.lastChild&&t.lastChild.nextSibling)},init:function(t){i.prototype.init.call(this,t||{});var e,a,n=this,_=document.body||document.getElementsByTagName("body")[0],t=this.get("storeName"),o=function(){window.detachEvent("onunload",o),e=a=n.__storage__=null,r.isFunction(CollectGarbage)&&CollectGarbage()};try{(e=new ActiveXObject("htmlfile")).open(),e.write("<html><head><title>"+t+'</title><script type="text/javascript">document.domain = \''+s+"//"+l+"';<\/script></head><body></body></html>"),e.close(),a=e.body,n.__storage__=e.createElement("div"),window.attachEvent("unload",o)}catch(t){a=_,n.__storage__=document.createElement("div")}n.appendChild(a,n.__storage__),n.__storage__.style.display="none",n.__storage__.addBehavior("#default#userData"),n.__storage__.load(t+"_"+l),n.__attributes__=n.__storage__.XMLDocument.documentElement.attributes,n.length=n.__attributes__.length},key:function(t){var e=null;try{e=t>=this.length?null:this.__attributes__[t].name}catch(t){}return e},getItem:function(t){return this.__storage__.getAttribute(this.fixKey(t))},setItem:function(t,e){var a=this;try{a.__storage__.setAttribute(a.fixKey(t),e),a.__storage__.save(this.get("storeName")+"_"+l),a.length=a.__attributes__.length}catch(t){throw{name:"UserDataQuotaExceeded",message:"UserData is out of memory"}}},removeItem:function(t){var e=this;e.__storage__.removeAttribute(e.fixKey(t)),e.__storage__.save(this.get("storeName")+"_"+l),e.length=e.__attributes__.length},clear:function(){var e=this;r.each(e.__attributes__,function(t){e.removeItem(t.name)})},getLength:function(){var t=0;return r.each(this.__attributes__,function(){t++}),t}}),a=null;return e.getDefault=function(){return a=null==a?new e:a},e});
