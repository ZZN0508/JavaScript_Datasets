define(["jquery","OK/utils/vanilla","OK/utils/utils","OK/utils/dom","OK/alf"],(function(t,i,o,e,s){var a={},n=!1,r=function(){};function l(t,i){n=!0;try{var o,e=a[t];if(!e||0==e.length)return;var s=[];for(o=0;o<e.length;o++)s.push(e[o].blockHookId);for(o=0;o<s.length;o++)OK.hookModel.setHookContent(s[o],i)}finally{n=!1}}function h(t){return t.type+"_"+t.id1+"_"+t.id2}function d(){k.call(this,!1)}function c(t){var i=t.target.getAttribute("uid");OK.isStopped()||i||k.call(this,!0)}function k(t){var i,n,r,d,c,k=h(this),u=this.isReshare,f=this.resharesRestricted,v=!1;if(this.hookElem.data("clickFromVideo")&&(f="on"),this.hookElem.removeData("clickFromVideo"),u){if(!t)return;i={}}else i={"st.v.refId1":this.id1,"st.v.refId2":this.id2,"st.v.type":this.type,"st.v.owner":this.owner,"st.v.count":this.count,"st.v.resharesRestricted":f},this.idStr&&(i["st.v.refIdStr"]=this.idStr),i["st.v.hookId"]=this.blockHookId,this.blockHook.hasClass("__vis")&&(i["st.v.hookId"]=this.blockHookId),t&&(i["st.v.like"]=this.like);function g(){o.ajax({type:"POST",url:this.url,data:i}).done((function(i,e,s){if(null!=i&&0!=i.length)if(t&&a[k].forEach((function(t){t._haveDataToSave=!1})),u)o.updateBlockModelCallback(i,e,s);else{var n,r=i.indexOf(OK.navigation.SPLITER);r<0?n=i:(n=i.substring(0,r),o.updateBlockModelCallback(i.substring(r),e,s)),l(k,n)}}))}t&&"on"===i["st.v.like"]&&(v=!0),v?(n=this.hookElem,d=n.get(0),c=e.parent(d,"js-video-scope"),c&&(r=c.getAttribute("data-impression-id")),r?Promise.resolve(r):s.findAdv(d).then((function(t){return t.getImpressionId()}))).then((function(t){t&&(i["st.v.impressionId"]=t),g()}),g):g()}return r.prototype={activate:function(i){var o=t(i);this.hookElem=o,this.blockHookId=OK.hookModel.getNearestBlockHookId(i),this.blockHook=t("#hook_Block_"+this.blockHookId),this.url=this.blockHook.attr("data-url"),this.wideCnt=!1,this.noCnt=!1;var e=this.blockHook.attr("data-flags"),s=this.hookElem.attr("data-flags");if(e||s)for(var r=(e+","+s).split(","),k=0;k<r.length;k++)switch(r[k]){case"wideCnt":this.wideCnt=!0;break;case"noCnt":this.noCnt=!0}this.id1=o.data("id1"),this.id2=o.data("id2")||0,this.idStr=o.data("idStr"),this.type=o.data("type"),this.owner=o.data("owner"),void 0===this.owner&&(this.owner=null),this.like=o.data("like")||"on",this.count=o.data("count")||0,this.isReshare="RESHARE"==this.type,this.resharesRestricted=this.blockHook.data("resharesrestricted");var u="off"!=o.attr("data-canlike");this.url&&u&&(u&&o.click(c.bind(this)),this.isReshare||o.mouseenter(d.bind(this)));var f=t(".widget",this.blockHook);f.toggleClass("__compact","true"==this.blockHook.attr("data-compact")),f.toggleClass("__no-count",this.noCnt),f.toggleClass("__wide-count",this.wideCnt),f.toggleClass("__null","true"==o.attr("data-null")),f.toggleClass("__only-icon","true"==this.blockHook.attr("data-only-icon")),this.isReshare&&0==this.count&&o.mouseleave(),function(t){if("true"===t.blockHook.attr("data-no-push"))return;var i=h(t),o=a[i];o||(a[i]=o=[]);t.count>-1&&o.length>0&&!n&&l(i,t.blockHook.html());o.push(t)}(this);var v=this.blockHook.data("player-id");if(v){var g="off"==this.like;runLinkedVideoCallbackFromJS({callbackId:v,liked:g,likeCount:this.count})}},deactivate:function(i){var o=t(i);o.off(),o.removeData(),function(t){var i=h(t),o=a[i];if(!o||0==o.length)return;var e=o.indexOf(t);e>-1&&o.splice(e,1)}(this)}},r}));