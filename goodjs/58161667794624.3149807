"use strict";var History=function(){var o=this;o.Constant={Cookie:{Product:"H_Product",Keyword:"H_Keyword",OffShortcut:"H_SC_Off",OffHistory:"H_Off"},Id:{AjaxParts:"ajaxParts",HistoryMain:"HMain",HistoryNothing:"HNothing",ItemListMain:"HLSMainItem",ItemListNothing:"HLSNothingItem",CompareMain:"HLSMainCompare",CompareNothing:"HLSNothingCompare",ShortcutOn:"HBtnMenuOn",ShortcutOff:"HBtnMenuOff",HistoryOn:"HBtnHistoryNo",HistoryOff:"HBtnHistoryYes"},Ls:{ItemList:"his_itemlist_ls",Compare:"his_prdcompare_ls"},Setting:{Cookie:{expires:365,path:"/"},MaxKeyword:20,MaxCategory:5,MergeInterval:36e5}},o.manager=new HistoryManager,o.cookies=Cookies.withConverter(function(t,e){if(-1!==[o.Constant.Cookie.Product,o.Constant.Cookie.Keyword].indexOf(e))return(void 0===t?"":t).split(encodeURIComponent(","))});var t=navigator.userAgent.toLowerCase();o.safari=~t.indexOf("safari")&&!~t.indexOf("chrome")};History.prototype.getManager=function(){return this.manager},History.prototype.clearHistory=function(t){var e=this,o=[e.manager.clear()];return t&&o.push(e.manager.setDisabled(!0)),Promise.all(o).then(function(){if(t&&e.disableHistory(t),Cookies.remove(e.Constant.Cookie.Keyword,{path:"/"}),Cookies.remove(e.Constant.Cookie.Product,{path:"/"}),localStorage.clear(),"undefined"!=typeof csrfToken)return $.ajax({url:"/history/ajax/clear/",type:"POST",headers:{"X-Csrf-Token":csrfToken}})})},History.prototype.disableHistory=function(t){return Cookies.remove(this.Constant.Cookie.OffHistory,{path:"/"}),this.manager.setDisabled(t)},History.prototype.disableShortcut=function(t){var e=this;t?Cookies.set(e.Constant.Cookie.OffShortcut,1,e.Constant.Setting.Cookie):Cookies.remove(e.Constant.Cookie.OffShortcut,{path:"/"})},History.prototype.getShortcut=function(){return!!Cookies.get(this.Constant.Cookie.OffShortcut)},History.prototype.deleteHistory=function(e){var o=this;Promise.resolve().then(function(){"undefined"!=typeof csrfToken?$.ajax({url:"/history/ajax/delete/",type:"POST",headers:{"X-Csrf-Token":csrfToken,"X-Delete-Product":e}}).then(function(t){o.removeHistoryPrice(e)},function(){}):o.removeHistoryPrice(e)})},History.prototype.removeHistoryPrice=function(t){var e=this,o=(Cookies.get(e.Constant.Cookie.Product)||"").split(","),n=_.indexOf(o,t);~n&&(o.splice(n,1),Cookies.set(e.Constant.Cookie.Product,o.join(","),e.Constant.Setting.Cookie)),Promise.all([e.manager.removeHistory(t),e.manager.removeBadge(t)]).then(function(){return e.manager.getHistories()}).then(function(t){!e.safari&&0===t.length||e.safari&&0===o.length||1==$("[id^='history_']").size()?location.href="/history/":location.reload()})},History.prototype.setHistoryCompare=function(o,n){var i=this;""!=o&&i.manager.getDisabled().then(function(t){var e;t||((e=JSON.parse(localStorage.getItem(i.Constant.Ls.Compare)||"[]")).splice(i.Constant.Setting.MaxCategory),-1!==(t=_.findIndex(e,{categorycd:o}))&&e.splice(t,1),e.unshift({categorycd:o,productids:n}),localStorage.setItem(i.Constant.Ls.Compare,JSON.stringify(e)))})},History.prototype.removeHistoryCompare=function(t){var e=this,o=JSON.parse(localStorage.getItem(e.Constant.Ls.Compare)||"[]"),n=_.findIndex(o,{categorycd:t});-1!==n&&(o.splice(n,1),localStorage.setItem(e.Constant.Ls.Compare,JSON.stringify(o))),$("#cmp_"+t).remove(),0==o.length?($("#"+e.Constant.Id.CompareMain).hide(),$("#"+e.Constant.Id.CompareNothing).show()):$(".historyCateItem").first().addClass("itemFirst"),$(".cateInner").tile()},History.prototype.displaytHistoryItemList=function(t){return Promise.resolve().then(function(){return[]})},History.prototype.setHistoryItemList=function(o,n){var i=this;""!=o&&i.manager.getDisabled().then(function(t){var e;t||((e=JSON.parse(localStorage.getItem(i.Constant.Ls.ItemList)||"[]")).splice(i.Constant.Setting.MaxCategory),-1!==(t=_.findIndex(e,{categorycd:o}))&&e.splice(t,1),e.unshift({categorycd:o,saveurl:n}),localStorage.setItem(i.Constant.Ls.ItemList,JSON.stringify(e)))})},History.prototype.removeHistoryItemList=function(t){var e=this,o=JSON.parse(localStorage.getItem(e.Constant.Ls.ItemList)||"[]"),n=_.findIndex(o,{categorycd:t});-1!==n&&(o.splice(n,1),localStorage.setItem(e.Constant.Ls.ItemList,JSON.stringify(o))),$("#itm_"+t).remove(),0==o.length?($("#"+e.Constant.Id.ItemListMain).hide(),$("#"+e.Constant.Id.ItemListNothing).show()):$(".historyCateItem").first().addClass("itemFirst"),$(".cateInner").tile()},History.prototype.setHistoryKeyword=function(o){var n=this;"-"!==o&&n.manager.getDisabled().then(function(t){var e;t||((e=(Cookies.get(n.Constant.Cookie.Keyword)||"").split(",")).splice(n.Constant.Setting.MaxKeyword),-1!==(t=e.indexOf(o))&&e.splice(t,1),e.unshift(o),Cookies.set(n.Constant.Cookie.Keyword,e.join(","),n.Constant.Setting.Cookie))})},History.prototype.displayHistory=function(a,s){var r=this,c=!1;return r.syncMerge("undefined"==typeof csrfToken?null:csrfToken).then(function(t){return r.manager.getDisabled()}).then(function(t){return c=t,Promise.all([r.manager.getHistories(),r.manager.getBadges(),r.manager.getUpdated(),r.manager.getPush()])}).then(function(t){return getHistoryBadge(_.map(t,function(t){return JSON.stringify(t)}))}).then(function(t){var e,o=t[StorageConstant.History.Price],n=t[StorageConstant.History.Badge],i=t[StorageConstant.History.Push];e=c?[]:r.safari?_.map(r.cookies.get(r.Constant.Cookie.Product),function(t){return"000000000"+t}):_.map(o,function(t){return("000000000"+(t.price||0)).slice(-9)+t.product});t=_.map(n,function(t){return("000000000"+(t.price||0)).slice(-9)+t.product});return $.ajax("/history/ajax/",{type:"POST",data:{historyProduct:e.join("\0")||"dummy",discountProduct:t.join("\0"),category:a,sort:s,pushDisabled:i.disabled}}).success(function(t){$("#ajaxContent").append($(t)),$(".spinnerArea").hide();t=_.filter(n,function(t){return t.attention}).length;return 0<t&&($("#discountNewCount").text(t+"件"),$("#discountNew").show()),_.each(n,function(t,e){t=$("#discount_"+md5(t.product)+" .itemlabelNew");1===t.length&&n[e].attention&&(t.show(),n[e].attention=!1)}),setBadgeCookie(n),historyView.disableModalInit(),Promise.all([r.manager.setBadges(n),r.manager.setHistories(o)])})})},History.prototype.displaySearch=function(){var n=this,t=JSON.parse(localStorage.getItem(n.Constant.Ls.ItemList)||"[]"),e=JSON.parse(localStorage.getItem(n.Constant.Ls.Compare)||"[]");if(0==t.length&&0==e.length)$("#"+n.Constant.Id.ItemListMain).hide(),$("#"+n.Constant.Id.CompareMain).hide(),$("#"+n.Constant.Id.ItemListNothing).show(),$("#"+n.Constant.Id.CompareNothing).show();else{e={itemlistdata:t,prdcompdata:e};try{$.ajax("/history/modules/searchhistory.ashx",{type:"POST",data:{historydata:JSON.stringify(e)},dataType:"json",traditional:!0,success:function(t){$("#"+n.Constant.Id.ItemListMain).show(),$("#"+n.Constant.Id.CompareMain).show(),$("#categorylist").html(t.itemlistTag),$("#prdcomaprelist").html(t.prdcomapreTag)},error:function(t,e,o){$("#"+n.Constant.Id.ItemListMain).hide(),$("#"+n.Constant.Id.CompareMain).hide(),$("#"+n.Constant.Id.ItemListNothing).show(),$("#"+n.Constant.Id.CompareNothing).show()},complete:function(){$(".cateInner").tile()}})}catch(t){$("#"+n.Constant.Id.ItemListMain).hide(),$("#"+n.Constant.Id.CompareMain).hide(),$("#"+n.Constant.Id.ItemListNothing).show(),$("#"+n.Constant.Id.CompareNothing).show()}}},History.prototype.displayDiff=function(){var t=this;t.safari||$(".itemPrice").each(function(){var d=this,l=$(this).data("kind"),u=$(this).data("price"),h=$(this).data("product");u&&Promise.all([t.manager.getHistories(),t.manager.getBadges()]).then(function(t){var e,o=t[0],n=t[1],i=null;switch(l){case"discount":(i=_(n).findWhere({product:h}))&&(e=i.created);break;case"history":(i=_(o).findWhere({product:h}))&&(e=i.view)}if(i&&e&&"Invalid Date"!==new Date(e)&&null!==i.price){var a=i.price,s=u-a,r=0,t="priceSame",c="±0";if(0!=s){for(r=parseInt(s/a*100),c=s.toString();c!=(c=c.replace(/^(-?\d+)(\d{3})/,"$1,$2")););t=0<s?"priceUp":"priceDown",1<=Math.abs(r)&&(c+="("+(0<r?"+":"")+r+"%)"),c=0<s?"+"+c+"↑":c+"↓"}r=new Date(e),s=r.getFullYear()+"/"+("0"+(r.getMonth()+1)).slice(-2)+"/"+("0"+r.getDate()).slice(-2),r=document.createElement("span");r.setAttribute("class",t),r.innerHTML=("history"===l?"<br>":"")+"&yen;"+c,$(d).append(s+"時点より").append(r)}})})},History.prototype.displayParts=function(e,o,n,i){var a=this;a.manager.getDisabled().then(function(t){t?$("#"+a.Constant.Id.AjaxParts).html(n):a.manager.getHistories().then(function(t){0!==(t=(a.safari?_.chain(a.cookies.get(a.Constant.Cookie.Product)).first(5).map(function(t){return"000000000"+t}):_.chain(t).filter(function(t){return t.product.match(/^[0-9A-Z]{11}$/)}).first(5).map(function(t){return("000000000"+(t.price||"")).slice(-9)+t.product})).value().join("\0")).length||"itemview"===e||"bookitem"===e||"xstorage"===e?(t=_.extend({historyProduct:t||"dummy",type:e,version:o},i||{}),$.ajax("/history/ajax/parts/",{method:"POST",data:t}).success(function(t){$("#"+a.Constant.Id.AjaxParts).html(t)}).error(function(){$("#"+a.Constant.Id.AjaxParts).html(n)})):$("#"+a.Constant.Id.AjaxParts).html(n)})})},History.prototype.syncMerge=function(n){var i=this;return Promise.all([i.manager.getDisabled(),i.manager.getHistories(),i.manager.getMerged()]).then(function(t){var e=t[0],o=t[1],t=t[2];return e||i.safari||new Date-new Date(t||null)<i.Constant.Setting.MergeInterval||!n?Promise.resolve(!1):$.ajax("/history/ajax/merge/",{type:"POST",data:JSON.stringify(o),headers:{"X-Csrf-Token":n},contentType:"application/json"}).done(function(t){return i.manager.setMerged(new Date).then(function(){return i.manager.setHistories(t)}).then(function(){var t;~location.search.indexOf("lid=pc_history_to_login")&&((t=$(".syncComp")).show().css("opacity",0).css({display:"block"}).animate({opacity:1},{duration:100}),setTimeout(function(){t.animate({opacity:0},{duration:500,complete:function(){$(this).css({display:"none"})}})},2500))})}).fail(function(t){return console.log(t),Promise.resolve(!1)})})};var historyView=window.historyView||{};historyView={disableModalInit:function(){historyView.setPushOnclickCatalystEvent(),historyView.setModalEffect(),$(".pushConfigBtn").click(function(){var t,e=$(this);if(!e.hasClass("on"))return!1;("subscribe"==(t=e.attr("data-config"))?historyPushLs.updateLsPushDisabled(!1):"unsubscribe"==t?historyPushLs.updateLsPushDisabled(!0):Promise.reject()).then(function(){$(".pushConfigBtn").toggleClass("on");var t=e.attr("data-notice");t&&alert(t)}).catch(function(t){console.log("disableModalInit",t)})})},setPushOnclickCatalystEvent:function(){$(".onclickPushFunc").click(function(){var t=$(this).attr("data-onclickfunc");return onclickcatalyst_pushfunction(t),!0})},setModalEffect:function(){var e;$(".scommonModalWrapper")[0]&&($(".scommonModalBtn").click(function(){e=$(window).scrollTop();var t=$(this).next();$(t).fadeIn("fast"),$(this).before('<span class="scommonModalBg" style="display: block;"></span>'),historyView.modalResize(),$("body").addClass("noScroll")}),$(".scommonModalWrapper, .scommonModalBtnClose").click(function(){$(".scommonModalBg").remove(),$(".scommonModalWrapper").fadeOut("fast"),$("body").removeClass("noScroll"),window.scrollTo(0,e)}),$(".scommonModalContent").click(function(t){t.stopPropagation()}),$(window).bind("resize",function(){historyView.modalResize()}))},modalResize:function(){var t=$(".scommonModalContent:visible"),e=$(window).width(),o=$(window).height(),n=t.outerWidth(!0),i=t.outerHeight(!0);o<i&&e<n?t.css({left:"0px",top:"10px"}):o<i&&n<e?t.css({left:(e-n)/2+"px",top:"10px"}):i<o&&e<n?t.css({left:"0px",top:(o-i)/2+"px"}):t.css({left:(e-n)/2+"px",top:(o-i)/2+"px"})}};
