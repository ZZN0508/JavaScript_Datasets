define(["PTS/webpush","OK/logger","OK/utils/utils","OK/uuid","OK/utils/vanilla"],function(o,s,t,i,u){"use strict";var n,a="webpush-device-id",c="webpush-endpoint",e="DEFAULT",r="DENIED",l="GRANTED",p="SUBSCRIBED",f="UNSUBSCRIBED",d="/web-api/webpush/sync",b=null,h=!1;function g(){return"PushManager"in window&&"serviceWorker"in navigator&&window.Notification&&"localStorage"in window}function w(){return g()&&h}function v(t){return t=t||"unknown",I("Unsubscribe from notifications"),g()?N().then(function(e){return null!==e&&e.unsubscribe().then(I),"messages"!==t&&T(!1),s.success("webpush."+t+".unsubscribe"),A(),k(f,e,t,!0)},function(e){throw s.error("webpush."+t+".unsubscribe"),I(e),e}):Promise.reject("Push API is not supported")}function S(){return!Notification||"denied"===Notification.permission?Promise.resolve(r):"default"===Notification.permission?Promise.resolve(e):N().then(function(e){return e?p:l})}function m(){return I("Register service worker"),navigator.serviceWorker.register(swPath).then(function(e){if(e.installing?I("Service worker installing. scope = "+e.scope):e.waiting?I("Service worker installed"):e.active&&I("Service worker active"),!e.showNotification)throw s.error("webpush.support.showNotifications"),new Error("Notifications aren't supported on service workers.");if("denied"===Notification.permission)throw s.error("webpush.denied"),new Error("The user has blocked notifications.");if(!("PushManager"in window))throw s.error("webpush.support.pushManager"),new Error("Push messaging isn't supported");return navigator.serviceWorker.ready})}function y(e){return I("Subscribe to notifications"),e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:t.urlBase64ToUint8Array(b)})}function N(){var e=navigator.serviceWorker.getRegistration();return e?e.then(function(e){return e&&e.pushManager?e.pushManager.getSubscription():null}):Promise.resolve()}function k(t,n,e,r){I("Sync subscription");e={status:t,place:e||"unknown",userAction:r};return n&&(e.subscription={deviceId:((r=P(a))||(r=i.generate(),U(a,r)),r),endpoint:n.endpoint,auth:E(n,"auth"),p256dh:E(n,"p256dh")}),u.ajax({method:"POST",url:d,headers:{"Content-Type":"application/json"},data:JSON.stringify(e)}).then(function(){var e;return n&&(e=n.endpoint,U(c,e)),t})}function A(){D(c)}function T(e){U("notification_enabled_messenger",e?"1":"0")}function E(e,t){return btoa(String.fromCharCode.apply(null,new Uint8Array(e.getKey(t))))}function P(e,t){if(!localStorage)return null;try{return localStorage.getItem(e)}catch(e){return s.error("webpush.localStorage-get-"+(e.name||""+e)),t}}function U(e,t){if(localStorage)try{localStorage.setItem(e,t)}catch(e){s.error("webpush.localStorage-set-"+(e.name||""+e))}}function D(e){if(localStorage)try{localStorage.removeItem(e)}catch(e){s.error("webpush.localStorage-remove-"+(e.name||""+e))}}function I(){var e;OK.fn.isDebug()&&(arguments[0]instanceof Error?console.error.apply(console,arguments):((e=Array.prototype.slice.apply(arguments)).unshift("[webpush]"),console.log.apply(console,e)))}return{STATUS_DEFAULT:e,STATUS_GRANTED:l,STATUS_DENIED:r,STATUS_SUBSCRIBED:p,STATUS_UNSUBSCRIBED:f,isSupported:g,isEnabled:w,activate:function(e){if(g()){h="true"===e.getAttribute("data-service-worker-is-enabled"),b=e.getAttribute("data-application-server-key"),n=e.getAttribute("data-server-status");var t="true"===e.getAttribute("data-message-notifications-enabled");if("true"===e.getAttribute("data-extended-settings-enabled")&&n===p&&T(t),D("webpush-activated"),!h)return I("Service worker is disabled"),void v().catch(I);S().then(function(e){return e===p?(I("Subscription is active"),N().then(function(e){n===p&&P(c)===e.endpoint||(I("Subscription has been changed"),s.success("webpush.subscription-changed"),k(p,e))})):e!==l?(I("Permission has been revoked"),A(),T(!1),s.success("webpush.subscription-revoked"),n!==e?k(e):void 0):void(n!==e&&k(e))},I)}},deactivate:function(){},subscribe:function(i){return i=i||"unknown",w()?S().then(function(e){if(e===r)throw new Error("User revoked permissions");return e===p?e:function(){if(Notification){if("default"===Notification.permission)return new Promise(function(t,n){Notification.requestPermission(function(e){"granted"===e?(s.success("webpush.request.granted"),t(l)):(s.success("webpush.request.denied"),n(r))})});if("granted"===Notification.permission)return Promise.resolve(l)}return Promise.reject(r)}().then(m).then(y).then(function(e){return"messages"!==i&&(T(!0),Notification&&(t=o["notification.enabled.title"],n=o["notification.enabled.body"],r=OK.cnst.staticUrl+"res/i/html5_notif_icon.png",new Notification(t,{body:n,icon:r,tag:"messenger-enabled"}))),s.success("webpush."+i+".subscribe"),k(p,e,i,!0);var t,n,r},function(){s.error("webpush."+i+".subscribe")})}):Promise.reject("Module is disabled")},unsubscribe:v,getStatus:S}});
