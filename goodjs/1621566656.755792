define("OK/feedback/Settings",["OK/utils/utils","OK/utils/dom"],(function(e,t){function n(e){this.element=e,this.count=parseInt(e.getAttribute("data-count"),10)}function i(e,n){var i=0===(e.count=n),o=t.firstByClass(e.element,"js-empty");o&&o.classList.toggle("invisible",!i),a.setGroupsIsEmpty(i),t.firstByClass(e.element,"sc-menu_h").classList.toggle("invisible",i),t.firstByClass(e.element,"feedback_settings_cnt").classList.toggle("invisible",i)}function o(t){var n=this;t.preventDefault(),require(["OK/feedback/FeedbackLayerController"],(function(t){var i=t.getNextUnreadTime();t.hideLabel(),e.ajax({url:n.getAttribute("data-href"),data:{"st.f.let":i}}).done((function(n,i,o){t.reset(o),e.updateBlockModelCallback(n,i,o)}))}))}function s(e){this.element=e,this.parent=t.parent(this.element,"js-deleteAll")}function r(e){this.element=e}var a,l,c;return n.prototype.activate=function(){i(this,this.count)},n.prototype.add=function(n){var o=OK.util.nextId(),s=this;this.remove(n),e.ajax({url:"/dk?cmd=FeedbackGroup",data:{"st.b.gId":n,"st.b.cId":o}}).done((function(e){i(s,s.count+1);var n=t.firstByClass(s.element,"js-list");n.insertAdjacentHTML("afterBegin",e),OK.hookModel.captureBlockHook(OK.hookModel.getNearestBlockHookId(n),n.firstChild)}))},n.prototype.remove=function(e){var n=document.getElementById("feedbackGroup"+e);n&&(t.remove(n),i(this,this.count-1))},s.prototype.activate=function(){this.element.addEventListener("click",o),a.setMenuIsEmpty(this.parent.classList.contains("invisible"))},s.prototype.deactivate=function(){this.element.removeEventListener("click",o)},s.prototype.show=function(){this.parent.classList.remove("invisible"),a.setMenuIsEmpty(!1)},s.prototype.hide=function(){this.parent.classList.add("invisible"),a.setMenuIsEmpty(!0)},r.prototype={setGroupsIsEmpty:function(e){this.groupsIsEmpty=e,this.toggleStub()},setMenuIsEmpty:function(e){this.menuIsEmpty=e,this.toggleStub()},toggleStub:function(){t.firstByClass(this.element,"js-empty").classList.toggle("invisible",!this.groupsIsEmpty||!this.menuIsEmpty)}},{activate:function(e){a=new r(e)},list:function(e){(l=new n(e)).activate()},showDeleteAllButton:function(){c&&c.show()},initDeleteButton:function(e){(c=new s(e)).activate()},addGroup:function(e){if(l){var t=e.getAttribute("data-gid");l.add(t)}},removeGroup:function(e){if(l){var t=e.getAttribute("data-gid");l.remove(t)}},getDeleteAllButton:function(){return c}}})),define("OK/HookModel",["OK/utils/utils"],(function(e){var t={},n=e.deferred();return{init:function(e){n.resolve(e)},hookActivated:function(e){var n,i,o=t[e],s=new Promise((function(t,o){var s=OK.hookModel.getHookById(e);s?t(s.getInstance?s.getInstance():void 0):(n=t,i=o)}));return n&&i&&(s.resolve=n,s.reject=i,o&&o.length||(o=[],t[e]=o),o.push(s)),s},removeObserver:function(e,n){var i=t[n];if(i&&i.length){var o=i.indexOf(e);-1!=o&&i.splice(o,1)}},activatedCallback:function(e,n){var i=t[e];i&&(delete t[e],i.forEach((function(e){e.resolve(n)})))},extractHookId:function(e){return e.substring(e.lastIndexOf("_")+1)},createHook:function(e,t){return n.promise.then((function(n){n.createHook(e,t)}))}}})),define("OK/feedback/ListController",["OK/utils/utils","OK/utils/dom","jquery","OK/logger","OK/feedback/Settings","OK/HookModel"],(function(e,t,n,i,o,s){var r=function(e,t,i,o){var s=this;this.layer=e,this.el=t,this.element=n(t),this.pageSize=o,this.loaded=n.Deferred(),this.empty=!0,this.scrollController=i,this.latest=void 0,this.element.on("click",".js-expand",l.bind(this)).on("click",".js-reply",(function(e){s.toggleReply(function(e){return n(e.target).closest(".notif")}(e)),e.preventDefault(),e.stopPropagation()})).on("click",".comments_text_more",c.bind(this))};function a(t,s,r){var a={url:"/dk",data:n.extend({cmd:"FeedbackLayerContent"},s),beforeSend:r},l=n.Deferred(),c=e.ajax(a,(function(){i.success("feedbackLayer","load.redirect")}),7);return c.always(t.layer.hideProgress.bind(t.layer)),c.done((function(e,n,i){var s=i.getResponseHeader("Last-Time-Micros"),r=i.getResponseHeader("Last-Access-Time-Micros");if("true"===i.getResponseHeader("Inconsistent"))l.reject(i);else{if(r&&(t.lastAccessTime=parseInt(r,10)),s&&(t.lastTime=parseInt(s,10),require(["OK/feedback/FeedbackLayerController"],(function(e){e.markAsRead(t.lastTime)}))),!(t.empty="true"===i.getResponseHeader("Block-Empty"))){o.showDeleteAllButton();var a=i.getResponseHeader("firstelem");a&&(t.marker=a)}clearTimeout(i.showProcess),t.layer.hideError(),l.resolve(e,n,i)}})),c.fail((function(e){l.reject(e)})),l.fail((function(e){clearTimeout(e.showProcess)})),l}function l(t){var i=this,o=n(t.target),s=o.closest(".notif").data("href");o.closest(".notif_w").each((function(n,r){r.expanded?(r.expanded=!1,r.classList.remove("__expanded"),t.target.getAttribute("data-scroll")&&(i.scrollController.scrollTop(r.listScrollTop),delete r.listScrollTop)):(r.listScrollTop=i.scrollController.element.scrollTop,r.expanded=!0,r.loaded?r.classList.add("__expanded"):(r.loaded=!0,e.ajax({url:s}).done((function(t,n,i){e.updateBlockModelCallback(t,n,i),r.classList.add("__expanded")})).fail((function(){r.loaded=!1,o.removeClass("__active")}))))})),t.preventDefault()}function c(e){require(["OK/discussions/Reveal"],(function(t){n(e.target).closest(".comments_current_cnt").each((function(){t.expand(this)}))}))}return r.prototype={getListContainer:function(){return t.firstByClass(this.el,"js-feedback-list")},load:function(t,n){var o=this,s=Math.max(5,n||Math.floor(window.innerHeight/85));a(o,{"st.f.ps":s},(function(e){e.showProcess=setTimeout(o.layer.showProgress.bind(o.layer,e),500)})).done((function(n,s,r){try{e.updateBlockModelCallback(r.responseText,s,r),i.success("feedbackLayer","load.empty",0===n.length)}catch(e){i.error("feedbackLayer","load.insert")}o.loaded.resolve();var a="true"===r.getResponseHeader("Has-Unread");t.resolve(o.lastTime,o.empty,a)})).fail((function(e,t,n){o.layer.showError(),i.error("feedbackLayer","load.fail"),i.clob("error",JSON.stringify({textStatus:t,errorThrown:n}),"feedbackLayer","load.fail")}))},isEmpty:function(){return this.empty},update:function(e,t){var o=this;return"resolved"!==o.loaded.state()||this.isEmpty()?this.load(e):o.loaded.done((function(){var r=t.getCount();if(r>o.pageSize)return o.load(e,o.pageSize),e;var l=o.getLatest(),c={"st.firstelem":o.marker,"st.fwd":"off","st.f.ps":o.pageSize,"st.f.lat":o.lastAccessTime||(isNaN(o.lastTime)?void 0:o.lastTime),"st.f.fio":l?l.options:void 0,fetch:!0};a(o,c).done((function(t,a,l){var c=parseInt(l.getResponseHeader("Last-Time-Micros"),10),d="true"===l.getResponseHeader("Block-Empty");if(isNaN(c))return e.resolve(o.lastTime,d),void i.clob("error",JSON.stringify({marker:o.marker,countToLoad:r,loaded:n(".notif",o.element).length}),"feedbackLayer","update.null");try{var u=o.getListContainer(),f=n(u),h=OK.hookModel.getNearestBlockHookId(u),p=document.createElement("div");p.innerHTML=t,i.success("feedbackLayer","update.empty",0===t.length);for(var m=Array.prototype.slice.call(p.childNodes),v=m.length-1;v>=0;v--){var g=m[v];g.getAttribute("id");f.prepend(g),o.scrollController.scroll(g.clientHeight),s.createHook(h,g)}}catch(e){throw i.error("feedbackLayer","update.insert"),i.clob("error",e.stack,"feedbackLayer","update.insert"),e}e.resolve(o.lastTime,d)})).fail((function(){i.error("feedbackLayer","update.fail")}))})),e},getLatest:function(){for(var e=this.latest;e&&e.isHidden();)e=e.next;return e},markAllAsRead:function(){this.layer.controller.unreadItemsCount=0,n(".feedback_seen",this.element).remove(),this.forEach((function(e){e.markAsRead(),e.deleted&&e.toggle(!1)})),void 0===this.latest&&(this.empty=!0,this.load(n.Deferred()))},getItemById:function(e){return n("[data-id="+e+"]",this.element)},toggleReply:function(t){var i=this;n(t).each((function(o,s){s.reply?(s.reply=!1,s.classList.remove("__reply"),delete i.activeForm):(s.reply=!0,s.form||(s.form=function(t,i){var o=n.Deferred(),s=n(".js-reply",i).data("href"),a=e.ajax({url:s}).done((function(t,n,i){e.updateBlockModelCallback(t,n,i)}));return require(["OK/feedback/FeedbackDiscussion"],(function(e){a.done((function(){var s=r.prototype.toggleReply.bind(t,i),a=i.getElementsByClassName("comment_status")[0],l=new e(t.layer,n(".comment-form",i),a,s);l.init(),o.resolve(l)}))})),o}(i,s)),s.form.done((function(e){i.activeForm&&i.toggleReply(i.activeForm),i.activeForm=t,s.classList.add("__reply"),e.form.focus()})))}))},addItem:function(e){if(void 0===this.latest)this.latest=e;else{var t=this.latest;if(e.compareTo(t)>0)e.next=t,this.latest=e;else{for(;t.next&&e.compareTo(t)<0;)t=t.next;t.next=e}}},removeItem:function(e){e.prev?(e.prev.next=e.next,e.next.prev=e.prev):(this.latest=e.next,e.next&&(e.next.prev=void 0))},forEach:function(e){for(var t=this.latest;t;){if(!e.call(t,t))return;t=t.next}},getItems:function(){var e=[];return this.forEach((function(t){e.push(t)})),e}},r})),define("OK/feedback/FeedbackLayer",["jquery","OK/utils/utils","OK/utils/vanilla","OK/feedback/ListController","OK/NewsFetchCoordinator","OK/ToolbarGrowl","OK/discussions/ScrollController","OK/logger","OK/utils/dom"],(function(e,t,n,i,o,s,r,a,l){function c(e){e!==OK.historyManager.getState()&&OK.historyManager.pushState(e)}function d(t,n){var s=this;this.controller=n,this.el=t,this.element=e(t);var a=document.getElementById("hook_Block_FeedbackLayerContent"),c=t.getElementsByClassName("notifs_lst")[0];this.scroller=new r({scrollingContainer:c,stickyContainer:e()}),this.list=new i(this,a,this.scroller,this.element.attr("data-pagesize"),n),this.label=e(".js-newTip",this.element),this.initialized=e.Deferred(),this.opened=!1,this.inProgress=!1,this.scrollTop=0,this.header=l.firstByClass(this.el,"toolbar-layer_h"),this.banner=document.getElementById("hook_Block_FeedbackLayerBanner"),this.bannerLoading=!1,o.addBlock("FeedbackGrowl"),this.element.on("click",".js-reload",(function(){s.list.load(s.initialized)}))}return d.prototype={toggle:function(){this.opened?this.hide():this.open()},open:function(t){var n=e.Deferred();try{var i=this;this.opened=!0,this.lastState=OK.historyManager.getState();var o=this.hide.bind(this,this);if(OK.loader.use("OKCustomJs",(function(){OK.Layers.unregisterAll(),OK.Layers.register("feedback",o)})),c("/marks"),this.element.removeClass("invisible"),OK.loader.use("OKCustomJs",(function(){OK.Layers.onLayerShown()})),s.destroyByLayerId("feedback"),n.done((function(){i.element.triggerHandler("show",t)})),this.inProgress||this.isInitialized())return this.banner&&!this.bannerLoading&&(this.bannerLoading=!0,this.loadBanner().then((function(){i.bannerLoading=!1}),(function(){i.bannerLoading=!1}))),n.resolve(),n.promise();this.inProgress=!0;var r=e.Deferred().done((function(e,t,o){n.resolve(),t||i.initialized.resolve(e,t,o)})).always((function(){i.inProgress=!1}));return this.list.load(r),this.initialized.done((function(e,n,o){i.toggleHeader(o),t&&t.resolve(e)})),n.promise()}catch(e){return this.showError(),a.error("feedbackLayer","open"),a.clob("error",e.stack,"feedbackLayer","open"),n.reject().promise()}},loadBanner:function(){return n.ajax({url:"/dk?cmd=FeedbackLayerBanner"}).then(n.updateBlockModelCallback)},hide:function(){this.opened&&(this.opened=!1,OK.loader.use("OKCustomJs",(function(){OK.Layers.remove("feedback"),OK.Layers.onLayerHidden()})),c(this.lastState&&0===this.lastState.indexOf("/marks")?"/":this.lastState),this.scrollTop=this.list.scrollController.element.scrollTop,this.element.addClass("invisible"),this.element.triggerHandler("hide"),this.list.markAllAsRead(),this.toggleHeader(!1),this.banner&&OK.hookModel.setHookContent("FeedbackLayerBanner",""))},on:function(e,t){return this.element.on(e,t),this},off:function(e,t){return this.element.off(e,t),this},isOpened:function(){return this.opened},isInitialized:function(){return"resolved"===this.initialized.state()},focusItem:function(t){var n=this;this.list.getItemById(t).each((function(){n.scroller.scrollToCenter(this),e(".js-reply",this).each(n.list.toggleReply.bind(n.list,this))}))},showProgress:function(){var e=this.el.getElementsByClassName("notifs_wrap");Array.prototype.slice.call(e).forEach((function(e){e.classList.add("__process")}))},hideProgress:function(){var e=this.el.getElementsByClassName("notifs_wrap");Array.prototype.slice.call(e).forEach((function(e){e.classList.remove("__process")}))},showError:function(){var e=document.getElementById("feedbackErrorStub");e&&e.classList.remove("invisible")},hideError:function(){var e=document.getElementById("feedbackErrorStub");e&&e.classList.add("invisible")},applyConf:function(t){e(".toolbar-layer",this.element).toggleClass("__unavailable",!t.enabled)},toggleHeader:function(e){this.header.classList.toggle("__has-unread",!0===e)}},d})),define("OK/feedback/FeedbackLayerController",["jquery","OK/feedback/FeedbackLayer","OK/logger","OK/utils/utils"],(function(e,t,n,i){var o=function(e,t){this.element=e,this.onClick=t.bind(this),this.visible=!1};function s(e){this.createTime=e.counter.counterCreateTime.timeMicros,this.lastEventTime=e.counter.lastEventTime?parseInt(e.counter.lastEventTime.timeMicros,10):void 0,this.count=e.counter.count,this.next=void 0}function r(e){this.capacity=e,this.queue=[]}o.prototype={show:function(){this.visible||(this.visible=!0,this.element.off("click.label").on("click.label",this.onClick),this.element.removeClass("__hidden").addClass("__active"))},hide:function(e){e&&this.element.addClass("__hidden"),this.element.removeClass("__active"),this.element.off("click.label",this.onClick),this.visible=!1}},s.prototype={isLater:function(e){return this.createTime>e.createTime},getCount:function(){return Math.max(this.count,this.next?this.next.getCount():0)},process:function(t,i){var s=this;if(this.lastEventTime)try{var r=parseInt(this.lastEventTime,10);if(this.count>0&&r>t){var l=a.list.scrollController,c=l.scrollToTop.bind(l,(function(t){e(this.element).animate({scrollTop:this.element.scrollTop+t},700)})),d=function(e,t){u.hide(!0),a.off("show",d),a.list.update(i,s).done(c),t&&i.done(t.resolve.bind(t))},u=new o(a.label,(function(){a.off("show",d);var e=a.list.update(i,s);e.done(this.hide.bind(this,!0)),e.done(c)}));a.list.isEmpty()?a.isOpened()?a.list.update(i,s):a.on("show",d):(u.show(),a.on("show",d))}else i.resolve(t)}catch(e){i.resolve(t),n.error("feedbackLayer","processNotification"),n.clob("error",e.stack,"feedbackLayer","processNotification")}else i.resolve(t)}},r.prototype={offer:function(e){if(0!==e.length&&this.size()!==this.capacity){var t=e.shift();try{var i=this.queue[this.size()-1];(this.isEmpty()||t.isLater(i)&&t.count!=i.count)&&(!this.isEmpty()&&(i.next=t),!h&&(h=t.lastEventTime),this.queue.push(t))}catch(e){n.error("feedbackLayer","offer"),n.clob("error",e.stack,"feedbackLayer","offer")}return this.offer(e)}},size:function(){return this.queue.length},isEmpty:function(){return 0===this.size()},poll:function(){return this.queue.shift()},peek:function(){return this.queue[0]}};var a,l,c=new r(100),d={autoScroll:!1,devMode:!1,isEnabled:!0},u=0,f=0,h=void 0;return{unreadItemsCount:0,reset:function(e){if(c.queue=[],!(a.list.empty="true"===e.getResponseHeader("Block-Empty"))){var t=e.getResponseHeader("firstelem");t&&(a.list.marker=t)}},activate:function(e){a=new t(e,this),e.getAttribute("data-opened")&&this.open()},setNewContent:function(t){try{var i=JSON.parse(t),o=i.notifications,r=i.conf;if(r&&(d=r),d.devMode&&(console.log("Got notifications: ",o),console.log("Queue: ",c),console.log("Configuraton",d)),!o||0===o.length)return;var l=c.isEmpty();c.offer(e.map(o,(function(e){var t=new s(e);if(0===t.count)require(["OK/ToolbarGrowl"],(function(e){try{e.destroyByLayerId("feedback")}catch(t){n.error("feedbackLayer","destroyByLayerId"),n.clob("error",Function.prototype.toString(e),"feedbackLayer","destroyByLayerId")}}));else if(a&&a.isInitialized())return t}))),l&&function t(i,o){var s=e.Deferred();try{if(i.isEmpty())return h=void 0,s.resolve(o);i.peek().process(o||0,s)}catch(e){n.error("feedbackLayer","processNotifications"),n.clob("error",e.stack,"feedbackLayer","processNotifications")}return s.then((function(e,n,o,s){return i.poll(),f=e,a.toggleHeader(!n),t(i,e)}))}(c),a&&a.applyConf(d)}catch(e){n.error("feedbackLayer","setNewContent"),n.clob("error",e.stack,"feedbackLayer","setNewContent")}},toggle:function(){a&&a.toggle()},open:function(t){if(a){var n=e.Deferred();n.done((function(e){f=e,t&&a.focusItem(t)})),a.open(n)}},hide:function(){a&&a.hide()},on:function(e,t){return a&&a.on(e,t),this},off:function(e,t){return a&&a.off(e,t),this},isOpened:function(){return!!a&&a.isOpened()},bindButton:function(e){l=e},markAsRead:function(e){f=e,u=0,i.ajax({url:"/web-api/feedback/mark/"+e}).done((function(){l.updateCounter(0)}))},uncount:function(e){u+=e,l&&l.updateCounter(l.counter-u)},getUncountable:function(){return u},getLastEventTime:function(){return f},getNextUnreadTime:function(){return h},hideLabel:function(){a&&a.label.addClass("__hidden").removeClass("__active")},addItem:function(e){this.unreadItemsCount+=e.isUnread?1:0,a.list.addItem(e.bind(a))},removeItem:function(e){this.unreadItemsCount-=e.isUnread?1:0,a.list.removeItem(e)},forEach:function(e){a.list.forEach(e)},getList:function(){return a.list}}})),define("OK/feedback/FeedbackButton",["require","jquery","OK/feedback/FeedbackLayerController","OK/NewsFetchCoordinator"],(function(e){var t=e("jquery"),n=e("OK/feedback/FeedbackLayerController");e("OK/NewsFetchCoordinator");function i(e,n){this.hookId=e,this.el=n,this.element=t(n),this.toggleOn=o.bind(this,this,!0),this.toggleOff=o.bind(this,this,!1),this.lastTime=parseInt(this.element.attr("data-time"),10),this.counter=parseInt(this.element.attr("data-counter"),10)}function o(e,t){e.element.toggleClass("toolbar_nav_a__feedback__active",t)}function s(e,n){var i=Math.max(n,0);t(".counterText",e.element).text(i>99?"99+":i),t(".toolbar_nav_notif, .new-marker",e.element).toggleClass("invisible",0===i)}return i.prototype={activate:function(){s(this,this.counter-n.getUncountable()),n.bindButton(this),o(this,n.isOpened()),n.on("show",this.toggleOn).on("hide",this.toggleOff),this.element.on("click",(function(e){n.toggle(),e.stopPropagation()}))},deactivate:function(){this.element.off("click"),n.off("show",this.toggleOn).off("hide",this.toggleOff)},updateCounter:function(e,t){(t=t||1e3*Date.now())>this.lastTime&&(this.lastTime=t,s(this,e))},setNewContent:function(e){var n=t(e);parseInt(n.attr("data-time"),10)>this.lastTime&&OK.hookModel.setHookContent("HeaderTopNewFeedbackInToolbarWrapper",e)}},i})),define("OK/feedback/FeedbackDiscussion",["jquery","OK/Discussion","OK/discussions/CommentForm","OK/discussions/LinkAttachController","OK/utils/utils"],(function(e,t,n,i,o){var s=function(e,t,o,s){n.call(this,t,o,s),this.onCancelFn=e,this.linksController=new i(this.objectId,{isSmall:!0})};(s.prototype=Object.create(n.prototype)).constructor=s,s.prototype.onCancel=function(e){this.deactivate(!0),e.preventDefault()},s.prototype.focus=function(){n.prototype.focus.call(this),this.discussion.statusElement.classList.add("invisible")},s.prototype.deactivate=function(e){return n.prototype.deactivate.call(this,e),this.onCancelFn(),this};var r=function(e,n,i,s){var r=o.parseJson(document.getElementById(n.data("params")).innerHTML);t.call(this,n,n.data("id"),n.data("type"),0,r),this.layer=e,this.onCancel=s,this.statusElement=i};return(r.prototype=Object.create(t.prototype)).constructor=r,r.prototype.init=function(){var t=this.form=new s(this.onCancel,this.elements.commentArea,this,e.extend({},this.elements,{collapsable:!1}));return t.init(),t.changeState(n.states.cancelable),this},r.prototype.destroy=function(){this.form.destroy(),this.elements.container.off()},r.prototype.post=function(t,n){this.statusElement.classList.remove("invisible");var i=this.statusElement.getAttribute("id"),o=i.substring(i.lastIndexOf("_")+1);return OK.hookModel.setHookContent(o,n),this.updateCount(1),this.onCancel(),e.Deferred().resolve()},r.prototype.replyMode=function(){},r.prototype.editMode=function(e,t){},r})),define("OK/discussions/Reveal",["OK/utils/dom"],(function(e){return{expand:function(t){e.firstByClass(t,"comments_text").classList.remove("__reveal-2","__reveal-3"),e.firstByClass(t,"comments_text_more").classList.add("invisible")},activate:function(t){var n=e.firstByClass(t,"comments_text");if(n){var i=parseInt(n.getAttribute("data-max-lines"),10);if(!isNaN(i)){var o=e.firstByClass(t,"comments_text_more"),s=parseInt(window.getComputedStyle(n)["line-height"],10)||21;n.firstChild.clientHeight/s>i+1?o.classList.remove("invisible"):n.classList.remove("__reveal-2","__reveal-3")}}}}})),define("OK/feedback/FeedbackItem",["jquery","OK/discussions/Reveal","OK/utils/dom","OK/feedback/FeedbackLayerController","OK/utils/utils"],(function(e,t,n,i,o){function s(e,t,n){this.id=e,this.type=t,this.isGroup=n}function r(e,t){this.element=t,this.bound=o.deferred(),this.options=parseInt(t.getAttribute("data-options"),10),this.isUnread=!!this.options&&!(!0&this.options),this.next=void 0,this.prev=void 0}return s.fromElement=function(e){return new s(e.getAttribute("data-sid"),e.getAttribute("data-st"),null!==e.getAttribute("data-sig"))},s.prototype={equals:function(e){return this.id===e.id&&this.type===e.type&&this.isGroup===e.isGroup}},r.prototype={activate:function(e){t.activate(this.element),i.addItem(this)},deactivate:function(){n.remove(this.element),i.removeItem(this)},bind:function(e){return this.bound.resolve(e),this},remove:function(t){this.deleted=!0,e(t).offsetParent(".notif").addClass("__blur __deleted")},blur:function(e){var t=e.getElementsByClassName("notif_disabled_tx")[0],i=n.parent(e,"notif");t.clientHeight>e.clientHeight&&(i.style.height=n.innerHeight(t)),i.classList.add("__blur"),i.classList.remove("show-on-hover")},unblur:function(e){var t=n.parent(this.element,"notif");t.classList.remove("__blur"),t.classList.add("show-on-hover"),t.style.height="",this.element.classList.add("invisible")},toggle:function(e){return this.element.parentNode.classList.toggle("invisible",this.hidden=!e),this.bound.promise.then((function(e){e.scroller.trigger()})),e},isHidden:function(){return this.hidden},markAsRead:function(){this.options=1|this.options,this.isUnread=!1},getSubject:function(){return this.subject?this.subject:this.subject=s.fromElement(this.element)},getGroupId:function(){return this.groupId?this.groupId:this.groupId=this.element.getAttribute("data-gid")},getLatestActorId:function(){return this.actorId?this.actorId:this.actorId=this.element.getAttribute("data-aid")},getTime:function(){return this.time?this.time:this.time=new Date(parseInt(this.element.getAttribute("data-time"),10)/1e3)},compareTo:function(e){return(this.getTime()>e.getTime())-(this.getTime()<e.getTime())}},r})),define("OK/feedback/TotalLink",[],(function(e){var t={},n=function(e,t){this.element=t,this.hookId=e,this.key=t.getAttribute("data-key")};return n.prototype={activate:function(){var e=t[this.key];e||(e=t[this.key]=[]);for(var n=0;n<e.length;n++)OK.hookModel.setHookContent(e[n],this.element.innerHTML);e.push(this.hookId)},deactivate:function(){t[this.key].splice(t[this.key].indexOf(this.hookId),1)},setNewContent:function(e){this.element.innerHTML=e}},n})),define("OK/feedback/FeedbackActions",["OK/utils/dom","OK/feedback/FeedbackLayerController"],(function(e,t){function n(t,n){this.hookId=t,this.element=n,this.stack=[],this.notifElement=e.parent(this.element,"notif"),this.wrapper=e.parent(this.notifElement,"notif_w")}return n.prototype={activate:function(){},deactivate:function(){},setNewContent:function(e,n,i){var o=this;function s(e){i(),o.element.innerHTML=e,n()}var r=document.createElement("div");r.innerHTML=e;var a,l,c=OK.util.parseJSON(r.firstChild.innerHTML),d=c.currentAction,u=c.revert;(0===this.stack.length&&(this.expanded=this.wrapper.classList.contains("__expanded")),u)?this.stack.length>0&&(s(this.stack.pop()),0===this.stack.length&&function(e){var t=e.notifElement;t.classList.remove("__blur"),t.classList.add("show-on-hover"),e.expanded&&e.wrapper.classList.add("__expanded")}(o)):(this.stack.push(this.element.innerHTML),s(e),function(e){e.notifElement.classList.add("__blur"),e.notifElement.classList.remove("show-on-hover"),e.expanded&&e.wrapper.classList.remove("__expanded")}(o));"UNSUBSCRIBE"===d?a=function(e){return e.getSubject().equals(c.subject)}:"TURN_OFF_GROUP"===d?a=function(e){return e.getGroupId()&&e.getGroupId()===c.groupId}:"BLOCK"===d&&(a=function(e){return e.getLatestActorId()&&e.getLatestActorId()===c.latestActorId}),t.forEach((function(e){if(e.element.contains(o.element)){if("FORCE_DELETE"===d)return e.toggle(!1),!1;e.deleted=o.stack.length>0}else a&&a.call(this,e)&&(e.toggle(u),!u&&e.isUnread&&(l=(l||0)+1));return!0})),l&&l===t.unreadItemsCount&&t.getList().markAllAsRead()}},n})),define("OK/feedback/RestoreLink",["OK/utils/dom","OK/utils/utils"],(function(e,t){var n=function(e){var n=this.getAttribute("href")||this.getAttribute("data-href");t.ajax({url:n}).done((function(e,n,i){var o=parseInt(i.getResponseHeader("Last-Time-Micros"),10);t.updateBlockModelCallback(e,n,i),require(["OK/feedback/FeedbackLayerController"],(function(e){e.markAsRead(o)}))})),e.preventDefault()};return{activate:function(e){e.addEventListener("click",n)},deactivate:function(e){e.removeEventListener("click",n)}}})),define("b/feedback",["OK/feedback/FeedbackButton","OK/feedback/FeedbackDiscussion","OK/feedback/FeedbackLayer","OK/feedback/FeedbackLayerController","OK/feedback/FeedbackItem","OK/feedback/ListController","OK/feedback/Settings","OK/feedback/TotalLink","OK/feedback/FeedbackActions","OK/feedback/RestoreLink"],(function(){}));