define("OK/messages/BrowserNotifications",["PTS/messaging.client","OK/logger","OK/utils/dom","OK/utils/vanilla","OK/WebPush","OK/NotificationPermissionPopup"],function(s,o,a,t,c,e){"use strict";var u,l,d,g="notification_enabled_messenger",f="notification_enabled_messenger_pro",h="notification_enabled_messenger_pro_hidden_till",m="js-notifications-on",p="js-notifications-off",v="__hidden",y=[],b=!1,w=!1;function n(){return window.Notification&&"granted"===window.Notification.permission}function O(){return n()&&window.localStorage&&"0"!==window.localStorage.getItem(g)}function C(){return window.Notification&&"denied"===window.Notification.permission}function k(e,t,s){e&&e.classList.toggle("invisible",s),t&&t.classList.toggle("invisible",!s)}function K(){return OK.cnst.staticUrl+"res/i/html5_notif_icon.png"}function i(e,t,s,n,i){s=s||K();var r,a,n=new Notification(e,{body:t,icon:s,tag:n});return a=i,(r=n).onshow=function(){o.success("html5.ntf.shown"),setTimeout(r.close.bind(r),7e3)},r.onclose=function(){y.some(function(e,t){if(e===r)return y.splice(t,1),!0})},r.onclick=function(){o.success("html5.ntf.click"),a&&a.call()},y.push(n),n}function r(e,t){return k(e,t,O()),i(s["html5.notification.enabled.title"],s["html5.notification.enabled.body"],K(),"messenger-enabled")}function M(t,s){return localStorage&&Notification&&("default"===Notification.permission?Notification.requestPermission(function(e){"granted"===e?(o.success("html5.ntf.granted"),localStorage.setItem(g,"1"),c.subscribe("messages").then(function(e){w&&e===c.STATUS_SUBSCRIBED&&I(!0)},T),r(t,s)):"denied"===e&&o.success("html5.ntf.denied")}):"denied"===Notification.permission?b&&e.open(function(){"denied"!==Notification.permission&&M(t,s)}):(o.success("html5.ntf.enabled"),localStorage.setItem(g,"1"),c.subscribe("messages").then(function(e){w&&e===c.STATUS_SUBSCRIBED&&I(!0)},T),r(t,s)),0)}function L(e,t){return e.parentNode.getElementsByClassName(t)[0].parentNode}function T(){OK.fn.isDebug()&&console.error.apply(console,arguments)}function S(e){localStorage.setItem(f,"1"),e.classList.add(v)}function I(e){c.isEnabled()&&t.ajax({method:"POST",url:"/web-api/webpush/messages?enabled="+(e?"true":"false")})}return{activate:function(e){w="true"===e.getAttribute("data-web-push-extended-settings-enabled"),b="true"===e.getAttribute("data-web-push-interop-enabled");var t,s,n,i,r=L(e,m),e=L(e,p);!C()||b?(r.notifClickListener=(n=r,i=e,function(e){M(n,i),k(n,i,O()),e.stopPropagation(),e.preventDefault()}),e.notifClickListener=(t=r,s=e,function(e){window.localStorage&&window.localStorage.setItem(g,"0"),k(t,s,O()),e.stopPropagation(),e.preventDefault(),o.success("html5.ntf.disable"),w?I(!1):c.unsubscribe("messages").catch(T)}),k(r,e,O()),r.addEventListener("click",r.notifClickListener),e.addEventListener("click",e.notifClickListener)):(e=e,r.classList.add("invisible"),e.classList.add("invisible"))},deactivate:function(e){var t=L(e,m),e=L(e,p);t.notifClickListener&&(t.removeEventListener("click",t.notifClickListener),t.notifClickListener=null),e.notifClickListener&&(e.removeEventListener("click",e.notifClickListener),e.notifClickListener=null)},activatePro:function(n){var i,r;O()||window.localStorage&&"1"===window.localStorage.getItem(f)||function(){if(window.localStorage){var e=window.localStorage.getItem(h),t=new Date;if(e)return t<new Date(e)}}()||(w="true"===n.getAttribute("data-web-push-extended-settings-enabled"),b="true"===n.getAttribute("data-web-push-interop-enabled"),C()&&!b)||(u=a.firstByClass(n,"js-browser-notif-pro_enable"),l=a.firstByClass(n,"js-browser-notif-pro_delay"),d=a.firstByClass(n,"js-browser-notif-pro_close"),u.notifProClickListener=(r=n,function(e){var t=a.firstByClass(document,m),s=a.firstByClass(document,p);M(t=t&&t.parentNode,s=s&&s.parentNode),S(r)}),u.addEventListener("click",u.notifProClickListener),l&&(i=parseInt(l.getAttribute("data-delay"),10),l.notifProDelayListener=function(){var e,t,s;e=n,t=i,(s=new Date).setSeconds(s.getSeconds()+t),localStorage.setItem(h,s),e.classList.add(v)},l.addEventListener("click",l.notifProDelayListener)),d&&(d.notifProCloseListener=function(){S(n)},d.addEventListener("click",d.notifProCloseListener)),setTimeout(function(){n.classList.remove(v)},1e3))},deactivatePro:function(e){u&&u.notifProClickListener&&(u.removeEventListener("click",u.notifProClickListener),u.notifProClickListener=null,u=null),l&&l.notifProDelayListener&&(l.removeEventListener("click",l.notifProDelayListener),l.notifProDelayListener=null,u=null),d&&d.notifProCloseListener&&(d.removeEventListener("click",d.notifProCloseListener),d.notifProClickListener=null,d=null)},show:i,closeAll:function(){y.forEach(function(e){e.close()}),y=[]},isEnabled:O,isPermitionGranted:n,toggle:function(e){localStorage&&localStorage.setItem(g,e?"1":"0")}}}),define("OK/messages/WindowVisibility",[],function(){"use strict";var e="hasFocus"in document,t=!0,s=[];function n(e){e=e||window.event,t="focus"===e.type,s.forEach(function(e){t&&e.onWindowFocus&&e.onWindowFocus(),!t&&e.onWindowBlur&&e.onWindowBlur()})}return window.addEventListener("focus",n),window.addEventListener("blur",n),{hasFocus:function(){return e?document.hasFocus():t},addListener:function(e){s.push(e)},removeListener:function(e){e=s.indexOf(e);-1<e&&s.splice(e,1)}}}),define("OK/ToolbarGrowl",["OK/logger","OK/utils/dom"],function(i,t){"use strict";var n=function(){var e,t,s=document.createElement("bootstrap"),n={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(t in n)if(n.hasOwnProperty(t)&&void 0!==s.style[t]){e=n[t];break}return i.success("growl","transition",e),e}(),s=null,r={},e=document.getElementById("msg_toolbar_button"),a=!(!e||!e.getAttribute("data-growl-add-log")),o=!!document.querySelector(".js-msg-ok"),c=!!document.querySelector(".js-msg-tt");function u(e){return e&&parseInt(e.getAttribute("data-time"),10)||0}function l(e){return t.firstByClass(e,"growl_close")}function d(e){this.hookId=e,this.hidden=!0,this.stash=null}return d.showAny=function(){var e,t;if(!s)for(e in r)if(r.hasOwnProperty(e)&&(t=r[e]).hidden&&(t.show(),!t.hidden))break},d.hideAll=function(){s&&s.hide()},d.destroyByLayerId=function(e){e=r[e];e&&e.destroy()},d.getByLayerId=function(e){return r[e]},d.prototype={activate:function(e){this.hook=this.getContentHook(),this.layerId=e.getAttribute("data-layer"),this.exclusive="true"===e.getAttribute("data-exclusive"),this.priority=parseInt(e.getAttribute("data-priority"),10)||0,(r[this.layerId]=this).hook&&(this.elem=this.hook.element.firstChild,this.elem&&(this.activateGrowl(),this.id=this.elem.getAttribute("data-id"),this.time=u(this.elem))),this.show()},activateGrowl:function(){var e=l(this.elem);e&&e.addEventListener("click",this)},deactivateGrowl:function(){var e=l(this.elem);e&&e.removeEventListener("click",this)},show:function(){if(this.id&&function(){return!(OK.Layers&&OK.Layers.isAnyLayerOpened()||document.getElementById("CallApplication")||document.querySelector(".discovery-menu.with-search.__search-wide")||"appMain"===OK.getCurrentDesktopModelId())}.call(this)){if(s){if(this.priority<=s.priority)return;i.success("growl","replace",this.layerId),s.hide()}if(this.elem.classList.add("__active"),this.hidden=!1,s=this,i.success("growl","show","music_app"===this.layerId?this.layerId+"-"+this.id:this.layerId),"messages"===this.layerId&&a)return i.success("messagesLayer","growl",c?"tt":o?"ok":"unknown")}},hide:function(){this.elem&&(this.elem.classList.remove("__active"),this.hidden=!0,this===s&&(s=null))},destroy:function(){this.elem&&(this.deactivateGrowl(),this.hide(),this.id=null,this.time=null,this.elem=null)},setNewContent:function(e){var t,s=(s=e,(t=document.createElement("div")).innerHTML=s,t.children.length?t.children[0]:null);OK.Layers&&OK.Layers.isLayerOpened(this.layerId)?i.success("growl","ignore"):s?(t=s.getAttribute("data-id"),s=u(s),this.exclusive&&this.id&&this.id!==t||(this.id!==t||this.time!==s?this.hidden?this.setNewGrowl(e,t,s):(this.stash={html:e,id:t,time:s},this.elem.addEventListener(n,this,!1),this.destroy()):i.success("growl","equal",1))):(this.destroy(),d.showAny())},applyNewContent:function(){this.hidden=!0,null===this.stash?OK.hookModel.setHookContent(this.getContentHookId(),""):(this.setNewGrowl(this.stash.html,this.stash.id,this.stash.time),i.success("growl","replace"),this.stash=null)},setNewGrowl:function(e,t,s){var n;this.id!==t||this.time!==s?(n=this.getContentHook(),OK.hookModel.setHookContent(n.id,e),this.elem=n.element.firstChild,this.id=t,this.time=s,this.activateGrowl(),setTimeout(this.show.bind(this),30)):i.success("growl","equal",2)},handleEvent:function(e){var t=e.type;"click"===t?(this.time>this.crossTime&&(this.crossTime=this.time),this.destroy(),d.showAny()):t===n&&"opacity"===e.propertyName&&(e.target.removeEventListener(n,this),this.applyNewContent())},getContentHookId:function(){return this.hookId+"_Content"},getContentHook:function(){return this.hook||(this.hook=OK.hookModel.getHookById(this.getContentHookId())),this.hook}},d}),define("OK/messages/Helper",["OK/messages/WindowVisibility","OK/utils/dom","OK/ToolbarBubble","OK/ToolbarGrowl","OK/logger","OK/utils/vanilla"],function(e,s,r,i,a,o){"use strict";var n="ConversationsList",c=r.wrap("counter_ToolbarMessages"),u=!!document.getElementById("msg_toolbar_button").getAttribute("data-button-add-log");function l(){return r.create("counter_GroupMessages")}function t(){return document.getElementById("js-chats_type")}function d(){var e=t();return e?e.getAttribute("data-filterTab"):null}function g(){var e=t();return e?e.getAttribute("data-filterGroupId"):null}return{isLayerOpenedAndActive:function(){return this.isWindowHasFocus()&&this.isMessageLayerOpened()},isMessageLayerOpened:function(){return OK.Layers&&OK.Layers.isLayerOpened("messages")},isWindowHasFocus:function(){return e.hasFocus()},updateToolbarBubbleFromServer:function(e){if(e)try{var t,s=r.wrap("counter_ToolbarMessages"),n=s.getCount(),i=e.conv;n!=i&&(s.resolveCustomIcon(i,e.hasReply),require(["OK/messages/MessagesAlert"],function(e){e.updateUnread(i)})),"GROUP"!=d()||g()||(t=l())&&t.resolveCustomIcon(e.group),require.defined("OK/GroupMessagesBubbleEventBus")&&require("OK/GroupMessagesBubbleEventBus").triggerAllMessages(e.group)}catch(e){a.error("messagesLayer.error","helper_updateToolbarBubbleFromServer"),a.clob("error",e.stack,"messagesLayer","helper_updateToolbarBubbleFromServer")}},getFilterTab:d,getFilterGroupId:g,getFilterUnanswered:function(){var e=t();return e?e.getAttribute("data-filterUnanswered"):null},newMessageNotify:function(t){var s,e=c.getCount(),n=c.hasBubble();t?(e!==t.conv?(c.resolveCustomIcon(t.conv,t.hasReply),s=t.updateFaviconIfNeeded,u&&a.success("messagesLayer","bubble",s?"tt":"ok"),require(["OK/messages/MessagesAlert"],function(e){e.updateUnread(t.conv,s)}),e>t.conv&&(i.destroyByLayerId("messages"),t.showGrowlTT&&o.ajax({url:"/dk?cmd=MessagesGrowl"}).then(function(e){o.updateBlockModelCallback(e)}))):n||c.resolveCustomIcon(0,!1),(e=r.create("counter_UserMessages"))&&e.resolveCustomIcon(t.conv-t.group),(e=l())&&e.resolveCustomIcon(t.group)):n||c.resolveCustomIcon(0,!1)},getConvLastMsgId:function(e){var t=(t=OK.hookModel.getHookById(n))?t.element:document.getElementById("hook_Block_"+n);if(t){e=s.firstByClass(t,"js-lastMsg_"+e);if(e&&e.firstChild)return e.firstChild.getAttribute("data-id")}return null}}}),define("OK/messages/MessagesConfig",["OK/logger","OK/utils/utils"],function(n,t){"use strict";var i={initialConvCount:0,initialMsgCount:0,saveUnsentMessages:!1,ajaxRetryCount:3,ajaxTimeout:1e4,lastMsgSyncFix:!1,cacheTimeout:0,poorPasteClean:!1,addCardOnRestore:!1,focusSearchOnOpen:!1,messagesCountForReset:-1,messagesCountForDisablePush:-1,hideTimestampOnVideoStart:!1,sendDeliveredToClient:!1,historyFix:!1,searchTouch:!1,newTyping:!1,copyMsgText:!1,myUnreadLeftColumn:!1,typingShowTimeout:6e3,chatListDrafts:!1,fancyScroll:!1,convDeactivateEnabled:!1,convListDuplicatesFix:!1,allowedTags:"p, br, div, img.emoji, img.usmile, img[alt^='#u'][alt$='s#']",user:{id:0,isPlaySound:!1,isStar:!1,isSendOnCtrlEnter:!1},retrySend:{timeout:0,retriesCount:0,retryDelay:0,increaseBy:1e3},attachItemVersions:{},asyncUploadEnabled:!1,sendStickerAsAttach:!1};return{activate:function(s){var e=function(){var e=s&&s.innerHTML,t={};if(e)try{t=OK.util.parseJSON(e)}catch(e){n.error("messagesLayer.error","confParse")}return t}();return t.extendDeep(i,e),i},update:function(e){return t.extendDeep(i,e),i},get:function(){return i},toggleSendOnEnter:function(e){i.user.isSendOnCtrlEnter=!e}}}),define("OK/messages/SoundPlayer",[],function(){var i="messages.nmst",r=null,a=null;return{initAndPlay:function(e){var t,s,n;window.HTMLAudioElement?(t=e,null!=r&&t===a||(s=new Audio,e=(n=s).canPlayType("audio/mp3"),n=n.canPlayType("audio/wav"),(n="probably"===e?(OK.logging.logger.success(i,"mp3.pb"),".mp3"):"probably"===n?(OK.logging.logger.success(i,"wav.pb"),".wav"):"maybe"===e?(OK.logging.logger.success(i,"mp3.mb"),".mp3"):"maybe"===n?(OK.logging.logger.success(i,"wav.mb"),".wav"):(OK.logging.logger.success(i,"err"),null))&&(s.src=t+n,s.volume=0,s.play(),a=t,r=s)),r.pause(),r.src=r.src,r.volume=1,r.play(),OK.logging.logger.success("messages.pnms")):OK.logging.logger.success(i,"ns")}}}),define("OK/messages/MessagesPushController",["OK/logger","OK/NewsFetchCoordinator"],function(n,i){"use strict";var c="PRIVATE",r=[],u={count:0,privateConv:0,chatConv:0,privateMessages:0,chatMessages:0,updateMessagesTime:0,readMarksTime:0,typingStatusesTime:0};function a(e){return parseInt(e,10)||0}function o(e,t){return e+(e.length?":":"")+t}return{priority:{very_high:4,high:3,medium:2,low:1},activate:function(){i.addBlock("MPC")},register:function(t){return r.push(t),r.sort(function(e,t){return t.priority-e.priority}),function(){var e=r.indexOf(t);0<=e&&r.splice(e,1)}},applyNews:function(e){var s;e&&(s={},r.forEach(function(t){if(t.applyNews)if(t.dependsOn&&s.hasOwnProperty(t.dependsOn)&&!s[t.dependsOn])s[t.name]=!1;else try{s[t.name]=t.applyNews(e)}catch(e){s[t.name]=!1,n.error("messagesLayer","pushCtrl_"+t.name),n.clob("error",e.toString(),"messagesLayer","pushListener_applyNews")}}))},setNewContent:function(e){try{var t;e&&(t=OK.util.parseJSON(e))&&(function(t){var e=t.unreadCount;e&&e.time&&u.count&&e.time<=u.count&&(t.unreadCount=void 0);var s,n=t.updatedConversations;n&&(u.privateConv||u.chatConv)&&(s=[],Object.keys(n).forEach(function(e){var t=n[e];t.time&&t.time<=(t.type===c?u.privateConv:u.chatConv)&&s.push(e)}),s.forEach(function(e){delete t.updatedConversations[e]}));var i=t.newMessages;i&&(u.privateMessages||u.chatMessages)&&Object.keys(i).forEach(function(e){var t=i[e],s=[];t.forEach(function(e){e.time&&e.time<=(e.type===c?u.privateMessages:u.chatMessages)||s.push(e)}),i[e]=s});var r=t.updatedMessages;r&&u.updateMessagesTime&&Object.keys(r).forEach(function(e){var t=r[e],s=[];t.forEach(function(e){e.time&&e.time<=u.updateMessagesTime||s.push(e)}),r[e]=s});var a=t.readMarks;a&&u.readMarksTime&&Object.keys(a).forEach(function(e){var t=a[e].list,s=[];t.forEach(function(e){e.time&&e.time<=u.readMarksTime||s.push(e)}),a[e].list=s});var o=t.typingStatuses;o&&u.typingStatusesTime&&Object.keys(o).forEach(function(e){var t=o[e].list,s=[];t.forEach(function(e){e.time&&e.time<=u.typingStatusesTime||s.push(e)}),o[e].list=s})}(t),this.applyNews(t),function(e){var t=e.unreadCount;t&&t.time&&(s=a(t.time))>u.count&&(u.count=s);var s,n=e.checkTime;n&&(t="",(e=n.privateConvTime)&&(s=a(e))>u.privateConv&&(u.privateConv=s),t=o("",u.privateConv),(e=n.chatConvTime)&&(s=a(e))>u.chatConv&&(u.chatConv=s),t=o(t,u.chatConv),(e=n.privateMessagesTime)&&(s=a(e))>u.privateMessages&&(u.privateMessages=s),t=o(t,u.privateMessages),(e=n.chatMessagesTime)&&(s=a(e))>u.chatMessages&&(u.chatMessages=s),t=o(t,u.chatMessages),(e=n.updateMessagesTime)&&(s=a(e))>u.updateMessagesTime&&(u.updateMessagesTime=s),(e=n.readMarksTime)&&(s=a(e))>u.readMarksTime&&(u.readMarksTime=s),(n=n.typingStatusesTime)&&(s=a(n),u.typingStatusesTime=s),0<t.length&&i.updateParam("st.mpCheckTime",t))}(t))}catch(e){n.error("messagesLayer.error","pushSetNewCnt"),n.clob("error",e.stack,"messagesLayer","processPush")}},getCheckTime:function(){return u}}}),define("OK/messages/WindowTitleChanger",["PTS/messaging.client"],function(s){"use strict";var i,e=document.title;function r(e){document.title=e}function n(e){var t,s=arguments.length,n=0;i&&clearInterval(i),1<s?(t=arguments,i=setInterval(function(){r(t[n]),++n>=s&&(n=0)},700)):r(e)}return{setTitle:n,resetTitle:function(){n(e)},setNewMessagesTitle:function(e){var t=OK.util.plurals(e);n(e+" "+s["new.message.count."+t])}}}),define("OK/messages/MessagesAlert",["OK/messages/MessagesConfig","OK/messages/SoundPlayer","OK/messages/BrowserNotifications","OK/messages/MessagesPushController","OK/messages/WindowTitleChanger","OK/FaviconManager","PTS/messaging.client","OK/messages/Helper","OK/NewsFetchCoordinator","OK/logger"],function(s,t,a,n,e,i,r,o,c,u){"use strict";var l,d,g,f=!1,h=[];function m(){return s.get()}function p(){return OK.lss&&OK.lss.isMaster()}function v(){var e=performance.now();d&&e-d<3e3||(d=e,t.initAndPlay(OK.cnst.staticUrl+"res/default/sound/newMessageSound15"))}function y(){f||(0<l?e.setNewMessagesTitle(l):(i.removeFavicon(0),e.resetTitle()))}function b(){f=!0,i.registerFavicon(0),e.setTitle(r["new.message.title"],"* * * * * * * * * * * *"),g&&clearTimeout(g),g=setTimeout(function(){f=!1,y()},5e3)}function w(e,i){e.forEach(function(t){var s,n,e;s=t,n=Date.now(),(e=h.some(function(e,t){return 6e4<n-s.time&&h.splice(t,1),s.msgId===e.msgId}))||(s.time=n,h.push(s)),e?u.success("html5.ntf.filter"):a.show(t.title,t.body,t.icon,t.convId,function(){a.closeAll(),window.focus(),i?require(["OK/messages2/layer"],function(e){e&&e.open(t.url)}):require(["OK/messages/MessagesLayer"],function(e){e.open({conversationId:t.convId})})})})}return{activate:function(e){s.activate(e);var t=this;n.register({name:"alert",priority:n.priority.medium,dependsOn:"convMgt_newMsg",applyNews:function(e){return t.applyNews(e)}}),e=m(),l=e.initialConvCount,0<e.initialMsgCount&&0<l&&!e.user.isStar&&b()},applyNews:function(e){var t=e&&e.alerts;if(!t)return!1;var s,n,i=t.notifications,r=function(e){if(!o.isLayerOpenedAndActive())return!0;if(require.defined("OK/messages/ConversationsManager")){for(var t,s=require("OK/messages/ConversationsManager"),n=0;n<e.length;n++)if(!(t=s.getById(e[n]))||!t.selected)return!0;return!1}return!0}(t.subscribedConvIds),t=i&&i.length&&r;try{s=r,n=m().user,s=!s&&o.isLayerOpenedAndActive(),n.isPlaySound&&p()&&!s&&v()}catch(e){u.error("messagesLayer.error","playSound")}return t&&(l=e.unreadCount?e.unreadCount.conv:0,b()),0<(i=i).length&&!o.isWindowHasFocus()&&a.isEnabled()&&c.isMaster()&&w(i),!0},updateUnread:function(e,t){l=e,t&&0<l&&b(),y()},playSoundTT:function(){p()&&v()},showNotificationsTT:function(e){!o.isWindowHasFocus()&&a.isPermitionGranted()&&p()&&w(e,!0)},toggleSound:function(e){(m().user.isPlaySound=e)&&v()}}}),define("OK/messages/Timing",["OK/logger"],function(i){"use strict";var r="OK/messages2/timing",a=require.defined(r),o={};return{log:function(e){if(!o.hasOwnProperty(e)){var t;if("start"==e)t=performance.now();else{var s=o.start;if(!s)return void i.success("messagesLayer","loading.ok.error");t=performance.now()-s}o[e]=t,i.durationScalar("messagesLayer","loading.ok."+e,t),n=e,a&&require([r],function(e){e.log("flback-"+n)})}var n}}}),define("OK/messages/MessagesToggleButton",["OK/logger","OK/messages/Timing","OK/ToolbarBubble"],function(n,t,e){"use strict";var i=e.wrap("counter_ToolbarMessages");function s(e){var s=this;e.preventDefault(),e.stopPropagation(),t.log("start"),OK.loader.execRequire("OK/messages/MessagesLayer",function(e){var t;"msg_toolbar_button"!==s.id||e.isOpen()||(t=i.hasReply()?"reply":i.getCount(),n.success("messagesLayer","open",t)),e.toggle()})}return{activate:function(e){e.addEventListener("click",s)},deactivate:function(e){e.removeEventListener("click",s)}}}),define("OK/AttachPicker",["jquery","OK/utils/utils"],function(d,n){"use strict";var s,i={},c="localStorage"in window&&null!==window.localStorage,r={},g={},a="OK/messages2/app",o=d({});function u(e){return e&&0===e.indexOf("tt_")}function l(e,t){u(e)&&require.defined(a)&&require(a).attachesSelected({objectId:e,attaches:t})}function f(){}function h(e){var t;return f.get(e).supportsLs?JSON.parse(localStorage.getItem("AttachPicker."+e))||[]:((t=r[e])||(r[e]=t=[]),t)}function m(e,t){var s;f.get(e).supportsLs?(s="AttachPicker."+e,0==t.length?localStorage.removeItem(s):localStorage.setItem(s,JSON.stringify(t))):r[e]=t}function p(e){e.warningContainer.addClass("__active"),setTimeout(function(){e.warningContainer&&e.warningContainer.removeClass("__active")},3e3)}function v(t,e,s){var n,i,r,a,o=s&&s.files,c=o?s.files:h(t.objectId),u=JSON.stringify(c);o?s.callback&&(r=s.callback,s.callback=null,r(u),f.destroy(t.objectId)):(i=t,r=u,a=[],(n=c).forEach(function(e){var t;-1<i.separateUploadTypes.indexOf(e.type)&&((t=e.id)<0&&!g[t]&&(g[t]=i.serializeAttachesCb(e)),a.push(e))}),0<a.length&&(a.forEach(function(e){e=n.indexOf(e);-1<e&&n.splice(e,1)}),r=JSON.stringify(n)),u=r,t.button&&(c.length>=t.maxCount?t.button.removeClass("invisible"):t.button.addClass("invisible")),t.attachedInput&&0<t.attachedInput.length&&t.attachedInput.val(u),t.previewUrl&&require(["OK/AttachPreview"],function(e){e.update(t,u).done(function(){t.trigger("update")})}))}return f.serialize=function(e,t,s,n){e={type:t.toString(),id:e};return n?e.token=n:(!s&&0!=s||"PHOTOERROR"!==e.type||(e.error=s.toString()),"VIDEOERROR"===e.type&&(e.error=s?s.toString():"video_default")),e},f.addRecentGif=function(i,e){var t=e.attr("data-token");e[0].hasAttribute("data-close-smiles")&&OK.Layers.unregisterLast(),n.ajax({type:"POST",url:"/web-api/photo/upload/attach/fixToken",data:{tokenTemplate:t}}).done(function(e,t,s){var n;e&&(n=e.photoId,e=e.token,e=f.serialize(n,"RECENTGIF",void 0,e),f.add(i,[e]))})},f.get=function(e,t){var s=i[e];return s||(i[e]=s=d.extend(d({}),{_counter:0,objectId:e,maxCount:8,single:!1,supportsLs:c,warningContainer:d(),attachedInput:d(),place:null,sessions:{},activeSession:null,edited:!1,separateUploadTypes:[],serializeAttachesCb:function(){},sendUploadedAttachesCb:function(){}})),t&&s._counter++,s},f.startSession=function(e){var t=f.get(e);if(t.activeSession)return t.activeSession;var s=OK.util.nextId(),e={sessionId:s,previewContainer:t.previewContainer,files:null,callback:null,data:null};return t.sessions[s]=e,t.activeSession=e},f.detachSession=function(e,t,s){var n=f.get(e,!0).activeSession;return n.callback=t,n.files=h(e),n.data=s,f.clear(e),n},f.findSession=function(e,t){var s=f.get(e,!0);if(s.sessions)for(var n in s.sessions)if(s.sessions.hasOwnProperty(n)&&s.sessions[n].data===t)return s.sessions[n];return null},f.updatePreviewContainer=function(e,t){var s,n=f.get(e,!0),i=d(t);for(s in n.sessions)n.sessions.hasOwnProperty(s)&&(n.sessions[s].previewContainer=i)},f.getRemainingCount=function(e){return f.get(e).maxCount-h(e).length},f.getCount=function(e){return h(e).length||0},f.add=function(e,t,s){for(var n=f.get(e),i=h(e),r=0,a=0,o=0;o<t.length;++o){var c=t[o];0<=i.indexOf(c)||(n.single?(++a,i.length?i[0]=c:i.push(c)):i.length>=n.maxCount?++r:(++a,i.push(c)))}return m(e,i),!s&&0<r&&p(n),0<a&&v(n),0===r},f.isEdited=function(e){e=f.get(e);if(e)return e.edited},f.edit=function(e){e=f.get(e);e&&(e.edited=!0)},f.remove=function(s,e,t){if(t)return t.callback=null,delete f.get(s).sessions[t.sessionId],void o.triggerHandler("remove.session."+s,[t]);var n=h(s),i=e.split(":")[0].split("_"),r="null"===i[1];d.each(n,function(e,t){t&&t.type==i[0]&&(r||t.id==i[1])&&(n.splice(e,1),m(s,n),v(f.get(s)),o.triggerHandler("remove."+s,[i[0],i[1]]))})},f.removeMultiple=function(e,t,r){var a=h(e),s=a.length,o=[];t=t.replace(/&quot;/gi,'"'),(t=JSON.parse(t)).forEach(function(e){var s,n=e.split(":")[0].split("_"),i="null"===n[1];d.each(a,function(e,t){t&&t.type==n[0]&&(i||t.id==n[1])&&(s=a.splice(e,1),r&&o.push(s[0]))})}),a.length!=s&&(r&&f.saveUnsent(e,o),m(e,a),v(f.get(e)))},f.saveUnsent=function(e,t){s={objectId:e,ids:t}},f.restoreUnsent=function(){s&&(f.add(s.objectId,s.ids),s=null)},f.replace=function(r,e,t,s){for(var n=s&&s.files,a=n?s.files:h(r),i=0;i<e.length;i++){var o=e[i].id,c=e[i].type,u=t[i];d.each(a,function(e,t){if(t.type===c&&t.id===(-0===o?0:o))return n=u,i=r,(t=g[(s=t).id])&&(f.get(i).sendUploadedAttachesCb(t,n),delete g[s.id],1)?a.splice(e,1):a[e]=u,!1;var s,n,i})}var l=f.get(r);n?s.files=a:m(r,a),s&&delete l.sessions[s.sessionId],v(l,0,s)},f.clear=function(e){s=null;var t=f.get(e);t&&(t.activeSession=null,t.edited=!1),0!=h(e).length&&(m(e,[]),v(f.get(e)))},f.subscribe=function(e,t,s){o.on(t+"."+e,s)},f.unsubscribe=function(e,t,s){o.off(t+"."+e,s)},f.getFiles=h,f.callGifPaymentWizard=function(){n.ajax({url:"/dk?cmd=PopLayer",data:{"st.layer.cmd":"PopLayerPaymentWizardOuter","st.layer.srv":"46","st.layer.t2nd":"off","st.layer.redirect":"","st.layer.stJsCb":"attachGifCb"}}).done(function(e,t,s){n.updateBlockModelCallback(e,t,s)})},f.destroy=function(e){var t=i[e];if(t._counter--,t._counter<=0){if(t.button&&(t.button.off(),t.button.removeData(),t.button=null),t.previewContainer&&(t.previewContainer.off(),t.previewContainer.removeData(),t.previewContainer=null),t.warningContainer&&(t.warningContainer.off(),t.warningContainer.removeData(),t.warningContainer=null),t.attachedInput&&(t.attachedInput.off(),t.attachedInput.removeData(),t.attachedInput=null),t.sessions){for(var s in t.sessions)t.sessions.hasOwnProperty(s)&&delete t.sessions[s];t.sessions=null,t.activeSession=null}t.off(),i[t.objectId]=void 0}},f.prototype={activate:function(e){var t=d(e),s=this.objectId=t.data("object-id")||d(".js-chat").attr("data-object-id"),i=f.get(s,!0),n=t.data("preview-url");n&&(i.previewUrl=n,i.previewContainer=d("#"+t.data("preview-id"))),t.data("single")&&(i.single=!0);e=t.data("use-local-storage");i.supportsLs=c&&(void 0===e||e);e=t.data("attached-ids");e&&m(s,e),i.single||(r=t.data("max-count"))&&(i.maxCount=parseInt(r,10));e=t.attr("data-separate-types");e&&(i.separateUploadTypes=e.replace(/^\[/,"").replace(/]$/,"").split(","));var r=t.data("button-id");r&&(i.button=d("#"+r),i.button.click(function(e){return p(i),e.stopPropagation(),!1}));var a=t.attr("data-attach-type"),o="true"===t.attr("data-instant");i.warningContainer=i.warningContainer.add(".tipAttachPicker",t);e=d(".attachedInput",t);i.attachedInput=i.attachedInput.add(e);r=t.attr("data-place");r&&(i.place=r);r=d(".attachButton",t);0<r.length?r.click(function(){var e=u(s),n=[];t.find("input:hidden").each(function(){var t,s=this.value;s&&!isNaN(parseInt(s,10))&&(t=!1,n.every(function(e){return!e.id||!e.type||e.id!==s||e.type!==a||!(t=!0)}),t||(e?"MUSIC"===a?n.push({type:"MUSIC",trackId:Number(s),title:this.getAttribute("data-name"),artistName:this.getAttribute("data-artist"),imageUrl:this.getAttribute("data-cover"),duration:this.getAttribute("data-duration"),context:this.getAttribute("data-ctx")}):n.push({id:s,type:String(a),url:this.getAttribute("data-url"),previewUrl:this.getAttribute("data-preview"),width:this.getAttribute("data-width"),height:this.getAttribute("data-height")}):n.push(f.serialize(s,a))))}),o?i.trigger("instantSendAttaches",[n]):f.add(s,n),l(s,n),this.classList.add("__disabled")}):d(".attachInput",t).click(function(){var e=d(this),t=e.data("id");e.data("add")?"RECENTGIF"===a?f.addRecentGif(s,e):(e=this.querySelector("img"),u(s)?l(s,[{id:t,type:a,preview:e&&e.src,width:this.getAttribute("data-width"),height:this.getAttribute("data-height")}]):f.add(s,[f.serialize(t,a)])):f.remove(s,t)}),(n||e.length)&&0<h(s).length&&v(i)},deactivate:function(e){e=d(e);i[this.objectId],d(".attachButton, .attachInput",e).off("click"),e.removeData(),f.destroy(this.objectId)}},f}),define("OK/messages/UnsentMessages",["require","OK/utils/dom","OK/utils/utils","OK/logger","OK/AttachPicker"],function(e){"use strict";function a(){clearTimeout(t),t=setTimeout(function(){localStorage.setItem(s,JSON.stringify(l))},10)}function n(e){return e&&0===Object.keys(e).length&&e.constructor===Object}function i(){d.forEach(function(e){e.call()})}function o(e){return e=0===e.lastIndexOf("msg_found_",0)?e.substring(10):e}var t,m=e("OK/utils/dom"),c=e("OK/utils/utils"),p=e("OK/logger"),r=e("OK/AttachPicker"),e=m.firstByClass(document,"js-unsent-msg-marker"),s=e&&e.getAttribute("data-store-key"),e="localStorage"in window&&null!==window.localStorage,u=!!s&&e,l=u&&JSON.parse(localStorage.getItem(s))||{},d=[],g={},f=!1;return Object.keys(l).forEach(function(e){0===e.lastIndexOf("msg_found_",0)&&(delete l[e],p.success("messagesLayer","unsentFix"),f=!0)}),f&&a(),{registerAndCheck:function(e){u&&(d.push(e),this.hasUnsentMessages()&&e(l))},addMessage:function(e,t,s,n){var i,r;u&&(e=o(e),i={},(r={})[t]=s,i[e]=r,n?c.extendDeep(g,i):(c.extendDeep(g,i),c.extendDeep(l,i),a()))},removeAsync:function(e,t){var s;u&&(e=o(e),(s=g[e])&&(delete s[t],n(s)&&delete g[e]))},removeMessage:function(e,t){this.removeAsync(e,t);var s=l[e];s&&(delete s[t],n(s)&&(delete l[e],i())),a()},removeConv:function(e){u&&(g[e]&&delete g[e],l[e]&&(delete l[e],i()),a())},hasUnsentMessages:function(){return!n(l)&&(!!n(g)||Object.keys(l).some(function(e){if(g[e]){var t=l[e],s=g[e];return Object.keys(t).some(function(e){return!s[e]})}return!0}))},getUnsentMessages:function(e){return this.hasUnsentMessages()&&l[e]||{}},getAsyncMessages:function(e){return g[e]||{}},getUnsentConversations:function(){return Object.keys(l)},onAsycContinue:function(e,t,s){this.onSendRetry(e,t,"asyncUpload",function(){var e;s&&s.sessions&&0<Object.keys(s.sessions).length&&(e=r.findSession(s.objectId,t),r.remove(s.objectId,void 0,e))})},onSendRetry:function(e,t,s,n){var i=0;try{var r,a,o,c=this,u=e.getStubEl(t),l=function(){},d=function(e){a.classList.toggle("invisible",!e)},g=function(e){o.classList.toggle("invisible",!e),r.classList.toggle("invisible",e),u.classList.toggle("__error",!e)},f=function(){i=71,a=m.removeAllListeners(a),i=72,a.addEventListener("click",function(){i=73,l.call(),i=74,c.removeMessage(e.conversation.id,t),i=75,e.removeStub(t)}),i=76,d(!0)},h=function(){r=m.removeAllListeners(r),m.one(r,"click",function(){g(!0),n.call()})},i=1;if(!u)return;switch(i=2,r=m.firstByClass(u,"js-retry-button"),i=3,a=m.firstByClass(u,"js-stub-delete-button"),i=4,o=m.firstByClass(u,"js-retry-spinner"),i=5,s){case"onError":f();break;case"asyncUpload":l=n,f(),g(!0);break;case"autoRetry":i=6,l=n,i=7,f(),i=8,g(!0);break;case"manualRetry":i=9,h(),i=10,f(),g(!(i=11));break;case"onConvActivate":i=111,r&&!r.classList.contains("invisible")?(i=12,h(),i=13,f()):d(!(i=14))}}catch(e){p.success("messagesLayer","e.onSendRetry_"+i)}}}}),define("OK/messages/MessageDelivery",["require","OK/messages/MessagesPushController","OK/utils/utils","OK/logger","OK/messages/MessagesConfig"],function(e){"use strict";var t=e("OK/messages/MessagesPushController"),c=e("OK/utils/utils"),u=e("OK/logger"),l=e("OK/messages/MessagesConfig");return{activate:function(e){t.register({name:"sendDeliveredToClient",priority:t.priority.medium,dependsOn:"convMgt_newMsg",applyNews:function(e){if(!e)return!0;var t,s,n,i=e.updatedConversations,r=e.unreadCount?e.unreadCount.conv:0,a=0;if(!i||!r)return!0;try{var o=[];Object.keys(i).forEach(function(e){a=1,(t=i[e])&&t.groupId&&(a=2,o.push(e))}),o.length&&(a=3,s=o,(n=l.get()).sendDeliveredToClient&&c.ajax({url:"/web-api/messages/conversation/markAsDelivered",data:{cid:s},timeout:n.ajaxTimeout},n.ajaxRetryCount).fail(function(){u.error("messagesLayer.error","markAsDelivered")}))}catch(e){u.success("sendDeliveredToClient","e.send_"+a)}return!0}})}}}),define("OK/messages/MessagesToolbarButton",["module","OK/logger","OK/messages/MessagesToggleButton","OK/messages/MessagesPushController","OK/ToolbarBubble","OK/messages/Helper","OK/messages/UnsentMessages","OK/utils/dom","OK/utils/utils","OK/ToolbarGrowl","OK/messages/MessageDelivery"],function(e,t,s,n,i,r,a,o,c,u,l){"use strict";var d=i.wrap("counter_ToolbarMessages");return n.register({name:"toolbarBtn",priority:n.priority.medium,dependsOn:"convMgt_newMsg",applyNews:function(e){r.newMessageNotify(e.unreadCount)}}),{activate:function(e){s.activate(e),l.activate(e),a.registerAndCheck(function(){e.classList.toggle("__unsent-warn",a.hasUnsentMessages())}),"1"===e.getAttribute("data-growl")&&d.hasBubble()&&("1"===e.getAttribute("data-growl-add-log")&&t.success("messagesLayer","messageGrowlLoad","ok"),c.ajax({url:"/dk?cmd=MessagesGrowl"}).done(function(e,t,s){c.updateBlockModelCallback(e,t,s)})),"true"===e.getAttribute("data-ws")&&require(["OK/WSConnectionCheck"],function(e){e.check()})},deactivate:function(e){s.deactivate(e)}}}),define("b/messagesButton",["OK/messages/BrowserNotifications","OK/messages/Helper","OK/messages/MessagesAlert","OK/messages/MessagesConfig","OK/messages/MessagesPushController","OK/messages/MessagesToggleButton","OK/messages/MessagesToolbarButton","OK/messages/UnsentMessages","OK/messages/WindowTitleChanger","OK/messages/WindowVisibility","OK/messages/SoundPlayer","OK/messages/MessageDelivery","OK/messages/Timing"],{});
