!function(){var p,g,t,e,c,n,r,l,a;try{var u=window.$MicrosoftMaps8,_=u.Internal,s=u.BasicMapAnimation,h=(_._Binding,_._BoundsAccumulator,_._ComponentNames),m=_._Debug,o=(_._Dispatcher,_._Gimme),f=u.GlobalConfig,y=_._Helper,d=u.ImageryMapLayer,v=_._JSEvent,L=u.LocationRect,C=_._LoggerConstants,i=_._LruCache,M=_._MapAuthentication,w=(_.MapHelper,u.MapLayer,u.Location),b=u.MapMath,T=u.MapTypeId,x=u.MapView,S=u.Matrix2D,R=_._Network,V=(_._Observable,_._ObservableCollection,_._ObservableObjectChangedArgs,u.Point),I=(u.PooledImage,u.Rectangle),P=u.SimplePointPrimitive,D=u.Size,E=u.LabelVisibility,A=u.VectorMapLayer,B=_._VectorMath,F=u.ZoomLevel,O=_._Url,H=(_.PyramidTileSpatialIndex,u.PyramidTileId),k=_.RasterTileCache,z=_.RasterTile,U=(_._LatLonCrs,_.TileSystemHelper),Z=u.ResourceManager,W=this&&this.__extends||(a=function(t,e){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),j=(Et.constrainView=function(t,e){var i=!1,n=e.view;0!==e.cause&&3!==e.cause||(d=F.fromLocation(e.view.cameraLocation,!0),d=Math.floor(d),e.view.cameraLocation=F.toLocation(e.view.cameraLocation,d,!0));var a,o=t.getMode(),r=t.getViewport(),s=t.getViewportPadding(),l=o.getCurrentCrs(),h=(a=o.getTileSize()).height,d=a.width;return a="number"==typeof(a=t.getMapOptions().navigationOptions.minCameraAltitude)?Math.max(o.getMinAltitude(),a):o.getMinAltitude(),o=t.getMapOptions().maxBounds,(0===n.heading||l instanceof u.BirdseyeV2Crs)&&(i=(i=i||Et.enforceMinZoom(t,e.view))||Et._enforceMinAltitude(l,n,r,s,d,h,a),Et._checkConstrainBirdseyeV2View(t,l)&&t.getMapOptions().constrainBirdseyeView?i=i||Et.constrainBirdseyeV2LatLong(t,l,new D(r.pixelWidth,r.pixelHeight),n):(h=Et._enforceLatitudeBoundaries(n,new D(r.pixelWidth,r.pixelHeight),h,o),i=i||h,o&&(o=Et._enforceLongitudeBoundaries(n,new D(r.pixelWidth,r.pixelHeight),d,o),i=i||o))),i},Et.enforceMinZoom=function(t,e,i){var n=!1,a=t.getMode(),o=t.getViewport(),r=t.getViewportPadding(),s=a.getCurrentCrs(),l=a.getTileSize(),h=l.height,d=l.width,a=t.getMapOptions().navigationOptions.minZoomFraming,l=t.getMapOptions().navigationOptions.maxCameraAltitude,c=0,u=Math.ceil(B.log2(o.pixelWidth/d)),p=Math.ceil(B.log2(o.pixelHeight/h));switch(a){case 0:c=Math.max(u,p);break;case 1:c=u;break;case 2:c=p;break;case 3:c=Math.min(u,p);break;case-1:c=3}return Et._checkConstrainBirdseyeV2View(t,s)&&(a=s.sceneMetadata,c=Math.max(c,Et.getBirdseyeV2AdjustedZoom(e.cameraLocation,o,a,t.getMapOptions().constrainBirdseyeView,i))),i=F.toAltitude(new w(0,0),c,!0),i="number"==typeof l?Math.min(l,i):i,e.cameraLocation.altitude>i&&(Et._setCameraAltitude(s,e,o,r,d,h,i),n=!0),n},Et._enforceMinAltitude=function(t,e,i,n,a,o,r){var s=!1;return e.cameraLocation.altitude<r&&(Et._setCameraAltitude(t,e,i,n,a,o,r),s=!0),s},Et._setCameraAltitude=function(e,i,n,a,t,o,r){a=new V(a.left+(n.pixelWidth-a.left-a.right)/2,a.top+(n.pixelHeight-a.top-a.bottom)/2),n=new D(n.pixelWidth,n.pixelHeight);try{i.cameraLocation=tt.getCameraForLocationToPoint(e instanceof u.BirdseyeV2Crs?e:J.instance,t,o,n,0,i.cameraLocation,a,r,0)}catch(t){(o=u.logger)&&(r={feature:h.MapControl,action:C.Error,data:{errorMessage:"_setCameraAltitude exception: "+t.toString(),crs:e&&e.id||"",crsVersion:e&&e.version||"",viewportSize:"[Size ("+n.width+", "+n.height+")]",viewportCenter:a.toString(),location:i.cameraLocation.toString(),altitude:r}},o.logCriticalError(null,r,!1))}},Et._enforceLatitudeBoundaries=function(t,e,i,n){var a,o=F.fromLocation(t.cameraLocation,!0),o=Math.pow(2,o)*i;return n&&(a=J.instance.projectToY(n.getNorth(),0),o*=J.instance.projectToY(n.getSouth(),0)-a),a=n?n.center.latitude:0,e.height<o?t.cameraLocation.latitude>a?(o=n?n.getNorth():null,Et._enforceNorthernBoundary(t,e,i,o)):(n=n?n.getSouth():null,Et._enforceSouthernBoundary(t,e,i,n)):(t.cameraLocation.latitude=a,!0)},Et._enforceNorthernBoundary=function(t,e,i,n){var a=!1,o=F.fromLocation(t.cameraLocation,!0),i=e.height/2/(Math.pow(2,o)*i),i=J.instance.toLatitude(0,"number"==typeof n?i+J.instance.projectToY(n,0):i);return t.cameraLocation.latitude>i&&(t.cameraLocation.latitude=i,a=!0),a},Et._enforceSouthernBoundary=function(t,e,i,n){var a=!1,o=F.fromLocation(t.cameraLocation,!0),i=e.height/2/(Math.pow(2,o)*i),i=J.instance.toLatitude(0,"number"==typeof n?J.instance.projectToY(n,0)-i:1-i);return t.cameraLocation.latitude<i&&(t.cameraLocation.latitude=i,a=!0),a},Et._enforceLongitudeBoundaries=function(t,e,i,n){var a,o,r=!1;return n&&(o=F.fromLocation(t.cameraLocation,!0),a=Math.pow(2,o)*i*n.width/360,o=n.center.longitude,r=e.width<a?t.cameraLocation.longitude>o?Et._enforceEasternBoundary(t,e,i,n.getEast()):Et._enforceWesternBoundary(t,e,i,n.getWest()):(t.cameraLocation.longitude=o,!0)),r},Et._enforceEasternBoundary=function(t,e,i,n){var a=!1,o=F.fromLocation(t.cameraLocation,!0),i=e.width/2/(Math.pow(2,o)*i),i=J.instance.toLongitude(J.instance.projectToX(0,n)-i,0);return t.cameraLocation.longitude>i&&(t.cameraLocation.longitude=i,a=!0),a},Et._enforceWesternBoundary=function(t,e,i,n){var a=!1,o=F.fromLocation(t.cameraLocation,!0),i=e.width/2/(Math.pow(2,o)*i),i=J.instance.toLongitude(J.instance.projectToX(0,n)+i,0);return t.cameraLocation.longitude<i&&(t.cameraLocation.longitude=i,a=!0),a},Et._checkConstrainBirdseyeV2View=function(t,e){return t.getMapType().id===T.birdseyeV2&&e instanceof u.BirdseyeV2Crs&&!!e.sceneMetadata},Et.getBirdseyeV2AdjustedZoom=function(t,e,i,n,a,o){var r=F.fromLocation(t,!0),t=Et.getBirdseyeV2MinZoom(e,i,n),n=Math.pow(2,i.endingZoomLevel-t);return t=.36<e.pixelHeight*e.pixelWidth/(i.height/n*i.width/n)&&a&&(o||!(r<=i.endingZoomLevel&&t<=r))?Math.min(i.endingZoomLevel,t+1):t},Et.getBirdseyeV2MinZoom=function(t,e,i){var n=18;return e&&(i=i?Math.round:Math.ceil,t=Math.min(i(B.log2(e.width/t.pixelWidth)),i(B.log2(e.height/t.pixelHeight))),n=e.endingZoomLevel-t+1),n},Et.constrainBirdseyeV2LatLong=function(t,e,i,n){var a,o,r,s,l,h,d=!1;return e.sceneMetadata&&(a=e.sceneMetadata,s=F.fromLocation(n.cameraLocation,!0),o=e.projectToX(n.cameraLocation.latitude,n.cameraLocation.longitude),r=e.projectToY(n.cameraLocation.latitude,n.cameraLocation.longitude),l=i.width/(1024*Math.pow(2,s)),h=i.height/(1024*Math.pow(2,s)),s=(i=a.maxTileOffset/Math.pow(2,a.endingZoomLevel))+l,l=(a.maxTileOffset+a.width/512)/Math.pow(2,a.endingZoomLevel)-l,i=i+h,h=(a.maxTileOffset+a.height/512)/Math.pow(2,a.endingZoomLevel)-h,(o<s||l<o||r<i||h<r)&&(o=Math.min(Math.max(s,o),l),r=Math.min(Math.max(i,r),h),n.cameraLocation.latitude=e.toLatitude(o,r),n.cameraLocation.longitude=e.toLongitude(o,r),d=!0)),d},Et),N=(Dt.prototype.getRootElement=function(){return this._canvasElement},Dt.prototype.setPercentOpacity=function(t){t=100<t?100:t,this._canvasElement&&this._currentPercentOpacity!==t&&(this._currentPercentOpacity=t,this._canvasElement.set_style({opacity:t/100*this._currentOpacity}))},Dt.prototype.getOpacityPercentage=function(){return this._currentPercentOpacity},Dt.prototype.transformCanvas=function(t,e){var i;this._canvasElement&&(t="matrix("+(i=t.getValues())[0]+","+i[1]+","+i[2]+","+i[3]+","+i[4]+","+i[5]+")",this._canvasElement.set_style({"-webkit-transform":t,transform:t}),(e=e?"center center":"top left")!==this._currentTransformationOrigin&&(this._currentTransformationOrigin=e,this._canvasElement.set_style({"-webkit-transform-origin":e,"transform-origin":e})),this._currentTransformationValues=i)},Dt.prototype.copyCanvas=function(t,e){var i,n;this._currentTransformationValues&&(i=this._canvasDrawingContext.getSize(),n=t.getDevicePixelRatio()/this._canvasDrawingContext.getDevicePixelRatio(),t.drawImage(this._canvasElement[0],this._currentTransformationValues[4],this._currentTransformationValues[5],i.width*(e?1:this._currentTransformationValues[0])*n,i.height*(e?1:this._currentTransformationValues[3])*n))},Dt.prototype.clear=function(){this._canvasDrawingContext&&this._canvasDrawingContext.clear()},Dt.prototype.dispose=function(){this._isDisposed=!0,y._disposeEvents(this),y._clearDisposables(this._disposables),y._nullifyClass(this)},Dt.prototype._setupCanvas=function(t){this._canvasElement&&(this._canvasElement.set_style({zIndex:this.zIndex,position:"absolute",left:"0px",opacity:this._currentOpacity,"-webkit-transform-origin":this._currentTransformationOrigin,"transform-origin":this._currentTransformationOrigin}),this._canvasElement.set_attr("Id",this._canvasId),t?this._parentElement.append(this._canvasElement):this._parentElement.fadeIn(this._canvasElement,q.fadingAnimationDuration,null,!!this._imageryMapLayer&&this._imageryMapLayer.isBaseLayer))},Dt.prototype._createCanvas=function(){this._canvasFactory&&!this._canvasElement&&(this._disposables.push(this._canvasDrawingContext=this._canvasFactory({devicePixelRatio:this._dpr})),this._canvasElement=this._canvasDrawingContext.getRootElement())},Dt),q=(Pt.containsCustomOverlay=function(){Pt.hasCustomOverlay=!0},Pt.prototype.onPrimitiveRenderingStart=function(){var i=this;this._initialViewport=this._compositeMapMode.getCurrentCrsViewport(),this._sortedRenderers.forEach(function(t){t.setPercentOpacity(100),t.transformCanvas(S.identity)}),this._animationCanvasStoryBoard&&this._animationCanvasStoryBoard.seek(1),0<this._currentOpacity&&(this._animationCanvasStoryBoard=o.Effects.Storyboard.create([this._animationDrawingContext.getRootElement()],{value:this._currentOpacity},{value:0},function(t,e){t.set_style({opacity:e.value}),i._currentOpacity=e.value,0===e.value&&(i._animationCanvasStoryBoard=null)},300*this._currentOpacity,null,function(){i._animationCanvasStoryBoard=null,i._currentOpacity=0},function(t){return t}),this._animationCanvasStoryBoard.begin())},Pt.prototype.clear=function(){this._animationDrawingContext.clear(this._getBackgroundColor())},Pt.prototype.dispose=function(){y._clearDisposables(this._disposables),y._disposeEvents(this),y._nullifyClass(this)},Pt.prototype._initialize=function(t){var e,i=this;this._disposables.push(this._animationDrawingContext=t()),t=this._animationDrawingContext.getRootElement(),this._currentOpacity=1,t.set_style({zIndex:Pt._zIndexDuringAnimation,position:"absolute"}),e=this._compositeMapMode.getRootElement(),t.appendTo(e),e.set_style({"background-color":this._getBackgroundColor()}),this._disposables.push(this._map.mapTypeChanged.add(function(){e.set_style({"background-color":i._getBackgroundColor()})})),this._disableHachHackSetFrame?this._disposables.push(this._map.viewChanged.add(function(){return i._onViewChanged()},!0)):(this._disposables.push(this._map.mapPanStopped.add(function(){return i._onPanningStop()},!0)),this._disposables.push(this._map.viewChanged.add(function(){return i._onViewChanged()}))),this._disposables.push(this._map.mapPanStarted.add(function(){return i._onPanningStart()})),this._disposables.push(this._map.mapZoomStarted.add(function(){return i._isInPanning=!1})),this._disposables.push(this._map.viewChanging.add(function(t){return i._onViewChanging(t)})),this._map.frameManagerLoaded.addOne(function(){i._onFrameManagerLoaded(i._map.getFrameManager())},!1,!0)},Pt.prototype._onFrameManagerLoaded=function(e){var i=this;this._previousMapview=this._map.getView(),this._disposables.push(e.frameRendered.add(function(){i._onFrameRendered()})),this._disposables.push(e.frameFailed.add(function(t){5===t.reason&&i._onFrameRendered()})),this._disposables.push(e.onDisabled.add(function(){i._disabled=!0,i.clear(),i._onFrameDisabled();var t=i._map.getSizeHelper().resize.add(function(){return i._onFrameDisabled()});i._disposables.push(e.frameSet.addOne(function(){i._disabled=!1,t.dispose()}))}))},Pt.prototype._onFrameDisabled=function(){var t;this._map&&(this._currentOpacity=1,t=this._map.getActualSize(),this._animationDrawingContext.getRootElement().set_style({zIndex:25e3,opacity:1,width:t.width,height:t.height,"background-color":this._getBackgroundColor()}))},Pt.prototype._onFrameRendered=function(){var t,e,i,n;this._initialViewport=this._compositeMapMode.getCurrentCrsViewport(),this.isInAnimation=!1,this._updateCurrentCritialLayer()&&(n=this._map.getViewport(),t=this._map.getView(),e={pixelHeight:n.pixelHeight*Pt._viewportSizeRatioForBackgroundTiles,pixelWidth:n.pixelWidth*Pt._viewportSizeRatioForBackgroundTiles,crs:n.crs,bounds:null},i=[],0<(n=Math.floor(F.fromLocation(t.cameraLocation,!0))-Pt._zoomLevelDifferenceForBackgroundTiles)&&i.push(new x(F.toLocation(t.cameraLocation,n,!0))),Pt._highestZoomLevelBackgroundTiles<n&&i.push(new x(F.toLocation(t.cameraLocation,n=Pt._highestZoomLevelBackgroundTiles,!0))),0<i.length&&this._currentCriticalLayer.refreshBackgroundTiles(e,i))},Pt.prototype._onAnimationStart=function(){var t;this._animationStartMapView=this._map.getView(),this._animationCanvasStoryBoard&&this._animationCanvasStoryBoard.abort(),this._currentOpacity=1,t=this._map.getActualSize(),this._animationDrawingContext.setSize(t.width,t.height),this._animationDrawingContext.getRootElement().set_style({opacity:1,zIndex:Pt._zIndexDuringAnimation}),this.clear(),t=this._map.getLabelController(),this._labelController=t&&t.getIsLabelsSupported()?t:null,this.isInAnimation=!0,this._labelController&&this._labelController.SetAnimationState(this.isInAnimation),this._previousViewport=null,this._updateCurrentCritialLayer()},Pt.prototype._updateCurrentCritialLayer=function(){for(var t,e=this._map.getAllLayers(),i=0;i<e.length;i++)if((t=e[i]).isCritical&&t instanceof d)return this._currentCriticalLayer=t,!0;return!1},Pt.prototype._onAnimationStop=function(){var t,e,i=this;this.isInAnimation=!1,this._labelController&&this._labelController.SetAnimationState(this.isInAnimation),t=this._animationDrawingContext.getRootElement(),this._currentOpacity=1,0!==this._currentRotation&&(this._animationDrawingContext.save(),e=this._animationDrawingContext.getSize(),this._animationDrawingContext.translate(e.width/2,e.height/2),this._animationDrawingContext.getRawContext().rotate(this._currentRotation),this._animationDrawingContext.translate(e.width/-2,e.height/-2)),this._sortedRenderers.forEach(function(t){var e;(!Pt.hasCustomOverlay||t instanceof X&&t.getLayer().isBaseLayer)&&((e=t.getOpacityPercentage())<100?0<e&&(i._animationDrawingContext.setGlobalAlpha(e),t.copyCanvas(i._animationDrawingContext),i._animationDrawingContext.setGlobalAlpha(1)):t.copyCanvas(i._animationDrawingContext,0!==i._currentRotation))}),0!==this._currentRotation&&this._animationDrawingContext.restore(),this._previousMapview=this._map.getView(),Pt.hasCustomOverlay||this._labelController&&this._labelController.copyCanvas(this._animationDrawingContext),t.set_style({zIndex:Pt.hasCustomOverlay?0:25e3,opacity:this._currentOpacity})},Pt.prototype._getBackgroundColor=function(){return this._map.getMapOptions().backgroundColor||this._map.getMapType().backgroundTileColor},Pt.prototype._adjustCrsViewport=function(t,e){var i,n,a;this._animationStartMapView&&(i=t.cameraLocation.longitude-this._animationStartMapView.cameraLocation.longitude,a=(n=e.bounds)[1]-this._initialViewport.bounds[1],e=(t=e.crs.bounds[1]-e.crs.bounds[3])/2,0<i?a<-e&&(n[1]+=t,n[3]+=t):e<a&&(n[1]-=t,n[3]-=t))},Pt.prototype._render=function(){var t,e,i,n;if(this.isInAnimation){var a,o=this._map.getViewport(),r=this._map.getView(),s=void 0;if(!o.areEqual(this._previousViewport)||!x.areEqual(r,this._previousMapview)){for(this._currentRotation=(this._previousMapview.heading-r.heading)*Math.PI/180,a=this._compositeMapMode.getCurrentCrsViewport(),this._isInPanning&&this._adjustCrsViewport(r,a),t=(s=this._currentTransformationMatrixInCrs=0===this._currentRotation?this._initialViewport.transform(a):S.identity.rotate(this._currentRotation)).getValues()[0],this._previousViewport=o,e=0;e<this._sortedRenderers.length;e++)i=this._sortedRenderers[e],1<t&&i instanceof Y&&i.setPercentOpacity(100*(n=(n=3/t)<.125?0:n)),0<i.getOpacityPercentage()&&i.transformCanvas(s,0!==this._currentRotation);0===this._currentRotation?this._renderBackgroundTiles():this.clear(),this._labelController&&this._labelController.renderLabels(a,!0),this.onPaint.invoke({viewport:a,transformationMatrix:s,percentComplete:1})}}},Pt.prototype._onViewChanging=function(){this._disabled||(this._initialViewport&&!this.isInAnimation&&this._onAnimationStart(),this._render())},Pt.prototype._renderBackgroundTiles=function(){var l,h,d,t,e,c,u,p,g,_,m,f=this,i=this._currentCriticalLayer&&this._currentCriticalLayer.getCurrentCrs();i&&(l=this._map.getViewport(),h=this._currentTransformationMatrixInCrs.transform({x:0,y:0}),d=this._currentTransformationMatrixInCrs.transform({x:l.pixelWidth,y:l.pixelHeight}),this._isInside(0,0,h.x,h.y,d.x,d.y)&&this._isInside(l.pixelWidth,l.pixelHeight,h.x,h.y,d.x,d.y)||(e=(t=this._map.getView()).cameraLocation,c=new V(i.projectToX(e.latitude,e.longitude),i.projectToY(e.latitude,e.longitude)),u=Math.floor(l.pixelWidth/2),p=Math.floor(l.pixelHeight/2),g=F.fromLocation(e,!0),_=this._currentCriticalLayer.getTileSize(),m=window.devicePixelRatio||1,this._currentCriticalLayer.getAllTilesForAnimation(l,t,this._isInPanning,function(t){var e,i,n,a,o,r,s;f._animationDrawingContext&&(e=t.tileRegion,i=t.requestedRegion,s=g-i.zoom,a=Math.pow(2,s),n=Math.round(_*a),o=Math.pow(2,i.zoom),r=Math.round(n*o*c.x),s=Math.round(n*o*c.y),a=i.x*n-r+u,o=i.y*n-s+p,s=(r=f._doOverlap(0,0,l.pixelWidth,l.pixelHeight,a,o,a+n,o+n))&&f._isInside(a,o,h.x,h.y,d.x,d.y)&&f._isInside(a+n,o+n,h.x,h.y,d.x,d.y),r&&!s&&(t.image?i.zoom===e.zoom?f._animationDrawingContext.drawImage(t.image.image,a,o,n*m,n*m):(s=Math.pow(2,e.zoom-i.zoom),f._animationDrawingContext.drawImage(t.image.image,a,o,n*m,n*m,null,(i.x*s-e.x)*_,(i.y*s-e.y)*_,s=_*s*m,s)):f._animationDrawingContext.clear(null,a,o,n*m,n*m)))})))},Pt.prototype._isInside=function(t,e,i,n,a,o){return i<=t&&t<=a&&n<=e&&e<=o},Pt.prototype._doOverlap=function(t,e,i,n,a,o,r,s){return!(r<t||i<a)&&!(s<e||n<o)},Pt.prototype._onPanningStart=function(){var t,e,i;for(this._isInPanning=!0,t=this._map.getAllLayers(),e=0;e<t.length;e++)if((i=t[e]).isCritical){this._currentCriticalLayer=i;break}},Pt.prototype._onPanningStop=function(){this.isInAnimation&&!this._disabled&&(this._isInPanning=!1,this._currentCriticalLayer=null,this._onAnimationStop())},Pt.prototype._onViewChanged=function(){this._disabled||(this._disableHachHackSetFrame?this.isInAnimation&&(this._isInPanning=!1,this._currentCriticalLayer=null,this._onAnimationStop()):this.isInAnimation&&!this._isInPanning&&this._onAnimationStop())},Pt.fadingAnimationDuration=300,Pt._zIndexDuringAnimation=-1,Pt._highestZoomLevelBackgroundTiles=3,Pt._zoomLevelDifferenceForBackgroundTiles=4,Pt._viewportSizeRatioForBackgroundTiles=.2,Pt),Y=(W(It,l=N),It.prototype.updateVectorLayers=function(t){this._sortedVectorLayers=t},It.prototype.setTemplateSelector=function(t){this._templateSelector=t},It.prototype.render=function(t,e){return this._setupRender(t,e),this._hitTestingData=null,this._renderInternal(t,!1)},It.prototype.partialRender=function(t,e,i){var n,a,o,r,s,l,h;if(i&&0<(a=(n=Object.keys(i)).length))for(this._setupRender(t,e),this._createCanvasOnDemand(t),o=this._canvasDrawingContext,r=0;r<a;r++)s=parseInt(n[r]),(l=this._sortedVectorLayers[s])&&((h=l.getTemplateSelector()||this._templateSelector)&&(o.setLayer(l),this._renderPrimitives(i[s],o,h,!1,!1)))},It.prototype._setupRender=function(t,e){this._currentRegion=e,this._renderedPrimitivesCount=0,this._totalCoordinatesCount=this._generalizedCoordinatesCount=0},It.prototype.performHitTesting=function(t,e){this._hitTestingCanvasDrawingContext&&0<this._renderedPrimitivesCount&&(this._hitTestingData||(this._hitTestingCanvasDrawingContext.setSize(this._currentRegion.pixelWidth,this._currentRegion.pixelHeight),this._hitTestingCanvasDrawingContext.clear(),this._renderInternal(null,!0),this._hitTestingData=this._hitTestingCanvasDrawingContext.getHitTestingData()),this._hitTestingData.setResultToArgs(e.x,e.y,t))},It.prototype._renderInternal=function(t,e){for(var i,n,a,o,r,s=e?this._hitTestingCanvasDrawingContext:this._canvasDrawingContext,l=this._vectorEntitiesGL(),h={},d={},c={},u=[],p=0,g=0;g<this._sortedVectorLayers.length;g++)if((a=(i=this._sortedVectorLayers[g]).getFrameManager())&&0<(n=a.getFrameData().getPrimitives(1,!1)).length){if(e||(this._createCanvasOnDemand(t),s=this._canvasDrawingContext),!(a=i.getTemplateSelector()||this._templateSelector))continue;if(s&&s.setLayer(i),o=this._renderPrimitives(n,s,a,e,l),!e){if(d[g]=n,0<o.unhandled.length)h[g]=o.unhandled;else{for(r in o.vectorEntities)o.vectorEntities.hasOwnProperty(r)&&(c[r]=o.vectorEntities[r]);u.push.apply(u,o.atlasRecords)}p+=n.length}}return m.enableFunctionalTestHooks&&!e&&m.logVectorRenderingData(this._renderedPrimitivesCount,this._revisionNumber,this._totalCoordinatesCount,this._generalizedCoordinatesCount),s&&(0!==p||e?s.flush():s.clear()),0<Object.keys(h).length?d:this._drawTemplateRenderingResults(d,u,c,e)},It.prototype._renderPrimitives=function(t,e,i,n,a){for(var o,r,s,l={},h=[],d=[],c=0;c<t.length;c++)if(o=t[c],r=i.getTemplates(o,1)){if(a&&!n&&_._MicroPoiEntity&&o.entity instanceof _._MicroPoiEntity){(s=this._renderIconTemplates(this._currentRegion,e,o,r))&&(h.push(s),this._renderedPrimitivesCount++);continue}if(!(s=a&&(f.glPolyline&&2===o.geometryType||f.glVec&&3===o.geometryType)&&!n)&&!e){d.push(o);break}if(!this._renderVectorTemplates(o,r,n,e,s,l)){d.push(o);break}}return{atlasRecords:h,vectorEntities:l,unhandled:d}},It.prototype._renderVectorTemplates=function(t,e,i,n,a,o){for(var r,s,l,h,d,c="function"==typeof t.isRouteSelected&&t.isRouteSelected(),u=t.id?t.id+(c?"_s":""):y._nextId().toString(),p=0;p<e.length;p++)if(r=e[p]){if(s=r.getIsHitTestable(),!i||s)if(n&&n.setPrimitive(t),a)if(l=u+"_"+r.id,this._isCached(l))o[l]=null;else{if(h=r.render(null,t,this._currentRegion,a,void 0,m.TileLogTag),!this._isStyleSupported(h))return!1;if(c)for(d=0;d<h.length;d++)h[d].glPriority=2;o[l]=h}else n&&r.render(n,t,this._currentRegion,a,void 0,m.TileLogTag);!i&&s&&(this._renderedPrimitivesCount++,this._revisionNumber++)}return!0},It.prototype._renderIconTemplates=function(){return null},It.prototype._isCached=function(){return!1},It.prototype._drawTemplateRenderingResults=function(){return null},It.prototype._isStyleSupported=function(){return!0},It.prototype._vectorEntitiesGL=function(){return!1},It.prototype._prepareCanvas=function(t){var e,i;t&&this._renderedFrameNumber!==t.frameNumber&&(e=this._canvasDrawingContext.getSize(),i=new D(t.viewport.pixelWidth,t.viewport.pixelHeight),e.width===i.width&&e.height===i.height||this._canvasDrawingContext.setSize(i.width,i.height),this._canvasDrawingContext.clear(),this._renderedFrameNumber=t.frameNumber)},It.prototype._createCanvasOnDemand=function(t){this._createAndSetupCanvas(),this._prepareCanvas(t)},It.prototype._createAndSetupCanvas=function(){this._canvasElement||(this._createCanvas(),this._setupCanvas(!0))},It._vectorCanvasId="vectorCanvas",It),X=(W(Vt,r=N),Vt.prototype.getLayer=function(){return this._layer},Vt.prototype.render=function(t){var e,i,n,a=this,o=this._layer.getLastViewChangeFrameNumber(),r=this._layer.getCurrentScene();if(this._renderedFrameNumber!==o&&r){if(this._calculateScreenSpaceCenter(t,r),this.resetCanvas(t),e=this._layer.getPercentComplete(),i=this._layer.getAvailableRasterTiles(),this._tileDownloadedHandler&&this._tileDownloadedHandler.dispose(),i)for(n=0;n<i.length;n++)this._renderTiles(i[n]);this.onCritialRenderingCompleted.invoke({frame:t}),e<100?this._tileDownloadedHandler=this._layer.tileDownloaded.add(function(t){a._renderTiles(t),100===a._layer.getPercentComplete()&&(a._renderedFrameNumber=o,a._tileDownloadedHandler.dispose())}):this._renderedFrameNumber=o}else r||this.resetCanvas(t),this.onCritialRenderingCompleted.invoke({frame:t})},Vt.prototype.dispose=function(){this._tileDownloadedHandler&&this._tileDownloadedHandler.dispose(),r.prototype.dispose.call(this)},Vt.prototype._onLayerChanged=function(t){var e=t.name;"opacity"===e?this._canvasDrawingContext.getRootElement().set_style({opacity:t.newValue}):"zIndex"===e&&this._canvasDrawingContext.getRootElement().set_style({zIndex:t.newValue})},Vt.prototype._renderTiles=function(t){var e,i,n,a,o,r,s,l;t&&(e=t.requestedRegion,i=t.tileRegion,n=e.x*this._scaledTileWidth-this._centerX,a=e.y*this._scaledTileHeight-this._centerY,r=(o=this._layer.getCurrentScene()).getSecondaryTile&&o.getSecondaryTile(),s=e.pixelWidth,l=e.pixelHeight,t.image?o&&e&&r&&("number"==typeof e.imageryWidth||"number"==typeof e.imageryHeight)?(s=e.imageryWidth||e.pixelWidth,l=e.imageryHeight||e.pixelHeight,this._canvasDrawingContext.drawImage(r,n,a,e.pixelWidth,e.pixelHeight),this._canvasDrawingContext.drawImage(t.image.image,n,a,s,l,null,0,0,s,l)):i.zoom===e.zoom?this._canvasDrawingContext.drawImage(t.image.image,n,a,s,l):(o=Math.pow(2,i.zoom-e.zoom),r=e.pixelWidth*o*this._devicePixelRatio,this._canvasDrawingContext.drawImage(t.image.image,n,a,s,l,null,(e.x*o-i.x)*s,(e.y*o-i.y)*l,r,r)):this._canvasDrawingContext.clear(null,n,a,s,l),this._coreConfig.displayTileBoundary&&this._displayTileBoundaries(n,a,e,t.image))},Vt.prototype._displayTileBoundaries=function(t,e,i,n){var a=this._canvasDrawingContext.getRawContext();a.save(),a.lineWidth=1,a.strokeStyle="black",a.setLineDash([1,5]),a.strokeRect(t+.5,e+.5,i.pixelWidth-1,i.pixelHeight-1),a.font="12px Segoe UI",a.strokeStyle="white",a.lineWidth=3,a.setLineDash([]),a.strokeText(i.zoom+"-"+i.quadKey,t+16,e+16),a.fillStyle="red",a.fillText(i.zoom+"-"+i.quadKey,t+16,e+16),"undefined"!=typeof FunctionalTestHooks&&FunctionalTestHooks.displayTileInfo(a,n,t,e),a.restore()},Vt.prototype.resetCanvas=function(t){var e;this._canvasDrawingContext.restore(),e=this._canvasDrawingContext.getSize(),t=new D(t.viewport.pixelWidth,t.viewport.pixelHeight),e.width===t.width&&e.height===t.height||this._canvasDrawingContext.setSize(t.width,t.height),this._canvasDrawingContext.save(),this._canvasDrawingContext.clear(),e=Math.floor(t.width/2),t=Math.floor(t.height/2),this._canvasDrawingContext.translate(e,t)},Vt.prototype._calculateScreenSpaceCenter=function(t,e){var i=this._layer.getCurrentCrs(),n=t.view.cameraLocation,a=Math.log(this._devicePixelRatio)/Math.log(2),t=this._layer.getTileSize(),e=Math.floor(F.fromLocation(n,!0,e instanceof dt?void 0:t))+a,a=Math.pow(2,a);this._scaledTileWidth=Math.round(t/a),this._scaledTileHeight=this._scaledTileWidth,n=new V(i.projectToX(n.latitude,n.longitude),i.projectToY(n.latitude,n.longitude)),e=Math.pow(2,e),this._centerX=Math.round(this._scaledTileWidth*e*n.x),this._centerY=Math.round(this._scaledTileHeight*e*n.y)},Vt),G=(Rt.prototype.dispose=function(){this._baseImageRenderingCompletedHandler&&this._baseImageRenderingCompletedHandler.dispose(),y._clearDisposables(this._sortedRenderers),this._sortedCurrentVectorLayer.length=0,y._clearDisposables(this._disposables),this._layerRootElement=null,y._nullifyClass(this)},Rt.prototype._attachFrameManagerEvents=function(){var e=this,t=this._map.getFrameManager();this._disposables.push(t.frameSet.add(function(t){return e._onframeSet(t.frame)}),t.frameFailed.add(function(){return e._onframeFailed()}))},Rt.prototype._initialize=function(){var e=this,t=this._map.getAllLayers();this._disposables.push(t.changed.addThrottled(function(){return e._onlayerCollectionChanged()},5)),this._disposables.push(t.changed.add(function(){return e._onlayerCollectionChangeStarted()},!0)),this._map.frameManagerLoaded.addOne(function(){e._attachFrameManagerEvents()},!1,!0),this._layerRootElement=this._compositeMapMode.getRootElement(),this._onlayerCollectionChanged(),this._disposables.push(this._animator=new q(this._map,this._compositeMapMode,this._canvasDrawingContextFactory,this._sortedRenderers)),this._disposables.push(this._animator.onPaint.add(function(t){e._compositeMapMode.onPaint.invoke(t)})),this._map.labelControllerLoaded.addOne(function(){var t=e._map.getLabelController();e._disposables.push(t.onLabelsProcessed.add(function(t){return e._onLabelProcessed(t)}))},!1,!0)},Rt.prototype._onLabelProcessed=function(t){var e=this._map.getLabelController();this._lastLabelProcessedFrame=t.frameNumber,this._lastPrimitiveRenderFrame===this._lastLabelProcessedFrame&&(e.renderLabels(this._compositeMapMode.getCurrentCrsViewport(),!1),this._compositeMapMode.onPaint.invoke({viewport:t.viewport,percentComplete:1}))},Rt.prototype._onBaseImageryRendered=function(t){this._compositeMapMode.onFrameRendered.invoke(t),this._lastPrimitiveRenderFrame=t.frame.frameNumber,this._lastPrimitiveRenderFrame===this._lastLabelProcessedFrame&&(this._map.getLabelController().renderLabels(this._compositeMapMode.getCurrentCrsViewport(),!1),this._compositeMapMode.onPaint.invoke({viewport:t.frame.viewport,percentComplete:1}))},Rt.prototype._onframeFailed=function(){this._currentFrameNumber=-1},Rt.prototype._onframeSet=function(t){var e=this;this._animator&&!this._animator.isInAnimation&&(this._layerCollectionChangeStarted?this._pendingFrame=t:(this._pendingFrame=null,this._currentFrameNumber=t.frameNumber,this._minCriticalDataLoadedHandler&&this._minCriticalDataLoadedHandler.dispose(),this._baseImageryLayer&&this._baseImageryLayer.onCriticalDataLoaded().then(function(){e._onCritialImageryDataLoaded(t)})))},Rt.prototype._onCritialImageryDataLoaded=function(e){this._currentFrameNumber===e.frameNumber&&this._animator&&!this._animator.isInAnimation&&(this._sortedRenderers.forEach(function(t){t instanceof X&&t.render(e)}),this._startRenderVectorData(e),this._animator.onPrimitiveRenderingStart())},Rt.prototype._startRenderVectorData=function(n){var a,e=this;this._vectorLayerRenderer?(this._vectorLayerPendingFrame=null,a=[],this._sortedCurrentVectorLayer.forEach(function(t){var i,e=t.getTemplateSelector();e&&a.push(e.selectorReady()),!(i=t.getFrameManager())||(!(t=i.getFrameData())||t.frame&&t.frame.frameNumber!==n.frameNumber)&&a.push(new Promise(function(e){i.dataLoaded.addOne(function(t){t.frame.frameNumber===n.frameNumber&&e()})}))}),a.push(this._map.getTemplateSelector().then(function(t){return e._vectorLayerRenderer.setTemplateSelector(t),t.selectorReady()})),Promise.all(a).then(function(){e._finishRenderVectorData(n)})):this._vectorLayerPendingFrame=n},Rt.prototype._finishRenderVectorData=function(t){var e,i,n;this._currentFrameNumber===t.frameNumber&&((e=this._compositeMapMode.getCurrentCrsViewport()).zoom=this._map.getMercatorZoomLevel(),(i=this._vectorLayerRenderer.render(t,e))&&(this._hitTestController.removeComponent(this._vectorLayerRenderer),this._removeFromSorted(this._vectorLayerRenderer),Rt.disposeRenderer(this._vectorLayerRenderer),n=this._vectorLayerRenderer=new Y(this._map.getContainer(),this._canvasDrawingContextFactory,this._layerRootElement,this._sortedCurrentVectorLayer,null,null,!0),this._sortedRenderers.push(n),this._hitTestController.addComponent(n),this._sortRenderers(),n.partialRender(t,e,i)))},Rt.prototype._initializeLayer=function(e){function i(){a._sortedRenderers.push(a._vectorLayerRenderer),a._hitTestController.addComponent(a._vectorLayerRenderer),a._sortRenderers(),a._initializeVectorLayerRenderer(e),f.glVec&&a._vectorLayerPendingFrame&&a._startRenderVectorData(a._vectorLayerPendingFrame)}var t,n,a=this,o=e._internalId;this._layersEventHandlers[o]||(this._layersEventHandlers[o]=[],this._layersEventHandlers[o].push(e.changed.add(function(t){return a._onLayerChanged(t,e)})),(t=this._disposables).push.apply(t,this._layersEventHandlers[o])),e.getVisible()&&(!this._currentImageryLayers[o]&&e instanceof d?(n=new X(this._canvasDrawingContextFactory,this._layerRootElement,e,this._map.getDpiScale(),this._map.getConfig()),this._sortedRenderers.push(n),e.isCritical&&(this._previousBaseImageryLayer=this._baseImageryLayer,this._baseImageryLayer=e,this._hitTestController.updateTestRootElement(n.getRootElement()),this._baseImageRenderingCompletedHandler&&this._baseImageRenderingCompletedHandler.dispose(),this._baseImageRenderingCompletedHandler=n.onCritialRenderingCompleted.add(function(t){a._onBaseImageryRendered(t)})),this._currentImageryLayers[o]=e):!this._currentVectorLayers[o]&&e instanceof A&&(this._vectorLayerRenderer?this._initializeVectorLayerRenderer(e):(n=this._map.getContainer(),(f.glPolyline||f.glVec)&&f.isMapsVertical?(o=[{name:"VectorLayerRendererGL",args:{rootElement:this._layerRootElement,sortedVectorLayers:this._sortedCurrentVectorLayer}}],f.glVec&&(o.push({name:"PolygonSplit"}),o.push({name:"Triangulate"})),n.instanceAsyncAll(o,function(t){a._vectorLayerRenderer=t.VectorLayerRendererGL,f.glVec&&(a._vectorLayerRenderer.setTriangulate(t.Triangulate.triangulate),a._vectorLayerRenderer.setPolygonSplit(t.PolygonSplit.splitPolygonGroup)),i()})):(this._vectorLayerRenderer=new Y(n,this._canvasDrawingContextFactory,this._layerRootElement,this._sortedCurrentVectorLayer),i()))))},Rt.prototype._onlayerCollectionChangeStarted=function(){this._pendingFrame=null,this._layerCollectionChangeStarted=!0},Rt.prototype._onlayerCollectionChanged=function(){var t,e,i,n,a,o;for(this._layerCollectionChangeStarted=!1,t=this._map.getAllLayers(),(e=Object.keys(this._currentImageryLayers)).push.apply(e,Object.keys(this._currentVectorLayers)),n=!(i={}),o=0;o<t.length;o++)(1!==(a=t[o]).getRenderTarget()||a instanceof d)&&(this._initializeLayer(a),i[a._internalId]=n=!0);for(n&&this._sortRenderers(),o=0;o<e.length;o++)i[e[o]]||this._removeLayer(e[o],!0);this._pendingFrame&&this._onframeSet(this._pendingFrame)},Rt.prototype._onLayerChanged=function(t,e){var i=t.name;"visible"===i&&(e instanceof d||1!==e.getRenderTarget())?e.getVisible()?(this._initializeLayer(e),this._sortRenderers()):this._removeLayer(e._internalId,!1):e instanceof A&&("renderTarget"===i?1===t.oldValue&&1!==t.newValue?this._initializeVectorLayerRenderer(e):1!==t.oldValue&&1===t.newValue&&this._tryRemoveVectorLayerRenderer(e):"zIndex"===i&&this._sortAndUpdateVectorLayer())},Rt.prototype._initializeVectorLayerRenderer=function(t){1!==t.getRenderTarget()&&t.getVisible()&&(this._currentVectorLayers[t._internalId]=t,this._sortedCurrentVectorLayer.push(t),this._sortAndUpdateVectorLayer())},Rt.prototype._sortAndUpdateVectorLayer=function(){this._sortedCurrentVectorLayer.sort(function(t,e){return t.getZIndex()-e.getZIndex()}),this._vectorLayerRenderer&&this._vectorLayerRenderer.updateVectorLayers(this._sortedCurrentVectorLayer)},Rt.prototype._tryRemoveVectorLayerRenderer=function(t){var e=this._sortedCurrentVectorLayer.indexOf(t);-1<e&&this._sortedCurrentVectorLayer.splice(e,1),delete this._currentVectorLayers[t._internalId],0===this._sortedCurrentVectorLayer.length&&this._vectorLayerRenderer&&this._removeRenderer()},Rt.prototype._removeLayer=function(t,e){var i=this._currentImageryLayers[t]||this._currentVectorLayers[t];i&&(e&&(y._clearDisposables(this._layersEventHandlers[t]),delete this._layersEventHandlers[t]),i instanceof d?(this._removeRenderer(i),delete this._currentImageryLayers[t]):this._tryRemoveVectorLayerRenderer(i))},Rt.prototype._removeRenderer=function(e){var i,t,n,a;e?this._sortedRenderers.forEach(function(t){t instanceof X&&t.getLayer()===e&&(i=t)}):(this._hitTestController.removeComponent(this._vectorLayerRenderer),i=this._vectorLayerRenderer,this._vectorLayerRenderer=null),this._removeFromSorted(i),e&&e===this._previousBaseImageryLayer&&this._baseImageryLayer?(this._previousBaseImageryLayer=null,this._baseImageryLayer.onCriticalDataLoaded().then(function(){i.getRootElement().fadeOut(!0,q.fadingAnimationDuration,function(){i&&i.dispose()})})):(t=this._map.viewChanging.addOne(function(){Rt.disposeRenderer(i)}),n=function(){t.dispose(),Rt.disposeRenderer(i)},(a=i.getRootElement())?a.fadeOut(!0,q.fadingAnimationDuration,n):n())},Rt.prototype._sortRenderers=function(){this._sortedRenderers.sort(function(t,e){return t.zIndex-e.zIndex})},Rt.prototype._removeFromSorted=function(t){!t||-1<(t=this._sortedRenderers.indexOf(t))&&this._sortedRenderers.splice(t,1)},Rt.disposeRenderer=function(t){var e;t&&((e=t.getRootElement())&&e.removeFromParent(),t.dispose())},Rt),Q=(St.fromIProjectedRegionId=function(t){return new St(t.pixelWidth,t.pixelHeight,t.bounds,t.crs)},St.prototype.areEqual=function(t){return this===t||!!t&&(this.pixelHeight===t.pixelHeight&&this.pixelWidth===t.pixelWidth&&this.bounds[0]==t.bounds[0]&&this.bounds[1]==t.bounds[1]&&this.bounds[2]==t.bounds[2]&&this.bounds[3]==t.bounds[3]&&this.crs.id===t.crs.id&&this.crs.version===t.crs.version)},St.prototype.toCrs=function(){return 0<this.pixelWidth&&0<this.pixelHeight?new S((this.bounds[1]-this.bounds[3])/this.pixelWidth,0,0,(this.bounds[2]-this.bounds[0])/this.pixelHeight,this.bounds[3],this.bounds[0]):S.identity},St.prototype.fromCrs=function(){return this.toCrs().invert()},St.prototype.transform=function(t){var e=S.identity;return this.crs.id!==t.crs.id&&(e=t.crs.getMatrix(J.instance).invert().multiply(this.crs.getMatrix(J.instance))),t.fromCrs().multiply(e.multiply(this.toCrs()))},St.prototype.normalize=function(t){return(t.x<this._min_x||t.x>this._max_x)&&(t.x=B.wrap(t.x,this._min_x,this._max_x)),t},St.prototype.getRectangle=function(){return I.fromSides(this._min_x,this._max_x,this._min_y,this._max_y)},St),J=(xt.prototype.toLatitude=function(t,e){return xt._yToLatitude(e)},xt.prototype.toLongitude=function(t){return 360*(t-.5)},xt.prototype.projectToX=function(t,e,i){return(e=(i=void 0===i?!0:i)?w.normalizeLongitude(e):e)/360+.5},xt.prototype.projectToY=function(t){return xt._latitudeToY(t)},xt.prototype.getScale=function(t){m.assert(t&&t.bounds&&4===t.bounds.length,"Invalid region");var e=Math.abs(t.bounds[1]-t.bounds[3]),t=Math.abs(t.bounds[0]-t.bounds[2]),t=B.log2(1/Math.max(e,t));return F.toScale(null,t,!0)},xt.getCenter=function(t){var e=t&&t.center;return e?new w(xt._yToLatitude((xt._latitudeToY(t.getNorth())+xt._latitudeToY(t.getSouth()))/2),e.longitude,e.altitude,e.altitudeReference):null},xt.prototype.getMatrix=function(t){if(t.id===this.id)return S.identity;if(t.getMatrix){var e=t.getMatrix(this);if(e)return e.invert()}throw new Error("don't know how to convert from "+this.id+" to "+t.id)},xt.getMercatorUnitsPerDegreeOfLatitude=function(t){t=xt._latitudeToY(t),t=Math.exp(Math.PI*(2*t-1));return(t*t+1)/(720*t)},xt.getMercatorUnitsPerDegreeOfLongitude=function(){return 1/360},xt._yToLatitude=function(t){return 90-2*Math.atan(Math.exp((2*t-1)*Math.PI))*B.degreesPerRadian},xt._latitudeToY=function(t){if(xt._latitudeLimit<=t)return 0;if(t<=-xt._latitudeLimit)return 1;t=Math.sin(t*B.radiansPerDegree);return.5-Math.log((1+t)/(1-t))*xt._invFourPi},xt.instance=new xt,xt._latitudeLimit=85.051128,xt._invFourPi=1/(4*Math.PI),xt._unitsPerMeterAtEquator=1/b.earthCircumference,xt),K=(Tt.pixelXYToLocation=function(t,e,i){i=Tt.tileSize*Math.pow(2,i),t=y._clamp(t,0,i-1)/i-.5,i=.5-y._clamp(e,0,i-1)/i,i=90-360*Math.atan(Math.exp(2*-i*Math.PI))/Math.PI;return new w(i,360*t)},Tt.latitudeToPixelY=function(t,e){e=Tt.tileSize*Math.pow(2,e);return t=y._clamp(t,Tt.minLatitude,Tt.maxLatitude),t=Math.sin(t*Math.PI/180),(.5-Math.log((1+t)/(1-t))/(4*Math.PI))*e+.5},Tt.longitudeToPixelX=function(t,e){e=Tt.tileSize*Math.pow(2,e);return((t=y._clamp(t,Tt.minLongitude,Tt.maxLongitude))+180)/360*e+.5},Tt.locationToPixelXY=function(t,e){return new V(Tt.longitudeToPixelX(t.longitude,e),Tt.latitudeToPixelY(t.latitude,e))},Tt.tileSize=256,Tt.enhancedBirdEyeTileHeight=180,Tt.minLatitude=-85.05112878,Tt.maxLatitude=85.05112878,Tt.minLongitude=-180,Tt.maxLongitude=180,Tt),$=(bt.prototype.toLatitude=function(t,e){return this._getLatitude(e)},bt.prototype.toLongitude=function(t,e){e=this._getLatitudeLength(this.toLatitude(t,e));return Math.max(-180,Math.min((t-.5)/e*360,180))},bt.prototype.projectToX=function(t,e){return e*this._getLatitudeLength(t)/360+.5},bt.prototype.projectToY=function(t){return.5+this._getLatitudeOffset(t)},bt.prototype.getScale=function(t){m.assert(t&&t.bounds&&4===t.bounds.length,"Invalid region");t=B.log2(1/(t.bounds[1]-t.bounds[3]));return F.toScale(null,t,!0)},bt.prototype._getLatitudeLength=function(t){return this._interpolate(t,this._latitudeLengths)},bt.prototype._getLatitudeOffset=function(t){var e=this._interpolate(t,this._latitudeOffsets);return 0<=t?-e:e},bt.prototype._getLatitude=function(t){var e,i,n,a,o;if(.5===t)return 0;if(e=t<.5,(t=Math.abs(t-.5))>=this._latitudeOffsets[this._latitudeOffsets.length-1])return e?90:-90;for(i=1,n=this._latitudeOffsets.length;i<n;i++)if(t<=(a=this._latitudeOffsets[i])||i===n-1)return o=5*(i-1)+(t-(o=this._latitudeOffsets[i-1]))/(a-o)*5,e?o:-o},bt.prototype._interpolate=function(t,e){if((t=Math.abs(t))%5==0)return e[t/5];t/=5;var i=Math.floor(t),n=e[i];return n+(e[i+1]-n)*(t-i)},bt.instance=new bt,bt),tt=(wt.getMapViewForLocationsInView=function(t,e,i,n,a,o){if(m.assertNotNull(o,"locations"),!o||0===o.length)return new x(new w(0,0,F.toAltitude(new w(0,0),1,!0),0),0);if(1===o.length)return new x(new w(o[0].latitude,o[0].longitude,F.toAltitude(o[0],20,!0),0),0);o=L.fromLocations(o);return wt.getMapViewWithBounds(t,e,i,n,a,o)},wt.getMapViewWithBounds=function(t,e,i,n,a,o){m.assertNotNull(t,"crs"),m.assertNotNull(a,"viewportPadding"),m.assertNotNull(o,"bounds");var r=new V(a.left,a.top),s=new V(n.width-a.right,n.height-a.bottom),l=s.x-r.x,h=s.y-r.y,d=new V(r.x+l/2,r.y+h/2),c=o.getNorth(),u=o.getSouth(),p=o.getEast(),g=o.getWest();p<g&&(p+=360);a=b.greatCircleDistance(o.getNorthwest(),new w(c,p)),s=b.greatCircleDistance(new w(u,g),o.getSoutheast()),r=null;0<c&&u<0&&(r=b.greatCircleDistance(new w(0,g),new w(0,p))),180<p-g&&(a=b.earthCircumference-a,s=b.earthCircumference-s,null!==r&&(r=b.earthCircumference-r));r=Math.max(a,s,r||0),u=b.greatCircleDistance(new w(c,0),new w(u,0)),h=Math.max(r/l,u/h),o=J.getCenter(o),h=F.fromScale(o,h,!1),h=F.toAltitude(o,h,!0),h=wt.getCameraForLocationToPoint(t,e,i,n,0,o,d,h,0);return new x(h,0)},wt.getCameraForLocationToPoint=function(t,e,i,n,a,o,r,s,l){var h=Math.pow(2,F.fromLocation(new w(o.latitude,o.longitude,s),!0)),e=h*e,h=h*i,i=t.projectToX(o.latitude,o.longitude),o=t.projectToY(o.latitude,o.longitude),e=i-(r=B.rotatePoint(r.x-n.width/2,r.y-n.height/2,-B.degreesToRadians(a))).x/e,h=o-r.y/h;return new w(t.toLatitude(e,h),t.toLongitude(e,h),s,l)},wt),et=(Mt.prototype.getDisplayName=function(){return this.getCurrentCrs().id},Mt.prototype.tryPointToLocation=function(t,e){e=e||this._map.getView();var i=this.getCurrentCrs(),n=e.cameraLocation,a=F.fromLocation(n,!0),o=this._map.getActualSize(),r=this.getHeading(),s=new V(i.projectToX(n.latitude,n.longitude),i.projectToY(n.latitude,n.longitude)),e=Math.pow(2,a),n=this.getTileSize(),a=e*n.width,n=e*n.height,a=(t.x-o.width/2)/a,n=(t.y-o.height/2)/n;t=B.rotatePoint(a,n,-B.degreesToRadians(r));r=s.x+t.x,s=s.y+t.y,t=i.toLatitude(r,s),s=w.normalizeLongitude(i.toLongitude(r,s));return new w(t,s)},Mt.prototype.tryLocationToPoint=function(t,e){e=e||this._map.getView();var i=this.getCurrentCrs(),n=e.cameraLocation,a=F.fromLocation(n,!0),o=this.getHeading(),r=Math.pow(2,a),s=this.getTileSize(),l=r*s.width,a=r*s.height,r=new V(i.projectToX(n.latitude,n.longitude),i.projectToY(n.latitude,n.longitude)),s=r.x*l,n=(i.projectToX(t.latitude,t.longitude)-r.x)*l,i=(i.projectToY(t.latitude,t.longitude)-r.y)*a,r=this._map.getActualSize();return s-r.width/2<0&&(a=new V(0,0),a=this.tryPointToLocation(a,e),w.normalizeLongitude(t.longitude)>a.longitude&&(n-=l)),s+r.width/2>l&&(s=new V(r.width,0),e=this.tryPointToLocation(s,e),w.normalizeLongitude(t.longitude)<e.longitude&&(n+=l)),r.width>l&&(l/2<n?n-=l:n<-l/2&&(n+=l)),(o=B.rotatePoint(n,i,B.degreesToRadians(o))).x+=r.width/2,o.y+=r.height/2,o},Mt.prototype.getMapViewForLocationsInView=function(t,e,i){var n;if(!t)throw"The 'locations' parameter cannot be null or undefined.";var a=this._map.getViewportPadding(),e=e||{},e={left:a.left+(e.left||0),top:a.top+(e.top||0),right:a.right+(e.right||0),bottom:a.bottom+(e.bottom||0)};return i||(n=this._map.getViewport(),m.assertNotNull(n,"viewport"),i=new D(n.pixelWidth,n.pixelHeight)),n=this.getTileSize(),tt.getMapViewForLocationsInView(this.getCurrentCrs(),n.width,n.height,i,e,t)},Mt.prototype.getMapViewWithBounds=function(t,e){if(!t)throw"The 'bounds' parameter cannot be null or undefined.";e=e||{};var i=this._map.getViewportPadding(),n={left:i.left+(e.left||0),top:i.top+(e.top||0),right:i.right+(e.right||0),bottom:i.bottom+(e.bottom||0)},i=this._map.getViewport();return m.assertNotNull(i,"viewport"),e=new D(i.pixelWidth,i.pixelHeight),i=this.getTileSize(),tt.getMapViewWithBounds(this.getCurrentCrs(),i.width,i.height,e,n,t)},Mt.prototype.getMapViewZoomedAboutLocation=function(t,e,i,n){var a=this.tryLocationToPoint(e,t);return this.getMapViewZoomedAboutLocationAtPoint(t,e,a,i,n)},Mt.prototype.getMapViewZoomedAboutLocationAtPoint=function(t,e,i,n,a){var o=F.fromLocation(new w(e.latitude,e.longitude,t.cameraLocation.altitude),!0),n=b.roundToInterval(o+n,a),a=this._map.getMapType(),n=Math.min(a.maxZoom,Math.max(n,a.minZoom)),n=this.getCameraForLocationToPoint(e,i,F.toAltitude(null,n,!0),0);return new x(n,t.heading)},Mt.prototype.getCameraForLocationToPoint=function(t,e,i,n,a){var o,r,s=this.getCurrentCrs(),l=this.getTileSize(),h=l.width,d=l.height,c=this.getHeading();return 0===c&&(r=o=0,u.BirdseyeV2Crs&&s instanceof u.BirdseyeV2Crs&&s.sceneMetadata&&(o=(l=s.sceneMetadata.centerLocation).latitude,r=l.longitude),r=new x(new w(o,r,i,0)),j.enforceMinZoom(this._map,r)&&(i=r.cameraLocation.altitude)),tt.getCameraForLocationToPoint(s,h,d,a||this._map.getActualSize(),c,t,e,i,n)},Mt.prototype.getCurrentCrs=function(){var t=this.getCurrentScenes(!0)[0];return t?t.crs:J.instance},Mt.prototype.getCurrentCrsViewport=function(){var t=this._map.getView(),e=this._map.getActualSize(),i=this.getTileSize(),n=F.fromLocation(t.cameraLocation,!0),a=Math.pow(2,n),o=this.getCurrentCrs(),n=new V(o.projectToX(t.cameraLocation.latitude,t.cameraLocation.longitude),o.projectToY(t.cameraLocation.latitude,t.cameraLocation.longitude)),t=(o.bounds[1]-o.bounds[3])/(i.width*a),a=(o.bounds[2]-o.bounds[0])/(i.height*a),t=e.width*t/2,a=e.height*a/2,t=[n.y-a,n.x+t,n.y+a,n.x-t];return new Q(e.width,e.height,t,o)},Mt.prototype.getCurrentScenes=function(t){for(var e,i=this._map.getView(),n=[],a=F.fromLocation(i.cameraLocation,!0),o=F.toScale(i.cameraLocation,a,!0),r=0,s=this._allLayers.length;r<s;r++)(e=this._allLayers[r])instanceof d&&e.getVisible()&&(!t||e.isCritical)&&((e=e.getScene(null,i.cameraLocation,o,i.heading))&&n.push(e));return 0===n.length&&this._previousMapScenes?n=this._previousMapScenes:this._previousMapScenes=n,n},Mt.prototype.getTileSize=function(){var t=this.getCurrentScenes(!0)[0],t=t?t.getTileSize():U.tileLength;return new D(t,t)},Mt.prototype.getHeading=function(){var t=this._map.getView();return(this.getCurrentCrs().heading||0)-t.heading},Mt.prototype.getCopyrights=function(e){function n(t){r--,t&&t.length&&0!==t.length&&(t=t.filter(function(t){return-1===i.indexOf(t)}),Array.prototype.push.apply(i,t)),r||e(i)}var a=this,i=[],t=this._map.getView(),o=F.fromLocation(t.cameraLocation,!0),t=this.getCurrentScenes(),r=t.length;t.forEach(function(e){var i;e.copyrightProvider?(i=null,u.BirdseyeV2Crs&&e.crs instanceof u.BirdseyeV2Crs?a._map.getBirdseyeV2Manager().then(function(t){(i=t.getUpdatedProductId(e.crs))?e.copyrightProvider.getCopyrights(i,a._map.getBounds().bounds,o,e.crs.heading,n):""===i&&n([])}):e.copyrightProvider.getCopyrights(i,a._map.getBounds().bounds,o,e.crs.heading,n)):n([])})},Mt.prototype.activated=function(){var e=this,t=this._map;this._disposables.push(this._allLayers.changed.addThrottled(function(){return e._layersChanged()},5),t.boxZoomStarted.add(function(t){return e._boxZoomStarted(t)}),t.boxZoomContinued.add(function(t){return e._boxZoomContinued(t)}),t.boxZoomStopped.add(function(t){return e._boxZoomStopped(t)}),t.boxZoomCancelled.add(function(){return e._boxZoomCancelled()}),t.constrainView.add(function(t){return e._constrainView(t)}),new G(this,t,this._canvasDrawingContextFactory,this._hitTestController))},Mt.prototype.deactivated=function(){y._clearDisposables(this._disposables)},Mt.prototype.dispose=function(){this.deactivated(),this._hitTestController&&(this._hitTestController.dispose(),this._hitTestController=null),this._rootElement&&(this._rootElement.clear(),this._rootElement.removeFromParent(),this._rootElement=null),this._allLayers=null,this._map=null},Mt.prototype.getRootElement=function(){var t,e,i,n=this;return this._rootElement||(this._rootElement=y._createElement("div"),this._rootElement.add_class("ms-composite"),this._rootElement.set_style({zIndex:0}),this._rootElement.set_attr("tabindex","0"),f.isMapsVertical||this._rootElement.set_attr("dir","ltr"),f.isMapsAnswer&&!f.isMapsVertical&&this._rootElement.add_class("maclick"),this._rootElement.set_attr("tabindex","-1"),t=this._map.getMapOptions(),e=y._createElement("div"),f.isMapsAnswer&&!t.allowMapFocus||e.set_attr("tabindex","0"),i="mapFocus",t.serpMultiMapsAccessible&&(i+=this._map.getRootElement().parent().get_native_prop("id")),e.set_attr("id",i),(i=Z.MapCore)&&i.L_FocusDivDefaultLabel?e.set_attr("aria-label",i.L_FocusDivDefaultLabel):e.set_attr("aria-label","Bing Maps - Interact to see more"),i=this._map.getActualSize(),e.set_style({top:"1px",left:"1px","z-index":25100,"pointer-events":"none",position:"absolute",width:i.width-2,height:i.height-2}),e.add_event("focus",function(t){t.relatedTarget&&e[0].focus()}),this._map.actualSizeChanged.add(function(){var t=n._map.getActualSize();t&&e.set_style({width:t.width-2,height:t.height-2})}),this._rootElement.append(e)),this._rootElement},Mt.prototype.getMinAltitude=function(){var t=this._map.getMapType(),e=t&&t.maxZoom||Mt._maxZoom;return t&&t.id===T.birdseyeV2&&((t=this.getCurrentCrs())&&t.sceneMetadata&&(e=Math.min(e,t.sceneMetadata.endingZoomLevel))),F.toAltitude(null,e,!0)},Mt.prototype._layersChanged=function(){for(var t,e=0,i=0,n=this._allLayers.length;i<n;i++)t=this._allLayers[i],e=Math.max(e,t.hitTestingGraceRadius||0);this._hitTestController.graceRadiusForMouse=e},Mt.prototype._constrainView=function(t){j.constrainView(this._map,t)},Mt.prototype._boxZoomStarted=function(t){this._boxZoomCancelled(),this._boxZoomStartArgs=t,this._boxZoomElement=y._createElement("div").add_class("boxZoom").set_style({position:"absolute",zIndex:3e4}),this._rootElement.append(this._boxZoomElement)},Mt.prototype._boxZoomContinued=function(t){var e=this._boxZoomElement,i=this._boxZoomStartArgs;e&&i&&(t=I.fromPoints(i.point,t.point),e.set_style({left:t.minPoint.x+"px",top:t.minPoint.y+"px",width:t.maxPoint.x-t.minPoint.x+"px",height:t.maxPoint.y-t.minPoint.y+"px"}))},Mt.prototype._boxZoomStopped=function(t){var e,i,n,a,o,r=this._boxZoomStartArgs;this._boxZoomCancelled(),r&&(i=r.point,n=t.point,a=r.location,r=t.location,2<Math.abs(i.x-n.x)&&2<Math.abs(i.y-n.y)&&(t=i.y<n.y?(e=a.latitude,r.latitude):(e=r.latitude,a.latitude),a=i.x<n.x?(o=a.longitude,r.longitude):(o=r.longitude,a.longitude),o=L.fromEdges(e,o,t,a),t=this._map.getViewport(),a=this.getTileSize(),a=tt.getMapViewWithBounds(this.getCurrentCrs(),a.width,a.height,new D(t.pixelWidth,t.pixelHeight),this._map.getViewportPadding(),o),t=this._map,o=F.fromLocation(a.cameraLocation,!0),o=Math.floor(o),a.cameraLocation=F.toLocation(a.cameraLocation,o,!0),t.setView(a,s.defaultAnimation,1)))},Mt.prototype._boxZoomCancelled=function(){var t=this._boxZoomElement;t&&(t.removeFromParent(),this._boxZoomElement=null,this._boxZoomStartArgs=null)},Mt.prototype.getState=function(){var t=this._map,e=t.getView().cameraLocation,i=t.getNavigationBar();return{centerPoint:e,level:Microsoft.Maps.Internal.MapHelper.getMercatorZoomLevel(t),mode:this.mapModeType,style:t.getMapType().id,labelVisibility:t.getLabelController().getIsLabelsEnabled()?E.visible:E.hidden,direction:t.getView().heading,hasRequestedBE:!!i&&i.getAerialBirdsEyeTransitionManager().hasRequestedBirdsEye()}},Mt._maxZoom=20,Mt),it=(Ct.prototype.send=function(t,e,i){var n=Math.max(this.boundingBox.getNorth(),this.boundingBox.getSouth()),a=Math.min(this.boundingBox.getNorth(),this.boundingBox.getSouth()),o=Math.min(this.boundingBox.getWest(),this.boundingBox.getEast()),r=Math.max(this.boundingBox.getWest(),this.boundingBox.getEast()),r=this._url.replace("{north}",n.toString()).replace("{west}",o.toString()).replace("{south}",a.toString()).replace("{east}",r.toString());R.downloadJsonp(r,"elev",t,e,null,null,i)},Ct),nt=(Lt.prototype.toLatitude=function(t,e){var i=J.instance;switch(this.heading){case 0:return i.toLatitude(t,e)-Lt._elevationInDegreesLatitude;case 90:return i.toLatitude(1-e,t);case 180:return i.toLatitude(1-t,1-e)+Lt._elevationInDegreesLatitude;case 270:return i.toLatitude(e,1-t);default:throw new Error("invalid operation - unsupported heading")}},Lt.prototype.toLongitude=function(t,e){var i=J.instance;switch(this.heading){case 0:return i.toLongitude(t,e);case 90:return i.toLongitude(1-e,t)-Lt._elevationInDegreesLongitude;case 180:return i.toLongitude(1-t,1-e);case 270:return i.toLongitude(e,1-t)+Lt._elevationInDegreesLongitude;default:throw new Error("invalid operation - unsupported heading")}},Lt.prototype.projectToX=function(t,e){var i=J.instance;switch(this.heading){case 0:return i.projectToX(t+Lt._elevationInDegreesLatitude,e);case 90:return i.projectToY(t,e+Lt._elevationInDegreesLongitude);case 180:return 1-i.projectToX(t-Lt._elevationInDegreesLatitude,e);case 270:return 1-i.projectToY(t,e-Lt._elevationInDegreesLongitude);default:throw new Error("invalid operation - unsupported heading")}},Lt.prototype.projectToY=function(t,e){var i=J.instance;switch(this.heading){case 0:return i.projectToY(t+Lt._elevationInDegreesLatitude,e);case 90:return 1-i.projectToX(t,e+Lt._elevationInDegreesLongitude);case 180:return 1-i.projectToY(t-Lt._elevationInDegreesLatitude,e);case 270:return i.projectToX(t,e-Lt._elevationInDegreesLongitude);default:throw new Error("invalid operation - unsupported heading")}},Lt.prototype.getScale=function(t){return J.instance.getScale(t)},Lt.prototype.getMatrix=function(t){var e=t===J.instance;if(e||t instanceof Lt){var i=S.identity,n=S.identity,a=Math.round(B.wrap(this.heading-(t.heading||0),0,360)),t=a*Math.PI/180;switch(e&&(n=S.identity.translate(-Lt._elevationInMercatorX*Math.sin(t),Lt._elevationInMercatorY*Math.cos(t))),a){case 0:break;case 90:i=Lt._m90;break;case 180:i=Lt._m180;break;case 270:i=Lt._m270;break;default:throw new Error("invalid operation - unsupported heading")}return n.multiply(i)}return null},Lt.prototype.getElevation=function(r,s,l,h){var d=this;new it(r,this._elevationServiceUrl).send(function(t,e){var i,n,a,o;if(e===d._mostRecentElevationRequest){if(i=null,t&&((n=t.alt)&&0<n.length)){for(a=n.length,o=i=0;o<a;o++)i+=(a-o)/a*n[o];if(isFinite(i))return Lt.setElevation(i,r.center.latitude),void(s&&s(i,h))}l&&l(h)}},function(t){t===d._mostRecentElevationRequest&&l&&l(h)},++this._mostRecentElevationRequest)},Lt.setElevation=function(t,e){Lt._elevationInDegreesLatitude=t/b.getMetersPerDegreeOfLatitude(e),Lt._elevationInDegreesLongitude=t/b.getMetersPerDegreeOfLongitude(e),Lt._elevationInMercatorY=Lt._elevationInDegreesLatitude*J.getMercatorUnitsPerDegreeOfLatitude(e),Lt._elevationInMercatorX=Lt._elevationInDegreesLongitude*J.getMercatorUnitsPerDegreeOfLongitude()},Lt._m90=new S(0,-1,1,0,0,1).invert(),Lt._m180=new S(-1,0,0,-1,1,1).invert(),Lt._m270=new S(0,1,-1,0,1,0).invert(),Lt._elevationInDegreesLatitude=0,Lt._elevationInDegreesLongitude=0,Lt._elevationInMercatorY=0,Lt._elevationInMercatorX=0,Lt),at=(vt.prototype.dispose=function(){this._eventRoot&&(this.stopHitTesting(),this._hitTestComponents=[],this._eventRoot=null,this._hitTestRoot=null),y._clearDisposables(this._mapEvents),y._nullifyClass(this)},vt.prototype.addComponent=function(t){y._orderedInsert(this._hitTestComponents,t,"hitTestPriority")},vt.prototype.removeComponent=function(t){y._orderedDelete(this._hitTestComponents,t,"hitTestPriority")},vt.prototype.startHitTesting=function(t,e){var i=this,n=this._eventRoot=t;this._hitTestRoot=e;for(var a={argBuilder:function(t,e){return i._performHitTestingForMouseEvent(t,e)}},o={argBuilder:function(t,e){return i._performHitTestingForTouchEvent(t,e)}},r=["mousemove","mousedown","mouseup","click","dblclick","contextmenu"],s=["touchstart","touchend"],l=0;l<r.length;l++)this._registeredJsEvents[r[l]]=y._defineJSEventForDomEvent(n,r[l],a);for(l=0;l<s.length;l++)this._registeredJsEvents[s[l]]=y._defineJSEventForDomEvent(n,s[l],o)},vt.prototype.updateTestRootElement=function(t){this._hitTestRoot=t},vt.prototype.stopHitTesting=function(){var t,e=this._eventRoot;for(t in this._registeredJsEvents)y._undefineJSEventForDomEvent(e,t,this._registeredJsEvents[t].id),this._registeredJsEvents[t].dispose()},vt.prototype._performHitTestingForMouseEvent=function(t,e){this._performHitTestingWithSpiraling(t.point,e,this.graceRadiusForMouse)},vt.prototype._performHitTestingForTouchEvent=function(t,e){var i,n;if(t&&e&&this._enableHitTesting)if(e.changedTouches)for(i=e.changedTouches,n=0;n<i.length;n++){var a=i[n],o=this._hitTestRoot.get_absolute_pos(),o=new V(a.pageX-o.x,a.pageY-o.y);this._performHitTestingForTouchPoint(o,a)}else this._performHitTestingForTouchPoint(t.point,e)},vt.prototype._performHitTestingForTouchPoint=function(t,e){this._performHitTestingWithSpiraling(t,e,vt._graceRadiusForTouch)},vt.prototype._performHitTestingWithSpiraling=function(t,e,i){if(this._performHitTesting(e,t),!e.primitive)for(var n=1;n<i&&(this._performHitTesting(e,new V(t.x+n,t.y)),!e.primitive)&&(this._performHitTesting(e,new V(t.x,t.y+n)),!e.primitive)&&(this._performHitTesting(e,new V(t.x-n,t.y)),!e.primitive)&&(this._performHitTesting(e,new V(t.x,t.y-n)),!e.primitive);n++);},vt.prototype._performHitTesting=function(t,e){var i,n,a;if(this._enableHitTesting)for(n=0,a=(i=this._hitTestComponents).length;n<a&&(i[n].performHitTesting(t,e),!t.primitive&&!t.exclusiveHitTest);n++);},vt._graceRadiusForTouch=20,vt),ot=(yt.prototype.reset=function(t,e){var i,n;for(this._height=1+(e/yt.cellSize|0),this._width=1+(t/yt.cellSize|0),this._index=new Array(this._height),i=0;i<this._height;i++)for(this._index[i]=new Array(this._width),n=0;n<this._width;n++)this._index[i][n]=[]},yt.prototype.add=function(t,e){for(var i,n=Math.max(e.minPoint.y/yt.cellSize|0,0),a=Math.min(e.maxPoint.y/yt.cellSize|0,this._height-1),o=Math.max(e.minPoint.x/yt.cellSize|0,0),r=Math.min(e.maxPoint.x/yt.cellSize|0,this._width-1),s=n;s<=a;s++)for(i=o;i<=r;i++)this._index[s][i].push(t)},yt.prototype.getOverlappingRegions=function(t){for(var e,i=Math.max(t.minPoint.y/yt.cellSize|0,0),n=Math.min(t.maxPoint.y/yt.cellSize|0,this._height-1),a=Math.max(t.minPoint.x/yt.cellSize|0,0),o=Math.min(t.maxPoint.x/yt.cellSize|0,this._width-1),r=[],s=i;s<=n;s++)for(e=a;e<=o;e++)Array.prototype.push.apply(r,this._index[s][e]);return r},yt.prototype.getRegionsAtPixel=function(t,e){t=y._clamp(t/yt.cellSize|0,0,this._width-1),e=y._clamp(e/yt.cellSize|0,0,this._height-1);return this._index[e][t]},yt.prototype.getRegions=function(t,e){return this._index[t][e]},yt.prototype.getHeight=function(){return this._height},yt.prototype.getWidth=function(){return this._width},yt.cellSize=64,yt),rt=(ft.prototype.reset=function(t,e){this._index.reset(t,e)},ft.prototype.addEllipse=function(t,e,i,n,a){i={key:t,shape:1,bounds:I.fromSides(e-n/2,e+n/2,i-a/2,i+a/2),center:{x:e,y:i}};this._index.add(i,i.bounds)},ft.prototype.addRectangle=function(t,e,i,n,a){a={key:t,shape:2,bounds:I.fromSides(e,e+n,i,i+a)};this._index.add(a,a.bounds)},ft.prototype.hitTest=function(t){for(var e,i=this._index.getRegionsAtPixel(t.x,t.y),n=null,a=i.length-1;0<=a;a--)if(e=i[a],this._pointInRegion(t,e)){n=e.key;break}return n},ft.prototype._pointInRegion=function(t,e){var i=e.bounds;return!!i.pointInRect(t)&&(1!==e.shape||(e=e.center,i=i.minPoint,(t.x-e.x)*(t.x-e.x)/(e.x-i.x)/(e.x-i.x)+(t.y-e.y)*(t.y-e.y)/(e.y-i.y)/(e.y-i.y)<=1))},ft),st=(mt.prototype.setFrame=function(){this._totalTilesCount=this._pendingTilesCount=this._failedTilesCount=0},mt.prototype.getRasterTiles=function(){return this._rasterTiles},mt.prototype.getPercentCompleted=function(){return 0===this._totalTilesCount?0:(this._totalTilesCount-this._pendingTilesCount)/this._totalTilesCount*100},mt.prototype.getPercentFailed=function(){return this._failedTilesCount/this._totalTilesCount*100},mt.prototype.getTileSize=function(){return this._tileSize},mt.prototype.getAllTiles=function(t,e,i,n,a,o,r,s,l,h,d,c,u,p,g){var _,m,f,y,v;for(void 0===p&&(p=-1),_=[],m=0;m<e.length;m++)_.push.apply(_,this._getRegions(t.pixelWidth,t.pixelHeight,e[m],s,g));for(o||!r||a||(this._totalTilesCount=this._pendingTilesCount=_.length,this._failedTilesCount=0,this._sceneRequetId++),this._rasterTiles=[],f=this._sceneRequetId,y=this._getTileUrlTemplate(l&&o),this._backgroundTilesCache=a?this._backgroundTilesCache:null,v=0;v<_.length;v++){var L=_[v],C=this._getTileUrl(L,y,!1),M=this._getcacheKey(C,p,L),w=a?k.getBackgroundTile(M):k.getTile(M);w?(o||!r||a||this._pendingTilesCount--,i&&i(new z(w.image,M,L))):(a&&this._tryAndReturnBackgroundTile(M,L,y,l,p,i),r&&((w=this._pendingRequest[M])?(w.callback=i,w.cacheKey=M,w.tileUrlTemplate=y,w.cacheDuration=p,w.isBackgroundRequest=o,w.isAnimationRequest=a,w.sceneRequetId!==f?(w.count=1,w.regions=[L],w.sceneRequetId=f):w.tileUrlTemplate===C&&(w.count++,w.regions.push(L))):(this._pendingRequest[M]=w={networkReqId:"",sceneRequetId:f,count:1,isRetry:!1,callback:i,cacheKey:M,regions:[L],tileUrlTemplate:y,cacheDuration:p,isBackgroundRequest:o,isAnimationRequest:a},L=this._getTile(w,C,M,L,n,o,h,d,c,u),this._processTileResponse(L,M))))}return o||a||this.cancelAllPendingRequests(f),_.length},mt.prototype.cancelAllPendingRequests=function(t){var e,i,n;if(void 0===t&&(t=-1),this._pendingRequest)for(e=Object.keys(this._pendingRequest),i=0;i<e.length;i++)n=this._pendingRequest[e[i]],-1!==t&&n.sceneRequetId===t||(delete this._pendingRequest[e[i]],R.abortRequest(n.networkReqId))},mt.prototype.getAllPendingRequestsBackgroundTiles=function(t){var e,i,n,a=[],o=Object.keys(this._pendingRequest);for(this._backgroundTilesCache=null,e=0;e<o.length;e++)for(i=this._pendingRequest[o[e]],n=0;n<i.regions.length;n++)this._tryAndReturnBackgroundTile(i.cacheKey,i.regions[n],i.tileUrlTemplate,t,i.cacheDuration,function(t){a.push(t)});return a},mt.prototype.dispose=function(){this.cancelAllPendingRequests(),y._clearDisposables(this._disposables),this._map=null,this._coreConfig=null,this.nativeView=null,this._backgroundTilesCache=null,this.copyrightProvider=null},mt.createMercatorImageryScene=function(t,e,i,n,a,o,r,s){return new mt(a,new x(F.toLocation(new w(0,0),0,!0)),J.instance,t,e,i,n,o,r,s)},mt.prototype._getTileUrl=function(t,e,i){var n=t.quadKey,a="string"==typeof e?(i=this._map&&(this._tileUrlContainsCredentialsParam||this._useTFEAuthentication&&(this._tileRequestFailedCount>this._maxFailureForFailover||i)),a=e,a=this._tileUrlContainsXParam?a.replace("{x}",t.x.toString()):a,a=this._tileUrlContainsYParam?a.replace("{y}",t.y.toString()):a,a=this._tileUrlContainsZoomParam?a.replace("{zoom}",t.zoom.toString()):a,a=this._tileUrlContainsQuardkeyParam?a.replace("{quadkey}",n):a,a=this._tileUrlContainsBBoxParam?a.replace("{bbox}",this._getWMSBoundsString(t)):a,a=this._tileUrlContainsSubdomainParam?a.replace("{subdomain}",y._getTileSubDomain(n)):a,this._getUpdatedUrlWithCredentials(a,i)):e(t);return a},mt.prototype._getRegions=function(t,e,i,n,a){var o,r,s=[],l=i.cameraLocation;t*=n,e*=n;for(var h=Math.log(n)/Math.log(2),d=Math.floor(F.fromLocation(l,!0,this instanceof dt?void 0:this._tileSize))+h,i=Math.pow(2,d),n=this.crs.projectToX(l.latitude,l.longitude),h=this.crs.projectToY(l.latitude,l.longitude),l=Math.round(this._tileSize*i*n),n=Math.round(this._tileSize*i*h),i=t/2,h=e/2,t=n-h,e=l+i-1,h=n+h-1,i=Math.floor((l-i)/this._tileSize),c=Math.floor(t/this._tileSize),u=Math.floor(e/this._tileSize),p=Math.floor(h/this._tileSize),g=i;g<=u;g++)for(o=c;o<=p;o++)r=new H(g,o,d,this._tileSize,this._tileSize,this.crs),a&&!a.intersects(L.fromRegionId(r))||s.push(r);return s},mt.prototype._getTile=function(o,t,e,r,s,l,h,d,c,i){var u=this;return new Promise(function(a){o.networkReqId=R.downloadImage(t,"raster",function(t){t=new z(t,e,r,o.regions[0]);s&&k.addTile(t,l),a(t)},function(t,e){var i,n;(i=4!==e&&s&&!l?!o.isRetry&&u._useTFEAuthentication?(o.isRetry||u._tileRequestFailedCount++,u._logError(),o.isRetry=!0,r):r.getParent():i)?(n=u._getTileUrl(i,o.tileUrlTemplate,o.isRetry),e=u._getcacheKey(n,o.cacheDuration,i),u._getTile(o,n,e,i,s,l,h,d,c).then(function(t){a(t)})):a(null)},null,h,d,c,i)})},mt.prototype._updateTileUrl=function(t){var e,i,n,a,o;return"string"!=typeof t||t.startsWith("data:")||(e=O.fromString(t),a=this._customMapStyleManager.styleString,(i=e.queryStringParameters)&&(i.st!==a&&(i.st?a?i.st=a:delete i.st:a&&(i.st=a)),o=i.it,n=this._customMapStyleManager.buildingVisible,a=this._customMapStyleManager.flatBuildings,!o||n&&!a||(o=o.split(","),o=n?o.map(function(t){return"BX"===t?"BF":t}):o.filter(function(t){return"BX"!==t&&"BF"!==t}),i.it=o.join(",")),t=e.toString(!0))),t},mt.prototype._getcacheKey=function(t,e,i){i=(t=this._useTFEAuthentication?t.replace(/&?key=([\w|-]{64})/i,""):t)+"_"+i.x+"_"+i.y+"_"+f.tileSourceParam;return-1<e&&(this._cacheTimeOffset<-1&&(this._cacheTimeOffset=Date.now()),i+="_"+(Date.now()-this._cacheTimeOffset)%e),i},mt.prototype._subscribeToTileChangeEvents=function(t,e,i,n,a){var o=this;i&&t.labelControllerLoaded.addOne(function(){o._subscribeToLabelControllerLabelsEnabledEvent(t,e,i,n,a)},!1,!0),this._customMapStyleManager&&this._disposables.push(this._customMapStyleManager.changed.add(function(){o._updateGlobalTileUrlTemplateParam()}))},mt.prototype._subscribeToLabelControllerLabelsEnabledEvent=function(t,e,i,n,a){var o=this;this._disposables.push(t.getLabelController().changed.add(function(t){"isLabelsEnabled"===t.name&&0==t.newValue?(o._activeTileTemplate=i,o._tileFeatures=a||n):(o._activeTileTemplate=e,o._tileFeatures=n),o._updateGlobalTileUrlTemplateParam()}))},mt.prototype._getWMSBoundsString=function(t){t=L.fromRegionId(t);return t.getWest()+","+t.getSouth()+","+t.getEast()+","+t.getNorth()},mt.prototype._updateGlobalTileUrlTemplateParam=function(){var t,e=this._tileUrlTemplate;this._tileUrlTemplate=this._activeTileTemplate,"string"==typeof this._tileUrlTemplate&&(t=(t=this._tileUrlTemplate).replace("{it}",this._tileFeatures).replace("{it2}",this._tileFeatures),t=(t=this._customMapStyleManager?(t=this._updateTileUrl(t)).replace("{shading}",this._customMapStyleManager.settingHasValue("shadedReliefVisible",!1)?"flat":"hill"):t).replace("{synthviewgenid}",f.dynamicProperties.synthViewGenerationId),t=y._updateTfeMktAndUrl(t),this._tileUrlContainsXParam=-1<t.indexOf("{x}"),this._tileUrlContainsYParam=-1<t.indexOf("{y}"),this._tileUrlContainsZoomParam=-1<t.indexOf("{zoom}"),this._tileUrlContainsCredentialsParam=-1<t.indexOf("{credentials}"),this._tileUrlContainsQuardkeyParam=-1<t.indexOf("{quadkey}"),this._tileUrlContainsBBoxParam=-1<t.indexOf("{bbox}"),this._tileUrlContainsSubdomainParam=-1<t.indexOf("{subdomain}"),"undefined"!=typeof FunctionalTestHooks&&(this._tileUrlContainsXParam=this._tileUrlContainsYParam=this._tileUrlContainsZoomParam=this._tileUrlContainsCredentialsParam=this._tileUrlContainsQuardkeyParam=this._tileUrlContainsBBoxParam=this._tileUrlContainsSubdomainParam=!0),e!==(this._tileUrlTemplate=t)&&this.tileUrlTemplateChanged.invoke(this))},mt.prototype._getTileUrlTemplate=function(t){var e=this._tileUrlTemplate;return e="string"==typeof e&&t?this._updateUrlForLiteModeBackgroundTile(e):e},mt.prototype._updateUrlForLiteModeBackgroundTile=function(t){var e,i,n,a;return"string"!=typeof t?t:(-1<(a=(n=t).indexOf("it="))&&(e=n.indexOf("&",a+=3),t=n.substr(a,-1<e?e-a:n.length-a).split(","),i=[],t.forEach(function(t){"LA"!==t.toUpperCase()&&"L"!==t.toUpperCase()&&i.push(t)}),n=n.substr(0,a)+i.join(",")+(-1<e?n.substr(e):"")),n)},mt.prototype._tryAndReturnBackgroundTile=function(t,e,i,n,a,o){var r,s,l,h;if(this._backgroundTilesCache=this._backgroundTilesCache||{},r=this._backgroundTilesCache[t])o(r);else if(null!==r){for(s=e,l=void 0,n&&(i=this._updateUrlForLiteModeBackgroundTile(i));1<s.zoom;)if(s=s.getParent(),h=this._getTileUrl(s,i,!1),h=this._getcacheKey(h,a,s),l=k.getBackgroundTile(h,n)){r=new z(l.image,h,s,e),o(this._backgroundTilesCache[t]=r);break}l||(this._backgroundTilesCache[t]=null,o(new z(null,t,e)))}},mt.prototype._processTileResponse=function(t,i){var n=this;t.then(function(t){var e=n._pendingRequest[i];e&&(--e.count<=0&&delete n._pendingRequest[i],e.isBackgroundRequest||e.sceneRequetId!==n._sceneRequetId||(e.isAnimationRequest||n._pendingTilesCount--,m.assert(0<=n._pendingTilesCount,"Can't have less than 0 pending tiles"),t?(n._rasterTiles.push(t),e.callback&&e.callback(t)):e.isAnimationRequest||(n._failedTilesCount++,e.callback&&e.callback(t))))})},mt.prototype._logError=function(){var t,e;this._tileRequestFailedCount===this._maxFailureForFailover+1&&Math.random()<=.1&&((t=u.logger)&&(e={feature:h.MapControl,action:C.Error,data:{errorMessage:"Tile requests failed "+this._tileRequestFailedCount+" times. Switching over to use TFE authentication."}},t.logCriticalError(null,e)))},mt.prototype._getUpdatedUrlWithCredentials=function(t,e){return e?this._tileUrlContainsCredentialsParam||(t+="&key="+M.instance.getSessionId()):!e&&this._tileUrlContainsCredentialsParam&&(t=t.replace(/&?key={credentials}/gi,"")),t},mt);u.CompositeMapMode=et,u.EnhancedBirdseyeCrs=nt,u.MercatorCubeCrs=J,_._VectorLayerRenderer=Y,_._MercatorTileUtility=K,_.RegionIndex=ot,_.HitTestIndex=rt,_.HitTestController=at,_._LayerRendererManager=void 0!==G?G:null,_._AnimationRenderer=void 0!==q?q:null,_._BoundaryHelper=j,u.RasterImageryScene=st,u.Viewport=Q;var lt,_=(u=window.$MicrosoftMaps8).Internal,s=u.BasicMapAnimation,j=(_._Binding,_._BoundaryHelper),h=(_._BoundsAccumulator,_._ComponentNames),m=_._Debug,o=(_._Dispatcher,_._Gimme),f=u.GlobalConfig,y=_._Helper,d=u.ImageryMapLayer,v=_._JSEvent,L=u.LocationRect,C=_._LoggerConstants,i=_._LruCache,M=_._MapAuthentication,w=(_.MapHelper,u.MapLayer,u.Location),b=u.MapMath,T=u.MapTypeId,x=u.MapView,S=u.Matrix2D,J=u.MercatorCubeCrs,R=_._Network,V=(_._Observable,_._ObservableCollection,_._ObservableObjectChangedArgs,u.Point),I=(u.PooledImage,u.Rectangle),P=u.SimplePointPrimitive,D=u.Size,E=u.LabelVisibility,A=u.VectorMapLayer,B=_._VectorMath,F=u.ZoomLevel,O=_._Url,H=(_.PyramidTileSpatialIndex,u.PyramidTileId),k=_.RasterTileCache,z=_.RasterTile,U=(_._LatLonCrs,_.TileSystemHelper),Z=u.ResourceManager,st=u.RasterImageryScene,W=this&&this.__extends||(n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),ht=(_t.prototype.toLatitude=function(t,e){var i,n,e=this.sceneMetadata?(i=512*(t*Math.pow(2,this.sceneMetadata.endingZoomLevel)-this.sceneMetadata.maxTileOffset),n=512*(e*Math.pow(2,this.sceneMetadata.endingZoomLevel)-this.sceneMetadata.maxTileOffset),this.sceneMetadata.projectToLatLong(i,n)[0]):J.instance.toLatitude(t,e);return Math.min(Math.max(e,-90),90)},_t.prototype.toLongitude=function(t,e){var i,n,e=this.sceneMetadata?(i=512*(t*Math.pow(2,this.sceneMetadata.endingZoomLevel)-this.sceneMetadata.maxTileOffset),n=512*(e*Math.pow(2,this.sceneMetadata.endingZoomLevel)-this.sceneMetadata.maxTileOffset),this.sceneMetadata.projectToLatLong(i,n)[1]):J.instance.toLongitude(t,e);return e},_t.prototype.projectToX=function(t,e){e=this.sceneMetadata?(this.sceneMetadata.projectToXY(t,e)[0]+512*this.sceneMetadata.maxTileOffset)/(512*Math.pow(2,this.sceneMetadata.endingZoomLevel)):J.instance.projectToX(t,e);return e},_t.prototype.projectToY=function(t,e){e=this.sceneMetadata?(this.sceneMetadata.projectToXY(t,e)[1]+512*this.sceneMetadata.maxTileOffset)/(512*Math.pow(2,this.sceneMetadata.endingZoomLevel)):J.instance.projectToY(t,e);return e},_t.prototype.getMatrix=function(t){var e=S.identity,t=Math.round(B.wrap(this.heading-(t.heading||0),0,360));return e.rotate(t*Math.PI/180)},_t.prototype.getScale=function(t){var e,t=this.sceneMetadata?(e=t.zoom,this.sceneMetadata.minScale*Math.pow(2,this.sceneMetadata.endingZoomLevel-e)):J.instance.getScale(t);return t},_t.prototype.update=function(t,e,i,n,a){var o=t.getView().cameraLocation,r=t.getViewport(),s=!1,l=t.getMapOptions().constrainBirdseyeView,h=l&&this._getSceneBoundaryHitArgs(r,o),h={originalMetadata:this.sceneMetadata,viewport:r,constrainView:l,boundaryHitArgs:h};this._shouldUpdateScene(o,t.isPanning(),h)&&(s=!0,this.updateLocation(o,h,e,i,n,a)),!s&&i&&i()},_t.prototype.updateLocation=function(t,e,i,n,a,o){var r=e.boundaryHitArgs&&e.boundaryHitArgs.transformedCheckLocation||t,s=this._selectSceneFromCache(t,e);s?(this._deletePendingMetadataCall(),this._prevSceneMetadata=this.sceneMetadata,this.sceneMetadata=s,this.version=this.sceneMetadata.sceneId.toString(),this._lastUpdatedLocation=t,i&&i()):w.areEqual(_t.lastQueriedLocation,r,!0,this._locationQueriedPrecision)?a&&a():this._requestNewScenes(t,e,i,n,a,o)},_t.prototype.getPreviousCrs=function(){var t=new _t(this.heading,this._sceneMetadataUrl);return t.sceneMetadata=this._prevSceneMetadata,t.version=this._prevSceneMetadata&&this._prevSceneMetadata.sceneId.toString(),t},_t.prototype.getEffectiveZoomForTransition=function(t){t=F.fromLocation(t,!0);return this.sceneMetadata&&(t+=g.getDeltaZoomBetweenScenes(this._prevSceneMetadata,this.sceneMetadata),this.metadataBeforeRotation&&(t+=g.getDeltaZoomBetweenScenes(this.metadataBeforeRotation,this.sceneMetadata),this.metadataBeforeRotation=null),t=Math.max(Math.min(t,this.sceneMetadata.endingZoomLevel),18)),t},_t.prototype.getThumbnailSceneFromCache=function(t,e){for(var i,n,a,o,r,s,l,h,d=null,c=null,u=_t.metadataCache.getInternalDictionary(),p=Object.keys(u),g=Number.MAX_VALUE,_=0,m=0;m<p.length;m++)(h=u[p[m]].item)&&h.cLook===this.heading&&h.isLocationInsideScene(t)&&(i=(r=h.projectToXY(t.latitude,t.longitude))[0],n=r[1],s=Math.pow(2,h.endingZoomLevel-e),a=0<h.width%(l=512*s)&&i+l>l*Math.ceil(h.maxNumXTiles/s),o=0<h.height%l&&n+l>l*Math.ceil(h.maxNumYTiles/s),r=a||o,s=Math.pow(Math.abs(l/2-i%l),2)+Math.pow(Math.abs(l/2-n%l),2),l=Math.pow(a?h.width-i:l,2)+Math.pow(o?h.height-n:l,2),!r&&s<g?(g=s,d=h):r&&_<l&&(_=l,c=h));return d||c},_t.prototype.reset=function(){this.sceneMetadata=null,this._prevSceneMetadata=null,this._lastUpdatedLocation=null},_t.prototype._deletePendingMetadataCall=function(){var t=this._requestId;this._requestId=null,t&&R.abortRequest(t),this._sceneSelectionArgs=null},_t.prototype._selectSceneFromCache=function(e,n){var i=this,a=[],o=[],r=[],s=F.fromLocation(e,!0),l=n.originalMetadata||this.metadataBeforeRotation,h=_t.metadataCache.getInternalDictionary(),t=Object.keys(h),d=[];t.forEach(function(t){t=h[t].item;i._isCachedSceneValid(e,t,n)&&d.push(t)}),(d=this._filterScenesByProvider(d)).forEach(function(t){var e,i;l?(e=g.getDeltaZoomBetweenScenes(l,t),i=s+e,(j.getBirdseyeV2MinZoom(n.viewport,t,!1)<=i&&i<=t.endingZoomLevel&&e<0?a:Math.abs(l.minScale-t.minScale)<.02?o:r).push(t)):(!l&&Math.abs(_t.averageCachedMinScale-t.minScale)<.05?o:r).push(t)});t=n.boundaryHitArgs&&n.boundaryHitArgs.transformedCheckLocation||e,t=!w.areEqual(_t.lastQueriedLocation,t,!0,this._locationQueriedPrecision),t=0<a.length||t?a:0<o.length?o:r;return this._selectMaxPannableScene(e,t,n)},_t.prototype._requestNewScenes=function(n,t,a,o,r,e){var s=this,l=t.boundaryHitArgs&&t.boundaryHitArgs.transformedCheckLocation||n,i=l.latitude,h=l.longitude,d=i+this._queryLatLongRange,c=i-this._queryLatLongRange,i=h+this._queryLatLongRange,h=h-this._queryLatLongRange;this._deletePendingMetadataCall();var u,h=this._sceneMetadataUrl.replace("{subdomain}",Math.floor(4*Math.random()).toString()).replace("{genId}",f.dynamicProperties.birdseyeV2MetadataGenerationId).replace("{north}",d.toString()).replace("{south}",c.toString()).replace("{east}",i.toString()).replace("{west}",h.toString());this._requestId=u=R.downloadJson(h,"birdseyeV2Metadata",function(t){var e,i;if(1<t.length){for(e=t.length-1;0<e;e--)i=new g(t[e]),_t.metadataCache.addItem(i.sceneId.toString(),i);s._calculateAvgCachedMinScale(),_t.lastQueriedLocation=l,s._postSceneDownload(n,l,u,a,o,r)}else u===s._requestId&&r&&r()},function(){u===s._requestId&&(s._deletePendingMetadataCall(),e&&e())},null,null,null,!1),this._sceneSelectionArgs=t},_t.prototype._postSceneDownload=function(t,e,i,n,a,o){i===this._requestId&&(t=this._selectSceneFromCache(t,this._sceneSelectionArgs),this._deletePendingMetadataCall(),!t||this.sceneMetadata&&t.sceneId===this.sceneMetadata.sceneId?t?a&&a():o&&o():(this._prevSceneMetadata=this.sceneMetadata,this.sceneMetadata=t,this.version=this.sceneMetadata.sceneId.toString(),n&&n()))},_t.prototype._selectMaxPannableScene=function(t,e,i){var n,a,o,r,s,l=null,h=i.boundaryHitArgs;if(!i.constrainView||h.top&&h.right&&h.bottom&&h.left){for(n=Number.MAX_VALUE,a=null,o=0;o<e.length;o++){var d=e[o],c=d.projectToXY(t.latitude,t.longitude),u=c[0],p=c[1],g=Math.pow(Math.abs(u-d.width/2),2)+Math.pow(Math.abs(p-d.height/2),2);g<n&&(n=g,a=d)}l=a}else{for(r=-1,a=null,o=0;o<e.length;o++)u=(c=(d=e[o]).projectToXY(t.latitude,t.longitude))[0],p=c[1],r<(s=Math.pow(h.left?u:0,2)+Math.pow(h.right?d.width-u:0,2)+Math.pow(h.top?p:0,2)+Math.pow(h.bottom?d.height-p:0,2))&&(r=s,a=d);l=a}return l},_t.prototype._canPositionLocationInNewScene=function(t,e,i,n,a){i.projectToXY(t.latitude,t.longitude);var o=F.fromLocation(t,!0);o+=g.getDeltaZoomBetweenScenes(e,i);o=Math.max(Math.min(o,i.endingZoomLevel),j.getBirdseyeV2MinZoom(n,i,!1)),Math.pow(2,i.endingZoomLevel-o),e=a?0:this._unconstrainedViewPaddingRatio;return i.canCoverViewportWithLocation(t,a,n,e,o)},_t.prototype._shouldUpdateScene=function(t,e,i){var n=!1,a=i.constrainView,o=i.boundaryHitArgs;return n=!e&&!w.areEqual(t,this._lastUpdatedLocation,!0,this._locationUpdatedPrecision)?a?o.top||o.bottom||o.left||o.right:!this.sceneMetadata||!this.sceneMetadata.canCoverViewportWithLocation(t,a,i.viewport,this._unconstrainedViewPaddingRatio,F.fromLocation(t,!0)):n},_t.prototype._isCachedSceneValid=function(t,e,i){var n=i.originalMetadata,a=i.boundaryHitArgs,o=i.constrainView,r=i.viewport,s=e.cLook===this.heading;return(s=s?(i=n||this.metadataBeforeRotation)?this._canPositionLocationInNewScene(t,i,e,r,o):e.canCoverViewportWithLocation(t,o,r,this._unconstrainedViewPaddingRatio):s)&&n&&o&&(r=F.fromLocation(t,!0),o=Math.pow(2,this.sceneMetadata.endingZoomLevel-r),r=_t.boundaryCheckThreshold*o,o=n.projectToXY(t.latitude,t.longitude),t=e.projectToXY(t.latitude,t.longitude),s&&a.left?s=t[0]-o[0]>r:s&&a.right&&(s=e.width-t[0]-(n.width-o[0])>r),s&&a.top?s=t[1]-o[1]>r:s&&a.bottom&&(s=e.height-t[1]-(n.height-o[1])>r)),s},_t.prototype._filterScenesByProvider=function(t){var e=t.filter(function(t){return"236"===t.productId});return 0<e.length?e:t},_t.prototype._calculateAvgCachedMinScale=function(){for(var t=_t.metadataCache.getInternalDictionary(),e=Object.keys(t),i=0,n=0;n<e.length;n++)i+=t[e[n]].item.minScale;_t.averageCachedMinScale=i/e.length},_t.prototype._getSceneBoundaryHitArgs=function(t,e){var i,n,a,o,r={top:!0,bottom:!0,left:!0,right:!0};return this.sceneMetadata&&(a=e.latitude,o=e.longitude,i=F.fromLocation(e,!0),n=Math.pow(2,this.sceneMetadata.endingZoomLevel-i),e=t.pixelWidth/2*n,i=t.pixelHeight/2*n,t=_t.boundaryCheckThreshold*n,a=(n=this.sceneMetadata.projectToXY(a,o))[0]-e-t,o=this.sceneMetadata.width-(n[0]+e+t),r={top:n[1]-i-t<0,bottom:this.sceneMetadata.height-(n[1]+i+t)<0,left:a<0,right:o<0},o=[n[0],n[1]],r.left?o[0]-=e/2:r.right&&(o[0]+=e/2),r.top?o[1]-=i/2:r.bottom&&(o[1]+=i/2),n[0]===o[0]&&n[1]===o[1]||(o=this.sceneMetadata.projectToLatLong(o[0],o[1]),r.transformedCheckLocation=new w(o[0],o[1]))),r},_t.boundaryCheckThreshold=10,_t.metadataCache=new i(100),_t.averageCachedMinScale=null,_t.lastQueriedLocation=null,_t),dt=(W(gt,c=st),gt.prototype._getTileUrl=function(t){var e,i,n,a,o,r=this._placeholderTileUrl,s=t,l=s&&s.zoom,h=this.crs&&this.crs.sceneMetadata;return l&&h&&l<=h.endingZoomLevel&&18<=l&&(e=Math.pow(2,h.endingZoomLevel-l),i=Math.ceil(h.maxNumXTiles/e),n=Math.ceil(h.maxNumYTiles/e),o=Math.pow(2,l-17),a=Math.ceil((Math.pow(2,l)-o)/2),t=s.x,o=s.y,a<=t&&t<a+i&&a<=o&&o<a+n&&(l=gt.positionToQuadkey(t-a,o-a,l),r=this._tileUrlTemplate.replace("{subdomain}",l.charAt(l.length-1)).replace("{beGenId}",f.dynamicProperties.birdseyeV2ImageryGenerationId).replace("{base4SceneId}",h.base4SceneId).replace("{birdseyeV2Quadkey}",l)),this._map.getMapOptions().constrainBirdseyeView||(t===a+i-1&&h.width/e<i*s.pixelWidth&&(s.imageryWidth=h.width/e-(i-1)*s.pixelWidth),o===a+n-1&&h.height/e<n*s.pixelHeight&&(s.imageryHeight=h.height/e-(n-1)*s.pixelHeight))),r},gt.prototype.getSecondaryTile=function(){return gt._borderReplacementImage},gt.prototype.dispose=function(){gt._brImageTimeoutId&&(window.clearTimeout(gt._brImageTimeoutId),gt._brImageTimeoutId=null),gt._borderReplacementImage=null,c.prototype.dispose.call(this)},gt.positionToQuadkey=function(t,e,i){for(var n="",a=0;a<=i-18;a++)n=(1&t)+2*(1&e)+n,t>>=1,e>>=1;return n},gt.prototype._instantiateBorderReplacementImage=function(){var e,t;gt._borderReplacementImage||(e=document.createElement("img"),t=function(t){t&&(e.onload=null,window.clearTimeout(gt._brImageTimeoutId),gt._brImageTimeoutId=null,gt._borderReplacementImage=e)},gt._brImageTimeoutId||(gt._brImageTimeoutId=Microsoft.Maps.setTimeout(function(){return t(!1)},5e3),e.onload=function(){t(!0)},e.src=this._placeholderTileUrl))},gt._tileSize=512,gt._borderReplacementImage=null,gt),ct=(pt.prototype.dispose=function(){ht.lastQueriedLocation=null,ht.metadataCache.clear(),this._savedTransientLensActionList=null,y._clearDisposables(this._disposables),this._tempHiddenLayers=[]},pt.prototype.onMapTypeChanged=function(t){t.newMapTypeId===T.birdseyeV2?this._onActivated(t.oldMapTypeId):t.oldMapTypeId===T.birdseyeV2&&this._onDeactivated(t.newMapTypeId)},pt.prototype.addContextPoi=function(t,e,i){var n=this,a=new P(t,{id:"BirdseyeV2ContextPoi",title:e,collisionBehavior:2});a.bucket="999998",a.taskDisplayState={activationState:1,colorIndex:i,prominence:1},a.viewState=2,this._contextLayer?((i=this._contextLayer.getDataSource()).clear(),a.layer=this._contextLayer,i.addPrimitive(a),this._map.getLayers().indexOf(this._contextLayer)<0&&this._map.getLayers().insert(this._contextLayer)):this._map.getContainer().instanceAsync("ListDataSource",function(e){e.addPrimitive(a),n._map.getContainer().instanceAsync("XsrPoiTemplateSelector",function(t){n._map.getLayers().remove(n._contextLayer),n._contextLayer=new A(pt._contextLayerId,e,t,1e4),n._contextLayer.setRenderTarget(1),a.layer=n._contextLayer,n._map.getLayers().insert(n._contextLayer)})})},pt.prototype._onActivated=function(e){var t,i=this;this._activated||(this._activated=!0,this._lastProductId=null,t=this._map.getView(),e!==T.streetside&&(this.previousMapState.mapTypeId=e,this.previousMapState.altitude=t.cameraLocation.altitude,this._map.navigationBarLoaded.addOne(function(){var t;i._map.getMapType().id===T.birdseyeV2&&((t=i._map.getNavigationBar().getHelper()).updateNavBarForBirdseyeV2(!0),null!==e&&t.handleLabelsVisibleOnMapTypeChanged())},!1,!0),f.isMapsVertical&&(this._map.getContainer().instanceAsync("TransientLens",function(t){var e;i._map.getMapType().id===T.birdseyeV2&&(i._savedTransientLensActionList=t.getViewModel().actionList,(e=u&&u.Internal&&u.Internal.TransientLensActions)&&(t.getViewModel().actionList=[e.Streetside]))}),this._map.getContainer().instanceAsync("TaskBar",function(t){var e;i._map.getMapType().id===T.birdseyeV2&&(e=t.fullScreenEnabled?256:0,t.setActionsOptions(8|e))}),o(".MicrosoftMap .taskLayoutContainer").add_class("hideTaskLayout"),o(".toggleButton").add_class("hideTaskLayout"),this._hideMapLayers(),sj_evt.fire("HideContextualTaskbar")),f.isMapsAnswer&&y._showOrHideOverlayMenu(!1)))},pt.prototype._onDeactivated=function(i){var t,e,n=this;this._activated&&(pt.approxAltitude=null,t=this._map.getView(),i!==T.streetside?(this.previousMapState.altitude?t.cameraLocation.altitude=this.previousMapState.altitude:(e=F.toLocation(t.cameraLocation,this._map.getMercatorZoomLevel()-1,!0),t=new x(e,0)),this._map.setView(t,null,0,!0),this._map.navigationBarLoaded.addOne(function(){n._map.getNavigationBar().getHelper().updateNavBarForBirdseyeV2(!1)},!1,!0),f.isMapsVertical&&(this._savedTransientLensActionList&&this._map.getContainer().instanceAsync("TransientLens",function(t){t.getViewModel().actionList=n._savedTransientLensActionList}),this._map.getContainer().instanceAsync("TaskBar",function(t){var e=t.fullScreenEnabled?256:0;t.setActionsOptions(i===T.streetside?24|e:1023)}),o(".MicrosoftMap .taskLayoutContainer").remove_class("hideTaskLayout"),o(".toggleButton").remove_class("hideTaskLayout"),this._showMapLayers(),this._map.getLayers().remove(this._contextLayer),y._getIsSlideCardEnabled()?sj_evt.fire("ShowContextualTaskbar"):sj_evt.fire("BirdsEyeDeactivated")),f.isMapsAnswer&&this.previousMapState.mapTypeId!==T.streetside&&y._showOrHideOverlayMenu(!0)):this.previousMapState.birdseyeV2Heading=t.heading,this._activated=!1)},pt.prototype.onCrsUpdate=function(t,e){t=t.getCurrentCrs();2===e?this._onCrsUpdateFailed(t):1===e?pt.constrainViewOnUpdateCrs(this._map,t,!!t.metadataBeforeRotation):(pt.updateApproxAltitude(this._map.getView().cameraLocation,t),pt.constrainViewOnUpdateCrs(this._map,t,!0),this._map.copyrightChanged.invoke(),(t=(t=this._map.getNavigationBar())&&t.getHelper())&&t.updateLabelToggleForBirdseyeV2(null,!0))},pt.prototype._onCrsUpdateFailed=function(t){var e=this,t=t.sceneMetadata;t?t.isLocationInsideScene(this._map.getView().cameraLocation)||(t=(t=this._map.getNavigationBar())&&t.getHelper())&&t.showBirdseyeV2NotAvailableTip(!1):this._map.getBirdseyeV2Manager().then(function(t){t=e._map.getMapTypes()[t.previousMapState.mapTypeId||T.road];t&&e._map.setBaseLayers(t)})},pt.prototype._hideMapLayers=function(){for(var t,e=this._map.getLayers(),i=e.length-1;0<=i;i--)(t=e[i])instanceof A&&t.getId()!==pt._contextLayerId&&(this._map.getLayers().remove(t),this._tempHiddenLayers.indexOf(t)<0&&this._tempHiddenLayers.push(t))},pt.prototype._showMapLayers=function(){for(var t,e=this._tempHiddenLayers.length-1;0<=e;e--)(t=this._tempHiddenLayers[e]).getFrameManager()&&this._map.getLayers().indexOf(t)<0&&this._map.getLayers().insert(t);this._tempHiddenLayers=[]},pt.prototype.getUpdatedProductId=function(t){var e=null,t=t.sceneMetadata;return t&&t.productId!==this._lastProductId&&(e=t.productId,this._lastProductId=e),e},pt.hideLayersForSDKMap=function(t){for(var e,i,n=t.hiddenLayerArgsInBEv2||[],a=Microsoft.Maps.TileLayer,o=Microsoft.Maps.DataBinningLayer,r=Microsoft.Maps.CustomOverlay,s=t.layers.length-1;0<=s;s--)e=t.layers[s],r&&e instanceof r&&!e.getOptions().showInBirdseye?(1===(i=e.getAnimationState&&e.getAnimationState())&&e.pause&&e.pause(),n.push({layer:e,index:s,animationState:i}),t.layers.remove(e)):(a&&e instanceof a||o&&e instanceof o)&&e.getVisible()&&(n.push({layer:e,index:-1}),e.setVisible(!1));t.hiddenLayerArgsInBEv2=n},pt.showLayersForSDKMap=function(a){for(var o=a.hiddenLayerArgsInBEv2||[],t=o.length-1;0<=t;t--)!function(t){var e,i=o[t],n=i.index;0<=n?(t=a.layers.length,e=t<n?t:n,Microsoft.Maps.setTimeout(function(){a.layers.insert(i.layer,e),1===i.animationState&&i.layer.play()},1)):i.layer.setVisible(!0)}(t);a.hiddenLayerArgsInBEv2=null},pt.hideSDKLayersDuringTransition=function(t){var e,i,n=t.getLayers(),a=Microsoft.Maps.Layer,o=[];if(a)for(e=0;e<n.length;e++)(i=n[e])instanceof a&&i.getVisible()&&(i.setVisible(!1),o.push(i));0<o.length&&t.birdseyeV2SceneTransitioned.addOne(function(){o.forEach(function(t){t.setVisible(!0)})})},pt.updateApproxAltitude=function(s,e){var t,l=[],h=[],i=ht.metadataCache.getInternalDictionary();Object.keys(i).forEach(function(t){t=i[t].item;e.sceneMetadata&&t.productId!==e.sceneMetadata.productId||function(t){for(var e,i,n,a,o=0,r=[t.topLeftCorner,t.topRightCorner,t.bottomLeftCorner,t.bottomRightCorner];o<r.length;o++)if(e=r[o],i=Math.pow(s.latitude-e.latitude,2)+Math.pow(s.longitude-e.longitude,2),0===l.length)l.push(i),h.push(e.altitude);else for(n=0;n<l.length;n++)if((a=l[n])<i||n===l.length-1){(0<n||n===l.length-1)&&(a=n===l.length-1&&i<a?n+1:n,l.splice(a,0,i),h.splice(a,0,e.altitude),4<l.length&&(l.splice(0,1),h.splice(0,1)));break}}(t)}),t=h.reduce(function(t,e){return t+e},0)/h.length,pt.approxAltitude=t},pt.constrainViewOnUpdateCrs=function(t,e,i){var n=t.getViewport(),a=t.getView(),o=a.cameraLocation,r=o.altitude;i&&(o.altitude=F.toAltitude(o,e.getEffectiveZoomForTransition(o),!0)),!j.enforceMinZoom(t,a,!0)&&r===o.altitude||t.mapZoomChanged.invoke(),t.getMapOptions().constrainBirdseyeView&&j.constrainBirdseyeV2LatLong(t,e,new D(n.pixelWidth,n.pixelHeight),a)},pt.getIsBirdseyeV2Available=function(t,e,i,n,a){t.birdseyeV2MetadataUrl?(i=g.normalizeHeading(i),new ht(i,t.birdseyeV2MetadataUrl).updateLocation(e,{originalMetadata:null,viewport:a,constrainView:!1,boundaryHitArgs:{top:!0,bottom:!0,left:!0,right:!0}},function(){n&&n(!0)},function(){n&&n(!1)},function(){n&&n(!1)},function(){n&&n(!1)})):n&&n(!1)},pt.getBirdseyeV2Thumbnail=function(i,n,a,o,t,e){var r,s=null;i.birdseyeV2MetadataUrl?(r=g.normalizeHeading(t),pt.getIsBirdseyeV2Available(i,n,r,function(t){var e;t&&(e=new ht(r,i.birdseyeV2MetadataUrl),0<(t=i.mapTypeDefinitions.filter(function(t){return t.mapType===T.birdseyeV2})).length&&t[0].data&&t[0].data[0]&&((t=(t=t[0].data[0]).imageryScenes&&0<t.imageryScenes.length&&t.imageryScenes[0])&&(e=e.getThumbnailSceneFromCache(n,a),s=pt._getThumbnailUrl(n,e,a,t)))),o&&o(s)},e)):o&&o(s)},pt._getThumbnailUrl=function(t,e,i,n){var a,o,r=null;return e&&(a=e.projectToXY(t.latitude,t.longitude),o=Math.max(Math.min(a[0],e.width),0),t=Math.max(Math.min(a[1],e.height),0),a=Math.max(Math.min(e.endingZoomLevel,i),18),i=512*Math.pow(2,e.endingZoomLevel-a),(o=Math.floor(o/i))===Math.ceil(e.width/i)-1&&e.width%i!=0&&(o=Math.max(o-1,0)),i=512*Math.pow(2,e.endingZoomLevel-a),(t=Math.floor(t/i))===Math.ceil(e.height/i)-1&&e.height%i!=0&&(t=Math.max(t-1,0)),a=dt.positionToQuadkey(o,t,a),r=y._updateTfeUrlDomain(n.tileUrlWithoutLabel).replace("{subdomain}",a.charAt(a.length-1)).replace("{tileUrlParam}",n.tileUrlParam).replace("{tileUrlWithoutLabelParam}",n.tileUrlWithoutLabelParam).replace("{beGenId}",f.dynamicProperties.birdseyeV2ImageryGenerationId).replace("{base4SceneId}",e.base4SceneId).replace("{birdseyeV2Quadkey}",a)),r},pt._contextLayerId="BirdseyeV2ContextLayer",pt);(e=lt=lt||{})[e.north=0]="north",e[e.east=90]="east",e[e.south=180]="south",e[e.west=270]="west",e[e.North=0]="North",e[e.East=90]="East",e[e.South=180]="South",e[e.West=270]="West",(t=p=p||{})[t.V1=0]="V1",t[t.V2=1]="V2",ut.prototype.projectToXY=function(t,e){var i,n,a=[],o=this.gtpMatrix;return this.version===p.V2?(i=[-((n=this._latLongtoEcc(t,e))[0]-this.ecc.x),n[1]-this.ecc.y,n[2]-this.ecc.z],i=(n=[o[0]*i[2]+o[1]*i[0]+o[2]*i[1],o[3]*i[2]+o[4]*i[0]+o[5]*i[1],o[6]*i[2]+o[7]*i[0]+o[8]*i[1]])[0]/n[1]*this.focalLength,n=-(n[2]/n[1]*this.focalLength),i=this.rawSceneWidth/2+i-this.sceneWidthOffset,n=this.originalHeight/2+n,i*=this.imageScaleFactor,n*=this.imageScaleFactor,a=[i,n=this.height-n]):this.version===p.V1&&(i=(t=B.matrixMultiply([[o[0],o[1],o[2]],[o[3],o[4],o[5]],[o[6],o[7],o[8]]],[[e],[t],[1]]))[0][0]/t[2][0],n=t[1][0]/t[2][0],a=[i+this._v1PixelOffsetX,n+this._v1PixelOffsetY]),a},ut.prototype.projectToLatLong=function(t,e){var i,n,a,o,r,s,l,h,d,c,u=[];return this.version===p.V2?(e=this.height-e,t/=this.imageScaleFactor,e/=this.imageScaleFactor,d=t=t+this.sceneWidthOffset-this.rawSceneWidth/2,i=e-=this.originalHeight/2,n=this.focalLength,a=this.gtpMatrix,c=this.ecc,o=this._getCurrentAltitude()*this.altitudeScaleFactor-c.z,r=n*a[1]-d*a[4],s=d*a[5]-n*a[2],l=n*o*a[0]+n*a[1]*c.x-n*a[2]*c.y-d*o*a[3]-d*c.x*a[4]+d*c.y*a[5],h=-i*a[4]-n*a[7],d=i*a[5]+n*a[8],c=n*a[8]*c.y-n*o*a[6]-n*a[7]*c.x+i*a[5]*c.y-o*a[3]*i-i*a[4]*c.x,u=this._eccToLatLong((l*d-s*c)/(r*d-s*h),(l*h-r*c)/(s*h-r*d))):this.version===p.V1&&(t=[[t-this._v1PixelOffsetX],[e-this._v1PixelOffsetY],[1]],e=this.ptgMatrix,t=(e=B.matrixMultiply([[e[0],e[1],e[2]],[e[3],e[4],e[5]],[e[6],e[7],e[8]]],t))[0][0]/e[2][0],u=[e[1][0]/e[2][0],t]),u},ut.prototype.isLocationInsideScene=function(t){var e=this.projectToXY(t.latitude,t.longitude),t=!1;return t=0<e[0]&&e[0]<this.width&&0<e[1]&&e[1]<this.height?!0:t},ut.prototype.canCoverViewportWithLocation=function(t,e,i,n,a){var o,r;return i?(o=(o=a)||j.getBirdseyeV2AdjustedZoom(t,i,this,e,!0,!0),r=Math.pow(2,this.endingZoomLevel-o),e=(a=this.projectToXY(t.latitude,t.longitude))[0],o=a[1],a=i.pixelWidth*(.5-n)*r,r=i.pixelHeight*(.5-n)*r,a<e&&e<this.width-a&&r<o&&o<this.height-r):this.isLocationInsideScene(t)},ut.prototype.getBoundsRectangle=function(){return I.fromPoints(new V(this.topLeftCorner.longitude,this.topLeftCorner.latitude),new V(this.topRightCorner.longitude,this.topRightCorner.latitude),new V(this.bottomLeftCorner.longitude,this.bottomLeftCorner.latitude),new V(this.bottomRightCorner.longitude,this.bottomRightCorner.latitude))},ut.getDeltaZoomBetweenScenes=function(t,e){var i=0;return i=t&&e?Math.round(B.log2(e.minScale/t.minScale)):i},ut.normalizeHeading=function(t){t=(t||0)%360;return t<0&&(t+=360),t},ut.prototype._calculatePixelOffset=function(){var t,e,i,n,a,o;this.version===p.V1&&(e=t=0,i=this.projectToXY(this.topLeftCorner.latitude,this.topLeftCorner.longitude),n=this.projectToXY(this.topRightCorner.latitude,this.topRightCorner.longitude),a=this.projectToXY(this.bottomLeftCorner.latitude,this.bottomLeftCorner.longitude),o=this.projectToXY(this.bottomRightCorner.latitude,this.bottomRightCorner.longitude),t+=2*this.width-(i[0]+n[0]+a[0]+o[0]),e+=2*this.height-(i[1]+n[1]+a[1]+o[1]),this._v1PixelOffsetX=t/4,this._v1PixelOffsetY=e/4)},ut.prototype._latLongtoEcc=function(t,e){e=(e+180)/360*256*Math.pow(2,23),t=Math.sin(t*Math.PI/180);return[e,256*(.5-Math.log((1+t)/(1-t))/(4*Math.PI))*Math.pow(2,23),this._getCurrentAltitude()*this.altitudeScaleFactor]},ut.prototype._eccToLatLong=function(t,e){t=360*t/(256*Math.pow(2,23))-180,e=Math.pow(Math.E,4*(.5-e/(256*Math.pow(2,23)))*Math.PI);return[180*Math.asin((e-1)/(e+1))/Math.PI,t]},ut.prototype._getCurrentAltitude=function(){var t=ct.approxAltitude;return t&&20<Math.abs(t-this.avgAltitude)?t:this.avgAltitude},ut.prototype._calculateMinScale=function(){var t,e,i,n=this.cLook===lt.north||this.cLook===lt.south,a=n?this.height:this.width,o=n?this.width:this.height,o=n?(t=Math.abs(b.latitudeDegreesToMeters(this.topLeftCorner.latitude)-b.latitudeDegreesToMeters(this.bottomLeftCorner.latitude))/a,e=Math.abs(b.latitudeDegreesToMeters(this.topRightCorner.latitude)-b.latitudeDegreesToMeters(this.bottomRightCorner.latitude))/a,i=Math.abs(b.longitudeDegreesToMeters(this.topLeftCorner.longitude)-b.longitudeDegreesToMeters(this.topRightCorner.longitude))/o,Math.abs(b.longitudeDegreesToMeters(this.bottomLeftCorner.longitude)-b.longitudeDegreesToMeters(this.bottomRightCorner.longitude))/o):(t=Math.abs(b.latitudeDegreesToMeters(this.topRightCorner.latitude)-b.latitudeDegreesToMeters(this.topLeftCorner.latitude))/a,e=Math.abs(b.latitudeDegreesToMeters(this.bottomRightCorner.latitude)-b.latitudeDegreesToMeters(this.bottomLeftCorner.latitude))/a,i=Math.abs(b.longitudeDegreesToMeters(this.bottomRightCorner.longitude)-b.longitudeDegreesToMeters(this.topRightCorner.longitude))/o,Math.abs(b.longitudeDegreesToMeters(this.bottomLeftCorner.longitude)-b.longitudeDegreesToMeters(this.topLeftCorner.longitude))/o);return(t+e+i+o)/4},ut.prototype._getHeading=function(t){var e;switch(t){case"E":e=lt.east;break;case"S":e=lt.south;break;case"W":e=lt.west;break;default:e=lt.north}return e},ut.prototype._getCameraType=function(t){var e;switch(t){case 2:e=1;break;case 3:e=2;break;case 4:e=3;break;case 5:e=4;break;case 6:e=5;break;case 7:e=6;break;default:e=0}return e},g=ut,u.Heading=lt,u.BirdseyeV2Crs=ht,u.BirdseyeV2Manager=ct,u.BirdseyeV2Metadata=g,u.BirdseyeV2ImageryScene=dt}catch(t){if(!u.logger)throw t;u.logger.logCriticalError(t)}function ut(t){this.cameraLocation=new w(0,0,0),this.width=0,this.height=0,this.originalWidth=0,this.originalHeight=0,this.imageScaleFactor=1,this.topLeftCorner=new w(0,0,0),this.topRightCorner=new w(0,0,0),this.bottomLeftCorner=new w(0,0,0),this.bottomRightCorner=new w(0,0,0),this.gtpMatrix=[0,0,0,0,0,0,0,0,0],this.ptgMatrix=[0,0,0,0,0,0,0,0,0],this.ecc=new V(0,0,0),0===t.ver?this.version=p.V1:this.version=p.V2,this.sceneId=t.id;var e=this.sceneId.toString(4);this.base4SceneId="000000000000000".substr(0,15-e.length)+e,this.productId=t.pids&&t.pids.join(",")||"",this.version===p.V2&&(this.cameraType=this._getCameraType(t.cam),t.camlla&&3===t.camlla.length&&(this.cameraLocation=new w(t.camlla[0],t.camlla[1],t.camlla[2]))),this.cLook=this._getHeading(t.clook),this.look=t.look,this.focalLength=t.fl,this.frameNumber=t.fra,t.size&&2===t.size.length&&t.osize&&2===t.osize.length&&(this.width=t.size[0],this.height=t.size[1],this.originalWidth=t.osize[0],this.originalHeight=t.osize[1],this.imageScaleFactor=this.width/this.originalWidth),this.endingZoomLevel=Math.min(22,18+Math.ceil(B.log2(Math.max(this.width/512,this.height/512)))-1),this.maxNumXTiles=Math.ceil(this.width/512),this.maxNumYTiles=Math.ceil(this.height/512),t.ullla&&3===t.ullla.length&&t.urlla&&3===t.urlla.length&&t.lllla&&3===t.lllla.length&&t.lrlla&&3===t.lrlla.length&&(this.topLeftCorner=new w(t.ullla[0],t.ullla[1],t.ullla[2]),this.topRightCorner=new w(t.urlla[0],t.urlla[1],t.urlla[2]),this.bottomLeftCorner=new w(t.lllla[0],t.lllla[1],t.lllla[2]),this.bottomRightCorner=new w(t.lrlla[0],t.lrlla[1],t.lrlla[2])),this.avgAltitude=(this.topLeftCorner.altitude+this.topRightCorner.altitude+this.bottomLeftCorner.altitude+this.bottomRightCorner.altitude)/4,this.centerLocation=new w(t.la,t.lo,t.al),this.gtpMatrix=t.gtp,this.ptgMatrix=t.ptg,t.ecc&&3===t.ecc.length&&(this.ecc=new V(t.ecc[0],t.ecc[1],t.ecc[2])),this.maxTileOffset=(Math.pow(2,this.endingZoomLevel)-Math.pow(2,this.endingZoomLevel-17))/2,this.minScale=this._calculateMinScale(),this.version===p.V2&&(this.altitudeScaleFactor=this.ecc.z/this.cameraLocation.altitude,this.rawSceneWidth=this.originalWidth,this.sceneWidthOffset=0,5!==this.cameraType&&6!==this.cameraType&&6870===this.originalWidth&&(this.rawSceneWidth=13450,2!==this.cameraType&&3!==this.cameraType||(this.sceneWidthOffset=this.rawSceneWidth-this.originalWidth))),this._v1PixelOffsetX=0,this._v1PixelOffsetY=0,this._calculatePixelOffset()}function pt(t){var e=this;this._map=t,this._disposables=[],this._disposables.push(this._map.mapTypeChanged.add(function(t){e.onMapTypeChanged(t)})),(f.isMapsVertical||f.isMapsAnswer)&&this._disposables.push(this._map.getLayers().changed.add(function(t){e._map.getMapType().id===T.birdseyeV2&&t.added&&0<t.added.length&&e._hideMapLayers()})),this._activated=!1,this._tempHiddenLayers=[],this.previousMapState={mapTypeId:null,altitude:null,birdseyeV2Heading:null}}function gt(t,e,i,n,a,o,r,s,l,h,d){d=c.call(this,t,e,i,n,a,o,r,s,l,h,d,gt._tileSize)||this;return d._placeholderTileUrl=d._map.getConfig().birdseyeV2PlaceHolderTileUrl,d._map.getMapOptions().constrainBirdseyeView||d._instantiateBorderReplacementImage(),d}function _t(t,e,i){this._queryLatLongRange=.1,this._unconstrainedViewPaddingRatio=.15,this._locationUpdatedPrecision=1e-6,this._locationQueriedPrecision=1e-4,this._sceneMetadataUrl=y._updateTfeUrlDomain(e),this.id="BirdseyeV2_"+t.toString(),this.bounds=[0,1,1,0],this.heading=t,i&&(this._unconstrainedViewPaddingRatio=Math.max(Math.min(i,.5),0));i=y._getUrlParam(window.location,"bev2transitionpadding"),i=i&&parseFloat(i);"number"!=typeof i||isNaN(i)||(this._unconstrainedViewPaddingRatio=Math.max(Math.min(i,.5),0))}function mt(t,e,i,n,a,o,r,s,l,h,d,c){void 0===c&&(c=256),this._tileRequestFailedCount=0,this._maxFailureForFailover=10,this._cacheTimeOffset=-1,this._sceneRequetId=0,this._totalTilesCount=0,this._pendingTilesCount=0,this._failedTilesCount=0,this._map=t,this._coreConfig=y._getCoreConfig(),this.nativeView=e,this.crs=i,this.imageryId=n,this.copyrightProvider=r,this._tileUrlTemplate=a,this._activeTileTemplate=a,this._tileFeatures=o,this._customMapStyleManager=h,this.downloadTimeOut=d,this._disposables=[],this._useTFEAuthentication="undefined"==typeof TileSource||!(this instanceof TileSource),this._tileSize=c,this._disposables.push(this.tileUrlTemplateChanged=new v),this._pendingRequest={},t&&this._subscribeToTileChangeEvents(t,a,s,o,l),this._updateGlobalTileUrlTemplateParam()}function ft(){this._index=new ot}function yt(){}function vt(t){var e=this;this.graceRadiusForMouse=0,this._mapEvents=[],this._registeredJsEvents={},this._enableHitTesting=!0,this._hitTestComponents=[],this._mapEvents.push(t.viewChanging.add(function(){return e._enableHitTesting=!1})),this._mapEvents.push(t.viewChanged.add(function(){return e._enableHitTesting=!0}))}function Lt(t,e){this._mostRecentElevationRequest=0,this.id="EnhancedBirdseye"+t,this.bounds=[0,1,1,0],this._elevationServiceUrl=e,this.heading=t}function Ct(t,e){this.boundingBox=t,this._url=e}function Mt(t,e,i,n,a){this.allowBoxZoom=!0,a&&"string"!=typeof a||(a=("Robinson"===a?$:J).instance),m.assertNotNull(t,"map"),m.assert(a&&a.bounds&&4===a.bounds.length&&0===a.bounds[0]&&1===a.bounds[1]&&1===a.bounds[2]&&0===a.bounds[3],"Only supports cube based CRSs currently"),this._map=t,this._allLayers=e,this._canvasDrawingContextFactory=n,this._hitTestController=i,this._hitTestController.startHitTesting(this._map.getRootElement()),this._disposables=[],this.mapModeType=0,this.onFrameRendered=new v,this.onFrameFailed=new v,this.onPaint=new v}function wt(){}function bt(){if(bt.instance)return bt.instance;this.id="Robinson",this.bounds=[0,1,1,0],this._latitudeLengths=[1,.9986,.9954,.99,.9822,.973,.96,.9427,.9216,.8962,.8679,.835,.7986,.7597,.7186,.6732,.6213,.5722,.5322],this._latitudeOffsets=[0,.062,.124,.186,.248,.31,.372,.434,.4958,.5571,.6176,.6769,.7346,.7903,.8435,.8936,.9394,.9761,1];for(var t=0,e=this._latitudeOffsets.length;t<e;t++)this._latitudeOffsets[t]*=.5072}function Tt(){}function xt(){if(xt.instance)return xt.instance;this.id="Mercator",this.bounds=[0,1,1,0]}function St(t,e,i,n){if(t<0)throw new Error("Viewport.ctor - pixelWidth cannot be less than zero");if(e<0)throw new Error("Viewport.ctor - pixelHeight cannot be less than zero");this.pixelWidth=t,this.pixelHeight=e,this.bounds=i,this.crs=n;var a=(Math.abs((n.bounds[1]-n.bounds[3])/(i[1]-i[3]))*t-t)/2,i=(Math.abs((n.bounds[2]-n.bounds[0])/(i[2]-i[0]))*e-e)/2;this._min_x=-a,this._max_x=t+a,this._min_y=-i,this._max_y=e+i}function Rt(t,e,i,n){this._sortedRenderers=[],this._compositeMapMode=t,this._map=e,this._canvasDrawingContextFactory=i,this._currentImageryLayers={},this._currentVectorLayers={},this._layersEventHandlers={},this._hitTestController=n,this._sortedCurrentVectorLayer=[],this._disposables=[],this._initialize()}function Vt(t,e,i,n,a){var o=r.call(this,t,e,i.getZIndex(),i.getId(),n,i)||this;return o._coreConfig=a,o._layer=i,o._disposables.push(i.layerInvalidated.add(function(){o._renderedFrameNumber=-1})),o._disposables.push(i.changed.add(function(t){return o._onLayerChanged(t)})),o._renderedFrameNumber=-1,o._devicePixelRatio=n,o._disposables.push(o.onCritialRenderingCompleted=new v),o}function It(t,e,i,n,a,o,r){var s=l.call(this,e,i,10100,a||It._vectorCanvasId,o,null,r,!0)||this;return s.hitTestPriority=2,s._sortedVectorLayers=n,s._revisionNumber=0,t.instanceAsync("HitTestingDrawingContext",function(t){s._hitTestingCanvasDrawingContext=t}),s}function Pt(t,e,i,n){this._disposables=[],this._map=t,this._disableHachHackSetFrame=t.getConfig().disableHachHackSetFrame,this._compositeMapMode=e,this._sortedRenderers=n,this.onPaint=new v,this._initialize(i)}function Dt(t,e,i,n,a,o,r,s){var l=this;this._disposables=[],this._dpr=a,this._canvasId=n,t&&(this._canvasFactory=t,s||this._createCanvas()),this._currentTransformationOrigin="top left",this._currentOpacity=o?o.getOpacity():1,this.zIndex=i,this._currentPercentOpacity=100,this._imageryMapLayer=o,this._parentElement=e,o&&o.isCritical?o.onCriticalDataLoaded().then(function(){l._isDisposed||l._setupCanvas(r)}):this._setupCanvas(r)}function Et(){}}.call(window);
