!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("wafer-action",[],e):"object"==typeof exports?exports["wafer-action"]=e():(t.wafer=t.wafer||{},t.wafer.wafers=t.wafer.wafers||{},t.wafer.wafers["wafer-action"]=e())}("undefined"!=typeof self?self:this,function(){return o={"./src/base.js":function(t,e,o){"use strict";function h(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}Object.defineProperty(e,"__esModule",{value:!0});var c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},m=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var o,r=arguments[e];for(o in r)Object.prototype.hasOwnProperty.call(r,o)&&(t[o]=r[o])}return t},v=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var o=[],r=!0,n=!1,i=void 0;try{for(var a,s=t[Symbol.iterator]();!(r=(a=s.next()).done)&&(o.push(a.value),!e||o.length!==e);r=!0);}catch(t){n=!0,i=t}finally{try{!r&&s.return&&s.return()}finally{if(n)throw i}}return o}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},r=function(t,e,o){return e&&l(t.prototype,e),o&&l(t,o),t},g=[],n=window.wafer,i=n.constants,a=n.features,s=n.utils,n=n.WaferBaseClass,y=s.fetchWithCache,w=i.ATTR_PREFIX,_=["handleClick"],S="wafer-action-is-true",k={block:-1,unblock:0},u=void 0,T="publisher",r=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(O,n),r(O,[{key:"statusDidUpdate",value:function(t){var e,o,r=this._util.elem;r&&(e=(o=this._util).falseLabel,o=o.trueLabel,(this._state.actionStatus=t)?(e&&r.setAttribute("title",e),r.classList.add(S)):(o&&r.setAttribute("title",o),r.classList.remove(S)))}},{key:"saveToStorage",value:function(){if(a.localStorage){var t=this._util,e=t.id,o=t.name,r=void 0===o?"":o,n=t.subType,o=t.type,t=Date.now()+9e5;return window.localStorage.setItem(O.LS_KEY,JSON.stringify({id:e,name:r,subType:n,ttl:t,type:o})),Promise.resolve()}}},{key:"triggerTopicAction",value:function(t){var e=this._util,o=e.appId,r=e.bookmarkActionHost,n=e.contentId,i=e.id,a=e.name,s=e.shouldSaveToStorage,c=e.subType,u=e.subTypeCategroy,l=e.title,f=e.type,p=this._util.apiPath,d={follow:this._state.actionStatus?"PUT":"DELETE",block:"POST",bookmark:this._state.actionStatus?"POST":"DELETE"}[f],b=void 0,e=void 0;return"follow"===f&&(b={types:h({},c,[{id:i}])},e={Crumb:t},"provider"===c&&(b.types[c][0].type=u||"PROVIDER")),"block"===f&&(b={entities:[{entity_id:i,entity_type:c,score:k[this._state.actionStatus?"block":"unblock"]}]},e={Crumb:t},c===T&&(b.entities[0].entity_name=a)),"bookmark"===f&&("DELETE"===d?p=r+"api/v1/user/bookmarks/"+c+"/"+n+"?appId="+o:(p=r+"api/v1/user/bookmarks/"+c+"?appId="+o,b={contentId:n,title:l}),e={"X-CSRF-Token":t}),s?this.saveToStorage():y(p,{cache:0,clientHeaders:e,credentials:"include",method:d,body:JSON.stringify(b)})}},{key:"getCrumb",value:function(){var t=this._util.shouldSaveToStorage,e=this._util.crumb||u;if(e||t)return new Promise(function(t){t(e||"")});var o=this._util,r=o.appId,t=o.actionHost,o=o.bookmarkActionHost;return y((o||t)+"api/v1/auth/crumb?appId="+r,{cache:0,credentials:"include"}).then(function(t){if(!(u=t.crumb))throw new Error("crumb not found");return u})}},{key:"trigger",value:function(t){var e,a=this;t&&((e=t.crumb)&&(u=e),this._util=m({},this._util,t));var s=this._util.name,t=this._state.actionStatus;this._state.inProgress=!0,t?this.setActionStatus(!1):this.setActionStatus(!0),this.getCrumb().then(function(t){return a._state.inProgress=!1,a.triggerTopicAction(t)}).then(function(t){var e=(t||{}).result,o=(void 0===e?{}:e).success,r=(void 0===o?{}:o).entities,n=void 0===r?[]:r,e=a._util,i=e.id,o=e.subType,r=e.type,e="follow"===r&&n.some(function(t){return t.id===i}),n="block"===r&&null!==t&&"object"===(void 0===t?"undefined":c(t)),t="bookmark"===r&&null!==t&&"object"===(void 0===t?"undefined":c(t));if(!("follow"===r?e:"block"===r?n:t))throw new Error("action failed");a.didComplete(null,{id:i,name:s,subType:o,type:r})}).catch(function(t){a._state.inProgress=!1,a._state.actionStatus=!a._state.actionStatus,a.setActionStatus(a._state.actionStatus)})}},{key:"handleClick",value:function(t){t.preventDefault(),this._state.inProgress||this.trigger()}}]),O);function O(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},o=e.appId,r=e.actionHost,n=e.bookmarkActionHost,i=e.crumb,a=e.id,s=e.name,c=e.selector,u=e.shouldSaveToStorage,l=e.subType,f=e.type;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,O);var p=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(O.__proto__||Object.getPrototypeOf(O)).call(this,t,{selector:c},{STATE_ATTRS:g})),o=t.getAttribute(w+"app-id")||o,i=t.getAttribute(w+"crumb")||i,d=t.getAttribute(w+"action-type")||f||"follow",b=t.getAttribute(w+"action-sub-type")||l,y=t.getAttribute(w+"action-sub-type-category")||"",e=t.getAttribute(w+"action-id")||a,c=t.getAttribute(w+"action-contentId")||"",f=t.getAttribute(w+"action-label"),l=t.getAttribute(w+"action-name")||s,a=f&&f.split("|")||[],s=v(a,2),f=s[0],a=s[1],s=t.getAttribute(w+"action-title")||"";return p._util=m({},p._util,(h(l={actionHost:r,apiPath:{follow:r+"api/v3/topics?appId="+o,block:r+"api/v1/content/feedback/"+(b===T?T:"entities")+"?appId="+o}[d],appId:o,bookmarkActionHost:n,subType:b,contentId:c,crumb:i,elem:t,falseLabel:a,id:e,mappingId:e+d+b+y,subTypeCategroy:y,shouldSaveToStorage:void 0===u?void 0:!!u,name:l},"subType",b),h(l,"title",s),h(l,"trueLabel",f),h(l,"type",d),l)),_.forEach(function(t){p[t]=p[t].bind(p)}),p._state={actionStatus:!1,inProgress:!1},t.classList.add("has-click","has-wafer-click"),setTimeout(function(){p.setActionStatus(t.classList.contains(S))},0),p}function l(t,e){for(var o=0;o<e.length;o++){var r=e[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}r.events={click:[["has-click","handleClick"]]},r.LS_KEY=w+"action-storage",e.default=r,t.exports=e.default},"./src/controller.js":function(t,e,o){"use strict";function y(){return t=o("./src/base.js"),h=t&&t.__esModule?t:{default:t};var t}Object.defineProperty(e,"__esModule",{value:!0});var h,m=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var o,r=arguments[e];for(o in r)Object.prototype.hasOwnProperty.call(r,o)&&(t[o]=r[o])}return t},r=function(t,e,o){return e&&a(t.prototype,e),o&&a(t,o),t},n=window.wafer,i=n.controllers,l=n.features,n=n.utils,i=i.WaferBaseController,f=n.getConfigFromJSONScriptNode,r=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(p,i),r(p,[{key:"processStoredAction",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"";if(t.shouldProcessState){var o=t.actionHost,r=t.appId,n=t.bookmarkActionHost,i=t.crumb,a=window.localStorage.getItem((h||y()).default.LS_KEY);if(a){var s=document.createElement("div"),e={actionHost:o,appId:r,bookmarkActionHost:n,crumb:i,selector:e};try{var c=JSON.parse(a),u=c.id,l=c.name,f=c.ttl,p=void 0===f?0:f,d=c.subType,b=c.type;p&&p>=Date.now()&&b&&d&&u&&(s.setAttribute("data-wf-on","complete:setState:wfAction.entity."+b),new(h||y()).default(s,Object.assign({},e,{id:u,name:l,subType:d,type:b})).trigger(m({},e,{id:u,name:l,subType:d,type:b})))}catch(t){}window.localStorage.removeItem((h||y()).default.LS_KEY)}}}}]),p);function p(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=t.root,o=void 0===e?document:e,r=t.selector;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,p);var n=f(document.getElementById("wafer-action-config")),i=n.actionHost,a=n.appId,s=n.bookmarkActionHost,e=n.crumb,t=n.shouldSaveToStorage,c=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(p.__proto__||Object.getPrototypeOf(p)).call(this,{root:o,selector:r,props:{actionHost:i,appId:a,bookmarkActionHost:s,crumb:e,shouldSaveToStorage:t,selector:r},WaferClass:(h||y()).default})),u=c;return c.sync(),c._state=m({},c._state,{idInstanceMapping:new Map}),(h||y()).default.prototype.setActionStatus=function(e){var t=this._util.mappingId,o=u._state.idInstanceMapping;o.has(t)||o.set(t,[]),o.get(t).push(this),o.get(t).forEach(function(t){t.statusDidUpdate(e)})},l.localStorage&&setTimeout(function(){c.processStoredAction(n,r)},1),c}function a(t,e){for(var o=0;o<e.length;o++){var r=e[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}e.default=r,t.exports=e.default},"./src/entry.js":function(t,e,o){"use strict";var r,n;Object.defineProperty(e,"__esModule",{value:!0}),e.default=new(r||(n=o("./src/controller.js"),r=n&&n.__esModule?n:{default:n})).default({selector:".wafer-action"}),t.exports=e.default}},n={},r.m=o,r.c=n,r.d=function(t,e,o){r.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:o})},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="https://s.yimg.com/aaq/wf/",r(r.s="./src/entry.js");function r(t){if(n[t])return n[t].exports;var e=n[t]={i:t,l:!1,exports:{}};return o[t].call(e.exports,e,e.exports,r),e.l=!0,e.exports}var o,n});
