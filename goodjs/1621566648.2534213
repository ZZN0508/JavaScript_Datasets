define(["OK/EventFactory","OK/PopLayerPhoto","OK/AbstractShortcutMenu","OK/ShortcutMenuReact","OK/utils/vanilla","OK/LogSeen","OK/pms!photoPickerConfig"],(function(e,t,a,o,r,n,l){"use strict";var i;function s(t){(i=i||e.create()).trigger(t)}function d(e){return null!==e.querySelector(".plc")}function c(){var e=document.getElementById("photoLayerLog");return e&&e.getAttribute("data-layer-log-type")}function u(e){var t=document.getElementById(e);t&&t.click()}function y(){u("plsp_next")}function p(){u("plsp_prev")}function h(){OK.photoLayer.isShown()||OK.photoLayer.open(),g({url:this.getAttribute("data-url")})}function m(e){var t,a,o;e&&(a=e.getAttribute("data-expand-text")||"вЂў вЂў вЂў",o=e.getAttribute("data-collapse-text")||"вЂў вЂў вЂў",e.scrollHeight>e.offsetHeight&&((t=document.createElement("a")).className="lstp",t.textContent=a,t.addEventListener("click",(function(){e.classList.toggle("__expanded"),e.classList.contains("__expanded")?(e.style.maxHeight=e.scrollHeight+"px",t.textContent=o):(e.style.maxHeight="",t.textContent=a)})),e.nextSibling?e.parentNode.insertBefore(t,e.nextSibling):e.parentNode.appendChild(t)))}function g(e){return r.ajax(e).then((function(e){r.updateBlockModelCallback(e)}))}function f(e){"object"==typeof e&&(e=e.url+"?"+r.stringifyParams(e.data)),navigateOnUrlFromJS(e)}return{getPhotoShownEvent:function(){return i=i||e.create()},prepareLayer:function(e){OK.photoLayer.isLogTimeDiff="false"!==e.getAttribute("data-log-time-diff"),OK.photoLayer.loaderEnabled="false"!==e.getAttribute("data-loader-enabled"),OK.photoLayer.commentsDelta=parseInt(e.getAttribute("data-comments-delta"),10),OK.photoLayer.minHeight=parseInt(e.getAttribute("data-min-height"),10),OK.photoLayer.hideElements="false"!==e.getAttribute("data-hide-elements"),OK.photoLayer.isLogPrematureClose="false"!==e.getAttribute("data-log-premature-close"),OK.loader.use(["jQuery","OKPhotoLayer"],(function(){OK.photoLayer.onPhotoShown(!1,s)}));var t=document.getElementById("photoLayerWrapper"),a=t&&"true"===t.getAttribute("data-just-opened");a&&t.removeAttribute("data-just-opened");var o=e.getAttribute("data-seen-params");if(o){var l=JSON.parse(o);l.data.time=Date.now(),l.data.logAction=a?"PHOTO_LAYER_OPEN":"PHOTO_LAYER_NAVIGATION";var i=l.data;i.useInstantLog||n.logSuccess(l.type,JSON.stringify(i)),i.useInstantLog&&r.ajax({url:"/web-api/photo/layer/registerSeen",data:{time:Date.now(),logAction:i.logAction,id:parseInt(i.ids,10),place:i.place,entrancePlace:i.entrancePlace,isExplicitView:i.isExplicitView}})}},toggleFullScreenButton:function(){OK.photoLayer.toggleFullScreenButton()},updateWrapper:function(e){var t=document.getElementById("photoLayerWrapper"),r=e.getAttribute("data-add"),n=e.getAttribute("data-remove"),l="true"===e.getAttribute("data-isStub");requestAnimationFrame((function(){var e,a;c();l&&t.classList.add("__ready"),t.classList.toggle("__v2",d(t)),a=(e=(e=t)||document.getElementById("photoLayerWrapper")).querySelector(".photo-layer_photo"),e.setAttribute("data-l",JSON.stringify({target:"photoLayer",windowWidth:window.innerWidth,windowHeight:window.innerHeight,withRightColumn:d(e),layerWidth:a&&a.clientWidth,layerHeight:a&&a.clientHeight,layerType:c()})),m(document.querySelector(".photo-layer_descr_tx")),m(document.querySelector(".plc-people-pins_body"))})),t&&r&&t.classList.add(r),t&&n&&t.classList.remove(n);var i=t.querySelector(".photo-layer_cnt_main");if(i){var s=function(){t.classList.toggle("__opened-sm",!!a.getActiveInstance()||!!o.getActive())};i.addEventListener("mouseenter",s),i.addEventListener("mouseleave",s)}},loadNavigation:function(e){var t=e.getAttribute("data-params");if(t)try{(t=JSON.parse(t))["st.layer.cmd"]="PopLayerPhotoOuter",t.cmd="PopLayerPhoto",t["st.layer.showNav"]="on",t["st.layer.limitedUi"]="on",t["st.layer.revNav"]="off";var a=t["st.layer.reqAttempt"]||1,o=t["st.layer.reqDelay"]||500,r=a>1?parseInt(o):1;setTimeout((function(){g({url:"/dk",data:t})}),r)}catch(e){}},footerRendered:function(){OK.loader.use(["jQuery","OKPhotoLayer"],(function(){OK.photoLayer.footerRendered()}))},activateNavigation:function(){var e,a=document.getElementById("plsp_next"),o=document.getElementById("plsp_prev"),r=document.getElementById("plp_photoLink");e=function(e){var a=e.currentTarget.getAttribute("data-fh");if(a){t.handleOnNavigate(a);var o=document.getElementById("scrollToTopPhotoLayer");o&&o.dispatchEvent(new CustomEvent("hideScrollElement")),e.preventDefault()}},a.addEventListener("click",e,!1),o.addEventListener("click",e,!1),r.addEventListener("click",y,!1)},next:y,prev:p,keyboardHandler:function(e){39===e.keyCode?(y(),e.preventDefault()):37===e.keyCode&&(p(),e.preventDefault())},activateOpenCrop:function(e){e.addEventListener("click",h)},deactivateOpenCrop:function(e){e.removeEventListener("click",h)},activateFullScreenButton:function(e){(e.requestFullscreen||e.webkitRequestFullscreen||e.mozRequestFullScreen)&&e.classList.remove("invisible")},on:function(e){switch(e.name){case"open-photo-layer":l.attachPhotoLayerRedesignEnabled?f({url:"/dk",data:{cmd:"PopLayerNewPhotoWrapper","st.layer.cmd":"PopLayerNewPhotoOuter","st.layer.type":"ATTACHMENT","st.layer.revNav":"off","st.layer.limitedUi":"false","st.layer.closeLayers":"off","st.layer.showNav":"on","st.layer.mTTId":e.messageId,"st.layer.mTTChatId":e.chatId,"st.layer.photoId":e.photoId,"st.layer.navStartPhotoId":e.photoId,"st.layer.authorId":e.authorId,"st.layer.sbd":"off","st.layer.loadNavAsync":"on","st.cmd":"userMain"}}):f({url:"/dk",data:{cmd:"PopLayerPhoto","st.layer.cmd":"PopLayerPhotoOuter","st.layer.type":"ATTACHMENT","st.layer.revNav":"off","st.layer.limitedUi":"false","st.layer.closeLayers":"off","st.layer.showNav":"on","st.layer.mTTId":e.messageId,"st.layer.mTTChatId":e.chatId,"st.layer.photoId":e.photoId,"st.layer.navStartPhotoId":e.photoId,"st.layer.authorId":e.authorId,"st.layer.sbd":"off","st.layer.loadNavAsync":"on","st.cmd":"userMain"}});break;case"open-conv-icon-layer":var t=e.isChat,a={cmd:"PopLayerPhoto","st.layer.cmd":"PopLayerPhotoOuter","st.layer.type":t?"CHAT_ICON":"FRIEND","st.layer.revNav":"off","st.layer.limitedUi":"false","st.layer.closeLayers":"off","st.layer.showNav":"on","st.layer.photoId":e.photoId,"st.layer.navStartPhotoId":e.photoId,"st.layer.sbd":"off","st.cmd":OK.getCurrentDesktopModelId()};e.hideChangeChatIconWidget&&(a["st.layer.hci"]="on"),t?a["st.layer.convId"]=e.convId:(a["st.layer.epm"]="off",a["st.layer.opl"]="off"),f({url:"/dk",data:a});break;case"open-photo-attach-layer":g({url:"/dk",data:{cmd:"PopLayer","st.layer.cmd":l.messageAttachNewPickerEnabled?"PopLayerMessageAttachPhotoPicker":"AttachDialog","st.layer.objectId":e.objectId,"st.layer.maxCount":e.maxCount||-1,"st.cmd":"userMain"}})}}}}));