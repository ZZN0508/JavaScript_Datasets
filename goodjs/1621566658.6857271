define(["require","exports","tslib","react","modules/core/i18n","modules/core/browser","modules/core/exception","modules/clean/deprecated_ajax/ajax_jquery","modules/clean/auth/common/types","modules/clean/auth/common/utils","modules/clean/auth/register/types","modules/clean/auth/register/view","modules/clean/marketing_tracker","modules/clean/profile_services/auth_callback_handler","modules/clean/profile_services/profile_services_constants","modules/clean/profile_services/profile_services_link","modules/clean/react/components/css","modules/clean/web_timing_logger","modules/clean/web_register_logging_data","modules/clean/auth/common/stats","modules/clean/api_v2/noauth_client","modules/core/notify"],(function(e,t,i,s,n,r,o,a,l,p,m,g,u,c,d,h,_,f,S,v,E,R){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TestOnlyRegisterFormComponent=t.RegisterForm=t.handleInviteResendImpl=void 0,s=i.__importDefault(s),r=i.__importStar(r),o=i.__importStar(o),a=i.__importStar(a),d=i.__importDefault(d);var C=(function(e){function t(t){var s=e.call(this,t)||this;s.testOnlyGetViewComponent=function(){return s.viewComponent},s.setViewComponent=function(e){s.viewComponent=e},s.onClickSignUp=function(e){e.preventDefault(),s.handleRegisterFormEvent(m.RegisterFormEvent.REGISTER_CLICK),v.AuthAMPLogger.logSignupAttempt(v.AuthType.CREDENTIALS),v.EmailAuthUXAnalyticsLogger.logSignupStart();var t=s.getFormErrors();t.fname||t.email||t.password||t.tos?s.setState({localErrors:t}):s.viewComponent.getCaptchaComponent().getWrappedComponent().submit()},s.onSubmit=function(){s.setState({isSubmitting:!0});var e=s.registerData(),t=s.props.signupUrl||(s.thirdPartySignupInitiated?"/ajax_thirdparty_register":"/ajax_register");a.WebRequest({url:t,type:"POST",data:e,success:function(e,t,i){s.handleSuccess(e)},error:function(e,t,i){s.handleServerErrors(JSON.parse(i))}})},s.handleGoogleCallback=function(e){v.AuthAMPLogger.logSignupResponse(v.AuthType.GOOGLE,e.success,e.err_msg),v.GoogleUXAnalyticsLogger.logSignupResponse(e);var t=s.props,n=t.additionalParams,o=void 0===n?{}:n,a=t.marketingOptInProps,l=void 0===a?{}:a,p=t.canRedirect,g=s.props.googleRegisterProps||{},u=g.signupContinuationUrl||"/",d=g.optimisticLoginContinuationUrl||u,h=S.getWebRegisterLoggingData();c.handleRegisterResponse(e,i.__assign({showMarketingOptIn:!!l.show,registerCont:u,loginCont:d,signupTag:o.signup_tag||"",canRedirect:!1!==p,k:o.k,eh:o.eh,signupEndpoint:s.props.signupEndpoint,inlineRedirect:p?void 0:function(e){var t=e.fname,n=e.lname,r=e.email,o=i.__rest(e,["fname","lname","email"]);s.setState({fname:t,lname:n,email:r,inlineThirdPartySignupState:o})}},h),void 0,(function(){s.handleRegisterFormEvent(m.RegisterFormEvent.GOOGLE_REGISTER_SUCCESS)}),(function(e){if(s.handleRegisterFormEvent(m.RegisterFormEvent.REGISTER_IMMEDIATE_SUCCESS,{userInfo:e}),!1!==s.props.canRedirect)r.redirect(d);else if(s.props.onRegisterSuccess)return s.props.onRegisterSuccess(e,e)}))},s.onGoogleRegisterClick=function(){s.handleRegisterFormEvent(m.RegisterFormEvent.REGISTER_CLICK),v.AuthAMPLogger.logSignupAttempt(v.AuthType.GOOGLE),v.GoogleUXAnalyticsLogger.logSignupStart();var e,t=new h.ProfileServicesLinkingHandler,i=s.props.googleRegisterProps||{};e=void 0===i.popup?h.AuthWindowOption.POP_UP:i.popup?h.AuthWindowOption.POP_UP:h.AuthWindowOption.REDIRECT;var n=i.signupContinuationUrl?{kind:"web",cont:i.signupContinuationUrl,remember_me:!1,pair_user:!1}:null;t.auth_service_create_user_if_needed(d.default.GOOGLE,s.handleGoogleCallback,"register_form",e,n)},s.onInputChange=function(e){var t={},i=e.currentTarget,n=i.name,r=i.value,o=i.checked;"fname"===n?t.fname=r:"lname"===n?t.lname=r:"email"===n?t.email=r:"password"===n?t.password=r:"tos_agree"===n?t.tosAgree=o:"marketing_opt_in"===n&&(t.marketingOptIn=o),s.setState(t),s.clearFormErrors(t)},s.handleResendClick=function(e){var t=e.target,i=s.state,n=i.email,r=i.isSendingInvite;"login-register-resend-invite"===t.className&&y(e,r,n,(function(){return s.setState({isSendingInvite:!0})}),(function(){return s.setState({isSendingInvite:!1})}))},s.onCaptchaReady=function(){},o.assert(!1!==t.canRedirect||!!t.onRegisterSuccess,"Need an on register success handler if we cannot redirect the user",{tags:["react-register-form"]});var n=t.fnameProps,l=void 0===n?{}:n,p=t.lnameProps,g=void 0===p?{}:p,u=t.emailProps,_=void 0===u?{}:u,f=t.tosCheckboxProps,E=void 0===f?{}:f,R=t.marketingOptInProps,C=void 0===R?{}:R,P=!C.show||!!C.checked;return s.state={localErrors:{},isSubmitting:!1,fname:l.initialValue||"",lname:g.initialValue||"",email:_.initialValue||"",password:"",tosAgree:!!E.checked,isSendingInvite:!1,marketingOptIn:P,shouldDisableForm:!0},s.mounted=!1,s}return i.__extends(t,e),t.prototype.handleServerErrors=function(e){if(this.mounted&&(v.AuthAMPLogger.logSignupResponse(v.AuthType.CREDENTIALS,!1,e.funcaptcha_response?"funcaptcha_response":"form_error"),!this.viewComponent.handleCaptchaErrors(e))){v.EmailAuthUXAnalyticsLogger.logSignupError();var t=i.__assign({},this.state.localErrors),s=Date.now();e.email&&(t.email=e.email,t.email.clientTimestamp=s),e.password&&(t.password=e.password,t.password.clientTimestamp=s),e.fname&&(t.fname=e.fname,t.fname.clientTimestamp=s),e.tos_agree&&(t.tos=e.tos_agree,t.tos.clientTimestamp=s),this.setState({localErrors:t}),this.setState({isSubmitting:!1})}},t.prototype.handleSuccess=function(e){if(this.mounted){var t=JSON.parse(e),i={id:t.id,email:t.email,display_name:t.display_name};if(v.AuthAMPLogger.logSignupResponse(v.AuthType.CREDENTIALS,!0,null),v.EmailAuthUXAnalyticsLogger.logSignupResponse(),this.handleRegisterFormEvent(m.RegisterFormEvent.REGISTER_IMMEDIATE_SUCCESS,{userInfo:i}),!1!==this.props.canRedirect){var s=t.force_redirect_url?t.redirect_url:this.props.continuationUrlForNonGoogleSignup||t.redirect_url||"/";r.redirect(s)}else this.props.onRegisterSuccess&&this.props.onRegisterSuccess(i,t);this.setState({isSubmitting:!1})}},t.prototype.trackSuccessfulRegister=function(e,t){if(e===m.RegisterFormEvent.GOOGLE_REGISTER_SUCCESS||e===m.RegisterFormEvent.REGISTER_IMMEDIATE_SUCCESS){var i=u.getGAViewData(u.MARKETING_REGISTER_EVENT,"ga_register_pageview","/virtual/ga_register_pageview");u.MarketingTracker.tryPushEvent(u.MARKETING_REGISTER_EVENT,u.EventTypeEnum.View,i)}},t.prototype.handleRegisterFormEvent=function(e,t){this.trackSuccessfulRegister(e,t),this.props.onRegisterFormEvent&&this.props.onRegisterFormEvent(e,t)},t.prototype.registerData=function(){var e=p.getFormattedName(this.state.fname,this.state.lname,this.props.combinedName),t=e[0],s=e[1],n=r.get_uri().getQuery(),o=this.state,a=o.email,l=o.password,m=o.tosAgree,g=o.marketingOptIn,u=o.inlineThirdPartySignupState,c=this.props,d=c.additionalParams,h=c.thirdPartyInitiatedSignupData,_=i.__assign({fname:t,lname:s,email:a,tos_agree:m},this.thirdPartySignupInitiated?{}:{password:l}),f=i.__assign(i.__assign(i.__assign(i.__assign(i.__assign({cont:this.props.continuationUrlForNonGoogleSignup,signup_endpoint:this.props.signupEndpoint,demandbase_override:n.demandbase_override,marketing_opt_in:g},_),h||{}),u||{}),this.viewComponent&&this.viewComponent.getCaptchaResponses()||{}),d);return S.setWebRegisterLoggingData(f)},t.prototype.clearFormErrors=function(e){var t=this.state.localErrors;e.fname&&(t.fname={}),e.email&&(t.email={}),e.password&&(t.password={}),e.tosAgree&&(t.tos={}),this.setState({localErrors:t})},t.prototype.getFormErrors=function(){var e={};if(!this.props.validateClientSide)return e;var t=Date.now();return this.state.fname?e.fname=void 0:e.fname={message_text:n.intl.formatMessage({id:"GlyhO1",defaultMessage:"Please enter your name"}),clientTimestamp:t},this.state.email?e.email=void 0:e.email={message_text:n.intl.formatMessage({id:"I7g4FQ",defaultMessage:"Please enter an email address"}),clientTimestamp:t},this.state.password||this.thirdPartySignupInitiated?e.password=void 0:e.password={message_text:n.intl.formatMessage({id:"LhlWCW",defaultMessage:"Please enter a password"}),clientTimestamp:t},this.state.tosAgree?e.tos=void 0:e.tos={message_text:n.intl.formatMessage({id:"yw3Lbd",defaultMessage:"Please agree to the terms of service"}),clientTimestamp:t},e},Object.defineProperty(t.prototype,"thirdPartySignupInitiated",{get:function(){return!!this.props.thirdPartyInitiatedSignupData||!!this.state.inlineThirdPartySignupState},enumerable:!1,configurable:!0}),t.prototype.componentDidMount=function(){this.setState({shouldDisableForm:!1}),this.props.markTti&&f.mark_time_to_interactive(),this.mounted=!0,v.AuthAMPLogger.logSignupIntent(),document.addEventListener("click",this.handleResendClick)},t.prototype.componentWillUnmount=function(){this.mounted=!1,document.removeEventListener("click",this.handleResendClick)},Object.defineProperty(t.prototype,"shouldDisableForm",{get:function(){return!!this.props.disabled||this.state.shouldDisableForm},enumerable:!1,configurable:!0}),t.prototype.render=function(){var e=this.props,t=e.marketingOptInProps,i=void 0===t?{}:t,n=e.variant,r=e.emailProps,o=e.maestroStyle,a=e.className,p=e.combinedName,m=e.fnameProps,u=e.lnameProps,c=e.passwordProps,d=e.tosCheckboxProps,h=e.submitButtonProps,_=e.googleRegisterProps,f=e.showSplitSignupFlow;return s.default.createElement(g.RegisterFormView,{ref:this.setViewComponent,variant:n||l.AuthFormVariant.STANDARD,maestroStyle:!!o,disabled:this.shouldDisableForm,className:a,combinedName:!!p,fnameProps:m||{},fnameValue:this.state.fname,fnameError:this.state.localErrors.fname,lnameProps:u||{},lnameValue:this.state.lname,emailProps:r||{},emailValue:this.state.email,emailError:this.state.localErrors.email,passwordProps:c||{},passwordValue:this.state.password,passwordError:this.state.localErrors.password,tosCheckboxProps:d||{},tosChecked:this.state.tosAgree,tosError:this.state.localErrors.tos,submitButtonProps:h||{},googleRegisterProps:_,thirdPartyInitiatedSignup:this.thirdPartySignupInitiated,isSubmitting:this.state.isSubmitting,onClickSignUp:this.onClickSignUp,onInputChange:this.onInputChange,onSubmit:this.onSubmit,onCaptchaReady:this.onCaptchaReady,onGoogleRegisterClick:this.onGoogleRegisterClick,showMarketingOptIn:!!i.show,marketingOptInChecked:this.state.marketingOptIn,splitSignupEnabled:f})},t})(s.default.Component);function y(e,t,i,s,r){if(!0!==t){var o=new E.NoAuthApiV2Client;s(),o.ns("team").rpc("logged_out_resend_pending_invite_email",{email:i},{}).then((function(){R.Notify.success(n.intl.formatMessage({id:"un5VKD",defaultMessage:"Invite resent to {email}"},{email:i})),r()})).catch((function(e){R.Notify.error(n.intl.formatMessage({id:"yqLGvW",defaultMessage:"Failed to resend invite."})),r()})),e.preventDefault()}else e.preventDefault()}t.TestOnlyRegisterFormComponent=C,t.handleInviteResendImpl=y,t.RegisterForm=_.requireCssWithComponent(C,["/static/css/login_or_register-vflZ9ry5P.css","/static/css/components/login_form-vflgnZctA.css","/static/css/components/button-vfllw60O5.css"])}));
//# sourceMappingURL=form.min.js-vflRkIm6z.map