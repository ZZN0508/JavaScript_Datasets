define(["OK/utils/utils","OK/utils/dom","OK/autofocus"],function(a,s,i){"use strict";function r(t){t.wrapper.classList.add("search-input_searching")}function n(t,e){!e&&(e=t).input.value.trim()===e.previous||(t.previous=t.input.value.trim(),t.timer&&clearTimeout(t.timer),r(t),t.timer=setTimeout(t.onChange.bind(t),t.timeout))}function h(t,e){for(var s=e.substring(Math.max(0,e.indexOf("?")+1)).split("&"),i=0;i<s.length;i++){var a=s[i];if(0===a.indexOf(t+"="))return a.substr(t.length+1)}return""}function t(){this.loading=!1}return t.prototype={onFinish:function(){this.wrapper.classList.remove("search-input_searching")},onChange:function(){var t,e={};if(e[this.input.name]=this.input.value.trim(),this.dynamicParamsNames)for(var s=0;s<this.dynamicParamsNames.length;s++){var i=this.dynamicParamsNames[s];this.input.hasAttribute(i)&&(e[i]=this.input.getAttribute(i))}this.request&&this.cancelRequests&&this.request.xhr.abort(),this.request=a.ajax({type:"GET",url:this.url,data:e}).done(function(t,e,s){this.onFinish(),a.updateBlockModelCallback(t,e,s),this.input.dispatchEvent(new CustomEvent("searchEnd",{bubbles:!0}))}.bind(this)),"altGroupAdvertsPage"==h("st.cmd",this.url)&&"on"==h("st.search",this.url)&&-1==(t=OK.historyManager.getState()).indexOf("/search",t.length-"/search".length)&&("/"==t[t.length-1]&&(t=t.slice(0,-1)),""==h("st.selection",this.url)&&(t=t.replace(/\/[0-9]+$/,"")),OK.historyManager.pushState(t+"/search"))},clear:function(){this.input.value="",this.previous="",this.wrapper.classList.remove("search-input_active"),this.toggleNeighbours(!0),r(this),this.onChange();var t=this.wrapper.querySelector(".js-search-parameters:not(.js-grid)");t&&t.classList.add("invisible"),this.advertsBack&&this.wrapper.querySelector(".js-search-parameters.js-grid").classList.remove("invisible")},isEmpty:function(){return 0===this.input.value.trim().length},handleEvent:function(t){var e=t.type;if("click"!==e){if("keydown"===e)switch(t.which){case 13:n(this,!0);break;case 27:this.isEmpty()?this.input.blur():this.clear(),t.stopPropagation()}else n(this,!1);this.isEmpty()?(this.wrapper.classList.remove("search-input_active"),this.toggleNeighbours(!0)):(this.wrapper.classList.add("search-input_active"),this.toggleNeighbours(!1))}else this.clear()},toggleNeighbours:function(e){var s=this.hideOnSearchClass;this.hideOnSearchEls&&this.hideOnSearchEls.forEach(function(t){t.classList.toggle(s,!e)})},activate:function(t){this.input=t,this.previous=this.input.value.trim(),this.wrapper=t.parentNode.parentNode,this.url=t.getAttribute("data-url"),this.cancelRequests="true"===t.getAttribute("data-cancel-requests"),this.timeout=parseInt(t.getAttribute("data-searchtimeout"),10),this.advertsBack="true"===t.getAttribute("data-adverts-back");var e=t.getAttribute("data-dynamic_params_names");e&&(this.dynamicParamsNames=e.split(",").filter(function(t){return 0<t.length})),t.addEventListener("keydown",this,!1),t.addEventListener("keyup",this,!1),t.addEventListener("keypress",this,!1),t.addEventListener("paste",this,!1),1===(e=this.wrapper.getElementsByClassName("ic_close-g")).length&&(this.close=e[0],this.close.addEventListener("click",this,!1));e=s.parent(t,"js-hide-on-search-wr");e&&(this.hideOnSearchEls=s.byClass(e,"js-hide-on-search"),this.hideOnSearchClass=t.getAttribute("data-hide-on-search-class")||"anim_shrink"),"true"===t.getAttribute("data-autofocus")&&i.activate(t)},deactivate:function(t){t.removeEventListener("keydown",this,!1),t.removeEventListener("keyup",this,!1),t.removeEventListener("keypress",this,!1),t.removeEventListener("paste",this,!1),this.close&&this.close.removeEventListener("click",this,!1)}},t});
