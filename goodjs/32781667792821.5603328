!function(o){function e(){for(var e=0,t=a.length;e<t;e++)o[a[e]].setHTML()}var a=[],r=/msie (\d+\.\d+)/i.test(navigator.userAgent)?document.documentMode||+RegExp.$1:void 0,t={postOut:function(e){if(e&&(t.callback=e),confirm("确认退出？")){e=document.createElement("script");return e.src="https://passport1.china.com/user/passportLogoff.do?callback=china_api_login_outerOutCallback",document.getElementsByTagName("head")[0].appendChild(e),!1}}};o.china_api_login_work=t,o.china_api_login_outerOutCallback=function(){t.callback&&t.callback(),e()},t.getCookie=function(e){e=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));return null!=e?unescape(e[2]):null},t.getNickname=function(){var e=t.getCookie("nickname");return null!=e&&e},o.china_api_login_nickname=t.getNickname;function i(e){this.params={},this.init(e)}i.prototype.model=function(e,t){for(var o in t)e[o]=t[o]},i.prototype.getCookie=function(e){e=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));return null!=e?unescape(e[2]):null},i.prototype.setCookie=function(e,t,o,a,i){o&&!1===isNaN(o)&&(o=new Date((new Date).getTime()+o)),document.cookie=e+"="+escape(t)+(o?"; expires="+o.toGMTString():"")+(a?"; path="+a:"; path=/")+(i?";domain="+i:"")},i.prototype.trim=function(e){var t=new RegExp(" ","g");return String(e).replace(t,"")},i.prototype.init=function(e){this.setParams(e),this.setHTML(),this.getCookie("nickname")||this.setForm(),this.params.initFn&&this.params.initFn()},i.prototype.setParams=function(e){if(this.model(this.params,{elem:1==e.id.nodeType?e.id:document.getElementById(e.id),userNameInitValue:null!=e.userNameInitValue?this.trim(e.userNameInitValue):"注册邮箱/用户名",passwordInitValue:null!=e.passwordInitValue?this.trim(e.passwordInitValue):"",initHTML:e.initHTML||"",logonHTML:e.logonHTML||"",hiddenForm:e.hiddenForm||"",initFn:e.initFn||"",submitAfterFn:e.submitAfterFn||"",submitBackFn:e.submitBackFn||"",name:e.name,loginUrl:e.loginUrl||"https://passport1.china.com/user/passportLogon.do",outUrl:e.outUrl||"https://passport1.china.com/user/passportLogoff.do"}),this.model(this.params,{tag_form:'<form name="'+this.params.name+'_form" method="post" action="">',tag_username:'<input type="text" name="username" />',tag_password:'<input type="password" name="password" />',tag_select_cookietime:'<select name="cookietime"><option value="-1" selected>无</option><option value="86400">一天</option><option value="604800">一周</option><option value="2592000">一月</option></select>',tag_checkbox_cookietime:'<input type="checkbox" name="checkbox_cookietime" /><input type="hidden" name="cookietime" value="-1" />',tag_out:'<a href="#" onclick="'+this.params.name+'.out(); return false;">退出</a>',succeed:{},error:{notUserName:function(e){alert("请输入用户名！"),e.focus()},notPassword:function(e){alert("请输入密码！"),e.focus()},notCheckCode:function(){alert("请输入验证码！")},errorUserName:function(){alert("用户名或密码错误！")},errorPassword:function(){alert("密码错误！")},errorCheckCode:function(){alert("验证码错误！")},loginFull:function(){alert("您已连续5次用户名或密码输入错误，请稍后再试！")},loginIpLock:function(){alert("您的IP已被禁用！")},errorServer:function(){alert("服务器响应错误，请重新操作！")},errorOut:function(){alert("退出失败，请重新操作！")}}}),e.error)for(var t in e.error)"function"==typeof e.error[t]&&(this.params.error[t]=e.error[t]);if(e.succeed){for(var t in e.succeed)"function"==typeof e.succeed[t]&&(this.params.succeed[t]=e.succeed[t]);this.params.succeed.loginOkUrl=e.succeed.loginOkUrl||"",this.params.succeed.outOkUrl=e.succeed.outOkUrl||""}},i.prototype.setHTML=function(){var e=this.params.elem;this.getCookie("nickname")?(e.innerHTML=this.getLogonHTML(),this.loginOk()):(e.innerHTML=this.getInitHTML(),this.setForm(),this.addFormEvent())},i.prototype.getInitHTML=function(){return this.params.initHTML||(this.params.initHTML='{F7:form}<p class="userName"><em>用户名：</em><label>{F7:username /}</label></p><p class="password"><em>密码：</em><label>{F7:password /}</label></p><p class="loginLink"><a href="https://passport.china.com/logon.do?processID=register1" class="loginReg">注册帐号</a><a href="https://passport.china.com/jsp/user/findpassword.jsp" class="loginLose">忘记密码？</a></p><p class="loginBut"><label class="loginSubmit"><input type="submit" name="button" value="登录" /></label><label class="loginReset"><input type="reset" name="button" value="重置" /></label></p>{/F7:form}'),this.converter(this.params.initHTML)},i.prototype.getLogonHTML=function(){var e,t;return this.params.logonHTML||(e='<div class="logon">',e+='<em class="logonGreet">',e+=(t=(new Date).getHours())<12?"早上好！":18<t?"晚上好！":"下午好！",e+="</em>",e+='<em class="logonName">[F7:nickname /]</em>',e+='<em class="logonOut">[F7:out /]</em>',this.params.logonHTML=e+="</div>"),this.converter(this.params.logonHTML)},i.prototype.converter=function(e){var t=this;return e=e.replace(/{F7.\w*}|({\/F7:{1}).\w*}|({F7:{1}).\w*.(\/}{1})|(\[F7:{1}).\w*.(\/\]{1})/g,function(e){return"{F7:form}"===e?t.params.hiddenForm?t.params.tag_form+t.params.hiddenForm:t.params.tag_form:"{/F7:form}"===e?"</form>":"{F7:username /}"===e||"{F7:username/}"===e?t.params.tag_username:"{F7:password /}"===e||"{F7:password/}"===e?t.params.tag_password:"{F7:select_cookietime /}"===e||"{F7:select_cookietime/}"===e||"{F7:select_cookieTime /}"===e||"{F7:select_cookieTime/}"===e?t.params.tag_select_cookietime:"{F7:checkbox_cookietime /}"===e||"{F7:checkbox_cookietime/}"===e||"{F7:checkbox_cookieTime /}"===e||"{F7:checkbox_cookieTime/}"===e?t.params.tag_checkbox_cookietime:"[F7:nickname /]"===e||"[F7:nickname/]"===e?t.getCookie("nickname"):"[F7:out /]"===e||"[F7:out/]"===e?t.params.tag_out:void 0})},i.prototype.setForm=function(e){if(!document[this.params.name+"_form"])return!1;var t=document[this.params.name+"_form"],o=t.username,a=t.password,i=this.params.userNameInitValue,t=this.params.passwordInitValue;e||(""==o.value||o.value==i?(r&&r<10?o.value=i:o.placeholder=i,o.className="dead"):o.className="",!this.getCookie("china_login_userID")||""!=o.value&&o.value!=i||(o.value=this.getCookie("china_login_userID"),o.className="",this.setForm()),""==a.value?(r&&r<10||(a.placeholder=t),a.className="dead"):a.className="",""==a.value?a.className="dead":a.className=""),"text"==e&&(o.value==i&&(o.value=""),o.className="current"),"password"==e&&(a.className="current")},i.prototype.addFormEvent=function(){if(!document[this.params.name+"_form"])return!1;var e=document[this.params.name+"_form"],t=e.username,o=e.password,a=this;t.onfocus=function(){a.setForm("text")},o.onfocus=function(){a.setForm("password")},t.onblur=function(){a.setForm(),this.value=a.trim(this.value)},o.onblur=function(){a.setForm()},e.onsubmit=function(){return a.checkForm(),!1}},i.prototype.checkForm=function(){var e=document[this.params.name+"_form"];return e.username.value&&e.username.value!=this.params.userNameInitValue?e.password.value?(e.checkbox_cookietime&&e.checkbox_cookietime.checked&&(e.cookietime.value=2592e3),this.submit()):this.params.error.notPassword(e.password):this.params.error.notUserName(e.username),!1},i.prototype.submit=function(){var e=document[this.params.name+"_form"],t=document.createElement("script"),o=this.params.loginUrl,a="username="+encodeURI(this.trim(e.username.value))+"&password="+e.password.value;e.cookietime?a+="&cookietime="+e.cookietime.value:a+="&cookietime=-1";for(var i,r=0,s=(i=e.getElementsByTagName("input")).length;r<s;r++)"hidden"==i[r].getAttribute("type")&&(a+="&"+i[r].getAttribute("name")+"="+i[r].getAttribute("value"));a+="&callback="+this.params.name+".callback",t.src=o+"?"+a,this.params.submitAfterFn&&this.params.submitAfterFn(),document.getElementsByTagName("head")[0].appendChild(t)},i.prototype.out=function(){if(confirm("确认退出？")){var e=document.createElement("script");return e.src=this.params.outUrl+"?callback="+this.params.name+".callback",document.getElementsByTagName("head")[0].appendChild(e),!1}},i.prototype.loginOk=function(){if(this.params.succeed.loginOkUrl)return o.location=this.params.succeed.loginOkUrl,!1;this.params.succeed.loginOk&&this.params.succeed.loginOk()},i.prototype.outOk=function(){if(e(),this.params.succeed.outOkUrl)return o.location=this.params.succeed.outOkUrl,!1;this.params.succeed.outOk&&this.params.succeed.outOk()},i.prototype.firstLogin=function(){e(),this.params.succeed.firstLogin&&this.params.succeed.firstLogin(),this.setCookie("china_login_userID",this.getCookie("nickname"),31536e6)},i.prototype.callback=function(e){this.params.submitBackFn&&this.params.submitBackFn(),"1"===e?this.firstLogin():"0"===e?this.params.error.errorUserName():"-2"===e?this.params.error.loginFull():"-1"===e?this.params.error.loginIpLock():"11"===e?this.outOk():"10"===e?this.params.error.errorOut():this.params.error.errorServer()};o.china_api_login=function(e){var t;if(!(e="string"==typeof e?{id:e}:e).id)return!1;if(1==e.id.nodeType)t=e.id.getAttribute("id")?"china_api_login_"+e.id.getAttribute("id"):"china_api_login_"+(new Date).getTime();else{if(!document.getElementById(e.id))return!1;t="china_api_login_"+e.id}t=t.replace(/-/g,"_"),e.name=t,a.push(t),o[t]=new i(e)}}(window);
