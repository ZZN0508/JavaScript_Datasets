Conviva.Impl=Conviva.Impl||{},Conviva.Impl.Html5PlayerInterface=function(e,t,a){var l=this;l._lastPlayHeadTimeSpeeds=[],l._timeupdate=0,l._lastTimeupdate=0,l._currentTimeIsInvalid=!1,this._timerInterface=new Conviva.Impl.Html5Timer,this._loggingInterface=a.buildLogger(),this._loggingInterface.setModuleName("Html5PlayerInterface"),this._width=-1,this._height=-1,this._addEventListener=function(e,t,a){void 0===a&&(a=l._videoElement),l._eventListeners.push([e,t,a]),window.addEventListener?a.addEventListener(e,t,!1):a.attachEvent("on"+e,t)},this._removeEventListener=function(e,t,a){void 0===a&&(a=l._videoElement),window.removeEventListener?a.removeEventListener(e,t,!1):a.detachEvent("on"+e,t)},this._registerVideoEventListeners=function(){l._addEventListener("ended",function(){l._receivedHtml5Event("ended")}),l._addEventListener("pause",function(){l._receivedHtml5Event("pause")}),l._addEventListener("playing",function(){return 0==l._videoElement.currentTime?void(l._currentTimeIsInvalid=!0):void(l._videoElement.seeking||l._receivedHtml5Event("playing"))}),l._addEventListener("waiting",function(){l._receivedHtml5Event("waiting")}),l._addEventListener("timeupdate",function(){l._currentTimeIsInvalid&&(l._timeupdate++,l._playerStateManager.getPlayerState()===Conviva.PlayerStateManager.PlayerState.PLAYING||l._videoElement.seeking||l._receivedHtml5Event("playing"))}),l._addEventListener("error",function(){var e;l._videoElement.error&&(e=l._videoElement.error.code,l._reportHtml5Error(e))}),l._addEventListener("loadedmetadata",l._loadedMetadata),l._addEventListener("seeking",function(){l.isSeekStarted||(l.isSeekStarted=!0,l._playerStateManager.setPlayerSeekStart(-1)),l._currentTimeIsInvalid&&l._playerStateManager.getPlayerState()!==Conviva.PlayerStateManager.PlayerState.BUFFERING&&(l._log("Adjusting Conviva player state to: BUFFERING"),l._receivedHtml5Event("waiting"))}),l._addEventListener("seeked",function(){l.isSeekStarted=!1,l._playerStateManager.setPlayerSeekEnd()}),l._monitorErrorsFromSourceElements()},this.getPHT=function(){return 1e3*l._videoElement.currentTime},this.getBufferLength=function(){var e=l._videoElement.buffered;if(void 0!==e){for(var t=0,a=0;a<e.length;a++){var n=e.start(a),i=e.end(a);n<=l._videoElement.currentTime&&l._videoElement.currentTime<i&&(t+=i-l._videoElement.currentTime)}return l._currentBufferLength=t,1e3*l._currentBufferLength}},this.getSignalStrength=function(){return Conviva.PlayerStateManager.DEFAULT_SIGNAL_STRENGTH},this.getRenderedFrameRate=function(){return Conviva.PlayerStateManager.DEFAULT_RENDERED_FRAME_RATE},this._monitorErrorsFromSourceElements=function(){if(void 0!==l._videoElement.children){function e(){l._log("Caught non-specific error from <source> element, reporting as ERR_UNKNOWN"),l._reportHtml5Error(0)}l._videoElement._sources=l._videoElement.children;for(var t=0;t<l._videoElement._sources.length;t++){var a=l._videoElement._sources[t];"SOURCE"==a.tagName&&l._addEventListener("error",e,a)}}},this._removeVideoEventHandlers=function(){for(var e=0;e<l._eventListeners.length;e++){var t=l._eventListeners[e];l._removeEventListener(t[0],t[1],t[2])}l._eventListeners=[]},this._findCurrentState=function(){l._prevReadyState=l._videoElement.readyState,0===l._videoElement.readyState||l._videoElement.ended?l._updateConvivaPlayerState(Conviva.PlayerStateManager.PlayerState.STOPPED):(l._videoElement.paused||l._videoElement.seeking)&&l._updateConvivaPlayerState(Conviva.PlayerStateManager.PlayerState.PAUSED),l._videoElement.readyState>=l._videoElement.HAVE_METADATA&&l._loadedMetadata()},this._receivedHtml5Event=function(e){var t=l._convertHtml5EventToConvivaPlayerState(e);l._log("Received HTML5 event: "+e+". Mapped to Conviva player state: "+t),l._updateConvivaPlayerState(t)},this._updateConvivaPlayerState=function(e){l._playerStateManager.getPlayerState()!==e&&(l._log("Changing Conviva player state to: "+e),l._playerStateManager.setPlayerState(e),l._resetPlayHeadTimes(),l._playerStateRecentlyChanged=!0)},this._convertHtml5EventToConvivaPlayerState=function(e){switch(e){case"playing":return Conviva.PlayerStateManager.PlayerState.PLAYING;case"waiting":return Conviva.PlayerStateManager.PlayerState.BUFFERING;case"ended":case"stopped":return Conviva.PlayerStateManager.PlayerState.STOPPED;case"pause":return Conviva.PlayerStateManager.PlayerState.PAUSED;default:return Conviva.PlayerStateManager.PlayerState.UNKNOWN}},this._reportHtml5Error=function(e){var t;switch(e){case 1:t="MEDIA_ERR_ABORTED";break;case 2:t="MEDIA_ERR_NETWORK";break;case 3:t="MEDIA_ERR_DECODE";break;case 4:t="MEDIA_ERR_SRC_NOT_SUPPORTED";break;default:t="MEDIA_ERR_UNKNOWN"}l._log("Reporting error: code="+e+" message="+t);e=Conviva.Client.ErrorSeverity.FATAL;l._playerStateManager.sendError(t,e)},this._loadedMetadata=function(){var e=l._videoElement.duration;isNaN(e)||e==1/0||l._playerStateManager.setDuration(e);e=l._videoElement.videoWidth;!isNaN(e)&&0<=e&&l._playerStateManager.setVideoResolutionWidth(e);e=l._videoElement.videoHeight;!isNaN(e)&&0<=e&&l._playerStateManager.setVideoResolutionHeight(e)},this._startPolling=function(){this._previousPosition=0,this._currentPosition=0,this._currentBufferLength=0,this._pollingTimerCancel=this._timerInterface.createTimer(this._poll,500,"Html5PlayerInterface._poll()")},this._poll=function(){l._pollStreamerResolution(),l._pollPosition(),l._inferPlayerStateFromPosition()},this._pollStreamerResolution=function(){var e=l._videoElement.videoWidth;!isNaN(e)&&0<=e&&e!=l._width&&(l._playerStateManager.setVideoResolutionWidth(e),l._width=e);e=l._videoElement.videoHeight;!isNaN(e)&&0<=e&&e!=l._height&&(l._playerStateManager.setVideoResolutionHeight(e),l._height=e)},this._pollPosition=function(){var e;l._previousPosition=l._currentPosition,l._currentPosition=l._videoElement.currentTime,convivaNowTime=Date.now(),0<l._lastPollTime&&convivaNowTime>l._lastPollTime&&(e=l._currentPosition-l._previousPosition,currentPhtSpeed=(e=e<0?0:e)/(convivaNowTime-l._lastPollTime)*1e3,l._lastPlayHeadTimeSpeeds.push(currentPhtSpeed)),l._lastPollTime=convivaNowTime,l._lastPlayHeadTimeSpeeds.length>Math.max(8,4)&&l._lastPlayHeadTimeSpeeds.shift()},this._inferPlayerStateFromPosition=function(){var e=l._lastPlayHeadTimeSpeeds.length;if(e>=Math.min(4,8)){for(var t=0,a=l._lastPlayHeadTimeSpeeds.slice(),n=0;n<a.length;n++)t+=a[n];t/=e;var i=1,r=.25,o=l._videoElement.playbackRate;!isNaN(o)&&o!=1/0&&0<o&&(isSafari=0<Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor"),i*=o=isSafari&&o<.5?.5:o,r*=o);o=l._playerStateManager.getPlayerState();if(o!=Conviva.PlayerStateManager.PlayerState.PLAYING&&4<=e&&Math.abs(t-i)<r)return l._log("Adjusting Conviva player state to: PLAYING"),void l._updateConvivaPlayerState(Conviva.PlayerStateManager.PlayerState.PLAYING);o==Conviva.PlayerStateManager.PlayerState.PLAYING&&8<=e&&0==t?l._videoElement.paused?o!=Conviva.PlayerStateManager.PlayerState.PAUSED&&(l._log("Adjusting Conviva player state to: PAUSED"),l._updateConvivaPlayerState(Conviva.PlayerStateManager.PlayerState.PAUSED)):l._videoElement.seeking||(l._log("Adjusting Conviva player state to: BUFFERING"),l._updateConvivaPlayerState(Conviva.PlayerStateManager.PlayerState.BUFFERING)):l._currentTimeIsInvalid&&(l._videoElement.paused?(o!=Conviva.PlayerStateManager.PlayerState.PAUSED&&(l._log("Adjusting Conviva player state to: PAUSED"),l._updateConvivaPlayerState(Conviva.PlayerStateManager.PlayerState.PAUSED)),l._timeupdate=l._lastTimeupdate):l._videoElement.seeking||(1<l._timeupdate&&l._timeupdate==l._lastTimeupdate&&(l._log("Adjusting Conviva player state to: BUFFERING"),l._updateConvivaPlayerState(Conviva.PlayerStateManager.PlayerState.BUFFERING)),l._lastTimeupdate=l._timeupdate))}},this._stopPolling=function(){this._pollingTimerCancel()},this._resetPlayHeadTimes=function(){l._lastPlayHeadTimeSpeeds=[],l._previousPosition=-1,l._lastPollTime=0},this._resetTimeupdate=function(){l._lastTimeupdate=0,l._timeupdate=0},this._log=function(e){this._loggingInterface.log(e,Conviva.SystemSettings.LogLevel.DEBUG)},function(e,t){if(this._log("Html5PlayerInterface._constr()"),!e)throw new Error("Html5PlayerInterface: playerStateManager argument cannot be null.");if(!t)throw new Error("Html5PlayerInterface: videoElement argument cannot be null.");this._playerStateManager=e,this._videoElement=t,this._eventListeners=[],this._registerVideoEventListeners(),this._resetPlayHeadTimes(),this._resetTimeupdate(),this._startPolling(),this._findCurrentState(),this._playerStateManager.setClientMeasureInterface(this),this._playerStateManager.setModuleNameAndVersion("HTML5",Conviva.Client.version)}.apply(this,arguments),this.cleanup=function(){this._log("Html5PlayerInterface.cleanup()"),this._stopPolling(),this._removeVideoEventHandlers(),this._videoElement=null,this._playerStateManager=null}},Conviva.Impl=Conviva.Impl||{},Conviva.Impl.Html5Http=function(){(function(){}).apply(this,arguments),this.makeRequest=function(e,t,a,n,i,r){return this.makeRequestStandard.apply(this,arguments)},this.makeRequestStandard=function(e,t,a,n,i,r){var o=new XMLHttpRequest;return o.open(e,t,!0),n&&o.overrideMimeType&&(o.overrideMimeType=n),n&&o.setRequestHeader&&o.setRequestHeader("Content-Type",n),0<i&&(o.timeout=i,o.ontimeout=function(){o.ontimeout=o.onreadystatechange=null,r&&r(!1,"timeout after "+i+" ms")}),o.onreadystatechange=function(){4===o.readyState&&(o.ontimeout=o.onreadystatechange=null,200==o.status?r&&r(!0,o.responseText):r&&r(!1,"http status "+o.status))},o.send(a),null},this.release=function(){}},Conviva.Impl=Conviva.Impl||{},Conviva.Impl.Html5Logging=function(){(function(){}).apply(this,arguments),this.consoleLog=function(e,t){"undefined"!=typeof console&&(console.log&&t===Conviva.SystemSettings.LogLevel.DEBUG||t===Conviva.SystemSettings.LogLevel.INFO?console.log(e):console.warn&&t===Conviva.SystemSettings.LogLevel.WARNING?console.warn(e):console.error&&t===Conviva.SystemSettings.LogLevel.ERROR&&console.error(e))},this.release=function(){}},Conviva.Impl=Conviva.Impl||{},Conviva.Impl.Html5Metadata=function(){(function(){}).apply(this,arguments),this.getBrowserName=function(){return null},this.getBrowserVersion=function(){return null},this.getDeviceBrand=function(){return null},this.getDeviceManufacturer=function(){return null},this.getDeviceModel=function(){return null},this.getDeviceType=function(){return null},this.getDeviceVersion=function(){return null},this.getFrameworkName=function(){return"HTML5"},this.getFrameworkVersion=function(){return null},this.getOperatingSystemName=function(){return null},this.getOperatingSystemVersion=function(){return null},this.getDeviceCategory=function(){return null},this.release=function(){}},Conviva.Impl=Conviva.Impl||{},Conviva.Impl.Html5Storage=function(){(function(){}).apply(this,arguments),this.saveData=function(e,t,a,n){t=e+"."+t;try{localStorage.setItem(t,a),n(!0,null)}catch(e){n(!1,e.toString())}},this.loadData=function(e,t,a){t=e+"."+t;try{a(!0,localStorage.getItem(t))}catch(e){a(!1,e.toString())}},this.release=function(){}},Conviva.Impl=Conviva.Impl||{},Conviva.Impl.Html5Time=function(){(function(){}).apply(this,arguments),this.getEpochTimeMs=function(){return(new Date).getTime()},this.release=function(){}},Conviva.Impl=Conviva.Impl||{},Conviva.Impl.Html5Timer=function(){(function(){}).apply(this,arguments),this.createTimer=function(e,t,a){var n=setInterval(e,t);return function(){-1!==n&&(clearInterval(n),n=-1)}},this.release=function(){}};
