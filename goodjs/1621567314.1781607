define("lofty/util/storage/2.0/storage",["lofty/lang/class","lofty/lang/base","jquery","lofty/util/messenger/2.0/messenger","lofty/util/json/1.0/json","lofty/util/storage/2.0/userdata-storage"],function(e,t,n,r,s,a){"use strict";var i="storage_id_",o=function(){var e=Math.random()+"",t=e.indexOf(".");return t>=0&&(e=e.substring(t+1,e.length)),i+(new Date).getTime()+"_"+e},l=function(){this.init()};l.prototype={add:function(e){var t=e.callback,n=o();return null==e.timeout&&(e.timeout=3e3),e.startTime=(new Date).getTime(),t&&(this.store[n]=e),n},call:function(e,t){var n=this.store[e],r=null;n&&!n.remove&&(r=n.callback),this.remove(e),r&&r(t)},getCfg:function(e){return this.store[e]},remove:function(e){this.store[e]&&(this.store[e].remove=!0),delete this.store[e]},run:function(){var e=this;clearTimeout(this.timeoutId),this.timeoutId=setTimeout(function(){var t=(new Date).getTime(),n=[];for(var r in e.store)e.store[r]&&!e.store[r].remove&&t-e.store[r].startTime>=e.store[r].timeout&&n.push(r);for(var s=0,a=n.length;a>s;s++)"function"==typeof e.store[n[s]].callback&&e.store[n[s]].callback({success:!1,errorCode:"timeout",errorMessage:"Send message timeout"}),e.remove(n[s]);e.run()},1e3)},init:function(){this.store={},this.run()}};var c=new l,u=e(t,{options:{crossDomain:!1,proxyUrl:"//astyle-src.alicdn.com/fdevlib/js/lofty/util/storage/2.0/proxy/storage-proxy.html",blankUrl:"about:blank",engine:null},init:function(e){t.prototype.init.call(this,e||{});var r=this.get("mixAttrs");r&&n.extend(this,r),this._funcsCache=[],this.Engine=null,this.isReady=!1,this.Engine=this.get("engine")||window.localStorage||a.getDefault(),this.get("crossDomain")?this.createMessenger():this.handleReady()},getConfigs:function(e,t){var r=t;try{r=n.parseJSON(e)}catch(s){r=t}return r},handleProxyReady:function(){this.trigger("proxyReady"),this.handleReady()},callbackMessage:function(e,t){var n=this,r=n.getConfigs(t,{});switch(e){case"proxyReady":n._init_||(n.messenger.clearAllTarget(),n.messenger.addTarget(n.proxyIframe[0].contentWindow,n.messageId),n.handleProxyReady(),n._init_=!0);break;case"setItem":case"getItem":case"removeItem":case"getJson":case"setJson":case"clear":case"getLength":case"key":c.call(r.id,{success:!0,data:r.result})}},sendMessage:function(e,t,n,r){var a=c.add({timeout:r,callback:n}),i={id:a,data:t};i=s.stringify(i),this.messenger.send(e+"|"+i)},_escapeHtml:function(e){return"string"!=typeof e?null:e.replace(/&/gm,"&amp;").replace(/</gm,"&lt;").replace(/>/gm,"&gt;").replace(/"/gm,"&quot;").replace(/'/gm,"&#39;")},getProxyUrl:function(){var e=this.get("proxyUrl");return e=e+(e.indexOf("?")>0?"&":"?")+"messageId="+this.messageId},createMessenger:function(){var e=this,t=o();this.messageId=t,this.proxyIframe=n('<iframe src="'+this._escapeHtml(e.get("blankUrl")||"")+'" style="width:1px;height:1px;overflow:hidden;position:absolute;top:0;left:0;visibility:hidden;"></iframe>').appendTo(n("body")),this.proxyIframe.prop("name",t).prop("id",t);var s=new r(t,t);s.listen(function(t){var n=t.indexOf("|"),r=t.substring(0,n),s=t.substring(n+1,t.length);e.callbackMessage(r,s)}),this.messenger=s,this.proxyIframe.on("load",function(){e.messenger.clearAllTarget(),e.proxyIframe.attr("src")!==e.get("blankUrl")&&(e.messenger.addTarget(e.proxyIframe[0].contentWindow,t),e.sendMessage("proxyReady"))}),this.proxyIframe.attr("src",this.getProxyUrl())},proxyMethod:function(e){var t=e.call,n=e.defaultValue,r=e.name,s=e.callback,a=e.args;if(!this.get("crossDomain")||null==this.messenger){var i=n;if(this.isSupport())try{i=t.apply(this,a),s&&s({success:!0,data:i})}catch(o){this.trigger("error",{exception:o,type:r}),s&&s({success:!1,errorCode:r,errorMessage:o.message}),i=n}else i=n,s&&s({success:!1,errorCode:"notSuport"});return i}this.sendMessage(r,a,s)},setItem:function(e,t,n){return this.proxyMethod({name:"setItem",args:[e,t],call:function(){return null==t?this.Engine.removeItem(e):this.Engine.setItem(e,t)},callback:n})},getItem:function(e,t){return this.proxyMethod({name:"getItem",args:[e],call:function(){return this.Engine.getItem(e)},callback:t})},setJson:function(e,t,n){return this.proxyMethod({name:"setJson",args:[e,t],call:function(){return this.Engine.setItem(e,encodeURIComponent(s.stringify(t)))},callback:n})},getJson:function(e,t){return this.proxyMethod({name:"getJson",args:[e],call:function(){var t=this.getItem(e);return s.parse(decodeURIComponent(t))},callback:t})},removeItem:function(e,t){return this.proxyMethod({name:"removeItem",args:[e],call:function(){return this.Engine.removeItem(e)},callback:t})},clear:function(e){return this.proxyMethod({name:"clear",args:[],call:function(){return this.Engine.clear()},callback:e})},getLength:function(e){return this.proxyMethod({defaultValue:0,name:"clear",args:[],call:function(){return"function"==typeof this.Engine.getLength?this.Engine.getLength():this.Engine.length||0},callback:e})},key:function(e,t){return this.proxyMethod({name:"key",args:[e],call:function(){return this.Engine.key(e)},callback:t})},isSupport:function(){return!!this.Engine},handleReady:function(){this.isReady=!0;var e=this,t=this._funcsCache;this._funcsCache=[];for(var n=0,r=t.length;r>n;n++)t[n].call(e);this.trigger("ready")},ready:function(e){this.isReady?e&&e.call(this):this._funcsCache.push(e)}}),g=null;return u.getDefault=function(){return null==g&&(g=new u),g},u});;