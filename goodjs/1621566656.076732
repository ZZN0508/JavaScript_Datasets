define(["jquery","OK/logger","OK/utils/utils","OK/OKVideo","OK/tmr","jquery.okTags"],(function(e,a,t,i,d){"use strict";var r="/dk?cmd=AltGroupAlbumCardBlock&st.cmd=altGroupVideoAll",s="/dk?cmd=videoCommand&a=changeAlbumMoviePosition",n="/dk?cmd=RelatedFeedMovies",o="video.related",l="groups.video-dnd",c="gv-error-drop",u="gv-drop-album",v="gv-drop-left-menu",p="gv-sort-start",f="gv-sort-success",g="gv-sort-error",m={revert:"invalid",scroll:!0,scrollSpeed:50,cursor:"move",cursorAt:{top:48,left:82},opacity:.8,zIndex:20,helper:function(a,t){var i=(t=t||e(a.currentTarget)).find(".video-card_img"),d=t.find(".video-card_img-w"),r=e("<div/>",{class:"draggable-item __video",width:Math.floor(d.width()/2)+"px",height:Math.floor(d.height()/2)+"px",data:{id:t.find(".video-card").data("id")}});return i.attr("src")&&e("<img/>",{class:"draggable-item_img",src:i.attr("src")}).appendTo(r),r},start:function(){a.success(l,"gv-drag")}},b=function(e){var a=e.data("fetchtype"),t=e.data("enabled-sortable");return("ALBUM"===a||"album"===a)&&t};function h(a,t){var i=e(this),d=i.children(".tip");d.length||(d=e("<div/>",{class:"tip __mid"}),t&&d.addClass(t),d.appendTo(i),e("<div/>",{class:"tip_cnt",text:a}).appendTo(d));var r=d.data("timeout");r?(clearTimeout(r),d.removeData("timeout")):setTimeout(e.fn.addClass.bind(d,"__active"),10),d.data("timeout",setTimeout((function(){d.removeClass("__active").removeData("timeout"),setTimeout(e.fn.remove.bind(d),150)}),2e3))}function C(t){var i=t.data("albumid");require(["jquery.ui.sortable"],(function(){t.sortable(e.extend(m,{items:".js-sortable",revert:!1,placeholder:"ugrid_i sortable-placeholder __video",update:function(t,d){if(d.item.dropped)return!1;var r=d.item.find(".video-card").data("id"),n=d.item.prev().find(".video-card").data("id"),o=d.item.next().find(".video-card").data("id");e.ajax({url:s,headers:{TKN:OK.tkn.get()},type:"POST",dataType:"json",data:{"st.vv_albumId":i,"st.vv_movieId":r,"st.vv_prevMovieId":n,"st.vv_nextMovieId":o}}).always((function(e){e.result?a.success(l,f):a.error(l,g)}))},start:function(){a.success(l,p)}})).disableSelection()}))}function _(e){e.sortable("disable")}return{extractScrollDelta:function(a,t,i){var d,r=a.originalEvent;return r.detail&&(d=r.detail),r.wheelDelta&&(d=-1*r.wheelDelta),r.wheelDeltaY&&(d=-1*r.wheelDeltaY),r.deltaY&&(d=r.deltaY),d?(!0===i&&(r.deltaMode&&1===r.deltaMode?d*=parseInt(e(t).css("fontSize"),10):r.deltaMode&&2===r.deltaMode&&(d*=e(t).height())),d):0},removeWrapperComponent:function(a){e(a).closest(".ugrid_i").remove()},activateSubscribeButton:function(a){var i=e(a),d=i.find(".js-action-subscribe"),r=i.find(".js-action-unsubscribe"),s=d.data("subscribe"),n=r.data("unsubscribe");i.find(".js-subscribe").on("click",(function(){var e=!d.length||d.hasClass("invisible");return t.ajax({url:e?n:s}).done((function(e,a,i){var s=e.split(OK.navigation.SPLITER),n=s[0];"unSubscribed"===n?(d.removeClass("invisible"),r.addClass("invisible")):"subscribed"===n&&(d.addClass("invisible"),r.removeClass("invisible")),s.length>1&&t.updateBlockModelCallback(e,a,i)})),!1}))},deactivateSubscribeButton:function(a){e(a).find(".js-subscribe").off()},activateDnd:function(i){var d,s=e(i),n=s.hasClass("js-dnd-child-cnt"),o=n?s.closest(".js-dnd-cnt"):s;b(o)?n?o.sortable("refresh"):C(o):(d=o,require(["jquery.ui.draggable"],(function(){d.find(".js-draggable:not(.ui-draggable)").draggable(m)})),d.off("dragstart"),d.on("dragstart",".video-card_cnt:not(.ui-draggable)",(function(e){e.preventDefault()}))),function(i){var d=i.data("ownertype"),s=i.data("refid"),n=i.data("albumid"),o=i.data("fetchtype"),p=e(".video-page");require(["jquery.ui.droppable"],(function(){i.find(".js-droppable:not(.ui-droppable)").droppable({tolerance:"pointer",hoverClass:"__hover",drop:function(i,f){f.draggable.dropped=!0;var g=e(this),m=f.draggable.find(".video-card"),b=g.data("id"),C=m.data("id"),_=m.data("bid")||C,T=g.hasClass("nav-side_i"),k=p.data("video-moved-msg"),j=p.data("video-moved-error-msg"),w=p.data("video-move-url")||r,S={"st.mc.albumId":b,"st.mc.id":C,"st.mc.bid":_,"st.mc.action":"DRAG_N_DROP"};"GROUP"==d&&(S["st.groupId"]=s,S["st.fetchType"]=o,n.length&&(S["st.albumId"]=n)),t.ajax({url:w,data:S}).done(function(e,i,d){t.updateBlockModelCallback(e,i,d),200===d.status?(h.call(p,k,"__fixed"),a.success(l,T?v:u)):(h.call(p,j,"__fixed"),a.error(l,c))}.bind(this))}})}))}(o)},deactivateDnd:function(a){var t=e(a);t.hasClass("js-dnd-child-cnt")||(t.find(".js-droppable.ui-droppable").droppable("disable"),t.off("dragstart"),b(t)?_(t):t.find(".js-draggable.ui-draggable").draggable("disable"))},activateSortable:C,deactivateSortable:_,showTip:h,activateRelatedVideo:function(d){var r=e(d),s=r.data("blockid"),l=r.data("checkpoints"),c=r.closest(".feed_cnt").find(".vid-card_cnt").data("player-element-id"),u=!1,v=function(e){var d=i.getPlayerId();if(e.detail&&c===d&&-1!==l.indexOf(e.detail.name)&&!u){if("pause"===e.detail.name&&"auto"===e.detail.data.statType&&i.isSilent())return!1;t.ajax({url:n,data:{"st.rm.movieId":e.detail.data.movieId,"st.rm.blockId":s}}).done((function(e,i,d){t.updateBlockModelCallback(e,i,d),u=!0,a.success(o,"success")})).fail((function(){a.error(o,"fail")}))}};document.addEventListener("__videoPlayerEvent",v),r.data("deactivateMethod",(function(){document.removeEventListener("__videoPlayerEvent",v)}))},deactivateRelatedVideo:function(a){var t=e(a),i=t.data("deactivateMethod");i&&i(),t.remove()},activateHideLinkedElementOnChange:function(a){var t=e(a),i=t.data("linked-id"),d=e("#"+i);t.on("change",(function(){d.toggleClass("invisible",e(this).attr("checked"))}))},deactivateHideLinkedElementOnChange:function(a){e(a).off()},activateOkTags:function(a){var t=Object.assign({inputCssSelector:"",wrapperCssSelector:"",tagCssClassName:"movie-tag-field",newTagInputCssClass:"tag_it",listClass:"tags it vl_it vl_tags",textRemoveTagTitle:"РЈРґР°Р»РёС‚СЊ РєР»СЋС‡РµРІРѕРµ СЃР»РѕРІРѕ"},a||{});if(t.inputCssSelector&&t.wrapperCssSelector){var i=document.querySelector(t.inputCssSelector);if(i){var d=e(t.wrapperCssSelector);if(d.length){var r=i.name,s=[];""!==i.value&&(s=i.value.split(",").map((function(e){return e.trim()}))),d.on("addedNewTag","."+t.newTagInputCssClass,(function(e,a){s.push(a),i.value=s.join(",")})),d.on("removedTag","."+t.newTagInputCssClass,(function(e,a){var t=s.indexOf(a);t>=0&&s.splice(t,1),i.value=s.join(",")}));for(var n=document.createDocumentFragment(),o=s.length||1;o--;){var l=document.createElement("input");l.name=r+"[]",l.className=t.tagCssClassName,l.value=s[o]?s[o]:"",n.appendChild(l)}i.parentNode.insertBefore(n,i.nextSibling),e("."+t.tagCssClassName).okTags({listClass:t.listClass,inputClass:t.newTagInputCssClass,textRemoveLinkTitle:t.textRemoveTagTitle})}}}},deactivateOkTags:function(a){if(a&&a.wrapperCssSelector){var t=e(a.wrapperCssSelector);t.length&&t.off()}},trackVideoPage:function(){"/video/sport"===window.location.pathname&&d.trackCustomGoal("open_sport_page_broadcast")}}}));