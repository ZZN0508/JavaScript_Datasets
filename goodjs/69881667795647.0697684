define(["./helper","local/common/push/pushAppSingleton","local/common/components/nsglibCommon"],function(H,M,F){return{init:function(){var c=M.getInstance(),d=H.getSystem(),l=H.getBrowser(),a=!0,r=15e3,s=null,n=3,u=500;"permissions"in navigator&&navigator.permissions.query({name:"notifications"}).then(function(e){e.onchange=function(){H.localStorage.removeItem("notificationsPermissionTTL")}});var m,p,h,v,f,o,y,g,w=document.querySelector(".notificationPrompt");w&&(m=w.querySelector(".popupNotif"),p=w.querySelector(".thankPrompt"),h=w.querySelector(".thankPrompt2"),v=w.querySelector(".tutorialPrompt"),f=w.querySelector(".infoSystemPrompt"),o=w.querySelector(".glsPush"),y=w.querySelector(".popupTopicSelection"),g=document.querySelector(".notificationTopicsPlaceholder"));var S=H.localStorage.getItem("sg.push.tutorialPrompt");function e(){var e,o,t,i,a,r,s,n;if(w&&m&&p&&v&&f&&y)switch(e=m.querySelector(".popupNotif .popupCloseIcon"),o=m.querySelector(".popupNotif .popupClose"),t=m.querySelector(".bellIcon"),i=m.querySelector("div.accept"),n=y.querySelector(".popupCloseIcon"),a=y.querySelector(".form button.save"),F.domBuilder.addEvent(e,"click",N),F.domBuilder.addEvent(o,"click",N),F.domBuilder.addEvent(t,"click",E),F.domBuilder.addEvent(i,"click",A),F.domBuilder.addEvent(n,"click",I),F.domBuilder.addEvent(a,"click",L),n=v.querySelector(".tutorialPrompt .popupCloseIcon"),F.domBuilder.addEvent(n,"click",R),"Windows"===d&&"firefox"===l&&(n=v.querySelector(".firefoxwindows"),F.domBuilder.removeClass(n,"hide")),"MacOsX"===d&&"firefox"===l&&(s=v.querySelector(".firefoxmacosx"),F.domBuilder.removeClass(s,"hide")),"Windows"!==d&&"MacOsX"!==d||"chrome"!==l||(s=v.querySelector(".chromemacosxwindows"),F.domBuilder.removeClass(s,"hide")),a=p.querySelector(".thankPrompt .popupCloseIcon"),n=h.querySelector(".thankPrompt2 .popupCloseIcon"),s=h.querySelector(".thankPrompt2 span"),F.domBuilder.addEvent(a,"click",O),F.domBuilder.addEvent(n,"click",D),F.domBuilder.addEvent(s,"click",x),H.localStorage.getItem("sg.push.notificationsPermission")){case"denied":switch(Notification.permission){case"denied":q();break;case"default":B(),q();break;case"granted":"visited"===S&&(H.localStorage.setItem("sg.push.tutorialPrompt","promoted"),g?c.on("onReady",P):c.on("onReady",function(){C(!0)})),H.localStorage.setItem("sg.push.notificationsPermission","granted")}break;case null:case void 0:switch(Notification.permission){case"default":B();break;case"denied":H.localStorage.setItem("sg.push.notificationsPermission","denied"),q();break;case"granted":H.localStorage.setItem("sg.push.notificationsPermission","granted"),g&&c.on("onReady",P)}break;case"granted":switch(Notification.permission){case"default":case"denied":H.localStorage.setItem("sg.push.notificationsPermission","denied"),q();break;default:"visited"===S&&(H.localStorage.setItem("sg.push.tutorialPrompt","promoted"),(r=w.querySelector(".active"))&&F.domBuilder.removeClass(r,"active"),F.domBuilder.addClass(p,"active"),F.domBuilder.removeClass(m,"bellActive"),F.domBuilder.removeClass(m,"bellReady"),window.dataLayer.push({category:"ThankPromptShow",event:"Push"}),setTimeout(function(){F.domBuilder.removeClass(p,"active")},5e3)),g&&"granted"===Notification.permission&&c.on("onReady",P)}}}function P(){var e=document.createElement("div");F.domBuilder.addClass(e,"notificationPrompt"),g.innerHTML="",g.appendChild(e),F.domBuilder.addClass(e,"active"),e.appendChild(y);var o=y.querySelector("button.save");function t(){o.removeEventListener("click",t),F.domBuilder.removeClass(e,"active"),F.domBuilder.removeClass(y,"active"),F.domBuilder.removeClass(g,"active"),w.appendChild(y)}o&&o.addEventListener("click",t),require(["local/common/push/topics"],function(e){e.getTopics().then(function(e){if(!e)throw new Error;window.dataLayer.push({category:"showTopicsInPlaceholderDesktop",event:"Push"}),i({topics:e}),F.domBuilder.addClass(g,"active"),F.domBuilder.addClass(y,"active")}).catch(function(){window.dataLayer.push({category:"showTopicsInPlaceholderDesktopError",event:"Push"}),t()})})}function t(e){var o=e.querySelectorAll("input:checked"),t=[],i=0;for(o.length;item=o[i];i++)t.push({displayName:item.dataset.displayName,codeName:item.dataset.codeName});require(["local/common/push/pushPlatformApi"],function(e){e.sendTokenToServer(t).then(function(e){setTimeout(function(){var e;F.domBuilder.removeClass(y,"active"),(e=w.querySelector(".active"))&&F.domBuilder.removeClass(e,"active"),F.domBuilder.addClass(h,"active"),window.dataLayer.push({category:"ThankPromptShow",event:"Push"}),a&&(s=setTimeout(function(){F.domBuilder.removeClass(h,"active")},r))},500)}).catch(function(e){F.domBuilder.removeClass(y,"active")})})}function C(o){F.domBuilder.addClass(y,"active"),require(["local/common/push/topics"],function(e){e.getTopics().then(function(e){if(!e)throw new Error;window.dataLayer.push({category:"OnetPopupTopicsShow",event:"Push"}),i({topics:e,firstLoad:o})}).catch(function(e){console.log(e),window.dataLayer.push({category:"OnetPopupTopicsError",event:"Push"}),F.domBuilder.removeClass(y,"active")})})}function i(e){var o=e.topics||!1,t=e.firstLoad||!1,e=y.querySelector(".form .topics"),i=e.querySelector("div.topic"),a=document.createDocumentFragment(),r=0;for(o.length;item=o[r];r++){var s=i.cloneNode(!0),n=s.querySelector("input"),c=s.querySelector("label");s.style.display="block",s.querySelector(".displayName").innerHTML=item.displayName,n.dataset.displayName=item.displayName,n.dataset.codeName=item.codeName,n.checked=item.subscribed||t&&-1<item.codeName.indexOf("wiadomosci"),n.id+=r,c.setAttribute("for",n.getAttribute("id")),a.appendChild(s)}e.innerHTML="",e.appendChild(a),e=null}function B(){var e=(new Date).setHours(0,0,0,0);0!=+(H.localStorage.getItem("notificationsPermissionTTL")||0)-e&&((e=w.querySelector(".active"))&&F.domBuilder.removeClass(e,"active"),F.domBuilder.addClass(m,"active"),window.dataLayer.push({category:"OnetPromptShow",event:"Push"}))}function q(s){var e;!function(){var e,o,t="choiceTopics"===s?(e="sg.push.showbellchoiceday",o="sg.push.showbellchoicecnt",u):(e="sg.push.showbellday",o="sg.push.showbellcnt",n),i=(new Date).getDay(),a=(a=H.localStorage.getItem(e))?parseInt(a,10):null,r=(r=H.localStorage.getItem(o))?parseInt(r,10):0;if(a===i){if(t<=r)return;r+=1}else r=1;return H.localStorage.setItem(o,r),H.localStorage.setItem(e,i),1}()||((e=w.querySelector(".active"))&&F.domBuilder.removeClass(e,"active"),F.domBuilder.addClass(m,"bellActive"))}function b(){var e;"firefox"===l&&((e=f.querySelector(".buttonLabel"))&&(e.innerHTML="&bdquo;Odbieraj&rdquo;"),F.domBuilder.addClass(f,"show"),o&&F.domBuilder.removeClass(o,"hide"),setTimeout(function(){T()},1e4))}function T(){F.domBuilder.removeClass(f,"show"),o&&F.domBuilder.addClass(o,"hide")}function k(){c.on("onPermissionGranted",function(){window.dataLayer.push({category:"Subscribed",event:"Push"}),T(),C(!0),H.localStorage.setItem("sg.push.tutorialPrompt","promoted"),H.localStorage.setItem("sg.push.notificationsPermission","granted"),H.localStorage.removeItem("notificationsPermissionTTL")}),c.on("onPermissionDenied",function(){window.dataLayer.push({category:"Unsubscribed",event:"Push"}),T(),H.localStorage.removeItem("notificationsPermissionTTL")}),require(["local/common/push/tokenApi"],function(e){e.subscribe()}),window.dataLayer.push({category:"SystemPromptShow",event:"Push"})}function I(){window.dataLayer.push({category:"OnetPromptChoiceTopicsClose",event:"Push"}),F.domBuilder.removeClass(y,"active"),q("choiceTopics")}function L(){window.dataLayer.push({category:"OnetPromptChoiceTopicsSubscribe",event:"Push"}),t(y.querySelector(".topics"))}function N(){F.domBuilder.addClass(m,"bellActive"),H.localStorage.setItem("sg.push.notificationsPermission","denied"),setTimeout(function(){F.domBuilder.addClass(m,"bellReady")},100),window.dataLayer.push({category:"OnetPromptClose",event:"Push"}),H.localStorage.setItem("notificationsPermissionTTL",(new Date).setHours(0,0,0,0))}function E(){switch(window.dataLayer.push({category:"BellFABClick",event:"Push"}),Notification.permission){case"default":k(),b();break;case"denied":(e=w.querySelector(".active"))&&F.domBuilder.removeClass(e,"active"),H.localStorage.setItem("sg.push.tutorialPrompt","visited"),F.domBuilder.addClass(v,"active"),window.dataLayer.push({category:"TutorialPromptShow",event:"Push"});break;case"granted":C()}var e;F.domBuilder.removeClass(m,"bellActive"),F.domBuilder.removeClass(m,"bellReady"),F.domBuilder.removeClass(m,"active")}function A(){window.dataLayer.push({category:"OnetPromptAccept",event:"Push"}),H.localStorage.setItem("sg.push.notificationsPermission","granted"),k(),b();var e=w.querySelector(".active");e&&F.domBuilder.removeClass(e,"active")}function O(){window.dataLayer.push({category:"ThankPromptClose",event:"Push"}),F.domBuilder.removeClass(p,"active")}function D(){window.dataLayer.push({category:"ThankPromptClose",event:"Push"}),F.domBuilder.removeClass(h,"active"),clearTimeout(s)}function x(){window.dataLayer.push({category:"ThankPromptClickOnAction",event:"Push"}),C(),D()}function R(){window.dataLayer.push({category:"TutorialPromptClose",event:"Push"}),F.domBuilder.removeClass(v,"active")}return{init:function(){"Notification"in window&&(c.on("onRegister",e),c.on("onShowNotification",function(e,o){var t=JSON.parse(o.data);require(["local/common/push/sendToAnalytics","local/common/push/getPushId"],function(e,o){e({cd1:"OnetSGDesktop",cd2:o(t.openUrl||""),cd3:t.title})})}),c.run())}}}().init}});
