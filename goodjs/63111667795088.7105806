define("lofty/util/messenger/2.0/messenger",["jquery","util/misc/2.0"],function(t,r){function i(t,e,i){var n="";if(arguments.length<2?n="target error - target and name are both requied":"object"!=typeof t?n="target error - target itself must be window object":"string"!=typeof e&&(n="target error - target name must be string type"),n)throw new Error(n);this.target=t,this.name=e,this.prefix=i}function e(t,e){this.targets={},this.name=t,this.listenFunc=[],this.prefix=(e||"[PROJECT_NAME]")+"",this.initListen()}var o="postMessage"in window;return i.prototype.send=o?function(t){this.target.postMessage(this.prefix+"|"+t,"*")}:function(t){var e=window.navigator[this.prefix+this.name];if("function"!=typeof e)throw new Error("target callback function is not defined");e(this.prefix+"|"+t,window)},e.prototype.addTarget=function(t,e){t=new i(t,e,this.prefix);this.targets[e]=t},e.prototype.removeTarget=function(t){delete this.targets[t]},e.prototype.clearAllTarget=function(){this.targets={}},e.prototype.initListen=function(){function t(t){if("object"==typeof t&&t.data){if(e=t.data,!r.isAliDomain(t.origin))throw new Error("invalid message origin")}else e=t;if(t=n.prefix+"|",e&&"string"==typeof e&&0===e.indexOf(t))for(var e=e.slice(t.length),i=0;i<n.listenFunc.length;i++)n.listenFunc[i](e)}var n=this;o?"addEventListener"in document?window.addEventListener("message",t,!1):"attachEvent"in document&&window.attachEvent("onmessage",t):window.navigator[this.prefix+this.name]=t},e.prototype.listen=function(t){this.listenFunc.push(t)},e.prototype.clear=function(){this.listenFunc=[]},e.prototype.send=function(t,e){var i,n=this.targets;if(1==arguments.length)for(i in e=t,n)n.hasOwnProperty(i)&&n[i].send(e);else{if(2!=arguments.length)throw new Error("params are lost.");if(void 0===t||""==t)throw new Error("target are invalid.");n[t].send(e)}},e});
