define(["OK/utils/dom","OK/FAPIClient","OK/logger","OK/cookie"],function(e,r,i,s){var o,n="SHOW",a="HIDE",c="DISABLE",h="UI_CLOSE";function u(t,e){i.success("Skrepochka",t,e)}function _(t){("true"===s.readCookie("dme")||OK.fn.isDebug())&&window.console&&console.log.apply(console,arguments)}function d(t){var e=this.extractDataModel(t);this.prepareViewData().findElements(t).initUIInteractionHandlers().prepareAPI(e).tryStart()}function l(t){this._currentTimeoutId=-1,this._commonCtx=t||null}return l.prototype={run:function(t,e,i){var r=this;this.cancel(),this._currentTimeoutId=setTimeout(function(){r._currentTimeoutId=-1,t.call(i||r._commonCtx||null)},e)},cancel:function(){-1!==this._currentTimeoutId&&clearTimeout(this._currentTimeoutId)}},d.prototype={extractDataModel:function(t){t=t.getAttribute("data-model");return JSON.parse(t)},findElements:function(t){return this._rootNode=t,this._contentNode=e.firstByClass(t,"skrepochka_content"),this._characterNode=e.firstByClass(t,"skrepochka_character"),this._closeButtonNode=e.firstByClass(t,"skrepochka_close"),this._notificationTextNode=e.firstByClass(t,"skrepochka_notification-text"),this._characterOpenerNode=e.firstByClass(t,"skrepochka_character-opener"),this._textOpenerNode=e.firstByClass(t,"skrepochka_text-opener"),this},prepareViewData:function(){return this._localClosedCategories={},this._currentShowedCategory=null,this._isViewShowed=!1,this._isInHiddingProcess=!1,this},prepareAPI:function(t){_(t);var e=t.apiData;this._newYearGameId=e.newYearGameId,this._nextAPIRequestTimeout=new l(this),this._isActive=!0;t=e.requestRetryTimeout;this._baseRequestRetryTimeout=t,this._requestRetryTimeout=t,this._pingIntervalMs=e.pingIntervalMs,this._currentStatus="PENDING",this._initialETag=this.getLocallyETag(),this._lastETag=null,this._expiresInMs=e.pingIntervalMs,this._currentCategories=null;e=e.params;return r.Client.initialize(e,e),this},initUIInteractionHandlers:function(){var t=this;return this._closeButtonNode.addEventListener("click",function(){t.closeAction(h)}),this._characterOpenerNode.addEventListener("click",function(){t.openNotification()}),this._textOpenerNode.addEventListener("click",function(){t.openNotification()}),this},getCurrentShowedCategory:function(t){var e=this._localClosedCategories;if(!Object.keys(e).length)return t[0];for(var i=0,r=t.length;i!==r;i+=1){var s=t[i];if(!e.hasOwnProperty(s.type))return s;if(s.last_notif_id!==e[s.type])return s}return null},processingResponse:function(t){_(t),e=t.status!==n||t.categories&&0!==t.categories.length?t.status:a,(this._currentStatus=e)===n&&(this._lastETag=t.etag),this._expiresInMs=t.expires_in_ms||this._pingIntervalMs,this._currentCharacter=t.character;var e,t=t.categories;return this._currentCategories=t,e===n&&(e=this._currentShowedCategory,t=this.getCurrentShowedCategory(t),this._currentShowedCategory=t,e&&(e.type!==t.type?u("opened-update","category"):e.last_notif_id!==t.last_notif_id&&u("opened-update","last-notif-changed"))),this},closeAction:function(t){var e=this._currentShowedCategory;this._localClosedCategories[e.type]=e.last_notif_id,t===h&&u("closed",e.type);e=this.getCurrentShowedCategory(this._currentCategories);return e?(this._currentShowedCategory=e,this.updateView()):(this.hideView(),this._initialETag=this._lastETag,this.saveETagLocally(this._lastETag)),this},openNotification:function(){var t=this._currentShowedCategory;return u("opened",t.type),"Game"===t.type?navigateOnUrlFromJS("/app/"+this._newYearGameId):navigateOnUrlFromJS("/notifications/"+t.type),this.closeAction("OPENED"),this},renderCurrentShowedCategory:function(){this._characterNode.classList.add("__"+this._currentCharacter.toLowerCase().trim());var t=this._currentShowedCategory.title;return this._notificationTextNode.textContent=t,this._characterOpenerNode.setAttribute("title",t),this._textOpenerNode.setAttribute("title",t),this},prepareForShowing:function(){return this.renderCurrentShowedCategory(),this._rootNode.classList.add("__showed"),this},runStartAnimation:function(){return this._contentNode.classList.add("__showed"),this._isViewShowed=!0,this},showInFirstTime:function(){var t=this;return u("showed"),requestAnimationFrame(function(){t.prepareForShowing(),requestAnimationFrame(function(){t.runStartAnimation()})}),this},updateView:function(){return this._isViewShowed?this.renderCurrentShowedCategory():this.showInFirstTime(),this},hideView:function(t){var e;return this._isViewShowed&&((e=this)._isViewShowed=!1,t?(e._rootNode.classList.remove("__showed"),e._contentNode.classList.remove("__showed")):(e._isInHiddingProcess=!0,e._rootNode.classList.add("__hide-anim"),setTimeout(function(){u("hided"),e._rootNode.classList.remove("__hide-anim"),e._rootNode.classList.remove("__showed"),e._contentNode.classList.remove("__showed"),e._currentShowedCategory=null,e._isInHiddingProcess=!1},400))),this},saveETagLocally:function(t){return localStorage.setItem("_skrepochka_",t),this},getLocallyETag:function(){var t=localStorage.getItem("_skrepochka_");return"null"===t?null:t},getNotificationsWithTimeout:function(){return this._nextAPIRequestTimeout.run(this.getNotifications,this._expiresInMs),this},resetProgressiveRetryTimeout:function(){return this._requestRetryTimeout=this._baseRequestRetryTimeout,this},retryAPIRequest:function(t,e){if(_("Skrepochka: retry",this._requestRetryTimeout,6e5),102===e.error_code)this.deactivate(),u("session-expired");else{if(!(6e5<this._requestRetryTimeout))return this._nextAPIRequestTimeout.run(t,this._requestRetryTimeout),this._requestRetryTimeout*=2,this;this.deactivate(),u("retry-timeout-expired",e.error_code)}},getNotifications:function(){var i=this;return r.Client.callWithPromise("promo.getSkrepochkaStatus",{etag:i._initialETag}).then(function(e){return i._isInHiddingProcess?new Promise(function(t){setTimeout(function(){t(e)},400)}):Promise.resolve(e)}).then(function(t){if(i._isActive){i.resetProgressiveRetryTimeout();var e=i._currentStatus;switch(i.processingResponse(t),i._currentStatus){case n:e===a&&u("closed-update",i._currentShowedCategory.type),i.updateView().getNotificationsWithTimeout();break;case a:i.hideView().getNotificationsWithTimeout();break;case c:i.deactivate()}}},function(t){i._isActive&&(u("error-get-new",t.error_code),i.retryAPIRequest(i.getNotifications,t))}),this},tryStart:function(){var e=this;return r.Client.callWithPromise("promo.getSkrepochkaStatus",{etag:e._initialETag}).then(function(t){if(e._isActive)switch(e.resetProgressiveRetryTimeout().processingResponse(t),e._currentStatus){case n:e.showInFirstTime().getNotificationsWithTimeout();break;case a:e.getNotificationsWithTimeout();break;case c:e.deactivate()}},function(t){e._isActive&&(u("error-start",t.error_code),e.retryAPIRequest(e.tryStart,t))}),this},deactivate:function(){this.hideView(!0),this._nextAPIRequestTimeout.cancel(),this._isActive=!1}},{activate:function(t){o=new d(t)},deactivate:function(t){o.deactivate()}}});
