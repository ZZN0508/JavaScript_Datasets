YUI.add("hermes-template-parseable-text-input",function(n,e){var i=n.Template.Handlebars.revive({1:function(e,t,n,i,s){var a=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'\t\t<div data-textarea contenteditable="true" role="textbox" class="custom-text '+e.escapeExpression("function"==typeof(a=null!=(a=a(n,"classList")||(null!=t?a(t,"classList"):t))?a:e.hooks.helperMissing)?a.call(null!=t?t:e.nullContext||{},{name:"classList",hash:{},data:s,loc:{start:{line:3,column:78},end:{line:3,column:91}}}):a)+'" tabindex="0" aria-multiline="true" ></div>\n'},3:function(e,t,n,i,s){var a=null!=t?t:e.nullContext||{},o=e.hooks.helperMissing,r=e.escapeExpression,l=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'\t\t<input class="'+r("function"==typeof(e=null!=(e=l(n,"classList")||(null!=t?l(t,"classList"):t))?e:o)?e.call(a,{name:"classList",hash:{},data:s,loc:{start:{line:5,column:16},end:{line:5,column:29}}}):e)+'" placeholder="'+r("function"==typeof(e=null!=(e=l(n,"placeholder")||(null!=t?l(t,"placeholder"):t))?e:o)?e.call(a,{name:"placeholder",hash:{},data:s,loc:{start:{line:5,column:44},end:{line:5,column:59}}}):e)+'" value="'+r("function"==typeof(e=null!=(e=l(n,"content")||(null!=t?l(t,"content"):t))?e:o)?e.call(a,{name:"content",hash:{},data:s,loc:{start:{line:5,column:68},end:{line:5,column:79}}}):e)+'">\n'},5:function(e,t,n,i,s){return'\t\t\t<div class="picker-icon-wrapper mention-icon-wrapper">\n\t\t\t\t<svg class="icon icon-at"><use xlink:href="#icon-at"></use></svg>\n\t\t\t</div>\n'},7:function(e,t,n,i,s){return'\t\t\t<div class="picker-icon-wrapper flimoji-icon-wrapper">\n\t\t\t\t<svg class="icon icon-emoji flimoji flimoji-icon"><use xlink:href="#icon-emoji"></use></svg>\n\t\t\t</div>\n'},9:function(e,t,n,i,s){return'\t\t<div class="emoji-area"></div>\n'},compiler:[8,">= 4.3.0"],main:function(e,t,n,i,s){var a,o=null!=t?t:e.nullContext||{},r=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="parseable-text-input">\n'+(null!=(a=r(n,"if").call(o,null!=t?r(t,"isTextArea"):t,{name:"if",hash:{},fn:e.program(1,s,0),inverse:e.program(3,s,0),data:s,loc:{start:{line:2,column:1},end:{line:6,column:8}}}))?a:"")+'\t<div class="text-toolbar">\n'+(null!=(a=r(n,"if").call(o,null!=t?r(t,"showMentions"):t,{name:"if",hash:{},fn:e.program(5,s,0),inverse:e.noop,data:s,loc:{start:{line:8,column:2},end:{line:12,column:9}}}))?a:"")+(null!=(a=r(n,"if").call(o,null!=t?r(t,"showEmojis"):t,{name:"if",hash:{},fn:e.program(7,s,0),inverse:e.noop,data:s,loc:{start:{line:13,column:2},end:{line:17,column:9}}}))?a:"")+"\t</div>\n"+(null!=(a=r(n,"if").call(o,null!=t?r(t,"showEmojis"):t,{name:"if",hash:{},fn:e.program(9,s,0),inverse:e.noop,data:s,loc:{start:{line:19,column:1},end:{line:21,column:8}}}))?a:"")+"</div>\n"},useData:!0}),s={};n.Array.each([],function(e){var t=n.Template.get("hermes/"+e);t&&(s[e]=t)}),n.Template.register("hermes/parseable-text-input",function(e,t){return(t=t||{}).partials=t.partials?n.merge(s,t.partials):s,i(e,t)})},"@VERSION@",{requires:["template-base","handlebars-base"]}),YUI.add("hermes-template-mentions-droparound",function(n,e){var i=n.Template.Handlebars.revive({1:function(e,t,n,i,s){var a=null!=t?t:e.nullContext||{},o=e.hooks.helperMissing,r=e.escapeExpression,l=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'\t\t<li class="mention-item" data-mention-id="'+r("function"==typeof(e=null!=(e=l(n,"nsid")||(null!=t?l(t,"nsid"):t))?e:o)?e.call(a,{name:"nsid",hash:{},data:s,loc:{start:{line:3,column:44},end:{line:3,column:52}}}):e)+'">\n\t\t\t<span class="avatar person tiny no-menu" data-person-nsid="'+r("function"==typeof(e=null!=(e=l(n,"nsid")||(null!=t?l(t,"nsid"):t))?e:o)?e.call(a,{name:"nsid",hash:{},data:s,loc:{start:{line:4,column:62},end:{line:4,column:70}}}):e)+'" style="background-image: url('+r("function"==typeof(e=null!=(e=l(n,"buddyicon")||(null!=t?l(t,"buddyicon"):t))?e:o)?e.call(a,{name:"buddyicon",hash:{},data:s,loc:{start:{line:4,column:101},end:{line:4,column:114}}}):e)+');"></span>\n\t\t\t<span class="display-name">'+r("function"==typeof(e=null!=(e=l(n,"text")||(null!=t?l(t,"text"):t))?e:o)?e.call(a,{name:"text",hash:{},data:s,loc:{start:{line:5,column:30},end:{line:5,column:38}}}):e)+"</span>\n\t\t</li>\n"},compiler:[8,">= 4.3.0"],main:function(e,t,n,i,s){var a=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<ul class="mentions-droparound">\n'+(null!=(s=a(n,"each").call(null!=t?t:e.nullContext||{},null!=t?a(t,"mentions"):t,{name:"each",hash:{},fn:e.program(1,s,0),inverse:e.noop,data:s,loc:{start:{line:2,column:1},end:{line:7,column:10}}}))?s:"")+"</ul>"},useData:!0}),s={};n.Array.each([],function(e){var t=n.Template.get("hermes/"+e);t&&(s[e]=t)}),n.Template.register("hermes/mentions-droparound",function(e,t){return(t=t||{}).partials=t.partials?n.merge(s,t.partials):s,i(e,t)})},"@VERSION@",{requires:["template-base","handlebars-base"]}),YUI.add("emojis-helper",function(s,e){require("hermes-core/flog")(e);var a=s.mix({langBundles:["common","comments","search"]},s.Localizable);s.EmojisHelper=function(e,t){var n=this,i=t.view;this.appContext=e,this.dismissAreaClass="flimojis-dismiss-area",this.container=i.get("container"),this.dropdownAnchorNode=this.container.one(".emoji-area"),this.textSpan=null,this.emojiPicked=!1,this.appendDimissArea=function(){s.one("body").append('<div class="'+this.dismissAreaClass+'"></div>'),i.registerEventHandler(s.one("body").one("."+this.dismissAreaClass).on("click",this.removePicker.bind(this)))},this.appendEmojiArea=function(){this.pickerContainerNode=s.Node.create('<div class="flimojis-picker-container with-emoji-picker"></div>'),s.one("body").append('<div class="'+this.dismissAreaClass+'"></div>'),s.one("body").appendChild(this.pickerContainerNode),this.overlayDismissHandler=i.registerEventHandler(s.one("body").one("."+this.dismissAreaClass).on("click",this.removePicker.bind(this)))},this.onEmojiSelected=function(e){this.emojiPicked=!0,this.fire("emojiSelected",{emoji:e.detail.emoji,span:this.textSpan}),this.removePicker()},this.addPicker=function(){var e,t=require("@flickr/flimojis");this.appendEmojiArea(),this.emojiArea=s.one("body .flimojis-picker-container").getDOMNode(),this.emojiArea.addEventListener("emojiSelected",n.onEmojiSelected.bind(this)),this.emojiPicker=new t.EmojiDropdown({enableSearchMenu:!0,inputElements:[this.textArea],headers:a.intlMessage({intlName:"comments.SELECT_EMOJI"}),unicode12:!1,iconsPath:s.config.flickr.urls.assetRoot+"/images/joypixels",language:this.appContext.lang,destinationArea:this.emojiArea,searchMenu:!0,searchButton:".flimoji-icon-wrapper",searchPlaceholder:a.intlMessage({intlName:"search.SEARCH"})}),this.emojiPicker.render(),this.appendCommentArrow(),e=s.one(".attach-to-input"),t=this.dropdownAnchorNode.getXY(),e.setStyle("left",t[0]),e.setStyle("top",t[1]+12),(t=s.one(".flimoji-search")).blur(),t.focus()},this.removePicker=function(){this.emojiPicker&&this.emojiPicker.destroy();var e=s.one("."+this.dismissAreaClass).getDOMNode();this.emojiArea&&(this.emojiArea.innerHTML=""),e&&this.overlayDismissHandler&&(i.detachRegisteredEvent(this.overlayDismissHandler),e.remove()),this.pickerContainerNode&&this.pickerContainerNode.remove(),!this.emojiPicked&&this.textSpan&&this.fire("removeSpan",this.textSpan),this.emojiPicked=!1,this.textSpan=null},this.regexTrigger=function(e){this.addPicker(),this.textSpan=e.span;var t=this.emojiArea.querySelector("input"),n=e.input.length;t.value=e.input.substr(1,n-1),t.focus(),t.selectionStart=t.selectionEnd=n-1},this.appendCommentArrow=function(){s.one(".attach-to-input").append('<div class="upward-arrow"></div>')},s.augment(s.EmojisHelper,s.EventTarget)}},"@VERSION@",{requires:["event-custom"]}),YUI.add("dropdown",function(r){"use strict";var l={css:{closed:"ui-dropdown-closed",shim:"ui-dropdown-shim",label:'span[data-action="toggle"]',items:"[data-value]",itemSelected:"ui-dropdown-item-selected",hasDialogArrow:"ui-dropdown-has-dialog-arrow",dialogArrow:"ui-dialog-arrow",useCheckMarks:"ui-dropdown-use-checkboxes"},options:{hasDialogArrow:!1,useCheckMarks:!1}};r.namespace("Views").Dropdown=r.Base.create("Dropdown",r.FlickrView,[],{initializer:function(e){!1!==e.activate&&this.activate()},activate:function(){var e,n=this,t=this.get("container");if(this.close(),this._items={},r.Lang.isArray(this.get("selected"))||this.set("selected",[this.get("selected")]),t.all(l.css.items).each(function(e){var t=e.getData();n._items[t.value]={text:t.text||'no data-text for "'+t.value+'"',sub:t.sub,node:e}}),this.labelEl=t.one(l.css.label),this.labelEl||(this.labelEl=r.Node.create('<span class="truncate" data-action="toggle" tabindex="0" aria-haspopup="true" aria-expanded="false" />'),t.insert(this.labelEl,0)),(e=this.get("staticLabel")||this.get("defaultLabel"))&&(!0===e?this.labelEl.set("text","set staticLabel/defaultLabel to a string, not `true`"):this.labelEl.set("text",e)),this.get("hasDialogArrow")&&!t.hasClass(l.css.hasDialogArrow)&&t.addClass(l.css.hasDialogArrow),t.hasClass(l.css.hasDialogArrow)&&(this.dialogArrowEl=t.one(l.css.dialogArrow),this.dialogArrowEl||(this.dialogArrowEl=r.Node.create('<span class="ui-dialog-arrow" />'),t.insert(this.dialogArrowEl,1))),this.get("useCheckMarks")&&!t.hasClass(l.css.useCheckMarks)&&t.addClass(l.css.useCheckMarks),this.select(),this.get("disabled"))return this.disable();this.attachEvents({":toggle":this.toggle.bind(this),":set":this.setData.bind(this)}),this.registerEventHandler(this.labelEl.on("key",this.toggle,"down:13",this)),this.registerEventHandler(this.labelEl.on("key",this.enterDropdown,"down:40",this));t=this.labelEl.next("ul");t&&(this.registerEventHandler(t.on("keydown",this.keyboardNavigation,this)),this.registerEventHandler(t.delegate("key",function(e){document.activeElement.dataset&&this.setData(e,document.activeElement.dataset)},"down:13","li",this)))},setData:function(e,t){if(e.halt(),!this.get("multiSelect")&&!this.get("multiSelectSub")&&0<=r.Array.indexOf(this.get("selected"),t.value))return this.close();this.select(t.value,t)},select:function(e,t,n){var i=this,s=e?this._items[e]:null,a=!0,o=[];s&&0<=r.Array.indexOf(this.get("selected"),e)&&(this.get("multiSelect")||this.get("multiSelectSub"))?(o=this.get("selected"),(!s.sub&&this.get("multiSelect")&&o.length>this.get("minimumSelected")||s.sub)&&(o.splice(r.Array.indexOf(this.get("selected"),e),1),a=!1),this.set("selected",o)):s&&(s.sub?(o.push(e),this.get("selectParent")&&o.push(s.sub),r.Array.each(this.get("selected"),function(e){(i._items[e].sub===s.sub||i.get("multiSelect")&&!i._items[e].sub)&&o.push(e)})):(this.get("multiSelect")?o=this.get("selected"):o).push(e),this.set("selected",o)),n||this.close(),t={clicked:s?{text:s.text,value:e,sub:s.sub,itemEl:s.node,isChecked:a}:null,data:t,selections:o},this.fire("selected",t),this.update(e,t,l)},update:function(e,t,n){var i=this,s=t.clicked,a=this.get("selected"),o=this.get("defaultLabel")||"[Unable to select a default item]";this.get("staticLabel")||(this.get("labelFunction")?o=this.get("labelFunction").apply(this,[e]):s?o=(t.data&&t.data.text&&t.data.text!==s.text?t.data:s).text:0<a.length&&i._items[a[0]]&&(o=i._items[a[0]].text),this.labelEl.set("textContent",o||"[!empty data-text!]")),this.get("container").all(n.css.items).removeClass(n.css.itemSelected),r.Array.each(a,function(e){i._items[e]&&i._items[e].node.addClass(n.css.itemSelected)})},toggle:function(e){e&&e.halt(),this._open?this.close(e):this.open(e)},open:function(e){var t=this.get("container"),n=0;this._open=!0,this.get("shouldCreateShim")&&this._shimUp(),t.removeClass(l.css.closed),this.get("autoSizeMenu")&&(n=parseInt(this.labelEl.getComputedStyle("width"),10))+30>parseInt(t.one("ul").getComputedStyle("width"),10)&&t.one("ul").setStyles({width:n+30}),e&&e.silent||this.fire("open",e);t=t.one("span:first-child");t&&t.setAttribute("aria-expanded","true")},close:function(e){var t=this.get("container");e&&e.halt(),this._open=!1,this._shimUp(!1),this.fire("close",e),t.addClass(l.css.closed);t=this.labelEl;t&&t.setAttribute("aria-expanded","false")},enterDropdown:function(e){e.preventDefault();e=this.labelEl.next("ul").one("li");e&&e.focus()},keyboardNavigation:function(e){var t=e.keyCode,n=38===t||9===t&&e.shiftKey,i=40===t||9===t&&!e.shiftKey,s=e.target.ancestor("li",!0);n&&s&&s.previous("li")?(e.preventDefault(),this.focusOnPreviousItem(e)):i?(e.preventDefault(),s&&s.next("li")&&this.focusOnNextItem(e)):27!==t&&!n||(e.preventDefault(),this.labelEl&&(this.labelEl.focus(),this.close()))},focusOnPreviousItem:function(e){e=e.target.ancestor("li",!0);!e||(e=e.previous("li"))&&(e.one("a")?e.one("a"):e).focus()},focusOnNextItem:function(e){e=e.target.ancestor("li",!0);!e||(e=e.next("li"))&&(e.one("a")?e.one("a"):e).focus()},_shimUp:function(e){if(!1===e)return this._shim?(this._shim.detach("click").remove(),void(this._shim=null)):void 0;this._shim=r.Node.create("<div />"),this._shim.addClass(l.css.shim),this._shim.on("click",this.close.bind(this)),this.get("container").appendChild(this._shim)},disable:function(){var e=this.get("container");this.set("disabled",!0),this.close(),e.addClass(l.css.disabled),e.detach()},destructor:function(){this._shimUp(!1),this._items=null,this.labelEl=null,this.set("selected",null),this.detachAll()}},{ATTRS:{selected:{value:[]},disabled:{value:!1},hasDialogArrow:{value:!1},useCheckMarks:{value:!1},multiSelect:{value:!1},multiSelectSub:{value:!1},selectParent:{value:!0},minimumSelected:{value:0},staticLabel:{value:!1},defaultLabel:{value:!1},labelFunction:function(){},shouldCreateShim:{value:!0},autoSizeMenu:{value:!0}}})},"@VERSION@",{requires:["flickr-view"]}),YUI.add("mentions-helper",function(c,e){var i=require("hermes-core/flog")(e);c.MentionsHelper=function(r,e){var l=this;this.appContext=r,this.mentionsRegex=/(?:^|[^a-zA-Z0-9_!#$%&*@ï¼ ]|(?:^|[^a-zA-Z0-9_+~.-]))[@ï¼ ]([a-zA-Z0-9_]{1,40})/g,this.bbmlRegex=/!\[http(?:s?):\/\/([a-z0-9.]+\.)?flickr\.com\/(photos|people)\/([^/]+)\/?\]/g;var n={photos:"flickr.photos.comments.getPossibleMentions",galleries:"flickr.galleries.comments.getPossibleMentions",groups:"flickr.groups.discuss.getPossibleMentions"};this.getMentions=function(e){var t=n[e.type];return l.appContext.callAPI(t,e.params).then(function(e){return e.possibleMentions?e.possibleMentions.map(function(e){var t=e.username;return e.realname&&(t+=" "+e.realname.content),{text:t,nsid:e.nsid,username:e.username,buddyicon:e.iconurls.small}}):[]},function(e){return[]}).catch(function(e){i.error("Error in the getting possible mentions",{err:e})})},this.createDropAround=function(e,t,n,i,s){var a,t=t.one(".mention-icon-wrapper"),o={mentions:e,span:n,query:s};(a=new c.Views.FluidDroparound({appContext:r,showDropArrow:!0,observePageResize:!0,dismissOnOverlayClick:!0,anchorElement:t,subview:new c.Views["mentions-droparound-view"](o),width:250,height:200,preferBottom:!0,anchorOffsetVertical:-12})).show(),a.get("subview").on("mentionSelected",function(e){l.selectedMention=e,a.close()}),a.on("closeDroparound",function(){l.selectedMention?l.fire("mentionSelected",l.selectedMention):o.span&&l.fire("removeSpan",o.span),a.destroy(),l.selectedMention=null})},this.convertBBMLtoHTML=function(t){for(var e,n,i,s,a="",o=[];null!==(e=l.bbmlRegex.exec(t));)n={matchLen:e[0].length,span:'<span class="mention-link" contenteditable="false"><a href="/'+e[2]+"/"+e[3]+'">@'+e[3]+"</a></span>",index:e.index},o.push(n);return 0<o.length?(s=0,o.forEach(function(e){s===e.index||(i=t.slice(s,e.index),a+='<span class="text">'+i+"</span>"),t.slice(e.index,e.index+e.matchLen),a+=e.span,s=e.matchLen+e.index})):a=t,a},this.convertHTMLtoBBML=function(e){var t=e.cloneNode(!0),e=t.all(".mention-link");return e&&0<e.get("nodes").length&&e._nodes.forEach(function(e){var t="["+e.querySelector("a").href+"]";e.innerHTML=t}),t.get("innerText")},this.filterMentions=function(n,e){var i=c.one(".mentions-droparound");e.forEach(function(e){var t=i.one(".mention-item[data-mention-id='"+e.nsid+"'");-1===e.text.toLowerCase().indexOf(n)?t.toggleClass("hidden",!0):t.toggleClass("hidden",!1)})},c.augment(c.MentionsHelper,c.EventTarget)}},"@VERSION@",{requires:["dropdown","fluid-droparound-view","mentions-droparound-view","event-custom","template-lib-helper"]}),YUI.add("mentions-droparound-view",function(t){t.FlickrView.create(this.name,t.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){return this.mentions=e.mentions,this.span=e.span||null,this.query=e.query||null,this.mentionsHelper=new t.MentionsHelper(this.appContext,{}),this},loadState:function(){return t.Promise.resolve()},buildContainer:function(){return this.setContainerWithTemplate("mentions-droparound",{mentions:this.mentions}),this},activate:function(){var e=this.get("container"),n=this;return this.registerEventHandler(e.delegate("click",function(t){var e=n.mentions.find(function(e){return e.nsid===t.currentTarget.get("dataset").mentionId});e&&n.fire("mentionSelected",{mention:e,span:n.span})},".mention-item")),this.query&&n.mentionsHelper.filterMentions(n.query,n.mentions),this}})},"@VERSION@",{requires:["flickr-view","hermes-template-mentions-droparound","mentions-helper"],langBundles:["common"]}),YUI.add("mutation-observer-helper",function(n,e){require("hermes-core/flog")(e),n.MutationObserverHelper=function(e){var t={createObserver:function(e,t,n,i){e&&t&&n&&new MutationObserver(t).observe(e.getDOMNode(),n)}};return n.augment(t,n.EventTarget),t}},"@VERSION@",{requires:["event-custom"]}),YUI.add("parseable-text-input-view",function(h,e){var i=require("hermes-core/flog")(e);h.FlickrView.create(this.name,h.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){return this.params=e.customParserConfig||e,this.parsers=this.params.parsers||["emojis","mentions"],this.classList=this.params.classList?this.params.classList.join(" "):"",this.showEmojis=this.parsers.includes("emojis"),this.showMentions=this.parsers.includes("mentions"),this.mentionsRegex=/(?:^|[^a-zA-Z0-9_!#$%&*@ï¼ ]|(?:^|[^a-zA-Z0-9_+~.-]))[@ï¼ ]([a-zA-Z0-9_]{1,40})/g,this.showMentions&&(this.mentionsHelper=new h.MentionsHelper(this.appContext,{}),this.mentionsApiConfig=this.params.mentionsApiConfig||null),this.type=this.params.type||"textarea",this.observerConfig={characterDataOldValue:!0,characterData:!0,childList:!0,subtree:!0},this.mutationObserverHelper=new h.MutationObserverHelper(this.appContext),this.placeholder=this.params.placeholder||this.intlMessage({intlName:"photo-page-scrappy.ADD_A_COMMENT"}),this},loadState:function(){return h.Promise.resolve()},buildContainer:function(){return this.setContainerWithTemplate("parseable-text-input",{classList:this.classList,dataAttr:this.dataAttr,showEmojis:this.showEmojis,showMentions:this.showMentions,isTextArea:"textarea"===this.type}),this},activate:function(){var n=this;return this.container=this.get("container"),this.textInput="textarea"===this.type?this.container.one("[data-textarea]"):this.container.one("input"),this.mentionButton=this.container.one(".mention-icon-wrapper"),this.emojiButton=this.container.one(".flimoji-icon-wrapper"),this.markup=this.params.content,this.markup&&this.textInput.append(this.markup),this.updatePlaceholderText(this.placeholder),this.showEmojis&&(this.emojisHelper=new h.EmojisHelper(this.appContext,{view:n}),this.emojiButton&&this.registerEventHandler(this.emojiButton.on("click",function(){n.emojisHelper.addPicker()})),this.emojisHelper.on("emojiSelected",function(e){var t={type:"emoji",message:e.emoji},e=e.span;n.replaceSpanWithMarkup(e,t)}),this.emojisHelper.on("removeSpan",function(e){n.removeSpan(e)})),this.showMentions&&this.mentionsApiConfig&&(this.activeMention,this.mentionsHelper.getMentions(this.mentionsApiConfig).then(function(e){n.contacts=e,n.getContacts().then(function(e){e&&e.forEach(function(e){var t=e.getValue("username");0<e.getValue("realname").length&&(t+=" "+e.getValue("realname")),t={nsid:e.getValue("nsid"),buddyicon:e.getValue("buddyicon").small,username:e.getValue("username"),text:t},n.contacts.push(t)})})}).catch(function(e){i.error("Error in the getting contact data",{err:e})}),this.mentionButton&&this.registerEventHandler(this.mentionButton.on("click",function(){n.mentionsHelper.createDropAround(n.contacts,n.container,null,n)})),this.mentionsHelper.on("mentionSelected",function(e){this.onMentionSelect(e)}.bind(this)),this.mentionsHelper.on("removeSpan",function(e){this.removeSpan(e)}.bind(this))),this.mutationObserverHelper.createObserver(this.textInput,this.observerHandler.bind(this),this.observerConfig,n),this.registerEventHandler(this.textInput.before("blur",function(e){this.container.toggleClass("focus"),this.rangeSelection=this.getRange()}.bind(this))),this.registerEventHandler(this.textInput.on("focus",function(e){this.container.toggleClass("focus")},this)),this.registerEventHandler(this.textInput.on("paste",function(e){e.preventDefault();e=e._event.clipboardData.getData("text/plain").replace(/<[^>]+>/g,""),e=decodeURI(e);return n.insertHTML(e),!1},this)),this.fire("activated"),this},textHandler:function(e,t){var n,i,s,a,o,r,l=this.container;!this.showEmojis||(n=t.match(/(?:^|[^a-zA-Z0-9_!#$%&*@ï¼ ]|(?:^|[^a-zA-Z0-9_+~.-]))[:]([a-zA-Z0-9]{2})/))&&(r=n[0].trim(),a=this.getRange(),n[0].length+n.index===a.startOffset&&(o=h.Node.create("<span class='emoji'>"+r+"</span>"),i=n.input.length,s=n[0].length,this.insertRegexMatchSpan(o,e,n,i,s),this.emojisHelper.regexTrigger({span:o,input:r}))),!this.showMentions||(o=t.match(/(?:^|[^a-zA-Z0-9_!#$%&*@ï¼ ]|(?:^|[^a-zA-Z0-9_+~.-]))[@ï¼ ]([a-zA-Z0-9_]{1,40})/))&&(t=(r=o[0].trim()).split("@").join(""),a=this.getRange(),o[0].length+o.index===a.startOffset&&(r=h.Node.create("<span class='mention'>"+r+"</span>"),i=o.input.length,s=o[0].length,this.insertRegexMatchSpan(r,e,o,i,s),this.positionCursor(r),this.mentionsHelper.createDropAround(this.contacts,l,r,this,t)))},insertRegexMatchSpan:function(e,t,n,i,s){var a=this.container;0===n.index?(t.set("text",n.input.substring(s+n.index,i)+" "),a.insert(e,t)):(s+n.index===i?t.set("text",n.input.substring(0,n.index)+" "):(t.set("text",n.input.substring(0,n.index)+" "),i=h.Node.create("<span class='text'>"+n.input.substring(s+n.index,i)+"</span>"),h.one(t).insert(i,"after")),h.one(t).insert(e,"after"))},onMentionSelect:function(e){var t=e.mention,e=e.span;this.replaceSpanWithMarkup(e,{type:"mention",mention:t})},removeSpan:function(e){var t,n,i;e&&this.textInput.contains(e)&&(t=e.get("prevSibling"),n=e.get("nextSibling"),t&&t.hasClass("text")?(i=t.get("text"),t.set("text",i+" "+e.get("text")),e.remove()):n&&n.hasClass("text")?(i=n.get("text"),n.set("text",e.get("text")+" "+i),e.remove()):(i=h.Node.create("<span class='text'>"+e.get("text")+"</span>"),e.get("parentNode").replaceChild(i,e)))},observerHandler:function(e,t){var c=this;e.forEach(function(t){var n,e=t.target,i=t.type,s=t.oldValue,a=e.data||"";if(a!==s&&e.parentNode)if(e=(r=t.target.parentNode).localName,"characterData"===i)switch(e){case"span":r.classList.contains("text")?(o=h.one(r),c.textHandler(o,a)):r.classList.contains("mention")&&(l=a.split("@").join(""),c.mentionsHelper.filterMentions(l,c.contacts));break;case"div":var o=h.one(t.target),r=h.one(t.target.parentNode),l=h.Node.create("<span class='text'>"+(a||" ")+"</span>");r.replaceChild(l,o),c.positionCursor(l)}else"childList"===i&&t.addedNodes.length<=0&&0<t.removedNodes.length&&t.removedNodes.forEach(function(e){"span"===e.localName&&e.classList.contains("mention-link")&&(e=e.innerText.slice(0,e.innerText.length-1),t.previousSibling&&t.previousSibling.classList.contains("text")?((n=t.previousSibling).innerText=n.innerText+e,c.positionCursor(h.one(n))):t.nextSibling&&t.nextSibling.classList.contains("text")?((n=t.nextSibling).innerText=e+n.innerText,c.positionCursor(h.one(n))):(e=h.Node.create("<span class='text'>"+e+"</span>"),h.one(t.target).insert(e,0),c.positionCursor(h.one(e))))})})},getRange:function(){var e,t=window.getSelection();return e=t?t.getRangeAt(0):e},positionCursor:function(e){var t=document.createRange(),n=window.getSelection();t.setStart(e.getDOMNode(),1),t.collapse(!0),n.removeAllRanges(),n.addRange(t)},replaceSpanWithMarkup:function(e,t){switch(t.type){case"emoji":null===e?((i=h.Node.create("<span class='emoji'>"+t.message+"</span>")).setAttribute("contenteditable",!1),this.insertHTML(i)):(e.set("text",t.message),e.setAttribute("contenteditable",!1));break;case"mention":var n,i=t.mention;null===e?((n=h.Node.create("<span class='mention-link'><a href='/photos/"+i.nsid+"'>@"+i.username+"</a></span>")).setAttribute("contenteditable",!1),this.insertHTML(n)):(i=t.mention,n=h.Node.create("<a href='/photos/"+i.nsid+"'>@"+i.username+"</a>"),e.set("text",""),e.setAttribute("contenteditable",!1),e.removeClass("mention"),e.addClass("mention-link"),e.append(n))}},insertHTML:function(e){var t,n,i,s=this.container,a=this.rangeSelection;a&&a.startContainer.parentNode?(t=a.startOffset,n=a.endOffset,"DIV"===(a=(i=a.startContainer).nodeName)?(this.textInput.append(e,t-1),this.positionCursor(e)):(i=(a="#text"===a?(i.parentNode,h.one(i.parentNode)):h.one(i)).get("text"),0===t&&n!==i.length?(a.set("text",i.substring(n+1)),s.insert(e,a)):0!==t&&n===i.length?(a.set("text",i.substring(0,t)),h.one(a).insert(e,"after")):0!==t&&n!==i.length?(a.set("text",i.substring(0,t)),n=h.Node.create("<span class='text'>"+i.substring(n)+"</span>"),h.one(a).insert(n,"after"),h.one(a).insert(e,"after")):s.replaceChild(e,a),this.positionCursor(a))):this.textInput.append(e)},getContacts:function(){var e=this.appContext.getViewer().nsid,t={page:1,perPage:1e3};return this.appContext.getModel("contacts-models",e).then(function(e){return e.getValue("contacts").getPage(t).then(function(e){return e},function(e){i.error("Error in getting contacts",{err:e})})}).catch(function(e){return i.error("Error in getting contact model",{err:e}),[]})},updatePlaceholderText:function(e){this.textInput.setAttribute("data-placeholder",e)},getContent:function(){return this.mentionsHelper.convertHTMLtoBBML(this.textInput)},clearContent:function(){return this.textInput.set("innerHTML","")},toggleCollapsed:function(e){this.get("container").toggleClass("collapsed",e)}})},"@VERSION@",{requires:["flickr-view","hermes-template-parseable-text-input","hermes-template-mentions-droparound","emojis-helper","mentions-helper","mutation-observer-helper"],langBundles:["common","photo-page-scrappy","comments"]});
