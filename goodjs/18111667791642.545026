var _DEFAULTS={url:"/api/log",flushInterval:1e3,isInSampling:!0,samplingRate:100,collectMetrics:!0,logLevels:["log","info","warn","debug","error"],maxAttempts:50};function Logger(){this.buffer=[],this.plugins={},this.url=_DEFAULTS.url,this.flushInterval=_DEFAULTS.flushInterval,this.collectMetrics=_DEFAULTS.collectMetrics,this.logLevels=_DEFAULTS.logLevels}function sample(e){return 100*Math.random()<e}function intialize(){var t,i=new Logger;window&&(window.$logger=i,t=window.onerror,window.onerror=function(){var e=Array.prototype.slice.call(arguments);return i.error(e),!!t&&t.apply(window,e)})}Logger.prototype.init=function(e){this.url=(e=e||_DEFAULTS).url||this.url,this.logLevels=e.logLevels||this.logLevels,this.flushInterval=(void 0!==e.flushInterval?e:this).flushInterval,this.collectMetrics=(void 0!==e.collectMetrics?e:this).collectMetrics,this.maxAttempts=(void 0!==e.maxAttempts?e:this).maxAttempts,this.isInSampling=void 0!==e.isInSampling?e.isInSampling:sample(e.samplingRate),this.isSendCritical=void 0!==e.isSendCritical&&e.isSendCritical;var n=this;(n.isInSampling||n.isSendCritical)&&(["log","info","warn","debug","error"].forEach(function(t){var i=console[t];console[t]=function(){var e=Array.prototype.slice.call(arguments);n[t](e),i.apply(console,e)}}),n.flushInterval?n.interval=setInterval(function(){n.flush()},n.flushInterval):(e="onpagehide"in window?"pagehide":"beforeunload",window.addEventListener(e,function(){n.flush()},!1)))},Logger.prototype.registerPlugin=function(e,t){this.plugins[e]=t},Logger.prototype.metrics=function(){if(window&&window.performance){var e=window.performance,t=e.timing,e=e.navigation;return{navType:e.type,rc:e.redirectCount,lt:t.loadEventEnd-t.navigationStart,ct:t.responseEnd-t.requestStart,rt:t.domComplete-t.domLoading}}},Logger.prototype.log=function(){this.addToQ("LOG",arguments)},Logger.prototype.info=function(){this.addToQ("INFO",arguments)},Logger.prototype.debug=function(){this.addToQ("DEBUG",arguments)},Logger.prototype.warn=function(){this.addToQ("WARN",arguments)},Logger.prototype.error=function(){var t=[];Array.prototype.slice.call(arguments[0]).forEach(function(e){"object"==typeof e&&e&&e.stack?t.push(e.stack):t.push(e)}),this.addToQ("ERROR",t)},Logger.prototype.clearBuffer=function(e){this.buffer=this.buffer.slice(e)},Logger.prototype.addToQ=function(e,t){-1<this.logLevels.indexOf(e.toLowerCase())&&(t=0<t.length&&[].join.call(t," ")||"",(this.isInSampling||this.isSendCritical&&-1<t.indexOf('"type":"critical"'))&&this.buffer.push({level:e,msg:t,desc:this.getDesc(t)}))},Logger.prototype.getDesc=function(e){var t="Non critical";if(-1<e.indexOf("{")&&-1<e.indexOf("}"))try{var i=JSON.parse(e.substring(e.indexOf("{"),e.indexOf("}")+1)),t=i&&i.desc}catch(e){}return t},Logger.prototype.flush=function(){var e,t,i,n,o=this;o.buffer.length<1||(o.maxAttempts<1?clearInterval(o.interval):(o.maxAttempts=o.maxAttempts-1,e=o.buffer.length,t={metrics:o.metrics(),logs:o.buffer,isBeaconAPI:!1},i=o.url+"&desc="+encodeURI(o.buffer.map(e=>e.desc)),Object.keys(o.plugins).forEach(function(e){o.plugins[e](t)}),navigator&&navigator.sendBeacon?(t.isBeaconAPI=!0,navigator.sendBeacon(i,JSON.stringify(t))&&o.clearBuffer(e)):((n=new XMLHttpRequest).open("POST",i,!0),n.setRequestHeader("Content-Type","text/plain"),n.onreadystatechange=function(){4===n.readyState&&200===n.status&&o.clearBuffer(e)},n.send(JSON.stringify(t)))))},intialize();
