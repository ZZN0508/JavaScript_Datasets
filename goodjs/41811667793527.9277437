YUI.add("flickr-galleries-comments-getList-fetcher",function(d,s){"use strict";d.namespace("ListFetchers")["flickr-galleries-comments-getList"]={run:function(t,o){var r=this,e=this._processParams(t);return d.FlickrPromise({apiResponse:o.callAPI("flickr.galleries.comments.getList",e),galleryInfoModelRegistry:o.getModelRegistry("gallery-info-models"),galleryCommentModelRegistry:o.getModelRegistry("gallery-comment-models"),personModelRegistry:o.getModelRegistry("person-models")}).then(function(e){return r._processResponse(e,t,o)},d.FetcherErrorLogger(s))},_processResponse:function(e,t,o){var r,s,i=e.apiResponse,n=e.galleryInfoModelRegistry,l=e.galleryCommentModelRegistry,a=e.personModelRegistry,p=[],e=parseInt(i.comments.total||0,10);return i.comments&&(i.comments.comment.forEach(function(e,t){var o=a.addOrUpdate(d.APIHelper.response.parsePerson({nsid:e.author,isDeleted:e.authorIsDeleted,pathAlias:e.pathAlias,username:e.authorname,realname:e.realname,isAdFree:e.isAdFree,ispro:e.ispro,proBadge:e.proBadge,iconurls:e.iconurls,location:e.location}));r=(r=e.secureComment?"string"==typeof e.secureComment?e.secureComment:e.secureComment.content:r)||(e.content||e.comment),s=(s=e.rawComment?"string"==typeof e.rawComment?e.rawComment:e.rawComment.content:s)||(e.content||e.comment),p.push(l.addOrUpdate({id:e.commentId,galleryId:e.galleryId,galleryOwnerId:e.galleryOwnerId,author:o,authorUsername:e.authorname,authorId:e.author,date:e.dateCreate,permalink:e.permalink,content:e.content,contentSecure:r,contentRaw:s}))}),0===n.getValue(t.id,"comments").size()&&(n.getValue(t.id,"comments").totalItems=0<e?e:p.length),n.getValue(t.id,"comments").concat(p),n.setValue(t.id,"commentsContinuation",i.comments.continuation)),p},_processParams:function(e){return{gallery_id:e.id,page:e.page||1,per_page:e.perPage||16,secure_image_embeds:e.secureImageEmbeds||1,extras:"icon_urls, expand_bbml",sort:e.sort||"date-posted-desc",continuation:e.continuation||0}}}},"@VERSION@",{requires:["flickr-promise","api-helper","url-helper"],optional:["gallery-info-models","person-models","gallery-comment-models"]}),YUI.add("flickr-galleries-editMeta-updater",function(r,s){"use strict";r.namespace("ModelUpdaters")["flickr-galleries-editMeta"]={run:function(e,t){var o={gallery_id:e.galleryId,title:e.title,description:e.description};return r.Promise.all([t.callAPI("flickr.galleries.editMeta",o),t.getModel("gallery-info-models",e.galleryId)]).then(function(e){var t=e[0],e=e[1];return e.setValues({title:t.title,description:t.description}),e},r.FetcherErrorLogger(s))}}},"@VERSION@",{requires:["flickr-promise"]}),YUI.add("flickr-galleries-delete-deletor",function(o,r){"use strict";o.namespace("ModelDeletors")["flickr-galleries-delete"]={run:function(e,t){return t.callAPI("flickr.galleries.delete",{gallery_id:e}).then(null,o.FetcherErrorLogger(r))}}},"@VERSION@",{requires:["flickr-promise"]}),YUI.add("photo-contexts-models",function(c){function t(e){t.superclass.constructor.call(this,e),this.getMorePromises={"group-pool-models":{},"set-models":{},"gallery-models":{}},this.continuationKeys={"group-pool-models":{},"set-models":{},"gallery-models":{}}}c.Models[this.name]=t,c.extend(t,c.FlickrModelRegistry,{name:this.name,remote:{read:function(e){return(this.appContext.flipper.isFlipped("enable-scrappy-photo-page")?c.ModelFetchers["flickr-photos-getAllContexts"]:c.ModelFetchers["flickr-photos-getInfo"]).run(e,this.appContext)}},getMoreContextsOfType:function(n,l,e){var t,a,o,p,d,r,g=this,s=c.APIHelper.request.getRebootPhotoExtras();switch(l){case"group-pool-models":t="flickr.photos.getGroups",a="groups.group",s+=","+c.APIHelper.request.getRebootGroupExtras();break;case"set-models":t="flickr.photos.getSets",a="sets.set";break;case"gallery-models":t="flickr.photos.getGalleries",a="galleries.gallery"}return t?this.exists(n)?"-1"===(o=this.continuationKeys[l][n]||"0")?c.Promise.resolve({type:l,newContexts:[],loadedAll:!0}):(r=this.getMorePromises[l][d=n+"_"+o])?r:(this.getMorePromises[l][d]=new c.FlickrPromise({apiResponse:this.appContext.callAPI(t,{photo_id:n,extras:s,primary_photo_extras:"url_sq, url_t, url_s, url_m",continuation:o,per_page:e},!0),contextRegistry:this.appContext.getModelRegistry(l),personRegistry:this.appContext.getModelRegistry("person-models")}).then(function(e){var t,o=[],r=e.apiResponse,s=e.contextRegistry,i=e.personRegistry;return(e=a.split(".").reduce(function(e,t){return c.Lang.isObject(e)?e[t]:void 0},r))&&(c.Array.each(e,function(e){c.APIHelper.response.addContextToRegistry(e,s,i),o.push(s.proxy(e.id))}),o.length&&(t=g.getContextsOfType(n,l).map(function(e){return e.getValue("id")}),(o=o.filter(function(e){return-1===t.indexOf(e.getValue("id"))})).length&&g.getValue(n,"contexts").appendToListMulti(o))),void 0===(p=r.continuation)?p="-1":c.Lang.isNumber(p)&&(p+=""),r="-1"===p,g.continuationKeys[l][n]=p,delete g.getMorePromises[l][d],{type:l,newContexts:o,loadedAll:r}}),this.getMorePromises[l][d]):c.Promise.reject("[photo-contexts-models] getMoreContextsOfType was called for an ID that isn't in the registry: "+n):c.Promise.reject("[photo-contexts-models] getMoreContextsOfType was called without an invalid type: "+l)},getContextsOfType:function(e,t){return t=c.Array(t),this.getValue(e,"contexts").getList().filter(function(e){return-1<t.indexOf(e.registry.name)})},getContextsNotOfType:function(e,t){return t=c.Array(t),this.getValue(e,"contexts").getList().filter(function(e){return-1===t.indexOf(e.registry.name)})},attributes:{contexts:{isCollection:!0},totalGroups:{validator:function(e){return c.AttributeHelpers.validateInteger(e)},setter:function(e){return c.AttributeHelpers.coerceInteger(e)},defaultValue:0},totalSets:{validator:function(e){return c.AttributeHelpers.validateInteger(e)},setter:function(e){return c.AttributeHelpers.coerceInteger(e)},defaultValue:0},totalGalleries:{validator:function(e){return c.AttributeHelpers.validateInteger(e)},setter:function(e){return c.AttributeHelpers.coerceInteger(e)},defaultValue:0}}})},"@VERSION@",{requires:["api-helper","flickr-model-registry","flickr-promise","flickr-photos-getInfo-fetcher","flickr-photos-getAllContexts-fetcher"]}),YUI.add("flickr-favorites-getContext-fetcher",function(c,r){"use strict";c.namespace("ListFetchers")["flickr-favorites-getContext"]={run:function(t,e){var o=this;return c.Promise.all([e.callAPI("flickr.favorites.getContext",this._processParams(t),!0),e.getModelRegistry("favorite-models"),e.getModelRegistry("photo-models"),e.getModelRegistry("person-models"),e.getModelRegistry("photo-engagement-models"),e.getModelRegistry("photo-stats-models")]).then(function(e){return o._processResponse(e,t)},function(e){throw 3===e.code&&"Photo not a favorite"===e.message&&(e.notInContext=!0),e}).then(null,c.FetcherErrorLogger(r))},_processParams:function(e){var t={photo_id:e.photoId,num_prev:e.numNext,num_next:e.numPrev,extras:c.APIHelper.request.getRebootPhotoExtras()};return e.id?t.user_id=e.id:t.path_alias=e.pathAlias,t},_processResponse:function(e,t){var o=e[0],r=e[1],s=e[2],i=e[3],n=e[4],l=e[5],a=[],p=s.proxy(t.photoId),e=o.prevphotos,o=o.nextphotos,d=c.APIHelper.response.parsePhotos({photos:e.photo,personModelRegistry:i,photoModelRegistry:s,photoEngagementModelRegistry:n,photoStatsModelRegistry:l}),a=c.APIHelper.response.parsePhotos({photos:o.photo,personModelRegistry:i,photoModelRegistry:s,photoEngagementModelRegistry:n,photoStatsModelRegistry:l}),s=r.getValue(t.id,"photoContextList"),n=!!s.hasMinBoundary&&s.hasMinBoundary(),l=!!s.hasMaxBoundary&&s.hasMaxBoundary(),s=s.getList(),g=c.APIHelper.response.addOrReplaceListByContext({model:p,next:d,prev:a.reverse(),hasMax:l,hasMin:n,current:s,numNext:t.numNext,numPrev:t.numPrev});return r.setValue(t.id,"photoContextList",g),{next:d,previous:a.reverse()}}}},"@VERSION@",{requires:["flickr-promise","api-helper"],optional:["favorite-models","photo-models","person-models","photo-engagement-models","photo-stats-models"]}),YUI.add("flickr-favorites-getList-fetcher",function(h,r){"use strict";h.namespace("ListFetchers")["flickr-favorites-getList"]={run:function(t,e){var o=this;return h.Promise.all([e.callAPI("flickr.favorites.getList",this._processParams(t)),e.getModelRegistry("photo-models"),e.getModelRegistry("person-models"),e.getModelRegistry("favorite-models"),e.getModelRegistry("photo-engagement-models"),e.getModelRegistry("photo-stats-models"),e.getModelRegistry("gallery-photo-association-models"),e.getModelRegistry("gallery-faves-models")]).then(function(e){return o._processResponse(e,t)},h.FetcherErrorLogger(r))},_processParams:function(e){var t={extras:h.APIHelper.request.getRebootPhotoExtras(),per_page:e.perPage||20,page:e.page||1,get_user_info:1,jump_to:e.withPhotoId||""};if(e.id||e.userId)t.user_id=(e.id||e.userId).split("-")[0];else{if(!e.pathAlias)throw new Error("[flickr-favorites-getList-fetcher] `id` or `pathAlias` is required.");t.path_alias=e.pathAlias}return e.galleryId&&(t.gallery_id=e.galleryId),t},_processResponse:function(e,t){var o,r=e[0],s=e[1],i=e[2],n=e[3],l=e[4],a=e[5],p=e[6],d=e[7],g={id:r.user.nsid,pathAlias:r.user.pathAlias,totalItems:r.photos.total},c=t.id||t.userId,u=[];return c&&c!==g.id&&(g.id=c),e=h.APIHelper.response.parsePerson(r.user),g.owner=i.addOrUpdate(e),t.galleryId?(r.photos.photo.forEach(function(e){e.gallerynotaddable&&u.push(e)}),o=h.APIHelper.response.parsePhotos({photos:r.photos.photo,personModelRegistry:i,photoModelRegistry:s,photoEngagementModelRegistry:l,photoStatsModelRegistry:a}),c=h.APIHelper.response.parsePhotos({photos:u,personModelRegistry:i,photoModelRegistry:s,photoEngagementModelRegistry:l,photoStatsModelRegistry:a}),g.photoList={perPage:r.photos.perpage,page:r.photos.page,pageContent:o,totalItems:r.photos.total},g.id=e.id+"-"+t.galleryId,d.addOrUpdate(g).getValue("nonGalleryAddablePhotos").concat(c)):(o=h.APIHelper.response.parsePhotos({photos:r.photos.photo,personModelRegistry:i,photoModelRegistry:s,photoEngagementModelRegistry:l,photoStatsModelRegistry:a}),g.photoPageList={perPage:r.photos.perpage,page:r.photos.page,pageContent:o,totalItems:r.photos.total},n.addOrUpdate(g)),r.photos.photo&&r.photos.photo.forEach(function(e){e.ingallery&&p.addOrUpdate({id:t.galleryId+"-"+e.id,galleryId:t.galleryId,photoId:e.id})}),o}}},"@VERSION@",{requires:["flickr-promise","api-helper"],optional:["photo-models","person-models","favorite-models","photo-engagement-models","photo-stats-models"]}),YUI.add("favorite-models",function(o){function t(e){t.superclass.constructor.call(this,e)}o.Models[this.name]=t,o.extend(t,o.FlickrModelRegistry,{name:this.name,remote:{read:function(e){return o.ListFetchers["flickr-favorites-getList"].run(e,this.appContext)}},attributes:{normalizedId:{readOnly:!0,defaultFn:function(e){return e.split("-")[0]}},displayType:{readOnly:!0,defaultFn:function(){return"favorites"}},title:{readOnly:!0,derivedBy:["owner","normalizedId"],defaultFn:function(e){var t=this.appContext.getViewer(),o=this.getValue(e,"normalizedId");return t&&t.nsid===o?"Your favorites":(e=this.getValue(e,"owner"))?e.getValue("displayname")+"'s favorites":"Favorites"}},pathAlias:{validator:function(e,t){return o.AttributeHelpers.validateString(e)},setter:function(e){return o.AttributeHelpers.coerceString(e)||void 0},defaultFn:function(e){return this.getValue(e,"normalizedId")}},owner:{isModel:!0},isOwner:o.PhotoModelHelper.attributes.isOwner,photoPageList:{isCollection:!0,pageFetch:{listFetcher:o.ListFetchers["flickr-favorites-getList"]}},photoContextList:{isListProxy:!0,contextFetch:{listFetcher:o.ListFetchers["flickr-favorites-getContext"],listItemIdField:"photoId"}},url:{readOnly:!0,derivedBy:["owner","normalizedId"],defaultFn:function(e){var t=this.getValue(e,"owner"),e=this.getValue(e,"normalizedId");return"/photos/"+(t?t.getValue("pathAlias"):e)+"/favorites/"}},totalItems:{defaultFn:function(){return null}},urlSuffix:{readOnly:!0,derivedBy:["owner"],defaultFn:function(e){return"faves-"+this.getValue(e,"owner").getValue("pathAlias")}}}})},"@VERSION@",{requires:["flickr-model-registry","flickr-promise","flickr-favorites-getContext-fetcher","flickr-favorites-getList-fetcher","photo-model-helper"]});
