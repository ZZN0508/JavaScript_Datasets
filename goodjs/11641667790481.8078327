define(["require","exports","tslib","modules/core/i18n","proto_utils/unpack","modules/core/exception","modules/clean/web_timing_logger","dropbox/proto/js_init_data/privacy_consent/privacy_consent","modules/clean/marketing_tracker","modules/clean/analytics"],function(e,t,i,o,n,r,a,s,c,l){"use strict";var u,d;Object.defineProperty(t,"__esModule",{value:!0}),t.init_async=t.initialize_module=t.moduleInit=t.PrivacyConsentPlatform=t.PrivacyConsentPlatformSingleton=void 0,(p=u=u||{}).StrictlyNecessary="strictly necessary",p.MarketingAdvertising="general marketing and advertising",p.Analytics="analytics",p.PerformanceFunctionality="performance and functionality",p.SocialMediaAdvertising="social media advertising",p.AllCookies="all",d=d||{},d[d.OptIn=1]="OptIn";var p=(g.prototype.init=function(e){var t,o=this;this.config=e,this.updateTealiumDataLayer(),e.iframeOrigin&&!this.iframeEl&&(this.iframeSrc="https://"+e.iframeOrigin,this.iframeStartTime=new Date,this.iframeEl=this.createIframe(),null===(t=this.iframeEl)||void 0===t||t.addEventListener("load",function(){o.handleIframeLoad(o.iframeStartTime,e.iframeOrigin)}),window.addEventListener("message",this.receiveMessage,!1))},g.prototype.handleIframeLoad=function(e,t){var o=this;this.logToUXA("privacy_consent_iframe_loaded",{total_time:((new Date).valueOf()-e.valueOf()).toString(),iframe_uri:t}),a.waitForTTI().then(function(){o.sendCountryCode(),o.setupSettingsReEntry()})},g.prototype.onFooterLoaded=function(){this.setupSettingsReEntry(),this.bannerVisible&&this.addLocaleSelectorMargin()},g.prototype.setupSettingsReEntry=function(){this.setManageCookies(),this.maybeUseFloatingButton()},g.prototype.maybeUseFloatingButton=function(){!this.iframeEl||this.manageCookiesSet||this.isFooterLoading||this.sendShowFloatingButton()},g.prototype.createIframe=function(){var e=document.createElement("iframe");return e.src=this.iframeSrc,e.setAttribute("sandbox","allow-scripts allow-same-origin allow-popups allow-forms"),e.setAttribute("class","consent-iframe"),e.setAttribute("id","consent-iframe"),e.setAttribute("allowTransparency","true"),e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("hidden","true"),e.setAttribute("title",o.intl.formatMessage({id:"ulDVPi",defaultMessage:"Dropbox Consent"})),e.setAttribute("tabindex","1"),document.body.insertBefore(e,document.body.childNodes[0]),e},g.prototype.openOptionsDialog=function(){var e;null===(e=null===(e=this.iframeEl)||void 0===e?void 0:e.contentWindow)||void 0===e||e.postMessage({message_type:"OPEN_OPTIONS_DIALOG"},this.iframeSrc)},g.prototype.addLocaleSelectorMargin=function(){var e=document.getElementById("locale-container");this.iframeEl&&e&&(e.style.marginBottom=parseInt(this.iframeEl.height,10)+16+"px")},g.prototype.removeLocaleSelectorMargin=function(){var e=document.getElementById("locale-container");e&&e.style.removeProperty("margin-bottom")},g.prototype.sendShowFloatingButton=function(){var e;null===(e=null===(e=this.iframeEl)||void 0===e?void 0:e.contentWindow)||void 0===e||e.postMessage({message_type:"SHOW_FLOATING_BUTTON"},this.iframeSrc)},g.prototype.setIframeHeight=function(e){this.iframeEl.height=e},g.prototype.setIframeWidth=function(e){this.iframeEl.width=e},g.prototype.getCookieStr=function(e){try{return String(document.cookie||"").split(";").map(function(e){return e.split("=")}).map(function(e){return[e[0],e.slice(1).join(";")].map(function(e){return e.replace(/^[ \t]+|[ \t]+$/g,"")})}).reduce(function(e,t){var o=t[0],t=t[1];return i.__assign(i.__assign({},e),((e={})[o]=t,e))},Object.create({}))[e]||""}catch(e){return""}},g.prototype.getCurrentCookieObj=function(){var t=this.getCookieStr("__Secure-dbx_consent");if(t)try{return JSON.parse(t)}catch(e){return r.reportException({err:new Error("Consent cookie could not be parsed"),severity:r.SEVERITY.NONCRITICAL,tags:["privacy_consent"],exc_extra:{cookie_str:t}}),null}return{}},g.prototype.createShadowCookieValue=function(e,t){var o=this.getCurrentCookieObj(),i=o.consentDate?new Date(o.consentDate):new Date,n=new Date(i);return n.setMonth(i.getMonth()+6),{consentType:d.OptIn,consentDate:i.toISOString(),expireDate:n.toISOString(),consentMonths:6,categories:e,userInteracted:!!o.userInteracted||t,numDots:1}},g.prototype.bakeCookie=function(e){var t=(new Date(e.expireDate).getTime()-(new Date).getTime())/1e3,o=((i={})["__Secure-dbx_consent"]=JSON.stringify(e).replace(/[;]|[^ -~]/g,function(e){return"\\u"+(65536+e.charCodeAt(0)).toString(16).substr(1)}),i.domain="dropbox.com",i.path="/",i["max-age"]=t.toString(),i.samesite="lax",i.secure="",i),i=Object.keys(o).map(function(e){return o[e]?e+"="+o[e]:""+e});document.cookie=i.join(";")},g.prototype.updateTealiumDataLayer=function(){var e=this.getCurrentCookieObj(),t=null==e?void 0:e.categories,e=Object.keys(u),o=[];t&&(t[u.AllCookies]?o=i.__spreadArrays(e):e.forEach(function(e){t[u[e]]&&o.push(e)})),c.MarketingTracker.pushWithDefaults({consent_categories:o.join(",")})},g.prototype.reloadPage=function(){window.location.reload(!0)},g.prototype.hasUserInteracted=function(){var e;return!(null===(e=this.getCurrentCookieObj())||void 0===e||!e.userInteracted)},g.prototype.havePreferencesChanged=function(e){var t=this.getCurrentCookieObj();if(t)try{var o=JSON.stringify(t.categories);return JSON.stringify(e)!==o}catch(e){return r.reportException({err:new Error("Consent cookie could not be parsed"),severity:r.SEVERITY.NONCRITICAL,tags:["privacy_consent"],exc_extra:{cookie_str:this.getCookieStr("__Secure-dbx_consent")}}),!1}return!0},g.prototype.mapCookies=function(e){var t,o,i={};for(t in e)e.hasOwnProperty(t)&&(o=t.toLowerCase(),Object.values(u).includes(o)?i[o]=e[t]:r.reportException({err:new Error("Invalid cookie category id"),severity:r.SEVERITY.NONCRITICAL,tags:["privacy_consent"],exc_extra:{cookie_id:o}}));return i},g.prototype.clearIframeMinimizeClass=function(){var e;null===(e=this.iframeEl)||void 0===e||e.classList.remove("prev-collapsed","collapsed","expanded")},g.prototype.onToggleButtonMinimize=function(e){var t;null===(t=this.iframeEl)||void 0===t||t.classList.remove("prev-collapsed"),null===(t=this.iframeEl)||void 0===t||t.classList.toggle("collapsed",e),null===(t=this.iframeEl)||void 0===t||t.classList.toggle("expanded",!e),sessionStorage.setItem("cookie-settings-minimized",null!==(e=this.iframeEl)&&void 0!==e&&e.classList.contains("collapsed")?"true":"false")},g.prototype.sendCountryCode=function(){var e;null!==(e=this.config)&&void 0!==e&&e.countryCode&&(null===(e=null===(e=this.iframeEl)||void 0===e?void 0:e.contentWindow)||void 0===e||e.postMessage({message_type:"COUNTRY_CODE",country_code:this.config.countryCode},this.iframeSrc))},g.prototype.logToUXA=function(e,t){l.UXAnalyticsLogger.log(e,t)},g.prototype.findManageCookies=function(){var e=document.querySelectorAll('a[href="/#manage-cookies"]');return e.length?e[0]:null},g.prototype.setManageCookies=function(){var e,t=this;!this.config||(e=this.findManageCookies())&&(e.onclick=function(e){e.preventDefault(),t.openOptionsDialog()},this.manageCookiesSet=!0)},g);function g(){var d=this;return this.bannerVisible=!1,this.optionsButtonLoaded=!1,this.isFooterLoading=!1,this.receiveMessage=function(e){var t,o=d.iframeEl,i=e.data;if(e.source===o.contentWindow){var n={},r=!1;switch(i.message_type){case"BODY_CONTENT_CHANGE":var a=i.bannerVisible,s=i.dialogVisible,c=i.optionsButtonVisible,l=i.optionsButtonLoaded,u=!a&&!s&&!c;null===(t=d.iframeEl)||void 0===t||t.classList.toggle("banner-visible",a),null===(t=d.iframeEl)||void 0===t||t.classList.toggle("dialog-open",s),d.bannerVisible=a,l&&!d.optionsButtonLoaded&&(d.optionsButtonLoaded=!0,d.setupSettingsReEntry()),u?(d.setIframeHeight("0"),d.setIframeWidth("0")):null===(u=d.iframeEl)||void 0===u||u.removeAttribute("hidden"),a?(d.addLocaleSelectorMargin(),d.hasUserInteracted()||d.bakeCookie(d.createShadowCookieValue(d.mapCookies({}),!1))):d.removeLocaleSelectorMargin(),c?(a="true"===sessionStorage.getItem("cookie-settings-minimized"),null===(c=d.iframeEl)||void 0===c||c.classList.toggle("prev-collapsed",a)):d.clearIframeMinimizeClass();break;case"BANNER_RESIZE":i.bannerHeight&&i.bannerHeight!==o.height&&(d.setIframeHeight(i.bannerHeight),d.addLocaleSelectorMargin());break;case"DISPLAY_BUTTON":!d.manageCookiesSet&&i.buttonHeight&&i.buttonWidth&&(d.setIframeHeight(i.buttonHeight),d.setIframeWidth(i.buttonWidth));break;case"PRIOR_CONSENT":n=d.mapCookies(i.categories),r=d.havePreferencesChanged(n),d.hasUserInteracted()&&!r||(d.bakeCookie(d.createShadowCookieValue(d.mapCookies(i.categories),!0)),d.reloadPage());break;case"CONSENT_CHANGED":case"CONSENT_WITHDRAWN":n=d.mapCookies(i.categories),r=d.havePreferencesChanged(n),d.bakeCookie(d.createShadowCookieValue(n,!0)),r&&d.reloadPage();break;case"CONSENT_DECLINED":d.bakeCookie(d.createShadowCookieValue(d.mapCookies(i.categories),!0));break;case"SCRIPT_LOADED":d.logToUXA("privacy_consent_script_loaded",{script_id:i.scriptId,script_url:i.scriptUrl});break;case"SCRIPT_LOAD_ERROR":d.logToUXA("privacy_consent_script_load_error",{script_id:i.scriptId,script_url:i.scriptUrl});break;case"TOGGLE_BUTTON_MINIMIZE":d.onToggleButtonMinimize(i.buttonMinimized)}}},t.PrivacyConsentPlatform||this}t.PrivacyConsentPlatformSingleton=p,t.PrivacyConsentPlatform=new p,t.moduleInit=function(e){e=n.unpackProto(e,s.privacy_consent.PrivacyConsentInitData);t.PrivacyConsentPlatform.init(e)},t.initialize_module=function(e){t.PrivacyConsentPlatform.init(e)},t.init_async=function(e){t.PrivacyConsentPlatform.config||t.PrivacyConsentPlatform.init(e)}});
