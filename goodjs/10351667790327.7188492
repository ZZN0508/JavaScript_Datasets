define(["jquery","OK/logger","OK/utils/utils","OK/utils/dom","OK/OhManager","OK/utils/vanilla"],function(T,f,e,o,n,k){"use strict";var L;OK.onload.addCallback(function(){L=!0});var M,b,A,a,p,_,m,i=null,r=null,s="mtLayer",c="mtLayerMain",l="mtLayerBack",d="mtLayerForward",u="scrollToTopMtLayer",t="media-layer js-viewport-container",h="media-layer_hld",v="mlr_disc",g="media-layer_close",y="media-layer_close_ovr",w="sticky-plank_cnt",O="media-layer_fixer",C="js_mediaLayerActions",K=310,B=null,I=null,P=null,H=null,E=null,S=null,R=null,x=null,D=null,j=1145,N={id:null,to:75},q="MediaTopicLayerBody",J="MediaTopicLayerAd",W="AnonymMediaTopicLayerAd",F="layer__disabled",U="invisible",V="data-banner-seq-show-count",G=!1,z=!1,$=e.deferred();function Q(e,t){var o,n=document.getElementById(e);if(n){for(o=0;o<t.length;o+=1)if(n.classList.contains(t[o]))return;return 1}}function X(){return M.isActive&&!T("#hook_Block_PopLayerMediaTopic").hasClass(F)}function Y(e){X()&&(z||B[0]===document.activeElement||0!==B.find(document.activeElement).length||(B.focus(),z=!0),B.hasClass("__edit")||0<B.find(".__edit").length||0<B.find(".tag-box__editable").length||Q("hook_Modal_popLayerModal",[F])||Q("photoLayerWrapper",[F,U])||Q("video-poplayer-cnt",[F,U])||(39===e.keyCode&&x?(x.click(),OK.stop(e)):37===e.keyCode&&R&&(R.click(),OK.stop(e))))}function Z(e){e?OK.Layers.register(s,function(){ve("cr_esc")},void 0,!1,Y):OK.Layers.remove(s)}function ee(e,t){OK.loader.use("OKCustomJs",function(){e&&Z(t),t?OK.Layers.onLayerShown&&OK.Layers.onLayerShown():OK.Layers.onLayerHidden&&OK.Layers.onLayerHidden()})}function te(){var e=t;M.market&&""==M.pfMode?e+=" product-layer":e+=" media-layer__topic",M.modernLayer&&(e+=" __modern"),M.v2&&(e+=" __v2"),M.pfJs&&(e+=" __posting"),M.isActive&&(e+=" __active"),M.isProcess&&(e+=" __process"),M.isProcessTransparent&&(e+=" __process-transparent"),"N"==M.pfMode&&(e+=" __create"),"E"==M.pfMode&&(e+=" __edit"),M.hasActiveTopics&&(e+=" __has-topics"),M.arrowsHidden&&(e+=" __hide-arrows"),M.hasBanner&&(e+=" __has-banner"),M.fixClosing&&(e+=" __new-closing"),B[0].className=e}function oe(){ee(!0,M.isActive),n.switchLayer(!!M.isActive),te();var e,t,o=Me();!o||(e=document.getElementById(o+"Config"))&&(t=e.getAttribute("data-slot"),M.isActive?(B.attr(V,0),require(["OK/banners/BannerLoader"],function(e){a=e.subscribeToEvents(t,{onAdsSuccess:ne,onNoAds:ae,onScriptError:ae,onHideBanner:ae})})):(a&&"function"==typeof a.remove&&a.remove(),ie(o),de(!1)))}function ne(e){de(!0)}function ae(e){de(!1)}function ie(e){e=document.getElementById(e+"Wrapper");e&&(e.innerHTML="")}function re(e){e=parseInt(B.attr(e),10);return e=isNaN(e)?0:e}function se(e){var t=M.isActive!==e;M.isActive=e,t?oe():M.isActive&&T("#hook_Block_PopLayerMediaTopic").hasClass(F)&&ee(!1,!0),document.getElementById("hook_Block_PopLayerMediaTopic").classList.remove(F)}function ce(e){var t=M.isProcess!==e;M.isProcess=e,t&&te()}function le(e){var t=M.pfMode!==e;M.pfMode=e,t&&te()}function de(e){var t;M&&(t=M.hasBanner!==e,M.hasBanner=e,t&&te(),B.attr(V,e?1:0))}function ue(e){I.toggleClass("__process",e)}function fe(e,t){for(var o=e.length,n=o;1+--o;)e[o].toggleClass(t);setTimeout(function(){for(;1+--n;)e[n].toggleClass(t)},1)}function he(){var t;H&&(t=0,T(".comments_i",H).each(function(){var e=T(this).data("unread");return e&&(t=this.getBoundingClientRect().top),!e}),B.each(function(){this.scrollTop=0!==t?this.scrollTop+t:this.scrollHeight}),setTimeout(function(){T(".js-comments_add",H).focus()},50))}function ge(e,t,i){var o=T(window),n=o.height(),o=o.width();N.id&&clearTimeout(N.id),N.id=setTimeout(function(){fe([E,x,R,D],O),N.id=null},e?0:N.to),B.toggleClass("__compact",o<=j),B.toggleClass("__min-height",n<K),t&&he(),i&&function(){if(i){var e=B.find("[data-scroll-to='"+i+"']");if(0<e.length){for(var t=e[0],o=t.offsetTop,n=t.offsetParent;n&&1===n.nodeType&&n!==B[0];)o+=n.offsetTop,n=n.offsetParent;var a=B,e=a.height(),t=a.scrollTop();t+e<=o+e?a.scrollTop(o+e-e-5):o<t&&a.scrollTop(o-5)}}}()}function pe(e){var t;G||(G=!0,i=T(window),r=T(document.body),B=T("#"+s),I=T("#"+c),R=T("#"+l),x=T("#"+d),D=T("#"+u),t="1"===B.attr("data-fix-closing"),M={fixClosing:t,isActive:B.hasClass("__active"),isProcess:B.hasClass("__process"),isProcessTransparent:B.hasClass("__process-transparent"),pfMode:B.hasClass("__edit")?"E":B.hasClass("__create")?"N":"",pfJs:B.hasClass("__posting"),modernLayer:B.hasClass("__modern"),v2:B.hasClass("__v2"),hasActiveTopics:B.hasClass("__has-topics"),hasBanner:B.hasClass("__has-banner"),arrowsHidden:B.hasClass("__hide-arrows")},P=B.find("."+h),E=P.find("."+g),S=B.find("."+y),t?B.on("click",function(e){o.parent(e.target,"js-mlr-block",!1,!0)||ve("cr_shadow")}):S.on("click",function(e){ve("cr_shadow")}),E.on("click",function(e){ve("cr_close")}),M.isActive&&(oe(),M.isProcess||ge(!0,e)),e&&he(),i.on("resize.mtLayer",function(){ge()}),$.resolve(B))}function _e(){return OK.historyManager.getState()}function me(e,t){t?OK.historyManager.replaceState(e):OK.historyManager.pushState(e)}function ve(e,t){if("cr_shadow"!=e||""==M.pfMode){if(""!=M.pfMode&&!t&&("cr_esc"===e||"cr_close"===e)){t=B.find(".posting");if(0<t.length){var o=t[0].okPosting;if(o)return o.needConfirmBeforeClose()?o.showCloseConfirmDialog():o.closeWithoutConfirmDialog(),0}}z=!1,M.topicId=null,M.owner=null;var n=M.closeTopicId,a=M.closeOwnerType;if(M.closeTopicId=null,M.closeOwnerType=null,n&&("cr_esc"===e||"cr_shadow"===e||"cr_close"===e||"cr_fail"===e))return e&&ye(e+"_ct"),setTimeout(function(){OK.historyManager.isHistorySupported()?OK.historyManager.back():be(n,a,"")},0),0;o=!1;X()&&p&&_==_e()&&(p==_?(o=!0,OK.historyManager.back()):me(p,!0)),o||(se(!1),ce(!1),le(""),ue(!1),we(),Oe(),D.removeClass("__active __animated"),OK.hookModel.setHookContent(q,"")),p=null,e&&ye(e),B.trigger("mtLayer.close")}}function ye(e){f.success("mtlayer",b||"",e)}function we(){R.removeClass("__active"),x.removeClass("__active")}function Oe(){var e=r,t=e.find(".gwt-shortcutMenu__show");t.length&&t.removeClass("gwt-shortcutMenu__show");e=e.find(".sc-menu:not(.sc-menu__hidden,.poll_ans_cnt)");e.length&&(e=e.not("#ownProfileLSMnu")).addClass("sc-menu__hidden")}var Ce=[0,1,2,3,5,8,13,21,34,55,89,144,233,377,610];function Ke(e,t){for(var o=(t-e)/100,n=1;n<Ce.length&&!(o<Ce[n]);n++);return Ce[n-1]+"00"}function Te(){B&&B.scrollTop(0)}function ke(e){(M.isProcess?ce:ue)(!1),e&&e()}function Le(e,t,o,n,a){A=t,pe(o);var i=T("#"+q);M.market="true"==i.attr("data-market"),M.advertSelectionId=i.attr("data-adv-sel-id"),M.modernLayer="true"===i.attr("data-modernLayer"),M.v2="true"===i.attr("data-v2");var r=i.attr("data-log");r&&ye(r),le(i.attr("data-pf-mode")||!1),u="true"===i.attr("data-pf-js"),t=M.pfJs!==u,M.pfJs=u,t&&te();var s,c,l,d,u,f,r=i.attr("data-url");r?(u=r,OK.historyManager.isHistorySupported()&&(0<(t=u.indexOf("?"))?(m=u.substr(t+1),_=u.substr(0,t),_=decodeURIComponent(_),0<m.length?m+="&mt.scrollTop="+T(window).scrollTop():m=null,r=_,null!=(t=m)&&0!=t.length&&OK.historyManager.putItemToCache(r,t)):(_=u,m=null),u=_e()==_&&!A,p?f=!M.closeTopicId:(u?f=!0:A&&me(A,!0),p=_e()),A="",u||me(_,f))):(p||_!=_e()||me(p,!0),m=_=p=null),M.closeTopicId||n||(s=i.attr("data-back-id"),c=e,R&&(R.toggleClass("__active",!!s&&!!c),R.unbind("click.back").bind("click.back",function(e){var t;R.hasClass("__active")&&(t=x.hasClass("__active"),be(s,c,"MT_GoBack_"+c,!1,"","BACK",t)),OK.stop(e)})),l=i.attr("data-forward-id"),d=e,x&&(x.toggleClass("__active",!!l&&!!d),x.unbind("click.forward").bind("click.forward",function(e){var t;x.hasClass("__active")&&(t=R.hasClass("__active"),be(l,d,"MT_GoForward_"+d,!1,"","FORWARD",t)),OK.stop(e)})));n=i.attr("data-id");n&&(M.topicId=n,M.owner=e);e=i.attr("data-log-click");e?B.attr("data-l",e):B.removeAttr("data-l");var h,g=P.find("."+C);0<g.length&&(h=function(e){var t=e.delegateTarget.getAttribute("data-url"),o=e.delegateTarget.getAttribute("uid");t&&(o?T.ajax({type:"POST",url:t,data:{"gwt.requested":window.pageCtx.gwtHash},headers:{TKN:OK.tkn.get()}}).done(function(e,t,o){g.children().unbind("click.advert"),Ae("PLAdvertStatusBackToView",function(){P.find("."+C).children().bind("click.advert",h)})}):window.navigateOnUrlFromJS(t)),OK.stop(e)},g.children().bind("click.advert",h)),M.isProcess||te(),ke(a),fe([x,R,D],O),Te(),H=P.find("."+v),P.find("."+w),ge(!0,o,i.attr("data-scroll-to-marker"))}function Me(){return document.getElementById("hook_Block_"+J)?J:document.getElementById("hook_Block_"+W)?W:null}function be(e,h,t,g,o,p,_,n,m,v,y,a){pe(g);var w,u=Date.now(),O=-1,C=-1;function K(e){var t,o,n,a,i,r,s,c,l=Date.now(),d="";e&&(d+="r_"),ye((d+=p?"dt":"ot")+Ke(u,l)),w&&ye("js_"+d+Ke(w,l)),M.pfMode&&(t=l-u,o=O-u,n=C-O,a=l-C,i=b||"",s=OK.getCurrentDesktopModelId&&OK.getCurrentDesktopModelId(),r=(M.pfJs?"js.":"gwt.")+(L?"f.":"p.")+(s||""),0<t?((c=window.__gwtStatsEventsLog)&&c.bootstrap&&c.bootstrap.begin&&(e=u-c.bootstrap.begin,d=Math.floor(e/1e3),s=Math.floor(d/60),r+=0<(c=Math.floor(s/60))?".h"+c:20<=s?".m"+20*Math.floor(s/20):10<=s?".m10":5<=s?".m5":s<=3&&0<s?".m"+s:20<=d?".s"+20*Math.floor(d/20):".s"+10*Math.floor(d/10),f.duration("mtlayer",e,"start."+i+"."+M.pfMode,r)),f.duration("mtlayer",t,i+"."+M.pfMode,r),0<o&&(f.duration("mtlayer",o,"net."+i+"."+M.pfMode,r),f.duration("mtlayer",n,"act."+i+"."+M.pfMode,r),f.duration("mtlayer",a,"bnr."+i+"."+M.pfMode,r))):f.duration("mtlayer",l-u,i+"."+M.pfMode,r+"_wtf"))}p||(M.closeTopicId=null,M.closeOwnerType=null),t&&-1!==t.indexOf("st.mt.or=on")&&(m=M.topicId,v=M.owner),OK.photoLayer&&OK.photoLayer.close(),OK.VideoPlayer.pauseAll(),require.defined("OK/dailyphoto/dailyphoto-model")&&require(["OK/dailyphoto/dailyphoto-model"],function(e){e.togglePlayer&&e.togglePlayer(!1)}),OK.loader.use("OKCustomJs",function(){var e=OK.Layers.stack;e&&0<e.length&&e[e.length-1].id===s||!M.isActive||Z(!0)}),b=h,(A=o)&&ye("shortlink"),we(),M.isActive&&!M.isProcess?(ue(!0),Oe()):ce(!0),se(!0);o=OK.getCurrentStateLink(),o=(o+=-1===o.indexOf("?")?"?":"&").replace(/st\.mt\.(id|ot|bi|dir|hn|c7).*?(&|$)/g,"");o+="cmd="+q,t&&(o+="&st._aid="+t);t=function(e){var t=Me();if(!t||!M.isActive)return!1;if(e){e=document.getElementById(t+"Config");if(e){t=e.getAttribute("data-everyNDisplay");if(t){e=re(V);return 0===e||e%t==0}}}return!0}(!!p),a={"gwt.requested":window.pageCtx.gwtHash,"st.mt.id":e,"st.mt.ot":h,"st.mt.dir":p,"st.mt.wc":n?"on":"off","st.mt.hn":y?"on":"off","st.mt.ad":t?"on":"off","st.mt.bi":a||0,"st.mt.as":M.advertSelectionId},a=T.ajax({type:"POST",url:o,data:a,headers:{TKN:OK.tkn.get()}});return a.done(function(e,t,o){w=Date.now(),m&&(M.closeTopicId=m,M.closeOwnerType=v);var n,a,i=o.getResponseHeader("Redirect-Location");if(i){var r=function(e){OK.navigation.redirect&&OK.navigation.redirect(i),0===e||OK.navigation.redirect?(ve(),K()):setTimeout(function(){r(e-1)},200)};r(5)}else{if("yes"===o.getResponseHeader("End-Reached"))return"FORWARD"===p?_&&R.toggleClass("__active",!0):"BACK"==p&&_&&x.toggleClass("__active",!0),void ke(K);O=Date.now();for(var s,c=e.split(OK.navigation.SPLITER),l=o.getResponseHeader(OK.navigation.HEADER).split(","),d=0;d<c.length;d++){var u,f=l[d];f&&(u=c[d],OK.hookModel.setHookContent(f,u),f!==J&&f!==W||(s=u))}C=Date.now(),n=p,(o=s)?((a=document.createElement("div")).innerHTML=o,0===a.getElementsByClassName("media-layer_ads").length&&de(!1)):"true"===document.getElementById(q).getAttribute("data-hide-ad")?(ie(Me()),de(!1)):n&&M.hasBanner&&(n=re(a=V),B.attr(a,n+1)),Le(h,A,g,y,K)}(n=document.querySelector(".js-mediatopic-widget"))&&k.trigger(n,"refreshMediatopicWidget")}),a.fail(function(){ve("cr_fail"),K()}),a}function Ae(e,t){function s(){t&&t()}var o;M&&M.topicId&&M.owner?(o=OK.getCurrentStateLink(),o+=-1===o.indexOf("?")?"?":"&",(o=T.ajax({type:"POST",url:o+="cmd="+q+"&st._aid="+e,data:{"gwt.requested":window.pageCtx.gwtHash,"st.mt.id":M.topicId,"st.mt.ot":M.owner},headers:{TKN:OK.tkn.get()}})).done(function(e,t,o){var n=o.getResponseHeader("Redirect-Location");if(n)OK.navigation.redirect&&OK.navigation.redirect(n),ve();else for(var a=e.split(OK.navigation.SPLITER),i=o.getResponseHeader(OK.navigation.HEADER).split(","),r=0;r<a.length;r++)i[r]&&OK.hookModel.setHookContent(i[r],a[r]);s()}),o.fail(s)):s()}return{show:function(){pe(),se(!0),Te()},showPreloaded:Le,showTopicInLayer:be,closeLayer:function(e,t){G&&ve(e,t)},hideLayer:function(){z=!1,M&&M.isActive&&(p&&_e()==_&&me(p,!0),ee(!1,!1))},restoreLayer:function(){M&&M.isActive&&(fe([E,x,R,D],O),p&&_e()!==_&&me(_,!0),ee(!1,!0))},refreshLayerBody:function(e){Ae("PLPhotoUserBackToView",e)},deactivate:function(){T(window).off(".mtLayer"),E&&E.off(),S&&S.off(),se(!1)},updateActiveTopics:function(n,a,i){$.promise.then(function(e){M.hasActiveTopics=a,M.arrowsHidden=i;var t=n.getHeight(),o=I.outerHeight(!0);a?o<t?I.css("min-height",t):o-t<100&&n.setHeight(o):I.css("min-height",""),te()})}}});
