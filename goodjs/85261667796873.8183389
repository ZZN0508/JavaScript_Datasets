define(["css!search/1/typeahead.css"],function(){"use strict";var i={up:function(e){return 38===e.which},down:function(e){return 40===e.which},left:function(e){return 37===e.which},right:function(e){return 39===e.which},enter:function(e){return 13===e.which},esc:function(e){return 27===e.which}},n={cache:{},emptyResponse:{types:[]},template:'<li class="typeahead_li_fmt pos{pos}" data-pos="{pos}">{text}</li>',init:function(e){var t=this;this.el=$("#"+e),this.input=this.el.find(".typeahead-search"),this.output=this.el.find(".typeahead-output"),this.ajaxData={s:2,sz:6},this.ajaxUrl=this.url(),0<this.input.length&&0<this.output.length?(this.input.hasClass("disabletypeahead")?webmd.debug("typeahead disabled: remove disabletypeahead class from input box to enable"):(this.input.keydown(function(e){t.keydown(e)}).keyup(function(e){t.keyup(e,this)}).focus(function(){0<$(t.output).find("li").length&&t.output.fadeIn(150)}).blur(function(){setTimeout(function(){t.output.fadeOut(100),t.waitingOnAjax=null},300)}),this.output.delegate("li","click",function(){webmd.debug("link clicked-value:"+$(this).text()),t.input.val($(this).text()),webmd.debug("start search:"+$(this).text()),t.submit()}).delegate("li","mouseover",function(){t.output.find(".selected").removeClass("selected"),$(this).hasClass("selected")||$(this).addClass("selected"),t.selected=$(this).index()+1}).delegate("li","mouseout",function(){$(this).removeClass("selected")})),this.initialized=!0):webmd.debug("typeahead disabled: required input/output elements are missing or this page is not secured")},url:function(){var e="";return-1<document.location.hostname.indexOf(".perf.webmd")?e="perf.":-1<document.location.hostname.indexOf(".devintlive.webmd")&&(e="devintlive."),"//www."+e+"webmd.com/api/qrl/LookupService.ashx"},fetch:function(e){for(var t,i,s,u=this,n=(this.ajaxData.q=e).length-1;0<n;n--)if((t=e.substring(0,n))in this.cache&&0===this.cache[t].types.length){i=this.emptyResponse;break}return(i=e in this.cache?this.cache[e]:i)?this.callback(i):(s={type:"GET",cache:!0,url:this.ajaxUrl,dataType:"jsonp",data:this.ajaxData,jsonp:"jsonp",success:function(e){u.callback(e,u)}},$.ajax(s))},keydown:function(e){i.down(e)&&this._moveSelection(1),i.up(e)&&this._moveSelection(-1)},keyup:function(e,t){i.enter(e)?this.submit(!0):i.esc(e)?(this.output.fadeOut(100),this.waitingOnAjax=null):i.up(e)||i.down(e)?this.select(this.selected):this._inputTextNumChanged(t)&&(t=$(t).val(),this.prevInput=t.replace(/[^a-z0-9]/gi,""),2<(this.curSearch=t).length?this.search(this.curSearch):this._removeResults())},search:function(e){this.waitingOnAjax=e,this.resultsNum=0,!1===this.isThrottling?(webmd.debug("no throttling,search for:"+e),this.fetch(e),this.isThrottling=!0):(webmd.debug("throttling...adding to queue:"+e),this._addtoQueue(e))},callback:function(e,t){t=t||this;t.cache[t.ajaxData.q]=e,null!==t.waitingOnAjax?e.types&&e.types[0]&&e.types[0].references?(t.addResults(e.types[0].references),t.resultsNum=e.types[0].references.length):e.types.length<1&&(webmd.debug("empty results"),t._removeResults()):webmd.debug("prevented expired jsonp call")},addResults:function(e){this.selected=0;var i=this,s="",u=this.curSearch.toLowerCase().replace(/[^a-z0-9\s]/g,"").split(/[^a-z0-9]/);u=new RegExp(u.join("|"),"gi"),$.each(e,function(e,t){t={pos:e+1,text:t.text.replace(u,function(e){return"<span>"+e+"</span>"})};s+=webmd.substitute(i.template,t)}),this.output.html(s).fadeIn(100)},select:function(e){this.output.find(".selected").removeClass("selected"),this.output.find(".typeahead_li_fmt.pos"+e).addClass("selected"),0<this.output.find(".selected").length?this.input.val(this.output.find(".selected").text()):this.input.val(this.curSearch)},moduleMetrics:function(e,t){return 0<e?t+"_la"+e:t+"_submit"},submit:function(){this.form=this.el.closest("[data-metrics-module]").data("metrics-module")||"",webmd.search2=webmd.object(webmd.search,{submit:function(e,t,i){var s=n.moduleMetrics(t,i),u=webmd.url.getEnv(),t=webmd.url.getLifecycle(),i=location.protocol,t=u?webmd.substitute("{protocol}//www{environment}.webmd.com/search",{protocol:i,environment:u}):webmd.substitute("{protocol}//www{lifecycle}.webmd.com/search",{protocol:i,lifecycle:t});e&&(t+="/search_results/default.aspx?query="+e);try{ctrs(s)}catch(e){}return window.location.href=t,!1}}),webmd.search2.submit(this.input.val(),this.selected,this.form)},_removeResults:function(){var e=this;this.output.fadeOut(100),this.resultsNum=0,setTimeout(function(){e.output.html("")},100),this.waitingOnAjax=null},_moveSelection:function(e){0<this.resultsNum&&(this.selected=this.selected+e<=this.resultsNum&&0<=this.selected+e?this.selected+e:this.selected+e<0?this.resultsNum:0,this.select(this.selected))},_inputTextNumChanged:function(e){return this.prevInput!==$(e).val().replace(/[^a-z0-9]/gi,"")},_addtoQueue:function(e){var t=this;this.queue.length<1&&setTimeout(function(){t._fireQueue()},1e3),this.queue.push(e)},_fireQueue:function(){webmd.debug("fired queue:"+this.queue[this.queue.length-1]),this.fetch(this.queue[this.queue.length-1]),this.isThrottling=!1,this.queue=[]},resultsNum:0,initialized:!1,active:!1,form:"",selected:0,prevInput:"",curSearch:"",waitingOnAjax:null,isThrottling:!1,queue:[]},e={init:function(e){$.extend(!0,{},n).init(e)}};return e});
