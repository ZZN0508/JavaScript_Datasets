!function(){function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function e(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&i(e,t)}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function i(e,t){return(i=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function o(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function c(e,t,n){return(c=o()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);r=new(Function.bind.apply(e,r));return n&&i(r,n.prototype),r}).apply(null,arguments)}function f(e){var n="function"==typeof Map?new Map:void 0;return(f=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==n){if(n.has(e))return n.get(e);n.set(e,t)}function t(){return c(e,arguments,s(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),i(t,e)})(e)}function l(n){var r=o();return function(){var e,t=s(n);return e=r?(e=s(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),t=this,!(e=e)||"object"!=typeof e&&"function"!=typeof e?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(t):e}}function d(e,t,n){return(d="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){e=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=s(e)););return e}(e,t);if(e){t=Object.getOwnPropertyDescriptor(e,t);return t.get?t.get.call(n):t.value}})(e,t,n||e)}function h(e){return function(e){if(Array.isArray(e))return m(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||p(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function p(e,t){if(e){if("string"==typeof e)return m(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(n="Object"===n&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?m(e,t):void 0}}function m(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var v=function(){u(t,f(Error));var e=l(t);function t(){return a(this,t),e.apply(this,arguments)}return t}(),t=function(){u(t,f(Error));var e=l(t);function t(){return a(this,t),e.apply(this,arguments)}return t}(),y=function(){u(t,f(Error));var e=l(t);function t(){return a(this,t),e.apply(this,arguments)}return t}(),g=function(){u(t,y);var e=l(t);function t(){return a(this,t),e.apply(this,arguments)}return t}(),w=function(){u(t,y);var e=l(t);function t(){return a(this,t),e.apply(this,arguments)}return t}(),b=function(){u(t,w);var e=l(t);function t(){return a(this,t),e.apply(this,arguments)}return t}();function _(e){if(!Array.isArray(e))throw new t("Provided argument must be an instance of Array.")}function S(e){return!!Array.isArray(e)&&e.every(function(e){return"number"==typeof e})}function j(e){return 1/(1+Math.exp(-e))}var A=(e(n,[{key:"transform",value:function(e){if(!(this.feature in e))throw new b("Unable to transform feature ".concat(this.feature,", missing input ").concat(this.feature,". \n                    Provided: ").concat(Object.keys(e),", Required: ").concat(this.dependencies));return e[this.feature]}},{key:"dependencies",get:function(){return[this.feature]}}]),n),O=function(){u(r,A);var n=l(r);function r(e,t){return a(this,r),(e=n.call(this,e)).interactions=t,e}return e(r,[{key:"transform",value:function(t){for(var n=this,e=this.interactions.map(function(e){if(!(e in t))throw new b("Unable to transform feature ".concat(n.feature,", missing input ").concat(e,".\n                    Provided: ").concat(Object.keys(t),", Required: ").concat(n.dependencies));return t[e]}).sort(function(e,t){return t.length-e.length}),r=0;r<e.length-1;r++){if(1!==e[r].length&&e[r].length!==e[r+1].length&&1!==e[r+1].length)throw new b("Unable to perform MultiplicativeInteraction: shapes can not be broadcasted.");if(!S(e[r]))throw new b("Unable to perform MultiplicativeInteraction: not all inputs are of type number[]")}for(var i=h(e[0]),o=1;o<e.length;o++)for(var a=0;a<i.length;a++)1<e[o].length?i[a]=i[a]*e[o][a]:i[a]=i[a]*e[o][0];return i}},{key:"dependencies",get:function(){return this.interactions}}]),r}(),k=function(){u(i,A);var r=l(i);function i(e,t,n){return a(this,i),(e=r.call(this,e)).input=t,e.value=n,e}return e(i,[{key:"transform",value:function(e){if(!(this.input in e))throw new b("Unable to transform feature '".concat(this.feature,"'. Missing required input '").concat(this.input,"'."));var t=e[this.input];if(t.length!==this.value.length)return[0];for(var n=0;n<t.length;n++)if(t[n]!==this.value[n])return[0];return[1]}},{key:"dependencies",get:function(){return[this.input]}}]),i}(),E=function(){u(o,A);var i=l(o);function o(e,t,n,r){return a(this,o),(e=i.call(this,e)).input=t,e.min=n,e.max=r,e}return e(o,[{key:"transform",value:function(e){if(!(this.input in e))throw new b("Unable to transform feature '".concat(this.feature,"'. Missing required input '").concat(this.input,"'."));for(var t=h(e[this.input]),n=0;n<t.length;n++)this.min&&t[n]<this.min?t[n]=this.min:this.max&&t[n]>this.max&&(t[n]=this.max);return t}},{key:"dependencies",get:function(){return[this.input]}}]),o}(),R=function(){u(o,A);var i=l(o);function o(e,t,n,r){return a(this,o),(e=i.call(this,e)).input=t,e.min=n,e.scale=r,e}return e(o,[{key:"transform",value:function(e){if(!(this.input in e))throw new b("Unable to transform feature '".concat(this.feature,"'. Missing required input '").concat(this.input,"'."));var t=e[this.input];if(t.length!==this.min.length||t.length!==this.scale.length)throw new b("Unable to transform feature '".concat(this.feature,"'. Shapes do not match."));if(!S(t))throw new b("Unable to transform feature '".concat(this.feature,"'. The input must be an array of numbers."));for(var n=new Array(t.length),r=0;r<t.length;r++)n[r]=this.scale[r]*t[r]+this.min[r];return n}},{key:"dependencies",get:function(){return[this.input]}}]),o}();function n(e){a(this,n),this.feature=e}function C(e){return"type"in e&&"string"==typeof e.type}var P=(e(I,[{key:"dependencies",get:function(){return this.transformer.dependencies}}]),I);function I(e,t,n){a(this,I),this.name=e,this.transformer=t,this.index=n}function T(n){var e=n.features;return _(e),e.map(function(e,t){return n.model.features&&(t=n.model.features.indexOf(e.name)),new P(e.name,function(e){if(!e.transformation)return new A(e.name);if(C(t=e.transformation)&&"multiplication"===t.type)return new O(e.name,e.transformation.features);var t;if(C(t=e.transformation)&&"equality"===t.type)return new k(e.name,e.transformation.input,e.transformation.value);if(C(t=e.transformation)&&"clipping"===t.type)return new E(e.name,e.transformation.input,e.transformation.min,e.transformation.max);if(C(t=e.transformation)&&"minmax_scaling"==t.type)return new R(e.name,e.transformation.input,e.transformation.min,e.transformation.scale);throw new g("Selected transformation (".concat(e.transformation.type,") is not supported."))}(e),t)})}var x=(e(q,[{key:"_getFeatureValue",value:function(n,r,i){var o=this;if(n.name in i)return i[n.name];if(1!==n.dependencies.length||n.dependencies[0]!==n.name)return n.dependencies.forEach(function(t){var e=o.features.find(function(e){return e.name===t});if(!e)throw new w("Feature '".concat(n.name,"' is dependent on ").concat(t,", but this feature has not been defined!"));if(e.transformer.dependencies.includes(n.name))throw new w("IllegalDependency: Feature '".concat(n.name,"' is dependent on ").concat(t,"', but '").concat(t," is also dependent on '").concat(n.name,"'!"));o._getFeatureValue(e,r,i)}),i[n.name]=n.transformer.transform(i),i[n.name];var e=this.measurements.get(n.name,r);return i[n.name]=[e],i[n.name]=n.transformer.transform(i),i[n.name]}},{key:"get",value:function(t){var n=this,r={},i={};return this.features.forEach(function(e){-1!==e.index&&(r[e.name]=n._getFeatureValue(e,t,i))}),r}}]),q),M=Object.freeze({LOGISTIC_REGRESSION:"logistic_regression",PASSTHROUGH:"passthrough"});function q(e,t){a(this,q),this.features=t,this.measurements=e}function F(e){if(!e.model_id)throw new g("Could not load model: missing required value model_id");if(!e.definition)throw new g("Could not load model: missing required definition");var t,n,r,i=JSON.parse(e.definition);if(!i.model)throw new g("Could not load model: missing required field 'model' in the model definition.");if(!i.features)throw new g("Could not load model: missing required feature definitions.");return!(i=i.model.type===M.PASSTHROUGH?(t=e.model_id,r=T(n=i),new G(t,r,null!==(n=n.version)&&void 0!==n?n:"")):function(e,t){if(e.model.type!==M.LOGISTIC_REGRESSION)throw new g("Could not load model with unsupported type: ".concat(e.model.type));var n=T(e),r=function(e){if("logistic_regression"!==(null==(t=e)?void 0:t.type)||!S(null==t?void 0:t.weights)||"number"!=typeof(null==t?void 0:t.bias))throw new g("Received invalid model configuration: the provided config is not a LogisticRegressionConfig");var t;return new D(e.weights,e.bias)}(e.model);return new V(t,n,r,null!==(e=e.version)&&void 0!==e?e:"")}(i,e.model_id)).version&&e.version&&(i.version=e.version),i}function U(n){var e,r=this;a(this,U),this.domain={},this.media={},this.defaults={},null!==(e=null===(e=null==n?void 0:n.jwpseg)||void 0===e?void 0:e.metrics)&&void 0!==e&&e.domain&&(this.domain=null==n?void 0:n.jwpseg.metrics.domain),null!==(e=null===(e=null==n?void 0:n.jwpseg)||void 0===e?void 0:e.metrics)&&void 0!==e&&e.defaults&&(this.defaults=null==n?void 0:n.jwpseg.metrics.defaults),null!==(e=null===(e=null==n?void 0:n.jwpseg)||void 0===e?void 0:e.metrics)&&void 0!==e&&e.media&&Object.keys(null==n?void 0:n.jwpseg.metrics.media).forEach(function(e){var t;r.media[e]=null!==(e=null===(t=null===(t=null===(t=null==n?void 0:n.jwpseg)||void 0===t?void 0:t.metrics)||void 0===t?void 0:t.media)||void 0===t?void 0:t[e])&&void 0!==e?e:{}})}var D=(e($,[{key:"predict",value:function(e){if(!(e instanceof Array))throw new w("FeatureProcessor must be provided as an Array.");e=function(e){if("number"==typeof e)return j(e);_(e);for(var t=[],n=0;n<e.length;n++)t.push(j(e[n]));return t}(function(e,t){if(_(e),_(t),e.length!==t.length)throw new v("Vectors must have equal length (".concat(e.length," != ").concat(t.length,")"));for(var n=0,r=0;r<e.length;r++)n+=e[r]*t[r];return n}(e,this.weights)+this.bias);return[1-e,e]}}]),$),L=(e(W,[{key:"getFeatures",value:function(e,t){return new x(e,this.featureColumns).get(t)}}]),W),V=function(){u(o,L);var i=l(o);function o(e,t,n,r){if(a(this,o),r=i.call(this,e,t,r),!(n instanceof D))throw new y("logisticRegression must be an instanceof LogisticRegression");return r.logisticRegression=n,r}return e(o,[{key:"predict",value:function(t){var n=[];return this.featureColumns.reduce(function(e,t){return-1!==t.index&&e.push(t),e},[]).sort(function(e,t){return e.index-t.index}).forEach(function(e){if(!(e.name in t))throw new w("Missing required feature: ".concat(e.name));n=n.concat(t[e.name])}),this.logisticRegression.predict(n)[1]}}]),o}(),G=function(){u(o,L);var r=l(o);function o(e,t,n){return a(this,o),r.call(this,e,t,n)}return e(o,[{key:"getFeatures",value:function(e,t){var n;try{n=d(s(o.prototype),"getFeatures",this).call(this,e,t)}catch(e){var r={},i=[-1];(t=this.passthroughFeatureColumn.name)in r?Object.defineProperty(r,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):r[t]=i,n=r}return n}},{key:"predict",value:function(e){var t=this.passthroughFeatureColumn;return t.name in e||(e[t.name]=[-1]),e[t.name][0]}},{key:"passthroughFeatureColumn",get:function(){if(void 0!==this._passthroughFeatureColumn)return this._passthroughFeatureColumn;var e=this.featureColumns.reduce(function(e,t){return-1!==t.index&&e.push(t),e},[]).sort(function(e,t){return e.index-t.index});if(e.length<1)throw new w("Could not determine passthrough feature column: model definition is invalid");if(1<e.length)throw new w("Could not determine passthrough feature column: multiple columns were provided");return this._passthroughFeatureColumn=e[0],this._passthroughFeatureColumn}}]),o}(),N=(e(J,[{key:"getPlaySessionSequence",value:function(){return this.playSessionSequence||0}},{key:"getAdvanceType",value:function(){return this.advanceType}}]),J),H={viewable:2},z=(e(Y,[{key:"get",value:function(e,t){if(e in this.PLAYER_MEASUREMENT_MAP)return this.PLAYER_MEASUREMENT_MAP[e]();t=t&&"mediaid"in t?t.mediaid:null;if(t&&t in this.metrics.media&&e in this.metrics.media[t])return this.metrics.media[t][e];if(this.metrics.domain&&e in this.metrics.domain)return this.metrics.domain[e];if(this.metrics.defaults&&e in this.metrics.defaults)return this.metrics.defaults[e];throw new w("Unsupported measurement: ".concat(e))}}]),Y);function Y(t,e,n){a(this,Y),this.PLAYER_MEASUREMENT_MAP={is_player_viewable_at_inference_time:t.getViewable,is_player_viewable:t.getViewable,is_player_muted:t.getMute,play_session_sequence:e.getPlaySessionSequence,autostart:function(){var e=t.getConfig();return e.autostart&&e.autostart in H?H[e.autostart]:e.autostart?1:0},advance_type:e.getAdvanceType},this.metrics=n}function J(e){var t=this;a(this,J),this.playSessionSequence=0,this.advanceType="unknown",e.on("playlistItem",function(){t.playSessionSequence||(t.playSessionSequence=0),t.playSessionSequence++}),e.on("nextAutoAdvance",function(){t.advanceType="auto"}),e.on("feedAutoAdvance",function(){t.advanceType="auto"}),e.on("nextClick",function(){t.advanceType="click"}),e.on("feedClick",function(){t.advanceType="click"})}function W(e,t,n){a(this,W),_(t),this.featureColumns=t,this.modelId=e,this.version=n}function $(e,t){if(a(this,$),!S(e))throw new y("Weights must be provided as an Array.");this.weights=e,this.bias=t}(window.jwplayerPluginJsonp||window.jwplayer().registerPlugin)("inference","7.0",function(u,e,t){var s,n,c,f,l=!1,r=new N(u);function i(){if(!l){if(!s||!n){if(!(n=u.getPlaylist())||"string"==typeof n)return l=!1;var e=u.getPlaylistItem();if(!e||!e.feedData)return;s=null!==(e=e.feedData)&&void 0!==e?e:{}}if(null!==(e=null==s?void 0:s.jwpseg)&&void 0!==e&&e.parameters){try{c=Object.entries(s.jwpseg.parameters).reduce(function(e,t){var n,t=(n=2,function(e){if(Array.isArray(e))return e}(t=t)||function(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var n=[],r=!0,i=!1,o=void 0;try{for(var a,u=e[Symbol.iterator]();!(r=(a=u.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{r||null==u.return||u.return()}finally{if(i)throw o}}return n}}(t,n)||p(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),n=t[0],t=t[1];return e[n]=(t=t,Array.isArray(t)?t.map(F):[F(t)]),e},{})}catch(e){return console.warn("Failed to initialize the inference plugin: ".concat(e)),o(),0}f=new z(u,r,new U(s)),l=!0}else o()}}function o(){f=c=n=s=null,l=!1}return u.on("playlist",function(e){o(),s=e.feedData,n=e.playlist,i()}),i(),{predict:function(e,i){if(!l||!f)throw new w("The InferencePlugin has not been initialized.");var t=null===(n=null==s?void 0:s.jwpseg)||void 0===n?void 0:n.target_profiles;if(!t)throw new w("Feed did not contain targeting profiles!");var n,r,o={},a={};return e.forEach(function(e){var r=null==t?void 0:t[e];if(!r)throw new w("The segment ".concat(e," does not have any targeting criteria defined."));a[e]=Object.keys(r).every(function(e){if(e in o)return o[e].prediction>r[e];var t=function(e){var t,n,r,i,o=u.getConfig().__ab_inference;if(!(r=null!==(t=null==o?void 0:o.modelMap)&&void 0!==t&&t[e]?(n=o.modelMap[e],null==c?void 0:c[e].find(function(e){return e.modelId===n})):(r=null!==(r=null==c?void 0:c[e])&&void 0!==r?r:[],(i=r.map(function(e){return e.modelId})).sort(function(e,t){return e.localeCompare(t)}),r.find(function(e){return e.modelId===i[0]}))))throw new w("Could not make predictions for target '".concat(e,"': no model available to support the request."));return r}(e),n=t.getFeatures(f,i);return o[e]={modelVersion:t.version,prediction:t.predict(n),modelId:t.modelId},o[e].prediction>r[e]})}),u.trigger("inference",{predictions:o,playlistItem:i,segments:(n=i,r=a,e={processed:(e=e).join(",")},n&&n.jwpseg&&Array.isArray(n.jwpseg)&&(e.historicalApproved=n.jwpseg.join(",")),r&&(e.realTimeApproved=Object.keys(r).filter(function(e){return r[e]}).join(",")),e)}),a},version:"0.6.0"}})}();
