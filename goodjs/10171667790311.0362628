define(["OK/reactions/ReactionController","OK/reactions/ReactionLogger","OK/LinkedHooksStore","OK/ShortcutMenuReact","OK/Surprise","OK/utils/dom","OK/utils/vanilla"],function(a,r,i,s,o,c,h){var n;require(["OK/ExpressReactionsPopup"]);var l=i.collections.REACTION_COMPONENTS;function t(){this.onClick=this.onClick.bind(this),this.switchLogTarget=this.switchLogTarget.bind(this)}return t.prototype={activate:function(t){this.el=t,this.blockHookId=OK.hookModel.getNearestBlockHookId(t),this.blockHook=document.getElementById("hook_Block_"+this.blockHookId),this.reactScMenuId="ShMenuExpressReact-"+this.blockHookId,this.refId=t.getAttribute("data-like-reference-id"),this.hookId=t.getAttribute("data-req"),this.owner=t.getAttribute("data-owner"),this.isPreview="1"===t.getAttribute("data-preview"),this.isButton="1"===t.getAttribute("data-button"),this.isCustomButton="1"===t.getAttribute("data-custom-button"),this.likeReactionData={reactionId:0,icon:t.getAttribute("data-like-icon"),text:t.getAttribute("data-like-tx")},this.customReactionData={reactionId:+t.getAttribute("data-custom-reaction-id"),icon:t.getAttribute("data-custom-reaction-icon"),text:t.getAttribute("data-custom-reaction-tx"),surprise:t.getAttribute("data-custom-reaction-surprise")};var e=parseInt(t.getAttribute("data-react"),10);this.reactionId=isNaN(e)?null:e,this.reactionCount=parseInt(t.getAttribute("data-count"),10)||0,this.logLocation=t.getAttribute("data-ll"),this.isButton||this.isCustomButton||i.add(this.refId,l,this.hookId),this.isButton||t.addEventListener("click",this.onClick),this.syncPlayersLikes(),this.switchLogTarget(),s.setReactComponent(this.blockHookId,this),setTimeout(this.addReactSMListeners.bind(this)),this.addLikesSMListeners(),this.isCustomButton&&(this.onReactionExternalChange=this.onReactionExternalChange.bind(this),a.subscribe(this.refId,this.onReactionExternalChange))},deactivate:function(){i.remove(this.refId,l,this.hookId),this.isButton||this.el.removeEventListener("click",this.onClick),this.surprise&&(this.surprise.destroy(),this.surprise=null),this.likersOnCountShm&&this.likersOnCountShm.hide(),s.removeReactComponent(this.blockHookId,this)},syncPlayersLikes:function(){var t;!this.blockHook||(t=this.blockHook.getAttribute("data-player-id"))&&runLinkedVideoCallbackFromJS({callbackId:t,liked:null!==this.reactionId,likeCount:this.reactionCount})},switchLogTarget:function(){var t=this.getReactScMenu();null===this.reactionId?this.el.setAttribute("data-l","t,.l"):t&&t.visible()?this.el.setAttribute("data-l","t,hide-react-sc"):this.el.setAttribute("data-l","t,unlike")},getReactScMenu:function(){var t=OK.hookModel.getHookById(this.reactScMenuId);return t&&t.getInstance()},addReactSMListeners:function(){var t=this.getReactScMenu();t&&(t.menuShownListener=this.switchLogTarget,t.tmpReactionsActiveInstanceListener=this.switchLogTarget)},addLikesSMListeners:function(){var t=this.el.querySelector(".js-sleep-shm");t&&(this.likersOnCountShm=new s,this.likersOnCountShm.activate(t),this.likersOnCountShm.tmpReactionsActiveInstanceListener=this._activateSMListener.bind(this))},_activateSMListener:function(){var t=this.getReactScMenu();t&&(t.tmpReactionsDisabled=this.likersOnCountShm.visible(),t.tmpReactionsDisabled||t.checkAfterTmpReactionsDisabled())},onClick:function(t){var e,i=this.isPreview,s=this.getReactScMenu();if(this.isCustomButton){this._doChangeReaction(this.customReactionData,this.reactionId);var n=this.customReactionData.surprise;return n?(this.surprise&&(this.surprise.destroy(),this.surprise=null),this.surprise=new o.Surprise(this.el,n,t.clientX,t.clientY),void this.surprise.run()):void 0}i&&s&&s.visible()?s.hideMenu():(s&&(s.visible()&&s.hideMenu(),s.isWaitingBeforeShow()&&s.abortWaitingBeforeShow()),e=null!==this.reactionId?null:(e=c.parent(t.target,"js-klass-action",this.el,!0),this.isCustomButton||e&&"private"===e.getAttribute("data-klass-type")?this.customReactionData:this.likeReactionData),this._doChangeReaction(e,this.reactionId))},changeReaction:function(t,e,i){return this.isPreview=i.mode===a.ORDER_MODE.ONLY_DRAW,this._doChangeReaction(t,e,i)},getCurrentReactionData:function(){if(null===this.reactionId)return null;var t=c.firstByClass(this.el,"widget_tx");return{reactionId:this.reactionId,icon:this.el.getAttribute("data-react-icon"),text:t?t.textContent:""}},onReactionExternalChange:function(t){var e=c.parent(this.el,"widget-list_i");e&&e.classList.toggle("invisible",null!==t.reactionId),this.reactionId=t.reactionId},refreshView:function(t){var e,i,s,n,o,a;this.isButton||this.isCustomButton||(e=c.firstByClass(this.el,"widget_ico"),(i=this.getCurrentReactionData())?e.classList.remove("__react","__react-"+i.icon):e.classList.remove("ic_klass"),a=c.firstByClass(this.el,"js-count"),s=this.el.parentNode,n=c.firstByClass(this.el,"js-private-klass"),o=this.el.classList.contains("__multi"),!a&&o&&((a=document.createElement("span")).className="widget_count widget_part js-count __empty",a.textContent=h.formatNumber(0),this.el.appendChild(a)),a&&(o=a.textContent.replace(/\s/g,""),isNaN(o)||(o=parseInt(o,10),a.textContent=h.formatNumber(o=i?t?o:o-1:t?o+1:o),0===o&&n&&this.el.removeChild(a))),a=c.firstByClass(this.el,"widget_tx"),t?(this.el.setAttribute("data-react-icon",t.icon),e.classList.add("__react","__react-"+t.icon),a&&(a.textContent=t.text),s.setAttribute("data-react",t.icon),s.classList.add("__active"),n&&n.classList.add("invisible")):(e.classList.add("ic_klass"),a&&(a.textContent=this.el.getAttribute("data-unlike-tx")),s.removeAttribute("data-react"),s.classList.remove("__active"),n&&n.classList.remove("invisible")))},_doChangeReaction:function(t,e,i){this.refreshView(t);var s=t?t.reactionId:null;e=void 0!==e?e:this.reactionId;var n=!i||i.mode!==a.ORDER_MODE.ONLY_DRAW;n&&(null!==s?r.logReaction("like",s):r.logReaction("unlike",e)),this.reactionId=s;var o={ll:this.logLocation};return i&&i.payload&&(Object.assign(o,i.payload),delete i.payload),this._getImpressionId().then(function(t){t&&(o.impressionId=t)}).then(function(){try{a.notify(Object.assign({refId:this.refId,reactionId:s,prevReactionId:e,owner:this.owner,payload:o},i))}catch(t){n&&(null!==s?r.logReactionError("like-notify-error",t.message):r.logReactionError("unlike-notify-error",t.message))}}.bind(this))},_getImpressionId:function(){var e=this.el,t=e.closest(".js-video-scope");if(t){t=t.getAttribute("data-impression-id");if(t)return Promise.resolve(t)}return new Promise(function(t){var i;i=e,new Promise(function(t,e){(n?Promise.resolve(n):(require(["OK/alf"],function(t){n=t}),Promise.reject())).then(function(t){return t.findAdv(i)}).then(t,e)}).then(function(t){return t.getImpressionId()}).catch(function(){return null}).then(t),setTimeout(function(){t(null)},5e3)})}},t});
