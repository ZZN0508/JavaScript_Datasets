define(["OK/utils/dom","OK/utils/utils","OK/entitySuggest/AbstractEntitySuggest","OK/LogSeen","OK/utils/throttle"],function(i,e,s,l,n){"use strict";function t(){}return t.prototype.changeState=function(t){this.hook.classList.toggle("__empty",t)},t.prototype.logSlidesSeen=function(t,e){var i=this.slider.getElementsByClassName("js-entity-item");if(i&&0<i.length){for(var s=[],n=t;n<t+e&&i[n];n++){var d=parseInt(i[n].getAttribute("data-entity-id"),10)||null;null!==d&&s.push(d)}0<s.length&&(this.seenParams.data.user_ids=s.join(","),l.logSuccess(this.seenParams.type,JSON.stringify(this.seenParams.data)))}},t.prototype.logSlidesIfInViewPort=function(){try{e.isElementInViewport(this.slider)&&(this.logSlidesSeen(this.sliderOffset,parseInt(this.slider.getAttribute("data-visibleSlides"),10)||0),this.removeLogSeenOnWindowScrollListeners())}catch(t){}},t.prototype.removeLogSeenOnWindowScrollListeners=function(){window.removeEventListener("scroll",this.logSeenOnWinowScroll),window.removeEventListener("keydown",this.logSeenOnWinowScroll)},t.prototype.activate=function(t){this.marker=t.getAttribute("data-slider-marker")||null,this.loadActivityId=t.getAttribute("data-load-aid")||"Feed_PossibleFriends_LoadFriendChunk",this.sliderOffset=0,this.lastRemovedEntityIndex=null,this.hook=t,this.slider=i.firstByClass(t,"uslider"),this.entitySuggest=i.firstByClass(t,"js-entity-suggest"),this.type=this.entitySuggest.getAttribute("data-type"),this.entitySuggestInstance=null,this.suggestFriendsPortlets=s.prototype.getPortlets(this.type),this.mode=this.entitySuggest.getAttribute("data-mode"),this.userId=this.entitySuggest.getAttribute("data-user-id"),this.isLargeCard="true"===this.entitySuggest.getAttribute("data-large-card");t=t.getAttribute("data-seen-params");if(t)try{this.seenParams=JSON.parse(t)}catch(t){this.seenParams=null}this.getNewSliderItems=function(d){this.seenParams&&this.logSeenOnSlide(d),this.suggestFriendsPortlets&&this.entitySuggest&&(this.entitySuggestId=parseInt(this.entitySuggest.getAttribute("data-entity-suggest-id"),10),this.entitySuggestInstance=this.suggestFriendsPortlets[this.entitySuggestId]),this.entitySuggestInstance&&this.marker&&d.detail.totalSlides-d.detail.offset<d.detail.visibleSlides+2&&e.ajax({url:s.urlConfig[this.type],data:{"st.modes":this.mode,list:Object.keys(s.prototype.getCommonEntities(this.type)).join(";"),slideSequence:!0,"st._aid":this.loadActivityId,marker:this.marker,largeCard:this.isLargeCard,"st.fid":this.userId}}).done(function(t,e,i){var s=t.split(OK.navigation.SPLITER),n="";this.marker=i.getResponseHeader("marker"),s.forEach(function(t){t&&(n=n+'<div class="uslider_i">'+t+"</div>")}),this.entitySuggestInstance.append(n);t=!d.detail.totalSlides&&!t;this.changeState(t)}.bind(this)),this.marker||d.detail.totalSlides||this.changeState(!0)}.bind(this),this.changeSliderItemsCount=function(t){var e;"remove"===t.detail.type&&(e=i.byClass(this.slider,"uslider_i"),this.lastRemovedEntityIndex=t.detail.index,void 0!==this.lastRemovedEntityIndex?(i.remove(e[this.lastRemovedEntityIndex]),this.slider.dispatchEvent(new CustomEvent("uSliderUpdateCount",{detail:{type:"remove"}}))):this.lastRemovedEntityIndex=null),"append"===t.detail.type&&this.slider.dispatchEvent(new CustomEvent("uSliderUpdateCount",{detail:{type:"append"}})),"replace"===t.detail.type&&this.seenParams&&(e=parseInt(this.slider.getAttribute("data-visibleSlides"),10)||0,this.sliderOffset<=t.detail.index&&this.sliderOffset+e-1>=t.detail.index&&this.logSlidesSeen(t.detail.index,1))}.bind(this),this.seenParams&&(this.logSeenOnWinowScroll=n(150,function(t){t.isTrigger||this.logSlidesIfInViewPort()}.bind(this)),this.logSeenOnSlide=function(t){var e,i;("slide"===t.detail.action||"remove"===t.detail.action&&this.sliderOffset<=this.lastRemovedEntityIndex&&this.sliderOffset+t.detail.visibleSlides>=this.lastRemovedEntityIndex)&&(0==(i=t.detail.offset-this.sliderOffset)?null!==this.lastRemovedEntityIndex&&(this.logSlidesSeen(this.lastRemovedEntityIndex,1),this.lastRemovedEntityIndex=null):(e=Math.abs(i),i=this.sliderOffset+i,this.sliderOffset=t.detail.offset,this.logSlidesSeen(i,e)))}.bind(this),window.addEventListener("scroll",this.logSeenOnWinowScroll),window.addEventListener("keydown",this.logSeenOnWinowScroll),this.logSlidesIfInViewPort()),this.slider.addEventListener("uSliderAction",this.getNewSliderItems),this.entitySuggest.addEventListener("entitySuggestUpdateCount",this.changeSliderItemsCount)},t.prototype.deactivate=function(){this.seenParams&&this.removeLogSeenOnWindowScrollListeners(),this.slider.removeEventListener("uSliderAction",this.getNewSliderItems),this.entitySuggest.removeEventListener("entitySuggestUpdateCount",this.changeSliderItemsCount)},t});
