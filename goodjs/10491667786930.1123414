define(["OK/utils/throttle","OK/utils/dom","OK/utils/utils","OK/logger"],function(t,g,r,c){"use strict";function e(t){this.element=t,this.autoplay="true"===t.getAttribute("data-autoplay"),this.nostop="true"===t.getAttribute("data-nostop"),this.inMessages="true"===t.getAttribute("data-messages"),this.playOnParent="true"===t.getAttribute("data-playOnParent"),this.location=t.getAttribute("data-location")||"u",this.volume=parseInt(t.getAttribute("data-volume")||"1",10),this.volumeControl="true"===t.getAttribute("data-volumeControl"),this.photoId=t.getAttribute("data-photoId"),this.groupPhoto="true"===t.getAttribute("data-groupPhoto")||void 0,t=g.parent(this.element,this.playOnParent?"js-gifPlay":"media-photos_i"),this.addButton=g.firstByClass(t,"gif-add"),this.gifContainer=this.element.parentNode,this.playOnParent&&(this.gifContainer=g.parent(this.element,"js-gifPlay")),this.boundPlay=this.play.bind(this),this.boundStop=this.stop.bind(this),this.boundToggleVolume=this.toggleVolume.bind(this),this.boundCanPlayHandler=this.canPlayHandler.bind(this),this.boundPlayingHandler=this.playingHandler.bind(this),this.boundErrorHandler=this.errorHandler.bind(this),this.autoplay?this.nostop?this.play():this.playOrStop():this.gifContainer&&(this.gifContainer.addEventListener("mouseenter",this.boundPlay),this.gifContainer.addEventListener("mouseleave",this.boundStop)),this.volumeControl&&(this.volumeToggler=g.firstByClass(this.gifContainer,".js-volumeControl"),this.volumeToggler&&this.volumeToggler.addEventListener("click",this.boundToggleVolume))}var d,i=[];function s(t,e){var i,s,a=t.getAttribute("data-id"),o=t.getAttribute("data-type"),n=t.getAttribute("data-tkn"),l=t.getAttribute("data-container-id");!0===e?(t.classList.add("invisible"),(i=t.nextElementSibling)&&i.classList.contains("js-clonePhotoDone")&&i.classList.remove("invisible")):((i=g.parent(t,"ovr-menu_soh"))&&i.classList.add("__success"),(t=g.parent(t,"gif-add"))&&(t.classList.add("__gif-success"),(s=g.firstByClass(t,"sc-menu"))&&s.classList.add("__gif-success")),d=d||document.getElementById("hook_Block_ShortcutMenu"),(s=g.firstByClass(d,"sc-menu"))&&(s.classList.add("__gif-success"),d.dispatchEvent(new CustomEvent("change",{bubbles:!0})))),r.ajax({type:"POST",contentType:"application/json; charset=utf-8",url:"/web-api/photo/add",timeout:6e4,data:JSON.stringify({photoId:a,type:o,tkn:n,cntId:l})})}function a(t){s(t.currentTarget,!1)}e.prototype={deactivate:function(){this.gifContainer&&(this.gifContainer.removeEventListener("mouseenter",this.boundPlay),this.gifContainer.removeEventListener("mouseleave",this.boundStop)),this.volumeToggler&&this.volumeToggler.removeEventListener("click",this.boundToggleVolume)},playOrStop:function(){var t,e;this.autoplay&&(t=this.element.classList.contains("__playing")||this.element.classList.contains("__loading"),(e=r.isElementPartiallyInViewport(this.element,.4))&&!t?this.play():e||!t||this.nostop||this.stop())},toggleVolume:function(t){t.stopPropagation(),t.preventDefault();var e,i=this.getVideo();i&&(e=0===i.volume,this.muteAll(),i.volume=e?1:0,i.muted=!e,e?t.target.classList.add("__animated"):t.target.classList.remove("__animated"))},mute:function(){var t=this.getVideo();t&&(t.volume=0,t.muted=!0,this.volumeToggler&&this.volumeToggler.classList.remove("__animated"))},isSupportsMp4:function(t){return!this.skipMp4&&0<t.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"').length},isSupportsWebm:function(t){return!this.skipWebm&&0<t.canPlayType("video/webm").length},canPlayHandler:function(t){t.currentTarget.play(),this.playing||c.duration("photo.gif",Math.max(Date.now()-this.startTime,0),"video_start",this.location)},playingHandler:function(){this.element.classList.add("__playing"),this.addButton&&this.addButton.classList.add("__playing"),this.element.classList.remove("__loading"),this.playing||(this.playing=!0,c.duration("photo.gif",Math.max(Date.now()-this.startTime,0),"video_play",this.location),c.success("photo.gif.inplace",location,this.autoplay?"a":"m"),c.raw("photo.gif",{g:this.groupPhoto,pid:this.photoId,d:Math.max(Date.now()-this.startTime,0),p1:"video_play"}))},errorHandler:function(t){var e="und",t=t.currentTarget;this.stop(!0),t.error&&t.error.code?(this.isSupportsMp4(t)?(this.skipMp4=!0,e="mp4"):this.isSupportsWebm(t)&&(this.skipWebm=!0,e="webm"),c.success("photo.gif","video_fail_"+e+"_"+t.error.code,this.location),this.play()):c.success("photo.gif","video_fail_"+e,this.location)},play:function(){var t,e=this.playing=!1,i=!1,s=this.element.getAttribute("data-mp4Src"),a=this.element.getAttribute("data-webmSrc"),o=this.element.getAttribute("data-width"),n=this.element.getAttribute("data-height"),l=this.element.getAttribute("data-style"),r=this.element.getAttribute("data-imageSrc"),d=this.element.getAttribute("data-gifSrc"),h=this.element.getAttribute("data-preferWebm"),u=this;this.skipMp4&&this.skipWebm||((t=document.createElement("video")).volume=this.volume,0===this.volume&&(t.muted=!0),"function"==typeof t.canPlayType&&(e=this.isSupportsMp4(t),i=this.isSupportsWebm(t))),this.startTime=Date.now(),e&&null!==s||i&&null!==a?(o&&(t.width=o),n&&(t.height=n),t.classList.add("gif_video"),n<o?t.classList.add("gif_video__landscape"):t.classList.add("gif_video__portrait"),t.loop=!0,t.setAttribute("style",l),t.addEventListener("canplay",this.boundCanPlayHandler),t.addEventListener("playing",this.boundPlayingHandler),t.addEventListener("error",this.boundErrorHandler),t.setAttribute("src",h?i&&a||e&&s:e&&s||i&&a),t.setAttribute("poster",r),g.firstByClass(this.element,"gif_cnt").appendChild(t),this.element.classList.add("__loading"),t.load(),t.play(),c.success("photo.gif","video_load",this.location)):((t=this.getImage())&&t.setAttribute("src",d),(t=new Image).src=d,t.onload=function(){u.classList.remove("__loading"),u.classList.add("__playing"),u.addButton.classList.add("__playing"),c.duration("photo.gif",Math.max(Date.now()-u.startTime,0),"gif_play",u.location),c.success("photo.gif.inplace",u.location,u.autoplay?"a":"m"),c.raw("photo.gif",{g:u.groupPhoto,pid:u.photoId,d:Math.max(Date.now()-u.startTime,0),p1:"gif_play"})},t.onerror=function(){u.stop(!0),c.success("photo.gif","gif_fail",u.location)},t.complete?(this.element.classList.remove("__loading"),this.element.classList.add("__playing"),this.addButton&&this.addButton.classList.add("__playing")):this.element.classList.add("__loading"),c.success("photo.gif","gif_load",this.location))},stop:function(t){var e=this.getVideo();e&&(e.removeEventListener("canplay",this.boundCanPlayHandler),e.removeEventListener("playing",this.boundPlayingHandler),e.removeEventListener("error",this.boundErrorHandler),g.remove(e)),this.element.classList.remove("__loading","__playing"),this.addButton&&this.addButton.classList.remove("__playing");var i=this.getImage();i&&i.setAttribute("src",this.element.getAttribute("data-imageSrc")),t||c.duration("photo.gif",Math.max(Date.now()-this.startTime,0),e?"video_stop":"gif_stop",this.location),this.volumeToggler&&this.volumeToggler.classList.remove("__animated")},muteAll:function(){for(var t=0;t<i.length;++t)i[t].mute()},getImage:function(){return g.firstByClass(this.element,"gif_preview")},getVideo:function(){return g.firstByClass(this.element,"gif_video")}};var o=t(500,function(){for(var t=0;t<i.length;t++)i[t].inMessages||i[t].playOrStop()});return{activate:function(t){t.classList.contains("gif-add_item")?t.addEventListener("click",a):(0===i.length&&window.addEventListener("scroll",o),i.push(new e(t)))},deactivate:function(t){if(t.classList.contains("gif-add_item"))t.removeEventListener("click",a);else{for(var e=0;e<i.length;e++)if(i[e].element===t){i[e].deactivate(),i.splice(e,1);break}0===i.length&&window.removeEventListener("scroll",o)}},add:function(t){s(t,!0)}}});
