define("lofty/util/exposure/1.0/exposure",["lofty/lang/class","lofty/lang/base","jquery"],function(t,r,i){"use strict";function e(){if(!this._hasBindEvent){this._hasBindEvent=!0;var t=this,r=this.get("timecell");i(window).on("scroll."+n.call(this),function(){t.scrollTimeoutId&&clearTimeout(t.scrollTimeoutId),t.scrollTimeoutId=setTimeout(function(){_.call(t)},r)}),i(window).on("resize."+n.call(this),function(){t.resizeTimeoutId&&clearTimeout(t.resizeTimeoutId),t.resizeTimeoutId=setTimeout(function(){_.call(t)},r)})}}function o(){e.call(this),this._groupArr&&l.call(this,0)}function s(){i(window).off("scroll."+n.call(this)),i(window).off("resize."+n.call(this)),this._hasBindEvent=!1}function h(t){if(this._allUnbind=!1,e.call(this),!this._overflowScrollBind[t]){var r=this;i(this._overflowContainerArr[t]).on("scroll."+n.call(this),function(){_.call(r,t)}),this._overflowScrollBind[t]=!0}}function l(t){for(var r=t,i=this._overflowContainerArr.length;i>r;r++)h.call(this,r)}function n(){return this._guid||(this._guid="_exposure_"+A++),this._guid}function a(t,r){if(t.length){f.call(this);for(var e=this._currentScrollTop+this._viewportHeight,o=this._currentScrollLeft+this._viewportWidth,s=this.get("threshold"),h=0;h<t.length;){var l,n=i(t[h]),a=n.offset(),c=a.top,g=a.left,u=n.outerHeight(),_=n.outerWidth();l=this.get("onlyTop")?!0:c+u+s>this._currentScrollTop,e+s>=c&&l&&o+s>=g&&g+_+s>this._currentScrollLeft?this._onlyOnce?(this.trigger("exposure",n),t.splice(h,1)):(r[h]||this.trigger("exposure",n),c>=this._currentScrollTop&&e>=c+u?2!=r[h]&&(r[h]=2,this.trigger("completeShow",n)):1!=r[h]&&(r[h]=1,this.trigger("partShow",n)),h++):(!this._onlyOnce&&r[h]&&(r[h]=0,this.trigger("hide",n)),h++)}}}function c(t){if(this._overflowScrollBind[t]){i(this._overflowContainerArr[t]).off("scroll."+n.call(this)),this._overflowScrollBind[t]=!1,this._allUnbind=!0;for(var r=0;r<this._overflowScrollBind.length;r++)if(this._overflowScrollBind[r]){this._allUnbind=!1;break}this._allUnbind&&(this._groupArr.length>this._overflowContainerArr.length&&!this._groupArr[this._groupArr.length-1].length||this._groupArr.length==this._overflowContainerArr.length)&&s.call(this)}}function g(t){if(!this._groupArr[t].length)return void c.call(this,t);var r=this._overflowContainerArr[t],e=this._currentScrollTop+this._viewportHeight,o=this._currentScrollLeft+this._viewportWidth,s=this.get("threshold"),h=i(r).offset(),l=parseInt(i(r).css("borderLeftWidth"),10)||0,n=parseInt(i(r).css("paddingLeft"),10),a=parseInt(i(r).css("borderTopWidth"),10)||0,g=parseInt(i(r).css("paddingTop"),10),u=h.top+a+g,f=h.left+l+n,_=i(r).innerHeight(),p=i(r).innerWidth();if(e>=u&&u+_>this._currentScrollTop&&o>=f&&f+p>this._currentScrollLeft){var d,v=Math.max(u,this._currentScrollTop),A=Math.max(f,this._currentScrollLeft),w=Math.min(o,f+p),y=Math.min(e,u+_),S=this._groupArr[t];this._onlyOnce||(d=this._groupStateArr[t]);for(var T=0;T<S.length;){var m,C=i(S[T]),O=C.offset(),I=O.top,B=O.left,L=C.outerHeight(),b=C.outerWidth();m=this.get("onlyTop")?!0:I+L+s>v,y+s>=I&&m&&w+s>=B&&B+b+s>A?this._onlyOnce?(this.trigger("exposure",C),S.splice(T,1)):(d[T]||this.trigger("exposure",C),I>=v&&y>=I+L?2!=d[T]&&(d[T]=2,this.trigger("completeShow",C)):1!=d[T]&&(d[T]=1,this.trigger("partShow",C)),T++):(this._onlyOnce||d[T]&&(d[T]=0,this.trigger("hide",C)),T++)}}}function u(t){if(f.call(this),void 0!==t)return void g.call(this,t);for(var r=0,i=this._overflowContainerArr.length;i>r;r++)g.call(this,r);var e=this._groupArr.length;this._overflowContainerArr.length<e&&(this._onlyOnce?a.call(this,this._groupArr[e-1]):a.call(this,this._groupArr[e-1],this._groupStateArr[e-1]),!this._groupArr[e-1].length&&this._allUnbind&&s.call(this))}function f(){this._currentScrollTop=i(document).scrollTop(),this._currentScrollLeft=i(document).scrollLeft(),this._viewportWidth=i(window).width(),this._viewportHeight=i(window).height()}function _(t){this._targetArr?(a.call(this,this._targetArr,this._targetLastStateArr),this._targetArr.length||s.call(this)):u.call(this,t)}function p(t){var t=this.get("container").find(t),r=t.toArray();if(this.get("overflowContainer")){for(var s=[],l=[],n=i(this.get("overflowContainer")),a=i(this.get("target")),c=0,g=r.length;g>c;c++){if(i(r[c]).is(n))s.push(r[c]);else{var u=i(r[c]).find(this.get("overflowContainer")).toArray();u.length&&(s=s.concat(u))}i(r[c]).is(a)&&l.push(r[c]);var f=i(r[c]).find(this.get("target")).toArray();l=l.concat(f)}var _,p=[],d=this._overflowContainerArr.length;if(d<this._groupArr.length){var v=this._groupArr.length-1;p=this._groupArr[v],this._groupArr.length=v,this._onlyOnce||(_=this._groupStateArr[v],this._groupStateArr.length=v)}this._overflowContainerArr=this._overflowContainerArr.concat(s);for(var A=0,w=s.length;w>A;A++)this._overflowScrollBind.push(!1),this._groupArr.push([]),this._onlyOnce||this._groupStateArr.push([]);for(var y=0,S=l.length;S>y;y++){for(var T=!1,m=0,C=this._overflowContainerArr.length;C>m;m++)if(i(this._overflowContainerArr[m]).find(l[y]).length){this._groupArr[m].push(l[y]),this._onlyOnce||this._groupStateArr[m].push(0),h.call(this,m),T=!0;break}T||(p.push(l[y]),this._onlyOnce||_.push(0))}p.length&&(this._groupArr.push(p),this._onlyOnce||this._groupStateArr.push(_),e.call(this))}else{for(var l=[],a=i(this.get("target")),c=0,g=r.length;g>c;c++){i(r[c]).is(a)&&l.push(r[c]);var f=i(r[c]).find(this.get("target")).toArray();l=l.concat(f)}if(this._targetArr=this._targetArr.concat(l),!this._onlyOnce)for(var O=l.length,c=0;O>c;c++)this._targetLastStateArr.push(0);this._targetArr.length&&o.call(this)}}function d(){if(this.get("overflowContainer")){this._overflowContainerArr=this.get("container").find(this.get("overflowContainer")).toArray(),this._overflowScrollBind=[],this._allUnbind=!0,this._groupArr=[],this._onlyOnce||(this._groupStateArr=[]);for(var t,r,e,o=this.get("container").find(this.get("target")).toArray(),s=0,h=this._overflowContainerArr.length;h>s;s++){this._overflowScrollBind.push(!1),t=[],e=[],r=[];for(var l=0,n=o.length;n>l;l++)i(this._overflowContainerArr[s]).find(i(o[l])).length?(t.push(o[l]),this._onlyOnce||e.push(0)):r.push(o[l]);this._groupArr.push(t),this._onlyOnce||this._groupStateArr.push(e),o=r,t=null,r=null}if(o.length&&(this._groupArr.push(o),!this._onlyOnce)){for(var a=[],c=0,g=o.length;g>c;c++)a.push(0);this._groupStateArr.push(a)}}else if(this._targetArr=this.get("container").find(this.get("target")).toArray(),!this._onlyOnce){var g=this._targetArr.length;this._targetLastStateArr=new Array(g);for(var s=0;g>s;s++)this._targetLastStateArr[s]=0}}var v=t(r,{options:{container:{value:"body",getter:function(t){return"string"==typeof t&&(t=i(t)),t}},target:null,overflowContainer:null,onlyTop:!1,onlyOnce:!0,threshold:200,timecell:100},init:function(t){r.prototype.init.call(this,t||{}),this._onlyOnce=this.get("onlyOnce"),d.call(this),o.call(this)},execute:function(){_.call(this)},collectResouce:function(t){p.call(this,i(t)),_.call(this)},destroy:function(){this.scrollTimeoutId&&clearTimeout(this.scrollTimeoutId),this.resizeTimeoutId&&clearTimeout(this.resizeTimeoutId),i(window).off("scroll."+n.call(this)),i(window).off("resize."+n.call(this)),this._hasBindEvent=!1,this.constructor.superclass.destroy.call(this)}}),A=1;return v});;