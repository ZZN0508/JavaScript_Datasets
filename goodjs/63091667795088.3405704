define("lofty/util/storage/2.0/storage",["lofty/lang/class","lofty/lang/base","jquery","lofty/util/messenger/2.0/messenger","lofty/util/json/1.0/json","lofty/util/storage/2.0/userdata-storage"],function(e,t,s,n,i,r){"use strict";function a(){var e=Math.random()+"",t=e.indexOf(".");return 0<=t&&(e=e.substring(t+1,e.length)),"storage_id_"+(new Date).getTime()+"_"+e}function o(){this.init()}o.prototype={add:function(e){var t=e.callback,n=a();return null==e.timeout&&(e.timeout=3e3),e.startTime=(new Date).getTime(),t&&(this.store[n]=e),n},call:function(e,t){var n=this.store[e],r=null;n&&!n.remove&&(r=n.callback),this.remove(e),r&&r(t)},getCfg:function(e){return this.store[e]},remove:function(e){this.store[e]&&(this.store[e].remove=!0),delete this.store[e]},run:function(){var i=this;clearTimeout(this.timeoutId),this.timeoutId=setTimeout(function(){var e,t=(new Date).getTime(),n=[];for(e in i.store)i.store[e]&&!i.store[e].remove&&t-i.store[e].startTime>=i.store[e].timeout&&n.push(e);for(var r=0,s=n.length;r<s;r++)"function"==typeof i.store[n[r]].callback&&i.store[n[r]].callback({success:!1,errorCode:"timeout",errorMessage:"Send message timeout"}),i.remove(n[r]);i.run()},1e3)},init:function(){this.store={},this.run()}};var l=new o,c=e(t,{options:{crossDomain:!1,proxyUrl:"//astyle-src.alicdn.com/fdevlib/js/lofty/util/storage/2.0/proxy/storage-proxy.html",blankUrl:"about:blank",engine:null},init:function(e){t.prototype.init.call(this,e||{});e=this.get("mixAttrs");e&&s.extend(this,e),this._funcsCache=[],this.Engine=null,this.isReady=!1,this.Engine=this.get("engine")||window.localStorage||r.getDefault(),this.get("crossDomain")?this.createMessenger():this.handleReady()},getConfigs:function(e,t){var n=t;try{n=s.parseJSON(e)}catch(e){n=t}return n},handleProxyReady:function(){this.trigger("proxyReady"),this.handleReady()},callbackMessage:function(e,t){var n=this,r=n.getConfigs(t,{});switch(e){case"proxyReady":n._init_||(n.messenger.clearAllTarget(),n.messenger.addTarget(n.proxyIframe[0].contentWindow,n.messageId),n.handleProxyReady(),n._init_=!0);break;case"setItem":case"getItem":case"removeItem":case"getJson":case"setJson":case"clear":case"getLength":case"key":l.call(r.id,{success:!0,data:r.result})}},sendMessage:function(e,t,n,r){n=l.add({timeout:r,callback:n}),t=i.stringify(t={id:n,data:t});this.messenger.send(e+"|"+t)},_escapeHtml:function(e){return"string"!=typeof e?null:e.replace(/&/gm,"&amp;").replace(/</gm,"&lt;").replace(/>/gm,"&gt;").replace(/"/gm,"&quot;").replace(/'/gm,"&#39;")},getProxyUrl:function(){var e=this.get("proxyUrl");return e+(0<e.indexOf("?")?"&":"?")+"messageId="+this.messageId},createMessenger:function(){var r=this,e=a();this.messageId=e,this.proxyIframe=s('<iframe src="'+this._escapeHtml(r.get("blankUrl")||"")+'" style="width:1px;height:1px;overflow:hidden;position:absolute;top:0;left:0;visibility:hidden;"></iframe>').appendTo(s("body")),this.proxyIframe.prop("name",e).prop("id",e);var t=new n(e,e);t.listen(function(e){var t=e.indexOf("|"),n=e.substring(0,t),e=e.substring(t+1,e.length);r.callbackMessage(n,e)}),this.messenger=t,this.proxyIframe.on("load",function(){r.messenger.clearAllTarget(),r.proxyIframe.attr("src")!==r.get("blankUrl")&&(r.messenger.addTarget(r.proxyIframe[0].contentWindow,e),r.sendMessage("proxyReady"))}),this.proxyIframe.attr("src",this.getProxyUrl())},proxyMethod:function(t){var e=t.call,n=t.defaultValue,r=t.name,s=t.callback,i=t.args;if(!this.get("crossDomain")||null==this.messenger){t=n;if(this.isSupport())try{t=e.apply(this,i),s&&s({success:!0,data:t})}catch(e){this.trigger("error",{exception:e,type:r}),s&&s({success:!1,errorCode:r,errorMessage:e.message}),t=n}else t=n,s&&s({success:!1,errorCode:"notSuport"});return t}this.sendMessage(r,i,s)},setItem:function(e,t,n){return this.proxyMethod({name:"setItem",args:[e,t],call:function(){return null==t?this.Engine.removeItem(e):this.Engine.setItem(e,t)},callback:n})},getItem:function(e,t){return this.proxyMethod({name:"getItem",args:[e],call:function(){return this.Engine.getItem(e)},callback:t})},setJson:function(e,t,n){return this.proxyMethod({name:"setJson",args:[e,t],call:function(){return this.Engine.setItem(e,encodeURIComponent(i.stringify(t)))},callback:n})},getJson:function(t,e){return this.proxyMethod({name:"getJson",args:[t],call:function(){var e=this.getItem(t);return i.parse(decodeURIComponent(e))},callback:e})},removeItem:function(e,t){return this.proxyMethod({name:"removeItem",args:[e],call:function(){return this.Engine.removeItem(e)},callback:t})},clear:function(e){return this.proxyMethod({name:"clear",args:[],call:function(){return this.Engine.clear()},callback:e})},getLength:function(e){return this.proxyMethod({defaultValue:0,name:"clear",args:[],call:function(){return"function"==typeof this.Engine.getLength?this.Engine.getLength():this.Engine.length||0},callback:e})},key:function(e,t){return this.proxyMethod({name:"key",args:[e],call:function(){return this.Engine.key(e)},callback:t})},isSupport:function(){return!!this.Engine},handleReady:function(){this.isReady=!0;var e=this._funcsCache;this._funcsCache=[];for(var t=0,n=e.length;t<n;t++)e[t].call(this);this.trigger("ready")},ready:function(e){this.isReady?e&&e.call(this):this._funcsCache.push(e)}}),u=null;return c.getDefault=function(){return u=null==u?new c:u},c});
