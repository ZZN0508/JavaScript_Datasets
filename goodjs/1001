define(["OK/utils/throttle","OK/utils/dom"],function(e,o){"use strict";var r=[],c=!1,l=e(100,function(){r.forEach(function(t){t.calculate()})});function u(e){var i=null;return r.some(function(t){if(t.element===e)return i=t,!0}),i}function n(t,e){e=t.indexOf(e);-1<e&&t.splice(e,1)}function a(t,e,i,n){this.element=t,this.container=e,this.callback=i,this.predicate=n?n.bind(this):null}function h(t){this.element=t,this.items=[],this.listener=e(100,this.calculate.bind(this)),this.element.addEventListener("scroll",this.listener),this.updateRect()}return a.prototype={destroy:function(){this.container=null},isInViewport:function(){var t,e=this.container.rect,i=e.top,n=e.bottom;try{t=this.element.getBoundingClientRect()}catch(e){t={top:0,right:0,bottom:0,left:0,width:0,height:0}}return t.top>=i&&t.top<=n||t.bottom>=i&&t.bottom<=n},calculate:function(){var t=this.predicate?this.predicate():this.isInViewport();this.visible!==t&&(this.visible=t,this.callback.call(this.element,t))}},h.prototype={add:function(t){this.items.push(t),this.updateRect(),t.calculate()},updateRect:function(){this.rect=this.element.getBoundingClientRect()},remove:function(e){var i=null;this.items.forEach(function(t){if(t.element===e)return i=t,!0}),i&&(i.destroy(),n(this.items,i))},isEmpty:function(){return 0===this.items.length},isLast:function(t){return this.items[this.items.length-1]===t},calculate:function(){this.updateRect(),this.items.forEach(function(t){t.calculate()})},destroy:function(){this.element.removeEventListener("scroll",this.listener)}},{add:function(t,e,i){var n,s=o.parent(t,"js-viewport-container");(n=u(s=null===s?window:s))||(n=new h(s),r.push(n)),n.add(new a(t,n,e,i)),c||(window.addEventListener("resize",l),c=!0)},remove:function(t){var e=o.parent(t,"js-viewport-container");(e=u(e=null===e?window:e))&&(e.remove(t),e.isEmpty()&&(e.destroy(),n(r,e))),c&&0===r.length&&(window.removeEventListener("resize",l),c=!1)},getContainer:function(t){return u(o.parent(t,"js-viewport-container"))}}});
