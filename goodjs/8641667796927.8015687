"use strict";function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],a=!0,i=!1,o=void 0;try{for(var n,s=e[Symbol.iterator]();!(a=(n=s.next()).done)&&(r.push(n.value),!t||r.length!==t);a=!0);}catch(e){i=!0,o=e}finally{try{a||null==s.return||s.return()}finally{if(i)throw o}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}require=function a(i,o,n){function s(t,e){if(!o[t]){if(!i[t]){var r="function"==typeof require&&require;if(!e&&r)return r(t,!0);if(l)return l(t,!0);r=new Error("Cannot find module '"+t+"'");throw r.code="MODULE_NOT_FOUND",r}r=o[t]={exports:{}};i[t][0].call(r.exports,function(e){return s(i[t][1][e]||e)},r,r.exports,a,i,o,n)}return o[t].exports}for(var l="function"==typeof require&&require,e=0;e<n.length;e++)s(n[e]);return s}({1:[function(e,t,r){var a=!1,i=window||self;try{a=!!i.localStorage.getItem("f7c9180f-5c45-47b4-8de4-428015f096c0")}catch(e){}t.exports=a},{}],2:[function(e,t,r){var a=e("../enabled");t.exports=function(e){return function(){if(a&&"object"===_typeof(window.console)&&"function"==typeof console[e])return console[e].apply(console,Array.prototype.slice.call(arguments,0))}}},{"../enabled":1}],3:[function(e,t,r){t.exports=e("./internal/expose")("log")},{"./internal/expose":2}],"@marcom/data-relay":[function(e,t,r){var a,u=e("@marcom/ac-console/log");try{a=e("@marcom/ac-analytics")}catch(e){u(e)}var i={properties:{absoluteUrlRegex:new RegExp("^(?:[a-z]+:)+//","i"),analyticsTitle:"data relayed",cidQueryParam:"cid",cookieDomain:".apple.com",cookieMaxKeyLength:5,cookieName:"aw_rid",cookieValueSeparator:"|",cookieValueEntrySeparator:":",customAnalyticsAttribute:"",dataMaxLength:100,deferNavigationTimeout:400,interactionEvent:"mouseup",internalLinkAttribute:"data-analytics-intrapage-link",parseRelativeUrlRegex:new RegExp("^([./]*)(.+)"),prefixAllowedCharacters:/^[A-Za-z0-9_]+$/,prefixMaxLength:3,relayButtonUrlAttribute:"data-url",ridQueryParam:"rid",ridRelayAttribute:"data-rid-relay",ridRelaySelector:"[data-rid-relay]",ridStoreAttribute:"data-rid-store",ridStoreSelector:"[data-rid-store]",ridPrefixSeparator:"-",trackingDataSeparator:"|",trackingProperty:"eVar17",urlFormatHostName:"https://apple.com/",urlSeparator:",",valueAllowedCharacters:/^[A-Za-z0-9-_%]+$/},options:{automaticMode:!0,canDeferNavigation:!0,trackCid:!1,useJsonStorageFormat:!1,useSecureCookie:!0},passiveTracking:{overwriteStorageItem:!1,overwriteStorageItemValues:!0,overwriteAppMeasurementValues:!0,overwriteAppMeasurementEvents:!0}},o=(_createClass(n,[{key:"_isSupported",value:function(){if(!(window&&document&&document.documentElement&&Array.prototype.includes))return!1;try{var e=new window.URL("x","http://w");return e.pathname="y%20z","http://w/y%20z"===e.href&&void 0!==e.searchParams}catch(e){return!1}}},{key:"_initialize",value:function(e){this.options=i.options,this.properties=i.properties,this.passiveTracking=i.passiveTracking,this.analytics=a,this._applyConfigurations(e),this.options.automaticMode&&(e=this.getRidFromUrl(window.location.href),this.storeRid(e),this._setupEventHandlers())}},{key:"_applyConfigurations",value:function(t){var r,a=this;t&&(r=Object.keys(i),Object.keys(t).forEach(function(e){r.includes(e)&&(a[e]=Object.assign(a[e],t[e]))}))}},{key:"_setupEventHandlers",value:function(){this._handleClick=this._handleClick.bind(this),document.documentElement.addEventListener(this.properties.interactionEvent,this._handleClick)}},{key:"_handleClick",value:function(e){var t=this._ancestor(e.target,"".concat(this.properties.ridRelaySelector,", ").concat(this.properties.ridStoreSelector));u("Data Relay - click occurred - looking for ancestor that has data-rid-relay or data-rid-store"),t&&(t.getAttribute(this.properties.ridRelayAttribute)?(u("Data Relay - an element with data-rid-relay was clicked"),this._handleRidRelay(e,t)):t.getAttribute(this.properties.ridStoreAttribute)&&(u("Data Relay - an element with data-rid-store was clicked"),this._handleRidStore(e,t)))}},{key:"storeRid",value:function(e){var t;e&&((t=this.getRidFromCookie())?(u("Data Relay - cookie was already there, combining the new data with the current cookie data"),u("Data Relay - current data stored in cookie",t),u("Data Relay - the rid that is currently in the URL that is overwriting the current rid",e),u("Data Relay - the combined value of the old and new rid data"),this.writeCookieFromObj(this._prepareCookieData(e,t))):(u("Data Relay - cookie was not already there - just created now"),u('Data Relay - wrote the following string to the cookie:"',JSON.stringify(e)+'"'),this.writeCookieFromObj(this._prepareCookieData(e))))}},{key:"_prepareCookieData",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};this._deleteInvalidValues(e);var r=Object.assign({},t,e),t=Object.keys(r),a=t.length-this.properties.cookieMaxKeyLength;if(a<=0)return r;for(var i=Object.keys(e),o=t.filter(function(e){return!i.includes(e)});0<a;){var n=o.length?o:i;delete r[this._getRandomArrayItem(n)],a--}return r}},{key:"writeCookieFromObj",value:function(e){var t="";return this.options.useSecureCookie&&(t=" secure;"),!this.options.trackCid&&e.cid&&delete e.cid,this._deleteInvalidValues(e),!this._isEmpty(e)&&!!(e=this._formatCookieData(e))&&(document.cookie="".concat(this.properties.cookieName,"=").concat(e,"; path=/; domain=").concat(this.properties.cookieDomain,";").concat(t),e)}},{key:"_formatCookieData",value:function(e){return e?this.options.useJsonStorageFormat?encodeURIComponent(JSON.stringify(e)):this._createSimpleFormatCookieData(e):null}},{key:"_createSimpleFormatCookieData",value:function(t){var r=this,a="";return Object.keys(t).forEach(function(e){a+="".concat(e).concat(r.properties.cookieValueEntrySeparator).concat(encodeURIComponent(t[e])).concat(r.properties.cookieValueSeparator)}),a=a.substring(0,a.length-this.properties.cookieValueSeparator.length),encodeURIComponent(a)}},{key:"_handleRidRelay",value:function(e,t){var r,a,i=this.getRidMappingFromEl(t);i?((a=this.getRidFromCookie())?r=this.relayDataToElement(t,i,a):u("Data Relay - no cookie data applied, there was no data stored in the cookie"),(r=r||this.getTrackingDataForEl(t,i))&&this._trackAnalyticsData(t,r,i,e)):u("Data Relay - no action taken, there was no proper data mapping")}},{key:"_handleRidStore",value:function(e,t){t=this.getRidStorageDataFromEl(t);t?(u("Data Relay - rid storage data found in element - attempting to store"),this.storeRid(t)):u("Data Relay - no action taken, there was no proper data in the rid store attribute")}},{key:"_trackAnalyticsData",value:function(e,t,r,a){if(u("Data Relay - analytics tracking - "+this.properties.trackingProperty+' should be tracked with the value "',t+'"'),this.analytics){r=this._createTrackingData(e,t,r);if(e.getAttribute("data-analytics-click")||e.hasAttribute("data-analytics-exit-link")||this.properties.customAnalyticsAttribute&&e.hasAttribute(this.properties.customAnalyticsAttribute))return delete r.title,void this.analytics.passiveTracker(r,this.passiveTracking);this.options.canDeferNavigation&&"A"===e.tagName&&!this._isIntraPageLink(e)&&(a.preventDefault(),this.timeout=setTimeout(function(){window.location=e.href},this.properties.deferNavigationTimeout)),this.analytics.track(r)}}},{key:"_createTrackingData",value:function(e,t,r){var a={};e&&e.hasAttribute("data-rid-options")&&(a=JSON.parse(e.getAttribute("data-rid-options")));r=this._buildEventsString(r,a),r={title:a.analyticsTitle||this.properties.analyticsTitle,events:r};return r[a.trackingProperty||this.properties.trackingProperty]=t,r}},{key:"_buildEventsString",value:function(e,t){var r="";return Object.keys(e).forEach(function(e){t&&t.eventTracking&&t.eventTracking[e]?r+="event".concat(t.eventTracking[e],","):"cid"!==e&&(r+="event".concat(e,","))}),r=r.substring(0,r.length-1)}},{key:"getTrackingDataForEl",value:function(e,t){var a=this,i=[];e.href?o="href":e.getAttribute(this.properties.relayButtonUrlAttribute)&&(o=this.properties.relayButtonUrlAttribute);var r=Object.keys(t),o=e.getAttribute(o),n=this.getQueryString(this._formatUrl(o).url);return r.forEach(function(e){var r=[];"string"==typeof t[e]&&(t[e]=[t[e]]),t[e].forEach(function(e){var t=n[e];if(t&&a.properties.valueAllowedCharacters.test(t)){if(e===a.properties.cidQueryParam&&null!==t){if(!a.options.trackCid)return;t="".concat(a.properties.cidQueryParam,"-").concat(t)}t&&r.push(t)}}),r.length<1?u("Data Relay - there was no data available in the elements url that corresponds to the rid to query param mapping, so this data will not be tracked on "+a.properties.trackingProperty):(e=new Set(r),Array.from(e).forEach(function(e){i.push(e)}))}),u('Data Relay - built the data for a link that had no data relayed to it, the current value of "'+i+'" will be tracked on '+this.properties.trackingProperty),i.join(this.properties.trackingDataSeparator)}},{key:"relayDataToElement",value:function(o,n,s){var l=this,e=[],c=[];o.href&&e.push("href"),o.getAttribute(this.properties.relayButtonUrlAttribute)&&e.push(this.properties.relayButtonUrlAttribute);var t=Object.keys(n);return e.forEach(function(r){var a=l._formatUrl(o.getAttribute(r)),i=new URL(a.url);t.forEach(function(t){if(t+""in s){if(t===l.properties.cidQueryParam){if(!l.options.trackCid)return;c.push("".concat(t,"-").concat(s[t]))}else c.push(s[t]);"string"==typeof n[t]&&(n[t]=[n[t]]),n[t].forEach(function(e){i.searchParams.set(e,s[t])});var e=i.toString();a.relative&&(e=e.replace(l.properties.urlFormatHostName,a.original)),o.setAttribute(r,decodeURIComponent(e)),u('Data Relay - the data-url of the element had the query string named "'+n[t]+'" and the value of it was replaced with '+s[t]+' rid - "'+t+'"')}})}),c.join(this.properties.trackingDataSeparator)}},{key:"getRidFromCookie",value:function(){var t=this,e=document.cookie.split("; ").find(function(e){return 0===e.indexOf(t.properties.cookieName)});return e?(e=this._readCookie(e.split("=")[1]),this._deleteInvalidValues(e),!this._isEmpty(e)&&e):null}},{key:"_readCookie",value:function(e){return e?this.options.useJsonStorageFormat?JSON.parse(decodeURIComponent(e)):this._readSimpleFormatCookie(e):{}}},{key:"_readSimpleFormatCookie",value:function(e){var a=this;return(e=decodeURIComponent(e)).split(this.properties.cookieValueSeparator).reduce(function(e,t){var r=_slicedToArray(t.split(a.properties.cookieValueEntrySeparator),2),t=r[0],r=r[1];return e[t]=decodeURIComponent(r),e},{})}},{key:"destroy",value:function(){document.documentElement.removeEventListener(this.properties.interactionEvent,this._handleClick)}},{key:"getRidMappingFromEl",value:function(e){return JSON.parse(e.getAttribute(this.properties.ridRelayAttribute))}},{key:"getRidStorageDataFromEl",value:function(e){e=JSON.parse(e.getAttribute(this.properties.ridStoreAttribute));return this._deleteInvalidValues(e),!this._isEmpty(e)&&e}},{key:"getRidFromUrl",value:function(e){var t,r=this.getQueryString(e),a=r[this.properties.ridQueryParam],e={};return a&&(e=this._parseRidStringData(a)),this.options.trackCid&&(t=(r=r[this.properties.cidQueryParam])?this._parseCidStringData(r):t)&&Object.assign(e,t),e=this._isEmpty(e)?null:e}},{key:"getRelayData",value:function(e,r,t,a){var i=this;if(!e)return null;void 0===t&&(t=!0),void 0===a&&(a=!1);var o=this.getRidFromCookie();if(!o&&!r)return null;var n=new Set,s=new Set;Array.isArray(e)||(e=[e]),Array.isArray(r)||(r=[r]),e.forEach(function(e,t){if(!(e.length>i.properties.prefixMaxLength)&&i.properties.prefixAllowedCharacters.test(e)){if(!o||void 0===o[e]||i.properties.dataMaxLength<o[e].length||!i.properties.valueAllowedCharacters.test(o[e])){if(!r[t]||i.properties.dataMaxLength<r[t].length||!i.properties.valueAllowedCharacters.test(r[t]))return;n.add(r[t])}else n.add(o[e]);s.add("event".concat(e))}});n=this._listToString(n),e=_defineProperty({events:s=this._listToString(s)},this.properties.trackingProperty,n);return this.analytics&&t&&r&&e[this.properties.trackingProperty]&&e.events&&(a?this.analytics.passiveTracker(e,this.passiveTracking):(e.title=this.properties.analyticsTitle,this.analytics.track(e))),{data:n,trackingData:e}}},{key:"get",value:function(e){var t=this.getRidFromCookie();return t&&void 0!==t[e]?t[e]:null}},{key:"set",value:function(e,t){return e&&"string"==typeof e&&t&&"string"==typeof t?this.storeRid(_defineProperty({},e,t)):null}},{key:"_listToString",value:function(e){var t="";return e.forEach(function(e){t+="".concat(e,",")}),t.substring(0,t.length-1)}},{key:"getQueryString",value:function(e){var r={};return e.substring(e.indexOf("?")+1).split("&").forEach(function(e){var t=_slicedToArray(e.split("="),2),e=t[0],t=t[1];r[e]=t}),r}},{key:"_deleteInvalidValues",value:function(t){var r=this;Object.keys(t).forEach(function(e){!(r.properties.dataMaxLength<t[e].length||r.properties.prefixMaxLength<e.length)&&r.properties.valueAllowedCharacters.test(t[e])&&r.properties.prefixAllowedCharacters.test(e)||delete t[e]})}},{key:"_isEmpty",value:function(e){return 0===Object.keys(e).length}},{key:"_parseRidStringData",value:function(e){var t,r=this;try{t=decodeURIComponent(e)}catch(e){u(e)}if(!t)return{};var a={};return t.split(this.properties.urlSeparator).forEach(function(e){var t=e.split(r.properties.ridPrefixSeparator),e=t.shift();e&&e.length<=r.properties.prefixMaxLength&&r.properties.prefixAllowedCharacters.test(e)&&(t=t.join(r.properties.ridPrefixSeparator),t=encodeURIComponent(t),r.properties.valueAllowedCharacters.test(t)&&(a[e]=t))}),a}},{key:"_formatUrl",value:function(e){var t={relative:!1,original:!1,url:null};if(this.properties.absoluteUrlRegex.test(e))return t.url=e,t;e=this.properties.parseRelativeUrlRegex.exec(e);return e.length&&e[e.length-1]?(t.relative=!0,t.original=e[1],t.url=this.properties.urlFormatHostName+e[e.length-1],t):null}},{key:"_parseCidStringData",value:function(e){var t={};return t[this.properties.cidQueryParam]=e,t}},{key:"_ancestor",value:function(e,t){if(e.matches(t))return e;for(;(e=e.parentNode)&&e.nodeType===Node.ELEMENT_NODE;){if(!t||e.matches(t))return e;if(e===document.documentElement)break}return null}},{key:"_getRandomArrayItem",value:function(e){return e.splice(Math.floor(Math.random()*e.length),1)}},{key:"_isIntraPageLink",value:function(e){var t=e.getAttribute("href");return!(null!==t&&"#"!==t.charAt(0)&&0!==t.indexOf("javascript:")&&0!==t.indexOf("mailto:")&&0!==t.indexOf("tel:")&&!e.hasAttribute(this.properties.internalLinkAttribute))}}]),n);function n(e){_classCallCheck(this,n),this._isSupported()&&this._initialize(e)}t.exports=o},{"@marcom/ac-analytics":"@marcom/ac-analytics","@marcom/ac-console/log":3}]},{},[]);
