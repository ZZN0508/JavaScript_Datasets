define(["jquery","jquery.autoGrowInput"],function(d){d.fn.okTags=function(i){if(i=d.extend(!0,{listClass:"tags it vl_it vl_tags",inputClass:"tag_it",inputWrapperClass:"tag_it_w",focusClass:"__focus",direction:"ltr",placeholder:"",tabindex:"2",breakKeyCodes:[32,13,44,59],textRemoveLinkTitle:"Remove from list.",onFocus:function(){},onBlur:function(){}},i||{}),!(this.length<=0)){var t=this.attr("dir");t&&0<t.length&&(i.direction=t);var n=new RegExp("^(.+)\\[[0-9]*\\]$","i");if((s=this.eq(0).attr("name").match(n))&&2==s.length){var s=s[1],r=d("<div/>",{class:i.listClass}),o=0;this.each(function(){var t=d(this),e=t.val(),a=t.attr("name").match(n);a&&2==a.length&&0<a[1].length&&0<e.length&&(t=d("<div/>",{class:"tag tag__old"}).appendTo(r),d("<span/>",{dir:i.direction,text:e}).appendTo(t),a=d("<div/>",{class:"tag_del_w"}).appendTo(t),d("<span/>",{class:"tag_del ic12_close-nh ic12",title:i.textRemoveLinkTitle}).appendTo(a),d("<input/>",{type:"hidden",name:s+"[]",value:e}).appendTo(t),o++)}),r.insertAfter(this.last()),this.remove();var e=d("<div/>",{class:i.inputWrapperClass}).css("width",o?"auto":"100%").appendTo(r),l=d("<input/>",{type:"text",value:"",class:i.inputClass,style:i.tagInputStyle,dir:i.direction,tabindex:i.tabindex,maxlength:"25",placeholder:o?"":i.placeholder}).css("width",o?"auto":"100%").appendTo(e);return r.on("click",function(){l.focus()}).on("click",".tag_del",function(t){t.preventDefault(),t.stopPropagation();var e=d(this).parent().parent(),t=e.text();e.remove(),l.trigger("removedTag",t),l.focus()}),l.autoGrowInput(i).on("addedNewTag",function(){r.find(".tag__old").length&&(l.attr("placeholder","").css("width","auto"),e.css("width","auto"))}).on("removedTag",function(){r.find(".tag__old").length||(l.attr("placeholder",i.placeholder).css("width","100%"),e.css("width","100%"))}).on("transformToTag",function(){var t,e,a=d(this),n=a.val(),o=(o=n).toLowerCase();r.find(".tag__old input:hidden[value]").filter(function(){return this.value.toLowerCase()==o}).length<=0&&(t=d("<div/>",{class:"tag tag__old"}),d("<span/>",{dir:i.direction,text:n}).appendTo(t),e=d("<div/>",{class:"tag_del_w"}).appendTo(t),d("<span/>",{class:"tag_del ic12_close-nh ic12",title:i.textRemoveLinkTitle}).appendTo(e),d("<input/>",{type:"hidden",name:s+"[]",value:n}).appendTo(t),a.parent().before(t),a.trigger("addedNewTag",n)),a.val("")}).on("keydown",function(t){var e,a,n=0<t.keyCode?t.keyCode:t.which,o=d(this),i=o.val().length;8==n&&i<=0?(t.preventDefault(),(e=r.find(".tag__old").last()).length&&(a=e.text(),e.remove(),l.trigger("removedTag",a))):9==n&&0<i&&(t.preventDefault(),o.trigger("transformToTag"))}).on("keypress",function(t){var e=0<t.keyCode?t.keyCode:t.which,a=d(this);-1<d.inArray(e,i.breakKeyCodes)&&(t.preventDefault(),0<a.val().length&&a.trigger("transformToTag"))}).on("paste",function(t){var n=d(this);"paste"==t.type&&setTimeout(function(){for(var t=n.val().split(/[\s,;]+/),e=0,a=t.length;e<a;e++)t[e]&&n.val(t[e]).trigger("transformToTag")},10)}).on("blur",function(){var t=d(this);0<t.val().length&&t.trigger("transformToTag"),r.removeClass(i.focusClass),i.onBlur()}).on("focus",function(){r.addClass(i.focusClass),i.onFocus()}),r}}}});
