define(["OK/utils/throttle","OK/utils/dom","OK/utils/utils","OK/logger"],(function(t,e,i,s){"use strict";var a,o=[],n=function(t){this.element=t,this.autoplay="true"===t.getAttribute("data-autoplay"),this.nostop="true"===t.getAttribute("data-nostop"),this.inMessages="true"===t.getAttribute("data-messages"),this.playOnParent="true"===t.getAttribute("data-playOnParent"),this.location=t.getAttribute("data-location")||"u",this.volume=parseInt(t.getAttribute("data-volume")||"1",10),this.volumeControl="true"===t.getAttribute("data-volumeControl"),this.photoId=t.getAttribute("data-photoId"),this.groupPhoto="true"===t.getAttribute("data-groupPhoto")||void 0;var i=e.parent(this.element,this.playOnParent?"js-gifPlay":"media-photos_i");this.addButton=e.firstByClass(i,"gif-add"),this.gifContainer=this.element.parentNode,this.playOnParent&&(this.gifContainer=e.parent(this.element,"js-gifPlay")),this.boundPlay=this.play.bind(this),this.boundStop=this.stop.bind(this),this.boundToggleVolume=this.toggleVolume.bind(this),this.boundCanPlayHandler=this.canPlayHandler.bind(this),this.boundPlayingHandler=this.playingHandler.bind(this),this.boundErrorHandler=this.errorHandler.bind(this),this.autoplay?this.nostop?this.play():this.playOrStop():this.gifContainer&&(this.gifContainer.addEventListener("mouseenter",this.boundPlay),this.gifContainer.addEventListener("mouseleave",this.boundStop)),this.volumeControl&&(this.volumeToggler=e.firstByClass(this.gifContainer,".js-volumeControl"),this.volumeToggler&&this.volumeToggler.addEventListener("click",this.boundToggleVolume))};function l(t,s){var o=t.getAttribute("data-id"),n=t.getAttribute("data-type"),l=t.getAttribute("data-tkn"),r=t.getAttribute("data-container-id");if(!0===s){t.classList.add("invisible");var d=t.nextElementSibling;d&&d.classList.contains("js-clonePhotoDone")&&d.classList.remove("invisible")}else{var h=e.parent(t,"ovr-menu_soh");h&&h.classList.add("__success");var u=e.parent(t,"gif-add");if(u){u.classList.add("__gif-success");var g=e.firstByClass(u,"sc-menu");g&&g.classList.add("__gif-success")}a||(a=document.getElementById("hook_Block_ShortcutMenu"));var c=e.firstByClass(a,"sc-menu");c&&(c.classList.add("__gif-success"),a.dispatchEvent(new CustomEvent("change",{bubbles:!0})))}i.ajax({type:"POST",contentType:"application/json; charset=utf-8",url:"/web-api/photo/add",timeout:6e4,data:JSON.stringify({photoId:o,type:n,tkn:l,cntId:r})})}function r(t){l(t.currentTarget,!1)}n.prototype={deactivate:function(){this.gifContainer&&(this.gifContainer.removeEventListener("mouseenter",this.boundPlay),this.gifContainer.removeEventListener("mouseleave",this.boundStop)),this.volumeToggler&&this.volumeToggler.removeEventListener("click",this.boundToggleVolume)},playOrStop:function(){if(this.autoplay){var t=this.element.classList.contains("__playing")||this.element.classList.contains("__loading"),e=i.isElementPartiallyInViewport(this.element,.4);e&&!t?this.play():e||!t||this.nostop||this.stop()}},toggleVolume:function(t){t.stopPropagation(),t.preventDefault();var e=this.getVideo();if(e){var i=0===e.volume;this.muteAll(),e.volume=i?1:0,e.muted=!i,i?t.target.classList.add("__animated"):t.target.classList.remove("__animated")}},mute:function(){var t=this.getVideo();t&&(t.volume=0,t.muted=!0,this.volumeToggler&&this.volumeToggler.classList.remove("__animated"))},isSupportsMp4:function(t){return!this.skipMp4&&t.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"').length>0},isSupportsWebm:function(t){return!this.skipWebm&&t.canPlayType("video/webm").length>0},canPlayHandler:function(t){t.currentTarget.play(),this.playing||s.duration("photo.gif",Math.max(Date.now()-this.startTime,0),"video_start",this.location)},playingHandler:function(){this.element.classList.add("__playing"),this.addButton&&this.addButton.classList.add("__playing"),this.element.classList.remove("__loading"),this.playing||(this.playing=!0,s.duration("photo.gif",Math.max(Date.now()-this.startTime,0),"video_play",this.location),s.success("photo.gif.inplace",location,this.autoplay?"a":"m"),s.raw("photo.gif",{g:this.groupPhoto,pid:this.photoId,d:Math.max(Date.now()-this.startTime,0),p1:"video_play"}))},errorHandler:function(t){var e="und",i=t.currentTarget;this.stop(!0),i.error&&i.error.code?(this.isSupportsMp4(i)?(this.skipMp4=!0,e="mp4"):this.isSupportsWebm(i)&&(this.skipWebm=!0,e="webm"),s.success("photo.gif","video_fail_"+e+"_"+i.error.code,this.location),this.play()):s.success("photo.gif","video_fail_"+e,this.location)},play:function(){this.playing=!1;var t,i=!1,a=!1,o=this.element.getAttribute("data-mp4Src"),n=this.element.getAttribute("data-webmSrc"),l=this.element.getAttribute("data-width"),r=this.element.getAttribute("data-height"),d=this.element.getAttribute("data-style"),h=this.element.getAttribute("data-imageSrc"),u=this.element.getAttribute("data-gifSrc"),g=this.element.getAttribute("data-preferWebm"),c=this;if(this.skipMp4&&this.skipWebm||((t=document.createElement("video")).volume=this.volume,0===this.volume&&(t.muted=!0),"function"==typeof t.canPlayType&&(i=this.isSupportsMp4(t),a=this.isSupportsWebm(t))),this.startTime=Date.now(),i&&null!==o||a&&null!==n)l&&(t.width=l),r&&(t.height=r),t.classList.add("gif_video"),l>r?t.classList.add("gif_video__landscape"):t.classList.add("gif_video__portrait"),t.loop=!0,t.setAttribute("style",d),t.addEventListener("canplay",this.boundCanPlayHandler),t.addEventListener("playing",this.boundPlayingHandler),t.addEventListener("error",this.boundErrorHandler),t.setAttribute("src",g?a&&n||i&&o:i&&o||a&&n),t.setAttribute("poster",h),e.firstByClass(this.element,"gif_cnt").appendChild(t),this.element.classList.add("__loading"),t.load(),t.play(),s.success("photo.gif","video_load",this.location);else{var p=this.getImage();p&&p.setAttribute("src",u);var m=new Image;m.src=u,m.onload=function(){c.classList.remove("__loading"),c.classList.add("__playing"),c.addButton.classList.add("__playing"),s.duration("photo.gif",Math.max(Date.now()-c.startTime,0),"gif_play",c.location),s.success("photo.gif.inplace",c.location,c.autoplay?"a":"m"),s.raw("photo.gif",{g:c.groupPhoto,pid:c.photoId,d:Math.max(Date.now()-c.startTime,0),p1:"gif_play"})},m.onerror=function(){c.stop(!0),s.success("photo.gif","gif_fail",c.location)},m.complete?(this.element.classList.remove("__loading"),this.element.classList.add("__playing"),this.addButton&&this.addButton.classList.add("__playing")):this.element.classList.add("__loading"),s.success("photo.gif","gif_load",this.location)}},stop:function(t){var i=this.getVideo();i&&(i.removeEventListener("canplay",this.boundCanPlayHandler),i.removeEventListener("playing",this.boundPlayingHandler),i.removeEventListener("error",this.boundErrorHandler),e.remove(i)),this.element.classList.remove("__loading","__playing"),this.addButton&&this.addButton.classList.remove("__playing");var a=this.getImage();a&&a.setAttribute("src",this.element.getAttribute("data-imageSrc")),t||s.duration("photo.gif",Math.max(Date.now()-this.startTime,0),i?"video_stop":"gif_stop",this.location),this.volumeToggler&&this.volumeToggler.classList.remove("__animated")},muteAll:function(){var t;for(t=0;t<o.length;++t)o[t].mute()},getImage:function(){return e.firstByClass(this.element,"gif_preview")},getVideo:function(){return e.firstByClass(this.element,"gif_video")}};var d=t(500,(function(){var t;for(t=0;t<o.length;t++)o[t].inMessages||o[t].playOrStop()}));return{activate:function(t){t.classList.contains("gif-add_item")?t.addEventListener("click",r):(0===o.length&&window.addEventListener("scroll",d),o.push(new n(t)))},deactivate:function(t){if(t.classList.contains("gif-add_item"))t.removeEventListener("click",r);else{var e;for(e=0;e<o.length;e++)if(o[e].element===t){o[e].deactivate(),o.splice(e,1);break}0===o.length&&window.removeEventListener("scroll",d)}},add:function(t){l(t,!0)}}}));