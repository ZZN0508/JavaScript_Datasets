define(["OK/EventFactory","OK/PopLayerPhoto","OK/AbstractShortcutMenu","OK/ShortcutMenuReact","OK/utils/vanilla","OK/LogSeen","OK/pms!photoPickerConfig"],function(t,r,n,l,o,s,i){"use strict";var a;function d(e){(a=a||t.create()).trigger(e)}function c(e){return null!==e.querySelector(".plc")}function u(){var e=document.getElementById("photoLayerLog");return e&&e.getAttribute("data-layer-log-type")}function e(e){e=document.getElementById(e);e&&e.click()}function y(){e("plsp_next")}function p(){e("plsp_prev")}function h(){OK.photoLayer.isShown()||OK.photoLayer.open(),g({url:this.getAttribute("data-url")})}function m(e){var t,a,o;e&&(a=e.getAttribute("data-expand-text")||"вЂў вЂў вЂў",o=e.getAttribute("data-collapse-text")||"вЂў вЂў вЂў",e.scrollHeight>e.offsetHeight&&((t=document.createElement("a")).className="lstp",t.textContent=a,t.addEventListener("click",function(){e.classList.toggle("__expanded"),e.classList.contains("__expanded")?(e.style.maxHeight=e.scrollHeight+"px",t.textContent=o):(e.style.maxHeight="",t.textContent=a)}),e.nextSibling?e.parentNode.insertBefore(t,e.nextSibling):e.parentNode.appendChild(t)))}function g(e){return o.ajax(e).then(function(e){o.updateBlockModelCallback(e)})}function f(e){"object"==typeof e&&(e=e.url+"?"+o.stringifyParams(e.data)),navigateOnUrlFromJS(e)}return{getPhotoShownEvent:function(){return a=a||t.create()},prepareLayer:function(e){OK.photoLayer.isLogTimeDiff="false"!==e.getAttribute("data-log-time-diff"),OK.photoLayer.loaderEnabled="false"!==e.getAttribute("data-loader-enabled"),OK.photoLayer.commentsDelta=parseInt(e.getAttribute("data-comments-delta"),10),OK.photoLayer.minHeight=parseInt(e.getAttribute("data-min-height"),10),OK.photoLayer.hideElements="false"!==e.getAttribute("data-hide-elements"),OK.photoLayer.isLogPrematureClose="false"!==e.getAttribute("data-log-premature-close"),OK.loader.use(["jQuery","OKPhotoLayer"],function(){OK.photoLayer.onPhotoShown(!1,d)});var t=document.getElementById("photoLayerWrapper"),a=t&&"true"===t.getAttribute("data-just-opened");a&&t.removeAttribute("data-just-opened");e=e.getAttribute("data-seen-params");e&&((e=JSON.parse(e)).data.time=Date.now(),e.data.logAction=a?"PHOTO_LAYER_OPEN":"PHOTO_LAYER_NAVIGATION",(a=e.data).useInstantLog||s.logSuccess(e.type,JSON.stringify(a)),a.useInstantLog&&o.ajax({url:"/web-api/photo/layer/registerSeen",data:{time:Date.now(),logAction:a.logAction,id:parseInt(a.ids,10),place:a.place,entrancePlace:a.entrancePlace,isExplicitView:a.isExplicitView}}))},toggleFullScreenButton:function(){OK.photoLayer.toggleFullScreenButton()},updateWrapper:function(e){var a=document.getElementById("photoLayerWrapper"),t=e.getAttribute("data-add"),o=e.getAttribute("data-remove"),r="true"===e.getAttribute("data-isStub");requestAnimationFrame(function(){var e,t;u(),r&&a.classList.add("__ready"),a.classList.toggle("__v2",c(a)),t=(e=(e=a)||document.getElementById("photoLayerWrapper")).querySelector(".photo-layer_photo"),e.setAttribute("data-l",JSON.stringify({target:"photoLayer",windowWidth:window.innerWidth,windowHeight:window.innerHeight,withRightColumn:c(e),layerWidth:t&&t.clientWidth,layerHeight:t&&t.clientHeight,layerType:u()})),m(document.querySelector(".photo-layer_descr_tx")),m(document.querySelector(".plc-people-pins_body"))}),a&&t&&a.classList.add(t),a&&o&&a.classList.remove(o);t=a.querySelector(".photo-layer_cnt_main");t&&(t.addEventListener("mouseenter",o=function(){a.classList.toggle("__opened-sm",!!n.getActiveInstance()||!!l.getActive())}),t.addEventListener("mouseleave",o))},loadNavigation:function(e){var t=e.getAttribute("data-params");if(t)try{(t=JSON.parse(t))["st.layer.cmd"]="PopLayerPhotoOuter",t.cmd="PopLayerPhoto",t["st.layer.showNav"]="on",t["st.layer.limitedUi"]="on",t["st.layer.revNav"]="off";var a=t["st.layer.reqAttempt"]||1,o=t["st.layer.reqDelay"]||500,r=1<a?parseInt(o):1;setTimeout(function(){g({url:"/dk",data:t})},r)}catch(e){}},footerRendered:function(){OK.loader.use(["jQuery","OKPhotoLayer"],function(){OK.photoLayer.footerRendered()})},activateNavigation:function(){var e=document.getElementById("plsp_next"),t=document.getElementById("plsp_prev"),a=document.getElementById("plp_photoLink"),o=function(e){var t=e.currentTarget.getAttribute("data-fh");t&&(r.handleOnNavigate(t),(t=document.getElementById("scrollToTopPhotoLayer"))&&t.dispatchEvent(new CustomEvent("hideScrollElement")),e.preventDefault())};e.addEventListener("click",o,!1),t.addEventListener("click",o,!1),a.addEventListener("click",y,!1)},next:y,prev:p,keyboardHandler:function(e){39===e.keyCode?(y(),e.preventDefault()):37===e.keyCode&&(p(),e.preventDefault())},activateOpenCrop:function(e){e.addEventListener("click",h)},deactivateOpenCrop:function(e){e.removeEventListener("click",h)},activateFullScreenButton:function(e){(e.requestFullscreen||e.webkitRequestFullscreen||e.mozRequestFullScreen)&&e.classList.remove("invisible")},on:function(e){switch(e.name){case"open-photo-layer":i.attachPhotoLayerRedesignEnabled?f({url:"/dk",data:{cmd:"PopLayerNewPhotoWrapper","st.layer.cmd":"PopLayerNewPhotoOuter","st.layer.type":"ATTACHMENT","st.layer.revNav":"off","st.layer.limitedUi":"false","st.layer.closeLayers":"off","st.layer.showNav":"on","st.layer.mTTId":e.messageId,"st.layer.mTTChatId":e.chatId,"st.layer.photoId":e.photoId,"st.layer.navStartPhotoId":e.photoId,"st.layer.authorId":e.authorId,"st.layer.sbd":"off","st.layer.loadNavAsync":"on","st.cmd":"userMain"}}):f({url:"/dk",data:{cmd:"PopLayerPhoto","st.layer.cmd":"PopLayerPhotoOuter","st.layer.type":"ATTACHMENT","st.layer.revNav":"off","st.layer.limitedUi":"false","st.layer.closeLayers":"off","st.layer.showNav":"on","st.layer.mTTId":e.messageId,"st.layer.mTTChatId":e.chatId,"st.layer.photoId":e.photoId,"st.layer.navStartPhotoId":e.photoId,"st.layer.authorId":e.authorId,"st.layer.sbd":"off","st.layer.loadNavAsync":"on","st.cmd":"userMain"}});break;case"open-conv-icon-layer":var t=e.isChat,a={cmd:"PopLayerPhoto","st.layer.cmd":"PopLayerPhotoOuter","st.layer.type":t?"CHAT_ICON":"FRIEND","st.layer.revNav":"off","st.layer.limitedUi":"false","st.layer.closeLayers":"off","st.layer.showNav":"on","st.layer.photoId":e.photoId,"st.layer.navStartPhotoId":e.photoId,"st.layer.sbd":"off","st.cmd":OK.getCurrentDesktopModelId()};e.hideChangeChatIconWidget&&(a["st.layer.hci"]="on"),t?a["st.layer.convId"]=e.convId:(a["st.layer.epm"]="off",a["st.layer.opl"]="off"),f({url:"/dk",data:a});break;case"open-photo-attach-layer":g({url:"/dk",data:{cmd:"PopLayer","st.layer.cmd":i.messageAttachNewPickerEnabled?"PopLayerMessageAttachPhotoPicker":"AttachDialog","st.layer.objectId":e.objectId,"st.layer.maxCount":e.maxCount||-1,"st.cmd":"userMain"}})}}}});
