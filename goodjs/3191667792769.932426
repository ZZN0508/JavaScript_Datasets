YUI.add("model",function(u,t){function o(){o.superclass.constructor.apply(this,arguments)}var e=YUI.namespace("Env.Model"),r=u.Lang,a=u.Array,d=u.Object,c="change",l="error",h="load",f="save";u.Model=u.extend(o,u.Base,{idAttribute:"id",_allowAdHocAttrs:!0,_isYUIModel:!0,initializer:function(t){this.changed={},this.lastChange={},this.lists=[]},destroy:function(e,n){var i=this;return"function"==typeof e&&(n=e,e=null),i.onceAfter("destroy",function(){function t(t){t||a.each(i.lists.concat(),function(t){t.remove(i,e)}),n&&n.apply(null,arguments)}e&&(e.remove||e.delete)?i.sync("delete",e,t):t()}),o.superclass.destroy.call(i)},generateClientId:function(){return e.lastId||(e.lastId=0),this.constructor.NAME+"_"+(e.lastId+=1)},getAsHTML:function(t){t=this.get(t);return u.Escape.html(r.isValue(t)?String(t):"")},getAsURL:function(t){t=this.get(t);return encodeURIComponent(r.isValue(t)?String(t):"")},isModified:function(){return this.isNew()||!d.isEmpty(this.changed)},isNew:function(){return!r.isValue(this.get("id"))},load:function(s,r){var a=this;return"function"==typeof s&&(r=s,s={}),s=s||{},a.sync("read",s,function(t,e){var n,i={options:s,response:e};t?(i.error=t,i.src="load",a.fire(l,i)):(a._loadEvent||(a._loadEvent=a.publish(h,{preventable:!1})),n=i.parsed=a._parse(e),a.setAttrs(n,s),a.changed={},a.fire(h,i)),r&&r.apply(null,arguments)}),a},parse:function(e){if("string"==typeof e)try{return u.JSON.parse(e)}catch(t){return this.fire(l,{error:t,response:e,src:"parse"}),null}return e},save:function(s,r){var a=this;return"function"==typeof s&&(r=s,s={}),s=s||{},a._validate(a.toJSON(),function(t){t?r&&r.call(null,t):a.sync(a.isNew()?"create":"update",s,function(t,e){var n,i={options:s,response:e};t?(i.error=t,i.src="save",a.fire(l,i)):(a._saveEvent||(a._saveEvent=a.publish(f,{preventable:!1})),e&&(n=i.parsed=a._parse(e),a.setAttrs(n,s)),a.changed={},a.fire(f,i)),r&&r.apply(null,arguments)})}),a},set:function(t,e,n){var i={};return i[t]=e,this.setAttrs(i,n)},setAttrs:function(t,e){var n,i,s,r,a=this.idAttribute,l=(e=u.merge(e))._transaction={};for(s in"id"!==a&&(t=u.merge(t),d.owns(t,a)?t.id=t[a]:d.owns(t,"id")&&(t[a]=t.id)),t)d.owns(t,s)&&this._setAttr(s,t[s],e);if(!d.isEmpty(l)){for(s in n=this.changed,r=this.lastChange={},l)d.owns(l,s)&&(i=l[s],n[s]=i.newVal,r[s]={newVal:i.newVal,prevVal:i.prevVal,src:i.src||null});e.silent||(this._changeEvent||(this._changeEvent=this.publish(c,{preventable:!1})),e.changed=r,this.fire(c,e))}return this},sync:function(){var t=a(arguments,0,!0).pop();"function"==typeof t&&t()},toJSON:function(){var t=this.getAttrs();return delete t.clientId,delete t.destroyed,delete t.initialized,"id"!==this.idAttribute&&delete t.id,t},undo:function(t,e){var n,i=this.lastChange,s=this.idAttribute,r={};return t=t||d.keys(i),a.each(t,function(t){d.owns(i,t)&&(n=!0,r[t=t===s?"id":t]=i[t].prevVal)}),n?this.setAttrs(r,e):this},validate:function(t,e){e&&e()},addAttr:function(t,e,n){var i,s=this.idAttribute;return s&&t===s&&(i=this._isLazyAttr("id")||this._getAttrCfg("id"),s=e.value===e.defaultValue?null:e.value,r.isValue(s)||(s=i.value===i.defaultValue?null:i.value,r.isValue(s)||(s=(r.isValue(e.defaultValue)?e:i).defaultValue)),e.value=s,i.value!==s&&(i.value=s,this._isLazyAttr("id")?this._state.add("id","lazy",i):this._state.add("id","value",s))),o.superclass.addAttr.apply(this,arguments)},_parse:function(t){return this.parse(t)},_validate:function(e,n){function t(t){if(r.isValue(t))return i.fire(l,{attributes:e,error:t,src:"validate"}),void n(t);n()}var i=this;1===i.validate.length?t(i.validate(e,t)):i.validate(e,t)},_setAttrVal:function(t,e,n,i,s,r){var a=o.superclass._setAttrVal.apply(this,arguments),l=s&&s._transaction,u=r&&r.initializing;return a&&l&&!u&&(l[t]={newVal:this.get(t),prevVal:n,src:s.src||null}),a}},{NAME:"model",ATTRS:{clientId:{valueFn:"generateClientId",readOnly:!0},id:{value:null}}})},"3.12.0",{requires:["base-build","escape","json-parse"]});
