define("lofty/util/exposure/1.0/exposure",["lofty/lang/class","lofty/lang/base","jquery"],function(t,r,m){"use strict";function y(){var t,r;this._hasBindEvent||(this._hasBindEvent=!0,r=(t=this).get("timecell"),m(window).on("scroll."+O.call(this),function(){t.scrollTimeoutId&&clearTimeout(t.scrollTimeoutId),t.scrollTimeoutId=setTimeout(function(){i.call(t)},r)}),m(window).on("resize."+O.call(this),function(){t.resizeTimeoutId&&clearTimeout(t.resizeTimeoutId),t.resizeTimeoutId=setTimeout(function(){i.call(t)},r)}))}function S(){y.call(this),this._groupArr&&function(t){for(var r=t,i=this._overflowContainerArr.length;r<i;r++)T.call(this,r)}.call(this,0)}function C(){m(window).off("scroll."+O.call(this)),m(window).off("resize."+O.call(this)),this._hasBindEvent=!1}function T(t){var r;this._allUnbind=!1,y.call(this),this._overflowScrollBind[t]||(m((r=this)._overflowContainerArr[t]).on("scroll."+O.call(this),function(){i.call(r,t)}),this._overflowScrollBind[t]=!0)}function O(){return this._guid||(this._guid="_exposure_"+e++),this._guid}function o(t,r){if(t.length){u.call(this);for(var i=this._currentScrollTop+this._viewportHeight,e=this._currentScrollLeft+this._viewportWidth,o=this.get("threshold"),s=0;s<t.length;){var h=m(t[s]),l=h.offset(),n=l.top,a=l.left,c=h.outerHeight(),g=h.outerWidth(),l=!!this.get("onlyTop")||n+c+o>this._currentScrollTop;n<=i+o&&l&&a<=e+o&&a+g+o>this._currentScrollLeft?this._onlyOnce?(this.trigger("exposure",h),t.splice(s,1)):(r[s]||this.trigger("exposure",h),n>=this._currentScrollTop&&n+c<=i?2!=r[s]&&(r[s]=2,this.trigger("completeShow",h)):1!=r[s]&&(r[s]=1,this.trigger("partShow",h)),s++):(!this._onlyOnce&&r[s]&&(r[s]=0,this.trigger("hide",h)),s++)}}}function s(t){if(this._groupArr[t].length){var r=this._overflowContainerArr[t],i=this._currentScrollTop+this._viewportHeight,e=this._currentScrollLeft+this._viewportWidth,o=this.get("threshold"),s=m(r).offset(),h=parseInt(m(r).css("borderLeftWidth"),10)||0,l=parseInt(m(r).css("paddingLeft"),10),n=parseInt(m(r).css("borderTopWidth"),10)||0,a=parseInt(m(r).css("paddingTop"),10),a=s.top+n+a,h=s.left+h+l,l=m(r).innerHeight(),r=m(r).innerWidth();if(a<=i&&a+l>this._currentScrollTop&&h<=e&&h+r>this._currentScrollLeft){var c,g=Math.max(a,this._currentScrollTop),u=Math.max(h,this._currentScrollLeft),f=Math.min(e,h+r),_=Math.min(i,a+l),p=this._groupArr[t];this._onlyOnce||(c=this._groupStateArr[t]);for(var d=0;d<p.length;){var v=m(p[d]),A=v.offset(),w=A.top,y=A.left,S=v.outerHeight(),T=v.outerWidth(),A=!!this.get("onlyTop")||g<w+S+o;w<=_+o&&A&&y<=f+o&&u<y+T+o?this._onlyOnce?(this.trigger("exposure",v),p.splice(d,1)):(c[d]||this.trigger("exposure",v),g<=w&&w+S<=_?2!=c[d]&&(c[d]=2,this.trigger("completeShow",v)):1!=c[d]&&(c[d]=1,this.trigger("partShow",v)),d++):(this._onlyOnce||c[d]&&(c[d]=0,this.trigger("hide",v)),d++)}}}else(function(t){if(this._overflowScrollBind[t]){m(this._overflowContainerArr[t]).off("scroll."+O.call(this)),this._overflowScrollBind[t]=!1,this._allUnbind=!0;for(var r=0;r<this._overflowScrollBind.length;r++)if(this._overflowScrollBind[r]){this._allUnbind=!1;break}this._allUnbind&&(this._groupArr.length>this._overflowContainerArr.length&&!this._groupArr[this._groupArr.length-1].length||this._groupArr.length==this._overflowContainerArr.length)&&C.call(this)}}).call(this,t)}function u(){this._currentScrollTop=m(document).scrollTop(),this._currentScrollLeft=m(document).scrollLeft(),this._viewportWidth=m(window).width(),this._viewportHeight=m(window).height()}function i(t){this._targetArr?(o.call(this,this._targetArr,this._targetLastStateArr),this._targetArr.length||C.call(this)):function(t){if(u.call(this),void 0===t){for(var r=0,i=this._overflowContainerArr.length;r<i;r++)s.call(this,r);var e=this._groupArr.length;this._overflowContainerArr.length<e&&(this._onlyOnce?o.call(this,this._groupArr[e-1]):o.call(this,this._groupArr[e-1],this._groupStateArr[e-1]),!this._groupArr[e-1].length&&this._allUnbind&&C.call(this))}else s.call(this,t)}.call(this,t)}var t=t(r,{options:{container:{value:"body",getter:function(t){return t="string"==typeof t?m(t):t}},target:null,overflowContainer:null,onlyTop:!1,onlyOnce:!0,threshold:200,timecell:100},init:function(t){r.prototype.init.call(this,t||{}),this._onlyOnce=this.get("onlyOnce"),function(){if(this.get("overflowContainer")){this._overflowContainerArr=this.get("container").find(this.get("overflowContainer")).toArray(),this._overflowScrollBind=[],this._allUnbind=!0,this._groupArr=[],this._onlyOnce||(this._groupStateArr=[]);for(var t=this.get("container").find(this.get("target")).toArray(),r=0,i=this._overflowContainerArr.length;r<i;r++){this._overflowScrollBind.push(!1);for(var e=[],o=[],s=[],h=0,l=t.length;h<l;h++)m(this._overflowContainerArr[r]).find(m(t[h])).length?(e.push(t[h]),this._onlyOnce||o.push(0)):s.push(t[h]);this._groupArr.push(e),this._onlyOnce||this._groupStateArr.push(o),t=s,s=e=null}if(t.length&&(this._groupArr.push(t),!this._onlyOnce)){for(var n=[],a=0,c=t.length;a<c;a++)n.push(0);this._groupStateArr.push(n)}}else if(this._targetArr=this.get("container").find(this.get("target")).toArray(),!this._onlyOnce){c=this._targetArr.length;this._targetLastStateArr=new Array(c);for(r=0;r<c;r++)this._targetLastStateArr[r]=0}}.call(this),S.call(this)},execute:function(){i.call(this)},collectResouce:function(t){(function(t){var r=(t=this.get("container").find(t)).toArray();if(this.get("overflowContainer")){for(var i,e=[],o=[],s=m(this.get("overflowContainer")),h=m(this.get("target")),l=0,n=r.length;l<n;l++){m(r[l]).is(s)?e.push(r[l]):(i=m(r[l]).find(this.get("overflowContainer")).toArray()).length&&(e=e.concat(i)),m(r[l]).is(h)&&o.push(r[l]);var a=m(r[l]).find(this.get("target")).toArray();o=o.concat(a)}var c,g=[];this._overflowContainerArr.length<this._groupArr.length&&(t=this._groupArr.length-1,g=this._groupArr[t],this._groupArr.length=t,this._onlyOnce||(c=this._groupStateArr[t],this._groupStateArr.length=t)),this._overflowContainerArr=this._overflowContainerArr.concat(e);for(var u=0,f=e.length;u<f;u++)this._overflowScrollBind.push(!1),this._groupArr.push([]),this._onlyOnce||this._groupStateArr.push([]);for(var _=0,p=o.length;_<p;_++){for(var d=!1,v=0,A=this._overflowContainerArr.length;v<A;v++)if(m(this._overflowContainerArr[v]).find(o[_]).length){this._groupArr[v].push(o[_]),this._onlyOnce||this._groupStateArr[v].push(0),T.call(this,v),d=!0;break}d||(g.push(o[_]),this._onlyOnce||c.push(0))}g.length&&(this._groupArr.push(g),this._onlyOnce||this._groupStateArr.push(c),y.call(this))}else{for(o=[],h=m(this.get("target")),l=0,n=r.length;l<n;l++){m(r[l]).is(h)&&o.push(r[l]);a=m(r[l]).find(this.get("target")).toArray();o=o.concat(a)}if(this._targetArr=this._targetArr.concat(o),!this._onlyOnce)for(var w=o.length,l=0;l<w;l++)this._targetLastStateArr.push(0);this._targetArr.length&&S.call(this)}}).call(this,m(t)),i.call(this)},destroy:function(){this.scrollTimeoutId&&clearTimeout(this.scrollTimeoutId),this.resizeTimeoutId&&clearTimeout(this.resizeTimeoutId),m(window).off("scroll."+O.call(this)),m(window).off("resize."+O.call(this)),this._hasBindEvent=!1,this.constructor.superclass.destroy.call(this)}}),e=1;return t});
