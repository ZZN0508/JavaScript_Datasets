define(["OK/capture","OK/logger","OK/utils/vanilla","OK/utils/throttle"],function(r,e,d,i){"use strict";function t(){this.loading=!1}return t.prototype={handleEvent:function(t){if(!document.body.contains(this.hookElement))return e.error("loader","oldQuery"),void this.deactivate();switch(t.type){case"click":this.loading||(this.hookElement.classList.add("in-progress"),this.hookElement.classList.add("loader-container"),this.loadMore()),t.preventDefault();break;case"scroll":!this.loading&&function(){if(this.forceBottomEdge||this.scrollingContainer!==window)return this.scrollingContainerId&&this.scrollingContainer!==window?this.scrollingContainer.scrollTop+this.scrollingContainer.offsetHeight>this.scrollingContainer.scrollHeight-this.forceBottomEdge:window.pageYOffset>(t=document.body,e=document.documentElement,Math.max(t.scrollHeight,t.offsetHeight,e.clientHeight,e.scrollHeight,e.offsetHeight)-document.documentElement.clientHeight-this.forceBottomEdge);var t=this.hookElement.getBoundingClientRect(),e=window.innerHeight-t.top;return t.height-e<.5*window.innerHeight}.call(this)&&(this.hookElement.classList.add("in-progress"),this.loadMore())}},activate:function(t){this.hookElement=t,this.list=this.hookElement.firstChild,this.showMoreButton=this.hookElement.getElementsByClassName("js-show-more")[0],this.url=this.hookElement.getAttribute("data-url"),this.params=this.hookElement.getAttribute("data-params"),this.dynamic=this.hookElement.getAttribute("data-dynamic"),this.forceBottomEdge=this.hookElement.getAttribute("data-forcedbottomedge")||0,this.dataMax=this.hookElement.getAttribute("data-max")||0,this.manualPagesCount=this.hookElement.getAttribute("data-manualpagescount")||0,this.scrollingContainerId=this.hookElement.getAttribute("data-scroller"),this.staticParams=this.params?this.params.split("&"):[],this.dynamicParams=this.dynamic?this.dynamic.split(","):[],this.lastElement=this.hookElement.getAttribute("data-last-element"),this.pageParamsName=this.hookElement.getAttribute("data-pageParam")||"st.page";t=this.hookElement.getAttribute("data-page");this.page=t?parseInt(t,10):1,this.autoPage=this.page,this.isManual=!1,this.isDeactivated=!1,this.throttledHandleEvent=i(200,this.handleEvent.bind(this)),this.scrollingContainerId&&(this.scrollingContainer=document.getElementById(this.scrollingContainerId)),this.scrollingContainer||(this.scrollingContainer=window),this.switchToManual(),this.isManual||this.scrollingContainer.addEventListener("scroll",this.throttledHandleEvent,!1),Object.defineProperty(this.hookElement,"getLoader",{enumerable:!1,configurable:!1,writable:!1,value:function(){return this}.bind(this)})},deactivate:function(){this.scrollingContainer&&this.scrollingContainer.removeEventListener("scroll",this.throttledHandleEvent,!1),this.showMoreButton&&this.showMoreButton.removeEventListener("click",this.throttledHandleEvent,!1),this.hookElement.classList.add("loader-container","loader__done"),this.isDeactivated=!0},switchToManual:function(){this.isManual||this.isDeactivated||(function(){return this.page==this.autoPage&&this.page>this.dataMax}.call(this)||function(){return this.page>this.autoPage&&this.autoPage>this.manualPagesCount}.call(this))&&(this.hookElement.classList.remove("loader-container"),this.scrollingContainer.removeEventListener("scroll",this.throttledHandleEvent,!1),this.showMoreButton.addEventListener("click",this.throttledHandleEvent,!1),this.isManual=!0)},switchToAuto:function(){1<this.manualPagesCount&&this.isManual&&!this.isDeactivated&&(this.hookElement.classList.add("loader-container"),this.scrollingContainer.addEventListener("scroll",this.throttledHandleEvent,!1),this.showMoreButton.removeEventListener("click",this.throttledHandleEvent,!1),this.isManual=!1,this.autoPage=1)},loadMore:function(t){if(this.isDeactivated)return this.hookElement.classList.remove("in-progress"),Promise.resolve([]);this.loading=!0,t=Object.assign({fetch:this.isManual},t);var e,i,s,n=this.list.lastChild,a=this.url,o=this.staticParams,l=this.dynamicParams,h=this.lastElement;if(t[this.pageParamsName]=this.page+1,o.length)for(e=0;e<o.length;e+=1)2===(i=(s=o[e]).split("=")).length&&(t[i[0]]=i[1]);if(l.length)for(e=0;e<l.length;e+=1)t[s=l[e]]=n.getAttribute(s);return h&&(t["st.lastelem"]=h),d.ajax({url:a,data:t}).then(function(t){var e,i=t.response,s=t.xhr,n=this.list,t=n.lastChild,a=[];function o(){this.hookElement.classList.remove("in-progress"),this.loading=!1,d.trigger(this.hookElement,"dataload",{elements:a})}if("true"===s.getResponseHeader("fetchedAll")&&this.deactivate(),this.lastElement=s.getResponseHeader("lastelem"),null===i||0===i.length)return o.call(this),a;for(n.insertAdjacentHTML("beforeend",i),OK.hookModel.dispatchDataLoadedEvent&&OK.hookModel.events.dispatchDataLoadedEvent(),e=null===t?n.firstChild:t.nextSibling;null!==e;)r.activate(e),a.push(e),e=e.nextSibling;return this.page=this.page+1,this.hookElement.setAttribute("data-page",this.page),this.autoPage=this.autoPage+1,this.isManual?(this.isDeactivated||this.hookElement.classList.remove("loader-container"),this.switchToAuto()):this.switchToManual(),o.call(this),a}.bind(this))}},t});
