define(["OK/capture","OK/logger","OK/utils/vanilla","OK/utils/throttle"],(function(t,e,i,s){"use strict";var n=.5;function a(e){var s,n=e.response,a=e.xhr,o=this.list,l=o.lastChild,h=[];function r(){this.hookElement.classList.remove("in-progress"),this.loading=!1,i.trigger(this.hookElement,"dataload",{elements:h})}if("true"===a.getResponseHeader("fetchedAll")&&this.deactivate(),this.lastElement=a.getResponseHeader("lastelem"),null===n||0===n.length)return r.call(this),h;for(o.insertAdjacentHTML("beforeend",n),OK.hookModel.dispatchDataLoadedEvent&&OK.hookModel.events.dispatchDataLoadedEvent(),s=null===l?o.firstChild:l.nextSibling;null!==s;)t.activate(s),h.push(s),s=s.nextSibling;return this.page=this.page+1,this.hookElement.setAttribute("data-page",this.page),this.autoPage=this.autoPage+1,this.isManual?(this.isDeactivated||this.hookElement.classList.remove("loader-container"),this.switchToAuto()):this.switchToManual(),r.call(this),h}var o=function(){this.loading=!1};function l(){if(this.forceBottomEdge||this.scrollingContainer!==window)return this.scrollingContainerId&&this.scrollingContainer!==window?this.scrollingContainer.scrollTop+this.scrollingContainer.offsetHeight>this.scrollingContainer.scrollHeight-this.forceBottomEdge:window.pageYOffset>(t=document.body,e=document.documentElement,Math.max(t.scrollHeight,t.offsetHeight,e.clientHeight,e.scrollHeight,e.offsetHeight)-document.documentElement.clientHeight-this.forceBottomEdge);var t,e,i=this.hookElement.getBoundingClientRect(),s=window.innerHeight-i.top;return i.height-s<window.innerHeight*n}return o.prototype={handleEvent:function(t){if(!document.body.contains(this.hookElement))return e.error("loader","oldQuery"),void this.deactivate();switch(t.type){case"click":this.loading||(this.hookElement.classList.add("in-progress"),this.hookElement.classList.add("loader-container"),this.loadMore()),t.preventDefault();break;case"scroll":!this.loading&&l.call(this)&&(this.hookElement.classList.add("in-progress"),this.loadMore())}},activate:function(t){this.hookElement=t,this.list=this.hookElement.firstChild,this.showMoreButton=this.hookElement.getElementsByClassName("js-show-more")[0],this.url=this.hookElement.getAttribute("data-url"),this.params=this.hookElement.getAttribute("data-params"),this.dynamic=this.hookElement.getAttribute("data-dynamic"),this.forceBottomEdge=this.hookElement.getAttribute("data-forcedbottomedge")||0,this.dataMax=this.hookElement.getAttribute("data-max")||0,this.manualPagesCount=this.hookElement.getAttribute("data-manualpagescount")||0,this.scrollingContainerId=this.hookElement.getAttribute("data-scroller"),this.staticParams=this.params?this.params.split("&"):[],this.dynamicParams=this.dynamic?this.dynamic.split(","):[],this.lastElement=this.hookElement.getAttribute("data-last-element"),this.pageParamsName=this.hookElement.getAttribute("data-pageParam")||"st.page";var e=this.hookElement.getAttribute("data-page");this.page=e?parseInt(e,10):1,this.autoPage=this.page,this.isManual=!1,this.isDeactivated=!1,this.throttledHandleEvent=s(200,this.handleEvent.bind(this)),this.scrollingContainerId&&(this.scrollingContainer=document.getElementById(this.scrollingContainerId)),this.scrollingContainer||(this.scrollingContainer=window),this.switchToManual(),this.isManual||this.scrollingContainer.addEventListener("scroll",this.throttledHandleEvent,!1),Object.defineProperty(this.hookElement,"getLoader",{enumerable:!1,configurable:!1,writable:!1,value:function(){return this}.bind(this)})},deactivate:function(){this.scrollingContainer&&this.scrollingContainer.removeEventListener("scroll",this.throttledHandleEvent,!1),this.showMoreButton&&this.showMoreButton.removeEventListener("click",this.throttledHandleEvent,!1),this.hookElement.classList.add("loader-container","loader__done"),this.isDeactivated=!0},switchToManual:function(){this.isManual||this.isDeactivated||(function(){return this.page==this.autoPage&&this.page>this.dataMax}.call(this)||function(){return this.page>this.autoPage&&this.autoPage>this.manualPagesCount}.call(this))&&(this.hookElement.classList.remove("loader-container"),this.scrollingContainer.removeEventListener("scroll",this.throttledHandleEvent,!1),this.showMoreButton.addEventListener("click",this.throttledHandleEvent,!1),this.isManual=!0)},switchToAuto:function(){this.manualPagesCount>1&&this.isManual&&!this.isDeactivated&&(this.hookElement.classList.add("loader-container"),this.scrollingContainer.addEventListener("scroll",this.throttledHandleEvent,!1),this.showMoreButton.removeEventListener("click",this.throttledHandleEvent,!1),this.isManual=!1,this.autoPage=1)},loadMore:function(t){if(this.isDeactivated)return this.hookElement.classList.remove("in-progress"),Promise.resolve([]);this.loading=!0,t=Object.assign({fetch:this.isManual},t);var e,s,n,o=this.list.lastChild,l=this.url,h=this.staticParams,r=this.dynamicParams,d=this.lastElement;if(t[this.pageParamsName]=this.page+1,h.length)for(e=0;e<h.length;e+=1)2===(s=(n=h[e]).split("=")).length&&(t[s[0]]=s[1]);if(r.length)for(e=0;e<r.length;e+=1)t[n=r[e]]=o.getAttribute(n);return d&&(t["st.lastelem"]=d),i.ajax({url:l,data:t}).then(a.bind(this))}},o}));