define("lofty/util/storage/2.0/userdata-storage",["jquery","lofty/lang/class","lofty/lang/base"],function(t,e,a){"use strict";var n=location.protocol||document.protocol,_=document.domain,o=e(a,{option:{storeName:"localStorage"},fixKey:function(t){var e=new RegExp("[!\"#$%&'()*+,/\\\\:;<=>?@[\\]^`{|}~]","g");return t.replace(/^d/,"___$&").replace(e,"___")},appendChild:function(t,e){t.insertBefore(e,t.lastChild?t.lastChild.nextSibling:t.lastChild)},init:function(e){a.prototype.init.call(this,e||{});var o,r,i=this,s=document.body||document.getElementsByTagName("body")[0],l=this.get("storeName"),u=function(){window.detachEvent("onunload",u),o=r=i.__storage__=null,t.isFunction(CollectGarbage)&&CollectGarbage()};try{o=new ActiveXObject("htmlfile"),o.open(),o.write("<html><head><title>"+l+'</title><script type="text/javascript">document.domain = \''+n+"//"+_+"';</script></head><body></body></html>"),o.close(),r=o.body,i.__storage__=o.createElement("div"),window.attachEvent("unload",u)}catch(c){r=s,i.__storage__=document.createElement("div")}i.appendChild(r,i.__storage__),i.__storage__.style.display="none",i.__storage__.addBehavior("#default#userData"),i.__storage__.load(l+"_"+_),i.__attributes__=i.__storage__.XMLDocument.documentElement.attributes,i.length=i.__attributes__.length},key:function(t){var e=this,a=null;try{a=t>=e.length?null:e.__attributes__[t].name}catch(n){}return a},getItem:function(t){var e=this;return e.__storage__.getAttribute(e.fixKey(t))},setItem:function(t,e){var a=this;try{a.__storage__.setAttribute(a.fixKey(t),e),a.__storage__.save(this.get("storeName")+"_"+_),a.length=a.__attributes__.length}catch(n){throw{name:"UserDataQuotaExceeded",message:"UserData is out of memory"}}},removeItem:function(t){var e=this;e.__storage__.removeAttribute(e.fixKey(t)),e.__storage__.save(this.get("storeName")+"_"+_),e.length=e.__attributes__.length},clear:function(){var e=this;t.each(e.__attributes__,function(t){e.removeItem(t.name)})},getLength:function(){var e=this,a=0;return t.each(e.__attributes__,function(){a++}),a}}),r=null;return o.getDefault=function(){return null==r&&(r=new o),r},o});;