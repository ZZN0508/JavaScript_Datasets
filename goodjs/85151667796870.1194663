define(["newsletter/1/service","input_label/1/input_label"],function(l){return{selector:"#moduleID",nl:36,promo:!0,template:{content:'<div class="nls-header">{header}</div>\n{preContent}<div class="nls-content">\n{preForm}<form class="nls-form" action="#" novalidate="novalidate">\n<div class="validationWrapper"><div class="checkbox-container clearfix">{inputs}</div></div>\n<div class="input-container">\n<div class="email-container validationWrapper">\n<input type="email" class="nls-email" name="email" autocapitalize="off" autocorrect="off" placeholder="Enter email address" /> <button name="nl-submit" formnovalidate class="off {submitClass}" type="submit"><span>Submit</span></button>\n<div class="clearfix"></div></div>\n</div>\n</form>\n<div class="privacy-disclaimer">By clicking Submit, I agree to the WebMD <a href="/about-webmd-policies/about-terms-and-conditions-of-use">Terms & Conditions</a> & <a href="/about-webmd-policies/about-privacy-policy">Privacy Policy</a> and understand that I may opt out of WebMD subscriptions at any time.</div>{postForm}</div>\n{postContent}',header:"<h2>Subscribe... <span>{title} Newsletter</span></h2>",headerMulti:"<h2>Subscribe <span>to WebMD Newsletters</span></h2>",inputSingle:'<input type="hidden" name="nls" value="{id}">',inputMulti:'<label><input type="checkbox" name="nls" class="multi-checkbox" value="{id}">{title}</label>',downtime:"<p>This feature is currently unavailable. The site is undergoing routine maintenance and will be back shortly.</p>",loading:'<div class="loading"><div class="loading_medium_png"><span>Loading...</span></div></div>',successHeader:"<h2>Thank You.</h2>",successMsg:'<p class="success"><span>{email}</span> is now subscribed.</p>',failure:'<div class="failure"><p>This feature is temporarily unavailable.</p><p>Please visit our <a href="{url}">Newsletter Preference Center</a> for all of our available subscription offerings.</p>',readonly:'<div class="failure"><p>This feature is temporarily unavailable.</p><p>Please try again later.</p>',promo:'<div class="promo"><div class="promo-content clearfix"><img src="{image}" alt="WebMD App" /><div class="promo-description"><p>{text}</p><p><a href="{url}" class="webmd-btn webmd-btn-pr webmd-btn-m" onclick="wmdTrack(\'nlupgrd_sub\')">{button}</a></p><div class="clearfix"></div></div></div></div>',promoMobile:'<a href="{url}" onclick="wmdTrack(\'nlupgrd_sub\')"><div class="promo"><div class="promo-content clearfix"><img src="{image}" alt="WebMD App" /><p>{text}</p></div></div></a>',submitClass:""},metricsModule:"nl-single",metricsModuleMultiple:"nl-multie",newsletterUrl:webmd.substitute("https://member{env}.webmd.com/newsletters/newsletters.aspx",{env:webmd.url.getEnv()}),init:function(e){var t=this;return e=e||{},$.extend(!0,t,e),t.el=$(t.selector),t.multiple=$.isArray(t.nl),t.buildModule(),t.vendor=webmd.url.getParam("vendor")||"",t.publisher=webmd.url.getParam("publisher")||"",t.campaign=webmd.url.getParam("campaign")||"",webmd.isDown("reg")?void t.showDowntime():void t.initEvents()},buildModule:function(){var e,i=this,t=i.el,n="";i.multiple?(e=i.template.headerMulti,$.each(i.nl,function(e,t){n+=webmd.substitute(i.template.inputMulti,{id:i.getNewsletterId(t),title:i.getNewsletterTitle(t)},!0)})):(e=webmd.substitute(i.template.header,{title:i.getNewsletterTitle(i.nl)},!0),n=webmd.substitute(i.template.inputSingle,{id:i.getNewsletterId(i.nl),title:i.getNewsletterTitle(i.nl)},!0)),e=webmd.substitute(i.template.content,{header:e,inputs:n,preForm:i.template.preForm,postForm:i.template.postForm,preContent:i.template.preContent,postContent:i.template.postContent,submitClass:i.template.submitClass},!0),t.addClass("nls-module").html(e),i.dom={heading:t.find(".nls-header"),content:t.find(".nls-content"),form:t.find(".nls-form"),inputContainer:t.find(".input-container"),privacyDisclaimer:t.find(".privacy-disclaimer"),checkboxContainer:t.find(".checkbox-container"),inputEmail:t.find("input[name=email]"),inputNlId:t.find("input[type=hidden][name=nls]"),inputCheckboxes:t.find("input:checkbox[name=nls]"),button:t.find("button[name=nl-submit]")},i.resize()},initEvents:function(){var t=this;t.dom.form.on("submit",function(e){e.preventDefault(),t.submit()}),t.dom.inputEmail.one("focus",function(){t.showPrivacyDisclaimer()}),t.dom.inputEmail.on("blur",function(){return setTimeout(function(){t.validateEmail()},200),!0}),t.dom.inputCheckboxes.on("change",function(){t.validateNewsletter()}),t.dom.inputEmail.webmdInputLabel({label:t.dom.inputEmail.attr("placeholder")})},validate:function(){var e=this.validateEmail();return this.validateNewsletter()&&e},validatePrivacy:function(){return this.dom.inputPrivacy.is(":checked")?(this.validationMessage(this.dom.inputPrivacy),!0):(this.validationMessage(this.dom.inputPrivacy,"Please acknowledge your agreement"),!1)},validateEmail:function(){var e=this.dom.inputEmail.val(),t=/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/i;return 0===e.length?(this.validationMessage(this.dom.inputEmail,"Please enter your email address"),!1):!t.test(e)||this.dom.inputEmail.webmdInputLabel("isLabel")?(this.validationMessage(this.dom.inputEmail,"Enter a valid email address"),!1):(this.validationMessage(this.dom.inputEmail),!0)},validateNewsletter:function(){if(this.multiple){if(0===this.getSelectedNewsletters().length)return this.validationMessage(this.dom.checkboxContainer,"Please select a newsletter"),!1;this.validationMessage(this.dom.checkboxContainer)}return!0},stylePrivacyCheckbox:function(){this.dom.inputPrivacyLabel.toggleClass("checked",this.dom.inputPrivacy.is(":checked"))},submit:function(){var i,n,a=this;a.validate()&&(i=a.dom.inputEmail.val(),a.email=i,n=a.getSelectedNewsletters(),a.dom.content.html(a.template.loading),l.subscribe({email:i,privacy:!0,vendor:a.vendor,publisher:a.publisher,campaign:a.campaign,id:n}).done(function(e){var t;a.multiple?(t=a.metricsModuleMultiple,t+="_"+n.length+"-"+a.nl.length,wmdPageLink(t)):wmdPageLink(a.metricsModule),a.usertype=webmd.object.get("d.usertype",e),a.el.removeClass("error").addClass("confirmed"),a.dom.privacyDisclaimer.hide(),a.dom.heading.html(a.template.successHeader),a.dom.content.html(webmd.substitute(a.template.successMsg,{email:i})),a.resize(),a.promo&&a.buildPromo()}).fail(function(e,t){"readonly"===t?a.dom.content.html(a.template.readonly):a.dom.content.html(webmd.substitute(a.template.failure,{url:a.newsletterUrl})),a.resize()}))},buildPromo:function(){var n=this,a=Boolean(-1!=location.href.indexOf(".m."));l.getPromo({id:n.getSelectedNewsletters(!0),mobile:a}).done(function(e){var t,i;if(!e.url){if(a||"Full"===n.usertype)return webmd.debug("No promo available."),!1;e=l.promoDefault}t=a?(i=n.template.promoMobile,l.urlGetPromoImg+"hd_"+e.image):(i=n.template.promo,l.urlGetPromoImg+e.image),t=webmd.substitute(i,{url:e.url,image:t,text:e.description,button:e.button}),e.email=n.email,"Light"===n.usertype&&(t=$(t).on("click","a",function(){return l.gotoPromo(e),!1})),n.dom.content.append(t),n.resize()}).fail(function(){webmd.debug("Promo build failed.")})},showDowntime:function(){var e;webmd.debug("Registration is down."),(e=this).dom.content.addClass("downtime").html(e.template.downtime),e.resize()},showPrivacyDisclaimer:function(){this.dom.privacyDisclaimer.show()},resizeEvent:"newsletterResize",resize:function(){this.el.trigger(this.resizeEvent)},getNewsletterTitle:function(e){return($.isPlainObject(e)?e.title||l.getName(e.id):l.getName(e))||"Newsletter"},getNewsletterId:function(e){return $.isPlainObject(e)?e.id||"":e||""},getSelectedNewsletters:function(e){var t;return e&&this.selectedCache?this.selectedCache:(t=[],this.dom.inputCheckboxes.filter(":checked").each(function(){t.push($(this).val())}),this.dom.inputNlId.length&&t.push(this.dom.inputNlId.val()),this.selectedCache=t)},validationMessage:function(e,t){var i={wrapper:"validationWrapper",msg:"validationMessage",content:"validationMessageContent",error:"validationError"},n=$(e).closest("."+i.wrapper);0!==n.length&&(e=n.find("."+i.msg),t?(n.addClass(i.error),(e=0===e.length?$('<div class="'+i.msg+'"><div class="'+i.content+'"></div></div>').appendTo(n):e).find("."+i.content).html(t),e.show()):(n.removeClass(i.error),e.hide()),this.resize())}}});
