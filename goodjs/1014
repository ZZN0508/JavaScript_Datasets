define(["OK/logger","OK/utils/vanilla","OK/utils/dom","OK/utils/delegate"],function(s,n,c,i){"use strict";var h="ShortcutMenuReact",o=null,l=document.createElement("div");l.id="hook_Block_"+h,document.body.appendChild(l),OK.hookModel.captureBlockHook("body",l),l.addEventListener("change",function(){o&&o.visible()&&o.positingElement()});var a={};function e(e){this.hookId=e,this.stopClick=!0,this.ajaxRequest=null,this.showTimeout=null,this.hideTimeout=null,this.menuElement=null,this.cacheable=!0,this.loaded=!1,this.showOnClick=!0,this._hoverIn=!1}return e.getActive=function(){return o},e.setReactComponent=function(e,t){a[e]=t},e.removeReactComponent=function(e){delete a[e]},e.getReactComponent=function(e){return a[e]},e.prototype={activate:function(e){if(this.element=e,this.holder=this.getHolder(),this.blockId=this.element.getAttribute("data-blockid"),this.block=document.getElementById("hook_Block_"+this.blockId),this.inplace=this.element.getAttribute("data-inplace"),this.loaded=this.element.getAttribute("data-loaded"),this.showDelay=parseInt(this.element.getAttribute("data-show"),10)||300,this.hideDelay=parseInt(this.element.getAttribute("data-hide"),10)||100,this.cacheable=!this.element.getAttribute("data-nocache"),this.saveChanges=this.element.getAttribute("data-save-changes"),this.direction=this.element.getAttribute("data-direction"),this.position=this.element.getAttribute("data-position")||"center",this.showOnClick=this.element.getAttribute("data-onClick"),this.isShowImmediately=this.element.getAttribute("data-showImmediately"),this.showImmediatelySelector=this.element.getAttribute("data-showImmediatelySelector"),this.relatedMenu=this.getRelatedMenu(),this.hideOnClick=this.element.getAttribute("data-hideOnClick"),this.hideOnScroll=this.element.getAttribute("data-hideOnScroll"),this.ignoreDoubleHoverIn=this.element.getAttribute("data-ignore-double-hover-in"),!this.holder)return s.error("asm","noholder"),void s.success("asm","noholder",this.buildParamFingerprint());this.handlers={},this.boundAjaxFail=this.ajaxFail.bind(this),this.boundAjaxDone=this.ajaxDone.bind(this),this.holderDelegate=new i(this.holder),OK.device.isTouch&&(this.holderDelegate.on("touchstart",this.holderTouchStartListener),(t=(t=this.holder.getElementsByTagName("a")[0])||c.traverseParents(this.holder,function(e){return"A"===e.tagName.toUpperCase()},document.body,!0))&&(this.linkDelegate=new i(t),this.linkDelegate.on("touchstart",this.touchHandle.bind(this),!0)));var t="1"===this.element.getAttribute("data-delegate-hover");t?this.holderDelegate.on("mouseleave",".js-sc-target",this.hoverOutListener.bind(this),!0):this.holderDelegate.on("mouseleave",this.hoverOutListener.bind(this)),this.showOnClick?this.oneClickListener=this.addOneTimeListener(this.holder,"click",this.showMenu):(t?this.holderDelegate.on("mouseenter",".js-sc-target",this.hoverInListener.bind(this),!0):this.holderDelegate.on("mouseenter",this.hoverInListener.bind(this)),this.hideOnClick&&this.holderDelegate.on("click",this.hoverOutListener.bind(this))),this.inplace&&this.loaded&&this.initListeners(this.getBlock()),this.isShowImmediately&&this.showImmediately()},deactivate:function(){this.holder&&(this.ajaxClose(),this.hide(),this.removeOneTimeListener(this.oneClickListener),this.removeOneTimeListener(this.oneScrollListener),this.removeOneTimeListener(this.oneBodyTouchListener),this.removeOneTimeListener(this.oneImmediatelyHandler),this.holderDelegate.destroy(),this.linkDelegate&&this.linkDelegate.destroy(),this.shortcutMenuDelegate&&this.shortcutMenuDelegate.destroy(),this.tmpReactionsActiveInstanceListener=null)},buildParamFingerprint:function(){var e=[this.inplace,this.loaded,this.cacheable,this.showOnClick,this.hideOnClick,this.hideOnScroll],t="";return e.forEach(function(e){t+=(+!!e).toString()}),t},hoverInListener:function(e){this.ignoreDoubleHoverIn&&this._hoverIn||OK.device.isTouch&&e||e&&c.parent(e.target,"js-private-klass",null,!0)||(this._hoverIn=!0,this.clearHideTimeout(),this.showTimeout||this.visible()||(this.showTimeout=setTimeout(this.showMenu.bind(this),this.showDelay)))},checkAfterTmpReactionsDisabled:function(){this._hoverIn&&(this._hoverIn=!1,this.hoverInListener())},hoverOutListener:function(){this._hoverIn=!1,this.clearShowTimeout(),this.ajaxClose(),this.hideTimeout||o!==this||(this.hideTimeout=setTimeout(this.hideMenu.bind(this),this.hideDelay))},menuElementHoverInListener:function(){this.menuElementHoverInListenerCalled=!0,this.hideTimeout&&(this.hideTimeout=clearTimeout(this.hideTimeout))},menuElementLinkClickListener:function(e){c.parent(e.target,"js-doNotHide",this.block)||this.menuElementClickListener()},menuElementClickListener:function(){!0===this.hideTimeout&&(this.hideTimeout=null),this.hoverOutListener()},holderTouchStartListener:function(e){e.stopPropagation()},hide:function(){this.clearShowTimeout(),this.clearHideTimeout(),this.menuElement&&this.hideMenu()},getHolder:function(){var e=this.element.getAttribute("data-holder");return e?document.getElementById(e):this.element.previousElementSibling},getRelatedMenu:function(){var e,t=this.element.getAttribute("data-related");return t&&(e=OK.hookModel.getHookById(t)).getInstance?e.getInstance():null},getBlock:function(){return this.inplace?this.block:l},getHtml:function(){if(!this.block)return"";var e=this.block.innerHTML;return this.inplace&&this.cacheable||(OK.hookModel.setHookContent(this.blockId,""),this.cacheable&&(this.block.innerHTML=e)),e},initBlock:function(){if(this.element&&!this.block){for(var e,t=Array.prototype.slice.call(this.element.children),i=null,s=0;s<t.length;s++)if(t[s].classList.contains("posR")){i=t[s];break}i?this.block=i:((e=document.createElement("div")).id="hook_Block_"+this.blockId,e.className="posR",this.element.appendChild(e),this.block=e,OK.hookModel.captureBlockHook(this.hookId,e))}},initListeners:function(e){this.shortcutMenuDelegate=new i(e),this.shortcutMenuDelegate.on("click",".sc-menu a",this.menuElementLinkClickListener.bind(this)),this.shortcutMenuDelegate.on("click",".sc-menu .js-hide",this.menuElementClickListener.bind(this)),this.shortcutMenuDelegate.on("click",".js-forceHide",this.hideMenu.bind(this)),this.shortcutMenuDelegate.on("mouseenter",this.menuElementHoverInListener.bind(this)),this.shortcutMenuDelegate.on("mouseleave",this.hoverOutListener.bind(this)),OK.device.isTouch&&this.shortcutMenuDelegate.on("touchstart",this.holderTouchStartListener.bind(this))},showMenu:function(){if(clearTimeout(this.hideTimeout),this.showTimeout=null,!this.tmpReactionsDisabled){if(this.relatedMenu&&this.relatedMenu.hide&&this.relatedMenu.hide(),o){if(this.visible())return;o.hide()}var i,e,t;this.showOnClick&&(this.removeOneTimeListener(this.oneClickListener),this.oneClickListener=this.addOneTimeListener(this.holder,"click",this.hideMenu)),this.hideOnScroll&&(i=/(auto|scroll)/,e=(e=c.traverseParents(this.element,function(e){var t=window.getComputedStyle(e);return i.test(t.overflow+t.overflowY+t.overflowX)&&e.scrollHeight>e.clientHeight}))||window,this.oneScrollListener=this.addOneTimeListener(e,"scroll",this.hoverOutListener)),this.showTimeout=null,OK.device.isTouch&&(this.oneBodyTouchListener=this.addOneTimeListener(document.body,"touchstart",this.hoverOutListener)),this.ajaxRequest||(this.startTime=Date.now(),this.loaded?(t=this.getHtml(),this.processHTML(t,void 0,!this.inplace||!this.cacheable),s.success("asm","show","cache")):(t=this.element.getAttribute("data-url"),this.ajaxRequest=n.ajax({url:t,dataType:"html"},function(){}),this.ajaxRequest.then(this.boundAjaxDone,this.boundAjaxFail)))}},showImmediately:function(){var e=this;e.showImmediatelySelector&&setTimeout(function(){var t=e.showImmediatelySelector+":hover";e.showImmediatelyElement=c.traverseParents(e.holder,function(e){return e.matches(t)}),e.showImmediatelyElement.matches(t)&&(e.showMenu(),e.oneImmediatelyHandler=this.addOneTimeListener(e.showImmediatelyElement,"mouseleave",function(){setTimeout(function(){e.menuElementHoverInListenerCalled||e.hideMenu()},e.hideDelay)}))},1)},visible:function(){return o===this},hideMenu:function(){this.clearShowTimeout(),(this.visible()||this.showOnClick)&&(this.hideTimeout=null,this.stopClick=!0,this.showOnClick&&(this.removeOneTimeListener(this.oneClickListener),this.oneClickListener=this.addOneTimeListener(this.holder,"click",this.showMenu)),this.ajaxClose(function(){s.success("asm","ajax","to")}),this.menuElement&&(this.menuElement.classList.add("sc-menu__hidden"),this.getHtml(),this.saveChanges&&!this.inplace&&this.loaded&&this.cacheable&&(this.initBlock(),this.block.innerHTML=l.innerHTML),OK.hookModel.setHookContent(h,""),this.menuElement=null),this.holder.classList.remove("__vis"),this.shortcutMenuDelegate&&!this.cacheable&&this.shortcutMenuDelegate.off(),o=null,this.tmpReactionsActiveInstanceListener&&this.tmpReactionsActiveInstanceListener())},touchHandle:function(e){if(this.stopClick)return e.preventDefault(),e.stopPropagation(),this.stopClick=!1,this.showOnClick||this.hoverInListener(),!1;this.hoverOutListener()},getOffset:function(e){e=e.getBoundingClientRect();return{left:e.left+window.pageXOffset,top:e.top+window.pageYOffset}},positingElement:function(){var e=c.outerSize(this.holder,!1,!0),t=this.inplace?{top:0,left:0}:this.getOffset(this.holder),i=c.outerSize(this.holder,!0,!0),s=c.outerSize(this.menuElement,!0,!0);"center"!==this.position&&"auto"!==this.position&&this.menuElement.classList.add("__noarrow");var n=c.outerSize(this.menuElement,!1,!0),h="top"===this.direction?this.getOffset(this.holder).top-window.pageYOffset-90>n:"bottom"!==this.direction&&window.innerHeight-e-this.holder.getBoundingClientRect().top<n,o=t.top,l=[];h?(this.menuElement.classList.add("sc-menu__top"),this.inplace?l.push("top: auto; bottom: "+Math.round(o+e)+"px;"):(o-=n,l.push("bottom: auto; top: "+Math.round(o)+"px;"))):(this.menuElement.classList.remove("sc-menu__top"),this.inplace||(o+=e),l.push("bottom: auto; top: "+Math.round(o)+"px;"));var a=Math.round(t.left-(s-i)),r=Math.round(t.left),u=Math.round(t.left+(i-s)/2);switch(this.position){case"left":l.push("left: "+a+"px;");break;case"right":l.push("left: "+r+"px;");break;case"auto":window.innerWidth-OK.scrollBar.width>t.left+s?(l.push("left: "+r+"px;"),this.menuElement.classList.remove("__right"),this.menuElement.classList.add("__left")):(l.push("left: "+a+"px;"),this.menuElement.classList.add("__right"),this.menuElement.classList.remove("__left"));break;default:l.push("left: "+u+"px;")}this.menuElement.setAttribute("style",l.join(""))},processHTML:function(e,t,i){var s=[];t&&t.getResponseHeader(OK.navigation.HEADER)&&(s=t.getResponseHeader(OK.navigation.HEADER).split(",")),t=this.inplace?(this.initBlock(),s[0]=this.blockId,this.block):(s[0]=h,l),i&&(n.updateBlocks(e,s),this.initListeners(this.getBlock())),this.menuElement=c.firstByClass(t,"sc-menu"),this.positingElement(),this.menuElement.classList.remove("sc-menu__hidden"),this.holder.classList.add("__vis"),(o=this).tmpReactionsActiveInstanceListener&&this.tmpReactionsActiveInstanceListener()},ajaxDone:function(e){s.duration("asm",Date.now()-this.startTime,"ajax");var t=e.response;t&&0!==t.split(OK.navigation.SPLITER)[0].length?(s.success("asm","show","ajax"),this.cacheable&&this.element&&(this.loaded=!0,this.initBlock(),this.block.innerHTML=t.split(OK.navigation.SPLITER)[0]),this.processHTML(t,e.xhr,!0),this.menuShownListener&&this.menuShownListener(),this.ajaxClose()):s.success("asm","ajax","e")},ajaxFail:function(){this.ajaxClose(function(){s.error("asm","ajax")})},ajaxClose:function(e){this.ajaxRequest&&(this.ajaxRequest.xhr.abort(),this.ajaxRequest=null,"function"==typeof e&&e())},isWaitingBeforeShow:function(){return this.showTimeout||this.ajaxRequest},abortWaitingBeforeShow:function(){this.clearShowTimeout(),this.ajaxClose()},clearShowTimeout:function(){this.showTimeout&&(this.showTimeout=clearTimeout(this.showTimeout))},clearHideTimeout:function(){this.hideTimeout&&(this.hideTimeout=clearTimeout(this.hideTimeout))},addOneTimeListener:function(t,e,i){function s(e){t.removeEventListener(e.type,s),i.call(n,e)}var n=this;return t.addEventListener(e,s),{element:t,type:e,handler:s}},removeOneTimeListener:function(e){e&&e.element.removeEventListener(e.type,e.handler)}},e});
