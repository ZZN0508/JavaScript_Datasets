"use strict";var HistoryManager=function(){var t=this;t.MAX_PRICE=100,t.MAX_BADGE=10,t.storage=null,t.history=0===location.hostname.indexOf("history."),t.domain="history.kakaku.com"};HistoryManager.prototype.connect=function(t){var e=this;if(null===e.storage&&(e.storage=new LocalStorageClient),!e.history)return Promise.reject("Disallow domain");var n=e.storage.onConnect();return t?n:n.then(function(){return e.storage.get(StorageConstant.History.Disabled)}).then(function(t){return JSON.parse(t||"false")?Promise.reject("History disabled"):n})},HistoryManager.prototype.setDisabled=function(t){var e=this;return e.connect(!0).then(function(){return t?e.storage.set(StorageConstant.History.Disabled,!0):e.storage.del(StorageConstant.History.Disabled)}).catch(function(t){})},HistoryManager.prototype.clear=function(){var t=this;return t.connect().then(function(){return Promise.all([t.storage.del(StorageConstant.History.Price),t.storage.del(StorageConstant.History.Badge),t.storage.del(StorageConstant.History.Update),t.storage.del(StorageConstant.History.Merged)]).catch(function(t){})})},HistoryManager.prototype.getHistories=function(){var t=this;return t.connect().then(function(){return t.storage.get(StorageConstant.History.Price)}).then(function(t){return JSON.parse(t||"[]")}).catch(function(t){return[]})},HistoryManager.prototype.getBadges=function(){var t=this;return t.connect().then(function(){return t.storage.get(StorageConstant.History.Badge)}).then(function(t){return JSON.parse(t||"[]")}).catch(function(t){return[]})},HistoryManager.prototype.getUpdated=function(){var t=this;return t.connect().then(function(){return t.storage.get(StorageConstant.History.Update)}).then(function(t){return new Date(t||null)}).catch(function(t){return null})},HistoryManager.prototype.getMerged=function(){var t=this;return t.connect().then(function(){return t.storage.get(StorageConstant.History.Merged)}).then(function(t){return new Date(t||null)}).catch(function(t){return null})},HistoryManager.prototype.getDisabled=function(){var t=this;return t.connect(!0).then(function(){return t.storage.get(StorageConstant.History.Disabled)}).then(function(t){return!!JSON.parse(t||0)}).catch(function(t){return null})},HistoryManager.prototype.getPush=function(){var t=this;return t.connect().then(function(){return t.storage.get(StorageConstant.History.Push)}).then(function(t){t=JSON.parse(t||"{}");return t="[object Object]"!==Object.prototype.toString.call(t)?{}:t}).catch(function(t){return console.log("HistoryManager.getPush",t),{}})},HistoryManager.prototype.setHistory=function(r,o){var i=this;if(i.history)return o=isNaN(parseInt(o,10))||0==o?null:+o,i.getHistories().then(function(t){var e,n=_.findIndex(t,function(t){return t.product===r});return-1===n?e={product:r,price:o,init:!0,view:(new Date).getTime()}:((e=t[n]).price=o,e.init=!0,e.view=(new Date).getTime(),t.splice(n,1)),t.unshift(e),i.storage.set(StorageConstant.History.Price,JSON.stringify(t.slice(0,i.MAX_PRICE)))}).catch(function(t){});var t=document.createElement("iframe");t.setAttribute("src","https://"+i.domain+"/history/parts.aspx?type=additem&version=v2&value="+encodeURIComponent(r)),t.setAttribute("width",1),t.setAttribute("height",1),t.setAttribute("frameborder",0),t.setAttribute("noresize","noresize"),t.setAttribute("scrolling","no"),document.getElementsByTagName("body")[0].appendChild(t)},HistoryManager.prototype.setHistories=function(t){return this.storage.set(StorageConstant.History.Price,JSON.stringify(t.slice(0,this.MAX_PRICE)))},HistoryManager.prototype.setBadges=function(t){return this.storage.set(StorageConstant.History.Badge,JSON.stringify(t.slice(0,this.MAX_BADGE)))},HistoryManager.prototype.setUpdated=function(t){var e=this;return e.connect().then(function(){return e.storage.set(StorageConstant.History.Update,t)}).catch(function(t){})},HistoryManager.prototype.setMerged=function(t){var e=this;return e.connect().then(function(){return e.storage.set(StorageConstant.History.Merged,t)}).catch(function(t){})},HistoryManager.prototype.setPush=function(t){return this.storage.set(StorageConstant.History.Push,JSON.stringify(t))},HistoryManager.prototype.removeHistory=function(n){var r=this;return r.getHistories().then(function(t){var e=_.findIndex(t,function(t){return t.product===n});return-1!==e&&t.splice(e,1),r.storage.set(StorageConstant.History.Price,JSON.stringify(t))}).catch(function(t){})},HistoryManager.prototype.removeBadge=function(n){var r=this;return r.getBadges().then(function(t){var e=_.findIndex(t,function(t){return t.product===n});return-1!==e&&t.splice(e,1),r.storage.set(StorageConstant.History.Badge,JSON.stringify(t))}).catch(function(t){})};var historyManager=new HistoryManager;
