define(["OK/logger"],function(u){"use strict";var e,t=null,n=null,s="nogwt",l=!1,m=60,c=5e3,f=30,g=100,v=5,b=[50],h=1e3,i=0,a=0,r=0,p=0,o=0,w=null,y=[],A=!1,O=0;function k(t,e){document.body.dispatchEvent(new CustomEvent("performance-event",{detail:{type:t,value:e},bubbles:!0}))}function C(){return OK&&OK.Layers&&OK.Layers.isAnyLayerOpened()}function d(t){g<t-a&&(p+=1),h<=(a=t)-r?(y.push(o),o=0,r=t):o+=1,c<t-i?L(!0):w=window.requestAnimationFrame(d)}function E(){o=O=p=0,a=window.performance.now(),r=i=a,l=C(),A=!0,w=window.requestAnimationFrame(d)}function L(t){window.cancelAnimationFrame(w),w=null,A=!1;var e=s;if((l||C())&&(e="layer"),t)u.duration&&(v<p&&p<c/g&&(u.duration("framerate",p,e),k("framerate",{lagCount:p,state:e})),v<O&&(u.duration("longtask.duration",O,e),k("longtask",{lagCount:O,state:e}))),E();else{for(var n,i,a,r,o,d=function(t){for(var e,n,i=[],a=1e3/h,r=a-1;r<t.length;r++){for(n=e=0;n<a;n++)e+=t[r-n];i.push(e)}return i}(y);d.length>=f;){for(n=d.splice(0,f),a=o=0;a<f;a++)(r=n[a])>m&&(u.duration("overFpsLimit",r),n[a]=r=m),o+=r;(i=function(n,t){var i={};return n.sort(function(t,e){return t-e}),t.forEach(function(t){var e;t&&(e=Math.floor((n.length-1)*(t/100)),i["p"+t]=n[e])}),i}(n,b)).mean=Math.floor(o/f),i.min=Math.min.apply(null,n),i.max=Math.max.apply(null,n),i.state=e,u.duration("altFramerate",i.p50||0,e,JSON.stringify(i)),k("altFramerate",i)}y=[]}}function K(){L(!1),s=OK.getCurrentDesktopModelId(),E()}function M(){document[t]?L(!1):E()}return void 0!==document.hidden?(t="hidden",n="visibilitychange"):void 0!==document.mozHidden?(t="mozHidden",n="mozvisibilitychange"):void 0!==document.msHidden?(t="msHidden",n="msvisibilitychange"):void 0!==document.webkitHidden&&(t="webkitHidden",n="webkitvisibilitychange"),{activate:function(t){if(c=Number(t.getAttribute("data-test-time"))||c,g=Number(t.getAttribute("data-threshold"))||g,v=t.hasAttribute("data-limit")?Number(t.getAttribute("data-limit")):v,f=t.hasAttribute("data-stat-limit")?Number(t.getAttribute("data-stat-limit")):f,h=t.hasAttribute("data-frame-period")?Number(t.getAttribute("data-frame-period")):h,b=t.hasAttribute("data-percentiles")?t.getAttribute("data-percentiles").split(",").map(function(t){return Number(t)}):b,s=OK.getCurrentDesktopModelId&&OK.getCurrentDesktopModelId()||s,"PerformanceObserver"in window)try{e=new PerformanceObserver(function(t){for(var e=t.getEntries(),n=0;A&&n<e.length;n++)O+=1}).observe({entryTypes:["longtask"]})}catch(t){u.success("longtask.error","unsupported")}n&&(window.addEventListener("navigationStateChanged",K),document.addEventListener(n,M,!1)),E()},deactivate:function(){L(!1),e&&e.disconnect(),n&&(window.addEventListener("navigationStateChanged",K),document.removeEventListener(n,M))}}});
