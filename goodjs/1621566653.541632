define(["OK/reactions/ReactionController","OK/reactions/ReactionLogger","OK/LinkedHooksStore","OK/ShortcutMenuReact","OK/Surprise","OK/utils/dom","OK/utils/vanilla"],(function(t,e,i,s,n,o,a){var r;function c(t){return new Promise((function(e,i){(r?Promise.resolve(r):(require(["OK/alf"],(function(t){r=t})),Promise.reject())).then((function(e){return e.findAdv(t)})).then(e,i)}))}require(["OK/ExpressReactionsPopup"]);var l=i.collections.REACTION_COMPONENTS;function h(){this.onClick=this.onClick.bind(this),this.switchLogTarget=this.switchLogTarget.bind(this)}return h.prototype={activate:function(e){this.el=e,this.blockHookId=OK.hookModel.getNearestBlockHookId(e),this.blockHook=document.getElementById("hook_Block_"+this.blockHookId),this.reactScMenuId="ShMenuExpressReact-"+this.blockHookId,this.refId=e.getAttribute("data-like-reference-id"),this.hookId=e.getAttribute("data-req"),this.owner=e.getAttribute("data-owner"),this.isPreview="1"===e.getAttribute("data-preview"),this.isButton="1"===e.getAttribute("data-button"),this.isCustomButton="1"===e.getAttribute("data-custom-button"),this.likeReactionData={reactionId:0,icon:e.getAttribute("data-like-icon"),text:e.getAttribute("data-like-tx")},this.customReactionData={reactionId:+e.getAttribute("data-custom-reaction-id"),icon:e.getAttribute("data-custom-reaction-icon"),text:e.getAttribute("data-custom-reaction-tx"),surprise:e.getAttribute("data-custom-reaction-surprise")};var n=parseInt(e.getAttribute("data-react"),10);this.reactionId=isNaN(n)?null:n,this.reactionCount=parseInt(e.getAttribute("data-count"),10)||0,this.logLocation=e.getAttribute("data-ll"),this.isButton||this.isCustomButton||i.add(this.refId,l,this.hookId),this.isButton||e.addEventListener("click",this.onClick),this.syncPlayersLikes(),this.switchLogTarget(),s.setReactComponent(this.blockHookId,this),setTimeout(this.addReactSMListeners.bind(this)),this.addLikesSMListeners(),this.isCustomButton&&(this.onReactionExternalChange=this.onReactionExternalChange.bind(this),t.subscribe(this.refId,this.onReactionExternalChange))},deactivate:function(){i.remove(this.refId,l,this.hookId),this.isButton||this.el.removeEventListener("click",this.onClick),this.surprise&&(this.surprise.destroy(),this.surprise=null),this.likersOnCountShm&&this.likersOnCountShm.hide(),s.removeReactComponent(this.blockHookId,this)},syncPlayersLikes:function(){if(this.blockHook){var t=this.blockHook.getAttribute("data-player-id");t&&runLinkedVideoCallbackFromJS({callbackId:t,liked:null!==this.reactionId,likeCount:this.reactionCount})}},switchLogTarget:function(){var t=this.getReactScMenu();null===this.reactionId?this.el.setAttribute("data-l","t,.l"):t&&t.visible()?this.el.setAttribute("data-l","t,hide-react-sc"):this.el.setAttribute("data-l","t,unlike")},getReactScMenu:function(){var t=OK.hookModel.getHookById(this.reactScMenuId);return t&&t.getInstance()},addReactSMListeners:function(){var t=this.getReactScMenu();t&&(t.menuShownListener=this.switchLogTarget,t.tmpReactionsActiveInstanceListener=this.switchLogTarget)},addLikesSMListeners:function(){var t=this.el.querySelector(".js-sleep-shm");t&&(this.likersOnCountShm=new s,this.likersOnCountShm.activate(t),this.likersOnCountShm.tmpReactionsActiveInstanceListener=this._activateSMListener.bind(this))},_activateSMListener:function(){var t=this.getReactScMenu();t&&(t.tmpReactionsDisabled=this.likersOnCountShm.visible(),t.tmpReactionsDisabled||t.checkAfterTmpReactionsDisabled())},onClick:function(t){var e,i=this.isPreview,s=this.getReactScMenu();if(this.isCustomButton){this._doChangeReaction(this.customReactionData,this.reactionId);var a=this.customReactionData.surprise;if(!a)return;return this.surprise&&(this.surprise.destroy(),this.surprise=null),this.surprise=new n.Surprise(this.el,a,t.clientX,t.clientY),void this.surprise.run()}if(i&&s&&s.visible())s.hideMenu();else{if(s&&(s.visible()&&s.hideMenu(),s.isWaitingBeforeShow()&&s.abortWaitingBeforeShow()),null!==this.reactionId)e=null;else{var r=o.parent(t.target,"js-klass-action",this.el,!0);e=this.isCustomButton||r&&"private"===r.getAttribute("data-klass-type")?this.customReactionData:this.likeReactionData}this._doChangeReaction(e,this.reactionId)}},changeReaction:function(e,i,s){return this.isPreview=s.mode===t.ORDER_MODE.ONLY_DRAW,this._doChangeReaction(e,i,s)},getCurrentReactionData:function(){if(null!==this.reactionId){var t=o.firstByClass(this.el,"widget_tx");return{reactionId:this.reactionId,icon:this.el.getAttribute("data-react-icon"),text:t?t.textContent:""}}return null},onReactionExternalChange:function(t){var e=o.parent(this.el,"widget-list_i");e&&e.classList.toggle("invisible",null!==t.reactionId),this.reactionId=t.reactionId},refreshView:function(t){if(!this.isButton&&!this.isCustomButton){var e=o.firstByClass(this.el,"widget_ico"),i=this.getCurrentReactionData();i?e.classList.remove("__react","__react-"+i.icon):e.classList.remove("ic_klass");var s=o.firstByClass(this.el,"js-count"),n=this.el.parentNode,r=o.firstByClass(this.el,"js-private-klass"),c=this.el.classList.contains("__multi");if(!s&&c&&((s=document.createElement("span")).className="widget_count widget_part js-count __empty",s.textContent=a.formatNumber(0),this.el.appendChild(s)),s){var l=s.textContent.replace(/\s/g,"");if(!isNaN(l))l=parseInt(l,10),l=i?t?l:l-1:t?l+1:l,s.textContent=a.formatNumber(l),0===l&&r&&this.el.removeChild(s)}var h=o.firstByClass(this.el,"widget_tx");t?(this.el.setAttribute("data-react-icon",t.icon),e.classList.add("__react","__react-"+t.icon),h&&(h.textContent=t.text),n.setAttribute("data-react",t.icon),n.classList.add("__active"),r&&r.classList.add("invisible")):(e.classList.add("ic_klass"),h&&(h.textContent=this.el.getAttribute("data-unlike-tx")),n.removeAttribute("data-react"),n.classList.remove("__active"),r&&r.classList.remove("invisible"))}},_doChangeReaction:function(i,s,n){this.refreshView(i);var o=i?i.reactionId:null;s=void 0!==s?s:this.reactionId;var a=!n||n.mode!==t.ORDER_MODE.ONLY_DRAW;a&&(null!==o?e.logReaction("like",o):e.logReaction("unlike",s)),this.reactionId=o;var r={ll:this.logLocation};return n&&n.payload&&(Object.assign(r,n.payload),delete n.payload),this._getImpressionId().then((function(t){t&&(r.impressionId=t)})).then(function(){try{t.notify(Object.assign({refId:this.refId,reactionId:o,prevReactionId:s,owner:this.owner,payload:r},n))}catch(t){a&&(null!==o?e.logReactionError("like-notify-error",t.message):e.logReactionError("unlike-notify-error",t.message))}}.bind(this))},_getImpressionId:function(){var t=this.el,e=t.closest(".js-video-scope");if(e){var i=e.getAttribute("data-impression-id");if(i)return Promise.resolve(i)}return new Promise((function(e){c(t).then((function(t){return t.getImpressionId()})).catch((function(){return null})).then(e),setTimeout((function(){e(null)}),5e3)}))}},h}));