KISSY.add("io/form-serializer",["dom"],function(o,e){function i(e){return e.replace(t,"\r\n")}var r,a=e("dom"),s=/^(?:select|textarea)/i,t=/\r?\n/g,c=/^(?:color|date|datetime|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i;return r={serialize:function(e,t){return o.param(r.getFormData(e),void 0,void 0,t||!1)},getFormData:function(e){var t=[],n={};return o.each(a.query(e),function(e){e=e.elements?o.makeArray(e.elements):[e],t.push.apply(t,e)}),t=o.filter(t,function(e){return e.name&&!e.disabled&&(e.checked||s.test(e.nodeName)||c.test(e.type))}),o.each(t,function(e){var t,r=a.val(e);null!==r&&(r=o.isArray(r)?o.map(r,i):i(r),void 0===(t=n[e.name])?n[e.name]=r:(t=!o.isArray(t)?n[e.name]=[t]:t).push.apply(t,o.makeArray(r)))}),n}}}),KISSY.add("io/base",["event/custom","promise"],function(u,e){function d(e){var t,r=this;if(!(r instanceof d))return new d(e);p.call(r),e=function(e){var t=e.context;delete e.context,(e=u.mix(u.clone(v),e,{deep:!0})).context=t||e;var r,n=e.type,o=e.dataType,t=e.uri=m.resolve(e.url);return e.uri.setQuery(""),"crossDomain"in e||(e.crossDomain=!e.uri.isSameOriginAs(m)),n=e.type=n.toUpperCase(),e.hasContent=!l.test(n),e.processData&&(r=e.data)&&"string"!=typeof r&&(e.data=u.param(r,void 0,void 0,e.serializeArray)),o=e.dataType=u.trim(o||"*").split(f),"cache"in e||!u.inArray(o[0],["script","jsonp"])||(e.cache=!1),e.hasContent||(e.data&&t.query.add(u.unparam(e.data)),!1===e.cache&&t.query.set("_ksTS",u.now()+"_"+u.guid())),e}(e),u.mix(r,{responseData:null,config:e||{},timeoutTimer:null,responseText:null,responseXML:null,responseHeadersString:"",responseHeaders:null,requestHeaders:{},readyState:0,state:0,statusText:null,status:0,transport:null}),p.Defer(r),d.fire("start",{ajaxConfig:e,io:r}),t=new(h[e.dataType[0]]||h["*"])(r),r.transport=t,e.contentType&&r.setRequestHeader("Content-Type",e.contentType);var n,o=e.dataType[0],i=e.timeout,a=e.context,s=e.headers,c=e.accepts;for(n in r.setRequestHeader("Accept",o&&c[o]?c[o]+("*"===o?"":", */*; q=0.01"):c["*"]),s)r.setRequestHeader(n,s[n]);if(e.beforeSend&&!1===e.beforeSend.call(a,r,e))return r;r.readyState=1,d.fire("send",{ajaxConfig:e,io:r}),e.async&&0<i&&(r.timeoutTimer=setTimeout(function(){r.abort("timeout")},1e3*i));try{r.state=1,t.send()}catch(e){r.state<2&&r._ioReady(-1,e.message||"send error")}return r}var t=e("event/custom"),p=e("promise"),r=/^(?:about|app|app\-storage|.+\-extension|file|widget)$/,f=/\s+/,e=function(e){return e},l=/^(?:GET|HEAD)$/,m=new u.Uri((u.Env.host.location||{}).href),r=m&&r.test(m.getScheme()),h={},v={type:"GET",contentType:"application/x-www-form-urlencoded; charset=UTF-8",async:!0,serializeArray:!0,processData:!0,accepts:{xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript","*":"*/*"},converters:{text:{json:u.parseJson,html:e,text:e,xml:u.parseXML}},headers:{"X-Requested-With":"XMLHttpRequest"},contents:{xml:/xml/,html:/html/,json:/json/}};return v.converters.html=v.converters.text,u.mix(d,t.Target),u.mix(d,{isLocal:r,setupConfig:function(e){u.mix(v,e,{deep:!0})},setupTransport:function(e,t){h[e]=t},getTransport:function(e){return h[e]},getConfig:function(){return v}}),d}),KISSY.add("io/xhr-transport-base",["./base"],function(m,e){function n(e,t){try{return new(t||o).XMLHttpRequest}catch(e){}}function h(e){var t;return e.ifModified&&(t=e.uri,!1===e.cache&&(t=t.clone()).query.remove("_ksTS"),t=t.toString()),t}var v=e("./base"),o=m.Env.host,y=7<m.UA.ieMode&&o.XDomainRequest,e={proto:{}},g={},x={};v.__lastModifiedCached=g,v.__eTagCached=x,e.nativeXhr=o.ActiveXObject?function(e,t){var r;if(!l&&e&&y)r=new y;else if(!(r=!v.isLocal&&n(0,t)))e:{try{r=new(t||o).ActiveXObject("Microsoft.XMLHTTP");break e}catch(e){}r=void 0}return r}:n,e.XDomainRequest_=y;var l=e.supportCORS="withCredentials"in e.nativeXhr();return m.mix(e.proto,{sendInternal:function(){var e,t,r=this,n=(d=r.io).config,o=r.nativeXhr,i=n.files,a=i?"post":n.type,s=n.async,c=d.mimeType,u=d.requestHeaders||{},d=d._getUrlForSend(),p=h(n);for(t in p&&((e=g[p])&&(u["If-Modified-Since"]=e),(e=x[p])&&(u["If-None-Match"]=e)),(e=n.username)?o.open(a,d,s,e,n.password):o.open(a,d,s),"withCredentials"in(a=n.xhrFields||{})&&(l||delete a.withCredentials),a)try{o[t]=a[t]}catch(e){}if(c&&o.overrideMimeType&&o.overrideMimeType(c),!1===u["X-Requested-With"]&&delete u["X-Requested-With"],void 0!==o.setRequestHeader)for(t in u)o.setRequestHeader(t,u[t]);var f=n.hasContent&&n.data||null;i&&(u={},(c=f)&&(u=m.unparam(c)),u=m.mix(u,i),f=new FormData,m.each(u,function(e,t){m.isArray(e)?m.each(e,function(e){f.append(t+(n.serializeArray?"[]":""),e)}):f.append(t,e)})),o.send(f),s&&4!==o.readyState?y&&o instanceof y?(o.onload=function(){o.readyState=4,o.status=200,r._callback()},o.onerror=function(){o.readyState=4,o.status=500,r._callback()}):o.onreadystatechange=function(){r._callback()}:r._callback()},abort:function(){this._callback(0,1)},_callback:function(e,t){var r,n,o,i,a=this.nativeXhr,s=this.io,c=s.config;try{if(t||4===a.readyState)if(y&&a instanceof y?(a.onerror=m.noop,a.onload=m.noop):a.onreadystatechange=m.noop,t)4!==a.readyState&&a.abort();else{var u=h(c),d=a.status;y&&a instanceof y||(s.responseHeadersString=a.getAllResponseHeaders()),u&&(r=a.getResponseHeader("Last-Modified"),n=a.getResponseHeader("ETag"),r&&(g[u]=r),n&&(x[n]=n)),(i=a.responseXML)&&i.documentElement&&(s.responseXML=i);var p,f,l=s.responseText=a.responseText;c.files&&l&&(-1!==(p=l.indexOf("<body>"))&&(-1===(f=l.lastIndexOf("</body>"))&&(f=l.length),l=l.slice(p+6,f)),s.responseText=m.unEscapeHtml(l));try{o=a.statusText}catch(e){o=""}d||!v.isLocal||c.crossDomain?1223===d&&(d=204):d=s.responseText?200:404,s._ioReady(d,o)}}catch(e){a.onreadystatechange=m.noop,t||s._ioReady(-1,e.message||"process error")}}}),e}),KISSY.add("io/xdr-flash-transport",["./base","dom"],function(a,e){function t(e){this.io=e}var s,o=e("./base"),c=e("dom"),u={},d=a.Env.host.document,p=!1;return a.augment(t,{send:function(){var e,t,r,n=this,o=n.io,i=o.config;e=(i.xdr||{}).src||a.Config.base+"io/assets/io.swf",r=t=1,p||(p=!0,e='<object id="io_swf" type="application/x-shockwave-flash" data="'+e+'" width="0" height="0"><param name="movie" value="'+e+'" /><param name="FlashVars" value="yid='+t+"&uid="+r+'&host=KISSY.IO" /><param name="allowScriptAccess" value="always" /></object>',t=d.createElement("div"),c.prepend(t,d.body||d.documentElement),t.innerHTML=e),s?(n._uid=a.guid(),u[n._uid]=n,s.send(o._getUrlForSend(),{id:n._uid,uid:n._uid,method:i.type,data:i.hasContent&&i.data||{}})):setTimeout(function(){n.send()},200)},abort:function(){s.abort(this._uid)},_xdrResponse:function(e,t){var r,n,o=t.id,i=t.c,t=this.io;switch(i&&(n=i.responseText)&&(t.responseText=decodeURI(n)),e){case"success":r={status:200,statusText:"success"},delete u[o];break;case"abort":delete u[o];break;case"timeout":case"transport error":case"failure":delete u[o],r={status:"status"in i?i.status:500,statusText:i.statusText||e}}r&&t._ioReady(r.status,r.statusText)}}),o.applyTo=function(e,t,r){var e=t.split(".").slice(1),n=o;a.each(e,function(e){n=n[e]}),n.apply(null,r)},o.xdrReady=function(){s=d.getElementById("io_swf")},o.xdrResponse=function(e,t){var r=u[t.uid];r&&r._xdrResponse(e,t)},t}),KISSY.add("io/sub-domain-transport",["event/dom","dom","./xhr-transport-base"],function(i,e){function t(e){var t=e.config;this.io=e,t.crossDomain=!1}function a(){var e=this.io.config.uri.getHostname();(e=p[e]).ready=1,s.detach(e.iframe,"load",a,this),this.send()}var s=e("event/dom"),c=e("dom"),u=e("./xhr-transport-base"),d=i.Env.host.document,p={};return i.augment(t,u.proto,{send:function(){var e=this.io.config,t=e.uri,r=t.getHostname(),n=p[r],o="/sub_domain_proxy.html";e.xdr&&e.xdr.subDomain&&e.xdr.subDomain.proxy&&(o=e.xdr.subDomain.proxy),n&&n.ready?(this.nativeXhr=u.nativeXhr(0,n.iframe.contentWindow))&&this.sendInternal():(n?e=n.iframe:(e=(n=p[r]={}).iframe=d.createElement("iframe"),c.css(e,{position:"absolute",left:"-9999px",top:"-9999px"}),c.prepend(e,d.body||d.documentElement),(n=new i.Uri).setScheme(t.getScheme()),n.setPort(t.getPort()),n.setHostname(r),n.setPath(o),e.src=n.toString()),s.on(e,"load",a,this))}}),t}),KISSY.add("io/xhr-transport",["./base","./xhr-transport-base","./xdr-flash-transport","./sub-domain-transport"],function(i,e){function t(e){var t=e.config,r=t.crossDomain,n=t.xdr||{},o=n.subDomain=n.subDomain||{};if(this.io=e,r&&!a.supportCORS){if(t=t.uri.getHostname(),u.domain&&i.endsWith(t,u.domain)&&!1!==o.proxy)return new c(e);if("flash"==""+n.use||!d)return new s(e)}return this.nativeXhr=a.nativeXhr(r),this}var r=e("./base"),a=e("./xhr-transport-base"),s=e("./xdr-flash-transport"),c=e("./sub-domain-transport"),u=i.Env.host.document,d=a.XDomainRequest_;return i.augment(t,a.proto,{send:function(){this.sendInternal()}}),r.setupTransport("*",t),r}),KISSY.add("io/script-transport",["./base"],function(n,e){function t(e){return e.config.crossDomain?(this.io=e,this):new(r.getTransport("*"))(e)}var r=e("./base");return r.setupConfig({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/javascript|ecmascript/},converters:{text:{script:function(e){return n.globalEval(e),e}}}}),n.augment(t,{send:function(){var e=this,t=e.io,r=t.config;e.script=n.getScript(t._getUrlForSend(),{charset:r.scriptCharset,success:function(){e._callback("success")},error:function(){e._callback("error")}})},_callback:function(e,t){var r=this.io;this.script&&(this.script=void 0,t||("error"!==e?r._ioReady(200,"success"):"error"===e&&r._ioReady(500,"script error")))},abort:function(){this._callback(0,1)}}),r.setupTransport("script",t),r}),KISSY.add("io/jsonp",["./base"],function(s,e){var e=e("./base"),c=s.Env.host;return e.setupConfig({jsonp:"callback",jsonpCallback:function(){return s.guid("jsonp")}}),e.on("start",function(e){var t,r,n,o,i=e.io,a=i.config;"jsonp"===(e=a.dataType)[0]&&(delete a.contentType,r=a.jsonpCallback,n="function"==typeof r?r():r,o=c[n],a.uri.query.set(a.jsonp,n),c[n]=function(e){1<arguments.length&&(e=s.makeArray(arguments)),t=[e]},i.fin(function(){if(void 0===(c[n]=o))try{delete c[n]}catch(e){}else t&&o(t[0])}),(i=a.converters).script=i.script||{},i.script.json=function(){if(!t)throw Error("not call jsonpCallback: "+n);return t[0]},e.length=2,e[0]="script",e[1]="json")}),e}),KISSY.add("io/form",["./base","dom","./form-serializer"],function(d,e){var t=e("./base"),p=e("dom"),f=e("./form-serializer"),l=Array.prototype.slice,m=d.Env.host.FormData;return t.on("start",function(e){if(r=(e=e.io.config).form){for(var t=p.get(r),r=e.data,n=!1,o={},i=p.query("input",t),a=0,s=i.length;a<s;a++){var c=i[a];if("file"===c.type.toLowerCase()){if(n=!0,!m)break;var u=l.call(c.files,0);o[p.attr(c,"name")]=1<u.length?u:u[0]||null}}n&&m&&(e.files=e.files||{},d.mix(e.files,o),delete e.contentType),!n||m?(t=f.getFormData(t),e.hasContent?(t=d.param(t,void 0,void 0,e.serializeArray),e.data=r?e.data+"&"+t:t):e.uri.query.add(t)):("*"===(e=(r=e.dataType)[0])&&(e="text"),r.length=2,r[0]="iframe",r[1]=e)}}),t}),KISSY.add("io/iframe-transport",["dom","./base","event/dom"],function(x,e){function t(e){this.io=e}var b=e("dom"),r=e("./base"),S=e("event/dom"),T=x.Env.host.document,e=x.clone(r.getConfig().converters.text);return e.json=function(e){return x.parseJson(x.unEscapeHtml(e))},r.setupConfig({converters:{iframe:e,text:{iframe:function(e){return e}},xml:{iframe:function(e){return e}}}}),x.augment(t,{send:function(){function e(){S.on(t,"load error",m._callback,m),g.submit()}var t,r,n,o,i,a,s,c,u,d,p,f,l,m=this,h=m.io,v=h.config,y=v.data,g=b.get(v.form);m.attrs={target:b.attr(g,"target")||"",action:b.attr(g,"action")||"",encoding:b.attr(g,"encoding"),enctype:b.attr(g,"enctype"),method:b.attr(g,"method")},m.form=g,n=h,o=x.guid("io-iframe"),i=b.getEmptyIframeSrc(),n=n.iframe=b.create("<iframe "+(i?' src="'+i+'" ':"")+' id="'+o+'" name="'+o+'" style="position:absolute;left:-9999px;top:-9999px;"/>'),b.prepend(n,T.body||T.documentElement),t=n,b.attr(g,{target:t.id,action:h._getUrlForSend(),method:"post",enctype:"multipart/form-data",encoding:"multipart/form-data"}),(r=y?x.unparam(y):r)&&(a=r,s=g,c=v.serializeArray,l=[],x.each(a,function(e,t){for(u=x.isArray(e),d=x.makeArray(e),p=0;p<d.length;p++)(f=T.createElement("input")).type="hidden",f.name=t+(u&&c?"[]":""),f.value=d[p],b.append(f,s),l.push(f)}),a=l),m.fields=a,6===x.UA.ie?setTimeout(e,0):e()},_callback:function(e){var t,r=this,n=r.form,o=r.io,e=e.type,i=o.iframe;if(i)if("abort"===e&&6===x.UA.ie?setTimeout(function(){b.attr(n,r.attrs)},0):b.attr(n,r.attrs),b.remove(this.fields),S.detach(i),setTimeout(function(){b.remove(i)},30),o.iframe=null,"load"===e)try{(t=i.contentWindow.document)&&t.body&&(o.responseText=b.html(t.body),x.startsWith(o.responseText,"<?xml")&&(o.responseText=void 0)),o.responseXML=t&&t.XMLDocument?t.XMLDocument:t,t?o._ioReady(200,"success"):o._ioReady(500,"parser error")}catch(e){o._ioReady(500,"parser error")}else"error"===e&&o._ioReady(500,"error")},abort:function(){this._callback({type:"abort"})}}),r.setupTransport("iframe",t),r}),KISSY.add("io/methods",["promise","./base"],function(p,e){var t=e("promise"),c=e("./base"),n=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm;p.extend(c,t,{setRequestHeader:function(e,t){return this.requestHeaders[e]=t,this},getAllResponseHeaders:function(){return 2===this.state?this.responseHeadersString:null},getResponseHeader:function(e){var t,r,e=e.toLowerCase();if(2===this.state){if(!(r=this.responseHeaders))for(r=this.responseHeaders={};t=n.exec(this.responseHeadersString);)r[t[1].toLowerCase()]=t[2];t=r[e]}return void 0===t?null:t},overrideMimeType:function(e){return this.state||(this.mimeType=e),this},abort:function(e){return e=e||"abort",this.transport&&this.transport.abort(e),this._ioReady(0,e),this},getNativeXhr:function(){var e=this.transport;return e?e.nativeXhr:null},_ioReady:function(e,t){if(2!==this.state){var r;if(this.state=2,this.readyState=4,200<=e&&e<300||304===e)if(304===e)t="not modified",r=!0;else try{(function(e){var r,n,o=e.responseText,i=e.responseXML,t=e.config,a=t.converters,s=t.contents,c=t.dataType;if(o||i){for(t=e.mimeType||e.getResponseHeader("Content-Type");"*"===c[0];)c.shift();if(!c.length)for(u in s)if(s[u].test(t)){c[0]!==u&&c.unshift(u);break}for(c[0]=c[0]||"text",u=0;u<c.length;u++){if("text"===c[u]&&void 0!==o){r=o;break}if("xml"===c[u]&&void 0!==i){r=i;break}}r||(n={text:o,xml:i},p.each(["text","xml"],function(e){var t=c[0];if(a[e]&&a[e][t]&&n[e])return c.unshift(e),r="text"===e?o:i,!1}))}for(s=c[0],t=1;t<c.length;t++){var u=c[t],d=a[s]&&a[s][u];if(!d)throw Error("no covert for "+s+" => "+u);r=d(r),s=u}e.responseData=r})(this),t="success",r=!0}catch(e){t=e.message||"parser error"}else e<0&&(e=0);this.status=e,this.statusText=t;var n=this.defer,o=this.config;(i=this.timeoutTimer)&&(clearTimeout(i),this.timeoutTimer=0);var i=r?"success":"error",a=[this.responseData,t,this],s=o.context,e={ajaxConfig:o,io:this};(t=o[i])&&t.apply(s,a),(t=o.complete)&&t.apply(s,a),c.fire(i,e),c.fire("complete",e),n[r?"resolve":"reject"](a)}},_getUrlForSend:function(){var e=this.config,t=e.uri,r=p.Uri.getComponents(e.url).query||"";return t.toString.call(t,e.serializeArray)+(r&&(t.query.has()?"&":"?")+r)}})}),KISSY.add("io","io/form-serializer,io/base,io/xhr-transport,io/script-transport,io/jsonp,io/form,io/iframe-transport,io/methods".split(","),function(e,t){function o(e,t,r,n,o){return"function"==typeof t&&(n=r,r=t,t=void 0),i({type:o||"get",url:e,data:t,success:r,dataType:n})}var r=t("io/form-serializer"),i=t("io/base");return t("io/xhr-transport"),t("io/script-transport"),t("io/jsonp"),t("io/form"),t("io/iframe-transport"),t("io/methods"),e.mix(i,{serialize:r.serialize,get:o,post:function(e,t,r,n){return"function"==typeof t&&(n=r,r=t,t=void 0),o(e,t,r,n,"post")},jsonp:function(e,t,r){return"function"==typeof t&&(r=t,t=void 0),o(e,t,r,"jsonp")},getScript:e.getScript,getJSON:function(e,t,r){return"function"==typeof t&&(r=t,t=void 0),o(e,t,r,"json")},upload:function(e,t,r,n,o){return"function"==typeof r&&(o=n,n=r,r=void 0),i({url:e,type:"post",dataType:o,form:t,data:r,success:n})}}),e.mix(e,{Ajax:i,IO:i,ajax:i,io:i,jsonp:i.jsonp}),i}),KISSY.add("promise",[],function(n){function a(e){"undefined"!=typeof console&&console.error&&console.error(e)}function s(e,t,r){var n,o;e instanceof d?l(function(){r.call(e,e[f])}):(n=e[f],(o=e[m])?o.push([t,r]):i(n)?s(n,t,r):t&&l(function(){t.call(e,n)}))}function c(e){if(!(this instanceof c))return new c(e);this.promise=e||new u,this.promise.defer=this}function i(e){return e&&e instanceof u}function u(e){void 0===(this[f]=e)&&(this[m]=[],this[o]=[])}function d(e){return e instanceof d?e:(u.apply(this,arguments),this)}function p(e,t,r){function n(e){i||e instanceof u||(i=1,o.resolve(function(e){try{return t?t.call(this,e):e}catch(e){return a(e.stack||e),new d(e)}}.call(this,e)))}var o=new c,i=0;return e instanceof u?s(e,n,function(e){i||(i=1,o.resolve(function(e){try{return r?r.call(this,e):new d(e)}catch(e){return a(e.stack||e),new d(e)}}.call(this,e)))}):n(e),o.promise}function t(e){return!r(e)&&i(e)&&void 0===e[m]&&(!i(e[f])||t(e[f]))}function r(e){return i(e)&&void 0===e[m]&&e[f]instanceof d}var f="__promise_value",l=n.setImmediate,o="__promise_progress_listeners",m="__promise_pendings";return c.prototype={constructor:c,resolve:function(e){var t,r=this.promise;return(t=r[m])?(r[f]=e,t=[].concat(t),r[m]=void 0,r[o]=void 0,n.each(t,function(e){s(r,e[0],e[1])}),e):null},reject:function(e){return this.resolve(new d(e))},notify:function(t){n.each(this.promise[o],function(e){l(function(){e(t)})})}},u.prototype={constructor:u,then:function(e,t,r){return r&&this.progress(r),p(this,e,t)},progress:function(e){return this[o]&&this[o].push(e),this},fail:function(e){return p(this,0,e)},fin:function(t){return p(this,function(e){return t(e,!0)},function(e){return t(e,!1)})},done:function(e,t){(e||t?this.then(e,t):this).fail(function(e){setTimeout(function(){throw e},0)})},isResolved:function(){return t(this)},isRejected:function(){return r(this)}},n.extend(d,u),KISSY.Defer=c,(KISSY.Promise=u).Defer=c,n.mix(u,{when:p,isPromise:i,isResolved:t,isRejected:r,all:function(r){var n=r.length;if(!n)return null;for(var o=new c,e=0;e<r.length;e++)!function(e,t){p(e,function(e){r[t]=e,0==--n&&o.resolve(r)},function(e){o.reject(e)})}(r[e],e);return o.promise},async:function(e){return function(){function t(e,t){var r;try{r=i[e](t)}catch(e){return new d(e)}return r.done?r.value:p(r.value,n,o)}function n(e){return t("next",e)}function o(e){return t("throw",e)}var i=e.apply(this,arguments);return n()}}}),u});
