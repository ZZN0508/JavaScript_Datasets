"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}}();!function(){function e(t){for(var e=document.cookie.split("; "),i=0;i<e.length;i++){var n=e[i].split("=");if(n[0]==t)return n[1]}return""}var n=void 0,t=void 0,s=null;"undefined"!=typeof document&&(void 0!==document.hidden?(n="hidden",t="visibilitychange"):void 0!==document.msHidden?(n="msHidden",t="msvisibilitychange"):void 0!==document.webkitHidden&&(n="webkitHidden",t="webkitvisibilitychange"));var i=(_createClass(h,[{key:"getIMtoken",value:function(){var t=this.UserName||"";t&&(t={appId:this.appId,userId:t||"",token:"",linkType:1,deviceId:this.deviceId,groupId:"CSDN-private-MSG",channelType:"privateMsg",appFrom:1},this.connectInfo=t,this.webSocketConnect())}},{key:"webSocketConnect",value:function(){var e=this,i=this.connectInfo;$.ajax({headers:{"Content-Type":"application/json"},type:"post",url:"https://bizapi.csdn.net/im-manage/v1.0/dispatch/do",data:JSON.stringify(i),crossDomain:!0,xhrFields:{withCredentials:!0},success:function(t){if(t.data){e.wsUrl="wss://"+t.data.linkServers[0],e.testMsg=JSON.stringify({ver:"1.0",cmdId:2,isZip:0,body:{userId:i.userId,appId:i.appId,imToken:t.data.imToken,groupId:i.groupId}});try{e.chatSocket=new WebSocket(e.wsUrl),e.webSocketInit()}catch(t){e.webSocketReconnect()}}},error:function(t){this.webSocketReconnect()}})}},{key:"webSocketReconnect",value:function(){var t=this;this.isReallClose||0<this.wsConnectStatus||this.lockReconnect||(this.lockReconnect=!0,this.tt&&clearTimeout(this.tt),this.tt=setTimeout(function(){t.webSocketConnect(),t.lockReconnect=!1},3e3))}},{key:"webSocketInit",value:function(t){var e=this;this.wsConnectStatus=1,this.chatSocket.onopen=function(t){e.wsConnectStatus=2,e.chatSocket.send(e.testMsg)},this.chatSocket.onmessage=function(t){e.wsConnectStatus=2,e.onMessage(t.data),e.heartCheck()},this.chatSocket.onerror=function(t){e.onMessage({cmdId:-1,msg:"ws 连接失败"}),e.wsConnectStatus=-1,e.isReallClose||e.webSocketReconnect()},this.chatSocket.onclose=function(t){e.onMessage({msg:"ws 连接关闭"}),e.wsConnectStatus=-1,e.isReallClose||e.webSocketReconnect()}}},{key:"onMessage",value:function(t){t="string"==typeof t?JSON.parse(t):t;5==+t.cmdId&&2===this.wsConnectStatus&&(this.wsConnectStatus=3),"function"==typeof this.messageHandle&&this.messageHandle(t)}},{key:"closeWebsocket",value:function(t){this.chatSocket.close(),t&&(this.isReallClose=!0),this.wsConnectStatus=0}},{key:"heartCheck",value:function(){var t=this;this.timeoutObj&&clearTimeout(this.timeoutObj),this.serverTimeoutObj&&clearTimeout(this.serverTimeoutObj),this.timeoutObj=setTimeout(function(){-1!==t.wsConnectStatus&&(t.chatSocket.send('{"cmdId":1}'),t.serverTimeoutObj=setTimeout(function(){t.chatSocket.close()},t.timeout))},this.timeout)}},{key:"sendMessage",value:function(t,e){return(t||e)&&this.UserName?Chatervice.sendMessage({username:this.UserName,liveId:this.liveId,message:t,anchorId:this.anchorId,image:e},{deviceId:this.deviceId,appId:this.appId}):void 0}}]),h),o=(_createClass(l,[{key:"init",value:function(){this.$tpl=$('<div class="notification" style="position: '+this.position+"; left:"+this.left+"; right: "+this.right+"; top: "+this.top+"; bottom: "+this.bottom+"; z-index: "+this.zIndex+';"></div>'),$(this.dom).append(this.$tpl),$(".notification").on("click",".notification-close",function(){var t=$(this).closest(".notification-item");t.slideUp("200",function(){t.remove()})})}},{key:"create",value:function(t){var e=$(t);e.appendTo(this.$tpl).hide().slideDown(200),setTimeout(function(){e.slideUp("200",function(){e.remove()})},this.time)}}]),l),c=(_createClass(a,[{key:"init",value:function(t,e){this.notification=new o(t),this.chat=new i({appid:"CSDN-PC",messageHandle:e.bind(this)}),-1===window.location.origin.indexOf("im.csdn.net")&&this.pageListener()}},{key:"create",value:function(t){this.notification.create(t)}},{key:"closeChat",value:function(){this.chat.closeWebsocket(!0)}},{key:"pageListener",value:function(){var e=this,i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:12e4;void 0!==t&&document.addEventListener(t,function(){var t=void 0===n?null:document[n];null!==t&&(s&&clearInterval(s),t&&2===e.chat.wsConnectStatus?s=setTimeout(function(){e.chat.closeWebsocket(!0)},i):!t&&e.chat.isReallClose&&(e.chat.webSocketConnect(),e.chat.isReallClose=!1))})}}]),a);function a(t,e){_classCallCheck(this,a),this.notification=null,this.chat=null,this.init(t,e)}function l(t){_classCallCheck(this,l),Object.assign(this,{position:"fixed",top:"initial",bottom:"initial",left:"initial",right:"initial",zIndex:99999,dom:"body",height:"100vh",overflow:"hidden",time:6e3},t),this.$tpl=null,this.init()}function h(t){_classCallCheck(this,h),this.messageHandle=t.messageHandle,this.UserName=e("UserName")||"",this.deviceId=e("uuid_tt_dd")||"default",this.appId=t.appid||"CSDN-PC",this.chatSocket=null,this.wsConnectStatus=0,this.testMsg=null,this.wsUrl=null,this.lockReconnect=!1,this.tt=null,this.timeout=5e3,this.timeoutObj=null,this.serverTimeoutObj=null,this.connectInfo=null,this.isReallClose=!1,this.getIMtoken()}window.CsdnNotification=c}();
