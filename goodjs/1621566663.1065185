define(["OK/logger"],(function(t){"use strict";var e,n=null,i=null,a="nogwt",r=!1,o=60,d=5e3,u=30,s=100,l=5,m=[50],c=1e3,f=0,g=0,v=0,b=0,h=0,p=null,w=[],y=!1,A=0;function O(t,e){document.body.dispatchEvent(new CustomEvent("performance-event",{detail:{type:t,value:e},bubbles:!0}))}function k(){return OK&&OK.Layers&&OK.Layers.isAnyLayerOpened()}function C(t){t-g>s&&(b+=1),g=t,t-v>=c?(w.push(h),h=0,v=t):h+=1,t-f>d?K(!0):p=window.requestAnimationFrame(C)}function E(){b=0,A=0,h=0,g=window.performance.now(),f=g,v=g,r=k(),y=!0,p=window.requestAnimationFrame(C)}function L(t,e){var n={};return t.sort((function(t,e){return t-e})),e.forEach((function(e){if(e){var i=Math.floor((t.length-1)*(e/100));n["p"+e]=t[i]}})),n}function K(e){window.cancelAnimationFrame(p),p=null,y=!1;var n=a;if((r||k())&&(n="layer"),e)t.duration&&(b>l&&b<d/s&&(t.duration("framerate",b,n),O("framerate",{lagCount:b,state:n})),A>l&&(t.duration("longtask.duration",A,n),O("longtask",{lagCount:A,state:n}))),E();else{for(var i,f,g,v,h,C=function(t){var e,n,i,a=[],r=1e3/c;for(n=r-1;n<t.length;n++){for(e=0,i=0;i<r;i++)e+=t[n-i];a.push(e)}return a}(w);C.length>=u;){for(i=C.splice(0,u),h=0,g=0;g<u;g++)(v=i[g])>o&&(t.duration("overFpsLimit",v),v=o,i[g]=v),h+=v;(f=L(i,m)).mean=Math.floor(h/u),f.min=Math.min.apply(null,i),f.max=Math.max.apply(null,i),f.state=n,t.duration("altFramerate",f.p50||0,n,JSON.stringify(f)),O("altFramerate",f)}w=[]}}function M(){K(!1),a=OK.getCurrentDesktopModelId(),E()}function N(){document[n]?K(!1):E()}return void 0!==document.hidden?(n="hidden",i="visibilitychange"):void 0!==document.mozHidden?(n="mozHidden",i="mozvisibilitychange"):void 0!==document.msHidden?(n="msHidden",i="msvisibilitychange"):void 0!==document.webkitHidden&&(n="webkitHidden",i="webkitvisibilitychange"),{activate:function(n){if(d=Number(n.getAttribute("data-test-time"))||d,s=Number(n.getAttribute("data-threshold"))||s,l=n.hasAttribute("data-limit")?Number(n.getAttribute("data-limit")):l,u=n.hasAttribute("data-stat-limit")?Number(n.getAttribute("data-stat-limit")):u,c=n.hasAttribute("data-frame-period")?Number(n.getAttribute("data-frame-period")):c,m=n.hasAttribute("data-percentiles")?n.getAttribute("data-percentiles").split(",").map((function(t){return Number(t)})):m,a=OK.getCurrentDesktopModelId&&OK.getCurrentDesktopModelId()||a,"PerformanceObserver"in window)try{e=new PerformanceObserver((function(t){for(var e=t.getEntries(),n=0;y&&n<e.length;n++)A+=1})).observe({entryTypes:["longtask"]})}catch(e){t.success("longtask.error","unsupported")}i&&(window.addEventListener("navigationStateChanged",M),document.addEventListener(i,N,!1)),E()},deactivate:function(){K(!1),e&&e.disconnect(),i&&(window.addEventListener("navigationStateChanged",M),document.removeEventListener(i,N))}}}));