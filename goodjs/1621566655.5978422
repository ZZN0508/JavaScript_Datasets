define(["OK/logger","OK/utils/dom","OK/ViewportTracker"],(function(e,t,i){"use strict";var s="standard",a="hover";function r(e,t){e.style.backgroundImage="url("+t+")"}function n(){this.isPaused=!0,this.lastFrameTime=0,this.frameID=0,this.bgPos=0,this.lastPos=0,this.active=0}return n.prototype={activate:function(r){var n,o=this,h=r.getAttribute("data-framerepeats"),m=h?JSON.parse(h):{};return o.element=r,o.mode=r.getAttribute("data-mode")||s,o.width=function(e){var t=getComputedStyle(e).width;return t?parseFloat(t.replace("px","")):e.clientWidth||0}(r),o.fps=parseInt(r.getAttribute("data-fps"),10)||24,o.replayDelay=parseInt(r.getAttribute("data-replaydelay"),10)||0,o.frameDuration=1e3/this.fps+1,o.bindedRender=this.render.bind(this),o.previewImage=this.element.style.backgroundImage,o.spriteImage=r.getAttribute("data-image"),(n=o.spriteImage,new Promise((function(e,t){var i=new Image;i.onload=e,i.onerror=t,i.src=n}))).then((function(e){var s=e.target,n=r.getAttribute("data-frames");if(n="auto"===n?Math.round(s.width/o.width):parseInt(n,10)||60,o.frames=function(e,t,i){var s,a,r,n,o=[];for(s=0;s<e;s++)if(a=-Math.round(s*i)+"px 0",t[s])for(r=t[s],n=0;n<r;n++)o.push(a);else o.push(a);return o}(n,m,o.width),o.mode===a){var h=t.parent(o.element,"js-hover-container");h&&h!==document&&(h.addEventListener("mouseover",o),h.addEventListener("mouseout",o),o.hoverElement=h)}else i.add(o.element,(function(e){e?o.play():o.pause()}))}),(function(t){throw e.clob("error",o.spriteImage,"prefetch","sprite"),t}))},setSpriteImage:function(){r(this.element,this.spriteImage)},setPreviewImage:function(){r(this.element,this.previewImage)},deactivate:function(){this.stop(),this.hoverElement&&(this.hoverElement.removeEventListener("mouseover",this),this.hoverElement.removeEventListener("mouseout",this)),this.mode!==a&&i.remove(this.element)},handleEvent:function(e){"mouseout"===e.type?this.pause():"mouseover"===e.type&&this.play()},play:function(){this.setSpriteImage(),this.frameID||(this.isPaused=!1,this.frameID=requestAnimationFrame(this.bindedRender))},pause:function(){this.isPaused||(cancelAnimationFrame(this.frameID),this.frameID=0,this.lastFrameTime=0,this.isPaused=!0)},stop:function(){this.pause(),this.setPreviewImage(),this.active=0},render:function(){this.frameID=requestAnimationFrame(this.bindedRender);var e=Date.now();this.fps<60&&this.lastFrameTime&&this.lastFrameTime+this.frameDuration>e||(this.lastFrameTime=e,this.tick(),this.bgPos=this.frames[this.active],this.bgPos!==this.lastPos&&(this.element.style.backgroundPosition=this.lastPos=this.bgPos))},tick:function(){if(this.active++,this.active>=this.frames.length){var e=this.replayDelay,t=this;0!==e&&(this.pause(),setTimeout((function(){t.play()}),e)),this.active=0}}},n}));