define(["jquery","OK/logger","OK/utils/utils","OK/utils/dom","OK/OhManager","OK/utils/vanilla"],(function(e,t,o,a,n,r){"use strict";var i;OK.onload.addCallback((function(){i=!0}));var s,c,l,d,u,f,v,g=null,h=null,_="mtLayer",p="mtLayerMain",m="mtLayerBack",y="mtLayerForward",w="scrollToTopMtLayer",O="media-layer js-viewport-container",C="media-layer_hld",K="mlr_disc",k="media-layer_close",T="media-layer_close_ovr",L="sticky-plank_cnt",M="media-layer_fixer",b="js_mediaLayerActions",A=310,B=null,I=null,H=null,P=null,E=null,S=null,R=null,x=null,D=null,j=1145,N={id:null,to:75},q="MediaTopicLayerBody",J="MediaTopicLayerAd",W="AnonymMediaTopicLayerAd",F="layer__disabled",U="invisible",V="data-banner-seq-show-count",G=!1,z=!1,$=o.deferred();function Q(e,t){var o,a=document.getElementById(e);if(!a)return!1;for(o=0;o<t.length;o+=1)if(a.classList.contains(t[o]))return!1;return!0}function X(){return s.isActive&&!e("#hook_Block_PopLayerMediaTopic").hasClass(F)}function Y(e){if(X()){if(z||B[0]===document.activeElement||0!==B.find(document.activeElement).length||(B.focus(),z=!0),B.hasClass("__edit")||B.find(".__edit").length>0)return;if(B.find(".tag-box__editable").length>0)return;if(Q("hook_Modal_popLayerModal",[F]))return;if(Q("photoLayerWrapper",[F,U]))return;if(Q("video-poplayer-cnt",[F,U]))return;39===e.keyCode&&x?(x.click(),OK.stop(e)):37===e.keyCode&&R&&(R.click(),OK.stop(e))}}function Z(e){e?OK.Layers.register(_,(function(){ye("cr_esc")}),void 0,!1,Y):OK.Layers.remove(_)}function ee(e,t){OK.loader.use("OKCustomJs",(function(){e&&Z(t),t?OK.Layers.onLayerShown&&OK.Layers.onLayerShown():OK.Layers.onLayerHidden&&OK.Layers.onLayerHidden()}))}function te(){var e=O;s.market&&""==s.pfMode?e+=" product-layer":e+=" media-layer__topic",s.modernLayer&&(e+=" __modern"),s.v2&&(e+=" __v2"),s.pfJs&&(e+=" __posting"),s.isActive&&(e+=" __active"),s.isProcess&&(e+=" __process"),"N"==s.pfMode&&(e+=" __create"),"E"==s.pfMode&&(e+=" __edit"),s.hasActiveTopics&&(e+=" __has-topics"),s.arrowsHidden&&(e+=" __hide-arrows"),s.hasBanner&&(e+=" __has-banner"),s.fixClosing&&(e+=" __new-closing"),B[0].className=e}function oe(){ee(!0,s.isActive),n.switchLayer(!!s.isActive),te();var e=be();if(e){var t=document.getElementById(e+"Config");if(t){var o=t.getAttribute("data-slot");s.isActive?(B.attr(V,0),require(["OK/banners/BannerLoader"],(function(e){d=e.subscribeToEvents(o,{onAdsSuccess:ae,onNoAds:ne,onScriptError:ne,onHideBanner:ne})}))):(d&&"function"==typeof d.remove&&d.remove(),re(e),de(!1))}}}function ae(e){de(!0)}function ne(e){de(!1)}function re(e){var t=document.getElementById(e+"Wrapper");t&&(t.innerHTML="")}function ie(e){var t=parseInt(B.attr(e),10);return isNaN(t)&&(t=0),t}function se(t){var o=s.isActive!==t;s.isActive=t,o?oe():s.isActive&&e("#hook_Block_PopLayerMediaTopic").hasClass(F)&&ee(!1,!0),document.getElementById("hook_Block_PopLayerMediaTopic").classList.remove(F)}function ce(e){var t=s.isProcess!==e;s.isProcess=e,t&&te()}function le(e){var t=s.pfMode!==e;s.pfMode=e,t&&te()}function de(e){if(s){var t=s.hasBanner!==e;s.hasBanner=e,t&&te(),B.attr(V,e?1:0)}}function ue(e){I.toggleClass("__process",e)}function fe(e,t){for(var o=e.length,a=o;1+--o;)e[o].toggleClass(t);setTimeout((function(){for(;1+--a;)e[a].toggleClass(t)}),1)}function ve(){if(P){var t=0;e(".comments_i",P).each((function(){var o=e(this).data("unread");return o&&(t=this.getBoundingClientRect().top),!o})),B.each((function(){this.scrollTop=0!==t?this.scrollTop+t:this.scrollHeight})),setTimeout((function(){e(".js-comments_add",P).focus()}),50)}}function ge(t,o,a){var n=e(window),r=n.height(),i=n.width();N.id&&clearTimeout(N.id),N.id=setTimeout((function(){fe([E,x,R,D],M),N.id=null}),t?0:N.to),B.toggleClass("__compact",i<=j),B.toggleClass("__min-height",r<A),o&&ve(),a&&function(e){if(e){var t=B.find("[data-scroll-to='"+e+"']");if(t.length>0){for(var o=t[0],a=o.offsetTop,n=o.offsetParent;n&&1===n.nodeType&&n!==B[0];)a+=n.offsetTop,n=n.offsetParent;var r=B,i=r.height(),s=r.scrollTop(),c=i;s+i<=a+c?r.scrollTop(a+c-i-5):s>a&&r.scrollTop(a-5)}}}(a)}function he(t){if(!G){G=!0,g=e(window),h=e(document.body),B=e("#"+_),I=e("#"+p),R=e("#"+m),x=e("#"+y),D=e("#"+w);var o="1"===B.attr("data-fix-closing");s={fixClosing:o,isActive:B.hasClass("__active"),isProcess:B.hasClass("__process"),pfMode:B.hasClass("__edit")?"E":B.hasClass("__create")?"N":"",pfJs:B.hasClass("__posting"),modernLayer:B.hasClass("__modern"),v2:B.hasClass("__v2"),hasActiveTopics:B.hasClass("__has-topics"),hasBanner:B.hasClass("__has-banner"),arrowsHidden:B.hasClass("__hide-arrows")},H=B.find("."+C),E=H.find("."+k),S=B.find("."+T),o?B.on("click",(function(e){a.parent(e.target,"js-mlr-block",!1,!0)||ye("cr_shadow")})):S.on("click",(function(e){ye("cr_shadow")})),E.on("click",(function(e){ye("cr_close")})),s.isActive&&(oe(),s.isProcess||ge(!0,t)),t&&ve(),g.on("resize.mtLayer",(function(){ge()})),$.resolve(B)}}function _e(t){if(OK.historyManager.isHistorySupported()){var o=t.indexOf("?");o>0?(v=t.substr(o+1),f=t.substr(0,o),f=decodeURIComponent(f),v.length>0?v+="&mt.scrollTop="+e(window).scrollTop():v=null,r=f,null!=(i=v)&&0!=i.length&&OK.historyManager.putItemToCache(r,i)):(f=t,v=null);var a,n=pe()==f&&!l;u?a=!s.closeTopicId:(n?a=!0:l&&me(l,!0),u=pe()),l="",n||me(f,a)}var r,i}function pe(){return OK.historyManager.getState()}function me(e,t){t?OK.historyManager.replaceState(e):OK.historyManager.pushState(e)}function ye(e,t){if("cr_shadow"!=e||""==s.pfMode){if(""!=s.pfMode&&!t&&("cr_esc"===e||"cr_close"===e)){var o=B.find(".posting");if(o.length>0){var a=o[0].okPosting;if(a)return void(a.needConfirmBeforeClose()?a.showCloseConfirmDialog():a.closeWithoutConfirmDialog())}}z=!1,s.topicId=null,s.owner=null;var n=s.closeTopicId,r=s.closeOwnerType;if(s.closeTopicId=null,s.closeOwnerType=null,n&&("cr_esc"===e||"cr_shadow"===e||"cr_close"===e||"cr_fail"===e))return e&&we(e+"_ct"),void setTimeout((function(){OK.historyManager.isHistorySupported()?OK.historyManager.back():Ae(n,r,"")}),0);var i=!1;X()&&u&&f==pe()&&(u==f?(i=!0,OK.historyManager.back()):me(u,!0)),i||(se(!1),ce(!1),le(""),ue(!1),Oe(),Ce(),D.removeClass("__active __animated"),OK.hookModel.setHookContent(q,"")),u=null,e&&we(e),B.trigger("mtLayer.close")}}function we(e){t.success("mtlayer",c||"",e)}function Oe(){R.removeClass("__active"),x.removeClass("__active")}function Ce(){var e=h,t=e.find(".gwt-shortcutMenu__show");t.length&&t.removeClass("gwt-shortcutMenu__show");var o=e.find(".sc-menu:not(.sc-menu__hidden,.poll_ans_cnt)");o.length&&(o=o.not("#ownProfileLSMnu")).addClass("sc-menu__hidden")}var Ke=[0,1,2,3,5,8,13,21,34,55,89,144,233,377,610];function ke(e,t){var o,a=(t-e)/100;for(o=1;o<Ke.length&&!(a<Ke[o]);o++);return Ke[o-1]+"00"}function Te(){B&&B.scrollTop(0)}function Le(e){s.isProcess?ce(!1):ue(!1),e&&e()}function Me(t,o,a,n,r){l=o,he(a);var i=e("#"+q);s.market="true"==i.attr("data-market"),s.advertSelectionId=i.attr("data-adv-sel-id"),s.modernLayer="true"===i.attr("data-modernLayer"),s.v2="true"===i.attr("data-v2");var c=i.attr("data-log");c&&we(c);var d=i.attr("data-pf-mode");le(d||!1),function(e){var t=s.pfJs!==e;s.pfJs=e,t&&te()}("true"===i.attr("data-pf-js"));var g,h,_,p,m=i.attr("data-url");if(m?_e(m):(u||f!=pe()||me(u,!0),u=null,f=null,v=null),s.closeTopicId||n);else{var y=i.attr("data-back-id");_=y,p=t,R&&(R.toggleClass("__active",!!_&&!!p),R.unbind("click.back").bind("click.back",(function(e){if(R.hasClass("__active")){var t=x.hasClass("__active");Ae(_,p,"MT_GoBack_"+p,!1,"","BACK",t)}OK.stop(e)})));var w=i.attr("data-forward-id");g=w,h=t,x&&(x.toggleClass("__active",!!g&&!!h),x.unbind("click.forward").bind("click.forward",(function(e){if(x.hasClass("__active")){var t=R.hasClass("__active");Ae(g,h,"MT_GoForward_"+h,!1,"","FORWARD",t)}OK.stop(e)})))}var O=i.attr("data-id");O&&(s.topicId=O,s.owner=t);var C=i.attr("data-log-click");C?B.attr("data-l",C):B.removeAttr("data-l");var k=H.find("."+b);if(k.length>0){var T=function(t){var o=t.delegateTarget.getAttribute("data-url"),a=t.delegateTarget.getAttribute("uid");o&&(a?e.ajax({type:"POST",url:o,data:{"gwt.requested":window.pageCtx.gwtHash},headers:{TKN:OK.tkn.get()}}).done((function(e,t,o){k.children().unbind("click.advert"),Be("PLAdvertStatusBackToView",(function(){H.find("."+b).children().bind("click.advert",T)}))})):window.navigateOnUrlFromJS(o));OK.stop(t)};k.children().bind("click.advert",T)}s.isProcess||te(),Le(r),fe([x,R,D],M),Te(),P=H.find("."+K),H.find("."+L),ge(!0,a,i.attr("data-scroll-to-marker"))}function be(){return document.getElementById("hook_Block_"+J)?J:document.getElementById("hook_Block_"+W)?W:null}function Ae(o,a,n,d,u,f,v,g,h,p,m,y){he(d);var w,O=Date.now(),C=-1,K=-1;function k(e){var o=Date.now(),a="";if(e&&(a+="r_"),we((a+=f?"dt":"ot")+ke(O,o)),w&&we("js_"+a+ke(w,o)),s.pfMode){var n=o-O,r=C-O,l=K-C,d=o-K,u=c||"",v=OK.getCurrentDesktopModelId&&OK.getCurrentDesktopModelId(),g=(s.pfJs?"js.":"gwt.")+(i?"f.":"p.")+(v||"");if(n>0){var h=window.__gwtStatsEventsLog;if(h&&h.bootstrap&&h.bootstrap.begin){var _=O-h.bootstrap.begin,p=Math.floor(_/1e3),m=Math.floor(p/60),y=Math.floor(m/60);g+=y>0?".h"+y:m>=20?".m"+20*Math.floor(m/20):m>=10?".m10":m>=5?".m5":3>=m&&m>0?".m"+m:p>=20?".s"+20*Math.floor(p/20):".s"+10*Math.floor(p/10),t.duration("mtlayer",_,"start."+u+"."+s.pfMode,g)}t.duration("mtlayer",n,u+"."+s.pfMode,g),r>0&&(t.duration("mtlayer",r,"net."+u+"."+s.pfMode,g),t.duration("mtlayer",l,"act."+u+"."+s.pfMode,g),t.duration("mtlayer",d,"bnr."+u+"."+s.pfMode,g))}else t.duration("mtlayer",o-O,u+"."+s.pfMode,g+"_wtf")}}f||(s.closeTopicId=null,s.closeOwnerType=null),n&&-1!==n.indexOf("st.mt.or=on")&&(h=s.topicId,p=s.owner),OK.photoLayer&&OK.photoLayer.close(),OK.VideoPlayer.pauseAll(),require.defined("OK/dailyphoto-model")&&require(["OK/dailyphoto-model"],(function(e){e.togglePlayer&&e.togglePlayer(!1)})),OK.loader.use("OKCustomJs",(function(){var e=OK.Layers.stack;!(e&&e.length>0&&e[e.length-1].id===_)&&s.isActive&&Z(!0)})),c=a,(l=u)&&we("shortlink"),Oe(),s.isActive&&!s.isProcess?(ue(!0),Ce()):ce(!0),se(!0);var T=OK.getCurrentStateLink();T=(T+=-1===T.indexOf("?")?"?":"&").replace(/st\.mt\.(id|ot|bi|dir|hn|c7).*?(&|$)/g,""),T+="cmd="+q,n&&(T+="&st._aid="+n);var L=function(e){var t=be();if(!(t&&s.isActive))return!1;if(e){var o=document.getElementById(t+"Config");if(o){var a=o.getAttribute("data-everyNDisplay");if(a){var n=ie(V);return 0===n||n%a==0}}}return!0}(!!f),M={"gwt.requested":window.pageCtx.gwtHash,"st.mt.id":o,"st.mt.ot":a,"st.mt.dir":f,"st.mt.wc":g?"on":"off","st.mt.hn":m?"on":"off","st.mt.ad":L?"on":"off","st.mt.bi":y||0,"st.mt.as":s.advertSelectionId},b=e.ajax({type:"POST",url:T,data:M,headers:{TKN:OK.tkn.get()}});return b.done((function(e,t,o){w=Date.now(),h&&(s.closeTopicId=h,s.closeOwnerType=p);var n,i=o.getResponseHeader("Redirect-Location");if(i){var c=function(e){OK.navigation.redirect&&OK.navigation.redirect(i),0===e||OK.navigation.redirect?(ye(),k()):setTimeout((function(){c(e-1)}),200)};c(5)}else{if("yes"===o.getResponseHeader("End-Reached"))return"FORWARD"===f?v&&R.toggleClass("__active",!0):"BACK"==f&&v&&x.toggleClass("__active",!0),void Le(k);C=Date.now();for(var u,g=e.split(OK.navigation.SPLITER),_=o.getResponseHeader(OK.navigation.HEADER).split(","),y=0;y<g.length;y++){var O=_[y];if(O){var T=g[y];OK.hookModel.setHookContent(O,T),O!==J&&O!==W||(u=T)}}K=Date.now(),function(e,t){if(e){var o=document.createElement("div");o.innerHTML=e,0===o.getElementsByClassName("media-layer_ads").length&&de(!1)}else{"true"===document.getElementById(q).getAttribute("data-hide-ad")?(re(be()),de(!1)):t&&s.hasBanner&&(n=ie(a=V),B.attr(a,n+1))}var a,n}(u,f),Me(a,l,d,m,k)}(n=document.querySelector(".js-mediatopic-widget"))&&r.trigger(n,"refreshMediatopicWidget")})),b.fail((function(){ye("cr_fail"),k()})),b}function Be(t,o){function a(){o&&o()}if(s&&s.topicId&&s.owner){var n=OK.getCurrentStateLink();n+=-1===n.indexOf("?")?"?":"&",n+="cmd="+q+"&st._aid="+t;var r=e.ajax({type:"POST",url:n,data:{"gwt.requested":window.pageCtx.gwtHash,"st.mt.id":s.topicId,"st.mt.ot":s.owner},headers:{TKN:OK.tkn.get()}});r.done((function(e,t,o){var n=o.getResponseHeader("Redirect-Location");if(n)OK.navigation.redirect&&OK.navigation.redirect(n),ye();else for(var r=e.split(OK.navigation.SPLITER),i=o.getResponseHeader(OK.navigation.HEADER).split(","),s=0;s<r.length;s++)i[s]&&OK.hookModel.setHookContent(i[s],r[s]);a()})),r.fail(a)}else a()}return{show:function(){he(),se(!0),Te()},showPreloaded:Me,showTopicInLayer:Ae,closeLayer:function(e,t){G&&ye(e,t)},hideLayer:function(){z=!1,s&&s.isActive&&(u&&pe()==f&&me(u,!0),ee(!1,!1))},restoreLayer:function(){s&&s.isActive&&(fe([E,x,R,D],M),u&&pe()!==f&&me(f,!0),ee(!1,!0))},refreshLayerBody:function(e){Be("PLPhotoUserBackToView",e)},deactivate:function(){e(window).off(".mtLayer"),E&&E.off(),S&&S.off(),se(!1)},updateActiveTopics:function(e,t,o){$.promise.then((function(a){s.hasActiveTopics=t,s.arrowsHidden=o;var n=e.getHeight(),r=I.outerHeight(!0);t?r<n?I.css("min-height",n):r-n<100&&e.setHeight(r):I.css("min-height",""),te()}))}}}));