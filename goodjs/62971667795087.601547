define("lofty/alicn/suggestion/3.0/history",["lofty/lang/observer","lofty/util/storage/2.0/storage","jquery"],function(e,o,y){function u(e){return String(e).replace(/[&<>"'\/]/g,function(e){return t[e]})}function i(){m.setJson("historyKeys",f),m.setItem("historyModify",+new Date),k.sycnToStorage()}function a(){f=(f=m.getJson("historyKeys"))||{objKeyItems:{},historyItems:[]},isNaN(c)&&(c=0)}function n(s){if(50<=f.length&&function(e){for(var t,s=e;s--;)t=f.historyItems.shift(),delete f.objKeyItems[t.key];r()}(),s.key in f.objKeyItems)y.isPlainObject(f.historyItems[f.objKeyItems[s.key]])&&f.historyItems[f.objKeyItems[s.key]].key===s.key||y.each(f.historyItems,function(e,t){y.isPlainObject(t)&&t.key===s.key&&(f.objKeyItems[s.key]=e)}),f.historyItems.push(f.historyItems.splice(f.objKeyItems[s.key],1)[0]),r(f.objKeyItems[s.key]),i();else{if(!s.value)return!1;f.historyItems.push(s),f.objKeyItems[s.key]=f.historyItems.length-1,i()}}function r(e){for(var t=e=e||0;t<f.historyItems.length;t++)y.isPlainObject(f.historyItems[t])&&(f.objKeyItems[f.historyItems[t].key]=t)}var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},s={};y.each(t,function(e,t){s[t]=e});var f,c,m,l,h=!1,I=!1,g=!1,k={loaded:!1,init:function(){if(!h){h=!0;var e=this;m=new o,l=new o({crossDomain:!0});function t(){2===s&&e.sycnFromStorage(function(){I=!0,e.loaded=!0,a(),e.trigger("ready")})}var s=0;if(!m.isSupport())return!1;l.ready(function(){s++,t()}),m.ready(function(){s++,t()})}},sycnToStorage:function(){l.setItem("historyKeys",m.getItem("historyKeys")),l.setItem("historyModify",m.getItem("historyModify"))},sycnFromStorage:function(t){var s,o;l.getItem("historyKeys",function(e){s=e.data,l.getItem("historyModify",function(e){o=e.data,m.setItem("historyKeys",s),m.setItem("historyModify",o),t&&t()})})},enableHtmlEscape:function(e){g=!!e},escapeHtml:u,unescapeHtml:function(e){return String(e).replace(/&amp;|&lt;|&gt;|&quot;|&#39;|&#x2F;/g,function(e){return s[e]})},query:function(e,t){if(!I)return!1;t=t||10;parseInt(m.getItem("historyModify"),10);a();var s,o=f.historyItems,i=[];if(!o)return[];if(e)for(var n=o.length;n--;){var r=o[n];if(y.isPlainObject(r)&&(0!==r.key.indexOf(e)&&0!==r.value.indexOf(e)||((s={}).key=r.key,s.value=r.value,s.htmlKey=s.key,g&&(s.key=u(s.key)),i.push(s)),i.length>=t))break}else for(n=o.length;n--&&!(y.isPlainObject(o[n])&&(s={},o[n].key&&(s.key=o[n].key,s.value=o[n].value,s.htmlKey=s.key,g&&(s.key=u(s.key)),i.push(s)),i.length>=t)););return i},remove:function(e){if(!I)return!1;var t=parseInt(f.objKeyItems[e]),s=f.historyItems;if(isNaN(t))return!1;if(void 0===s[t]||s[t].key!==e){for(;--t>=s.length;);if(s[t].key!==e)return!1}return s.splice(t,1),r(0),delete f.objKeyItems[e],i(),!0},add:function(t){return!(!I||!t)&&void(t in f.objKeyItems?n({key:t}):(s=function(e){n({key:t,value:e})},y.ajax({url:"//suggest.1688.com/bin/suggest",dataType:"script",data:"type=pinyin&q="+t.replace(/%/g,"%25").replace(/&/g,"%26"),success:function(){var e=window._suggest_result_.result;e&&(e="string"==typeof e[0]?e[0]:e[0].q,"function"==typeof s&&s(e))}})));var s},clear:function(){return!!I&&(m.removeItem("historyKeys"),m.removeItem("historyModify"),f={objKeyItems:{},historyItems:[]},void this.sycnToStorage())}};return e.mixTo(k),k});
