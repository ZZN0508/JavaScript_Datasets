!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("wafer-module",[],t):"object"==typeof exports?exports["wafer-module"]=t():(e.wafer=e.wafer||{},e.wafer.wafers=e.wafer.wafers||{},e.wafer.wafers["wafer-module"]=t())}("undefined"!=typeof self?self:this,function(){return function(e){function t(r){if(a[r])return a[r].exports;var n=a[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var a={};return t.m=e,t.c=a,t.d=function(e,a,r){t.o(e,a)||Object.defineProperty(e,a,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var a=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(a,"a",a),a},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="https://s.yimg.com/aaq/wf/",t(t.s="./src/entry.js")}({"./src/base.js":function(e,t,a){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},l=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),s=function e(t,a,r){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,a);if(void 0===n){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,a,r)}if("value"in n)return n.value;var i=n.get;if(void 0!==i)return i.call(r)},d=[],c=window.wafer,u=c.base,f=c.constants,m=c.utils,g=c.WaferBaseClass,v=m.convertNodeListToArray,p=m.findAncestor,h=m.getConfigFromJSONScriptNode,y=m.getTemplateContent,_=m.setTimeout,E=m.throttle,b=f.ATTR_PREFIX,w=["handleAdd","handleDrag","handleDragEnd","handleDragEnter","handleDragIndicatorFocusIn","handleDragLeave","handleDragOver","handleDragStart","handleDrop","handleKeyDown","handleMouseEnter","handleMouseleave","handleMoveDown","handleMoveToColumn","handleMoveUp","handleRemove"],D="wafer-module-drag-indicator",M=document.body,C=function(e){function t(e){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=a.selector,l=a.successClass;r(this,t);var s=n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,{selector:o},{STATE_ATTRS:d})),c=e.getAttribute(b+"module-id"),f=e.getAttribute(b+"module-remove-delay")||"1000",m=e.getAttribute(b+"module-drag-image-elem"),g=e.getAttribute(b+"module-remove-self-on-delete"),v="true"===e.getAttribute("draggable"),p=h(e.getElementsByClassName("wafer-module-config")[0]),y=e.getElementsByClassName(D)[0],M=void 0;if(m&&(M=e.getElementsByClassName(m)[0]),w.forEach(function(e){s[e]=s[e].bind(s)}),s._util=i({},s._util,{config:p,contextMenuActiveIndex:0,contextMenuButtons:null,delay:f,dragElement:y,dragImageElem:M,elem:e,id:c,isDraggable:v,removeSelfOnDelete:null===g||void 0===g?1:Number(g),successClass:l}),s._state=s._state||{},v){var C=e.getAttribute(b+"module-drag-mouseenter-timeout")||100;s.addEventListeners(),s._util.dragMouseEnterTimeout=C,s._state=i({},s._state,{dragElem:null,dragProxy:null,focusDragElem:null,focusMenuElem:null,hoverTimeout:null,scrollStop:!0})}return e.classList.add(l),s.handleDragOver=E(s.handleDragOver,100),_(function(){s.addInstanceToIdMap(s),u.emitWaferEvent("module:added",{elem:e,meta:{id:c}})},s,0),s}return o(t,e),l(t,[{key:"removeDragDropOverCueFromAll",value:function(){var e=this._state.dragProxy;if(e){var t=e.parentNode;t&&t.removeChild(e)}v(document.getElementsByClassName("wafer-module-drop-over")).forEach(function(e){e.classList.remove("wafer-module-drop-over")})}},{key:"focus",value:function(){var e=this._util.dragElement;e&&_(function(){e.focus()},50,this)}},{key:"destroy",value:function(){var e,a=this._util,r=a.elem,n=a.id,o=a.isDraggable;u.emitWaferEvent("module:destroyed",{elem:r,meta:{id:n}}),o&&this.removeEventListeners();for(var i=arguments.length,l=Array(i),d=0;d<i;d++)l[d]=arguments[d];(e=s(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this)).call.apply(e,[this].concat(l))}},{key:"_closeContextMenu",value:function(){var e=this;_(function(){var t=e._state.focusMenuElem;t&&t.parentNode.removeChild(t),e._state.focusMenuElem=null,e._state.focusDragElem=null,e._state.contextMenuButtons=null},5,this)}},{key:"_pageScroll",value:function(e){var t=this,a=window.scrollY;window.scrollTo({top:a+e}),this._state.scrollStop||_(function(){t._pageScroll(e)},20,this)}},{key:"handleRemove",value:function(){var e=this,t=this._util,a=t.elem,r=t.delay,n=t.removeSelfOnDelete;a.classList.add("wafer-module-delete-in-progress"),_(function(){n&&(u.destroy(a),e.destroy(),a.parentNode.removeChild(a)),a.classList.remove("wafer-module-delete-in-progress")},r,this),this.didRemove(a)}},{key:"handleDrag",value:function(e){e.stopPropagation();var t=this._util.elem;this._state.scrollStop=!0,t.classList.add("wafer-module-drag-in-progress"),M.classList.add("wafer-module-drag-in-progress"),this.setDragElem(e.currentTarget),e.clientY<150&&(this._state.scrollStop=!1,this._pageScroll(-1))}},{key:"handleDragEnter",value:function(e){var t=e.currentTarget;this.getDragElem()!==t&&(this.removeDragDropOverCueFromAll(),t.classList.add("wafer-module-drop-over"))}},{key:"handleDragLeave",value:function(e){var t=e.clientX,a=e.clientY,r=e.currentTarget,n=r.parentNode.getBoundingClientRect();if(a<n.top||a>=n.bottom||t<n.left||t>=n.right){if(this.getDragElem()===r)return;r.classList.remove("wafer-module-drop-over")}}},{key:"handleDragEnd",value:function(e){var t=this._util.elem;this._state.scrollStop=!0,t.classList.remove("wafer-module-drag-in-progress"),M.classList.remove("wafer-module-drag-in-progress"),this.removeDragDropOverCueFromAll()}},{key:"handleDragOver",value:function(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}},{key:"handleDragStart",value:function(e){var t=this._util,a=t.dragImageElem,r=t.elem;if(e.dataTransfer.effectAllowed="move",a){var n=document.createElement("div");n.classList.add("wafer-module-drag-proxy"),n.appendChild(a.cloneNode(!0)),document.body.appendChild(n),n.style.width=r.offsetWidth+"px",e.dataTransfer.setDragImage(n,e.offsetX,n.offsetHeight/2),this._state.dragProxy=n}}},{key:"handleAdd",value:function(e){this._closeContextMenu(),this.handleAdd()}},{key:"handleMoveUp",value:function(e){this._closeContextMenu(),this._handleMoveUp(e)}},{key:"handleMoveDown",value:function(e){this._closeContextMenu(),this._handleMoveDown(e)}},{key:"handleMoveToColumn",value:function(e){this._closeContextMenu(),this._handleMoveToColumn(e)}},{key:"handleMouseEnter",value:function(){if(this._util.isDraggable){var e=this._util,t=e.elem,a=e.dragMouseEnterTimeout;this._state.hoverTimeout=_(function(){t.classList.add("wafer-module-drag-hover-enter")},a,this)}}},{key:"handleMouseleave",value:function(){var e=this._util,t=e.isDraggable,a=e.isDropOnly;if(t&&!a){var r=this._util.elem;clearTimeout(this._state.hoverTimeout,this),r.classList.remove("wafer-module-drag-hover-enter")}}},{key:"handleDragIndicatorFocusIn",value:function(e){this._state.focusDragElem=e.target}},{key:"handleKeyDown",value:function(e){var t=this._state.focusDragElem;if(t){var a=e.keyCode,r=e.target,n=r.classList,o=void 0;if(32===a&&n&&n.contains(D)){e.preventDefault();var i=p(this._util.elem,"wafer-module-drop-target");if(i){var l=y(i.getElementsByClassName("wafer-module-drag-context-menu")[0]);if(l){var s=document.createElement("div");s.classList.add("wafer-module-drag-options-context-menu"),this._state.focusMenuElem=s,s.innerHTML=l;t.parentNode.appendChild(s);var d=this._state.contextMenuButtons=s.getElementsByTagName("button");this._state.contextMenuActiveIndex=0,o=d[this._state.contextMenuActiveIndex],o&&_(function(){o.focus()},10,this)}}}else if(!this._state.contextMenuButtons)return;var c=this._state.contextMenuActiveIndex;38===a?(e.preventDefault(),0===c?this._state.contextMenuActiveIndex=this._state.contextMenuButtons.length-1:--this._state.contextMenuActiveIndex,o=this._state.contextMenuButtons[this._state.contextMenuActiveIndex]):40===a&&(e.preventDefault(),c>=this._state.contextMenuButtons.length-1?this._state.contextMenuActiveIndex=0:++this._state.contextMenuActiveIndex,o=this._state.contextMenuButtons[this._state.contextMenuActiveIndex]),o?_(function(){o.focus()},10,this):this._closeContextMenu()}}},{key:"handleClickOutside",value:function(e){var t=this._state.focusDragElem;(0,e.waferComposedMap)().get(t)||this._closeContextMenu()}},{key:"handleDrop",value:function(e){var t=this.getDragElem();if(e.stopPropagation(),t){var a=e.currentTarget;if("true"!==a.getAttribute("draggable"))return;a.previousElementSibling===t?(a.parentElement.insertBefore(a,t),this.didDrag({dragElem:a,dropElem:t})):(a.parentElement.insertBefore(t,a),this.didDrag({dragElem:t,dropElem:a}))}}},{key:"config",get:function(){var e=this._util,t=e.config;return{config:void 0===t?{}:t,elem:e.elem,id:e.id}}}]),t}(g);C.events={click:[["wafer-module-add","handleAdd"],["wafer-module-move-down","handleMoveDown"],["wafer-module-move-to-column","handleMoveToColumn"],["wafer-module-move-up","handleMoveUp"],["wafer-module-remove","handleRemove"]],drag:[["_self","handleDrag"]],dragend:[["_self","handleDragEnd"]],dragenter:[["_self","handleDragEnter"]],dragleave:[["_self","handleDragLeave"]],dragover:[["_self","handleDragOver"]],dragstart:[["_self","handleDragStart"]],drop:[["_self","handleDrop"]],focusin:[[D,"handleDragIndicatorFocusIn"]],keydown:[["_self","handleKeyDown"]],mouseenter:[[D,"handleMouseEnter"]],mouseleave:[[D,"handleMouseleave"]]},t.default=C,e.exports=t.default},"./src/controller.js":function(e,t,a){"use strict";function r(){return c=o(a("./src/base.js"))}function n(){return u=a("./src/utils.js")}function o(e){return e&&e.__esModule?e:{default:e}}function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function d(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var c,u,f=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},m=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),g=function e(t,a,r){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,a);if(void 0===n){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,a,r)}if("value"in n)return n.value;var i=n.get;if(void 0!==i)return i.call(r)},v=window.wafer,p=v.base,h=v.utils,y=h.bindEvent,_=h.convertNodeListToArray,E=h.fetchWithCache,b=h.findAncestor,w=h.getConfigFromJSONScriptNode,D=h.throttle,M=h.unbindEvent,C=window.wafer.controllers.WaferBaseController,A="wafer-module-drag-in-progress",O="wafer-module-drop-target",x="wafer-module-set-active",T="wafer-module-added",k="wafer-module-add-in-progress",N="wafer-module-error",L=document.body,I=void 0,B=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=e.root,o=void 0===a?document:a,i=e.selector,d=e.successClass,m=void 0===d?"wafer-module-complete":d;l(this,t);var g=w(document.getElementById("wafer-module-config")),v={};g.bodyErrorClass=g.bodyErrorClass||N;var h=g.bodyErrorClass,E=g.modulesAdded,M=void 0===E?[]:E,C=g.moveAriaMessage;M.forEach(function(e){v[e]=!0});var I=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,{root:o,selector:i,props:{selector:i,successClass:m},WaferClass:(c||r()).default})),B=I;I._util=f({},I._util,{moduleConfig:g}),I._state=f({},I._state,{activeElem:null,dragElem:null,dropTargetElementConfigMap:new Map,idInstanceMapping:new Map,lastTargetIndex:0,modulesAddedMap:v,proxyElem:null}),I.handleBodyDragover=I.handleBodyDragover.bind(I),I.handleBodyDrop=I.handleBodyDrop.bind(I),I.handleDragEnd=I.handleDragEnd.bind(I),I.handleDragLeave=D(I.handleDragLeave.bind(I)),y(document.body,"dragover",I.handleBodyDragover,{passive:!1}),y(document.body,"drop",I.handleBodyDrop),y(document.body,"dragend",I.handleDragEnd,{passive:!1}),y(document.body,"dragleave",I.handleDragLeave,{passive:!1});var S=g.enableSnapshotOnLoad,P=void 0===S||S;return(c||r()).default.prototype.addInstanceToIdMap=function(){var e=B._state.idInstanceMapping,t=this._util.id;e.has(t)||e.set(t,[]);var a=B._state.modulesAddedMap;e.get(t).push(this),a[t]&&e.get(t).forEach(function(e){if(!e._destroyed){e._util.elem.classList.add(T)}})},(c||r()).default.prototype.setDragElem=function(e){B._state.dragElem=e},(c||r()).default.prototype.getDragElem=function(){return B._state.dragElem},(c||r()).default.prototype.handleAdd=function(){var e=B._state.activeElem,t=!1;e||(t=!0,e=B.getActiveTarget());var a=b(e,"wafer-module"),r=b(e,O),o=this.config,i=o.config,l=o.id,s=this._util.elem;if(!s.classList.contains(k)){s.classList.add(k);var d=r&&r.getElementsByClassName("wafer-module"),c=0;if(a)c=_(a.parentNode.children).indexOf(a);else if(t)c=0;else{var m=d&&d.length||0;c=0===m?0:m+1}if(r){var g=B.getDropTargetConfig(r),y=f({},i,g);y.rank=c||0,this.focus(),B.handleInlineAddingModule(r,d,y.packageId||y.id||l,l,s,c,v,this).then(function(){var e=(0,(u||n()).getSnapshot)(y);B.triggerAction({packageData:e})}).catch(function(e){L.classList.add(h),s.classList.remove(k),p.emitError({name:"WaferModule",elem:s,meta:{type:"addModuleActionFailed"},stack:e.stack})})}}},(c||r()).default.prototype.didDrag=function(){var e=B._state.dragElem;if(e){e.classList.remove(A);var t=B._state.elementInstances,a=t.get(e)||{},r=a.instance;if(r){var o=this.config.elem,i=b(o,O);if(i){var l=B.getDropTargetConfig(i),s=r.config.config,d=e.parentNode.children,c=_(d).indexOf(e),m=f({},s,l,{rank:c}),g=s.name,v=l.name,y=(0,(u||n()).getSnapshot)(m);if(g&&v&&C){var E=C.replace("[NAME]",g).replace("[DROP_NAME]",v).replace("[DROP_ITEMS_COUNT]",d.length).replace("[RANK]",c+1);p.liveAriaRegion.innerHTML=E}this.focus(),B.triggerAction({packageData:y}).catch(function(e){L.classList.add(h),p.emitError({name:"WaferModule",elem:o,meta:{type:"dragdropModuleActionFailed"},stack:e.stack})}),p.emitWaferEvent("wafer:module:drop:complete",{elem:e,meta:{config:f({},s,l)}})}B._state.dragElem=null}}},(c||r()).default.prototype.didRemove=function(e){var t=B._state.idInstanceMapping,a=this._util,r=a.config,n=a.elem,o=a.id;if(v[o]&&t.has(o))for(var i=B._state.activeElem,l=t.get(o),s=l.length,d=b(i,"wafer-module"),c=s-1;c>=0;c--){var u=l[c];if(u._destroyed)t.get(o).splice(c,1);else{var f=u._util,m=f.elem,g=f.removeSelfOnDelete;if(g&&m!==e){if(d===m&&(B._state.activeElem=m.previousSibling,!B._state.activeElem)){var y=m.parentNode,_=y.getElementsByClassName(x);B._state.activeElem=_[_.length-1]}p.destroy(m),u.destroy(),m.parentNode.removeChild(m),t.get(o).splice(c,1)}m.classList.remove(T)}}v[o]=!1,B.triggerAction({removedPackages:[r.packageId||r.id||o]}).catch(function(e){L.classList.add(h),p.emitError({name:"WaferModule",elem:n,meta:{type:"removeModuleActionFailed"},stack:e.stack})}),r.removeMessage&&(p.liveAriaRegion.innerHTML=r.removeMessage),p.emitWaferEvent("wafer:module:deleted",{elem:n,meta:{config:{id:r.id||o}}})},(c||r()).default.prototype._handleMoveUp=function(){var e=this._util.elem,t=e.previousElementSibling;if(t){var a=this.config.config,r=a;e.parentNode.insertBefore(e,t);var o=(0,(u||n()).getSnapshot)(r),i=b(e,O),l=_(i.getElementsByClassName("wafer-module")).filter(function(e){return e.getAttribute("draggable")}),s=a.name,d=B.getDropTargetConfig(i),c=d.name,f=l.indexOf(e);if(s&&c&&C){var m=C.replace("[NAME]",s).replace("[DROP_NAME]",c).replace("[DROP_ITEMS_COUNT]",l.length).replace("[RANK]",f+1);p.liveAriaRegion.innerHTML=m}this.focus(),B.triggerAction({packageData:o}).catch(function(t){L.classList.add(h),p.emitError({name:"WaferModule",elem:e,meta:{type:"moveUpFailed"},stack:t.stack})}),p.emitWaferEvent("wafer:module:moveup:complete",{elem:e,meta:{config:a}})}},(c||r()).default.prototype._handleMoveDown=function(){var e=this._util.elem,t=b(e,O),a=_(t.getElementsByClassName("wafer-module")).filter(function(e){return e.getAttribute("draggable")}),r=a.indexOf(e),o=this.config.config,i=o;e.parentNode.insertBefore(a[r+1],e);var l=(0,(u||n()).getSnapshot)(i),s=_(t.getElementsByClassName("wafer-module")),d=o.name,c=B.getDropTargetConfig(t),f=c.name,m=s.indexOf(e);if(d&&f&&C){var g=C.replace("[NAME]",d).replace("[DROP_NAME]",f).replace("[DROP_ITEMS_COUNT]",s.length).replace("[RANK]",m+1);p.liveAriaRegion.innerHTML=g}this.focus(),B.triggerAction({packageData:l}).catch(function(t){L.classList.add(h),p.emitError({name:"WaferModule",elem:e,meta:{type:"moveDownFailed"},stack:t.stack})}),p.emitWaferEvent("wafer:module:movedown:complete",{elem:e,meta:{config:o}})},(c||r()).default.prototype._handleMoveToColumn=function(e){var t=e.target,a=this._util.elem,r=this.config.config,o=r,i=t.getAttribute("data-index");i=parseInt(i,10)||1;var l=document.getElementsByClassName(O)[i-1],s=l.getElementsByClassName("wafer-module")[0]||l.children[0];s&&l.insertBefore(a,s);var d=(0,(u||n()).getSnapshot)(o),c=b(a,O),f=_(c.getElementsByClassName("wafer-module")).filter(function(e){return e.getAttribute("draggable")}),m=r.name,g=B.getDropTargetConfig(c),v=g.name,y=f.indexOf(a);if(m&&v&&C){var E=C.replace("[NAME]",m).replace("[DROP_NAME]",v).replace("[DROP_ITEMS_COUNT]",f.length).replace("[RANK]",y+1);p.liveAriaRegion.innerHTML=E}this.focus(),B.triggerAction({packageData:d}).catch(function(e){L.classList.add(h),p.emitError({name:"WaferModule",elem:a,meta:{type:"moveUpFailed"},stack:e.stack})}),p.emitWaferEvent("wafer:module:moveacrosscolumns:complete",{elem:a,meta:{config:r}})},I.sync(),P&&setTimeout(function(){var e=(0,(u||n()).getSnapshot)();e.length&&I.triggerAction({packageData:e}).catch(function(e){})},100),I}return d(t,e),m(t,[{key:"handleInlineAddingModule",value:function(e,t,a,r,n,o,i,l){var s=this._util.moduleConfig,d=void 0===s?{}:s,c=d.addFetchUrl;return E((void 0===c?"/?p_id=MODULE_ID":c).replace(/MODULE_ID/,a),{cacheStrategy:"cacheFirst"}).then(function(a){var s=a.html,d=document.createElement("div"),c=t.length&&t[o];i[r]=!0,n.classList.remove(k),d.innerHTML=s;var u=d.children[0];if(c)e.insertBefore(u,t[o]);else{var f=e.children,m=o?f[f.length-1]:f[0];e.insertBefore(u,m)}if(p.sync(e),l){var g=l.config.config,v=void 0===g?{}:g,h=v.addMessage;l.focus(),h&&(p.liveAriaRegion.innerHTML=h)}}).catch(function(e){var t=d.bodyErrorClass;L.classList.add(t),i[r]=!1,n.classList.remove(k),p.emitError({name:"WaferModule",elem:n,meta:{type:"addModuleActionFailed"},stack:e.stack})})}},{key:"getActiveTarget",value:function(){var e=_(document.getElementsByClassName(O));return e.length?(this._state.lastTargetIndex>=e.length&&(this._state.lastTargetIndex=0),e[this._state.lastTargetIndex++]):null}},{key:"handleEvent",value:function(e,a,r){if(g(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"handleEvent",this).call(this,e,a,r),r&&"click"===r.type){var n=r.target;n.className&&n.classList.contains(x)&&(this._state.activeElem=n)}}},{key:"triggerAction",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=t.critical,r=void 0!==a&&a,n=this._util.moduleConfig,o=void 0===n?{}:n;return o.actionHost?this.getCrumb().then(function(t){if(!t)throw new Error("crumb not found");var a=o.actionHost,n=o.actionVersion,l=void 0===n?"v2":n,s=o.appId,d=o.experienceId,c=o.currentContainers,u=void 0===c?{}:c,m=o.propertyId,g=i({},m,{selectedContainer:d,containers:[f({id:d},e)],currentContainers:u}),v=a+"api/"+l+"/preferences/declared/common?appId="+s;return r&&(v+="&criticalWrite=true&criticalWriteTimeout=1200"),E(v,{cache:0,clientHeaders:{Crumb:t},credentials:"include",method:"PUT",body:JSON.stringify(g)})}):Promise.resolve()}},{key:"getDropTargetConfig",value:function(e){var t=this._state.dropTargetElementConfigMap,a=t.get(e);if(!a)try{a=JSON.parse(e.getAttribute("data-wf-module-drop-target-config")),t.set(e,a)}catch(e){}return a}},{key:"getCrumb",value:function(){var e=this._util.moduleConfig,t=void 0===e?{}:e,a=t.crumb||I;if(a)return Promise.resolve(a);var r=t.actionHost,n=t.appId;return E(r+"api/v1/auth/crumb?appId="+n,{cache:0,credentials:"include"}).then(function(e){if(!(I=e.crumb))throw new Error("crumb not found");return I})}},{key:"handleBodyDragover",value:function(e){var t=e.target;if(t.classList.contains(O)&&(e.preventDefault(),!this._state.proxyElem)){var a=document.createElement("div"),r=_(t.getElementsByClassName("wafer-module")),n=r.length;if(a.style.pointerEvents="none",a.classList.add("wafer-module-drop-proxy"),this._state.proxyElem=a,n){var o=r[n-1];t.insertBefore(a,o.nextSibling)}else t.insertBefore(a,t.children[0])}}},{key:"handleBodyDrop",value:function(e){var t=this._state.dragElem;if(t){var a=this._util.moduleConfig,r=void 0===a?{}:a,o=r.bodyErrorClass,i=r.moveAriaMessage,l=e.target;if(l.classList.contains(O)){var s=this._state,d=s.elementInstances,c=s.dropTargetElementConfigMap,m=d.get(t)||{},g=m.instance,v=c.get(l);if(!v)try{v=JSON.parse(l.getAttribute("data-wf-module-drop-target-config")),c.set(l,v)}catch(e){}var h=_(l.getElementsByClassName("wafer-module")).filter(function(e){return e.getAttribute("draggable")}),y=h.length,E=void 0;if(y){var b=h[y-1];E=y,l.insertBefore(t,b.nextSibling)}else E=0,l.insertBefore(t,l.children[0]);var w=g.config.config,D=f({},w,v),M=(0,(u||n()).getSnapshot)(D);this.triggerAction({packageData:M}).catch(function(e){L.classList.add(o),p.emitError({name:"WaferModule",elem:t,meta:{type:"actionFailed"},stack:e.stack})});var C=w.name,A=v,x=A.name;if(C&&x&&i){var T=i.replace("[NAME]",C).replace("[DROP_NAME]",x).replace("[DROP_ITEMS_COUNT]",y).replace("[RANK]",E+1);p.liveAriaRegion.innerHTML=T}p.emitWaferEvent("wafer:module:drop:complete",{elem:t,meta:{config:D}})}}}},{key:"handleDragLeave",value:function(e){var t=e.target,a=this._state.proxyElem;a&&t.classList.contains(O)&&(a.parentNode.removeChild(a),this._state.proxyElem=null)}},{key:"handleDragEnd",value:function(e){var t=this._state.proxyElem;if(t){var a=t.parentNode;a&&a.removeChild(t),this._state.proxyElem=null}}},{key:"destroy",value:function(e){g(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this,e),e||(M(document.body,"dragover",this.handleBodyDragover,{passive:!1}),M(document.body,"drop",this.handleBodyDrop),M(document.body,"dragend",this.handleDragEnd,{passive:!1}),M(document.body,"dragleave",this.handleDragLeave,{passive:!1}))}}]),t}(C);t.default=B,e.exports=t.default},"./src/entry.js":function(e,t,a){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var n;t.default=new((n||function(){return n=r(a("./src/controller.js"))}()).default)({selector:"wafer-module"}),e.exports=t.default},"./src/utils.js":function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=window.wafer.utils,n=r.convertNodeListToArray,o=r.getWaferInstanceForElem,i={},l=n(document.getElementsByClassName("wafer-module-drop-target")),s=l.map(function(e){var t=e.getAttribute("data-wf-module-drop-target-config");try{t=JSON.parse(t)}catch(e){}return t=t||{},{elem:e,regionId:t.regionId}});t.getSnapshot=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=[],a=e.packageId;return a&&(i[a]=!0),s.forEach(function(e){var a=e.elem,r=e.regionId;n(a.getElementsByClassName("wafer-module")).forEach(function(e,a){var n=o(e,"wafer-module"),l=n.instance,s=void 0===l?{}:l,d=s.config||{},c=d.config,u=c||{},f=u.id,m=u.pin,g=void 0!==m&&m,v=c||{},p=v.packageId;(p=p||f)&&t.push({id:p,pin:i[p]||g,rank:a,regionId:r})})}),t}}})});