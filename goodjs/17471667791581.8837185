embedded_svc.defineFeature("LiveAgent",function(d){function n(e,t){this.name=e,this.data=t}function e(e){this.liveAgentAPI=e,this.running=!1,this.pingScript=this.pingTimeoutTimer=void 0,this.sid=d.getCookie("liveagent_sid")}function t(){this.createElements(),this.registerMessageHandlers()}function i(){this.visitCount=0,this.originalReferrer=void 0,this.pages=[]}function s(){this.connection=new e(this),this.fileTransfer=new t,this.visitorInfo=new i,this.browserSessionInfo={},this.INVITATIONS_CONTAINER_ID="esw-invite-container",this.inviteButton={},this.hasInvitationsLoaded=!1,d.setDefaultButtonText("LiveAgent","Chat with an Expert","Agent Offline","Live chat:"),d.addDefaultSetting("avatarImgURL",""),d.addDefaultSetting("prechatBackgroundImgURL",""),d.addDefaultSetting("waitingStateBackgroundImgURL",""),d.addDefaultSetting("smallCompanyLogoImgURL",""),d.addDefaultSetting("headerBackgroundURL",""),d.addDefaultSetting("extraPrechatInfo",[]),d.addDefaultSetting("extraPrechatFormDetails",[]),d.addDefaultSetting("agentAvailableOnButtonClick",!1),d.settings.isOfflineSupportEnabled&&(d.settings.offlineSupportMinimizedText=d.settings.offlineSupportMinimizedText||"Contact Us"),d.addMessageHandler("liveagent.chatCanceledOnDifferentTab",function(){d.fireEvent("liveagent.chatCanceledOnDifferentTab")}),d.addEventHandler("error",this.disconnect.bind(this)),d.addEventHandler("sessionDataRetrieved",function(e){return r=embedded_svc.liveAgentAPI.constructChatSettingsEndpointURL(),e.CHASITOR_SERIALIZED_KEY?(d.settings.agentAvailableOnButtonClick=!0,this.ping()):(embedded_svc.menu||embedded_svc.settings.disableDeploymentDataPrefetch||embedded_svc.liveAgentAPI.getChatSettings(),d.loadFeatureScript("Invite",function(){embedded_svc.liveAgentAPI.getButtonSettings(),document.querySelector("style#inert-style")||d.loadScriptFromDirectory("utils","inert")})),this.visitorInfo.initialize(e),!!e.CHASITOR_SERIALIZED_KEY}.bind(this)),d.addEventHandler("beforeCreate",function(){d.settings.visitorInfo=this.visitorInfo.getInfo()}.bind(this)),d.addEventHandler("validateInit",function(e){if("string"!=typeof e.baseLiveAgentURL)throw Error("Invalid Live Agent chat URL: "+e.baseLiveAgentURL);if("string"!=typeof e.baseLiveAgentContentURL)throw Error("Invalid Live Agent content URL: "+e.baseLiveAgentContentURL);if(!this.isButtonId(e.buttonId))throw Error("Invalid ButtonId Parameter Value: "+e.buttonId);if(!this.isDeploymentId(e.deploymentId))throw Error("Invalid DeploymentId Parameter Value: "+e.deploymentId);return!0}.bind(this)),d.loadStorageScript("Chasitor"),d.registerStorageKeys("CHASITOR_SERIALIZED_KEY LA_ESW_CHAT_SCROLL_POSITION LA_ESW_UNSEEN_MESSAGES LA_ESW_SHOW_QUEUE_POSITION LA_VISITOR_INFO LA_ESW_FILE_TOKEN LA_ESW_FILE_UPLOAD_SERVLET_URL CHATBOT_FOOTER_MENU PRECHAT_FORM_DETAILS PRECHAT_ENTITIES".split(" ")),"LiveAgent"===d.settings.entryFeature&&this.updateButton()}function o(e){var t=String(e.inviteRules);if(void 0===window.JSON)throw embedded_svc.utils.error("Browser does not support JSON.parse"),Error("Error during JSON.parse");var n=window.JSON.parse(t);(t=document.getElementById("snapins_invite"))&&d.inviteAPI&&"Custom"!==e.inviteRenderer&&(d.inviteAPI.inviteButton.addTracker(t,e),d.inviteAPI.inviteButton.setRules(n.rules,n.filter),d.inviteAPI.inviteButton.setOnlineState(e.isAvailable))}var r,a=0;e.prototype.send=function(e,t){var n,i=t||{},s="",o=!(t="Visitor");this.pingScript?this.onError("SCRT did not handle response before sending another message."):(1<e.length?(t="System",s="MultiNoun",i.nouns="",o=!0):s=e[0].name,n=d.settings.baseLiveAgentURL+"/rest/"+t+"/"+s+".jsonp?",e.forEach(function(t){o&&(i.nouns+=t.name+","),i[t.name+".prefix"]="Visitor",Object.getOwnPropertyNames(t.data).forEach(function(e){i[t.name+"."+e]=t.data[e]})}),o&&(i.nouns=i.nouns.substr(0,i.nouns.length-1)),Object.getOwnPropertyNames(i).forEach(function(e){n+=e+"="+i[e]+"&"}),n+="callback=embedded_svc.liveAgentAPI.connection.handlePing&deployment_id="+d.settings.deploymentId+"&org_id="+d.settings.orgId+"&version=48",(e=document.createElement("script")).type="text/javascript",e.src=n,this.pingScript=document.body.appendChild(e),this.pingTimeoutTimer=window.setTimeout(function(){this.onError("Server failed to respond.")}.bind(this),5e3))},e.prototype.handlePing=function(e){this.pingTimeoutTimer&&(clearTimeout(this.pingTimeoutTimer),this.pingTimeoutTimer=void 0),this.running=!0,e.messages.forEach(function(e){this.messageHandler(e.type,e.message)}.bind(this)),this.onSuccess(),this.pingScript&&(document.body.removeChild(this.pingScript),this.pingScript=void 0)},e.prototype.messageHandler=function(e,t){switch(e){case"Availability":this.liveAgentAPI.handleAvailability(t);break;case"SwitchServer":this.liveAgentAPI.handleSwitchServer(t);break;case"Settings":this.liveAgentAPI.handleSettings(t);break;default:d.log("Unexpected message of type "+e+": "+JSON.stringify(t))}},e.prototype.onSuccess=function(e){e=e||5e4,this.pingTimer&&clearTimeout(this.pingTimer),this.pingTimer=window.setTimeout(this.liveAgentAPI.ping.bind(this.liveAgentAPI),e)},e.prototype.onError=function(e){d.error(e)},t.prototype.registerMessageHandlers=function(){d.addMessageHandler("liveagent.fileTransfer.uploadFile",function(e){this.uploadFile(e)}.bind(this)),d.addMessageHandler("liveagent.fileTransfer.resetFileSelector",function(){this.resetFileSelector()}.bind(this))},t.prototype.handleFileSelectorChange=function(){var e=document.getElementById("fileSelector").files[0];embedded_svc.liveAgentAPI.sendFileInfo(e)},t.prototype.uploadFile=function(e){var t=document.getElementById("fileUploadForm");t.action=e.url,t.submit(),this.resetFileSelector()},t.prototype.resetFileSelector=function(){document.getElementById("fileSelector").value=""},t.prototype.createElements=function(){var e=document.createElement("form"),t=document.createElement("input"),n=document.createElement("input"),i=document.createElement("iframe");e.id="fileUploadForm",e.enctype="multipart/form-data",e.method="post",e.target="fileUploadIframe",t.type="file",t.id="fileSelector",t.name="file",t.style.display="none",t.onchange=this.handleFileSelectorChange,n.name="filename",n.type="hidden",i.id="fileUploadIframe",i.name="fileUploadIframe",i.title="FileUploadFrame",i.style.display="none",e.appendChild(t),e.appendChild(n),document.body.appendChild(e),document.body.appendChild(i)},i.prototype.initialize=function(e){e&&e.LA_VISITOR_INFO?(e=JSON.parse(e.LA_VISITOR_INFO),this.visitCount=e.visitCount,this.pages=e.pages,this.originalReferrer=e.originalReferrer||document.referrer):this.originalReferrer=document.referrer,this.visitCount+=1,this.addCurrentPage(),this.serialize()},i.prototype.serialize=function(){var e=JSON.stringify({visitCount:this.visitCount,originalReferrer:this.originalReferrer,pages:this.pages});embedded_svc?embedded_svc.setSessionData("LA_VISITOR_INFO",e):window.sessionStorage.setItem("LA_VISITOR_INFO",e)},i.prototype.getInfo=function(){return{visitCount:this.visitCount,originalReferrer:this.originalReferrer,pages:this.pages}},i.prototype.addCurrentPage=function(){var n=window.location.href;this.pages.forEach(function(e,t){e.location===n&&this.pages.splice(t,1)}.bind(this)),this.pages.unshift({location:n,time:(new Date).getTime()})},s.prototype.ping=function(){var e={},t=[new n("Availability",{ids:"["+d.settings.buttonId+"]"})];d.log("Pinging server"),this.connection.pingTimer=void 0,e.sid=this.sid,e.r=(new Date).getMilliseconds(),this.connection.send(t,e)},s.prototype.getChatSettings=function(){embedded_svc.utils.loadScriptFromUrl(r),a+=1},s.prototype.constructChatSettingsEndpointURL=function(){var e=embedded_svc.settings.language,t=embedded_svc.settings.eswConfigDevName,n=(n="?Settings.prefix=EmbeddedService&org_id="+embedded_svc.settings.orgId)+"&EmbeddedServiceConfig.configName="+t+"&callback=embedded_svc.liveAgentAPI.handleChatSettings&version=48";return"string"==typeof e&&0<e.trim().length&&(n+="&EmbeddedServiceConfig.language="+e),embedded_svc.settings.baseLiveAgentURL+"/rest/EmbeddedService/EmbeddedServiceConfig.jsonp"+n},s.prototype.handleChatSettings=function(e){var t={};e.messages.forEach(function(e){"EmbeddedServiceConfig"===e.type?(embedded_svc.config=e.message,embedded_svc.utils.isCommunityOrSite()&&(t.ChatInvitation=d.liveAgentAPI.processInvitations),embedded_svc.utils.isMatchingCustomizationFound(embedded_svc.config,embedded_svc.settings.pageName)&&embedded_svc.utils.processCustomizations(embedded_svc.settings.pageName,embedded_svc.config,t)):"SwitchServer"===e.type?(embedded_svc.utils.warning("[Chat] Your org has been migrated on the Service Cloud Real Time servers. Consider regenerating the snippet for this page."),embedded_svc.settings.baseLiveAgentURL=e.message.newUrl,a=0,r=embedded_svc.liveAgentAPI.constructChatSettingsEndpointURL(),embedded_svc.liveAgentAPI.getChatSettings()):"EmbeddedServiceError"===e.type||"Error"===e.type?1<=a||"EmbeddedServiceError"===e.type&&!e.message.shouldRetry?embedded_svc.utils.error("[Chat] "+e.type+" from jsonp call: "+e.message.text):(embedded_svc.log("[Chat] Getting chat settings failed. Retrying..Attempt:"+a),embedded_svc.liveAgentAPI.getChatSettings()):embedded_svc.utils.error("[Chat] Unexpected message type from jsonp call:"+e.type)})},s.prototype.getButtonSettings=function(){var e=[],t={};this.sid&&(t.sid=this.sid,t.r=(new Date).getMilliseconds(),d.log("Reusing existing session.")),e.push(new n("Settings",{buttonIds:"["+d.settings.buttonId+"]",updateBreadcrumb:1})),this.connection.send(e,t)},s.prototype.handleAvailability=function(e){d.log("Agent Available: "+JSON.stringify(e)),e.results.forEach(function(e){var t=e.isAvailable;embedded_svc.utils.fireEvent("onAvailability",void 0,{isAgentAvailable:t,id:e.id}),"LiveAgent"===d.settings.entryFeature&&(d.settings.agentAvailableOnButtonClick=t,this.updateButton(t),d.inviteAPI&&d.inviteAPI.inviteButton.getTracker()&&d.inviteAPI.inviteButton.setOnlineState(t))}.bind(this))},s.prototype.handleSettings=function(e){var t;e.buttons.forEach(function(e){e.id===d.settings.buttonId&&(t=e.isAvailable,"Invite"===e.type&&(d.liveAgentAPI.inviteButton=e))}),d.log("Agent Available: "+JSON.stringify(t)),"LiveAgent"===d.settings.entryFeature&&(d.settings.agentAvailableOnButtonClick=t,this.updateButton(t)),embedded_svc.liveAgentAPI.hasInviteButton()&&(d.liveAgentAPI.hasInvitationsLoaded&&embedded_svc.liveAgentAPI.appendInvitationsComponent(),o(d.liveAgentAPI.inviteButton)),embedded_svc.utils.fireEvent("onSettingsCallCompleted",void 0,{isAgentAvailable:t})},s.prototype.handleSwitchServer=function(e){e=e.newUrl,d.log("Detected new Live Agent url: "+e),d.settings.baseLiveAgentURL=e,d.log("Immediately re-pinging server with new Live Agent url"),window.setTimeout(function(){this.connection.onSuccess(1)}.bind(this),1),this.getButtonSettings()},s.prototype.disconnect=function(){d.log("Disconnecting from Live Agent"),this.connection.running=!1},s.prototype.isButtonId=function(e){return"573"===d.getKeyPrefix(e)},s.prototype.isDeploymentId=function(e){return"572"===d.getKeyPrefix(e)},s.prototype.sendFileInfo=function(e){var t=document.createEvent("CustomEvent");t.initCustomEvent("sendFileInfo",!0,!1,{name:e.name,size:e.size}),window.dispatchEvent(t)},s.prototype.sendCustomEvent=function(e,t){var n={};n.type=e,n.data=t,d.postMessage("chasitor.sendCustomEvent",n)},s.prototype.getCustomEvents=function(e){d.addMessageHandler("liveagent.getCustomEventsResult",e),d.postMessage("chasitor.getCustomEvents")},s.prototype.addCustomEventListener=function(e,t){d.addMessageHandler("liveagent.customEventReceived",t),d.postMessage("chasitor.addCustomEventListener",e)},s.prototype.getSessionId=function(){return this.sid},s.prototype.updateButton=function(e){d.settings.isOfflineSupportEnabled&&!e?(d.isButtonDisabled=!1,d.setHelpButtonText(d.settings.offlineSupportMinimizedText)):d.isButtonDisabled=!e},s.prototype.handleInvitationsResource=function(){embedded_svc.config.invitation.htmlMarkup&&(d.liveAgentAPI.hasInvitationsLoaded=!0,embedded_svc.liveAgentAPI.hasInviteButton()&&(embedded_svc.liveAgentAPI.appendInvitationsComponent(),o(d.liveAgentAPI.inviteButton)))},s.prototype.appendInvitationsComponent=function(){var e,t=document.createElement("div");t.id=embedded_svc.liveAgentAPI.INVITATIONS_CONTAINER_ID,t.innerHTML=embedded_svc.config.invitation.htmlMarkup,embedded_svc.config.invitation.styles&&((e=document.createElement("style")).type="text/css",e.innerHTML=embedded_svc.config.invitation.styles,t.appendChild(e)),embedded_svc.settings.targetElement.appendChild(t),embedded_svc.config.invitation.invitationAPIs&&((t=document.createElement("script")).type="text/javascript",t.innerHTML=embedded_svc.config.invitation.invitationAPIs,embedded_svc.settings.targetElement.appendChild(t))},s.prototype.processInvitations=function(e){var t=embedded_svc.config.embeddedServiceConfig?embedded_svc.utils.getSiteEndpointUrl(embedded_svc.config.embeddedServiceConfig):null;t?(embedded_svc.config.invitation={},embedded_svc.utils.loadScriptFromUrl(embedded_svc.utils.generateResourceUrl(t,e.resource),embedded_svc.liveAgentAPI.handleInvitationsResource,function(){embedded_svc.utils.error("[Invitations] Something went wrong while loading invitations static resource.")}.bind(embedded_svc))):embedded_svc.utils.warning("Static resource cannot be loaded because no site endpoint exists for the embedded service deployment.")},s.prototype.hasInviteButton=function(){return 0<Object.keys(d.liveAgentAPI.inviteButton).length&&d.liveAgentAPI.inviteButton.constructor===Object},s.prototype.startChat=function(s){if("function"==typeof Promise)return new Promise(function(e,t){var n;try{(n=document.querySelector(".embeddedServiceSidebar"))?n.classList.contains("sidebarMinimized")?n.dispatchEvent(new CustomEvent("embeddedservicemaximizechat",{detail:{resolve:e,reject:t}})):n.classList.contains("sidebarMaximized")&&e("Embedded Service component is already maximized."):d.bootstrapEmbeddedService({chatAPISettings:s}).then(function(){d.liveAgentAPI.startChat.bind(d,s),e("Embedded Service application and component bootstrapped")}).catch(function(e){t(e)})}catch(e){t(e)}}).then(function(e){return d.log("[Start Chat API] "+e),(d.util.isChannelMenuContext()||d.menu)&&(d.menu.hideButtonAndMenu(),d.menu.hideTopContainer()),new Promise(function(e,t){try{var n=document.querySelector(".embeddedServiceLiveAgentSidebarFeature"),i=document.querySelector(".embeddedServiceSidebarState");n?i.classList.contains("embeddedServiceLiveAgentStateWaiting")||i.classList.contains("embeddedServiceLiveAgentStateChat")?e("Restricted from starting chat in current state. Chat request will not fire."):(n.dispatchEvent(new CustomEvent("embeddedservicestartchat",{detail:{data:s?embedded_svc.validateStartChatAttributes(s):{},resolve:e,reject:t}})),d.addMessageHandler("liveagent.initialized",function(){e("Successfully requested to start chat session.")})):!n&&document.getElementsByClassName("embeddedServiceSidebarDialogState")?e("Restricted from starting a chat in current state. Chat request will not fire."):e("Embedded Service sidebar feature not rendered. Start Chat was not called.")}catch(e){t(e)}}).then(function(e){d.log("[Start Chat API] "+e)}).catch(function(e){d.error("[Start Chat API] Error starting chat: "+e)})}).catch(function(e){d.error("[Start Chat API] Error bootstrapping/maximizing chat: "+e)});d.loadScriptFromDirectory("common","promisepolyfill",function(){return d.liveAgentAPI.startChat(s)},!0)},s.prototype.endChat=function(){if("function"==typeof Promise)return new Promise(function(t,n){var i;try{(i=document.querySelector(".embeddedServiceSidebarState"))?["embeddedServiceLiveAgentStateWaiting","embeddedServiceLiveAgentStateChat","embeddedServiceSidebarDialogState"].some(function(e){return i.classList.contains(e)})?(i.dispatchEvent(new CustomEvent("embeddedserviceendchat",{detail:{resolve:t,reject:n}})),d.addMessageHandler("session.deletedSessionData",function(e){-1!==e.indexOf("CHASITOR_SERIALIZED_KEY")&&-1!==e.indexOf("MASTER_DEPLOYMENT_ID")&&t("Successfully deleted session keys after chat ended.")})):(d.addMessageHandler("session.deletedSessionData",function(e){-1!==e.indexOf("ESW_IS_MINIMIZED")&&t("Successfully deleted session keys after client closed.")}),d.deleteSessionData(["ESW_IS_MINIMIZED"])):t("Embedded Service application state is not rendered on this page.")}catch(e){n(e)}}).then(function(e){return d.log("[End Chat API] "+e),new Promise(function(t,n){var e;try{(e=document.querySelector(".embeddedServiceSidebar"))?(d.addMessageHandler("session.deletedSessionData",function(e){-1!==e.indexOf("ESW_IS_MINIMIZED")&&-1!==e.indexOf("LA_ESW_SHOW_QUEUE_POSITION")&&-1!==e.indexOf("CHATBOT_FOOTER_MENU")&&t("Successfully deleted session keys after sidebar destroyed.")}),e.dispatchEvent(new CustomEvent("embeddedservicedestroysidebar",{detail:{resolve:t,reject:n}})),d.deleteSessionData(["ESW_IS_MINIMIZED","SCROLL_ENABLED","LA_ESW_CHAT_SCROLL_POSITION","CHATBOT_FOOTER_MENU","LA_ESW_SHOW_QUEUE_POSITION"])):t("Embedded Service component is not rendered on this page.")}catch(e){n(e)}finally{e&&e.remove()}}).then(function(e){d.log("[End Chat API] "+e),d.deleteSessionData(["CHASITOR_SERIALIZED_KEY","MASTER_DEPLOYMENT_ID","ACTIVE_CHAT_SESSIONS","PRECHAT_FORM_DETAILS","PRECHAT_ENTITIES"]),embedded_svc.postMessage("chasitor.decrementActiveChatSession",embedded_svc.settings.deploymentId),sessionStorage.removeItem(d.settings.storageDomain+"MASTER_DEPLOYMENT_ID"),d.deleteSessionData(["ESW_IS_MINIMIZED","SCROLL_ENABLED","LA_ESW_CHAT_SCROLL_POSITION","CHATBOT_FOOTER_MENU","LA_ESW_SHOW_QUEUE_POSITION"]),d.menu&&d.menu.settings.displayChannelMenu&&d.menu.showButtonAndMenu(),!d.menu&&d.settings.displayHelpButton&&d.showHelpButton()}).catch(function(e){d.error("[End Chat API] Error destroying sidebar: "+e)})}).catch(function(e){d.error("[End Chat API] Error ending chat: "+e)}).finally(function(){d.log("[End Chat API] Finished executing End Chat API")});d.loadScriptFromDirectory("common","promisepolyfill",function(){return this.endChat()}.bind(this),!0)},s.prototype.clearSession=function(){if("function"==typeof Promise)return d.liveAgentAPI.endChat().then(function(){return new Promise(function(e,t){try{if(document.getElementById("esw_storage_iframe"))if(-1===d.settings.enabledFeatures.indexOf("LiveAgent"))t("Embedded Service deployment does not have the LiveAgent feature enabled.");else{d.addMessageHandler("session.deletedAllSessionData",function(){e("Successfully deleted all tracked ESW storage keys.")});try{d.postMessage("chasitor.cancelChat"),d.postMessage("chasitor.endChat")}finally{d.deleteSessionData("CHASITOR_SERIALIZED_KEY ACTIVE_CHAT_SESSIONS LA_VISITOR_INFO MASTER_DEPLOYMENT_ID CHASITOR_EVENTS PRECHAT_FORM_DETAILS PRECHAT_ENTITIES".split(" ")),d.deleteSessionData(["ACTIVE_CHAT_SESSIONS"],!0),sessionStorage.removeItem(d.settings.storageDomain+"MASTER_DEPLOYMENT_ID"),d.deleteSessionData(d.storageKeys),d.postMessage("session.deleteAllKeys",d.settings.storageDomain)}}else e("Salesforce iframe not present on this page.")}catch(e){t(e)}}).then(function(e){d.log("[Clear Session API] "+e)}).catch(function(e){d.error("[Clear Session API] Error deleting session keys or iframe: "+e)})}).catch(function(e){d.error("[Clear Session API] Error clearing session: "+e)}).finally(function(){d.log("[Clear Session API] Finished executing Clear Session API")});d.loadScriptFromDirectory("common","promisepolyfill",function(){return this.clearSession()}.bind(this),!0)},d.liveAgentAPI=new s});
