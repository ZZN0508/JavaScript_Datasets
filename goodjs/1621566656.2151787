define("OK/notifications/LayerController",["OK/utils/utils","OK/logger","OK/ToolbarGrowl","OK/ToolbarBubble"],(function(t,e,n,o){"use strict";var r="layer_notifications",i=null,a=o.wrap("counter_Notifications"),c=j("ntf_toolbar_button"),s="toolbar_nav_a__notif__active",l=!1,d="/",f=0,u=1,y=!1,g=!1;return{show:function(o){(o=o||{},g)||(h(),O(),j("hook_Block_NotificationsLayer").innerHTML?OK.loader.use(["OKCustomJs"],_):(OK.loader.use(["OKCustomJs"],K),c.classList.add(s),C(I()),g=!0,t.ajax({url:c.getAttribute("data-link"),data:{"st.ntf.cat":o.category||i||"All","st.ntf.reset":f>0?"off":"on","st.ntf.page":u}}).fail((function(){c.classList.add(s),g=!1,e.error("ll","ntf"),p(I()),v()})).done((function(e,i,a){g=!1,O(),n.destroyByLayerId(r),t.updateBlockModelCallback(e,i,a),OK.loader.use(["OKCustomJs"],_.bind(window,o.callback))}))))},hide:m,reset:k,showContent:function(t,e){if(h(),N().classList.remove("__process"),t&&(i=t,y=!1,e)){var n=j("ntf_layer_menu_link_"+t);n&&L(n.getAttribute("href"))}},toggleContent:function(){N().getElementsByClassName("notif").length?(C(w()),p(B())):(p(w()),C(B()))},showLoader:function(){b(0),N().classList.add("__process")},category:function(){return l?i:null},shouldCheckNews:function(){y=!0}};function h(){var t=j("ntf_layer_close");!l&&t&&(t.addEventListener("click",m),l=!0)}function _(t){h(),OK.Layers.register(r,m),p(I()),c.classList.add(s),d=OK.historyManager.getState(),C(E()),b(f),a.hide(),t&&t()}function m(){if(l){(o=w())&&(f=o.scrollTop),function(){var t=j("ntf_layer_content_inner");if(t){var e=t.parentNode;if(e&&e.getAttribute){var n=t.parentNode.getAttribute("data-page");u=parseInt(n,10)||u}}}(),L(d&&0===d.indexOf("/notifications")?"/":d),O(),v(),function(){if(l){var t=j("ntf_layer_close");t&&t.removeEventListener("click",m),l=!1}}();var e=(n=j("ntf_layer_left_menu"))&&null!==n.getAttribute("data-unread");(y||e)&&(y=!1,e&&k(),t.ajax({url:"/dk?cmd=NotificationsController&st.checkNews=on"}).done((function(e,n,o){t.updateBlockModelCallback(e,n,o)})))}var n,o}function v(){p(E()),c.classList.remove(s),OK.hookModel.setHookContent("NotificationsLayer",""),OK.Layers&&OK.Layers.remove&&(OK.Layers.remove(r),OK.Layers.onLayerHidden())}function O(){n.destroyByLayerId(r)}function k(t){i=t||"All",f=0,u=1}function K(){OK.Layers.unregisterAll(),OK.Layers.onLayerShown()}function L(t){t!==OK.historyManager.getState()&&OK.historyManager.pushState(t)}function p(t){t&&t.classList.add("invisible")}function C(t){t&&t.classList.remove("invisible")}function b(t){var e=w();e&&(e.scrollTop=t)}function B(){return j("ntf_layer_content_stub")}function N(){return j("hook_Block_NotificationsLayerContent")}function w(){return j("ntf_layer_content_scroll")}function E(){return j("ntf_layer")}function I(){return j("ntf_toolbar_layer_loader")}function j(t){return document.getElementById(t)}})),define("OK/notifications/ActionsController",["OK/logger","OK/ToolbarGrowl","OK/ToolbarBubble"],(function(t,e,n){"use strict";var o,r="layer_notifications",i=n.wrap("counter_Notifications"),a={confirm:function(t){var e,n;t.json.massOperationRemoved&&(n=document.getElementById("ntf_mass_operation"))&&(e=n.parentNode)&&e.removeChild(n),!o.category()&&t.html?(o.reset(t.json.category),o.show({callback:function(){var e,n,r,i;for((n=document.createElement("div")).innerHTML=t.html,e=document.getElementById("ntf_layer_content_inner");!n.id;)n=n.firstChild;r=n.id.replace("hook_Block_",""),(i=OK.hookModel.getHookById(r))?(OK.hookModel.setHookContent(r,n.innerHTML),function(t){var e=document.getElementById("ntf_layer_content_scroll"),n=t.offsetTop-20;n>0&&(e.scrollTop=n,t.firstChild.classList.add("__anim-highlight"))}(i.element)):(n=e.insertBefore(n,e.firstChild),OK.hookModel.captureBlockHook("NotificationsLayerContent",n),o.toggleContent()),t.json.redirectAfterNtfLayerLoaded&&t.performRedirect()}})):(c(t.json.nid,t.html,!1,t.json.counter),t.json.redirectAfterNtfLayerLoaded&&t.performRedirect()),t.json.redirectAfterNtfLayerLoaded||t.performRedirect()},news:function(n){var a=o.category(),s=n.json.totalUnread,l=n.json.removed,d=n.json.closed;!function(t){if(t)for(var e=0;e<t.length;e++)c(t[e],null,!0,!0)}(l),function(t){var n,o=e.getByLayerId(r);if(o&&t&&t.length)for(n=0;n<t.length;n++)if(o.id===t[n]){o.destroy(!0);break}}(d),a?s&&(o.shouldCheckNews(),t.success("ntf","push.open",s)):(i.update(s),s>0&&o.reset(),0===s&&e.destroyByLayerId(r))}};return{init:function(t){o=t,OK.util.extend(OK.ntf,{close:function(t){c(t,null,!1,!1)},lock:function(t){var e=OK.hookModel.getHookById("Ntf_"+t);e&&e.element.setAttribute("data-locked","true")}})},handle:function(t){var e;t.action&&a[t.action]&&a[t.action](t),void 0===(e=t.json.totalUnread)||o.category()||i.update(e)}};function c(t,n,i,a){var c,l,d,f,u=document.getElementById("ne-"+t);if(u&&(c=OK.hookModel.getNearestBlockHookId(u),l=OK.hookModel.getHookById(c))){if(d=l.element,i&&"true"===d.getAttribute("data-locked"))return;if(o.category())n?OK.hookModel.setHookContent(c,n):(OK.hookModel.setHookContent(c,""),(f=d.parentNode)&&f.removeChild(d),o.toggleContent(),setTimeout(s,500)),a&&function(t){var e=document.getElementById("ntf_counter_"+t);if(e){var n=parseInt(e.innerHTML,10)||0;if(n>0){var o=n-1;e.classList.toggle("__empty",0===o),e.innerHTML=o}}}(u.getAttribute("data-category"));else{var y=e.getByLayerId(r);y&&t===y.id&&y.destroy(!0)}}}function s(){var t,e=document.getElementById("ntf_layer_content_inner");document.createEvent?((t=document.createEvent("Event")).initEvent("scroll",!0,!0),e.dispatchEvent(t)):document.createEventObject&&(t=document.createEventObject(),e.fireEvent("onscroll",t))}})),define("OK/notifications/ContentData",[],(function(){"use strict";function t(t){if(t){var e=t.split("&&&%%%");this.json=OK.util.parseJSON(e[0]),this.action=this.json.action,2===e.length&&(this.html=e[1])}}return t.prototype={performRedirect:function(){if(this.json.redirect){var t=decodeURIComponent(this.json.redirect).replace(/&amp;/g,"&");0===t.indexOf("http://")||0===t.indexOf("https://")?window.open(t,"_blank"):navigateOnUrlFromJS(t)}}},t})),define("OK/Notifications",["require","OK/notifications/LayerController","OK/notifications/ActionsController","OK/notifications/ContentData","OK/NewsFetchCoordinator","OK/logger"],(function(t){"use strict";var e=t("OK/notifications/LayerController"),n=t("OK/notifications/ActionsController"),o=t("OK/notifications/ContentData"),r=t("OK/NewsFetchCoordinator"),i=t("OK/logger");function a(t){t.stopPropagation(),e.category()?e.hide():e.show()}return{LayerController:e,activate:function(t){document.getElementById("ntf_layer")&&(i.success("ntf","short-link"),e.show()),t.parentNode.addEventListener("click",a),n.init(e),r.addBlock("NTF")},setNewContent:function(t){try{n.handle(new o(t))}catch(e){i.clob("ntf",t+"\n"+e.stack,"fail","actions")}},showContent:function(t){setTimeout((function(){e.showContent(t.getAttribute("data-category"),"on"===t.getAttribute("data-history"))}))}}}));