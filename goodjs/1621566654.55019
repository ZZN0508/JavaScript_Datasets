define(["OK/utils/dom","OK/FAPIClient","OK/logger","OK/cookie"],(function(t,e,i,r){var s,o="Skrepochka",n="PENDING",a="SHOW",c="HIDE",h="DISABLE",u="Game",_="OPENED",d="UI_CLOSE";function l(t,e){i.success(o,t,e)}function f(t){("true"===r.readCookie("dme")||OK.fn.isDebug())&&window.console&&console.log.apply(console,arguments)}function g(t){var e=this.extractDataModel(t);this.prepareViewData().findElements(t).initUIInteractionHandlers().prepareAPI(e).tryStart()}function p(t){this._currentTimeoutId=-1,this._commonCtx=t||null}return p.prototype={run:function(t,e,i){var r=this;this.cancel(),this._currentTimeoutId=setTimeout((function(){r._currentTimeoutId=-1,t.call(i||r._commonCtx||null)}),e)},cancel:function(){-1!==this._currentTimeoutId&&clearTimeout(this._currentTimeoutId)}},g.prototype={extractDataModel:function(t){var e=t.getAttribute("data-model");return(JSON.parse(e))},findElements:function(e){return this._rootNode=e,this._contentNode=t.firstByClass(e,"skrepochka_content"),this._characterNode=t.firstByClass(e,"skrepochka_character"),this._closeButtonNode=t.firstByClass(e,"skrepochka_close"),this._notificationTextNode=t.firstByClass(e,"skrepochka_notification-text"),this._characterOpenerNode=t.firstByClass(e,"skrepochka_character-opener"),this._textOpenerNode=t.firstByClass(e,"skrepochka_text-opener"),this},prepareViewData:function(){return this._localClosedCategories={},this._currentShowedCategory=null,this._isViewShowed=!1,this._isInHiddingProcess=!1,this},prepareAPI:function(t){f(t);var i=t.apiData;this._newYearGameId=i.newYearGameId,this._nextAPIRequestTimeout=new p(this),this._isActive=!0;var r=i.requestRetryTimeout;this._baseRequestRetryTimeout=r,this._requestRetryTimeout=r,this._pingIntervalMs=i.pingIntervalMs,this._currentStatus=n,this._initialETag=this.getLocallyETag(),this._lastETag=null,this._expiresInMs=i.pingIntervalMs,this._currentCategories=null;var s=i.params;return e.Client.initialize(s,s),this},initUIInteractionHandlers:function(){var t=this;return this._closeButtonNode.addEventListener("click",(function(){t.closeAction(d)})),this._characterOpenerNode.addEventListener("click",(function(){t.openNotification()})),this._textOpenerNode.addEventListener("click",(function(){t.openNotification()})),this},getCurrentShowedCategory:function(t){var e=this._localClosedCategories;if(!Object.keys(e).length)return t[0];for(var i=0,r=t.length;i!==r;i+=1){var s=t[i];if(!e.hasOwnProperty(s.type))return s;if(s.last_notif_id!==e[s.type])return s}return null},processingResponse:function(t){var e;f(t),e=t.status!==a||t.categories&&0!==t.categories.length?t.status:c,this._currentStatus=e,e===a&&(this._lastETag=t.etag),this._expiresInMs=t.expires_in_ms||this._pingIntervalMs,this._currentCharacter=t.character;var i=t.categories;if(this._currentCategories=i,e===a){var r=this._currentShowedCategory,s=this.getCurrentShowedCategory(i);this._currentShowedCategory=s,r&&(r.type!==s.type?l("opened-update","category"):r.last_notif_id!==s.last_notif_id&&l("opened-update","last-notif-changed"))}return this},closeAction:function(t){var e=this._currentShowedCategory;this._localClosedCategories[e.type]=e.last_notif_id,t===d&&l("closed",e.type);var i=this.getCurrentShowedCategory(this._currentCategories);return i?(this._currentShowedCategory=i,this.updateView()):(this.hideView(),this._initialETag=this._lastETag,this.saveETagLocally(this._lastETag)),this},openNotification:function(){var t=this._currentShowedCategory;return l("opened",t.type),t.type===u?navigateOnUrlFromJS("/app/"+this._newYearGameId):navigateOnUrlFromJS("/notifications/"+t.type),this.closeAction(_),this},renderCurrentShowedCategory:function(){this._characterNode.classList.add("__"+this._currentCharacter.toLowerCase().trim());var t=this._currentShowedCategory.title;return this._notificationTextNode.textContent=t,this._characterOpenerNode.setAttribute("title",t),this._textOpenerNode.setAttribute("title",t),this},prepareForShowing:function(){return this.renderCurrentShowedCategory(),this._rootNode.classList.add("__showed"),this},runStartAnimation:function(){return this._contentNode.classList.add("__showed"),this._isViewShowed=!0,this},showInFirstTime:function(){var t=this;return l("showed"),requestAnimationFrame((function(){t.prepareForShowing(),requestAnimationFrame((function(){t.runStartAnimation()}))})),this},updateView:function(){return this._isViewShowed?this.renderCurrentShowedCategory():this.showInFirstTime(),this},hideView:function(t){if(this._isViewShowed){var e=this;e._isViewShowed=!1,t?(e._rootNode.classList.remove("__showed"),e._contentNode.classList.remove("__showed")):(e._isInHiddingProcess=!0,e._rootNode.classList.add("__hide-anim"),setTimeout((function(){l("hided"),e._rootNode.classList.remove("__hide-anim"),e._rootNode.classList.remove("__showed"),e._contentNode.classList.remove("__showed"),e._currentShowedCategory=null,e._isInHiddingProcess=!1}),400))}return this},saveETagLocally:function(t){return localStorage.setItem("_skrepochka_",t),this},getLocallyETag:function(){var t=localStorage.getItem("_skrepochka_");return"null"===t?null:t},getNotificationsWithTimeout:function(){return this._nextAPIRequestTimeout.run(this.getNotifications,this._expiresInMs),this},resetProgressiveRetryTimeout:function(){return this._requestRetryTimeout=this._baseRequestRetryTimeout,this},retryAPIRequest:function(t,e){if(f("Skrepochka: retry",this._requestRetryTimeout,6e5),102===e.error_code)this.deactivate(),l("session-expired");else{if(!(this._requestRetryTimeout>6e5))return this._nextAPIRequestTimeout.run(t,this._requestRetryTimeout),this._requestRetryTimeout*=2,this;this.deactivate(),l("retry-timeout-expired",e.error_code)}},getNotifications:function(){var t=this;return e.Client.callWithPromise("promo.getSkrepochkaStatus",{etag:t._initialETag}).then((function(e){return t._isInHiddingProcess?new Promise((function(t){setTimeout((function(){t(e)}),400)})):Promise.resolve(e)})).then((function(e){if(t._isActive){t.resetProgressiveRetryTimeout();var i=t._currentStatus;switch(t.processingResponse(e),t._currentStatus){case a:i===c&&l("closed-update",t._currentShowedCategory.type),t.updateView().getNotificationsWithTimeout();break;case c:t.hideView().getNotificationsWithTimeout();break;case h:t.deactivate()}}}),(function(e){t._isActive&&(l("error-get-new",e.error_code),t.retryAPIRequest(t.getNotifications,e))})),this},tryStart:function(){var t=this;return e.Client.callWithPromise("promo.getSkrepochkaStatus",{etag:t._initialETag}).then((function(e){if(t._isActive)switch(t.resetProgressiveRetryTimeout().processingResponse(e),t._currentStatus){case a:t.showInFirstTime().getNotificationsWithTimeout();break;case c:t.getNotificationsWithTimeout();break;case h:t.deactivate()}}),(function(e){t._isActive&&(l("error-start",e.error_code),t.retryAPIRequest(t.tryStart,e))})),this},deactivate:function(){this.hideView(!0),this._nextAPIRequestTimeout.cancel(),this._isActive=!1}},{activate:function(t){s=new g(t)},deactivate:function(t){s.deactivate()}}}));