var webmd=webmd||{};webmd.xdm={timeoutInit:1e4,timeoutCall:15e3,cachedCalls:{},callId:0,receiverUrl:"https://www.webmd.com/xdm",whitelist:[],services:{},requireSSL:!0,call:function(r){var i,t=this;return r=$.extend({timeout:t.timeoutCall},r),i=r.deferred=$.Deferred(),r.timer=setTimeout(function(){i.reject({status:"timeout",msg:"Timeout making the xdm service call "+r.service})},r.timeout),t.callerInit().fail(function(e){i.reject(e)}).done(function(){var e=++t.callId,i={id:e,service:(t.cachedCalls[e]=r).service,data:r.data,headers:r.headers},e="";try{e=JSON.stringify(i)}catch(e){}e&&t.iframe[0].contentWindow.postMessage(e,t.receiverUrl)}),i.promise()},callerInit:function(){var e,i=this;return i.deferredCallerInit?i.deferredCallerInit.promise():(e=i.deferredCallerInit=$.Deferred(),window.postMessage?($(window).on("message",function(e){i.callerProcessResponse(e.originalEvent)}),i.timerInit=setTimeout(function(){e.reject({status:"timeout",msg:"Cross-domain iframe timed out before sending ready response"})},i.timeoutInit),i.iframe=$("<iframe/>").attr({frameborder:"0",height:"1",marginheight:"0",marginwidth:"0",scrolling:"no",src:i.receiverUrl,style:"display:none",width:1}).appendTo("body")):e.reject({status:"unsupported",msg:"postMessage is not supported in this browser"}),e.promise())},callerProcessResponse:function(e){var i,r;if(0===this.receiverUrl.indexOf(e.origin)){r={};try{r=JSON.parse(e.data)}catch(e){}if("init"===r.status)return clearTimeout(this.timerInit),void this.deferredCallerInit.resolve();(i=this.cachedCalls[r.id])&&(delete this.cachedCalls[r.id],clearTimeout(i.timer),"success"===r.status?i.deferred.resolve(r.data):i.deferred.reject(r))}},receiverInit:function(){var i=this;$(window).on("message",function(e){i.receiverProcessRequest(e.originalEvent)}),this.receiverSendResponse({status:"init"})},receiverProcessRequest:function(t){var e,s=this,n=JSON.parse(t.data);return s.receiverIsWhitelisted(t)?s.requireSSL&&"https:"!==window.location.protocol?void s.receiverSendResponse({id:n.id,status:"forbidden",msg:"Access forbidden because receiver page is not HTTPS "+t.origin,data:{}},t):(e=s.services[n.service])?(e=$.extend({data:n.data,headers:n.headers},e),void $.ajax(e).done(function(e){s.receiverSendResponse({id:n.id,status:"success",data:e},t)}).fail(function(e,i,r){s.receiverSendResponse({id:n.id,status:i,http:e.status,msg:r,data:e.responseText},t)})):void s.receiverSendResponse({id:n.id,status:"forbidden",msg:"Access forbidden for service "+n.service,data:{}},t):void s.receiverSendResponse({id:n.id,status:"forbidden",msg:"Access forbidden for domain "+t.origin,data:{}},t)},receiverSendResponse:function(e,i){var r;i=$.extend({source:window.parent,origin:document.referrer},i),r="";try{r=JSON.stringify(e)}catch(e){}r&&i.source.postMessage(r,i.origin)},receiverIsWhitelisted:function(e){var i,r;if(r=e.origin)for(i=0;i<this.whitelist.length;i++)if(r.match(this.whitelist[i]))return!0;return!1}},window.define&&window.define.amd&&define(webmd.xdm);
