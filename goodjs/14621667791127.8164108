define(function(){"use strict";function d(o){o=new RegExp(o+"=(.*?)(?:;|$)").exec(document.cookie);return!(!o||!o.length)&&o[1]}function c(){var o,e=bbcdotcom.adverts.keyValues.getAll(),n="&cust_params=";for(o in e)e.hasOwnProperty(o)&&""!==e[o]&&(n+=o+"%3D"+e[o]+"%26");n+=function(){var o,e="",n=window.ccauds;if(void 0===n)return"";for(o=0;o<n.Profile.Audiences.Audience.length;o++)0<o&&(e+=","),e+=n.Profile.Audiences.Audience[o].abbr;return"ccaud%3D"+encodeURIComponent(e)+"%26"}(),n+=void 0!==window.gs_channels&&"DEFAULT"!==window.gs_channels?"gs_cat%3D"+encodeURIComponent(window.gs_channels)+"%26":"",bbcdotcom.objects("bbcdotcom.adverts.adUnit.getPreviewUid")&&(t="uid="+bbcdotcom.adverts.adUnit.getPreviewUid(),n+=encodeURIComponent(t)),null!==bbcdotcom.config.getWindowLocation().pathname.match(/\/embed$/g)&&(n+=encodeURIComponent("client=embedplayer"));var t=window.localStorage.getItem("_pdfps"),t=encodeURIComponent(JSON.parse(t||"[]").slice(0,250).join(","));return t&&(n+="permutive="+encodeURIComponent(t)),n}function a(){var o,e,n,t;return"undefined"!=typeof bbcdotcom&&void 0!==bbcdotcom.objects&&bbcdotcom.objects("bbcdotcom.adverts.adUnit.get")&&bbcdotcom.objects("bbcdotcom.adverts.keyValues.getAll")?(o="https://pubads.g.doubleclick.net/gampad/ads?sz=640x360&iu="+bbcdotcom.adverts.adUnit.get()+c()+"&env=vp&gdfp_req=1&impl=s&output=xml_vast3&unviewed_position_start=1&ord="+Math.floor(1e9*Math.random())+"&url="+encodeURIComponent(encodeURIComponent(bbcdotcom.config.getWindowLocation().href))+"&ad_rule=1",bbcdotcom.config&&bbcdotcom.config.isNPA&&bbcdotcom.config.isNPA()&&(o+="&npa=1&rdp=1"),t=d(n="ckpf_ppid")||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(o){var e=Math.floor(16*Math.random());return("x"===o?e:3&e|8).toString(16)}).split("-").join(""),window.bbcdotcom.ppid=t,window.bbccookies&&bbccookies.readPolicy("performance")&&(e=n,n=t,(t=new Date).setTime(t.getTime()+31536e6),document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(n)+"; expires="+t.toGMTString()+"; domain=.bbc.com; path=/"),o+=`&ppid=${bbcdotcom.ppid}`):window.bbcdotcom&&bbcdotcom.asyncCmd&&bbcdotcom.asyncCmd.push(function(){bbcdotcom.av.emp.adverts.updatePrerollAdTag()}),o}return bbcdotcom.av.emp.adverts={getPrerollAdTag:a,getPrerollAdTagWithAdRule:function(o){var e=a();return e=!1===new RegExp(/(ad_rule=)\d{1}/g).test(e)?e+"&ad_rule="+o||1:e},getPrerollAdTagForAudio:function(){var o=a();return o=(o=o.replace(/sz=640x360/,"sz=1x1")).replace(/env=vp/,"env=instream"),o+="&ad_type=audio"},updatePrerollAdTag:function(){var o=a();try{var e,n=embeddedMedia.players[0];if(n&&n.pluginsToLoad){for(var t=0;t<n.pluginsToLoad.length;t++)n.pluginsToLoad[t].data&&n.pluginsToLoad[t].data.name&&"AdsPluginParameters"===n.pluginsToLoad[t].data.name&&(e=t);n.pluginsToLoad[e].data.data.adTag=o}}catch(o){}},setupCompanionSlots:function(o){},enableCompanions:function(){},getCompanionSlotId:function(o){},getCompanionSlots:function(o){},encodeCompanionSlots:function(o){},decodeCompanionSlots:function(o){},defineCompanionSlots:function(o){},setCompanionFlashVars:function(o,e){},playerBeforeEachWrite:function(o){o.set("preroll",a())},addSmpPlugin:function(o,e,n){var t,n=n||{};void 0===e||window.bbcdotcom&&bbcdotcom.config&&bbcdotcom.config.isAdsEnabled&&!bbcdotcom.config.isAdsEnabled()||(void 0!==e.loadPlugin&&"function"==typeof e.loadPlugin&&(t=function(o){var e,n={name:"AdsPluginParameters",data:{adTag:a(),debug:d("bbcdotcomHtml5AdsDebug")}};for(e in o)n.data[e]=o[e];return n}(n),e.loadPlugin({html:"name:dfpAds.js",swf:"name:dfpAds.swf"},t)),n=["ident"],(e=(t=e).settings()).suppressItemKind=n,t.settings(e))}},bbcdotcom.av.emp.adverts});
