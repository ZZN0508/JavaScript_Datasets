!function(){var e,p,W,i,t,n,o,a,s,r,l,h;try{var d=window.$MicrosoftMaps8,c=d.Internal,g=(d.Anchor,Microsoft.Maps.Internal._BaseMapDataSource),_=c._BaseMapTemplateSelector,N=c.CanvasDrawingContext,D=(c._ComponentNames,d.CoordinateProjection),y=c._Debug,L=c._EntityHelper,u=(d.G,d.GlobalConfig),f=c._Gimme,m=c._Helper,b=c.HitTestIndex,v=c._JSEvent,x=u.features.labels,w=(c._LatLonCrs,c._LayerDataSource),R=(d.LocationRect,c._LoggerConstants,c._MapFrameData),T=d.Location,I=d.Matrix2D,C=(c.MapHelper,d.MapMath),S=(d.MapTypeId,d.MercatorCubeCrs),P=c._Observable,M=c._ObservableObject,k=d.Point,F=d.Rectangle,A=c.RegionIndex,z=d.SimpleLinePrimitive,O=(d.SimplePointPrimitive,d.Size),B=d.Viewport,H=d.ZoomLevel,j=(c.Iterator,c._Network,c._LatLonCrs),E=c._NAARectangle,V=d.VectorImageTemplate,U=d.VectorMapLayer,X=c._VectorMath,Y=(c._WorkDispatcher,c._LayerRendererManager,this&&this.__extends||(h=function(e,t){return(h=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}h(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)})),G=(Re.prototype.reset=function(){this.placedRegions=[],this.placementPriority=Number.MAX_VALUE,this.shouldBeRendered=!0,this.regions=[],this.positionInitialized=!1},Re.getIconBounds=function(e,t){var i,n,a=F.empty();if(e)for(i=0,n=e.length;i<n;i++)e[i]&&a.union(e[i].getBounds(t));return a},Re.prototype.lastUsedRegion=function(e){for(var t,i=0,n=this.lastUsedRegions.length;i<n;i++)if(t=this.lastUsedRegions[i],Re._regionsMatch(t,e))return t;return e},Re._regionsMatch=function(e,t){e=e.bounds.getBoundingBoxRelativeTo(e.anchor),t=t.bounds.getBoundingBoxRelativeTo(t.anchor);return e.equals(t,.5)},Re.prototype.initializePosition=function(e,t){this.positionInitialized||(this._initializeLabelRegions(e,t),(t=this.data.style&&this.data.style.styleStatic.strataStyle)&&t.alpha&&t.alpha<te.collisionAlphaThreshold&&this.regions.length&&(this.regions[0].isFixed=!0),this._initBounds(e),this.positionInitialized=!0)},Re.prototype._computeFontSize=function(e,t,i,n,a){return C.roundToInterval(Math.min(n,i/(e/t))/a,.1)},Re.getLabelOrigin=function(e,t,i,n){var a,s;switch(i=i||{x:0,y:0},(n=n||W.topRight)&W.horizontalMask){case W.left:a=-e;break;case W.center:a=-e/2;break;default:case W.right:a=0}switch(n&W.verticalMask){default:case W.top:s=-t;break;case W.middle:s=-t/2;break;case W.bottom:s=0}return new k(a+i.x,s+i.y)},Re.prototype._initRegionBounds=function(e,t,i){var n=t.size,a=(n=!n?i=i||this._measureLabel():n).height,s=n.width,o=t.anchor,n=Re.getLabelOrigin(s,a,t.anchorOffset,t.placement),a=new k(n.x+s,n.y+a),n=new F(n,a),a=Math.max(this.data.lowImportanceCollisionPadding/4,this._padding)||this._padding;return n.buffer(a,a),t.bounds=new p(t.anchor,new E(n,t.orientation,o)),i},Re.prototype._initBounds=function(e){for(var t,i,n=0,a=this.regions.length;n<a;n++)t=this.regions[n],e.normalize(t.anchor),t.anchorTransform=I.identity,void 0===t.bounds&&(i=this._initRegionBounds(e,t,i))},Re.prototype.getRegions=function(){if(!this.positionInitialized)throw new Error("Invalid operation: initializePosition must be called before getRegions");return this.regions},Re.prototype._measureLabel=function(){this.lineWidths=[];var e=this.data;return q.getTextSize(e.text,e.secondaryText,e.style,e.fontSize,e.secondaryFontSize,this.lineWidths)},Re.prototype._hasBackground=function(){var e=this.data.style.styleStatic;return e.showBackground&&!!(e.backgroundColor||e.backgroundOutlineColor&&e.backgroundOutlineWidth)},Re.prototype._initializeLabelRegions=function(){},Re.prototype._getRegionsFromHints=function(e,t,i,n,a,s){for(var o,r,l,h,d,c,p,g,u,_,y,f=[],m={},b=[],v=0,x=this.data.primitives.length;v<x;v++)if((r=(o=this.data.primitives[v]).entity.labelHint)&&r.lbl&&-1===f.indexOf(r)){for(l=null,h=0,d=r.lbl.length;h<d;h++){for(var L=r.lbl[h],w=[],R=L.tps&&L.tps.length,T=i,C=null,S=0;S<R;S++)!!(c=L.tps[S]).n==!!n||"number"==typeof s&&"number"==typeof c.esi&&s!==c.esi-1||(C||((u=new D(o.crs,e)).project(c.x||0,c.y||0),C=new k(u.lastProjectedX,u.lastProjectedY),e.normalize(C),T||(p=C.x,g=C.y,c.n&&(u=new k(c.w/2,c.h/2),p+=(u=c.a?I.identity.rotate(c.a).transform(u):u).x,g+=u.y),T=new k(p,g))),w.push(c));w.length&&(m[y=((_=w[0]).n||"")+T.x.toFixed(2)+","+T.y.toFixed(2)]||(m[y]=!0,l={label:this,text:this.data.text,anchor:T.clone(),anchorOffset:new k(C.x-T.x,C.y-T.y),parentRegion:a,textSpans:w,placement:_.n?void 0:W.middleCenter},i&&C.x+_.w<i.x&&(l.horizontalAlignment=2),b.push(l)))}f.push(r)}return 1<b.length&&this._setReplicaProximityForLabelHints(),Re._computeRegionBoundsBasedOnLabelHints(b),b},Re.prototype._setReplicaProximityForLabelHints=function(){this.replicaProximity=1},Re._computeRegionBoundsBasedOnLabelHints=function(e){for(var t,i,n,a,s=0,o=e.length;s<o;s++)if((t=e[s]).textSpans){for(var r=new p(t.anchor),l=t.textSpans[0].x,h=t.textSpans[0].y,d=0,c=t.textSpans.length;d<c;d++)(i=t.textSpans[d]).n&&(n=new O(i.w,i.h),a=new k(t.anchor.x+t.anchorOffset.x+(i.x-l),t.anchor.y+t.anchorOffset.y+(i.y-h)),r.add(new E(new F(new k(0,0),new k(n.width,n.height)),i.a,a)));r.bbox.isEmpty()||(t.bounds=r)}},Re._defaultPadding=2,Re),K=(Y(we,l=G),we.prototype._largestAreaPrimitiveItem=function(e){for(var t=-1,i=0,n=0,a=e.length;n<a;n++){var s=e[n].geometry,s=Math.abs(s.bounds[1]-s.bounds[3])*Math.abs(s.bounds[2]-s.bounds[0]);t<s&&(t=s,i=n)}return i},we.prototype._initializeRegionsAtCentroid=function(e,t,i,n){var a,s=d.SpatialMath,o=s&&s.Geometry;if(o){a=void 0;try{a=o.centroid(t)}catch(e){}a&&(s=t.crs,s=new z([new T(a.latitude,s.toLongitude(n.bounds[3],n.bounds[2])),new T(a.latitude,s.toLongitude(n.bounds[1],n.bounds[0]))],null,null,!1),(o=o.intersection(t,s))&&void 0===o.length&&(s=void 0,i.project(n.bounds[3],n.bounds[2]),n=i.lastProjectedY,(i=t.crs!==j.instance?new D(j.instance,e):i).project(a.longitude,a.latitude),s=new k(i.lastProjectedX,i.lastProjectedY),a=o.geometry.bounds,i.project(a[3],a[2]),o=i.lastProjectedX,i.project(a[1],a[0]),i=i.lastProjectedX-o,1.1<(o=this._measureLabel()).width/i&&(this.data.text=te.wrapTextToFit(this.data.text,o,{width:i,height:0},3),0<this.data.text.indexOf("\n")&&(o=this._measureLabel())),o.width/i<=1.2&&this.regions.push({label:this,text:this.data.text,anchor:s,horizontalAlignment:0,placement:W.middleCenter,orientation:0}),this.regions.push({label:this,text:this.data.text,anchor:new k(s.x,n),anchorOffset:new k(0,8),horizontalAlignment:0,placement:W.bottomCenter,orientation:0})))}},we.prototype._initializeRegionsWithBounds=function(e,t,i){var n,a;t.project(i.bounds[3],i.bounds[2]),n=t.lastProjectedX,a=t.lastProjectedY,t.project(i.bounds[1],i.bounds[0]);var s=t.lastProjectedX,o=t.lastProjectedY,r=s-n,i=a-o,t=this._measureLabel();1.3<=t.width/r&&(this.data.text=te.wrapTextToFit(this.data.text,t,{width:r,height:i},3),0<this.data.text.indexOf("\n")&&(t=this._measureLabel())),1.3<=t.width/r||1.3<=t.height/i||1.3<=t.width*t.height/(r*i)?this.shouldBeRendered=!1:(o=new k((n+s)/2,(a+o)/2),this.regions.push({label:this,text:this.data.text,anchor:o,horizontalAlignment:0,placement:W.middleCenter,orientation:0}))},we.prototype._getRegionsFromVenueRects=function(e,t){for(var i,n,a=t.labelRects,s=this._measureLabel(),o=S.instance,r=new D(o,e),l=[],h=0,d=a.length;h<d;h++)if(n=a[h]){var c=n.xy,p=o.projectToX(c[1],c[0]),g=o.projectToY(c[1],c[0]),u=n.width||0,_=n.height||0,y=g+_/2,c=p-u/2;r.project(c,y),g=r.lastProjectedY,p=r.lastProjectedX,r.project(c+u,y-_);c=r.lastProjectedY,u=r.lastProjectedX,y=Math.abs(u-p),_=Math.abs(g-c);if(!(h<d-1&&(_<s.height||y<s.width)||((i=(n.angle||0)%360)<0&&(i+=360),60<i&&i<270))){n=X.degreesToRadians(-i),n={label:this,text:this.data.text,anchor:new k((p+u)/2,(g+c)/2),orientation:n,placement:W.middleCenter,horizontalAlignment:0},l.push(n),this._padding=.5;break}}return l},we.prototype._initializeLabelRegions=function(e,t){var i=this.data.primitives&&this.data.primitives[0],n=i&&i.entity;this.regions=n.labelRects?this._getRegionsFromVenueRects(e,n,i):this._getRegionsFromHints(e,t),this.regions.length||n.labelRects||(i=0,n=(t=this.data.primitives)[i=1<t.length?this._largestAreaPrimitiveItem(t):i],t=new D(n.crs,e),i=n.geometry,this._initializeRegionsAtCentroid(e,n,t,i),this.regions.length||this._initializeRegionsWithBounds(n,t,i))},we),Z=(Le.prototype.beginDraw=function(){},Le.prototype.endDraw=function(){},Le.prototype.clear=function(){},Le.prototype.cancelRender=function(){},Le.prototype.draw=function(){return!1},Le.prototype.remove=function(){return!1},Le.prototype.update=function(){return!1},Le.prototype.transformContainer=function(){return!1},Le.prototype.invalidateHitTestingData=function(){},Le.prototype.performHitTesting=function(){return!1},Le.prototype.dispose=function(){m._disposeEvents(this)},Le._getTextAnchorOffset=function(e,t){var i=t.width,n=t.height,a=e.region,t=a.placement,e=t&W.horizontalMask||W.right,e=i*(Le._horizontalTextAnchorFactor[W[e]][a.horizontalAlignment]||0),s=0;switch(t&W.verticalMask){default:case W.top:s=-n;break;case W.middle:s=-n/2;break;case W.bottom:}return e=new k(e,s),e=a.anchorOffset?e.add(a.anchorOffset):e},Le._horizontalTextAnchorFactor={left:[-.5,-1,0],center:[0,-.5,.5],right:[.5,0,1]},Le),q=(Y(xe,r=Z),xe.init=function(){var e,t;void 0!==u&&(e=(u.dynamicProperties&&u.dynamicProperties.uiLanguage||"").split("-")[0].toLowerCase(),t=(x.nonItalicLabelLanguages||"").toLowerCase().split(","),e&&0<=t.indexOf(e)&&(xe._nonItalicMarket=!0))},xe.prototype.transformContainer=function(e){return this._validate2DCanvas()&&(e="translate("+(e=this._lastAnchorPointOfLabelCanvas=e.transform(new k(0,0))).x+"px,"+e.y+"px)",this._canvas.set_style({"-webkit-transform":e,transform:e})),!0},xe.prototype.dispose=function(){this._map=null,this._canvas&&this._canvas.clear(),this._canvas=null,this._drawingContext&&(this._drawingContext.dispose(),this._drawingContext=null),this._hitTestIndex=null,this._context=null,this._orderedLabels=null,this._mapEvents.forEach(function(e){e.dispose()}),r.prototype.dispose.call(this)},xe.prototype.beginDraw=function(e,t){this._currentLabelRenderingContext=e,m._renderAllPoiAndLabelsGL()||((e=this._drawingContext)?(this._positionCanvas(t),e.save()):y.log(null,"Canvas context hasn't been created"))},xe.prototype.copyCanvas=function(e){var t,i=this._drawingContext;i&&this._validate2DCanvas()&&(this._lastAnchorPointOfLabelCanvas=this._lastAnchorPointOfLabelCanvas||new k(0,0),t=i.getSize(),e.drawImage(i.getRootElement()[0],this._lastAnchorPointOfLabelCanvas.x-this._widthPadding,this._lastAnchorPointOfLabelCanvas.y-this._heightPadding,t.width,t.height),this._lastAnchorPointOfLabelCanvas=null)},xe.prototype.endDraw=function(e,t){var i,n,a=this;e&&(i=this._validate2DCanvas(),(n=this._drawingContext)||!i)&&(this._drawLabels(!1,t,e.frame),Microsoft.Maps.setAsync(function(){a.labelRenderingComplete&&a.labelRenderingComplete.invoke({labelRenderingContext:e,delayedRenderingTime:0})}),i&&n.restore())},xe.prototype._drawLabels=function(e,t,i){var n,a,s,o,r,l,h=this._orderedLabels,d=xe._getSortedPriorityKeys(Object.keys(h)),c=this._drawingContext,p=this._dpiScale;for(y.clearTestHooksLog(y.LabelDrawOrderTag),n=0,a=d.length;n<a;n++)if(s=h[d[n]],(o=Object.keys(s)).length)for(r=0,l=o.length;r<l;r++){var g=o[r],u=s[g],_=Object.keys(u);_.length?this._drawLabelsInLayer(u,_,e,t,c,p,i):delete s[g]}else delete h[d[n]]},xe.prototype._renderHitTesting=function(e,t,i,n){var e=e[0].getHitTestShape(),a={primitive:t,target:i.independentHotRegions?1:0},i=n.bounds.getBoundingBoxRelativeTo(n.anchor),n=i.getSize(),s=i.minPoint,o=n.width,r=n.height;switch(e){case 2:this._hitTestIndex.addRectangle(a,s.x,s.y,o,r);break;case 1:this._hitTestIndex.addEllipse(a,s.x+o/2,s.y+r/2,o,r)}},xe.prototype._drawLabelsInLayer=function(e,t,i,n,a,s){for(var o,r,l,h,d,c,p=t.length-1;0<=p;p--){o=e[t[p]],y.logLabelDrawOrder(o.text);var g=o.region,u=g.label.data.primitives[0],_=o.iconTemplates;if(!i||(c=_&&_[0],r=!1,(r=(r=u?L.getClickable(u.entity)||u.isTapEnabled&&u.isTapEnabled():r)||c&&c.getIsHitTestable())&&u&&u.layer))if(1===g.type){if(l=g.anchor,_&&_.length)if(i)this._renderHitTesting(_,u,o,g);else{for(y.logPoiLayerStyleStart(),h=0,d=_.length;h<d;h++)(c=_[h]).renderCanvas(a,{id:null,name:o.text},l.x*s,l.y*s,s,y.UserLogTag,u);y.logPoiLayerStyleEnd(y.UserLogTag),y.logPushpinPrimitive(y.UserLogTag,u)}}else o.style&&this._drawTextLabel(o,i,n)}},xe.prototype.cancelRender=function(){this._currentLabelRenderingContext=null},xe.prototype.draw=function(e){var t,i,n=this._acceptRenderable(e);return n&&(e.drawPriority=Math.round(1e3*(e.fontSize||0)),i=xe._labelKey(e),(t=this._orderedLabels[i])||(this._orderedLabels[i]=t={}),(i=t[e.labelZIndex])||(t[e.labelZIndex]=i={}),(i[e.id]=e).oldLabelZIndex=e.labelZIndex),n},xe.prototype.remove=function(e){var t,i=this._acceptRenderable(e);return i&&((t=(t=this._orderedLabels[xe._labelKey(e)])&&t[e.oldLabelZIndex])&&delete t[e.id]),i},xe.prototype.update=function(e){var t,i,n=this._acceptRenderable(e);return n&&((t=(i=(i=this._orderedLabels[xe._labelKey(e)])&&i[e.oldLabelZIndex])?i[e.id]:t)&&(this.remove(t),this.draw(e))),n},xe._size=function(e){var t=e.size;return t||(t=1===(e.region&&e.region.type||0)?G.getIconBounds(e.iconTemplates,e.text).getSize():xe.getTextSize(e.text,e.secondaryText,e.style,e.fontSize,e.secondaryFontSize,e.lineWidths))&&t.width&&t.height&&(e.size=t),t},xe._labelKey=function(e){return 1e6*(e.layerZIndex||0)+e.drawPriority},xe._getSortedPriorityKeys=function(e){for(var t,i,n=0,a=!0,s=0,o=e.length;s<o;s++){if((i=parseInt(e[s]))<n){a=!1;break}n=i}if(a)return e;for(t=[],s=0,o=e.length;s<o;s++)m._orderedInsert(t,e[s],null,function(e){return parseInt(e)});return t},xe.getTextSize=function(e,t,o,i,n,r){function a(e,t){var i,n,a,s;if(e)for(t=xe.createFont(t,o),p=p||N.getLineHeight(t),i=e.split("\n"),l.setFont(t),n=0,a=i.length;n<a;n++)s=h.measureText(i[n]).width,r&&r.push(s),d=Math.max(d,s),c+=p}var l=xe._scratchContext,h=l.getRawContext(),d=0,c=0,p=0;return r&&(r.length=0),a(e,i),a(t,n),new O(d,c)},xe.prototype.invalidateHitTestingData=function(){this._hitTestIndexValid=!1},xe.prototype.performHitTesting=function(e,t){this._hitTestIndexValid||this._renderHitTestData();var i=this._hitTestIndex.hitTest(t),t=!1;return i&&i.primitive&&(e.primitive=i.primitive,e.hitTarget=i.target,e.layer=i.primitive.layer,t=!0),t},xe.prototype._addCanvas=function(){var e;this._require2DCanvas()&&!this._drawingContext&&(this._drawingContext=new N,(e=this._canvas=this._drawingContext.getRootElement()).set_attr("id","labelCanvasId"===this._canvasId?this._canvasId:this._canvasId+"2d"),e.set_attr("class","labelCanvas"),e.set_style({outline:"none",position:"absolute",zIndex:this._canvasZIndex}),this._map.getMode().getRootElement().append(e),this._context=this._drawingContext.getRawContext())},xe.prototype._positionCanvas=function(e){var t,i,n,a,s,o=this._map.getActualSize();return this._require2DCanvas()?(s=300,(a=this._map.getMapOptions()).isPrintMode?s=0:(a.liteMode||1<m._getDpr())&&(s=100),t=this._widthPadding=Math.min(s,Math.ceil(.75*o.width)),i=this._heightPadding=Math.min(s,Math.ceil(.75*o.height)),n=this._dpiScale,a=o.width+2*t,s=o.height+2*i,this._drawingContext.setSize(n*a,n*s),e||this._canvas.set_style({top:-i+"px",left:-t+"px","-webkit-transform":"translate(0px, 0px)",transform:"translate(0px, 0px)",display:"block"}),this._context.translate(n*t,n*i)):this._canvas&&this._canvas.set_style({display:"none"}),o},xe.prototype._renderHitTestData=function(){var e,t,i;this._validate2DCanvas()?(e=(t=this._drawingContext).getSize(),i=this._dpiScale,this._hitTestIndex.reset(e.width/i,e.height/i),t.save(),this._drawLabels(!0),t.restore()):(e=this._map.getActualSize(),this._hitTestIndex.reset(e.width,e.height),this._drawLabels(!0)),this._hitTestIndexValid=!0},xe.prototype._renderTextLabel=function(e,t,i,n,a){var s,o=e.region,r=this._drawingContext,l=!a&&r.getRawContext(),h=e.style,d=n,c={labels:[]},p=o.textSpans&&0<o.textSpans.length?xe.createFont(o.textSpans[0].f*d,h):xe.createFont(e.fontSize*d,h);switch(a||r.setFont(p),n=o.horizontalAlignment){default:case 1:s="left";break;case 0:s="center";break;case 2:s="right"}return a||(l.textAlign=s),o.textSpans?this._drawTextWithHints(l,e,p,d,n,h,t,i,a,c):a?this._drawTextWithoutHints(r,e,o,p,d,n,h,t,i,a,c):(r.save(),a=this._drawTextWithoutHints(r,e,o,p,d,n,h,t,i,a,c),r.restore(a)),c},xe.prototype._getTextLabelData=function(e,t,i,n){return this._renderTextLabel(e,t,i,n,!0)},xe.prototype._drawTextLabel=function(e,t,i){this._renderTextLabel(e,t,i,this._dpiScale,!1)},xe.prototype._drawTextWithHints=function(e,t,i,n,a,s,o,r,l,h){var d,c,p,g,u,_,y,f,m,b=t.region,v=b.textSpans,x=v[0].x,L=v[0].y,w=s.styleStatic,R=s.styleDynamic,T=!l&&e.font,C=!1,S=v[0].f,D=i;for(w.fontOutlined&&(d=R.outlineColor,c=w.outlineWidth*n),p=0,g=v.length;p<g;p++)(u=v[p]).n&&(y=xe._prepareTextRenderingResult(a,s,t,p,u,x,L,d,c,n),o?(m={primitive:(f=b.label.data).primitives[0],target:f.independentHotRegions?2:0},this._hitTestIndex.addRectangle(m,y.x,y.y,y.w,y.h)):(y.x*=n,y.y*=n,y.relativePlacement=W.bottom,(_=u.f&&u.f!==S)&&(S=u.f,D=xe.createFont(S*n,s)),y.font=D,l||(f=y.x,m=y.y,0===a?f+=n*(y.w/2):2===a&&(f+=n*(y.w-3)),e.textBaseline=y.textBaseline,_&&(C=!0,e.font=y.font),0!==y.rotation?(e.save(),e.translate(f,m),e.rotate(y.rotation),xe._strokeAndFillText(e,s,u.n,0,0,r,null,null,d,c),e.restore()):xe._strokeAndFillText(e,s,u.n,f,m,r,null,null,d,c)),h.labels.push(y)));!l&&C&&(e.font=T)},xe.prototype._drawTextWithoutHints=function(e,p,g,t,u,_,y,f,m,b,v){function i(e,t,i){for(var n,a,s,o,r,l,h=e?e.split("\n"):[],d=0,c=h.length;d<c;d++,j++){if(n=h[d],(f||b)&&(a=H[j]||xe.getTextSize(n,"",y,p.fontSize,0).width),f){switch(H[j]=a,o=-2,g.horizontalAlignment){case s=0:s=-a/2;break;case 2:s=-a}switch(P){case W.middle:o=-C/2;break;case W.top:o=2-C}l={primitive:g.label.data.primitives[0],target:t},E.addRectangle(l,s+S.x+D.x,o+S.y+D.y+B,a,C)}else r=u*B,b||xe._strokeAndFillText(T,y,n,0,r,m,k,F,A,z),l=x,0===_?l-=u*a/2:2===_&&(l-=u*a),v.labels.push({style:y,text:n,anchorOffetX:w,anchorOffetY:R+r,x:l,y:L,w:a,h:C,rotation:g.orientation,relativePlacement:P,font:i,outlineColor:A,outlineSize:z,glowColor:k,glowSize:F,background:O,horizontalAlignment:_,resetFont:I,textBaseline:M});B+=C}}var x,L,w,R,T=!b&&e.getRawContext(),n=xe._size(p),C=N.getLineHeight(t)/u,S=g.anchor,D=Z._getTextAnchorOffset(p,n),I=!1,P=g.placement&W.verticalMask,a=xe._getVerticalAdjustment(P),M=a.textBaseline;D.y+=C*a.verticalAdjustmentRatio,b||(T.textBaseline=M);var k,F,A,z,s=y.styleStatic,o=y.styleDynamic,n=s.showBackground,a=this._labelOptions,O=null;this._labelOptions.testRenderStyles&&n?(k=a.glowColor,F=k&&a.glowSize,A=a.outlineColor,z=A&&a.outlineSize*u,n=!1):s.fontOutlined&&(A=o.outlineColor,z=s.outlineWidth||1),!f&&n&&(n=g.bounds.getBoundingBoxRelativeTo(S),O=xe._renderTextBackground(T,u,s,n,b)),x=u*S.x,L=u*S.y,b||T.translate(x,L),!b&&g.orientation&&T.rotate(g.orientation),w=u*D.x,R=u*D.y,b||T.translate(w,R);var B=0,H=p.lineWidths=p.lineWidths||[],j=0,E=this._hitTestIndex;return i(p.text,p.independentHotRegions?2:0,t),p.secondaryText&&(t=xe.createFont(p.secondaryFontSize*u,y),b||e.setFont(t),I=!0,i(p.secondaryText,p.independentHotRegions?3:0,t)),I},xe.prototype._require2DCanvas=function(){return-1<this._renderEntityTypes.indexOf(1)&&(!m._renderAllPoiAndLabelsGL()||this._taintedTemplatesExists)},xe.prototype._validate2DCanvas=function(){var e=this._require2DCanvas();return e&&!this._canvas&&(this._addCanvas(),this._positionCanvas(!1)),e},xe.prototype._acceptRenderable=function(e){function t(){return 1===n.type||!!e.style}var i,n=e.region;try{i=-1<this._renderEntityTypes.indexOf(2)?c._MicroPoiEntity&&n.label.data.primitives[0].entity instanceof c._MicroPoiEntity:t()}catch(e){i=t()}return i},xe._strokeAndFillText=function(e,t,i,n,a,s,o,r,l,h){i=1===t.styleDynamic.fontCaps&&i.toLocaleUpperCase?i.toLocaleUpperCase():i;var d=e.lineWidth,c=e.strokeStyle;s||(o&&r&&(e.shadowColor=o,e.shadowBlur=r),l&&h&&(e.strokeStyle=l,e.lineWidth=h,e.strokeText(i,n,a))),e.fillStyle=t.styleDynamic.fontColor,t.styleStatic.strataStyle&&t.styleStatic.strataStyle.alpha&&t.styleStatic.strataStyle.alpha<1&&(e.globalAlpha=t.styleStatic.strataStyle.alpha),e.fillText(i,n,a),e.globalAlpha=1,e.lineWidth=d,e.strokeStyle=c,e.shadowBlur=0},xe.createFont=function(e,t){var i=t.styleDynamic,n=1!==i.fontStyle||xe._nonItalicMarket?"":"italic",t=2===i.fontCaps?"small-caps":"",a="",s=i.font;if(i.fontWeight)switch(i.fontWeight){case 4:a="bold";break;case 1:a="lighter";break;case 3:"segoebing"!==s.toLowerCase()&&(a="600")}return[n,t,a,e+"pt",V.getDefaultFontFamily(s)].join(" ")},xe._prepareTextRenderingResult=function(e,t,i,n,a,s,o,r,l,h){var d=i.region,c=d.anchor.x+d.anchorOffset.x+(a.x-s),s=d.anchor.y+d.anchorOffset.y+(a.y-o),d=i.lineWidths||[],p=parseFloat(a.w),g=p;if(x.useSegoeFontStack||(d[n]||(o=1===t.styleDynamic.fontCaps&&a.n.toLocaleUpperCase?a.n.toLocaleUpperCase():a.n,o=xe.getTextSize(o,"",t,a.f,0).width,o+=f.Browser.is_safari&&1<h?10:0,d[n]=Math.max(g,o)),g=d[n]),g!==p)switch(e){case 2:c-=g-p;break;case 0:c-=(g-p)/2}return n=(f.Browser.is_edge||f.Browser.is_ie||f.Browser.is_safari)&&m._renderAllPoiAndLabelsGL()?xe._size(i).height:parseFloat(a.h),i=parseFloat(a.a),i=isNaN(i)?0:i,{style:t,text:a.n,x:c,y:s,anchorOffetX:0,anchorOffetY:0,w:g,h:n,rotation:i,outlineColor:r,outlineSize:l,font:null,horizontalAlignment:e,resetFont:!1,textBaseline:"top"}},xe._renderTextBackground=function(e,t,i,n,a){var s=i.backgroundColor,o=i.backgroundOutlineColor,r=i.backgroundOutlineWidth*t,l=Math.floor(n.minPoint.x),h=Math.floor(n.minPoint.y)+2,d=Math.ceil(n.maxPoint.x-l),c=Math.ceil(n.maxPoint.y-h);return l*=t,h*=t,d*=t,c*=t,a||(s&&(e.fillStyle=s,e.fillRect(l,h,d,c)),o&&r&&(e.strokeStyle=o,e.lineWidth=r,e.strokeRect(l,h,d,c))),{bound:n,scale:t,styleStatic:i}},xe._getVerticalAdjustment=function(e){var t,i;switch(e){default:case W.bottom:t="top",i=0;break;case W.middle:t="middle",i=.5;break;case W.top:t="bottom",i=1}return{textBaseline:t,verticalAdjustmentRatio:i}},xe._scratchContext=new N,xe);q.init(),ve.prototype.reset=function(e,t){this._index.reset(e,t),this._occludedIndex.reset(e,t)},ve.prototype.addLabels=function(e){for(var t,i,n,a,s,o,r,l=0,h=e.length;l<h;l++)if((t=e[l]).shouldBeRendered)for(n=0,a=(i=t.getRegions()).length;n<a;n++)(s=i[n]).id=s.id||ve._regionId++,s.isFixed&&(o=!0,(o=1===s.type?(r=t.data.primitives[0].layer)&&0!==P.getValue(r,"renderTarget"):o)&&t.placedRegions.push(s),!s.occludesOthers)||(s.occludesOthers?this._occludedIndex:this._index).add(s,s.bounds.bbox)},ve.prototype.addRenderables=function(e){for(var t,i=0,n=e.length;i<n;i++)t=e[i].region,this._index.add(t,t.rect)},ve.prototype.getOverlappingRegions=function(e){return this._getOverlappingRegions(e,this._index)},ve.prototype.getOverlappingOccludedRegions=function(e){return this._getOverlappingRegions(e,this._occludedIndex)},ve.prototype._getOverlappingRegions=function(e,t){for(var i,n,a=e.rect,s=t.getOverlappingRegions(a||e.bounds.bbox),o=[],r={},l=0,h=s.length;l<h;l++)r[(i=s[l]).id]||(n=!1,(n=!i.isRejected&&i.label.id!==e.label.id?a?a.intersects(i.rect):e.bounds.intersects(i.bounds):n)&&o.push(i),r[i.id]=!0);return o},ve.prototype.getRegions=function(e,t){return this._index.getRegions(e,t)},ve.prototype.getHeight=function(){return this._index.getHeight()},ve.prototype.getWidth=function(){return this._index.getWidth()},ve._regionId=0,e=ve,be.prototype.add=function(e){this.bounds.push(e),this.bbox.union(e.bbox),this._refreshArbb()},be.prototype.getBoundingBoxRelativeTo=function(e){var t=this.anchorRelativeBoundingBox;return t=e&&!t.isEmpty()?new F(t.minPoint.add(e),t.maxPoint.add(e)):t},be.prototype.setAnchor=function(e){this.anchor=e&&e.clone(),this._refreshArbb()},be.prototype._refreshArbb=function(){var e=this.anchor;this.anchorRelativeBoundingBox=e&&!this.bbox.isEmpty()?new F(this.bbox.minPoint.subtract(e),this.bbox.maxPoint.subtract(e)):F.empty()},be.prototype.intersects=function(e){var t,i,n,a,s,o;if(!this.bbox.intersects(e.bbox))return!1;for(t=0,i=this.bounds.length;t<i;t++)for(n=this.bounds[t],a=0,s=e.bounds.length;a<s;a++)if(o=e.bounds[a],n.intersects(o))return!0;return!1},p=be,(s=W=W||{})[s.none=0]="none",s[s.top=1]="top",s[s.middle=2]="middle",s[s.bottom=4]="bottom",s[s.verticalMask=15]="verticalMask",s[s.left=16]="left",s[s.center=32]="center",s[s.right=64]="right",s[s.horizontalMask=240]="horizontalMask",s[s.topLeft=17]="topLeft",s[s.topCenter=33]="topCenter",s[s.topRight=65]="topRight",s[s.middleLeft=18]="middleLeft",s[s.middleCenter=34]="middleCenter",s[s.middleRight=66]="middleRight",s[s.bottomLeft=20]="bottomLeft",s[s.bottomCenter=36]="bottomCenter",s[s.bottomRight=68]="bottomRight";var Q=(me.prototype.computeRenderables=function(e,t,i){var n,a,s={},o=[],r=0,l=0,h=i.pixelWidth,d=i.pixelHeight,c=F.fromSides(0,h,0,d),p=F.fromSides(-h/2,1.5*h,-d/2,1.5*d);for(n in me._addLabelsToCache(s,e),d=Date.now(),s)if(s.hasOwnProperty(n)){if((a=s[n]).data.dirty&&0===a.data.primitives.length)delete s[a.id];else{if(a.reset(),!a.data.style)continue;a.initializePosition(i,t),me._isInDisplay(a,c,p)&&(o.push(a),l++)}r++}return h=Date.now()-d,r!==l&&y.log(null,"CollisionManager: received {0} labels out of which {1} in display, {2} outside display",r,l,r-l),e=Date.now(),this._sortByXsrPriority(o),e=Date.now()-e,this._index.reset(i.pixelWidth,i.pixelHeight),this._index.addLabels(o),d=Date.now(),this._doFirstPlacementPass(o),h={sortTime:e,collisionTime:Date.now()-d,initializePositionTime:h},this._index.reset(0,0),{renderables:this._createRenderables(o),diagnosticArgs:h,landmarksCount:this._landmarksCount,landmarkDealsCount:this._landmarkDealsCount}},me._addLabelsToCache=function(e,t){for(var i,n=0,a=t.length;n<a;n++)(i=t[n]).data&&i.data.primitives&&i.data.primitives[0]&&!i.data.primitives[0].isDisposed&&(e[i.id]=i)},me.prototype._sortByXsrPriority=function(e){e.sort(function(e,t){var i,n=e.data,a=t.data,s=n.drawOrder||0,o=a.drawOrder||0,r=n.priorityGroup===_.poiStylePriorityGroup,l=a.priorityGroup===_.poiStylePriorityGroup;if(r&&l)return n.priority-a.priority||s-o;if(r)return-1;if(l)return 1;var e=n.style.styleStatic.strataStyle,t=a.style.styleStatic.strataStyle,r=e&&e.alpha&&e.alpha<1,l=t&&t.alpha&&t.alpha<1;if(r&&!l)return-1;if(l&&!r)return 1;if(e=parseInt(n.entityId),t=parseInt(a.entityId),0!==n.priorityGroup&&0!==a.priorityGroup&&n.priorityGroup===a.priorityGroup)return s-o||e-t;if(n.priority!==a.priority)return n.priority-a.priority;if(l=n.lowImportanceCollisionPadding,r=a.lowImportanceCollisionPadding,0===l&&0!==r)return-1;if(0!==l&&0===r)return 1;if(n=n.labelImportance,a=a.labelImportance,-1!==n&&-1===a)return-1;if(-1===n&&-1!==a)return 1;if(-1!==n&&-1!==a){if(n!==a)return n-a;if(0!=(i=l-r))return i}return s-o||e-t});for(var t=0;t<e.length;t++)e[t].placementPriority=t},me.prototype._doFirstPlacementPass=function(e){for(var t,i,n,a,s,o,r=0,l=e.length;r<l;r++){var h=e[r],d=h.getRegions(),c=null,p=!1;if(x.debugLabels&&d.length)Array.prototype.push.apply(h.placedRegions,d);else{for(t=0,i=d.length;t<i;t++)if(a=(n=d[t]).parentRegion,!(n.isRejected||n.isFixed||a&&a.isRejected)&&(1!==n.type||h.data.iconTemplates)){if(a?c===a&&(p=!0):(c&&!c.isFixed&&p&&(c.isRejected=!0),c=n,p=!1),0<this._index.getOverlappingOccludedRegions(n).length){n.isRejected=!0;continue}for(var g=this._index.getOverlappingRegions(n),u=g.length,_=!1;u--;){for(var y=g[u],f=y.label.placedRegions,m=f.length;m--;)if(f[m]===y){_=!0;break}if(_)break}if(_){n.isRejected=!0;continue}if(h.placedRegions.push(n),a){for(s=t+1;s<i;s++)(o=d[s]).isFixed||o.parentRegion!==a||(o.isRejected=!0);c=null}else if(h.replicaProximity)this._filterReplicas(n,t,h.replicaProximity,d);else for(s=t+1;s<i;s++)(o=d[s]).isFixed||o.parentRegion===n||(o.isRejected=!0)}c&&!c.isFixed&&p&&(c.isRejected=!0)}}},me.prototype._filterReplicas=function(e,t,i,n){var a,s,o,r=e.bounds.bbox.clone();for(r.buffer(i,i),a=t+1,s=n.length;a<s;a++)(o=n[a]).isFixed||o.isRejected||o.parentRegion||!r.intersects(o.bounds.bbox)||(o.isRejected=!0)},me.prototype._createRenderables=function(e){for(var t,i,n=[],a=0,s=0,o=0,r=e.length;o<r;o++){for(var l=e[o],h=l.data,d=l.placedRegions,c=[],p=0,g=d.length;p<g;p++)(t=d[p])&&!t.isRejected&&(t=l.lastUsedRegion(t),i=h.primitives[0],L.isLandmarkEntity(i.entity)&&t.type&&1===t.type&&(a++,i.entity.landmarksDealFlag&&s++),n.push({id:t.id.toString(),type:h.type,text:t.text,secondaryText:t.secondaryText,independentHotRegions:h.independentHotRegions,lineWidths:l.lineWidths,labelId:l.id,region:t,geometryType:i.geometryType,iconTemplates:h.iconTemplates,style:h.style,fontSize:h.fontSize,secondaryFontSize:h.secondaryFontSize,layerZIndex:i.layer&&parseInt(i.layer.getZIndex()),labelZIndex:i.zIndex||0}),c.push(t));for(l.lastUsedRegions=c,p=0,g=(d=l.regions).length;p<g;p++)(t=d[p]).bounds.bounds=[];l.regions=[]}return this._landmarksCount=a,this._landmarkDealsCount=s,n},me._isInDisplay=function(e,t,i){for(var n,a=e.getRegions(),s=!1,e=e.data,e=e&&e.primitives&&e.primitives[0],o=e&&e.hasVectorIcon&&e.hasVectorIcon()&&1===e.entity.collisionBehavior?i:t,r=0,l=a.length;r<l;r++)n=a[r],o.intersects(n.bounds.bbox)?s=!0:n.isRejected=!0;return s},me),J=(Y(fe,a=G),fe.prototype.initializePosition=function(e,t){var i=this.data;i.style.styleStatic.wrapDisplayName&&i.text&&(i.text=te.wrapText(i.text)),a.prototype.initializePosition.call(this,e,t)},fe.prototype._initializeLabelRegions=function(e){var t=this.data,i=new D(t.crs,e),n=t.primitives[0],e=n.entity&&n.entity.labelHint;if(e)e=(t=e.lbl)[0],t&&0<t.length&&e.tps&&0<e.tps.length&&(e=e.tps[0],i.project(e.x||0,e.y||0));else{if(!(n=n.geometry))return;i.project(n.x,n.y)}(i=this._getIconRegion(i.lastProjectedX,i.lastProjectedY))&&this.regions.push(i)},fe.prototype._getIconRegion=function(e,t){var i,n,a=this.data.iconTemplates,s=this.data.imageWidth,o=this.data.imageHeight;return s&&o||!a||!a[0]||(s=(a=(n=G.getIconBounds(a,this.data.iconText)).getSize()).width,o=a.height,n=new k(n.maxPoint.x-s/2,n.maxPoint.y-o/2)),s&&o&&(i={type:1,label:this,text:this.data.iconText,anchor:new k(e,t),anchorOffset:n,size:new O(s,o),placement:W.middleCenter},0!==(n=(n=this.data.primitives[0].entity)&&n.collisionBehavior||0)&&(i.isFixed=!0),2===n&&(i.occludesOthers=!0),this.data.offsetX||(this.data.offsetX=s/2+fe._defaultIconLabelOffset),this.data.offsetY||(this.data.offsetY=o/2+fe._defaultIconLabelOffset)),i},fe._defaultIconLabelOffset=2,fe),$=(ye.prototype.collide=function(e,t){for(var i,n=[],a=Object.keys(e),s=0,o=a.length;s<o;s++)(i=e[a[s]].region).rect=i.bounds.getBoundingBoxRelativeTo(i.anchor),i.isRejected=!1,n.push(e[a[s]]);this._scaledViewportWidth=t*this._collisionMapScale,t=Math.ceil(t/32*this._collisionMapScale),this._sort(n),this._collide(n,t)},ye.prototype._collide=function(e,t){this._collideGroup(e,t,!0),this._collideGroup(e,t,!1),this._collisionMap=[]},ye.prototype._collideGroup=function(e,t,i){for(var n,a,s,o,r,l=this._collisionMapScale,h=0,d=e.length;h<d;h++)o=(r=e[h].region).rect,n=Math.ceil((o.minPoint.x-this._bufferSizeAroundRenderables)*l),a=Math.floor((o.maxPoint.x+this._bufferSizeAroundRenderables)*l),s=Math.ceil((o.minPoint.y-this._bufferSizeAroundRenderables)*l),o=Math.floor((o.maxPoint.y+this._bufferSizeAroundRenderables)*l),n=Math.min(n,a),s=Math.min(s,o),n<0||a>this._scaledViewportWidth?r.isRejected=!0:!!r.occludesOthers!==i||r.isRejected||(r.occludesOthers||!this._isOverlappingRegion(n,a,s,o,t)?this._updateCollisionMap(n,a,s,o,t):r.isRejected=!0)},ye.prototype._updateCollisionMap=function(e,t,i,n,a){this._isOverlappingRegionOrUpdateCollisionMap(e,t,i,n,a,!0)},ye.prototype._isOverlappingRegion=function(e,t,i,n,a){return this._isOverlappingRegionOrUpdateCollisionMap(e,t,i,n,a,!1)},ye.prototype._isOverlappingRegionOrUpdateCollisionMap=function(e,t,i,n,a,s){for(var o,r,l,h=e/32>>0,d=t/32>>0,e=e%32,c=-1<<e>>>e,p=-2147483648>>t%32,g=c&p,u=!1,_=this._collisionMap,y=h;y<=d;y++)for(o=i;o<=n;o++)if(l=_[r=a*o+y]||0,h==d?s?l|=g:u=0!=(l&g):y===h?s?l|=c:u=0!=(l&c):y===d?s?l|=p:u=0!=(l&p):s?l=-1:u=!!l,s)_[r]=l;else if(u)return!0;return u},ye.prototype._sort=function(e){e.sort(function(e,t){return t.drawPriority-e.drawPriority})},ye),ee=(Y(_e,o=M),_e.prototype.attach=function(e){var t=this;this._map=e,this._labelUserMapLayers=this.getIsLabelsSupported(),this._mapEvents.push(this._map.changed.add(function(e){"mode"===e.name&&t._onMapModeChanged(e.newValue)})),this._mapEvents.push(this._map.mapTypeChangeStarted.add(function(e){t._onMapTypeChangeStarted(e)}))},_e.prototype.getIsLabelsSupported=function(){return!this._map.getMode()||this._isSupportedMapTypeForLabels(this._map.getMapType().id)&&this._isSupportedMapModeForLabels(this._map.getMode().mapModeType)},_e.prototype.getBaseTemplateName=function(){return this._templateName},_e.prototype.SetAnimationState=function(e){this._isInAnimation=e},_e.prototype.dispose=function(){this._shutDown(),o.prototype.dispose.call(this),this._hitTestController=null,clearTimeout(this._invalidatedTimerId),m._clearDisposables(this._mapEvents),m._clearDisposables(this._frameMangerEventHandlers),m._disposeEvents(this)},_e.prototype._onFrameSet=function(e){var t;this._isInAnimation||(t=e.frame,this._currentLabelRenderingContext&&this._currentLabelRenderingContext.frame&&(e=this._labeler&&this._labeler.cancelProcessingForFrame(this._currentLabelRenderingContext.frame),this._vectorLabels&&this._vectorLabels.cancelRender(this._currentLabelRenderingContext),e&&this._previousFrameData&&this._previousFrameData.frame.frameNumber===this._currentLabelRenderingContext.frame.frameNumber&&(this._previousFrameData=null)),this._finalVectorLabelRenderCompleteHandler&&this._finalVectorLabelRenderCompleteHandler.dispose(),this._finalVectorLabelRenderCompleteHandler=null,this._currentLabelRenderingContext={frame:t,paintId:0},this._isFinalPaintInitiated=!1)},_e.prototype.performHitTesting=function(e,t){this._vectorLabels&&!this._isShutDown&&this._vectorLabels.performHitTesting(e,t)},_e.prototype._constructVectorLabel=function(){return new re(this._map)},_e.prototype._initLabelRenderer=function(){this._vectorLabels&&this._vectorLabels.dispose(),this._vectorLabels=this._constructVectorLabel()},_e.prototype._bootStrap=function(){var t=this;this._isShutDown&&(this._isShutDown=!1,this._hitTestController&&this._hitTestController.addComponent(this)),this._isTemplateReady=!1,this._subscribeToFrameManagerEvents(),this._map.getTemplateSelector().then(function(e){return t._templateSelector=e,t._templateName=(e.getName()||"").toUpperCase(),e.selectorReady()}).then(function(e){!t._isShutDown&&e&&t._templateSelector&&e.getName()===t._templateSelector.getName()&&(t._isTemplateReady=!0,t._onTemplateReady.invoke(),t._onTemplateSelectorReady())})},_e.prototype._onTemplateSelectorReady=function(){this._isShutDown||(y.log(null,"Hooking up LabelController to FrameManager and CompositeMode events"),this._createLabeler(),this._initLabelRenderer())},_e.prototype._shutDown=function(){this._isShutDown||(m._clearDisposables(this._disposables),m._clearDisposables(this._frameMangerEventHandlers),this._templateSelector=null,this._isInitialLoadingComplete=!1,this._labeler=null,this._vectorLabels&&(this._vectorLabels.dispose(),this._vectorLabels=null),this._hitTestController&&this._hitTestController.removeComponent(this),this._isShutDown=!0)},_e.prototype.getViewport=function(){return this._map.getMode().getCurrentCrsViewport()},_e.prototype.copyCanvas=function(e){this._vectorLabels&&this._vectorLabels.copyCanvas(e)},_e.prototype.renderLabels=function(e,t){var i=this;this._currentLabelRenderingContext&&this._currentLabelRenderingContext.frame&&((this._isFinalPaintInitiated||this._labelInvalidated)&&y.clearTestHooksLog(y.UserLogTag),this._currentLabelRenderingContext={frame:this._currentLabelRenderingContext.frame,paintId:this._currentLabelRenderingContext.paintId++},this._vectorLabels||this._initLabelRenderer(),this._isFinalPaintInitiated&&(this._labelingDiagnostics.renderingTime=Date.now(),this._finalVectorLabelRenderCompleteHandler=this._vectorLabels.renderingComplete.add(function(e){e.labelRenderingContext&&e.labelRenderingContext.frame&&i._currentLabelRenderingContext&&i._currentLabelRenderingContext.frame&&e.labelRenderingContext.frame.frameNumber===i._currentLabelRenderingContext.frame.frameNumber&&e.labelRenderingContext.paintId===i._currentLabelRenderingContext.paintId&&(i._labelingDiagnostics.totalLabelingTime+=e.delayedRenderingTime,i._labelingDiagnostics.delayedRenderingTime=e.delayedRenderingTime,i._finalVectorLabelRenderCompleteHandler&&i._finalVectorLabelRenderCompleteHandler.dispose(),i._finalVectorLabelRenderCompleteHandler=null,i._completeLabelRenderingPhase())})),this._vectorLabels.render(e,this._currentLabelRenderingContext,this._labelingDiagnostics,t,this._labelInvalidated),this._labelInvalidated=!1,this._isFinalPaintInitiated&&(this._labelingDiagnostics.renderingTime=Date.now()-this._labelingDiagnostics.renderingTime,this._labelingDiagnostics.totalLabelingTime=Date.now()-this._labelingDiagnostics.totalLabelingTime,this._isFinalPaintInitiated=!1))},_e.prototype._subscribeToFrameManagerEvents=function(){var t=this,e=this._map.getFrameManager();0===this._frameMangerEventHandlers.length&&(this._isInitialLoadingComplete||(this._isInitialLoadingComplete=!0,e.frameSet.isPreviouslyInvoked&&this._onFrameSet(e.frameSet.lastInvokedArgs),e.dataLoaded.isPreviouslyInvoked&&this._showLabelsForFrameOnTemplateReady(e.dataLoaded.lastInvokedArgs.frame)),this._frameMangerEventHandlers.push(e.frameSet.add(function(e){t._onFrameSet(e)})),this._frameMangerEventHandlers.push(e.dataLoaded.add(function(e){t._showLabelsForFrameOnTemplateReady(e.frame)})))},_e.prototype._showLabelsForFrameOnTemplateReady=function(e){var t=this;this._isInAnimation||(this._isTemplateReady?this._showLabelsForFrame(e):this._onTemplateReady.addOne(function(){t._showLabelsForFrame(e)}))},_e.prototype._createLabeler=function(){var t=this;this._labeler||(this._disposables.push(this._labeler=new te(this,this._workDispatcher)),this._disposables.push(this._labeler.primitiveProcessingComplete.add(function(e){return t._primitiveProcessingComplete(e)})),this._disposables.push(this._labeler.labelsProcessed.add(function(e){return t._showLabels(e)})))},_e.prototype._isSupportedMapTypeForLabels=function(){return!0},_e.prototype._isSupportedMapModeForLabels=function(e){return 0===e},_e.prototype._showLabelsForFrame=function(t){var e,i,n=this;this._labelingDiagnostics={frameNumber:t.frameNumber},i=Date.now(),this._labelingDiagnostics.totalLabelingTime=i;this._map.getFrameManager();var a,s,o=this._getMapFrameData(),r=o&&o.getPrimitives(1,!0);r&&(a=this._map.getMapOptions().liteMode||_e._isNullDataRegionFrame(o),s={},o.getLayerFrameData().forEach(function(e){var t=e.layer,i=t&&t.getIconOnlyLimit();0<i&&((e=e.getPrimitives(1,!0))&&e.length>=i&&(s[t.getId()]=!0))}),this._labelingDiagnostics.primitiveCount=r.length,this._labelingDiagnostics.timeToAddStyles=Date.now(),e=this._fetchPrerequisites(r),this._previousFrameData=o,i=function(){var e;n._previousFrameData===o&&n._labeler&&!n._isInAnimation&&(e=n._map.getMode().getCurrentCrsViewport(),n.addStyle(r),n._labelingDiagnostics.timeToAddStyles=Date.now()-n._labelingDiagnostics.timeToAddStyles,n._labelingDiagnostics.labelDataProcessingTime=Date.now(),n._labeler.processData(t,r,s,e,n._map.getMercatorZoomLevel(),a),n._labelingDiagnostics.labelDataProcessingTime=Date.now()-n._labelingDiagnostics.labelDataProcessingTime)},Promise.all(e).then(i))},_e.isIconStyle=function(e){return e===_e._iconStyle},_e.prototype.addStyle=function(e){var t,i,n;if(e)for(t=this._map.getMercatorZoomLevel(),i=H.toScale(null,t,!0),n=e.length-1;0<=n;n--){var a=e[n],s=a.layer,o=s&&s.getTemplateSelector()||this._templateSelector;a.style=(o.getMarkupStyle?o:this._templateSelector).getMarkupStyle(a,i),L.isLandmarkEntity(a.entity)&&a.style&&(a.style.styleStatic.wrapDisplayName=!0),1===a.geometryType?(!s||0!==s.getRenderTarget()||a.entity&&2===a.entity.collisionBehavior)&&this._setMarkupStyle(a,o,i):a.iconTemplates=this._templateSelector.getFetchedShields(t,a.bucket,L.getShieldIndices(a.entity))}},_e.prototype._fetchPrerequisites=function(e){for(var t,i=this,n={},a={},s={},o=[],r=Array(),l=0,h=e.length;l<h;l++){var d,c,p=e[l],g=p.layer,u=g&&g.getTemplateSelector();1!==p.geometryType&&((d=L.getShieldIndices(p.entity))&&0<d.length&&o.push({bucketId:p.bucket,indexes:d}),!this._spatialMathRequested&&3===p.geometryType&&p.bucket&&p.entity&&!p.entity.labelHint&&L.getDisplayName(p.entity)&&(this._spatialMathRequested=!0,r.push(new Promise(function(e,t){i._map?i._map.getContainer().instanceAsync("SpatialMath",function(){e()}):t()})))),u&&(0!==g.getRenderTarget()||p.entity&&2===p.entity.collisionBehavior)&&(n[c=g.getId()]||(n[c]=!0,r.push(u.selectorReady())),d=p.bucket,(u=(c=g=p.entity)&&g.oid)?s[u]=!0:d&&(a[d]=!0),!(p.catId||g&&g.getSelectedCategoryForIcon)||(g=p.catId||g.getSelectedCategoryForIcon()||_.extractCategoryId(g.getPrimaryCategoryPath(),!0))&&((g=_.getBucketForCategory(g))&&(a[g]=!0),(g=(c=c&&c.getSearchCategory&&c.getSearchCategory())&&_.getBucketForCategory(c))&&(a[g]=!0)),!p.stylesheetEntry||(p=this._customMapStyleManager.getElementBucket(p.stylesheetEntry,p.geometryType))&&(a[p.toString()]=!0))}return 0<(t=Object.keys(a)).length&&r.push(this._templateSelector.prefetchImages(t)),0<(t=Object.keys(s)).length&&r.push(this._templateSelector.prefetchOrganizationImagesByOrgId(t)),0<o.length&&r.push(this._templateSelector.prefetchShields(o)),r},_e.prototype.invalidateLabels=function(){var e=this;clearTimeout(this._invalidatedTimerId),this._invalidatedTimerId=Microsoft.Maps.setTimeout(function(){e._labelInvalidated=!0,e.onLabelsProcessed.invoke(e._currentLabelRenderingContext.frame)},0)},_e.prototype._setMarkupStyle=function(e,t,i){i=e.iconTemplates=t.getTemplates(e,i);i&&i.length&&!e.style&&(e.style=_e._iconStyle)},_e.prototype._showLabels=function(e){var t=H.toScale(null,this._map.getMercatorZoomLevel(),!0);H.toScale(null,e.zoom,!0)===t&&(this._vectorLabels||this._initLabelRenderer(),this._vectorLabels.showLabels(e.labels,e.region),this._isFinalPaintInitiated=!0,this.invalidateLabels(),this._zoomLevelForLabelingPhase=this._map.getMercatorZoomLevel())},_e.prototype._getMapFrameData=function(){var e,t,i,n=this._map.getFrameManager(),a=n.getFrameData();if(this._labelBaseMapLayers||this._labelUserMapLayers){if(!this._labelBaseMapLayers||!this._labelUserMapLayers){for(var s=[],o=[],r=a.getLayerFrameData(),l=0;l<r.length;++l)t=(e=r[l]).layer,(_e._isBaseMapLayer(t)?o:s).push(e);i=this._labelBaseMapLayers?o:s,a=new R(n.getFrame(),i)}}else a=new R(n.getFrame(),[]);return a},_e._isBaseMapLayer=function(e){var t=!1,e=e.getDataSource&&e.getDataSource();return t=(e=e&&e instanceof w?e.getParentDataSource():e)&&e instanceof g?!0:t},_e.prototype._primitiveProcessingComplete=function(e){this._labelingDiagnostics.collisionSortTime=e.sortTime,this._labelingDiagnostics.collisionTime=e.collisionTime,this._labelingDiagnostics.primitiveChangeProcessingTime=e.primitiveChangeProcessingTime,this._labelingDiagnostics.computeRenderablesTime=e.computeRenderablesTime,this._labelingDiagnostics.initializePositionTime=e.initializePositionTime,this._labelingDiagnostics.landmarksCount=e.landmarksCount,this._labelingDiagnostics.landmarkDealsCount=e.landmarkDealsCount},_e.prototype._completeLabelRenderingPhase=function(){this.instrumentLabelingPass.invoke(this._labelingDiagnostics),this._labelingDiagnostics={},this._map.getFrameManager().completeLabelRenderingPhase(this._currentLabelRenderingContext.frame)},_e.prototype._onMapTypeChangeStarted=function(e){this.getIsLabelsEnabled()&&e.newMapTypeId!==e.oldMapTypeId&&(this._isSupportedMapTypeForLabels(e.newMapTypeId)?(this._templateSelector=null,this._bootStrap()):this._shutDown())},_e.prototype._onMapModeChanged=function(e){this.getIsLabelsEnabled()&&(this._isSupportedMapTypeForLabels(this._map.getMapType().id)&&this._isSupportedMapModeForLabels(e.mapModeType)?this._bootStrap():this._shutDown())},_e.prototype._onIsLabelsEnabledChanged=function(e,t){var i,n,a;if(this.getIsLabelsSupported())for(this._labelBaseMapLayers=t,this._bootStrap(),i=this._map.getBaseLayers(),n=0;n<i.length;n++)(a=i[n])instanceof U&&a.dataVersion++},_e.prototype._onIsUserLabelsEnabledChanged=function(e,t){e!==t&&this.getIsLabelsSupported()&&(this._labelUserMapLayers=t,this._bootStrap())},_e._isNullDataRegionFrame=function(e){for(var t,i,n,a=!1,s=0,o=e.getLayerFrameData(),r=0;r<o.length;++r)if(i=(t=o[r]).layer,_e._isBaseMapLayer(i)&&0<(n=t.getPrimitives(2,!0)).length)if(n[0].isNullDataRegionMarker){if(a=!0,0<s&&n.length!==s){a=!1;break}s=n.length}else a=!1;return a},_e._iconStyle={styleDynamic:{densityDistance:0,densityImportance:0,densityLodDelta:0,globalOrder:20,priority:0,font:"x",fontSize:1,fontColor:"x",visible:!0},styleStatic:{}},_e),te=(ue.prototype.processData=function(e,t,i,n,a,s){var o,r,l;if(t&&n){for(this._showLabelBackground=s,this._labelDataByLabelId={},this._disposeAllChangedHandlers(),this._currentFrame=e,o={type:0,frame:this._currentFrame,viewport:n,zoom:a,labels:[]},this._labelDrawOrder={},r=0,l=t.length;r<l;r++)this._associateLabelsWithPrimitive(t[r],i,o);this._postMessage(o)}},ue.prototype.cancelProcessingForFrame=function(e){var t=!!this._currentFrame;return this._postMessage({type:2,frame:e}),this._workDispatcher&&this._workDispatcher.cancelDispatchWithKey(this._getWorkDispatcherKeyForFrame(e),4),this._currentFrame=null,t},ue.prototype._getWorkDispatcherKeyForFrame=function(e){return ue._dispatchKey+e.frameNumber},ue.prototype._associateLabelsWithPrimitive=function(e,t,i){var n,a,s,o,r,l,h,d=e.layer&&e.layer.getId(),t=!(e.entity&&e.entity.alwaysShowLabel)&&d&&t[d],c=this._createLabelData(e,t);if(c&&c.length)for(e.labelIds=[],n=0,a=c.length;n<a;n++){for(s=c[n],e.labelIds[n]=s.labelId,o=ne.getKey(e,s),(r=this._labelDataByLabelId[o])?r.dirty=!0:(i.labels.push(r=s),this._labelDataByLabelId[o]=s),(d=e.layer&&e.layer.getId())&&(r.drawOrder=this._labelDrawOrder[d]||0,this._labelDrawOrder[d]=r.drawOrder+1),e.labelIds[n]=r.labelId,h=r.primitives.length;h--;)if(m._arePrimitivesEqual(r.primitives[h],e)){l=!0;break}l||r.primitives.push(e)}},ue.prototype.dispose=function(){m._clearDisposables(this._disposables),this._disposeAllChangedHandlers(),this._labelDataByLabelId={},this._worker=null,this._controller=null},ue.prototype._disposeAllChangedHandlers=function(){var t=this;Object.keys(this._changedHandlersByLabelId).forEach(function(e){return m._clearDisposables(t._changedHandlersByLabelId[e])}),this._changedHandlersByLabelId={}},ue.prototype._disposeChangedHandlers=function(e){m._clearDisposables(this._changedHandlersByLabelId[e]),delete this._changedHandlersByLabelId[e]},ue.prototype._processWorkerMessage=function(e){var t,i;if(1!==e.type)throw new Error("Unknown MessageType: "+e.type);for(var e=e,n={},a=e.renderables,s=0,o=a.length;s<o;s++){var r=a[s],l=r.labelId,h=this._labelDataByLabelId[l];h&&h.primitives&&h.primitives[0]&&!h.primitives[0].isDisposed&&((d=n[l])||(n[l]=d=[]),d.push(r))}for(s=0,i=(t=Object.keys(n)).length;s<i;s++){var d=n[l=t[s]],c=this._labelDataByLabelId[l],p=c.primitives[0],g=p.entity,u=this._updateExistingLabel.bind(this,d,c),c=[];g.changed&&c.push(g.changed.add(u)),p.changing&&c.push(p.changing.add(u)),this._disposeChangedHandlers(l),c.length&&(this._changedHandlersByLabelId[l]=c)}this._currentFrame=null,this.primitiveProcessingComplete.invoke(e.labelWorkerDiagnosticArgs),this._raiseLabelsProcessedEvent(e.region,e.renderables,e.zoom)},ue.prototype._updateExistingLabel=function(e,t,i){var n,a;this._controller&&(a=!1,(n=t.primitives[0])&&(i&&i.sender===n?"location"===i.name&&(this._updateLocation(e,t,i.newValue),a=!0):(this._updateStyle(e,t,n),this._updateZIndex(e,n),a=!0)),a&&this._controller.invalidateLabels())},ue.prototype._updateLocation=function(e,t,i){var n,a,s,o,r,l,h=this._controller.getViewport();if(h)for((h=new D(j.instance,h)).project(i.longitude,i.latitude),n=h.lastProjectedX,a=h.lastProjectedY,s=0,o=e.length;s<o;s++)(r=e[s].region)&&(l=new k(n,a),r.anchor=l,r.bounds&&r.bounds.setAnchor(l))},ue.prototype._updateStyle=function(e,t,i){var n,a,s;for(this._controller.addStyle(t.primitives),t.style=i.style,n=0,a=e.length;n<a;n++)(s=e[n]).style=t.style,s.lineWidths=[],s.size=null,s.iconTemplates=t.iconTemplates=i.iconTemplates&&i.iconTemplates.length?i.iconTemplates:null},ue.prototype._updateZIndex=function(e,t){for(var i=t.zIndex||0,n=0,a=e.length;n<a;n++)e[n].labelZIndex=i},ue.prototype._createLabelData=function(e,t){var i,n,a,s,o,r=e.entity;if(!e.entity||(i=e.style,!ue._isValidStyle(i)))return null;if(!e.entity.labelHint){var l=L.getLabelImportance(r),h=0;if(i.styleDynamic.visible&&i.styleDynamic.densityLodDelta&&i.styleDynamic.densityLodDelta!==X.markupVisible&&i.styleDynamic.densityLodDelta!==X.markupInvisible&&(i.styleDynamic.visible=0<=l?l<=255-i.styleDynamic.densityLodDelta*i.styleDynamic.densityImportance:i.styleDynamic.densityLodDelta<=(255-i.styleDynamic.densityImportance)/50+1,i.styleDynamic.visible&&(h=i.styleDynamic.densityLodDelta*i.styleDynamic.densityDistance+.5)),!i.styleDynamic.visible||2===e.geometryType&&e.geometry.x.length<2)return null}var d=L.getShieldIndices(r),c=d&&d.length&&L.getShieldNames(r),p=e.iconTemplates,g=c&&c.length&&p,u=L.isLandmarkEntity(r),_=!(!g||!g.length),y=p&&!!p[0],f=L.getDisplayName(r),m=f&&L.getSecondaryDisplayName(r),b=m&&L.independentHotRegions(r),v=L.getIconText(r),x=!1;if(!_||(l=(l=(l=e.entity.labelHint)&&l.lbl&&l.lbl[0])&&l.tps&&l.tps[0])&&l.n&&(x=!0,f=l.n),n=y&&!_&&(t||!f||p[0].hasText&&!v||ee.isIconStyle(i)),i.styleStatic.showBackground=this._showLabelBackground,!_&&1===i.styleStatic.shieldLabelVisibility||!f&&!_&&!n)return null;if(t=[],_&&(t=ue._createShieldLabelData(e,r,i,h,d,c,g),!x))return t;switch(1===i.styleDynamic.fontCaps&&(f=f.toUpperCase(),m=m.toUpperCase()),s=0,e.geometryType){case a=1:a=n?0:1,s=i.styleDynamic.priority,o=!n&&ue._getPointLabelType(u,y,e.bucket);break;case 3:a=3;break;case 2:a=2}n&&(v=v||f,m=f=null);g=i.styleDynamic.fontSize,x=i.styleDynamic.secondaryFontSize,p={labelId:null,entityId:r.id,bucket:e.bucket,primitives:[],crs:e.crs,lowImportanceCollisionPadding:h,labelImportance:L.getLabelImportance(r),fontSize:g,secondaryFontSize:x,priority:i.styleDynamic.globalOrder,text:f,secondaryText:m,independentHotRegions:b,iconText:v,type:a,pointType:o,priorityGroup:s,offsetX:i.styleStatic.offsetX,offsetY:i.styleStatic.offsetY,imageWidth:i.styleStatic.imageWidth,imageHeight:i.styleStatic.imageHeight,style:i,iconTemplates:y?p:null};return p.labelId=ne.getKey(e,p),t.push(p),t},ue._createShieldLabelData=function(e,t,i,n,a,s,o){var r,l,h,d,c,p=[];for(y.assert(!(!a||!a.length),"No shield indices"),y.assert(!(!s||!s.length),"No shield names"),y.assert(!(!o||!o.length),"No shield templates"),l=r=0;l<o.length;l++)o[l]&&r++;for(y.assert(a.length===s.length&&s.length===r,"Shield indices, names and templates don't match"),l=0,h=s.length;l<h;l++)c=L.getShieldDisplayData(s[l]),d=o[l],c&&c.text&&d&&((c={labelId:null,entityId:t.id,bucket:e.bucket,primitives:[],crs:e.crs,lowImportanceCollisionPadding:n,labelImportance:L.getLabelImportance(t),fontSize:i.styleDynamic.fontSize,priority:i.styleDynamic.globalOrder,text:c.modifier,iconText:c.text,type:4,priorityGroup:0,offsetX:i.styleStatic.offsetX,offsetY:i.styleStatic.offsetY,imageWidth:i.styleStatic.imageWidth,imageHeight:i.styleStatic.imageHeight,style:i,iconTemplates:[o[l]],shieldIndex:a[l],shieldCount:r,shieldInstance:l}).labelId=ne.getKey(e,c),p.push(c));return p},ue._getPointLabelType=function(e,t,i){switch(i){case _.pricePoiBucketId:case _.bucketIdForPoi:case _.bucketIdForDirectionsPins:case _.bucketIdForSelectedPoi:return 1;case _.bucketIdForTransientLensTop:return 2;case _.bucketIdForTransientLensBottom:return 3;case _.bucketIdForTransientLensLeft:return 4;case _.bucketIdForTransientLensRight:return 5;default:return t?1:0}},ue.wrapText=function(e,t){var i;if(t=t||ue._minWrapLength,e&&e.length>=t&&1<(i=e.split(/\s+/)).length){for(var t=e.length/2,n="",a="";i.length;){for(;i.length&&n.length<=a.length;)n=n+" "+i.shift();for(;i.length&&a.length<=n.length;)a=i.pop()+" "+a}Math.abs(n.length-a.length)<2*t/3&&(e=(n+"\n"+a).trim())}return e},ue.wrapTextToFit=function(e,t,i,n){if(t.width>i.width)if(2===(n=m._clamp(Math.round(t.width/i.width),2,n)))e=ue.wrapText(e,0);else{for(var a=Math.ceil(e.length/n),s=e.split(/\s+/),o=[],r="",l=!1,h=0,d=s.length;h<d;h++){var c=s[h],p=c.length,g=r.length+p+(l?1:0)-a;g<=p/2?(r=r+(l?" ":"")+c,l=!0,0<=g&&(o.push(r),r="",l=!1)):(o.push(r),r=c,l=!0)}r&&o.push(r),e=o.join("\n").trim()}return e},ue.prototype._raiseLabelsProcessedEvent=function(e,t,i){this.labelsProcessed.invoke({region:e,labels:t,zoom:i})},ue.prototype._postMessage=function(e){this.message.invoke(e)},ue._isValidStyle=function(e){return!!(e&&e.styleStatic&&e.styleDynamic.fontColor&&e.styleDynamic.fontSize&&e.styleDynamic.font)},ue.collisionAlphaThreshold=.58,ue._minWrapLength=20,ue._dispatchKey="Labeler:",ue),ie=(ge.prototype.dispose=function(){this._mainThreadMessageSubscription&&(this._mainThreadMessageSubscription.dispose(),this._mainThreadMessageSubscription=null)},ge.prototype._queueMessage=function(e){var t=this,i=this._getWorkDispatcherKeyForFrame(e.frame);2===e.type?this._workDispatcher.cancelDispatchWithKey(i,4):(this._messageQueue.push(e),this._workDispatcher.dispatch(function(){t._processMessage()},i,4))},ge.prototype._getWorkDispatcherKeyForFrame=function(e){return ge._dispatchKey+e.frameNumber},ge.prototype._processMessage=function(){var e,t=this;if(0!==this._messageQueue.length){if(0!==(e=this._messageQueue.shift()).type)throw new Error("Unknown MessageType: "+e.type);this._processPrimitivesChangedMessage(e),0<this._messageQueue.length&&(e=this._getWorkDispatcherKeyForFrame(this._messageQueue[0].frame),this._workDispatcher.dispatch(function(){t._processMessage()},e,4))}},ge.prototype._processPrimitivesChangedMessage=function(e){for(var t,i,n,a,s,o=Date.now(),r=[],l=0,h=e.labels.length;l<h;l++){switch(n=(t=e.labels[l]).type){case 0:i=new J(t);break;case 1:i=new se(t);break;case 2:i=new ae(t);break;case 3:i=new K(t);break;case 4:i=new oe(t,this._templateName);break;default:throw new Error("Unknown LabelType: "+n)}r.push(i)}a=Date.now(),s=this._collisionManager.computeRenderables(r,e.zoom,e.viewport),a=Date.now()-a,o=Date.now()-o,s.diagnosticArgs.computeRenderablesTime=a,s.diagnosticArgs.primitiveChangeProcessingTime=o,s.diagnosticArgs.landmarksCount=s.landmarksCount,s.diagnosticArgs.landmarkDealsCount=s.landmarkDealsCount,this._postMessage({type:1,frame:e.frame,region:e.viewport,renderables:s.renderables,labelWorkerDiagnosticArgs:s.diagnosticArgs,zoom:e.zoom})},ge.prototype._postMessage=function(e){this.message.invoke(e)},ge._dispatchKey="LabelerWorker:",ge),ne=(pe.getKey=function(e,t){var i=e.geometryType,n="g:"+i+"#"+("b:"+(t.bucket||"-1"))+"#"+("r:"+(e.revision||0))+"#"+("l:"+(e.layer&&e.layer.getId()||"0")),e=(t.iconText||"")+(t.text||"");return 4===t.type?"#S#"+t.shieldIndex+"#"+t.shieldInstance+"#"+t.shieldCount+"#"+e:2===i?n+"#"+e:n+"#"+t.entityId},pe),ae=(Y(ce,n=G),ce.prototype._initializeLabelRegions=function(e,t){var i,n,a;if(this.regions=this._getRegionsFromHints(e,t),!this.regions.length)for(n=0,a=(i=ce.getLongestSegments(this.data.primitives,ce._MAX_ALTERNATES)).length;n<a;n++){var s=i[n],o=s.x0,r=s.y0,l=s.x1,h=s.y1,s=new D(s.crs,e);s.project(o,r),o=s.lastProjectedX,r=s.lastProjectedY,s.project(l,h),l=s.lastProjectedX,h=s.lastProjectedY,this._addLinearLabelRegion(o,r,l,h)}},ce.prototype._addLinearLabelRegion=function(e,t,i,n){var a,s;i<e&&(s=e,e=i,i=s,s=t,t=n,n=s),a=Math.atan2(n-t,i-e),Math.abs(a-Math.PI/2)<=ce._VERTICAL_LABEL_TOLERANCE&&(a+=Math.PI,s=e,e=i,i=s,s=t,t=n,n=s),this.regions.push({label:this,text:this.data.text,anchor:new k((e+i)/2,(t+n)/2),placement:W.middleCenter,horizontalAlignment:0,orientation:a})},ce.getLongestSegments=function(e,t){for(var i,n,a,s,o=[],r=0,l=e.length;r<l;r++)for(a=0,s=(n=(i=e[r]).geometry).x.length-1;a<s;a++){var h=n.x[a],d=n.y[a],c=n.x[a+1],p=n.y[a+1];o[r]={x0:h,y0:d,x1:c,y1:p,crs:i.crs,weight:Math.abs(h-c)+Math.abs(d-p)}}return o.sort(function(e,t){return t.weight-e.weight}),o.length=Math.min(o.length,t),o},ce._MAX_ALTERNATES=3,ce._VERTICAL_LABEL_TOLERANCE=Math.PI/60,ce),se=(Y(de,t=J),de.prototype._calculatePlacements=function(){switch(this._placement=W.none,this.data.pointType){default:this._possiblePlacements=de._defaultLabelPlacements;break;case 1:case 5:this._possiblePlacements=de._poiLabelPlacements,this._hasBackground()||(this._padding=0);break;case 2:this._possiblePlacements=de._transientLensLabelTopPlacements;break;case 3:this._possiblePlacements=de._transientLensLabelBottomPlacements;break;case 4:this._possiblePlacements=de._transientLensLabelLeftPlacements;break;case 5:this._possiblePlacements=de._transientLensLabelRightPlacements}},de.prototype._getIconLocationFromHint=function(e){e=e.entity.labelHint,e=g.getAnchorTextSpan(e);return e&&!e.n?new k(e.x,e.y):null},de.prototype._initializeLabelRegions=function(e,t){var i=this.data.primitives[0],n=this._getIconLocationFromHint(i),a=i.geometry,i=new D(this.data.crs,e);if(i.project((n||a).x,(n||a).y),a=new k(i.lastProjectedX,i.lastProjectedY),e.normalize(a),(i=this._getIconRegion(a.x,a.y))&&this.regions.push(i),(t=this._getRegionsFromHints(e,t,a,!1,i)).length)return this._padding=0,void Array.prototype.push.apply(this.regions,t);t=this._measureLabel(),i&&this._initRegionBounds(e,i,t),Array.prototype.push.apply(this.regions,this._getTextRegions(a,t,i))},de.prototype._getTextRegions=function(e,t,i){for(var n,a=[],s=(this.data.offsetX,this.data.offsetY,0),o=this._possiblePlacements.length;s<o;s++)(n=this._getRegionForPosition(this._possiblePlacements[s],e,t,i))&&a.push(n);return a},de.prototype._getRegionForPosition=function(e,t,i,n){var a,s,o,r=t.x,l=t.y,h=i.width,d=i.height,t=n?n.bounds.getBoundingBoxRelativeTo(t):F.fromPoints(t),c=t.minPoint.x,p=t.minPoint.y,g=t.maxPoint.x,u=t.maxPoint.y,_=de._iconMargin;switch((e=e||W.middleCenter)&W.horizontalMask){default:case W.center:0,o=a=0;break;case W.left:a=c-r-_.left,o=2;break;case W.right:a=g-r+_.right,o=1}switch(e&W.verticalMask){default:case W.middle:s=0,0;break;case W.top:s=p-l-_.top;break;case W.bottom:s=u-l+_.bottom}return{label:this,text:this.data.text,secondaryText:this.data.secondaryText,anchor:new k(r,l),anchorOffset:new k(a,s),placement:e,parentRegion:n,orientation:0,horizontalAlignment:o}},de._poiLabelPlacements=[W.bottomCenter,W.topCenter,W.middleLeft,W.middleRight],de._basemapIconLabelPlacements=[W.topLeft,W.topRight,W.bottomLeft,W.bottomRight,W.bottomCenter],de._transientLensLabelTopPlacements=[W.topCenter],de._transientLensLabelBottomPlacements=[W.bottomCenter],de._transientLensLabelLeftPlacements=[W.middleLeft],de._transientLensLabelRightPlacements=[W.middleRight],de._defaultLabelPlacements=[W.middleCenter],de._iconMargin={left:4,top:1,right:4,bottom:1},de),oe=(Y(he,i=se),he.prototype._initializeLabelRegions=function(e,t){var i,n,a,s,o,r=[],l=this.data;if((r=this._getRegionsFromHints(e,t,null,!0,null,l.shieldInstance)).length)for(i=this._measureLabel(),n=G.getIconBounds(l.iconTemplates,l.iconText).getSize(),l.offsetX||(l.offsetX=n.width/2+J._defaultIconLabelOffset),l.offsetY||(l.offsetY=n.height/2+J._defaultIconLabelOffset),a=0,s=r.length;a<s;a++)(o=r[a]).text=l.iconText,o.type=1,o.size=n,this.regions.push(o),l.text&&(this._initRegionBounds(e,o,i),Array.prototype.push.apply(this.regions,this._getTextRegions(o.anchor,i,o)))},he._roadShieldPlacements=[W.topCenter],he._roadShieldModifierStyle={styleStatic:{fontOutlined:!0,outlineWidth:1,horizontalAlignment:0},styleDynamic:{font:"SegoeBing",fontSize:7.5,fontWeight:4,fontColor:"#000",outlineColor:"#fff",globalOrder:726,visible:!0,priority:0}},he._aerialShieldModifierStyle={styleStatic:{fontOutlined:!0,outlineWidth:1,horizontalAlignment:0},styleDynamic:{font:"SegoeBing",fontSize:7.5,fontWeight:4,globalOrder:726,visible:!0,fontColor:"#fff",outlineColor:"#555",priority:0}},he),re=(le.prototype._constructRenderers=function(e,t){return[new q(e,t,"labelCanvasId",2e4,[1])]},le.prototype._createRenderer=function(e,t){for(var i=this,n=this._constructRenderers(e,t),a=0,s=n.length;a<s;a++)this._disposables.push(n[a].labelRenderingComplete.add(function(e){Microsoft.Maps.setAsync(function(){i.renderingComplete.invoke(e)})}));(t=this._disposables).push.apply(t,n),(t=this._renderers).push.apply(t,n)},le.prototype.performHitTesting=function(e,t){for(var i=this._renderers,n=i.length-1;0<=n&&(!i[n]||!i[n].performHitTesting(e,t));n--);},le.prototype.showLabels=function(e,t){y.log(null,"renderLabels called with {0} labels",e.length),this._renderArgs={labels:e,viewport:t}},le.prototype._showLabels=function(e,t,i){for(var n,a,s,o,r,l=t.transform(i),h=this._labels,d=Object.keys(h),c={},p=this._renderers.length,g=e.length-1;0<=g;g--){var u=e[g],_=u.region,y=l.transform(_.anchor);for(_.anchor.x=y.x,_.anchor.y=y.y,_.anchorTransform=l.multiply(_.anchorTransform),c[o=u.id]=u,r=0;r<p;r++)if(n=this._renderers[r],h[o]){if(n.update(u))break}else if(n.draw(u))break}for(a=0,s=d.length;a<s;a++)if(!c[o=d[a]])for(r=0;r<p&&!this._renderers[r].remove(h[o]);r++);this._labels=c},le.prototype.dispose=function(){m._clearDisposables(this._disposables),this._renderers=[]},le.prototype.copyCanvas=function(e){for(var t=0,i=this._renderers.length;t<i;t++)this._renderers[t].copyCanvas(e)},le.prototype.render=function(e,t,i,n,a){var s,o=null,r=this._renderers,l=r.length,h=(o=this._viewport?this._viewport.transform(e):I.identity).getZoomDirection(),d=!o.nearlyEquals(I.identity,1e-6);if(d||this._renderArgs)for(s=0;s<l;s++)r[s].invalidateHitTestingData();if(h||this._renderArgs||a){for(s=0;s<l;s++)r[s].beginDraw(t,n);for(a=Date.now(),this._fullRender(e,o,h,t,n),h=Date.now(),i.fullRenderTime=h-a,i.labelCount=Object.keys(this._labels).length,s=0;s<l;s++)r[s].endDraw(t,n)}else if(d)for(s=0;s<l;s++)r[s].transformContainer(o);y.logLabelData(this._labels)},le.prototype.cancelRender=function(t){this._renderers.forEach(function(e){e.cancelRender(t)})},le.prototype._fullRender=function(e,t,i,n,a){var s,o,r,l,h,d,c,p,g=this._labels,u=this._renderArgs,_=this._renderers.length,y=!1;if(n&&(n=n.frame,y=m._renderAllPoiAndLabelsGL()&&(a||7===n.cause||3===n.cause||1===n.cause)),u)this._showLabels(u.labels,B.fromIProjectedRegionId(u.viewport),e),this._renderArgs=null;else{for(h=0,d=(l=Object.keys(g)).length;h<d;h++)if(c=(o=(s=g[l[h]]).region).label&&o.label.data&&o.label.data.primitives&&o.label.data.primitives[0],1!==o.type||!y||c.taintedTemplate||!m._renderAllPoiAndLabelsGL())for(c=t.transform(o.anchor),o.anchor.x=c.x,o.anchor.y=c.y,o.anchorTransform=t.multiply(o.anchorTransform),r=0;r<_&&!this._renderers[r].update(s);r++);if(-1===i&&this._labelCollider.collide(g,e.pixelWidth),-1===i||1===i)for(h=0,d=l.length;h<d;h++)if((o=(s=g[p=l[h]]).region).isRejected||o.anchor.x<0||o.anchor.x>=e.pixelWidth||o.anchor.y<0||o.anchor.y>=e.pixelHeight){for(r=0;r<_;r++)this._renderers[r].remove(s);delete g[p]}}this._viewport=e},le);c._CanvasLabelRenderer=q,c.AreaLabel=K,c.Labeler=te,c.LabelRenderer=Z,c.LabelController=ee,c.RelativePlacement=W,c.VectorLabels=re}catch(e){if(!d.logger)throw e;d.logger.logCriticalError(e)}function le(e){this._disposables=[],this._renderers=[],this._labels={},this._labelCollider=new $,this._disposables.push(this.renderingComplete=new v);var t=e.getLabelDpiScale();this._createRenderer(e,t)}function he(e,t){e=i.call(this,e)||this,t="7443EAC9-CD76-4236-B027-22DBC504BF06"===t?he._aerialShieldModifierStyle:he._roadShieldModifierStyle;return e.data.style=t,e.data.fontSize=t.styleDynamic.fontSize,e._possiblePlacements=he._roadShieldPlacements,e.replicaProximity=200,e}function de(e){e=t.call(this,e)||this;return e._calculatePlacements(),e}function ce(e){return n.call(this,e)||this}function pe(){}function ge(e,t,i){var n=this;this._workDispatcher=i,this._templateName=t,this._collisionManager=new Q,this._messageQueue=[],this.message=new v,this._mainThreadMessageSubscription=e.message.add(function(e){return n._queueMessage(e)})}function ue(e,t){var i=this;this._disposables=[],this.message=new v,this.primitiveProcessingComplete=new v,this._workDispatcher=t,this._controller=e,this._worker=new ie(this,e.getBaseTemplateName(),t),this._labelDataByLabelId={},this._changedHandlersByLabelId={},this._alwaysRaiseEvents=!1,this._disposables.push(this._worker.message.add(function(e){var t;i._currentFrame&&e.frame.frameNumber===i._currentFrame.frameNumber&&(t=i._getWorkDispatcherKeyForFrame(e.frame),i._workDispatcher&&i._workDispatcher.dispatch(function(){i._processWorkerMessage(e)},t,4))})),this.labelsProcessed=new v}function _e(e,t,i,n){var a=this,s={};return(a=o.call(this,s)||this)._isShutDown=!0,a._spatialMathRequested=!(!d||!d.SpatialMath),s.defineProperty("isLabelsEnabled",function(e,t){a._onIsLabelsEnabledChanged(e,t),a.labelsEnabledChanged.invoke(t)}),s.defineProperty("isUserLabelsEnabled",function(e,t){a._onIsUserLabelsEnabledChanged(e,t)}),a.instrumentLabelingPass=new v,a.labelsEnabledChanged=new v,a.onLabelsProcessed=new v,a._onTemplateReady=new v,a._frameMangerEventHandlers=[],a._labelingDiagnostics={},a._disposables=[],a._mapEvents=[],a._coreConfig=e,a._hitTestController=t,a._workDispatcher=i,a._customMapStyleManager=n,a.hitTestPriority=1,a}function ye(){this._collisionMapScale=.01,this._bufferSizeAroundRenderables=5,this._collisionMap=[]}function fe(e){return a.call(this,e)||this}function me(){this._index=new e,this._landmarksCount=0,this._landmarkDealsCount=0}function be(e,t){this.bbox=F.empty(),this.setAnchor(e),this.bounds=[],t&&this.add(t)}function ve(){this._index=new A,this._occludedIndex=new A}function xe(e,t,i,n,a){var s=r.call(this)||this;return s._mapEvents=[],s._taintedTemplatesExists=!1,s._map=e,s._dpiScale=t,s._canvasId=i||"labelCanvasId",s._canvasZIndex=n,s._renderEntityTypes=a,s._addCanvas(),s._positionCanvas(!1),s._hitTestIndex=new b,s._labelOptions=e.getMapOptions().labelOptions,s._orderedLabels={},s}function Le(){this.labelRenderingComplete=new v}function we(e){return l.call(this,e)||this}function Re(e){this.data=e,this._padding=Re._defaultPadding,this.id=e.labelId,this.lastUsedRegions=[],this.reset()}}.call(window);
