!function(){var e,c,t,s,i,o,u,r,a,n,l,p,h;try{var d,y=window.$MicrosoftMaps8,g=y.Internal,v=(g._WorkDispatcher,y.Anchor,y.BasicTemplate),f=(g._BinaryObject,y.BitmapImageTemplate,y.ChildVectorImageTemplate),m=g._CurveKey,_=g._Curve,k=g._Color,S=g._ComponentNames,I=(g._CurveVector4,g._CurveColor),b=g._CurveColorHelper,C=g.CustomMapStyleManager,T=g._DiscreteRangeCollectionSpline,x=g._Debug,P=g._Gimme,F=y.GlobalConfig,D=g._Helper,w=g._HslaTransformCurve,V=g._JSEvent,B=F.features.labels,O=g._LatLonCrs,L=(y.LocationRect,g._LoggerConstants),M=g._LruCache,K=y.Matrix2D,G=g._MapAuthentication,R=(y.Location,y.MapMath,y.MercatorCubeCrs),W=(g._MercatorTileUtility,g._Network),N=g._Observable,z=(g._ObservableObject,y.Point),X=(g.PyramidTileSpatialIndex,y.Rectangle,g.SheetSpatialIndex),E=g.StaticPromise,A=g._TransformCurve,Y=g._Url,H=y.VectorImageTemplate,j=g._VectorMath,q=F.features.xsr,U=y.ZoomLevel,J=this&&this.__spreadArrays||function(){for(var e=0,t=0,i=arguments.length;t<i;t++)e+=arguments[t].length;for(var r=Array(e),o=0,t=0;t<i;t++)for(var a=arguments[t],n=0,l=a.length;n<l;n++,o++)r[o]=a[n];return r},Z=this&&this.__extends||(h=function(e,t){return(h=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}h(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});a=d=d||{},n={x:-2,y:3},l=new M(25),p=[null,{records:[{vectorType:2,centerX:8,centerY:8,radiusX:7.5,radiusY:7.5,style:{fillStyle:"#de3700",lineWidth:1,strokeStyle:"#fff"}},{vectorType:4,pathData:"M9.108 5.882C 8.609 5.383 8.331 4.705 8.335 4c -0.094 0.036 -0.184 0.078 -0.272 0.127 -1.033 0.606 -1.379 1.934 -0.774 2.967l.125 .211c 0.29 0.37 0.225 0.905 -0.145 1.195 -0.37 0.29 -0.905 0.225 -1.195 -0.145l-.709 -.785c -0.739 1.359 -0.324 3.057 0.958 3.921 1.283 0.865 3.012 0.612 3.995 -0.583 0.982 -1.195 0.895 -2.941 -0.202 -4.032l-1.008 -.995z",style:{fillStyle:"#fff"}}]},{records:[{vectorType:2,centerX:8,centerY:8,radiusX:7.5,radiusY:7.5,style:{fillStyle:"#006d21",lineWidth:1,strokeStyle:"#fff"}},{vectorType:4,pathData:"M12 6.5l-1-1.49-2.125 1.424V4h-1.75v2.434L5 5 4 6.5 6.331 8 4 9.5 5 11l2.125-1.434V12h1.75V9.566L11 11l1-1.5L9.669 8z",style:{fillStyle:"#fff"}}]},{records:[{vectorType:2,centerX:8,centerY:8,radiusX:7.5,radiusY:7.5,style:{fillStyle:"#006d21",lineWidth:1,strokeStyle:"#fff"}},{vectorType:4,pathData:"M11.7,6.5L9.5,4.3c-0.2-0.2-0.5-0.2-0.7,0L4.3,8.8C4.2,8.8,4.1,9,4.1,9.1v2.3c0,0.3,0.2,0.5,0.5,0.5h2.3c0.1,0,0.3-0.1,0.4-0.1l4.5-4.5C11.9,7.1,11.9,6.7,11.7,6.5z M6.1,10.9c-0.1,0.1-0.3,0.2-0.5,0.2c-0.2,0-0.4-0.1-0.5-0.2c-0.1-0.1-0.2-0.3-0.2-0.5S4.9,10,5.1,9.9c0.1-0.1,0.3-0.2,0.5-0.2c0.2,0,0.4,0.1,0.5,0.2c0.1,0.1,0.2,0.3,0.2,0.5S6.3,10.8,6.1,10.9z",style:{fillStyle:"#fff"}}]}],a.addBadgeTemplate=function(e,t,i){var r,o=p[t];return e&&o?((t=l.getItem(r="badge${badgeType}{templates[0].id}"))||(t=new f(e[0],o,2,0,i||n,.875),l.addItem(r,t)),J(e,[t])):e},Ve.prototype.getLayerDataSource=function(e){return new le(e,this,this.spatialIndex)},Ve.prototype.cancelPrimitivesRequest=function(e,t){t=this._getDispatchKey(e,null,t||"",this._id);W.abortRequest(this._requests[t])},Ve.prototype.cancelPrimitivesRequestInternal=function(e,t,i){i=this._getDispatchKey(e,t,i||"",this._id);W.abortRequest(this._requests[i])},Ve.prototype.getPrimitives=function(e,t,i,r){this.getPrimitivesInternal(e,null,t,i,r)},Ve.prototype.shouldFetchPrimitives=function(){return!0},Ve.prototype.getPrimitivesInternal=function(e,t,i,r,o){var a,n,l=this._getDispatchKey(e,t,r||"",this._id);(o=Math.round(o))<this._minZoom||o>this._maxZoom||!this.shouldFetchPrimitives()?this._completeRequest(i,{primitives:[]},l):(n=e.quadKey,r=this.getFilterKey(),o=this._cstl,(r=this._urlFormat.replace(/{quadkey}/gi,n).replace(/{subdomain}/gi,D._getTileSubDomain(n)).replace(/{filter}/gi,r).replace(/{cstl}/gi,o)).startsWith("data:")||(a=Y.fromString(r),"undefined"==typeof FunctionalTestHooks||(o=a.queryStringParameters&&a.queryStringParameters.ourl)&&(o=Y.fromString(atob(o)).toString(!0,!0),a.queryStringParameters.ourl=btoa(o)),r=a.toString(!0,!0)),(a=Ve._responsesCacheV2.getItem(r))?(a=this._getVectorDataResponse(t,a),this._completeRequest(i,this._filterResponse(a),l)):this._downloadGrid(e,l,t,r,i))},Ve.prototype._filterResponse=function(e){return e},Ve.prototype.applyFilter=function(e){this._filter=e,this.invalidated.invoke()},Ve.prototype.resetFilter=function(){this._filter=null,this.invalidated.invoke()},Ve.prototype.getFilterKey=function(){var e,t,i="",r=this._filter;if(r&&r.value&&r.distribution)for(e=r.value,t=0;t<e.length;t++)i+=e[t]+":"+r.distribution[t],t<e.length&&(i+=",");return i},Ve.prototype._updateCstl=function(){var e=this._map.getMapType(),e=e&&e.cstl||"";this._cstl!==e&&(this._cstl=e,this.invalidated.invoke())},Ve.prototype._downloadGrid=function(i,r,o,a,n,l){var e,s=this,p=i.quadKey;x.logDebugData("BaseMapDataSource - _downloadgrid() "+p),x.time(D._formatString("Network call for quadkey - {0}",p)),e=null,this._coreConfig.autoGenBaseMapJsonso&&!x.getFunctionalTestHooksEnabled()||(e=p.toString()+"_"+this._jsonsoSuffix);var t=this._urlContainsCredentialsParam||this._requestFailedCount>this._maxFailureForFailover||l,t=this._getUpdatedUrlWithCredentials(a,t);this._requests[r]=W.downloadJsonp(t,"grid",function(e){s._handleResponse(i,a,r,o,n,e,!0)},function(e,t){x.log(null,"ERROR: failed to get {0}",p),4===t||l?s._handleResponse(i,a,r,o,n,Ve._createEmptyResponse(),!1,t):(s._requestFailedCount++,s._logNetworkError(),s._downloadGrid(i,r,o,a,n,!0))},e,!1,null,0)},Ve.prototype._handleResponse=function(e,t,s,i,p,r,o,a){var n,l,c,u,h=this;this._map.isDisposed()||(n=e.quadKey,delete this._requests[s],x.groupCollapsed(null,"Callback for lod: {0} quadkey {1}",e.lod.toString(),n),x.timeEnd(D._formatString("Network call for quadkey - {0}",n)),x.time(D._formatString("Parsing vector response for quadkey - {0}",n)),(l=Ve._responsesCacheV2.getItem(t))||(r&&!r.tag?l=this._parseResponse(r,e,t):(l=Ve._responsesCacheV2.getItem(t)||{},N.mergeProperties(l,this._parseNullDataRegion(i))),o&&Ve._responsesCacheV2.addItem(t,l)),x.timeEnd(D._formatString("Parsing vector response for quadkey - {0}",n)),r&&r.requestFailed||(c=this._getVectorDataResponse(i,l)),(u=(c=c||{primitives:null,requestFailed:!0,requestAborted:4===a})&&c.primitives)&&0<u.length?this._map.getTemplateSelector().then(function(l){l.selectorReady().then(function(){for(var e,t,i,r=[],o=[],a=[],n=0;n<u.length;n++)(e=u[n]).entity&&e.entity.oid?a.push(e.entity.oid):1===e.geometryType?r.push(e.bucket):0<(t=$.getShieldIndices(e.entity)).length&&o.push({bucketId:e.bucket,indexes:t});i=[],0<r.length&&i.push(l.prefetchImages(r)),0<o.length&&i.push(l.prefetchShields(o)),0<a.length&&i.push(l.prefetchOrganizationImagesByOrgId(a)),Promise.all(i).then(function(){h._completeRequest(p,h._filterResponse(c),s)})})}):this._completeRequest(p,this._filterResponse(c),s),x.groupEnd())},Ve.prototype._completeRequest=function(e,t){e(t)},Ve.prototype._getDispatchKey=function(e,t,i,r){e=e.quadKey;return t?e+"_"+t+"_"+i+"_"+r:e+"_"+i+"_"+r},Ve._createEmptyResponse=function(){return{entities:[],layers:{},requestFailed:!0}},Ve.prototype._getVectorDataResponse=function(e,t){var i,r,o=null;if(e)-1<this._layersOfInterest.indexOf(e)&&(o=t[e]);else{for(i=[],r=0;r<this._layersOfInterest.length;r++)t[this._layersOfInterest[r]]&&i.push.apply(i,t[this._layersOfInterest[r]].primitives);0<i.length&&(o={primitives:i})}return o},Ve.prototype._parseNullDataRegion=function(e){var t,i,r;if(Ve._nullDataRegionResponse||(t={isNullDataRegionMarker:!0,crs:O.instance,geometryType:1,geometry:{x:0,y:0,bounds:[90,180,-90,-180]}},Ve._nullDataRegionResponse={primitives:[t]}),i={},e)i[e]=Ve._nullDataRegionResponse;else for(r=0;r<this._layersOfInterest.length;r++)i[this._layersOfInterest[r]]=Ve._nullDataRegionResponse;return i},Ve.getAnchorTextSpan=function(e){var t,i,r,o,a,n,l;if(e&&e.lbl)for(i=0,r=e.lbl.length;i<r;i++){for(a=(o=e.lbl[i]).tps&&o.tps.length||0,n=0;n<a;n++)if(l=o.tps[n],t=t||l,!l.n){t=l;break}if(t&&!t.n)break}return t},Ve.prototype._constructGeometryFromHint=function(e,t){var i,r,o,a,e=Ve.getAnchorTextSpan(e);if(e)switch(r=e.x||0,o=e.y||0,t){case 1:i={x:r,y:o,bounds:[o,r,o,r]};break;case 2:i={x:[r,r],y:[o,o],bounds:[o,r,o,r]};break;case 3:i={rings:[a={x:[r,r],y:[o,o]}],r:[a],bounds:[o,r,o,r]}}return i},Ve.prototype._logResponseError=function(e,t,i){var r=y.logger;r&&(e={feature:S.BaseMapData,action:L.Error,data:{layerId:i||"",response:t||"",url:e||""}},r.logCriticalError(null,e))},Ve.prototype._parseResponse=function(e,t,i){var r,o,a,n,l,s,p,c,u,h,d,y,g,f,m,_,S,I=e.entities,v=t.crs,k={},b=e.layers,T=e.placement;if(this._constructGeometryFromLabelHints&&T&&0<T.length)for(r={},a=0,n=(o=Object.keys(b)).length;a<n;a++)for(k[l=o[a]]={primitives:[]},s=0,p=(c=b[l]).length;s<p;s++)y=(h=c[s]).entityIndex||h.ei,x.assert(0!==y,"Primitive with entityindex 0 is invalid"),r[y+","+h.gt]||(h.bucket=h.bkt,h.entityIndex=y,h.geometryType=h.gt,h.geometry=this._constructGeometryFromHint(T[y],h.geometryType),x.assert(null!==h.geometry,"Geometry should be constructed from a hint"),(g=I[y])&&(this._coreConfig.clickBasemapPrimitives&&(g.clickable=g.clickable||!!g.clk,g.clickable&&(h.isTapEnabled||(h.isTapEnabled=h.isHoverEnabled=function(){return!0}),g.changed||(g.changed=new V))),g.name=g.displayName||g.dn,g.labelImportance=g.labelImportance||g.li||-1,g.ypid=g.ypid||g.yp,g.shieldName=g.shieldName||g.sn||[],g.shieldIndex=g.shieldIndex||g.si||[],g.labelHint=T[y],g.landmarksDealFlag=!!g.cp,h.entity=g),h.crs=v,k[l].primitives.push(h),r[y+","+h.gt]=y);else for(l in b)if(b.hasOwnProperty(l))for(c=this._generateLinePrimitives(b[l]),k[l]={primitives:c},u=0;u<c.length;u++)if(h=c[u],!h.bucket){switch(h.g||this._logResponseError(i,JSON.stringify(e),l),h.bucket=h.bkt,h.entityIndex=h.ei,h.geometry=h.g,h.geometryType=h.gt,h.geometry.bounds=h.g.b,h.geometryType){case 1:d=h.geometry,h.geometry.bounds=[Math.min(16384,d.y),d.x,d.y,Math.min(16384,d.x)];break;case 3:(m=h.geometry).rings=m.r}if((g=I[y=h.entityIndex])&&(g.name=g.displayName||g.dn,g.labelImportance=g.labelImportance||g.li||-1,g.ypid=g.ypid||g.yp,g.shieldName=g.shieldName||g.sn||[],g.shieldIndex=g.shieldIndex||g.si||[],g.labelHint=T&&T[y],h.entity=(g.ypid||g.tj,g)),f=h.geometry,3===h.geometryType)for(m=f,_=0;_<m.rings.length;_++)S=m.rings[_],D._deltaDecode(S.x),D._deltaDecode(S.y);h.crs=v}return k},Ve.prototype._generateLinePrimitives=function(e){for(var t,i,r,o,a,n,l,s=[],p=0;p<e.length;p++)if(3===(t=e[p]).gt){if(!(i=t.g.r))continue;for(r=0;r<i.length;r++)o=i[r],D._deltaDecode(o.x),D._deltaDecode(o.y);for(a=this._convertPolygonToPolylineGeometry(t.g,512),n=0;n<a.length;n++)l={entityIndex:t.ei,ei:t.ei,bkt:t.bkt,gt:2,g:a[n]},s.push(l)}else s.push(t);return s},Ve.prototype._convertPolygonToPolylineGeometry=function(e,t){for(var i,r,o,a,n,l=[],s=0;s<e.r.length;s++){var p=e.r[s],c=!1,u=null;for(0<p.x.length&&(p.x.push(p.x[0]),p.y.push(p.y[0])),i=0;i<p.x.length;i++)r=p.x[i],o=p.y[i],r<0||t<r||o<0||t<o?(c=!0,0<i&&(a=[],(n=this._lineIntersect(0,0,0,t,p.x[i-1],p.y[i-1],p.x[i],p.y[i]))&&a.push(n),(n=this._lineIntersect(0,0,t,0,p.x[i-1],p.y[i-1],p.x[i],p.y[i]))&&a.push(n),(n=this._lineIntersect(0,t,t,t,p.x[i-1],p.y[i-1],p.x[i],p.y[i]))&&a.push(n),(n=this._lineIntersect(t,0,t,t,p.x[i-1],p.y[i-1],p.x[i],p.y[i]))&&a.push(n),1===a.length&&u?(u.x.push(a[0].x),u.y.push(a[0].y)):2===a.length&&l.push({x:[a[0].x,a[1].x],y:[a[0].y,a[1].y],bounds:null,b:[0,0,t,t]})),u&&(l.push(u),u=null)):(u=u||{x:[],y:[],bounds:null,b:[0,0,t,t]},c&&((n=this._lineIntersect(0,0,0,t,p.x[i-1],p.y[i-1],p.x[i],p.y[i])||this._lineIntersect(0,0,t,0,p.x[i-1],p.y[i-1],p.x[i],p.y[i])||this._lineIntersect(0,t,t,t,p.x[i-1],p.y[i-1],p.x[i],p.y[i])||this._lineIntersect(t,0,t,t,p.x[i-1],p.y[i-1],p.x[i],p.y[i]))&&(u.x.push(n.x),u.y.push(n.y))),u.x.push(r),u.y.push(o),c=!1);u&&l.push(u)}return l},Ve.prototype._lineIntersect=function(e,t,i,r,o,a,n,l){var s,p;return e===i&&t===r||o===n&&a===l?null:0==(s=(l-a)*(i-e)-(n-o)*(r-t))?null:(p=((i-e)*(t-a)-(r-t)*(e-o))/s,(s=((n-o)*(t-a)-(l-a)*(e-o))/s)<0||1<s||p<0||1<p?null:new z(e+s*(i-e),t+s*(r-t)))},Ve.prototype._getUpdatedUrlWithCredentials=function(e,t){return t?this._urlContainsCredentialsParam||(e+="&key="+G.instance.getSessionId()):!t&&this._urlContainsCredentialsParam&&(e=e.replace(/&?key={credentials}/gi,"")),e},Ve.prototype._logNetworkError=function(){var e,t;this._requestFailedCount===this._maxFailureForFailover+1&&Math.random()<=.1&&((e=y.logger)&&(t={feature:S.MapControl,action:L.Error,data:{errorMessage:"Basemap vector data requests failed "+this._requestFailedCount+" times. Switching over to use TFE authentication."}},e.logCriticalError(null,t)))},Ve._responsesCacheV2=new M(50),e=Ve,(r=ie=ie||{}).convertLegacyImage=function(e,t,i){var r,o,a,n,l,s,p;if(!e)return null;for(r={background:{records:[],shape:-1},icon:{records:[],shape:-1}},o=0,a=e.records;o<a.length;o++)(l=function(e,t,i){if(!e)return null;var r,o,a=null;switch(e.recordType){case"Ellipse":a={type:"ellipse",scale:{property:e.scalePaletteKeyId},stroke:Ie(e.lineStyle.colorValueId,t),strokeScale:{property:e.strokeScalePaletteKeyId},strokeWidth:e.lineStyle.strokeWidth,centerX:e.cX,centerY:e.cY,radiusX:e.rX,radiusY:e.rY};break;case"FilledEllipse":a={type:"ellipse",scale:{property:e.scalePaletteKeyId},fill:Ie(e.colorValueId,t),centerX:e.cX,centerY:e.cY,radiusX:e.rX,radiusY:e.rY};break;case"Path":a={type:"path",scale:{property:e.scalePaletteKeyId},stroke:Ie(e.strokeValueId,t),strokeScale:{property:e.strokeScalePaletteKeyId},strokeWidth:e.strokeWidth,fill:Ie(e.fillValueId,t),data:e.geometryString};break;case"Polygon":a={type:"polygon",scale:{property:e.scalePaletteKeyId},fill:Ie(e.colorValueId,t),points:ve(e.pointsList)};break;case"Polyline":a={type:"polyline",scale:{property:e.scalePaletteKeyId},stroke:Ie(e.lineDrawStyle.colorValueId,t),strokeScale:{property:e.strokeScalePaletteKeyId},strokeWidth:e.lineDrawStyle.strokeWidth,points:ve(e.pointsList)};break;case"Text":a={type:"text",scale:{property:e.scalePaletteKeyId},x:e.leftTop.x,y:e.leftTop.y,width:e.rightBottom.x-e.leftTop.x,height:e.rightBottom.y-e.leftTop.y,fill:Ie(e.textStyle.colorValueId,t),fontFamily:i.getFixedString(e.textStyle.fontFamilyId),fontSize:e.textStyle.fontSize,fontWeight:(r=e.textStyle.fontStyle,o=null,16&r?o="semiBold":1&r?o="bold":32&r&&(o="light"),o)}}return a}(n=a[o],t,i))&&((p=(s=i.getFixedString(n.shapePaletteKeyId)||"").endsWith(c.backgroundShapeRecord)?r.background:r.icon).records.push(l),s&&-1===p.shape&&(p.shape=n.shapePaletteKeyId));return e={anchorX:e.hotspotX,anchorY:e.hotspotY,overrideAnchor:e.overrideHotspot},-1!==r.background.shape||-1!==r.icon.shape?(e.layers={},r.background.records.length&&(e.layers.background=r.background),r.icon.records.length&&(e.layers.icon=r.icon)):e.records=r.icon.records,e},r.imageFromLegacy=function(e,t,i){return e&&{hitTest:1,hotspotX:e.hotspotX,hotspotY:e.hotspotY,overrideHotspot:e.overrideHotspot,records:e.records&&e.records.map(function(e){return function(e,t,i){var r=null;switch(e.recordType){case"Ellipse":r={vectorType:2,centerX:e.cX,centerY:e.cY,radiusX:e.rX,radiusY:e.rY,style:{lineWidth:e.lineStyle.strokeWidth,lineWidthScale:i.getSinglePaletteValue(e.strokeScalePaletteKeyId),strokeStyle:ke(e.lineStyle.colorValueId,t,i)},strokeScalePaletteKey:i.getFixedString(e.strokeScalePaletteKeyId),strokeStylePaletteKey:be(e.lineStyle.colorValueId,t,i)};break;case"FilledEllipse":r={vectorType:2,centerX:e.cX,centerY:e.cY,radiusX:e.rX,radiusY:e.rY,style:{fillStyle:ke(e.colorValueId,t,i)},fillStylePaletteKey:be(e.colorValueId,t,i)};break;case"Path":r={vectorType:4,pathData:e.geometryString,style:{fillStyle:ke(e.fillValueId,t,i),lineWidth:e.strokeWidth,lineWidthScale:i.getSinglePaletteValue(e.strokeScalePaletteKeyId),strokeStyle:ke(e.strokeValueId,t,i)},fillStylePaletteKey:be(e.fillValueId,t,i),strokeScalePaletteKey:i.getFixedString(e.strokeScalePaletteKeyId),strokeStylePaletteKey:be(e.strokeValueId,t,i)};break;case"Polygon":r={vectorType:0,pointsList:e.pointsList,style:{fillStyle:ke(e.colorValueId,t,i)},fillStylePaletteKey:be(e.colorValueId,t,i)};break;case"Polyline":r={vectorType:1,pointsList:e.pointsList,style:{lineWidth:e.lineDrawStyle.strokeWidth,lineWidthScale:i.getSinglePaletteValue(e.strokeScalePaletteKeyId),strokeStyle:ke(e.lineDrawStyle.colorValueId,t,i)},strokeScalePaletteKey:i.getFixedString(e.strokeScalePaletteKeyId),strokeStylePaletteKey:be(e.lineDrawStyle.colorValueId,t,i)};break;case"Text":var o=e.leftTop||{x:0,y:0},a=e.rightBottom||o,n=o.x,l=a.x,s=o.y,p=a.y,r={vectorType:3,text:H.placeholderText,anchor:{x:(n+l)/2,y:(s+p)/2},maxWidth:l-n,leftTop:o,rightBottom:a,style:{fillStyle:ke(e.textStyle.colorValueId,t,i),font:i.getFixedString(e.textStyle.fontFamilyId)||H.defaultFont,fontStyle:e.textStyle.fontStyle,fontSize:e.textStyle.fontSize,horizontalAutoScaling:e.horizontalAutoScaling,verticalAlignment:1},fillStylePaletteKey:be(e.textStyle.colorValueId,t,i)}}return r&&(r.scale=i.getSinglePaletteValue(e.scalePaletteKeyId),r.scalePaletteKey=i.getFixedString(e.scalePaletteKeyId),r.shapePaletteKey=i.getFixedString(e.shapePaletteKeyId)),r}(e,t,i)})}},r.imageFromBaseMap=function(e,t){var i=[];return e&&e.layers?(we(i,e,"background",t),we(i,e,"icon",t)):e&&e.records&&i.push.apply(i,e.records.map(function(e){return De(e,void 0,t)})),i&&i.length?{hitTest:1,hotspotX:e.anchorX,hotspotY:e.anchorY,overrideHotspot:e.overrideAnchor||!1,records:i}:void 0},u=ie=ie||{},Se.prototype.getImage=function(e,t,i,r){var o,a=e+"_"+t,t=this._parsedImages.getItem(a);return t||(this._fetchNewImageFormat||this._convertLegacyFormat?(o=this._images[e])&&(t=u.imageFromBaseMap(o,r)):(o=this._legacyImages[e])&&(e=void 0,"image"in o?(e=o.image&&o.image.vectorImage,i=o.svgColor):e=o,e&&(t=u.imageFromLegacy(e,i,r))),t&&this._parsedImages.addItem(a,t)),t},Se.prototype.getOrgImage=function(e,t,i){var r,o="o"+e+"_"+t,t=this._parsedImages.getItem(o);return t||(this._fetchNewImageFormat||this._convertLegacyFormat?(r=this._orgImages[e])&&(t=u.imageFromBaseMap(r,i)):(r=this._legacyOrgImages[e])&&(t=u.imageFromLegacy(r.image&&r.image.vectorImage,r.svgColor,i)),t&&this._parsedImages.addItem(o,t)),t},Se.prototype.createClassicIcon=function(e){var t,i=9999;return this._fetchNewImageFormat||this._convertLegacyFormat?this._images[i]||(this._images[i]={overrideAnchor:!0,layers:{background:{records:[{type:"circle",centerX:0,centerY:0,radius:10,fill:{value:"#FFFFFF",property:e.getFixedStringId("Task1.HighlightFillColor")},scale:{property:e.getFixedStringId("Task1.HighlightScale")},stroke:{value:"#FFFFFF",property:e.getFixedStringId("Task1.HighlightStrokeColor")},strokeScale:{property:e.getFixedStringId("Task1.HighlightStrokeWidthScale")},strokeWidth:1},{type:"circle",centerX:0,centerY:0,radius:7,fill:{value:"#FFFFFF",property:e.getFixedStringId("Task1.FillColor")},scale:{property:e.getFixedStringId("Task1.BackgroundScale")}}],shape:e.getFixedStringId("Task1.Shape-Background")}}}):this._legacyImages[i]||(t=[{type:"SvgPaletteColor",color:"#FFFFFF",svgPaletteColor:{paletteKeyId:e.getFixedStringId("Task1.FillColor")}},{type:"SvgPaletteColor",color:"#FFFFFF",svgPaletteColor:{paletteKeyId:e.getFixedStringId("Task1.HighlightFillColor")}},{type:"SvgPaletteColor",color:"#FFFFFF",svgPaletteColor:{paletteKeyId:e.getFixedStringId("Task1.HighlightStrokeColor")}}],this._legacyImages[i]={svgColor:t,image:{vectorImage:{overrideHotspot:!0,records:[{recordType:"FilledEllipse",cX:0,cY:0,rX:10,rY:10,scalePaletteKeyId:e.getFixedStringId("Task1.HighlightScale"),shapePaletteKeyId:e.getFixedStringId("Task1.Shape-Background"),colorValueId:1},{recordType:"Ellipse",cX:0,cY:0,rX:10,rY:10,scalePaletteKeyId:e.getFixedStringId("Task1.HighlightScale"),shapePaletteKeyId:e.getFixedStringId("Task1.Shape-Background"),strokeScalePaletteKeyId:e.getFixedStringId("Task1.HighlightStrokeWidthScale"),lineStyle:{colorValueId:2,strokeWidth:1}},{recordType:"FilledEllipse",cX:0,cY:0,rX:7,rY:7,scalePaletteKeyId:e.getFixedStringId("Task1.BackgroundScale"),shapePaletteKeyId:e.getFixedStringId("Task1.Shape-Background"),colorValueId:0}]}}}),i},Se.prototype.prefetchImages=function(e,n,l,s,t){var p=this,i=e.split(",").map(function(e){return parseInt(e)}),r=i[0]%2,r=this._urlImageFormat.replace(/{imageIdx}/gi,e).replace(/{orgId}/gi,"").replace(/{subdomain}/gi,(isNaN(r)?0:r)+"");W.downloadJson(r,"XsrImages",function(e,t){for(var i,r,o=0,a=t;o<a.length;o++)r=e[i=a[o]],p._fetchNewImageFormat?p._images[i]=r:p._convertLegacyFormat?p._images[i]=u.convertLegacyImage(r.vectorImage,n,l):p._legacyImages[i]=r.vectorImage;s&&s(t)},t,i,!1,0,!1)},Se.prototype.prefetchOrgImage=function(e,i,r,t){var o=this,a=parseInt(e)%2,a=this._urlImageFormat.replace(/{orgId}/gi,e).replace(/{imageIdx}/gi,"").replace(/{subdomain}/gi,(isNaN(a)?0:a)+"");W.downloadJson(a,"XsrOrgJsImages",function(e,t){e&&(o._fetchNewImageFormat?o._orgImages[t]=e:o._convertLegacyFormat?o._orgImages[t]=u.convertLegacyImage(e.image&&e.image.vectorImage,e.svgColor,i):o._legacyOrgImages[t]=e),r&&r(t)},t,e,!1,0,!1)},u.BaseMapImageLoader=Se;var $,Q=(Z(_e,o=e),_e),ee=(me._clone=function(e,t){var i;switch(e.type){case 0:i={keyId:t,type:e.type,stringId:e.stringId};break;case 1:i={keyId:t,type:e.type,value:e.value,ignoreTransform:e.ignoreTransform};break;case 3:i={keyId:t,type:e.type,value:e.value};break;case 2:i={keyId:t,type:e.type,value:e.value,ignoreTransform:e.ignoreTransform};break;case 4:i={keyId:t,type:e.type,value:e.value}}return i&&(i.additionalAttributes=e.additionalAttributes),i},me.prototype._addItem=function(e,t){this._items[t]=e},me.prototype.getStackedColorPaletteValue=function(e,t){var i=NaN,t=this.getStackedPaletteItem(e,t);return i=t&&1===t.type?t.value:i},me.prototype.getStackedSinglePaletteItem=function(e,t){var i=null,t=this.getStackedPaletteItem(e,t);return i=t&&2===t.type?t:i},me.prototype.getStackedStringPaletteValue=function(e,t){var i,t=this.getStackedPaletteItem(e,t);return i=t&&0===t.type?this._fixedStringList[t.stringId]:i},me.prototype.getStackedEnumPaletteValue=function(e,t){var i,t=this.getStackedPaletteItem(e,t);return i=t&&4===t.type?t.value:i},me.prototype.getStackedBooleanPaletteValue=function(e,t){var i,t=this.getStackedPaletteItem(e,t);return i=t&&3===t.type?t.value:i},me.prototype.getStackedPaletteItem=function(e,t){var i,r,o,a,n=null;if(!e||!t)return null;for(i=0,r=e.length;i<r;i++)if((o=this._customStyleManager&&this._customStyleManager.getElementItem(e[i],t))||(a=e[i]+"."+t,a=this.getFixedStringId(a),o=this._items[a]),o){if(!(a=(a=o.additionalAttributes)&&a.propertyReferenceId)){n=o;break}t=this._fixedStringList[a]}return n},me.prototype.getColorPaletteValue=function(e,t){var i,r=NaN;return(i=this._items[e=e||0])&&(t&&i.keyId!==e||(r=i.value)),r},me.prototype.getSinglePaletteValue=function(e,t,i){var r=i=void 0===i?1:i;return(i=this._items[e=e||0])&&(t&&i.keyId!==e||(r=i.value)),r},me.prototype.getBooleanPaletteValue=function(e){var t=!1;return t=(e=this._items[e=e||0])?e.value:t},me.prototype.getStringPaletteValue=function(e){var t="";return t=(e=this._items[e=e||0])?this._fixedStringList[e.stringId]:t},me.prototype.getFixedStringId=function(e){e=this._fixedStringMap[e];return e="number"!=typeof e?-1:e},me.prototype.getFixedString=function(e){return this._fixedStringList[e]},me.prototype.populate=function(e,t,i){var r,o,a,n,l;if(!e.isParsed){if(e.isParsed=!0,r={},e.nodeType){for(o=e.nodeType.properties,a={name:e.nodeType.name,parent:e.nodeType.parent,properties:e.nodeType.properties};a.parent&&a.parent.properties;)o=o.concat(a.parent.properties),a=a.parent;for(l=0;l<o.length;l++){var s=o[l].propertyName,p=e.name+"."+s,c=t[p];c?(this._addItem(c,c.keyId),r[s]=c):(n=i&&i[s])?0<=(c=this.getFixedStringId(p))?(n=n.additionalAttributes?me._clone(n,n.keyId):n,this._addItem(n,c),r[s]=n):x.assert(!0,"KeyId not in FixedStrings "+c):x.assert(!0,"Palette key should be present "+p)}}if(e.children)for(l=0;l<e.children.length;l++)this.populate(e.children[l],t,r)}},me.prototype.getBackgroundShapeIds=function(){for(var e,t,i=Object.keys(this._items),r={},o=0,a=i.length;o<a;o++)(t=this._items[i[o]])&&0===t.type&&(e=t.keyId,(e=this._fixedStringList[e])&&e.endsWith(c.backgroundShapeRecord)&&(t=t.stringId,this._fixedStringList[t]&&(r[t]=!0)));return Object.keys(r)},me.prototype.addItem=function(e,t){this.addPaletteItem(e,{type:4,hasValue:!0,value:t})},me.prototype.addPaletteItem=function(e,t){t.keyId=this.addFixedString(e),this._addItem(t,t.keyId)},me.prototype.addFixedString=function(e){var t=this.getFixedStringId(e);return-1===t&&(t=this._fixedStringList.length,this._fixedStringList.push(e),this._fixedStringMap[e]=t),t},me),te=(fe.prototype.dispose=function(){},fe.prototype.selectorReady=function(){var t=this;return this._ready||(this._ready=new Promise(function(e){e(t)})),this._ready},fe.prototype.getCategoryIconTemplate=function(e){Microsoft.Maps.setTimeout(function(){e&&e({icon:null,iconColor:""})},0)},fe.prototype.getIconTemplate=function(e){Microsoft.Maps.setTimeout(function(){e&&e({icon:null,iconColor:""})},0)},fe.prototype.getCityPolygonTemplates=function(){return null},fe.prototype.getFirstDrawOrder=function(){return 0},fe.prototype.getPolygonTemplates=function(){return null},fe.prototype.getLandmarkVectorImageTemplate=function(e,t){t=fe._landmarkTemplates[t];return t?[t]:[]},fe.prototype.getMarkupStyle=function(){var e=c.isDarkTheme(this._templateName)?fe._darkThemeStyle:fe._lightThemeStyle;return{styleStatic:e.styleStatic,styleDynamic:D._copyObject(e.styleDynamic)}},fe.prototype.getName=function(){return this._templateName},fe.prototype.getPoiTemplate=function(e,t){t=fe.poiTemplates[t];return t?[t]:[]},fe.prototype.getPoiVectorImageTemplate=function(e,t){t=fe.poiTemplates[t];return t?[t]:[]},fe.prototype.getRoutePoiVectorImageTemplate=function(e,t){t="turn"===e?fe.directionsTurnTemplate:fe.poiTemplates[t];return t?[t]:[]},fe.prototype.prefetchShields=function(){return new Promise(function(e){e()})},fe.prototype.prefetchImages=function(){return new Promise(function(e){e()})},fe.prototype.prefetchOrganizationImagesByOrgId=function(){return new Promise(function(e){e()})},fe.prototype.getFetchedShields=function(e,t,i){var r,o,a;if(t&&i&&i.length){for(r=[],o=0,a=i.length;o<a;o++)r.push(fe.DefaultShieldTemplate);return r}return null},fe.prototype.getShieldsAsync=function(e,t,i,r){var o=this;Microsoft.Maps.setTimeout(function(){r&&r(o.getFetchedShields(e,t,i))},0)},fe.prototype.getTemplates=function(){return null},fe._lightThemeStyle={styleStatic:{backgroundColor:"rgba(236,234,227,0.7)"},styleDynamic:{visible:!0,font:"SegoeBing",fontSize:10,fontColor:"#000"}},fe._darkThemeStyle={styleStatic:{backgroundColor:"rgba(64,64,64,0.7)"},styleDynamic:{visible:!0,font:"SegoeBing",fontSize:10,fontColor:"#fff"}},fe._landmarkTemplates=[null,null,new H({records:[{vectorType:2,style:{fillStyle:"rgba(255,255,255,0.7)",strokeStyle:"rgba(0,0,0,0.7)",lineWidth:1},centerX:0,centerY:0,radiusX:6,radiusY:6}],hitTest:1}),new H({records:[{vectorType:2,style:{fillStyle:"rgba(192,192,192,0.4)",strokeStyle:"rgba(64,64,64,0.4)",lineWidth:2},centerX:0,centerY:0,radiusX:12,radiusY:12},{vectorType:2,style:{fillStyle:"rgba(255,255,255,0.7)",strokeStyle:"rgba(0,0,0,0.7)",lineWidth:1},centerX:0,centerY:0,radiusX:6,radiusY:6}],hitTest:1}),new H({records:[{vectorType:2,style:{fillStyle:"rgba(192,192,192,0.4)",strokeStyle:"rgba(64,64,64,0.4)",lineWidth:2},centerX:0,centerY:0,radiusX:12,radiusY:12},{vectorType:2,style:{fillStyle:"rgba(255,255,255,0.7)",strokeStyle:"rgba(0,0,0,0.7)",lineWidth:1},centerX:0,centerY:0,radiusX:6,radiusY:6}],hitTest:1})],fe.poiTemplates=[null,null,new H({records:[{vectorType:2,style:{fillStyle:"#fff",strokeStyle:"#000",lineWidth:1},centerX:0,centerY:0,radiusX:10,radiusY:10}],hitTest:1}),new H({records:[{vectorType:2,style:{fillStyle:"rgba(192,192,192,0.4)",strokeStyle:"rgba(64,64,64,0.4)",lineWidth:2},centerX:0,centerY:0,radiusX:16,radiusY:16},{vectorType:2,style:{fillStyle:"#fff",strokeStyle:"#000",lineWidth:1},centerX:0,centerY:0,radiusX:10,radiusY:10}],hitTest:1}),new H({records:[{vectorType:2,style:{fillStyle:"#fff",strokeStyle:"#000",lineWidth:2},centerX:0,centerY:0,radiusX:14,radiusY:14},{vectorType:2,style:{fillStyle:"#000"},centerX:0,centerY:0,radiusX:4,radiusY:4}],hitTest:1}),new H({records:[{vectorType:2,style:{fillStyle:"rgba(255,255,255,0.5)",strokeStyle:"rgba(0,0,0,0.5)",lineWidth:1},centerX:0,centerY:0,radiusX:8,radiusY:8}],hitTest:1}),new H({records:[{vectorType:2,style:{fillStyle:"rgba(255,255,255,0.5)",strokeStyle:"rgba(0,0,0,0.5)",lineWidth:2},centerX:0,centerY:0,radiusX:10,radiusY:10},{vectorType:2,style:{fillStyle:"rgba(0,0,0,0.5)"},centerX:0,centerY:0,radiusX:4,radiusY:4}],hitTest:1})],fe.directionsTurnTemplate=new H({records:[{vectorType:2,style:{fillStyle:"rgba(255,255,255,0.5)",strokeStyle:"rgba(0,0,0,0.5)",lineWidth:1},centerX:0,centerY:0,radiusX:4,radiusY:4}],hitTest:1}),fe.DefaultShieldTemplate=new H({records:[{vectorType:2,style:{fillStyle:"#fff",strokeStyle:"#666",lineWidth:1},centerX:0,centerY:0,radiusX:10,radiusY:8},{vectorType:3,style:{fillStyle:"#000",font:"SegoeBing",fontSize:7,fontStyle:1,horizontalAutoScaling:1},anchor:{x:0,y:0},maxWidth:18,text:"{MapDisplay}"}]}),fe);(i=$=$||{}).getClickable=function(e){return!(!e||!e.clickable)},i.getDisplayName=function(e){var t="";return(e=e)&&(e.getPrimaryLabelText?t=e.getPrimaryLabelText():e.name?t=e.name:e.getName?t=e.getName():e.title?t=e.title:e.getTitle&&(t=e.getTitle())),t},i.getSecondaryDisplayName=function(e){var t="";return(e=e).getSecondaryLabelText?t=e.getSecondaryLabelText():e.subtitle?t=e.subtitle:e.getSubtitle&&(t=e.getSubtitle()),t},i.independentHotRegions=function(e){var t=!1;return void 0!==(e=e).independentHotRegions?t=e.independentHotRegions:e.getIndependentHotRegions&&(t=e.getIndependentHotRegions()),t},i.getIconText=function(e){var t="";return(e=e)&&(e.getIconText?t=e.getIconText():e.iconText&&(t=e.iconText)),t},i.getLabelImportance=function(e){return e&&e.labelImportance||0},i.getShieldNames=function(e){return e&&e.shieldName},i.getShieldIndices=function(e){return e&&e.shieldIndex},i.getShieldDisplayData=function(e){var t=e.split(","),i="",e="";return x.assertNotNull(t,"shield attributes"),x.assert(4===t.length,"all four shield attributes should be present"),t&&4===t.length&&(i=ge(t[0]),e=ge(t[3])),{text:i,modifier:e}},i.getYpid=function(e,t){return e=e&&(e.ypid||e.businesslistingid),e=t&&e&&-1<e.indexOf(":")?e.split(":")[1]:e},i.getTransitJson=function(e){return e&&e.tj},i.isTransitEntity=function(e){return e&&e.representsTransitStop},i.isLandmarkEntity=function(e){return e&&5===e.poiType},ye.init=function(){var t={},i={},r={};["50","64","65","226","227","228","229","231","232","234","235","236","238","239","240","241","242","243","244","245","246","247","248","249","250","251","252","253","254","1899"].forEach(function(e){t[e]=!0,i[e]=!0}),["337","338","339","340","341","342","350","351","352","1386","1387","353","1370","1371","344","1441","1442","1443"].forEach(function(e){i[e]=!0}),["254","253","252","251","250","249","243","242","241","236","235","232","231","229","228","227","226"].forEach(function(e){r[e]=!0}),ye._transitBucketIds=t,ye._invertedIconBucketIds=i,ye._multimodeTransitBucketIds=r},ye.prototype.getName=function(){return this._templateName},ye.isDarkTheme=function(e){return!!this._darkTemplates[e]},ye.extractCategoryId=function(e,t){for(var i,r=(i=(e=e||"").split(".")).length-1;0<=r;r--)if(ye.getBucketForCategory(i[r]))return i[r];return t?ye.DefaultBucketForLocalCat:null},ye.getBucketForCategory=function(e){var t=ye._categoryBucketMap,e=t?(t=t[e]||t[ye._categoryRemap[e]]||ye._categoryFallbackMap[e])&&t.bucketId.toString():ye._localCatIdBucketMapping[e];return e},ye.getPaletteKeyForCategory=function(e){var t="",i=ye._bucketPaletteMap,e=ye.getBucketForCategory(e);return t=i?i[e]||"":t},ye.prototype.selectorReady=function(){var r=this;return this._ready||(this._ready=new Promise(function(e,t){var i=[r._initCategoryMap(),r._initTemplateData()];r._styleEntryBucketMap&&8.12<=parseFloat(r._stlVersion)&&i.push(r._styleEntryBucketMap.ready()),Promise.all(i).then(function(){r._initialized=!0,r._ready=new E(r),e(r)},function(){r._ready=null,t(null)})})),this._ready},ye.prototype._initCategoryMap=function(){var i=this,e=ye._catMapPromise;return e||(e=this._catMapUrlFormat?new Promise(function(t){W.downloadJson(i._catMapUrlFormat,"catmap",function(e){i._onCatMapResponse(e),t(null)},function(){t(null)},null,!1,null,!1)}):new E(null),ye._catMapPromise=e),e},ye.prototype._onCatMapResponse=function(e){var t;if(!this._isDisposed&&e){for(var i=e.categoryMap||[],r={},o={},a=0,n=i.length;a<n;a++)o[(r[(t=i[a]).categoryId]=t).bucketId]=t.entry;ye._categoryBucketMap=r,ye._bucketPaletteMap=o}},ye.prototype._initTemplateData=function(){var i=this,e=this._templatePromise;return e||(e=new Promise(function(e,t){i._requestTemplateData(e,t)}),this._templatePromise=e),e},ye.prototype._requestTemplateData=function(i,t){var r,e,o,a,n=this;!this._requested&&this._urlFormat&&(this._requested=!0,this._delayLoadTimerId&&(window.clearTimeout(this._delayLoadTimerId),this._delayLoadTimerId=null),x.logDebugData("BaseMapTemplateSelector - _requestTemplateData() "+this._urlFormat),r=this._clientPerf&&this._clientPerf.start(ye._latencyLogKey),void 0!==(e=window[this._templateName])&&e===this._templateName?(o="XsrPrefetchCallback",a="XsrPrefetchErrorCallback",window[o]=function(e,t){delete window[t],delete window[a],delete window[o],n._onTemplateResponse(e,r,i)},window[a]=function(e){delete window[e],delete window[a],delete window[o],n._retryCount++,n._onTemplateError(e,i,t)}):e?(delete window[this._templateName],this._onTemplateResponse(e,r,i)):W.downloadJson(this._urlFormat.replace(/{templateName}/gi,this._templateName).replace(/{subdomain}/gi,"0"),"styles",function(e){n._onTemplateResponse(e,r,i)},function(){n._onTemplateError(n._templateName,i,t)},null,!1,null,!1))},ye.prototype._onTemplateError=function(e,t,i){var r=this;this._retryCount<ye._maxRetries?(this._requested=!1,this._retryCount++,x.logNetworkData(e,"retry "+this._retryCount),this._delayLoadTimerId=Microsoft.Maps.setTimeout(function(){r._requestTemplateData(t,i)},1e3*ye._retryTimeout)):x.logNetworkData(e,"max retries"),i(null)},ye.prototype._onTemplateResponse=function(e,t,i){this._isDisposed||(this._clientPerf&&this._clientPerf.end(t),this._parseTemplate(e,i))},ye.prototype._loadTemplates=function(e,t,i){if(!this._initialized)throw new Error("BaseMapTemplateSelector: trying to use this class before it has been initialized");return this._getMarkupRecord(e,t,i)},ye.prototype._IsCurveGraph=function(e){return void 0!==e.position&&void 0!==e.tangentType},ye.prototype._IsDiscreateCollectionGraph=function(e){return void 0!==e.start&&void 0!==e.end},ye.prototype._IsHslaTransformCurveGraph=function(e){return 14===e.graphType},ye.prototype._IsTransformCurveGraph=function(e){return 15===e.graphType&&void 0!==e.numericTransformCurve},ye.prototype._getFixedStringId=function(e){e=this._fixedStringMap[e];return e="number"!=typeof e?-1:e},ye.prototype._getColorformat=function(e){var t=null;return 1===e.graphType&&((e=e.value)&&"string"==typeof e&&6===e.slice(1).length&&!isNaN(parseInt(e.slice(1),16))?t=1:e&&"string"==typeof e&&-1<e.indexOf("rgba")?t=0:!e&&0!==e||"number"!=typeof e||(t=3)),t},ye.prototype._parseTemplate=function(e,t){var i,r,o,a,n,l,s,p,c,u,h,d,y,g,f,m,_,S,I,v,k=this;if(x.time("ParseTemplate"),g=this._graphPassDefinitionList=e.graphs,this._landColor=e.landColor,this._drawOrderList=e.drawOrder,this._shieldStyleResponseData={},e&&e.shields)for(f=0,i=e.shields.length;f<i;f++)r=e.shields[f],this._shieldStyleResponseData[r.shieldBucketId]=r.passID[0];for(this._passDefinitionList=e.passDefinitions,this._imageGroups=e.imageGroups,this._groupedImageOptions=e.groupedImageOptions,this._state=e.state||[],this._propertyValues=e.propertyValues,this._svgColor=e.svgColor,this._serverColorValues=e.colorValues,this._serverSingleValues=e.singleValues,this._serverBooleanValues=e.booleanValues,this._serverStringValues=e.stringValues,this._serverEnumValues=e.enumValues,H.fontFamilies=e.fontFamilies,this._markupOrderList=e.markupOrder,this._visibilityRanges=e.visibilityRanges,this._computedSplineGraphs=new Array(g.length),this._computedSplineGraphPaletteKeys=new Array(g.length),this._mapImages=[],this._imgVariants=e.imageVariantsList,this._fixedStringList=e.fixedStrings,this._fixedStringMap={},o=0,a=this._fixedStringList.length;o<a;o++)this._fixedStringMap[this._fixedStringList[o]]=o;for(this._palette=this._createPalette(e.paletteDefinitions,e.paletteItems),g=this._getFixedStringId("Global.ImageFamily"),g=this._palette.getStringPaletteValue(g),this._paletteFlavorKeyId=this._getFixedStringId(g),n=this._getFixedStringId("Default"),f=T=0;f<(this._imgVariants&&this._imgVariants.length);f++){for(s=this._imgVariants[f],_=0;_<s.imageReferences.length;_++){if((p=s.imageReferences[_]).keyId===this._paletteFlavorKeyId){l=p.imageId;break}p.keyId===n&&(l=p.imageId)}this._unmappedToMappedImageIndex[l]=T,this._mappedToUnmappedImageIndex[T++]=l}for(this._shapeImageLookup={},u=0,h=(c=e.shapeImageLookup&&e.shapeImageLookup.idPair||[]).length;u<h;u++)(d=c[u])&&(y=d.second,this._shapeImageLookup[d.first]=y,this._unmappedToMappedImageIndex[y]||(this._unmappedToMappedImageIndex[y]=T,this._mappedToUnmappedImageIndex[T++]=y));for(g=this._palette.getBackgroundShapeIds().map(function(e){return k._shapeImageLookup[e]}),this._initClassicIcons(),this._setStateIndex(),f=0;f<e.visibilityRanges.length;f++)if(m=e.visibilityRanges[f])for(_=0;_<m.length;_++){var b=m[_],T=b.visibleValueId||0,P=e.booleanValues[T];P&&(1===P.type?b.visible=P.fValue||!1:(b.visible=this._palette.getBooleanPaletteValue(P.pValue),b.visiblePaletteKey=P.pValue))}for(this._styleVisibilities=[],this._markupVisibilities=[],_=0,S=this._drawOrderList.bucket.length;_<S;_++)I=this._drawOrderList.bucket[_].toString(),v=this._drawOrderList.passID[_],this._bucketToPassDefinitionIndex[I]=v,this._bucketToDrawOrderListIndex[I]=_,0<=(v=this._getMappedImageIndex(v))&&(this._bucketToMappedImageIndex[I]=v),v=this._mappedToUnmappedImageIndex[v],this._unmappedIndexToBucketIds[v]||(this._unmappedIndexToBucketIds[v]=[]),this._unmappedIndexToBucketIds[v].push(I);x.timeEnd("ParseTemplate"),this.prefetchImages([ye._haloImageBucket,ye.DefaultBucketForLocalCat,ye.pricePoiBucketId,ye.xsrPolygonBucketId,ye.cityPolygonBucket,ye.itineraryPoiBucketId,ye._multimodeTransitBucket],g,!0).then(function(){k._initialized=!0,k._ready=new E(k),t(),k.ready&&k.ready.invoke()})},ye.prototype._populateSplineGraphValueAndPaletteKey=function(e,t){var i,r,o,a,n;switch(t){case 1:for(r=0;r<e.length;r++)if("number"==typeof(a=void 0!==(o=e[r]).valueId?o.valueId:o.value)){if(!(n=this._serverColorValues[a]))continue;1===n.type?o.value=n.fValue||0:(o.value=this._palette.getColorPaletteValue(n.pValue,!1),o.paletteKey=n.pValue,isNaN(o.value)&&(o.value=-1))}break;case 2:for(r=0;r<e.length;r++)if("number"==typeof(a=void 0!==(o=e[r]).valueId?o.valueId:o.value)){if(!(n=this._serverSingleValues[a]))continue;1===n.type?o.value=n.fValue||0:(o.value=this._palette.getSinglePaletteValue(n.pValue),o.paletteKey=n.pValue)}break;case 16:for(r=0;r<e.length;r++)if("number"==typeof(a=void 0!==(o=e[r]).valueId?o.valueId:o.value)){if(!(n=this._serverBooleanValues[a]))continue;1===n.type?o.value=n.fValue||!1:(o.value=this._palette.getBooleanPaletteValue(n.pValue),o.paletteKey=n.pValue)}break;case 17:for(r=0;r<e.length;r++)if("number"==typeof(a=void 0!==(o=e[r]).valueId?o.valueId:o.value)){if(!(n=this._serverStringValues[a]))continue;1===n.type?(i=n.fValue||0,o.value=this._fixedStringList[i]):(o.value=this._palette.getStringPaletteValue(n.pValue),o.paletteKey=n.pValue)}break;case 18:for(r=0;r<e.length;r++)if("number"==typeof(a=void 0!==(o=e[r]).valueId?o.valueId:o.value)){if(!(n=this._serverEnumValues[a]))continue;1===n.type?o.value=n.fValue||0:(o.value=this._palette.getSinglePaletteValue(n.pValue,!1,0),o.paletteKey=n.pValue)}}},ye.prototype._getComputedSplineGraph=function(e){var t,i,r,o,a,n,l,s,p,c,u,h,d,y,g;if(void 0===this._computedSplineGraphs[e]){if(g=null,!(t=this._graphPassDefinitionList[e])||t.length<1)return this._computedSplineGraphs[e]=g;if((h=t[0].graphType)&&this._populateSplineGraphValueAndPaletteKey(t,h),i=t[0],null!==(r=this._getColorformat(i))){for(o=new I,c=0;c<t.length;c++)l=t[c],a=new k(l.value,r),o.addKey(l.position,a.red,a.green,a.blue,a.alpha,"Smooth"===l.tangentType?1:"Step"===l.tangentType?2:0),c+1<t.length&&(t[c+1].graphType=1,r=this._getColorformat(t[c+1]));o.computeTangents(),g=o}else if(this._IsCurveGraph(i)){for(n=new _,c=0;c<t.length;c++)l=t[c],s=new m(l.position,l.value,"Smooth"===l.tangentType?1:"Step"===l.tangentType?2:0),n.addKey(s);n.computeTangents(),g=n}else if(this._IsDiscreateCollectionGraph(i)){for(p=new T,c=0;c<t.length;c++)p.addRange(t[c].start,t[c].end,t[c].value);g=p}else this._IsTransformCurveGraph(i)?(d=i.numericTransformCurve,(y=this._getComputedSplineGraph(d))&&(g=new A(y))):this._IsHslaTransformCurveGraph(i)&&(u=this._getComputedSplineGraph(i.h),h=this._getComputedSplineGraph(i.s),d=this._getComputedSplineGraph(i.l),y=this._getComputedSplineGraph(i.a),g=new w(u,h,d,y));this._computedSplineGraphPaletteKeys[e]=g&&i.paletteKey?i.paletteKey:null,this._computedSplineGraphs[e]=g}return this._computedSplineGraphs[e]},ye.prototype._getImageByBucketId=function(e){var t;return this._images?(this._images[e]||(t=this._bucketToMappedImageIndex[e],this._updateCachedImages(this._mappedToUnmappedImageIndex[t])),this._images[e]):null},ye.prototype._getImage=function(e){return this._imageLoader.getImage(e,this._templateName,this._svgColor,this._palette)},ye.prototype._getOrgImage=function(e){return this._imageLoader.getOrgImage(e,this._templateName,this._palette)},ye.prototype._updateCachedImages=function(e){var t,i,r,o,a,n,l=this._getImage(e);if(l&&(t=this._unmappedToMappedImageIndex[e],!this._mapImages[t]&&(this._mapImages[t]=l,i=this._unmappedIndexToBucketIds[e])))for(r=0,o=i;r<o.length;r++)a=o[r],n=this._passDefinitionList[this._bucketToPassDefinitionIndex[a]],this._images[a]={scale:n.scale,scaleTransform:n.scaleTransform,template:new H(l),visibility:this._getStyleVisibility(this._bucketToDrawOrderListIndex[a])}},ye.prototype._initClassicIcons=function(){var e=this._imageLoader.createClassicIcon(this._palette),t=this._palette,i=t.addFixedString("Classic");this._shapeImageLookup[i]=e,t.addPaletteItem("DefaultPointStateClassic.Shape-Background",i={type:0,hasValue:!0,stringId:i}),t.addPaletteItem("HoverPointStateClassic.Shape-Background",i),t.addPaletteItem("HoverPointStateClassic.HighlightScale",{type:2,hasValue:!0,value:1.3}),t.addPaletteItem("HoverPointStateClassic.HighlightStrokeWidthScale",{type:2,hasValue:!0,value:2}),t.addPaletteItem("SelectedPointStateClassic.Shape-Background",i),t.addPaletteItem("SelectedPointStateClassic.HighlightScale",{type:2,hasValue:!0,value:1.8}),t.addPaletteItem("SelectedPointStateClassic.HighlightStrokeWidthScale",{type:2,hasValue:!0,value:2}),t.addPaletteItem("InactivePointStateClassic.Shape-Background",i),t.addPaletteItem("InactivePointStateClassic.HighlightScale",{type:2,hasValue:!0,value:0}),t.addPaletteItem("InactiveSelectedPointStateClassic.Shape-Background",i),t.addPaletteItem("InactiveSelectedPointStateClassic.HighlightScale",{type:2,hasValue:!0,value:1.5})},ye.prototype._createPalette=function(e,t){var i,r,o,a,n,l,s,p,c,u,h,d,y,g,f,m,_,S,I,v,k,b,T=e.nodes,P=e.types;for(C&&C.initialize(T,this._fixedStringList),r={},o={},I=0;I<P.length;I++)if(a=P[I]){for(n=a.parentId,g=this._fixedStringList[a.nameId],r[I]={name:g,properties:[]},0<=n&&((l=r[n])?r[I].parent=l:o[I]=n),s=a.properties,p=0;p<s.length;p++)(c=s[p])&&(u=this._fixedStringList[c.nameId],r[I].properties.push({propertyName:u,valueType:c.valueType}));for(b in o)I===o[b]&&(_=r[b],_&&(_.parent=r[I],delete o[b]))}for(h={},d={},I=0;I<T.length;I++)if((y=T[I])&&(g=this._fixedStringList[y.nameId],(f=r[y.nodeTypeId])||!(0<=y.parentId)))for(b in h[I]={name:g,nodeType:f},0<=y.parentId&&((m=h[y.parentId])?(m.children||(m.children=[]),m.children.push(h[I])):d[I]=y.parentId),d)I===d[b]&&(_=h[b],_&&(_.children||(_.children=[]),_.children.push(h[I]),delete d[b]));for(S={},I=0;I<t.length;I++)if(v=t[I],k=this._fixedStringList[v.keyId],v&&k)switch(v.type){case"StringPaletteItem":S[k]={keyId:v.keyId,type:0,stringId:v.stringPaletteItem};break;case"ColorPaletteItem":S[k]={keyId:v.keyId,type:1,value:v.colorPaletteItem.value,ignoreTransform:v.colorPaletteItem.ignoreTransform,additionalAttributes:v.colorPaletteItem.additionalAttributes};break;case"SinglePaletteItem":S[k]={keyId:v.keyId,type:2,value:v.singlePaletteItem.value,ignoreTransform:v.singlePaletteItem.ignoreTransform};break;case"EnumPaletteItem":S[k]={keyId:v.keyId,type:4,value:v.enumPaletteItem.value};break;case"BooleanPaletteItem":S[k]={keyId:v.keyId,type:3,value:v.booleanPaletteItem}}for(b in i=new ee(this._customStyleManager,this._fixedStringList,this._fixedStringMap),h)i.populate(h[b],S);return i.addPaletteItem("Inverted.FillColor",{type:1,hasValue:!0,value:-1,ignoreTransform:!1,additionalAttributes:{propertyReferenceId:this._getFixedStringId("IconColor")}}),i.addPaletteItem("Inverted.IconColor",{type:1,hasValue:!0,value:-1,ignoreTransform:!1,additionalAttributes:{propertyReferenceId:this._getFixedStringId("FillColor")}}),i},ye.prototype._getShieldUnmappedImageIndexes=function(e){var t,i,r,o,a,n,l,s=[],p=this._shieldStyleResponseData[parseInt(e)];if(p)for(t=p.length,i=this._getFixedStringId("Default"),r=0;r<t;r++){for(o=this._computeSplineGraphObject(this._passDefinitionList[p[r]].image,1),a=this._imgVariants[o].imageReferences,n=0;n<a.length;n++){if((l=a[n]).keyId===this._paletteFlavorKeyId){o=l.imageId;break}l.keyId===i&&(o=l.imageId)}s.push(o)}return s},ye.prototype._getShieldImages=function(e,t){for(var i,r,o,a=(a=this._shieldImages[e])||[],n=this._getShieldUnmappedImageIndexes(e),l=0;l<n.length;l++){for(r=-1,o=0;o<t.length;o++)if(t[o]===l){r=l;break}(i=this._mapImages[this._unmappedToMappedImageIndex[n[l]]])&&(-1===r||a[r]||(a[r]=new H(i)))}return this._shieldImages[e]=a},ye.prototype._getShieldScales=function(e,t){var i,r,o,a,n,l,s=this._shieldScaleListForZoom[e]||{};if(s&&!(i=s[t])){if(r=this._getStyleScale(e),o=this._shieldStyleResponseData[parseInt(t)])for(a=o.length,i=new Array(a),n=0;n<a;n++)l=this._passDefinitionList[o[n]],l=this._getScale(l.shieldScale,l.shieldScalingTransform,r),i[n]=l;s[t]=i,this._shieldScaleListForZoom[e]=s}return i},ye.prototype._getMarkupRecord=function(e,t,i){var r,o,a,n,l,s;if(x.time("ParseMarkupOrder"),o=this._markupOrder[r=e+","+t+","+i]||this._getStaticMarkupRecord(e,t,i))return o;(a=this._markupOrderList).validKeys={},a.keys=a.bucket,n=[],a.templates=new Array(a.passID.length);for(var p=this._getStyleScale(e),c=P.Browser.is_webkit?ye._webkitFontFillLightnessFactor:0,u=[],h=parseInt(t),d=0,y=a.bucket.length;d<y;d++)if(a.bucket[d]===h)this._getGeometryType(this._markupOrderList.geometry[d])===i&&u.push(d);else if(0<u.length)break;if(0===u.length)return null;for(l=0,s=u.length;l<s;l++){var g=u[l],f={},m=a.passID[g];n[m]||(n[m]=this._getMarkupOrderTemplate(m,p,c)),f.style=n[m],o?o.style.styleDynamic.secondaryFontSize=f.style.styleDynamic.fontSize:(f.visibility=this._getMarkupVisibility(g),f.priority=a.priority[g],f.globalOrder=g+1,o=f)}return this._markupOrder.addItem(r,o),x.time("PopulateMarkupOrder"),x.timeEnd("ParseMarkupOrder"),o},ye.prototype._getStaticMarkupRecord=function(e,t,i){var r=t+","+i,o=ye._poiStyles[this._templateName][r];if(o){var a=e+","+r,n=[{visible:!0,visiblePaletteKey:this._fixedStringMap["UserPoint.LabelVisible"],zoom:0}],l={drawingStyleVisibilities:{}},r=l.drawingStyleVisibilities;if(r[3]=r[2]=r[1]=n,n={style:{styleStatic:D._copyObject(o.styleStatic),styleDynamic:o.styleDynamic},priority:o.styleDynamic.priority,globalOrder:o.styleDynamic.globalOrder},this._markupOrder.addItem(a,n),1===i){var a=this._getMarkupRecord(e,ye.DefaultBucketForLocalCat,i).style,s=D._copyObject(a.styleStatic),i=a.styleDynamic,p=a.styleDynamic.fontColor;switch(s.wrapDisplayName=!0,s.backgroundColor=ye.isDarkTheme(this._templateName)?"rgba(64,64,64,0.7)":"rgba(236,234,227,0.7)",t){case ye.bucketIdForPoi:e<16?(s.offsetX=13,s.offsetY=13):16<=e&&e<=19?(s.offsetX=15,s.offsetY=15):(s.offsetX=17,s.offsetY=17);break;case ye.bucketIdForSelectedPoi:s.offsetX=24,s.offsetY=24,p=this._getColor("SelectedPointState"+ye._labelColor,!0)}t=(a=n.style).styleDynamic,a.styleStatic=s,t.font=i.font,t.fontPaletteKey=i.fontPaletteKey,t.fontColor=p,t.fontColorPaletteKey=i.fontColorPaletteKey,t.fontSize=i.fontSize,t.secondaryFontSize=i.secondaryFontSize,t.fontWeight=i.fontWeight,t.fontWeightPaletteKey=i.fontWeightPaletteKey,t.fontStyle=i.fontStyle,t.fontStylePaletteKey=i.fontStylePaletteKey,t.fontCaps=i.fontCaps,t.fontCapsPaletteKey=i.fontCapsPaletteKey,t.outlineColor=i.outlineColor,t.outlineColorPaletteKey=i.outlineColorPaletteKey,n.visibility=l}}return n},ye.prototype._getMarkupOrderTemplate=function(e,t,i){var r,o,a=this._passDefinitionList[e],n={styleStatic:{},styleDynamic:{font:"",fontSize:0,fontColor:"",outlineColor:""},markupPassDefinitionIndex:e},l=n.styleStatic,s=n.styleDynamic;switch(s.font=this._computeSplineGraphObject(a.fontName,t)||"SegoeBing",s.fontPaletteKey=this._getSplineGraphPaletteKey(a.fontName),e=this._computeSplineGraphObject(a.fontColorTransform,t),s.fontColor=e?this._computeHslaTransform(a.fontColor,t,e,i):this._computeSplineGraphObject(a.fontColor,t),s.fontColorPaletteKey=this._getSplineGraphPaletteKey(a.fontColor),s.fontWeight=this._computeSplineGraphObject(a.fontWeight,t)||0,s.fontWeightPaletteKey=this._getSplineGraphPaletteKey(a.fontWeight),s.fontStyle=this._computeSplineGraphObject(a.fontStyle,t)||0,s.fontStylePaletteKey=this._getSplineGraphPaletteKey(a.fontStyle),s.fontCaps=this._computeSplineGraphObject(a.fontCapitals,t)||0,s.fontCapsPaletteKey=this._getSplineGraphPaletteKey(a.fontCapitals),l.preferredFontSize=this._computeSplineGraphObject(a.preferedFontSize,t),l.preferredFontSizePaletteKey=this._getSplineGraphPaletteKey(a.preferedFontSize),l.fontSizeTransform=this._computeSplineGraphObject(a.preferedFontSizeTransform,t)||1,s.fontSize=l.preferredFontSize*l.fontSizeTransform,l.pointLabelPlacementPreference=this._computeSplineGraphObject(a.pointPlacement,t),l.polygonFillPreference=this._computeSplineGraphObject(a.areaFillingPreference,t),l.verticalAlignment=this._computeSplineGraphObject(a.lineVerticalAlign,t),l.fontGlow=this._computeSplineGraphObject(a.fontGlow,t),l.fontOutlined=this._computeSplineGraphObject(a.fontOutlined,t),l.fontUnderlined=this._computeSplineGraphObject(a.fontUnderlined,t),l.glowColor=this._computeSplineGraphObject(a.glowColor,t),l.glowSize=this._computeSplineGraphObject(a.glowSize,t),this._computeSplineGraphObject(a.heightMatch,t)){case"LabelHeightMatchXHeight":r=2;break;case"LabelHeightMatchAscent":r=1;break;default:r=0}return 0!==r&&(o=0,(e=this._computeSplineGraphObject(a.heightMatchPixels,t))&&((i=this._computeSplineGraphObject(a.heightMatchPixelsTransform,t))&&(e*=i),1===r?o=e*ye._capHeightRatio:2===r&&(o=e*ye._xHeightRatio),o<s.fontSize&&(s.fontSize=o))),o=this._computeSplineGraphObject(a.outlineColorTransform,t),s.outlineColor=o?this._computeHslaTransform(a.outlineColor,t,o):this._computeSplineGraphObject(a.outlineColor,t),s.outlineColorPaletteKey=this._getSplineGraphPaletteKey(a.outlineColor),l.outlineWidth=this._computeSplineGraphObject(a.outlineWidth,t),l.outlineWidth<2&&(l.outlineWidth+=ye._outlineWidthDelta),B.ignoreStrata||((s={}).alpha=this._computeSplineGraphObject(a.overrideAlpha,t),s.fontSize=this._computeSplineGraphObject(a.strataFontSize,t),l.strataStyle=s),t=this._computeSplineGraphObject(a.shieldLabelVisibility,t),l.shieldLabelVisibility="Both"===t?2:"NoText"===t?1:0,n},ye.prototype._applyStackedBackgroundShape=function(e,t,i,r){function o(e,t){for(var i,r,o=e&&Object.keys(e)||[],a=0,n=o.length;a<n;a++)(i=o[a]).endsWith("PaletteKey")&&(2===(r=(e[i]||"").split(".")).length&&(e[i]=t+"."+r[1]))}for(var a,n,l,s,p,c=this,u=r&&r.getVectorImage(),h=u&&u.records||[],d="",y=0,g=h.length;y<g;y++)if(a=h[y].shapePaletteKey)if(d){if(a!==d)break;p=y}else a.endsWith(ye.backgroundShapeRecord)&&(s=p=y,d=a);else if(d)break;if(2===e||3===e)n=this._mapImages[this._bucketToMappedImageIndex[2===e?ye.pricePoiBucketId:ye.itineraryPoiBucketId]];else{if(!(f=this._getStackedStringValue(i,d)))return r;n=function(e){e=c._getFixedStringId(e),e=c._shapeImageLookup[e];return c._getImage(e)}(f)}if(n){i=JSON.parse(JSON.stringify(n.records)),f=void 0;var f=t?h.filter(function(e){return 3===e.vectorType}):(i=i.filter(function(e){return 3!==e.vectorType}),h.slice(p+1)),e=n.overrideHotspot||2===e,m=[].concat(h.slice(0,s),i,f),u={hotspotX:(e?n:u).hotspotX,hotspotY:(e?n:u).hotspotY,hitTest:u.hitTest,records:m};for(r=new H(u),l=d.split(".")[0],y=0,g=i.length;y<g;y++)o(m[y],l),o(m[y].style,l)}return r},ye.prototype._applyStackedColor=function(e,t,i,r){r=this._getStackedColorValue(e,r);r&&(t[i]=r)},ye.prototype._getStackedColorValue=function(e,t){var i;return 2===(t=(t=t||"").split(".")).length&&(i=this._palette.getStackedColorPaletteValue(e.concat(t[0]),t[1]),i=isNaN(i)?"":isFinite(i)?b.convertPackedTorgba(i):k.black),i},ye.prototype._applyStackedScale=function(e,t,i,r){r=this._getStackedNumericValueItem(e,r),r=r&&r.value;"number"==typeof r&&isFinite(r)&&(t[i]*=r)},ye.prototype._getStackedNumericValueItem=function(e,t){var i=null;return i=2===(t=(t=t||"").split(".")).length?this._palette.getStackedSinglePaletteItem(e.concat(t[0]),t[1]):i},ye.prototype._applyStackedEnum=function(e,t,i,r){r=this._getStackedEnumValue(e,r);r&&(t[i]=r)},ye.prototype._getStackedEnumValue=function(e,t){var i;return i=2===(t=(t=t||"").split(".")).length?this._palette.getStackedEnumPaletteValue(e.concat(t[0]),t[1]):i},ye.prototype._applyStackedString=function(e,t,i,r){r=t[r],r=this._getStackedStringValue(e,r);r&&(t[i]=r)},ye.prototype._getStackedStringValue=function(e,t){var i;return i=2===(t=(t=t||"").split(".")).length?this._palette.getStackedStringPaletteValue(e.concat(t[0]),t[1]):i},ye.prototype._getStackedBooleanValue=function(e,t){var i;return i=2===(t=(t=t||"").split(".")).length?this._palette.getStackedBooleanPaletteValue(e.concat(t[0]),t[1]):i},ye.prototype._getColor=function(e,t){e=this._getFixedStringId(e),t=this._palette.getColorPaletteValue(e,t);return isNaN(t)?"":t||0===t?b.convertPackedTorgba(t):k.black},ye.prototype._getScale=function(e,t,i,r,o){return void 0===o&&(o=!1),e=void 0!==r?r:this._computeSplineGraphObject(e,i),o||0<(i=this._computeSplineGraphObject(t,i))&&(e*=i),e},ye.prototype._setStateIndex=function(){for(var e="en-us",t=this._currentStateIndex=0;t<this._state.length;t++)if(r=this._state[t].idPair[0]){var i=this._propertyValues[r.second],r=this._fixedStringList[i.propVal].toLowerCase(),i=F.dynamicProperties.market.toLowerCase();if(i===e&&r===e||i.substr(0,2)!==e.substr(0,2)&&r.substr(0,2)===i.substr(0,2)){this._currentStateIndex=t;break}}},ye.prototype._getMappedImageIndex=function(e){var t,i,r,e=this._passDefinitionList[e],o=-1;if(void 0!==e.imageGroup){if(o=Math.round(this._computeSplineGraphObject(e.imageGroup,1)),!(t=this._imageGroups[o].images))return o;for(i=0;i<t.length;i++){if((r=this._groupedImageOptions[t[i]]).stateId==this._currentStateIndex){o=r.mapImage;break}0==r.stateId&&(o=r.mapImage)}}return o},ye.prototype.getRoutePoiVectorImageTemplate=function(e,t,i){var r=ye.directionIconTypeBuckets[e],o=ye._getPointStateName(t,ye._poiTypeStateGroups[7]),a="d"+r+o+i.toString(),n=this._primitiveTemplateCache.getItem(a);return n||((n=this._getTemplates_PoiRefresh(7,!1,r,null,1,i,[o],!0,!0,null))&&n.length?this._primitiveTemplateCache.addItem(a,n):n="turn"===e?[te.directionsTurnTemplate]:[te.poiTemplates[t]],n)},ye.prototype._addShadow_PoiRefresh=function(e,t,i){var r;e&&e.length&&t&&this._computeSplineGraphObject(t.shadow,i)&&(r=this._computeSplineGraphObject(t.glowColor,i),i=this._computeSplineGraphObject(t.glowSize,i),(e=(e=e[0])&&e.shadowStyle)&&(e.shadowColor=r,e.shadowBlur=i,e.shadowOffset={x:0,y:2}))},ye._getPointStateName=function(e,t){e=ye._poiStateNames[e]||"";return t&&e.endsWith("PointState")&&(e+=t||""),e},ye.prototype.getCategoryIconTemplate=function(e,t,i,r,o){t=ye.getBucketForCategory(t)||ye.DefaultBucketForLocalCat;this.getIconTemplate(e,t,!1,i,r,o)},ye.prototype.getIconTemplate=function(d,y,g,f,m,_){var S=this,I=""+y+g+f+m+_,e=this._categoryIconCache.getItem(I);d&&(e?Microsoft.Maps.setAsync(function(){d(e)}):this.prefetchImages([y]).then(function(){var e,t,i,r,o=ye._transitBucketIds[y],a=ye._getPointStateName(2,ye._poiTypeStateGroups[5]),n=S._getTemplates_PoiRefresh(5,!1,y,null,1,12,[a],!0,!0,null),a=n&&n[0],n=null,l="",s="",p=null;if(a){for(t={hotspotX:(e=a.getVectorImage()).hotspotX,hotspotY:e.hotspotY,records:[]},i=0,r=e.records.length;i<r;i++){var c=e.records[i],u=t.records[i]=D._copyObject(c),h=u.style=D._copyObject(c.style);g||(c.shapePaletteKey&&c.shapePaletteKey.endsWith(ye.backgroundShapeRecord)?(!s&&u.fillStylePaletteKey&&u.fillStylePaletteKey.endsWith(ye._fillColor)&&(s=h.fillStyle),h.fillStyle=h.strokeStyle=k.transparent):(l=l||h.fillStyle,h.fillStyle=f||(o?s:l),h.strokeStyle=k.transparent))}n=new H(t),m&&(_=_||m,(a=n.getBounds().getSize()).width&&a.height&&n.setScale(Math.min(m/a.width,_/a.height))),p={icon:n,iconColor:o?s:l},S._categoryIconCache.addItem(I,p)}Microsoft.Maps.setAsync(function(){d(p)})}))},ye.prototype._getLandmarkVectorImageTemplate_PoiRefresh=function(e,t,i,r){var o,a,n,l=e.bucket,s=e.entity&&e.entity.oid||"",p=ye._getPointStateName(t,ye._poiTypeStateGroups[r]);if(ye._multimodeTransitBucketIds[l]&&4===r&&(l=ye._multimodeTransitBucket),(n=(a=this._bucketToDrawOrderListIndex[l])&&this._getStyleVisibility(a))&&this._isTemplateVisible(i,n,e.geometryType)){if(t=this._getScaleFromZoom(i,l,s,[p]),o=this._primitiveTemplateCache.getItem(a=""+r+l+s+p+t))return o;o=this._getTemplates_PoiRefresh(r,!1,l,s,e.geometryType,i,[p],!1,!0,t),D._renderAllPoiAndLabelsGL()&&n&&(e.visibilities=n.drawingStyleVisibilities[e.geometryType]),o&&this._primitiveTemplateCache.addItem(a,o)}return o},ye.prototype._getBucketPaletteKey=function(e,t){var i,r,o,a,n="";if(!e||e===t)return n;if(t=ye._bucketPaletteMap)n=t[e]||"";else{if(e=(e=this._getImageByBucketId(e))&&e.template)for(r=0,o=(i=e.getVectorImage()).records.length;r<o;r++)if(!(a=i.records[r]).shapePaletteKey||!a.shapePaletteKey.endsWith(ye.backgroundShapeRecord)){n=a.fillStylePaletteKey;break}n&&(1<(e=n.split(".")).length&&(n=e[0]))}return n},ye.prototype._getPoiVectorImageTemplate_PoiRefresh=function(e,t,i,r,o,a){var n,l,s=a;if(s=!a?(l=(l=this._bucketToDrawOrderListIndex[e])&&this._getStyleVisibility(l))&&this._isTemplateVisible(r,l,1):s){if(l=this._getScaleFromZoom(r,e,null,t),s=e+","+t.join(".")+","+l+","+o,n=this._primitiveTemplateCache.getItem(s))return n;(n=this._getTemplates_PoiRefresh(i,o,e,null,1,r,t,a,!0,l))&&this._primitiveTemplateCache.addItem(s,n)}return n},ye.prototype._getTemplates_PoiRefresh=function(e,t,i,r,o,a,n,l,s,p){var c,u,h,d,y,g,f,m=null;if(!this._initialized)return x.log(null,"TemplateSelector needs to be initialized before getTemplates() call"),null;var _=this._passDefinitionList[this._bucketToPassDefinitionIndex[i]],S=this._getStyleScale(a),I=r&&this._getOrgImage(r);if(r&&I)r=this._getStyleVisibility(this._bucketToDrawOrderListIndex[i]),(l||this._isTemplateVisible(a,r,o))&&(c=null===p?this._getScale(_.scale,_.scaleTransform,S):p,m=[new H(I,c)]);else if((i=(c=this._getImageByBucketId(i))?c.template:null)&&s&&(f=JSON.parse(JSON.stringify(i.getVectorImage())),i=new H(f)),i&&(l||this._isTemplateVisible(a,c.visibility,o))){for(2===e?i=this._applyStackedBackgroundShape(2,t,n,i):t&&!i.hasPlaceholderText&&(i=this._applyStackedBackgroundShape(3,t,n,i)),h=0,d=(u=(f=(i=this._applyStackedBackgroundShape(null,t,n,i)).getVectorImage()).records).length;h<d;h++)g=(y=u[h]).style,this._applyStackedColor(n,g,"fillStyle",y.fillStylePaletteKey),this._applyStackedColor(n,g,"strokeStyle",y.strokeStylePaletteKey),this._applyStackedScale(n,g,"lineWidthScale",y.strokeScalePaletteKey),this._applyStackedScale(n,y,"scale",y.scalePaletteKey);p=null===p?(f=this._getSplineGraphPaletteKey(c.scale),f=this._getStackedNumericValueItem(n,f)||{},this._getScale(c.scale,c.scaleTransform,S,f.value,f.ignoreTransform)):p,i.setScale(p),m=[i]}return this._addShadow_PoiRefresh(m,_,S),m},ye.prototype.getMarkupStyle=function(e,t,i,r){var o;if(e){var a=e.stylesheetEntry,n=e.stylesheetEntryState,l=e.bucket||this._customStyleManager.getElementBucket(a,e.geometryType);if(l){var s=l.toString(),l=e.geometryType,e=Math.round(U.fromScale(null,t,!0)),t=this._markupOrder.getItem(e+","+s+","+l);if(!(t=t||this._loadTemplates(e,s,l))){if(o=s,s=this._getOriginalBucketId(s),x.assert(null!=s,"failed to map bucketId "+o),!s)return;(t=this._getMarkupRecord(e,s,l))&&this._markupOrder.addItem(e+","+o+","+l,t)}if(t)return o=[],(r=ye._getPointStateName(i,ye._poiTypeStateGroups[r]))&&(3===l&&(r=r.replace("Point","Area")),o.push(r)),a&&0<=a.indexOf(".")&&o.push(a),n&&o.push.apply(o,n.split(";")),(o=this._computeStyleDynamic(t,l,e,o))?{styleStatic:t.style.styleStatic,styleDynamic:o}:void 0}}},ye.prototype.getLandmarkVectorImageTemplate=function(e,t,i,r){void 0===r&&(r=5);var o=e.bucket,a=!!$.getTransitJson(e.entity)&&e.layer&&e.layer.getHighlighted(),i=U.fromScale(null,i,!0);return a?r=4:5===r&&ye._transitBucketIds[o]&&(r=6),this._getLandmarkVectorImageTemplate_PoiRefresh(e,t,i,r)},ye.prototype.getPoiTemplate=function(e,t,i,r,o,a,n,l){return void 0===o&&(o=!0),void 0===a&&(a=!0),t=(t=ye._getPointStateName(t,ye._poiTypeStateGroups[r=void 0===r?1:r]))?[t]:[],n&&0<=n.indexOf(".")&&t.push(n),l&&t.push.apply(t,l.split(";")),3===r?t.push("ItineraryPoint"):1!==r&&4!==r||!ye._invertedIconBucketIds[e]||t.push("Inverted"),e=e||(n?(n=this._customStyleManager.getElementBucket(n,1))&&n.toString():ye.DefaultBucketForLocalCat),(a=this._getPoiVectorImageTemplate_PoiRefresh(e,t,r,i,o,a))&&a.slice()},ye.prototype.getPoiVectorImageTemplate=function(e,t,i,r,o,a,n){void 0===r&&(r=1),void 0===o&&(o=!0);var l,n="number"==typeof n?ye._taskList[n]:void 0,e=ye.getBucketForCategory(e),a=ye.getBucketForCategory(a),e=e||ye.DefaultBucketForLocalCat;return n?l=n:(a=this._getBucketPaletteKey(a,e))&&(l=a),this.getPoiTemplate(e,t,i,r,o,!0,null,l)},ye._setLineDashes=function(e,t,i){var r,o;if(e&&"number"==typeof e&&isFinite(e)&&"number"==typeof t&&0<t&&t<=32){r=[],a=void 0,(e=Math.floor(e))<0&&(e>>>=0);for(var a,n=0,l=0,s="",p=(a=e.toString(2).slice(-t)).length-1;0<=p;p--)(o=a[p])!==s&&(l&&(r.length||"0"!==s?r.push(l):n=l),s=o,l=0),l++;a.length<t&&(r.push(l),l=t-a.length),n?(r.push(l,n),i.dashes=r,i.dashOffset=n):r.length&&(r.push(l),i.dashes=r)}},ye.prototype._applyPolygonDrawingPass=function(e,t,i){var r,o,a,n,l;return e&&(e.brushColor?(o=e.brushColor,r={},(a=this._getStackedColorValue(t,this._fixedStringList[this._getComputedSplineGraphPaletteKey(o)]))?r.fillStyle=a:(n=this._computeSplineGraphObject(e.brushColorTransform,i),r.fillStyle=n?this._computeHslaTransform(o,i,n):this._computeSplineGraphObject(o,i))):e.penColor&&(o=e.penColor,(r={}).strokeStyle&&(r.secondaryLineWidth=r.lineWidth,r.secondaryStrokeStyle=r.strokeStyle),(a=this._getStackedColorValue(t,this._fixedStringList[this._getComputedSplineGraphPaletteKey(e.penColor)]))?r.strokeStyle=a:(n=this._computeSplineGraphObject(e.penColorTransform,i),r.strokeStyle=n?this._computeHslaTransform(o,i,n):this._computeSplineGraphObject(o,i)),e.penWidth&&(l=this._getSplineGraphPaletteKey(e.penWidth),l=this._getStackedNumericValueItem(t,l)||{},r.lineWidth=this._getScale(e.penWidth,e.penWidthTransform,i,l.value,l.ignoreTransform)),e.bitPattern&&(l=this._computeSplineGraphObject(e.bitPattern,i),i=this._computeSplineGraphObject(e.patternRepeat,i),ye._setLineDashes(l,i,r)))),r},ye.prototype.getFirstDrawOrder=function(e){e=parseInt(e);return this._drawOrderList.bucket.indexOf(e)},ye.prototype.getPolygonTemplates=function(e,t,i,r,o,a,n,l){var s,p,c,u,h,d,y,g=t?parseInt(t):this._customStyleManager.getElementBucket(n,e),t=U.fromScale(null,o,!0),o="apt_"+e+"_"+g+"_"+i+"_"+t+"_"+a+"_"+n+"_"+l,e=this._primitiveTemplateCache.getItem(o);if(e)return e;switch(i){default:case 2:s="DefaultAreaState";break;case 3:s="HoverAreaState";break;case 4:s="SelectedAreaState"}(r=ye._poiTypeStateGroups[r])&&(s+=r);var f=s?[s]:[],m=this._getStyleScale(t),_=this._drawOrderList,S=this._passDefinitionList,I=D._allIndexesOf(_.bucket,g);if(n&&0<=n.indexOf(".")&&f.push(n),l&&f.push.apply(f,l.split(";")),I&&I.length){for(p=[],c=void 0,u=0,h=I.length;u<h;u++)y=S[_.passID[I[u]]],(d=this._applyPolygonDrawingPass(y,f,m))&&(d.hitTest=a,y=!1,c&&(d.fillStyle?c.fillStyle||(y=!0):d.strokeStyle&&(d.dashes||c.dashes||(c.strokeStyle?!c.secondaryStrokeStyle&&c.lineWidth>d.lineWidth&&(c.secondaryLineWidth=c.lineWidth,c.secondaryStrokeStyle=c.strokeStyle,y=!0):y=!0))),y?N.mergeProperties(c,d):(c=d,p.push(d)));e=p.map(function(e){return new v(e)}),this._primitiveTemplateCache.addItem(o,e)}return e},ye.prototype.getCityPolygonTemplates=function(e,t,i,r,o){var a=null;return a=e===ye.cityPolygonBucket||e===ye.xsrPolygonBucketId?this.getPolygonTemplates(3,ye.xsrPolygonBucketId,i,1,r,o):a},ye.getPushpinTextTemplates=function(e,t,i,r){var o,a=[],n={style:{fillStyle:"rgb(255,255,255)",font:"Arial, Helvetica, Sans-Serif",fontStyle:1,fontSize:11.25,horizontalAutoScaling:1},text:"{MapDisplay}",anchor:{x:0,y:0},vectorType:3,scale:1};return t?(o=t.height,o={pointsList:[{x:0,y:0},{x:t=t.width,y:0},{x:t,y:o},{x:0,y:o}],vectorType:0,style:{fillStyle:"rgba(255,255,255,0)"},scale:1},n.maxWidth=t,n.style.fontSize=10,n.anchor.x=i.x,n.anchor.y=i.y,a=[new H({records:[o,n],hitTest:1},1,r)]):(r=(r=e.getVectorImage().records)[r.length-1])&&2===r.vectorType&&(r=ye._cloneObject(r),n.maxWidth=2*r.radiusX/1.414,a=[new H({records:[r,n],hitTest:1},e.getScale())]),a},ye.prototype.getTemplates=function(e,t,i){var r,o,a,n,l,s;if(void 0===i&&(i=!1),r=null,!this._initialized)return x.log(null,"TemplateSelector needs to be initialized before getTemplates() call",this._initialized),null;var p=e.bucket,c=U.fromScale(null,t,!0),t=this._getImageByBucketId(p),p=t?t.template:null;if(p&&i&&(o=JSON.parse(JSON.stringify(p.getVectorImage())),p=new H(o)),p&&this._isTemplateVisible(c,t.visibility,e.geometryType)){for(a=0,n=(o=p.getVectorImage()).records.length;a<n;a++)l=o.records[a].fillStylePaletteKey,(s=this._getColor(l,!1))&&l&&(-1<l.indexOf(ye._backgroundColor)||-1<l.indexOf(ye._borderColor)||l.indexOf(ye._colorString)||l.indexOf(ye._fillColor))&&(o.records[a].style.fillStyle=s);c=this._getStyleScale(c),c=this._getScale(t.scale,t.scaleTransform,c),p.setScale(c),r=[p]}return r},ye.prototype._getVisibilitiesByIndex=function(e,t,i,r){var o,a,n,l,s,p,c,u,h={drawingStyleVisibilities:{}};for(o in h.geometryType=this._getGeometryType(i[e]),t[e]){switch(a=[],h.densityLodCollection=new T,o){case"point":n=1;break;case"line":n=2;break;case"polygon":n=3}if(n===h.geometryType){for(var d,y=j.markupVisible,g=1,f=r[t[e][o]],m=0;m<f.length;m++)l=f[m],(s={visible:!1}).densityDistance=l.densityDistance,s.densityImportance=l.densityImportance,s.visible=l.visible,s.zoom=Math.round(j.calculateZoomforStyleScale(l.startZoomLevel)),s.visiblePaletteKey=l.visiblePaletteKey,a.push(s);for(m=a.length-1;0<=m;m--){if(s=a[m],d=this._getStyleScale(s.zoom),0===s.densityDistance&&0===s.densityImportance)h.densityLodCollection.addRange(d,g,y);else{for(c=y+(p=(g-d)/j.zoomDeltaBetweenLods),u=d;u<g;u+=j.zoomDeltaBetweenLods)h.densityLodCollection.addRange(u,u+j.zoomDeltaBetweenLods,c),c-=1;y+=p}g=d,s.densityLodDelta=y}}h.drawingStyleVisibilities[n]=a}return h},ye.prototype._getMarkupVisibility=function(e){return this._markupVisibilities[e]||(this._markupVisibilities[e]=this._getVisibilitiesByIndex(e,this._markupOrderList.visibilityIndex,this._markupOrderList.geometry,this._visibilityRanges)),this._markupVisibilities[e]},ye.prototype._getStyleVisibility=function(e){return this._styleVisibilities[e]||(this._styleVisibilities[e]=this._getVisibilitiesByIndex(e,this._drawOrderList.visibilityIndex,this._drawOrderList.geometry,this._visibilityRanges)),this._styleVisibilities[e]},ye.prototype._getComputedSplineGraphPaletteKey=function(e){return void 0===this._computedSplineGraphPaletteKeys[e]&&this._getComputedSplineGraph(e),this._computedSplineGraphPaletteKeys[e]},ye.prototype._getGeometryType=function(e){var t;switch(e){case 0:t=1;break;case 2:t=2;break;case 3:t=3}return t},ye.prototype._computeHslaTransform=function(e,t,i,r){var o;return this._computedSplineGraphs&&((e=this._getComputedSplineGraph(e))&&(o=e.evaluateHsla(t),o=b.applyHslaTransform(o,i),r&&o.z<.7&&(o.z*=r),o=b.hslaTorgba(o.x,o.y,o.z,o.w*ye._alphaTransformCoefficient).toRgba())),o},ye.prototype._computeSplineGraphObject=function(e,t){var i=null;if(this._computedSplineGraphs)return(e=this._getComputedSplineGraph(e))instanceof _?i=e.evaluate(t):e instanceof I?i=e.evaluate(t).toRgba():(e instanceof T||e instanceof A||e instanceof w)&&(i=e.evaluate(t)),i},ye.prototype._getSplineGraphPaletteKey=function(e){e=this._getComputedSplineGraphPaletteKey(e);return this._fixedStringList[e]},ye.prototype.getLandColor=function(){return this._landColor[0].value},ye.prototype._getOriginalBucketId=function(e){return Math.floor(65535&parseInt(e)).toString()},ye.prototype._computeStyleDynamic=function(e,t,i,r){var o,a,n,l,s,p,c=e.style,u=c.styleDynamic||{},c=c.styleStatic||{},h=u.visible,d=u.densityDistance,y=u.densityImportance,g=u.densityLodDelta,f=0;if(e.visibility){for(n=(a=e.visibility.drawingStyleVisibilities[t]).length,s=0;s<n;s++)p=a[s],f=f||p.visiblePaletteKey,i>=p.zoom&&(h=p.visible,d=p.densityDistance,y=p.densityImportance,g=p.densityLodDelta);if(3===t){for(l=!1,a=e.visibility.drawingStyleVisibilities[2],s=0;s<a.length;s++)p=a[s],f=f||p.visiblePaletteKey,i>=p.zoom&&(l=p.visible);(h||l)&&(h=!0)}f&&(void 0!==(t=this._getCustomStyle(f))?h=t:h&&(void 0!==(t=this._getStackedBooleanValue(r,this._fixedStringList[f]))&&(h=t)))}return h&&(o={visible:h,densityDistance:d,densityImportance:y,densityLodDelta:g,priority:e.priority,font:u.font,fontPaletteKey:u.fontPaletteKey,fontSize:u.fontSize,fontWeight:u.fontWeight,fontWeightPaletteKey:u.fontWeightPaletteKey,fontStyle:u.fontStyle,fontStylePaletteKey:u.fontStylePaletteKey,fontCaps:u.fontCaps,fontCapsPaletteKey:u.fontCapsPaletteKey,fontColor:u.fontColor,fontColorPaletteKey:u.fontColorPaletteKey,outlineColor:u.outlineColor,outlineColorPaletteKey:u.outlineColorPaletteKey,secondaryFontSize:u.secondaryFontSize||u.fontSize,globalOrder:e.globalOrder},this._applyStackedString(r,o,"font","fontPaletteKey"),"number"==typeof(e=(e=this._getStackedNumericValueItem(r,c.preferredFontSizePaletteKey))&&e.value)&&isFinite(e)&&(o.fontSize=e*c.fontSizeTransform),this._applyStackedEnum(r,o,"fontWeight",o.fontWeightPaletteKey),this._applyStackedEnum(r,o,"fontStyle",o.fontStylePaletteKey),this._applyStackedEnum(r,o,"fontCaps",o.fontCapsPaletteKey),this._applyStackedColor(r,o,"fontColor",o.fontColorPaletteKey),this._applyStackedColor(r,o,"outlineColor",o.outlineColorPaletteKey)),o},ye.prototype._getCustomStyle=function(e){var t,e=this._fixedStringList[e],e=e&&e.split(".");return t=e&&2===e.length?this._customStyleManager.getElementStyle(e[0],e[1]):t},ye.prototype._getStyleScale=function(e){return Math.round(1e7*j.calculateStyleScaleForLod(e))/1e7},ye.prototype.prefetchShields=function(u,h){var d=this;return void 0===h&&(h=3),new Promise(function(e){for(var t,i,r,o,a,n,l,s=[],p={},c=0;c<u.length;c++)for(t=d._getShieldUnmappedImageIndexes(u[c].bucketId),i=u[c].indexes,r=0;r<i.length;r++)0<=(o=t[i[r]])&&(d._getImage(o)?d._updateCachedImages(o):p[o]||(p[o]=!0));for(a=function(e){s.push(new Promise(function(t){d._imageLoader.prefetchImages(e,d._svgColor,d._palette,function(e){d._isDisposed||d._updateCachedImages(e[0]),t()},function(){0<h&&Microsoft.Maps.setTimeout(function(){d._isDisposed||d.prefetchShields(u,--h)},200),t()})}))},n=0,l=Object.keys(p);n<l.length;n++)a(l[n]);Promise.all(s).then(function(){e()})})},ye.prototype.prefetchOrganizationImagesByOrgId=function(e,o){var a,t,i,r,n=this;if(void 0===o&&(o=3),a=[],e)for(t=0,i=e;t<i.length;t++)r=i[t],this._getOrgImage(r)||a.push(r);return new Promise(function(e){for(var t=[],i=0,r=a;i<r.length;i++)(function(e){t.push(new Promise(function(t){n._imageLoader.prefetchOrgImage(e,n._palette,function(){t()},function(e){0<o&&Microsoft.Maps.setTimeout(function(){n._isDisposed||n.prefetchOrganizationImagesByOrgId([e],o-1)},200),t()})}))})(r[i]);Promise.all(t).then(function(){e()})})},ye.prototype.prefetchImages=function(u,h,d,y){var g=this;return void 0===y&&(y=3),h=h||[],new Promise(function(e){function t(e){var t;0<=e&&(t=g._mappedToUnmappedImageIndex[e],g._getImage(t)&&g._updateCachedImages(t),e=g._mapImages[e],l=l||!e,e&&!d||(s[t]=!0))}for(var i,r,o,a,n=[],l=!1,s={},p=0,c=u.length;p<c;p++)i=u[p],t(g._bucketToMappedImageIndex[i]);for(p=0,c=h.length;p<c;p++)t(g._unmappedToMappedImageIndex[h[p]]);if(l)for(d&&(r=Object.keys(s),(s={})[r.join(",")]=!0),a=function(e){var t=o[e];n.push(new Promise(function(o){g._imageLoader.prefetchImages(t,g._svgColor,g._palette,function(e){var t,i,r;if(!g._isDisposed)for(t=0,i=e;t<i.length;t++)r=i[t],g._updateCachedImages(r);o()},function(){0<y&&Microsoft.Maps.setTimeout(function(){g._isDisposed||g.prefetchImages(u,h,d,--y)},200),o()})}))},p=0,c=(o=Object.keys(s)).length;p<c;p++)a(p);Promise.all(n).then(function(){e()})})},ye.prototype.getFetchedShields=function(e,t,i){var r,o,a,n,l;if(!t||!i||!i.length)return null;var e=Math.round(e),s=this._getShieldImages(t,i),p=[];if(s)for(r=this._getShieldScales(e,t),o=0,a=i.length;o<a;o++)l=null,0<=(n=i[o])&&((l=s[n])&&r&&r[n]&&l.setScale(r[n]),l=l||te.DefaultShieldTemplate),p.push(l);return p},ye.prototype.getShieldsAsync=function(e,t,i,r){var o,a=this;r&&(o={bucketId:t,indexes:i},this.selectorReady().then(function(){a.prefetchShields([o]).then(function(){r(a.getFetchedShields(e,t,i))})}))},ye.prototype.dispose=function(){this._shieldStyleResponseData=null,this._computedSplineGraphs=[],this._markupOrder&&this._markupOrder.clear(),this._serverBooleanValues=[],this._serverColorValues=[],this._serverEnumValues=[],this._serverSingleValues=[],this._serverStringValues=[],this._graphPassDefinitionList=[],this._styleVisibilities=[],this._passDefinitionList=[],this._markupVisibilities=[],this._images=null,this._imgVariants=[],this._markupOrderList=null,this._palette=null,this._drawOrderList=null,this._mapImages=[],this._svgColor=[],this._imageGroups=[],this._groupedImageOptions=[],this._fixedStringList=[],this._shieldImages=null,this._shieldScaleListForZoom=null,this._state=[],this._urlFormat=null,this._propertyValues=[],this._primitiveTemplateCache.clear(),this._categoryIconCache.clear(),this._bucketToMappedImageIndex={},this._bucketToPassDefinitionIndex={},this._bucketToDrawOrderListIndex={},this._mappedToUnmappedImageIndex={},this._unmappedToMappedImageIndex={},this._unmappedIndexToBucketIds={},this._visibilityRanges=null,this.ready&&this.ready.dispose(),window.clearTimeout(this._delayLoadTimerId),this._isDisposed=!0},ye.prototype._isTemplateVisible=function(e,t,i){for(var r,o=t.drawingStyleVisibilities[i],a=o.length||0,n=!1,l=0;l<a;l++)r=r||o[l].visiblePaletteKey,e>=o[l].zoom&&(n=o[l].visible);return this._customStyleManager&&this._customStyleManager.hasCustomStyle&&("boolean"==typeof(i=this._getCustomStyle(r))&&(n=i)),n},ye.prototype._getScaleFromZoom=function(e,t,i,r){var e=this._getStyleScale(e),o=i&&this._getOrgImage(i)?(i=this._passDefinitionList[this._bucketToPassDefinitionIndex[t]],this._getScale(i.scale,i.scaleTransform,e)):(t=this._getImageByBucketId(t))?(o=this._getSplineGraphPaletteKey(t.scale),o=this._getStackedNumericValueItem(r,o)||{},this._getScale(t.scale,t.scaleTransform,e,o.value,o.ignoreTransform)):null;return o},ye._cloneObject=function(e){var t,i,r,o,a;if(!e||"object"!=typeof e)return e;for(t={},r=0,o=(i=Object.keys(e)).length;r<o;r++)t[a=i[r]]=this._cloneObject(e[a]);return t},ye._colorString=".Color",ye._backgroundColor=".BackgroundColor",ye._borderColor=".BorderColor",ye._labelColor=".LabelColor",ye._fillColor=".FillColor",ye.backgroundShapeRecord="Shape-Background",ye._poiStateNames=["","","DefaultPointState","HoverPointState","SelectedPointState","InactivePointState","InactiveSelectedPointState"],ye._poiTypeStateGroups=["","Search","Price","Itinerary","ShowMe","Landmark","Transit","","","","Classic","","Search","Venue"],ye.DefaultBucketForLocalCat="334",ye.FallbackLocalCat="90000",ye._taskList=["Task1","Task2","Task3","Transit","Favorite","Layer"],ye._haloImageBucket="1372",ye.cityPolygonBucket="879",ye.microPoiBucket="1374",ye._categoryRemap={13344:"91572",90298:"91257",90375:"90386",90628:"90727",90948:"91562",90975:"90977",91485:"90661",91563:"90940",91826:"90012",1e5:"203",EatAndDrink:"90287",WhatToDo:"90012",WhereToStay:"91572",WhereToStayOpalAction:"91572",Attraction:"90012",Campground:"91562",MovieTheatre:"90045",Parking:"90925",Trail:"90012",School:"90199",University:"90199",TestingLocation:"90386"},ye._categoryFallbackMap={House:{categoryId:-1,bucketId:1942,entry:""},PivotEntity:{categoryId:-1,bucketId:353,entry:""},9e4:{categoryId:9e4,bucketId:334,entry:"Business"}},ye._localCatIdBucketMapping={EatAndDrink:"286",WhatToDo:"280",WhereToStay:"287",WhereToStayOpalAction:"287",Attraction:"280",Campground:"1366",House:"310",MovieTheatre:"273",Parking:"275",PivotEntity:"353",Trail:"280",School:"294",University:"294",TestingLocation:"1367",91562:"1366",91826:"280",13344:"287",91648:"288",90014:"300",91616:"257",90954:"277",90133:"278",90122:"279",90243:"284",91563:"329",90650:"1365",91533:"271",91649:"281",90948:"1366",90903:"274",90024:"303",90386:"1367",90188:"295",91485:"1368",90727:"306",90859:"325",90089:"276",91537:"296",90298:"318",90738:"67",91348:"309",91572:"287",90320:"297",90837:"313",90045:"273",90016:"304",90960:"1369",91271:"319",90925:"275",90804:"270",90331:"320",90342:"272",90287:"286",90199:"294",90771:"305",91548:"324",91549:"118",91550:"307",91493:"299",90871:"326",90034:"302",90012:"280",91510:"1381",90017:"301",90595:"311",90001:"258",90078:"330",91186:"327",91204:"308",91714:"66",90977:"331",90584:"310",91627:"68",91391:"316",91259:"321",91774:"70",91773:"71",91499:"312",91651:"328",90540:"315",91764:"67",91768:"69",90496:"314",91762:"113",91643:"114",90848:"322",91650:"1359",90942:"317",91621:"64",90892:"1899",91600:"1380",1e5:"248",203:"248",255:"254",257:"253",251:"252",253:"251",254:"250",252:"249",91754:"65",205:"247",204:"246",207:"245",206:"244",200:"240",264:"243",265:"242",263:"241",250:"239",202:"238",266:"236",261:"235",91571:"50",201:"234",262:"232",256:"231",260:"229",259:"228",258:"227",267:"226"},ye._localCatIdBucketMapping_Delta={House:"1942",90940:"329",90975:"331",90375:"1367",90628:"306",9e4:"334"},ye._multimodeTransitBucket="239",ye.directionIconTypeBuckets={start:"352",middle:"350",via:"1387",turn:"1386",end:"351",ferry:"339",walk:"341",bus:"342",train:"338",airline:"340",tube:"338",auto:"337"},ye.poiStylePriorityGroup=999999,ye.itineraryPoiBucketId="1941",ye.pricePoiBucketId="1901",ye.bucketIdForPoi="999999",ye.bucketIdForSelectedPoi="999998",ye.bucketIdForTransientLensTop="999997",ye.bucketIdForTransientLensBottom="999997.5",ye.bucketIdForTransientLensLeft="999997.6",ye.bucketIdForTransientLensRight="999997.7",ye.bucketIdForDirectionsPins="999996",ye.xsrPolygonBucketId="1383",ye._poiStyles={"097A0D85-2585-425A-8471-60BDD3C5B7C3":ye._roadCustomStyle={"999999,1":{styleStatic:{fontOutlined:!0,outlineWidth:1,horizontalAlignment:0,wrapDisplayName:!0,offsetX:12,offsetY:12,imageWidth:20,imageHeight:20},styleDynamic:{font:"SegoeBing",fontSize:10,fontColor:"#000",outlineColor:"#fff",globalOrder:3,visible:!0,priority:ye.poiStylePriorityGroup}},"999999,3":{styleStatic:{fontOutlined:!1,horizontalAlignment:0,wrapDisplayName:!0},styleDynamic:{font:"SegoeBing",fontSize:10,fontColor:"#000",globalOrder:3,visible:!0,priority:ye.poiStylePriorityGroup}},"1901,1":{styleStatic:{fontOutlined:!0,outlineWidth:1,horizontalAlignment:0,wrapDisplayName:!0},styleDynamic:{font:"SegoeBing",fontSize:10,fontColor:"#000",outlineColor:"#fff",globalOrder:3,visible:!0,priority:ye.poiStylePriorityGroup}},"999998,1":{styleStatic:{fontOutlined:!0,outlineWidth:1,horizontalAlignment:0,wrapDisplayName:!0,offsetX:22,offsetY:22,imageWidth:40,imageHeight:40},styleDynamic:{font:"SegoeBing",fontSize:10,fontColor:"#000",outlineColor:"#fff",globalOrder:2,visible:!0,priority:ye.poiStylePriorityGroup}},"999997,1":{styleStatic:{fontOutlined:!0,outlineWidth:1,horizontalAlignment:0,wrapDisplayName:!0,offsetX:22,offsetY:22,imageWidth:40,imageHeight:40},styleDynamic:{font:"SegoeBing",fontSize:10,fontColor:"#000",outlineColor:"#fff",globalOrder:1,visible:!0,priority:ye.poiStylePriorityGroup}},"999997.5,1":{styleStatic:{fontOutlined:!0,outlineWidth:1,horizontalAlignment:0,wrapDisplayName:!0,offsetX:22,offsetY:22,imageWidth:40,imageHeight:40},styleDynamic:{font:"SegoeBing",fontSize:10,fontColor:"#000",outlineColor:"#fff",globalOrder:1,visible:!0,priority:ye.poiStylePriorityGroup}},"999997.6,1":{styleStatic:{fontOutlined:!0,outlineWidth:1,horizontalAlignment:0,wrapDisplayName:!0,offsetX:22,offsetY:22,imageWidth:40,imageHeight:40},styleDynamic:{font:"SegoeBing",fontSize:10,fontColor:"#000",outlineColor:"#fff",globalOrder:1,visible:!0,priority:ye.poiStylePriorityGroup}},"999997.7,1":{styleStatic:{fontOutlined:!0,outlineWidth:1,horizontalAlignment:0,wrapDisplayName:!0,offsetX:22,offsetY:22,imageWidth:40,imageHeight:40},styleDynamic:{font:"SegoeBing",fontSize:10,fontColor:"#000",outlineColor:"#fff",globalOrder:1,visible:!0,priority:ye.poiStylePriorityGroup}},"999996,1":{styleStatic:{fontOutlined:!0,outlineWidth:1,horizontalAlignment:0,wrapDisplayName:!0,offsetX:6,offsetY:6,imageWidth:20,imageHeight:20},styleDynamic:{font:"SegoeBing",fontSize:10,fontColor:"#000",outlineColor:"#fff",globalOrder:3,visible:!0,priority:ye.poiStylePriorityGroup}}},"7DCFF932-3B97-4B3E-9EB4-5B9AA89EFA3C":ye._roadCustomStyle,"DCD31B1C-B637-4B36-8635-829DF5E46999":ye._roadCustomStyle,"DC2B2930-4CA4-45EB-9EE9-3F4EFA4267E5":ye._roadCustomStyle,"7443EAC9-CD76-4236-B027-22DBC504BF06":ye._aerialCustomStyle={"999999,1":{styleStatic:{fontOutlined:!0,outlineWidth:3,horizontalAlignment:0,wrapDisplayName:!0,offsetX:12,offsetY:12,imageWidth:20,imageHeight:20},styleDynamic:{font:"SegoeBing",fontSize:10,fontColor:"#fff",outlineColor:"#000",globalOrder:3,visible:!0,priority:ye.poiStylePriorityGroup}},"999999,3":{styleStatic:{fontOutlined:!1,horizontalAlignment:0,wrapDisplayName:!0},styleDynamic:{font:"SegoeBing",fontSize:10,fontColor:"#fff",globalOrder:3,visible:!0,priority:ye.poiStylePriorityGroup}},"1901,1":{styleStatic:{fontOutlined:!0,outlineWidth:1,horizontalAlignment:0,wrapDisplayName:!0},styleDynamic:{font:"SegoeBing",fontSize:10,fontColor:"#fff",outlineColor:"#000",globalOrder:3,visible:!0,priority:ye.poiStylePriorityGroup}},"999998,1":{styleStatic:{fontOutlined:!0,outlineWidth:3,horizontalAlignment:0,wrapDisplayName:!0,offsetX:22,offsetY:22,imageWidth:40,imageHeight:40},styleDynamic:{font:"SegoeBing",fontSize:10,fontColor:"#fff",outlineColor:"#000",globalOrder:2,visible:!0,priority:ye.poiStylePriorityGroup}},"999997,1":{styleStatic:{fontOutlined:!0,outlineWidth:3,horizontalAlignment:0,wrapDisplayName:!0,offsetX:22,offsetY:22,imageWidth:40,imageHeight:40},styleDynamic:{font:"SegoeBing",fontSize:10,fontColor:"#fff",outlineColor:"#000",globalOrder:1,visible:!0,priority:ye.poiStylePriorityGroup}},"999997.5,1":{styleStatic:{fontOutlined:!0,outlineWidth:3,horizontalAlignment:0,wrapDisplayName:!0,offsetX:22,offsetY:22,imageWidth:40,imageHeight:40},styleDynamic:{font:"SegoeBing",fontSize:10,fontColor:"#fff",outlineColor:"#000",globalOrder:1,visible:!0,priority:ye.poiStylePriorityGroup}},"999997.6,1":{styleStatic:{fontOutlined:!0,outlineWidth:3,horizontalAlignment:0,wrapDisplayName:!0,offsetX:22,offsetY:22,imageWidth:40,imageHeight:40},styleDynamic:{font:"SegoeBing",fontSize:10,fontColor:"#fff",outlineColor:"#000",globalOrder:1,visible:!0,priority:ye.poiStylePriorityGroup}},"999997.7,1":{styleStatic:{fontOutlined:!0,outlineWidth:3,horizontalAlignment:0,wrapDisplayName:!0,offsetX:22,offsetY:22,imageWidth:40,imageHeight:40},styleDynamic:{font:"SegoeBing",fontSize:10,fontColor:"#fff",outlineColor:"#000",globalOrder:1,visible:!0,priority:ye.poiStylePriorityGroup}},"999996,1":{styleStatic:{fontOutlined:!0,outlineWidth:3,horizontalAlignment:0,wrapDisplayName:!0,offsetX:6,offsetY:6,imageWidth:20,imageHeight:20},styleDynamic:{font:"SegoeBing",fontSize:10,fontColor:"#fff",outlineColor:"#000",globalOrder:3,visible:!0,priority:ye.poiStylePriorityGroup}}},"A3A1C843-30CE-4828-984C-AD44EAF2A245":ye._aerialCustomStyle,"68C27B9C-4FB4-4CEC-A664-3FC3C2E8A12A":ye._aerialCustomStyle,"F83F2201-05FD-4BFF-8700-07CEEF51C66B":ye._aerialCustomStyle},ye._darkTemplates={"7443EAC9-CD76-4236-B027-22DBC504BF06":!0,"A3A1C843-30CE-4828-984C-AD44EAF2A245":!0,"68C27B9C-4FB4-4CEC-A664-3FC3C2E8A12A":!0,"3AD7646D-02C7-4E2A-B3AB-2044A88171E9":!0},ye._latencyLogKey="MC_TD_NL",ye._delayLoadTimeout=60,ye._maxRetries=5,ye._retryTimeout=10,ye._alphaTransformCoefficient=1.5,ye._outlineWidthDelta=1,ye._xHeightRatio=1.15385,ye._capHeightRatio=.93752,ye._webkitFontFillLightnessFactor=.85,(c=ye).init();var ie,re=(de.prototype.dispose=function(){this._basemapSelector&&this._basemapSelector!==this._selector&&this._basemapSelector.dispose(),this._selector&&(this._selector.dispose(),this._selector=null),this._basemapSelector=null,this._ready=null,window.clearTimeout(this._delayLoadTimerId)},de.prototype.selectorReady=function(){var i=this;return this._ready||(this._ready=new Promise(function(t){i._selector&&i._selector.selectorReady().then(function(e){t(e)},function(){var e;i._selector&&(i._selector=new te(i._selector.getName()),i._basemapSelector&&i._basemapSelector.ready&&i._basemapSelector.ready.addOne(function(){i._selector=i._basemapSelector}),t(i),e={feature:"",action:L.Error,data:"BaseMapTemplateSelector failed to load, FallbackTemplateSelector loaded"},y.logger&&y.logger.logCriticalError(null,e))})})),this._ready},de.prototype.getCategoryIconTemplate=function(e,t,i,r,o){this._selector&&this._selector.getCategoryIconTemplate(e,t,i,r,o)},de.prototype.getIconTemplate=function(e,t,i,r,o,a){this._selector&&this._selector.getIconTemplate(e,t,i,r,o,a)},de.prototype.getCityPolygonTemplates=function(e,t,i,r,o){return this._selector&&this._selector.getCityPolygonTemplates(e,t,i,r,o)},de.prototype.getFirstDrawOrder=function(e){return this._selector&&this._selector.getFirstDrawOrder(e)},de.prototype.getPolygonTemplates=function(e,t,i,r,o,a,n,l){return this._selector&&this._selector.getPolygonTemplates(e,t,i,r,o,a,n,l)},de.prototype.getLandmarkVectorImageTemplate=function(e,t,i,r){return this._selector&&this._selector.getLandmarkVectorImageTemplate(e,t,i,r)},de.prototype.getMarkupStyle=function(e,t,i,r){return this._selector&&this._selector.getMarkupStyle(e,t,i,r)},de.prototype.getName=function(){return this._selector&&this._selector.getName()},de.prototype.getPoiTemplate=function(e,t,i,r,o,a,n,l){return this._selector.getPoiTemplate(e,t,i,r=void 0===r?1:r,o=void 0===o?!0:o,a=void 0===a?!0:a,n,l)},de.prototype.getPoiVectorImageTemplate=function(e,t,i,r,o,a,n){return this._selector&&this._selector.getPoiVectorImageTemplate(e,t,i,r,o,a,n)},de.prototype.getRoutePoiVectorImageTemplate=function(e,t,i){return this._selector&&this._selector.getRoutePoiVectorImageTemplate(e,t,i)},de.prototype.prefetchShields=function(e){return this._selector&&this._selector.prefetchShields(e)},de.prototype.prefetchImages=function(e,t,i,r){return this._selector&&this._selector.prefetchImages(e,t,i,r)},de.prototype.prefetchOrganizationImagesByOrgId=function(e,t){return void 0===t&&(t=3),this._selector&&this._selector.prefetchOrganizationImagesByOrgId(e,t)},de.prototype.getFetchedShields=function(e,t,i){return this._selector&&this._selector.getFetchedShields(e,t,i)},de.prototype.getShieldsAsync=function(e,t,i,r){this._selector&&this._selector.getShieldsAsync(e,t,i,r)},de.prototype.getTemplates=function(e,t){return this._selector&&this._selector.getTemplates(e,t)},de),oe=(he.prototype.getMatrix=function(e){var t=e.id,i=this._matrixCache.getItem(t);return i||(i=this._getMatrixInternal(e),this._matrixCache.addItem(t,i)),i},he.prototype._getMatrixInternal=function(e){var t=new K(this._width,0,0,this._height,this._x1,this._y1);return e===R.instance?t:(e=e.getMatrix&&e.getMatrix(R.instance))?e.invert().multiply(t):null},he.prototype._getMercatorToGridCrsMatrix=function(){return this._mercatorToGridCrsMatrix||(this._mercatorToGridCrsMatrix=this._getMatrixInternal(R.instance).invert()),this._mercatorToGridCrsMatrix},he.prototype.projectToX=function(e,t){return this._project(e,t,!0)},he.prototype.projectToY=function(e,t){return this._project(e,t,!1)},he.prototype._project=function(e,t,i){var r=R.instance.projectToX(e,t),o=R.instance.projectToY(e,t),a=this._getMercatorToGridCrsMatrix();switch(i){case!0:return a.projectX(r,o);case!1:return a.projectY(r,o)}},he.prototype.toLatitude=function(e,t){e=this._x1+this._width*e,t=this._y1+this._height*t;return R.instance.toLatitude(e,t)},he.prototype.toLongitude=function(e,t){e=this._x1+this._width*e,t=this._y1+this._height*t;return R.instance.toLongitude(e,t)},he),ae=(ue.fromLocation=function(e,t){if(0===t)return new ue(1);if(1===t)return new ue(0<e.longitude?3:2);var i=2<<t-2,r=Math.floor(2*(e.longitude+180)*i/360),e=Math.floor((90-e.latitude)*i/180),r=Math.min(r,2*i-1),e=Math.min(e,i-1);return ue.fromGridXY(r,e,t)},ue.fromGridXY=function(e,t,i){var r,o=0;if(x.assertNotNull(e,"gridX"),x.assertNotNull(t,"gridY"),x.assertNotNull(i,"lod"),0===i)o=1;else{for(r=o=0;r<i;r++)o<<=1,o|=t>>i-r-1&1,o<<=1,o|=e>>i-r-1&1;o|=1<<2*i-1}return new ue(o)},ue),ne=(Z(ce,s=e),ce.prototype.updateZoom=function(e,t){this._minZoom=e,this._minZoom=t},ce.prototype.applyFilter=function(e){this._filter=e},ce.prototype.resetFilter=function(){this._filter=null},ce.prototype.setLayer=function(e){this._layer=e},ce.prototype._filterResponse=function(e){var t,i,r,o={},a=B.staticLandmarks;if(o.primitives=[],e&&e.primitives)for(o.primitives=e.primitives,t=0;t<o.primitives.length;t++)i=o.primitives[t],a?i.isHoverEnabled=i.isTapEnabled=null:i.isHoverEnabled||(i.isHoverEnabled=i.isTapEnabled=function(){return!0}),(r=i.entity)&&(r.changed||(r.changed=new V),r.ypid&&0!==r.ypid.indexOf("ypid:")&&(r.ypid="ypid:"+r.ypid),r.poiType=5),i.layer=this._layer;return o},ce.prototype.shouldFetchPrimitives=function(){return!(this._suppressDataRetrieval||this._layer&&!this._layer.getVisible())},ce),le=(pe.prototype.getParentDataSource=function(){return this._parentDataSource},pe.prototype.getPrimitives=function(e,t,i,r){this._parentDataSource.getPrimitivesInternal(e,this._layerId,t,i,r)},pe.prototype.applyFilter=function(e){this._parentDataSource.applyFilter(e)},pe.prototype.resetFilter=function(){this._parentDataSource.resetFilter()},pe.prototype.cancelPrimitivesRequest=function(e,t){this._parentDataSource.cancelPrimitivesRequestInternal(e,this._layerId,t)},pe.prototype.getDataUniquenessKey=function(e){return x.assertNotNull(e,"regionId"),e.quadKey+this._parentDataSource.getFilterKey()},pe);t=ie=ie||{},se.prototype.ready=function(){var r=this;return this._readyPromise||(this._readyPromise=new Promise(function(e,t){var i=F.dynamicProperties,i=r._coreConfig.mapTemplateUrlBase.replace("{stlRequestDomain}",i.bingRequestDomain),i=D._updateTfeUrlDomain(q.styleEntryToBucketUrl.replace("{urlbase}",i)).replace("{stlVersion}",F.stlVersion).replace("{subdomain}","0");W.downloadJson(i,"basemapdata",function(t){r._entryToBucket={},Object.keys(t).forEach(function(e){r._entryToBucket[e.toLowerCase()]=t[e]}),e()},function(){t()},null,!1,null,!1)})),this._readyPromise},se.prototype.getEntryBucket=function(e,t){var i,r=e&&this._entryToBucket&&this._entryToBucket[e.toLowerCase()];if(r)switch(t){case 3:i=r.a;break;case 2:i=r.l;break;case 1:i=r.p}return i},t.StyleEntryBucketMap=se,g.BadgeTemplateSelector=d,g._BaseMapDataSource=e,g._BaseMapStreetsideDataSource=Q,g._EntityHelper=$,g.BaseMapImageLoader=ie.BaseMapImageLoader,g._BaseMapTemplateSelector=c,g._BaseMapTemplateSelectorProxy=re,g._GridId=ae,g._GridCrs=oe,g._LandmarksDataSource=ne,g._LayerDataSource=le,g.StyleEntryBucketMap=ie.StyleEntryBucketMap}catch(e){if(!y.logger)throw e;y.logger.logCriticalError(e)}function se(e){this._coreConfig=e}function pe(e,t,i){var r=this;this._layerId=e,this._parentDataSource=t,this.spatialIndex=i,this.invalidated=new V,t.invalidated.add(function(e){return r.invalidated.invoke(e)})}function ce(e,t,i,r,o,a,n,l){r=s.call(this,e,t,i,r)||this;return r._id=n,l&&(r._jsonsoSuffix=l),r._minZoom=o,r._maxZoom=a,r._suppressDataRetrieval=!B.staticLandmarks&&!B.dynamicLandmarks,r}function ue(e){var t,i,r=0,o=0;if(0===e)t=0;else{for(var a=e,n=2147483648,l=31;l&&!(a&n);)l--,n/=2;t=(l+1)/2}for(i=0;i<t;i++)r<<=1,r|=e>>2*(t-i-1)&1,0<i&&(o<<=1,o|=e>>2*(t-i-1)+1&1);for(var a=e&2147483647>>32-2*t,s="0",p=t;p--;)s+="0123".charAt(a>>2*p&3);this.quadKey=s,this.x=r,this.y=o,this.lod=t,this.crs=new oe(this),this.bounds=[0,16384,16384,0]}function he(e){this._maxValue=16384,this.id="SpatialGrid"+e.quadKey,this._matrixCache=new M(1024),this.bounds=[0,this._maxValue,this._maxValue,0];var t=1<<e.lod,i=1<<(0<e.lod?e.lod-1:0);this._west=e.x/t*360-180,this._east=(e.x+1)/t*360-180,this._north=90-e.y/i*180,this._south=90-(e.y+1)/i*180,this._x1=R.instance.projectToX(this._north,this._west),this._width=(R.instance.projectToX(this._south,this._east)-this._x1)/this._maxValue,this._y1=R.instance.projectToY(this._north,this._west),this._height=(R.instance.projectToY(this._south,this._east)-this._y1)/this._maxValue,this._mercatorToGridCrsMatrix=null}function de(e,t,i,r,o,a,n,l){this._basemapSelector=new c(e,t,i,r,o,a,n,l),this._selector=this._basemapSelector}function ye(e,t,i,r,o,a,n,l){this._clientPerf=l,this._customStyleManager=t,this._imageLoader=r,this._styleEntryBucketMap=i,t&&(t.styleEntryBucketMap=i),this._primitiveTemplateCache=new M(100),this._categoryIconCache=new M(100),this._templateName=a,this._state=[],this._stlVersion=n,this._bucketToMappedImageIndex={},this._bucketToPassDefinitionIndex={},this._bucketToDrawOrderListIndex={},this._mappedToUnmappedImageIndex={},this._unmappedToMappedImageIndex={},this._unmappedIndexToBucketIds={},this._images={},this.ready=new V,x.enableFunctionalTestHooks&&"1"===D._getUrlParam(window.location,"teststylefailure")&&(ye._retryTimeout=1);a=F.dynamicProperties,n=a.compositionHandlerGenerationId,a=e.mapTemplateUrlBase.replace("{stlRequestDomain}",a.bingRequestDomain);e.catMapUrlFormat&&(this._catMapUrlFormat=D._updateTfeUrlDomain(e.catMapUrlFormat.replace("{urlbase}",a)).replace("{stlVersion}",this._stlVersion).replace("{subdomain}","0")),this._urlFormat=D._updateTfeUrlDomain(o.replace("{urlbase}",a)).replace("{stlVersion}",this._stlVersion).replace("{odmgenid}",n),N.mergeProperties(ye._localCatIdBucketMapping,ye._localCatIdBucketMapping_Delta),this._markupOrder=new M(1e3),this._shieldImages={},this._shieldScaleListForZoom={},this._initialized=!1,this._retryCount=0}function ge(e){e=e&&e.split(":");return e&&1<e.length?e[1].replace(/^["\s]+|["\s]+$/g,""):""}function fe(e){this._templateName=e}function me(e,t,i){this._items={},(this._customStyleManager=e)&&(e.palette=this),this._fixedStringList=t,this._fixedStringMap=i}function _e(e,t,i,r){return o.call(this,e,t,i,r,!1)||this}function Se(e){this._images={},this._orgImages={},this._legacyImages=[],this._legacyOrgImages={},this._parsedImages=new M(250);var t=F.dynamicProperties,i=t.compositionHandlerGenerationId,t=e.mapTemplateUrlBase.replace("{stlRequestDomain}",t.bingRequestDomain);this._urlImageFormat=D._updateTfeUrlDomain(q.mapImageTemplateUrlFormat.replace("{urlbase}",t)).replace("{stlVersion}",F.stlVersion).replace("{odmgenid}",i),this._fetchNewImageFormat=q.fetchNewMapImageFormat,this._convertLegacyFormat=q.convertLegacyMapImageFormat}function Ie(e,t){e=t[e]||{};return"SvgFixedColor"===e.type?e.color:"SvgPaletteColor"===e.type?{value:e.color,property:Te(e.svgPaletteColor)}:null}function ve(e){for(var t,i=[],r=0,o=e;r<o.length;r++)t=o[r],i.push(t.x,t.y);return i}function ke(e,t,i){e=t[e]||{};return"SvgFixedColor"===e.type?e.color:"SvgPaletteColor"===e.type?(i=i.getColorPaletteValue(Te(e.svgPaletteColor)))||0===i?b.convertPackedTorgba(i):e.color:null}function be(e,t,i){var r,e=t[e]||{};return"SvgPaletteColor"===e.type&&"number"==typeof(r=Te(e.svgPaletteColor))?i.getFixedString(r):void 0}function Te(e){var t;return e&&("number"!=typeof(t=e.paletteKeyId)&&(t=(e=e.idPair&&e.idPair[0])&&e.second)),t}function Pe(e,t){var i;if("string"==typeof e)i=e;else if(e){if((t=t.getColorPaletteValue(e.property))||0===t)return b.convertPackedTorgba(t);i=e.value||k.transparent}return i?(i=k.parse(i,2))&&i.toRgba():void 0}function Ce(e,t){return"number"==typeof e?e:e?t.getSinglePaletteValue(e.property):1}function xe(e,t){return"object"==typeof e?t.getFixedString(e.property):void 0}function Fe(e){var t,i=[];if(e.length%2==0)for(t=0;t<e.length;t+=2)i.push({x:e[t],y:e[t+1]});return i}function De(e,t,o){function r(e,t){var i=t.style,r=Pe(e.stroke,o);r&&(i.strokeStyle=r,i.lineWidth=e.strokeWidth||1,i.lineWidthScale=Ce(e.strokeScale,o),t.strokeScalePaletteKey=xe(e.strokeScale,o),t.strokeStylePaletteKey=xe(e.stroke,o))}function i(e,t){r(e,t);var i=Pe(e.fill,o);i&&(t.style.fillStyle=i,t.fillStylePaletteKey=xe(e.fill,o))}var a=null;switch(e.type){case"circle":i(e,a={vectorType:2,centerX:e.centerX||0,centerY:e.centerY||0,radiusX:e.radius||0,radiusY:e.radius||0,style:{}});break;case"ellipse":i(e,a={vectorType:2,centerX:e.centerX||0,centerY:e.centerY||0,radiusX:e.radiusX||0,radiusY:e.radiusY||0,style:{}});break;case"line":r(e,a={vectorType:1,pointsList:[{x:e.x1||0,y:e.y1||0},{x:e.x2||0,y:e.y2||0}],style:{lineCap:e.lineCap||"butt",lineJoin:e.lineJoin||"round"}});break;case"path":i(e,a={vectorType:4,pathData:e.data,style:{}});break;case"polygon":i(e,a={vectorType:0,pointsList:Fe(e.points),style:{}});break;case"polyline":i(e,a={vectorType:1,pointsList:Fe(e.points),style:{lineCap:e.lineCap||"butt",lineJoin:e.lineJoin||"round"}});break;case"rect":i(e,a={vectorType:0,pointsList:[{x:n=e.x||0,y:l=e.y||0},{x:n+(s=e.width||0),y:l},{x:n+s,y:l+(p=e.height||0)},{x:n,y:l+p},{x:n,y:l}],style:{}});break;case"text":var n=e.x||0,l=e.y||0,s=e.width||0,p=e.height||0;a={vectorType:3,text:H.placeholderText,anchor:{x:n+s/2,y:l+p/2},maxWidth:s,leftTop:{x:n,y:l},rightBottom:{x:n+s,y:l+p},style:{fillStyle:Pe(e.fill,o),font:e.fontFamily||H.defaultFont,fontStyle:function(e){var t=0;switch(e){case"bold":t=1;break;case"semiBold":t=16;break;case"light":t=32}return t}(e.fontWeight),fontSize:e.fontSize||0,horizontalAutoScaling:1,verticalAlignment:1},fillStylePaletteKey:xe(e.fill,o)}}return a&&(a.scale=Ce(e.scale,o),a.scalePaletteKey=xe(e.scale,o),a.shapePaletteKey=t),a}function we(e,t,i,r){var o=t.layers[i];o&&o.records&&e.push.apply(e,o.records.map(function(e){return De(e,r.getFixedString(o.shape),r)}))}function Ve(e,t,i,r,o){var a=this;this._requestFailedCount=0,this._maxFailureForFailover=10,this.spatialIndex=new X,this._map=e,this._coreConfig=t,this._constructGeometryFromLabelHints="boolean"!=typeof o||o,this._minZoom=t.basemapDataMinZoom,this._maxZoom=t.basemapDataMaxZoom,x.assertNotNullOrEmpty(i,"vectorTileUrlFormat"),this._layersOfInterest=r,this._urlFormat=D._updateTfeUrlDomain(i),this._urlFormat=D._updateTfeMktAndUrl(this._urlFormat),t.vectorTileFeatures&&(this._urlFormat+=t.vectorTileFeatures),this._urlContainsCredentialsParam=-1<this._urlFormat.indexOf("{credentials}"),this._id=this._jsonsoSuffix="basemap",this._requests={},this.invalidated=new V,e.mapTypeChangeStarted.add(function(){return a._updateCstl()}),this._updateCstl()}}.call(window);
