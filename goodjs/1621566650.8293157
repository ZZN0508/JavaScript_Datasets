define(["OK/utils/dom","OK/utils/utils","OK/entitySuggest/AbstractEntitySuggest","OK/LogSeen","OK/utils/throttle"],(function(t,e,i,s,n){"use strict";function d(){}return d.prototype.changeState=function(t){this.hook.classList.toggle("__empty",t)},d.prototype.logSlidesSeen=function(t,e){var i=this.slider.getElementsByClassName("js-entity-item");if(i&&i.length>0){for(var n=[],d=t;d<t+e&&i[d];d++){var l=parseInt(i[d].getAttribute("data-entity-id"),10)||null;null!==l&&n.push(l)}n.length>0&&(this.seenParams.data.user_ids=n.join(","),s.logSuccess(this.seenParams.type,JSON.stringify(this.seenParams.data)))}},d.prototype.logSlidesIfInViewPort=function(){try{e.isElementInViewport(this.slider)&&(this.logSlidesSeen(this.sliderOffset,parseInt(this.slider.getAttribute("data-visibleSlides"),10)||0),this.removeLogSeenOnWindowScrollListeners())}catch(t){}},d.prototype.removeLogSeenOnWindowScrollListeners=function(){window.removeEventListener("scroll",this.logSeenOnWinowScroll),window.removeEventListener("keydown",this.logSeenOnWinowScroll)},d.prototype.activate=function(s){this.marker=s.getAttribute("data-slider-marker")||null,this.loadActivityId=s.getAttribute("data-load-aid")||"Feed_PossibleFriends_LoadFriendChunk",this.sliderOffset=0,this.lastRemovedEntityIndex=null,this.hook=s,this.slider=t.firstByClass(s,"uslider"),this.entitySuggest=t.firstByClass(s,"js-entity-suggest"),this.type=this.entitySuggest.getAttribute("data-type"),this.entitySuggestInstance=null,this.suggestFriendsPortlets=i.prototype.getPortlets(this.type),this.mode=this.entitySuggest.getAttribute("data-mode"),this.userId=this.entitySuggest.getAttribute("data-user-id"),this.isLargeCard="true"===this.entitySuggest.getAttribute("data-large-card");var d=s.getAttribute("data-seen-params");if(d)try{this.seenParams=JSON.parse(d)}catch(t){this.seenParams=null}this.getNewSliderItems=function(t){this.seenParams&&this.logSeenOnSlide(t),this.suggestFriendsPortlets&&this.entitySuggest&&(this.entitySuggestId=parseInt(this.entitySuggest.getAttribute("data-entity-suggest-id"),10),this.entitySuggestInstance=this.suggestFriendsPortlets[this.entitySuggestId]),this.entitySuggestInstance&&this.marker&&t.detail.totalSlides-t.detail.offset<t.detail.visibleSlides+2&&e.ajax({url:i.urlConfig[this.type],data:{"st.modes":this.mode,list:Object.keys(i.prototype.getCommonEntities(this.type)).join(";"),slideSequence:!0,"st._aid":this.loadActivityId,marker:this.marker,largeCard:this.isLargeCard,"st.fid":this.userId}}).done(function(e,i,s){var n=e.split(OK.navigation.SPLITER),d="";this.marker=s.getResponseHeader("marker"),n.forEach((function(t){t&&(d=d+'<div class="uslider_i">'+t+"</div>")})),this.entitySuggestInstance.append(d);var l=!t.detail.totalSlides&&!e;this.changeState(l)}.bind(this)),this.marker||t.detail.totalSlides||this.changeState(!0)}.bind(this),this.changeSliderItemsCount=function(e){if("remove"===e.detail.type){var i=t.byClass(this.slider,"uslider_i");this.lastRemovedEntityIndex=e.detail.index,void 0!==this.lastRemovedEntityIndex?(t.remove(i[this.lastRemovedEntityIndex]),this.slider.dispatchEvent(new CustomEvent("uSliderUpdateCount",{detail:{type:"remove"}}))):this.lastRemovedEntityIndex=null}if("append"===e.detail.type&&this.slider.dispatchEvent(new CustomEvent("uSliderUpdateCount",{detail:{type:"append"}})),"replace"===e.detail.type&&this.seenParams){var s=parseInt(this.slider.getAttribute("data-visibleSlides"),10)||0;this.sliderOffset<=e.detail.index&&this.sliderOffset+s-1>=e.detail.index&&this.logSlidesSeen(e.detail.index,1)}}.bind(this),this.seenParams&&(this.logSeenOnWinowScroll=n(150,function(t){t.isTrigger||this.logSlidesIfInViewPort()}.bind(this)),this.logSeenOnSlide=function(t){if("slide"===t.detail.action||"remove"===t.detail.action&&this.sliderOffset<=this.lastRemovedEntityIndex&&this.sliderOffset+t.detail.visibleSlides>=this.lastRemovedEntityIndex){var e=t.detail.offset-this.sliderOffset;if(0===e)null!==this.lastRemovedEntityIndex&&(this.logSlidesSeen(this.lastRemovedEntityIndex,1),this.lastRemovedEntityIndex=null);else{var i=Math.abs(e),s=this.sliderOffset+e;this.sliderOffset=t.detail.offset,this.logSlidesSeen(s,i)}}}.bind(this),window.addEventListener("scroll",this.logSeenOnWinowScroll),window.addEventListener("keydown",this.logSeenOnWinowScroll),this.logSlidesIfInViewPort()),this.slider.addEventListener("uSliderAction",this.getNewSliderItems),this.entitySuggest.addEventListener("entitySuggestUpdateCount",this.changeSliderItemsCount)},d.prototype.deactivate=function(){this.seenParams&&this.removeLogSeenOnWindowScrollListeners(),this.slider.removeEventListener("uSliderAction",this.getNewSliderItems),this.entitySuggest.removeEventListener("entitySuggestUpdateCount",this.changeSliderItemsCount)},d}));