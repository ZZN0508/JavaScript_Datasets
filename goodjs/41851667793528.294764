YUI.add("flickr-galleries-reorderPhotos-updater",function(o,e){"use strict";o.namespace("ModelUpdaters")["flickr-galleries-reorderPhotos"]={run:function(s,e){var t={gallery_id:s.galleryId,photo_ids:JSON.stringify(s.photoIds),user_id:s.userId,current_state:s.currentState};return o.Promise.all([e.callAPI("flickr.galleries.reorderPhotos",t),e.getModel("gallery-info-models",s.galleryId),e.getModelRegistry("gallery-models")]).then(function(e){var t,o=e[0],r=e[1],e=e[2];r.setValue("currentState",o.currentState),e.exists(s.galleryId)&&(t=e.getValue(s.galleryId,"photoContextList")).getList().forEach(function(e){t.removeFromList(e.id)})})}}},"@VERSION@",{requires:[],optional:["gallery-info-models"]}),YUI.add("flickr-galleries-getContext-fetcher",function(u,r){"use strict";u.namespace("ListFetchers")["flickr-galleries-getContext"]={run:function(t,e){var o=this;return u.Promise.all([e.callAPI("flickr.galleries.getContext",this._processParams(t),!0),e.getModelRegistry("gallery-models"),e.getModelRegistry("photo-models"),e.getModelRegistry("person-models"),e.getModelRegistry("photo-engagement-models"),e.getModelRegistry("photo-stats-models")]).then(function(e){return o._processResponse(e,t)},function(e){throw 3===e.code&&"Photo not in gallery"===e.message&&(e.notInContext=!0),e}).then(null,u.FetcherErrorLogger(r))},_processParams:function(e){return{gallery_id:e.compoundId||e.id,photo_id:e.photoId,extras:u.APIHelper.request.getRebootPhotoExtras(),num_prev:e.numPrev,num_next:e.numNext,user_id:e.ownerId}},_processResponse:function(e,t){var o=e[0],r=e[1],s=e[2],l=e[3],i=e[4],a=e[5],n=[],d=s.proxy(t.photoId),e=o.nextphotos,o=o.prevphotos,p=u.APIHelper.response.parsePhotos({photos:e.photo,personModelRegistry:l,photoModelRegistry:s,photoEngagementModelRegistry:i,photoStatsModelRegistry:a}),n=u.APIHelper.response.parsePhotos({photos:o.photo,personModelRegistry:l,photoModelRegistry:s,photoEngagementModelRegistry:i,photoStatsModelRegistry:a}),s=r.getValue(t.id,"photoContextList"),i=!!s.hasMinBoundary&&s.hasMinBoundary(),a=!!s.hasMaxBoundary&&s.hasMaxBoundary(),s=s.getList(),g=u.APIHelper.response.addOrReplaceListByContext({model:d,next:p,prev:n.reverse(),current:s,hasMin:i,hasMax:a,numNext:t.numNext,numPrev:t.numPrev});return r.setValue(t.id,"photoContextList",g),{next:p,previous:n.reverse()}}}},"@VERSION@",{requires:["flickr-promise","api-helper"],optional:["gallery-models","photo-models","person-models","photo-engagement-models","photo-stats-models"]}),YUI.add("flickr-galleries-addPhoto-creator",function(c,s){"use strict";c.namespace("ModelCreators")["flickr-galleries-addPhoto"]={run:function(e,t){var o={full_response:1},u=e.galleryCompoundID?e.galleryCompoundID.split("-").pop():e.galleryID,r=[];return o.photo_id=Array.isArray(e.photoID)?e.photoID.join(","):e.photoID,o.gallery_id=u,Array.isArray(e.photoID)?e.photoID.forEach(function(e){r.push(t.getModel("photo-models",e))}):r.push(t.getModel("photo-models",e.photoID)),c.Promise.all([t.callAPI("flickr.galleries.addPhoto",o),t.getModel("gallery-models",u),c.Promise.all(r),t.getModelRegistry("photo-galleries-models"),t.getModelRegistry("photo-contexts-models"),t.getModelRegistry("gallery-info-models"),t.getModelRegistry("gallery-photo-association-models")]).then(function(e){var o,r,s,l,t=e[0],i=e[1],a=e[2],n=e[3],d=e[4],p=e[5],g=e[6];if("ok"===t.stat)return s=t.gallery,l=t.failures,a.forEach(function(t){l&&l.some(function(e){return e.photo_id&&e.photo_id.toString()===t.id})||(i&&!i.hasPhoto(t.getValue("id"))&&(i.addPhoto(t),i.getValue("primary")!==s.primaryPhotoId&&t.id===s.primaryPhotoId&&(o=t.getValue("sizes"),r={},c.Object.each(o,function(e,t){-1<["m","s","sq","t"].indexOf(t)&&(r[t]={width:e.width,height:e.height,src:e.url})}),i.setValue("primaryPhotoSizes",r))),p.exists(u)&&!p.hasPhoto(u,t.getValue("id"))&&p.getValue(u,"photoList").prependToList(t),n.exists(t.id)&&!n.getValue(t.id,"galleries").getFromListByID(i.getValue("id"))&&(n.getValue(t.id,"galleries").prependToList(i),n.setValue(t.id,"total",n.getValue(t.id,"total")+1)),d.exists(t.id)&&!d.getValue(t.id,"contexts").getFromListByID(i.getValue("id"))&&(d.setValue(t.id,"totalGalleries",d.getValue(t.id,"totalGalleries")+1),d.getValue(t.id,"contexts").appendToList(i)),g.addOrUpdate({id:u+"-"+t.id,galleryId:u,photoId:t.id}))}),i&&i.setValues({photoCount:s.countPhotos,videoCount:s.countVideos,primary:s.primaryPhotoId}),p.exists(u)&&(p.setValues(u,{photoCount:s.countPhotos,videoCount:s.countVideos,currentState:s.currentState,primaryPhotoId:s.primaryPhotoId}),p.getValue(u,"photoList").totalItems=s.countPhotos+s.countVideos||0),{galleryModel:i,apiResponse:t}},c.FetcherErrorLogger(s))}}},"@VERSION@",{requires:["flickr-promise"],optional:["gallery-models","gallery-info-models","photo-models","photo-galleries-models","photo-contexts-models","gallery-photo-association-models"]}),YUI.add("smart-galleries-models",function(o){function t(e){t.superclass.constructor.call(this,e)}o.Models[this.name]=t,o.extend(t,o.FlickrModelRegistry,{name:this.name,remote:{read:function(e){return o.ListFetchers["flickr-galleries-getList"].run(e,this.appContext)},readNextGalleries:function(e,t){return o.ListFetchers["flickr-galleries-getList"].run(e,t)}},readNextGalleriesRemote:function(e,t){t=t||{};return t.id=e,t.continuation=this.getValue(e,"continuation"),this.remote.readNextGalleries(t,this.appContext)},attributes:{id:{},pathAlias:{},galleries:{isCollection:!0,pageFetch:{listFetcher:o.ListFetchers["smart-galleries-getList"]}},continuation:{validator:function(e){return o.AttributeHelpers.validateString(e)},setter:function(e){return o.AttributeHelpers.coerceString(e)},defaultValue:0},totalItems:{validator:function(e){return o.AttributeHelpers.validateInteger(e)},setter:function(e){return o.AttributeHelpers.coerceInteger(e)}}}})},"@VERSION@",{requires:["flickr-model-registry","flickr-promise","flickr-galleries-getList-fetcher"]}),YUI.add("flickr-galleries-getList-fetcher",function(p,l){"use strict";p.namespace("ListFetchers")["flickr-galleries-getList"]={run:function(t,e,o){var r=this,s=this._processParams(t);return p.Promise.all([e.callAPI("flickr.galleries.getList",s),e.getModelRegistry("person-galleries-models"),e.getModelRegistry("gallery-models"),e.getModel("person-models",t.id||{pathAlias:t.pathAlias}),e.getModelRegistry("gallery-photo-association-models"),e.getModelRegistry("smart-galleries-models")]).then(function(e){return r._processResponse(e,t)},p.FetcherErrorLogger(l))},_processResponse:function(e,t){var o=e[0],r=e[1],l=e[2],i=e[3],a=e[4],s=e[5],n=o.galleries,e={},d=[];if(n)return n.gallery&&p.Array.each(n.gallery,function(e,t){var o=e.hasRequestedPhotos,r=e.coverPhotos?e.coverPhotos.photo:[],s=e.id.split("-")[1];r.forEach(function(e){e.url=p.APIHelper.response.removeProtocolFromURL(e.url)}),r={id:s,compoundId:e.id,title:e.title.content,description:e.description.content,owner:i,primary:e.primaryPhotoId,primaryPhotoSizes:p.APIHelper.response.parsePrimaryPhotoSizes(e),photoCount:e.countPhotos,videoCount:e.countVideos,viewCount:e.countViews,commentCount:e.countComments,coverPhotosData:r},d.push(l.addOrUpdate(r)),o&&o.forEach(function(e){a.addOrUpdate({id:s+"-"+e,galleryId:s,photoId:e})})}),e={id:i.getValue("id"),pathAlias:i.getValue("pathAlias"),totalItems:n.total||n.gallery.length},o={perPage:t.perPage||500,page:n.page||1,pageContent:d,totalItems:n.total||n.gallery.length},n&&n.continuation?(e.continuation=n.continuation,s.addOrUpdate(e).getValue("galleries").appendToListMulti(d)):r.addOrUpdate(e).getValue("galleriesList").addPage(o),o.pageContent},_processParams:function(e){var t={primary_photo_extras:"url_sq, url_q, url_t, url_s, url_m",page:e.page||1,per_page:e.perPage||500,photo_ids:e.photoIds?e.photoIds.join():"",sort_groups:e.sortGroups?e.sortGroups.join():""};if(e.id)t.user_id=e.id;else{if(!e.pathAlias)throw new Error("[flickr-galleries-getList-fetcher] `id` or `pathAlias` is required.");t.path_alias=e.pathAlias}return e.withGalleryId&&(t.jump_to=e.withGalleryId),void 0!==e.continuation?t.continuation=e.continuation:(t.cover_photos=e.coverPhotos||1,t.primary_photo_cover_size=e.primaryPhotoCoverSize||"m",t.cover_photos_size=e.coverPhotosSize||"q"),t}}},"@VERSION@",{requires:["flickr-promise","api-helper"],optional:["person-galleries-models","gallery-models","person-models","gallery-photo-association-models","smart-galleries-models"]}),YUI.add("person-galleries-models",function(t){function o(e){o.superclass.constructor.call(this,e)}t.Models[this.name]=o,t.extend(o,t.FlickrModelRegistry,{name:this.name,remote:{read:function(e){return t.ListFetchers["flickr-galleries-getList"].run(e,this.appContext)}},attributes:{id:{},pathAlias:{},url:{readOnly:!0,derivedBy:["pathAlias","id"],getter:function(e,t){var o=this.getValue(t,"pathAlias");return o?"/photos/"+o+"/galleries":"/photos/"+t+"/galleries"}},galleriesList:{isCollection:!0,pageFetch:{listFetcher:t.ListFetchers["flickr-galleries-getList"]}},totalItems:{validator:function(e){return t.AttributeHelpers.validateInteger(e)},setter:function(e){return t.AttributeHelpers.coerceInteger(e)}}}})},"@VERSION@",{requires:["flickr-model-registry","flickr-promise","flickr-galleries-getList-fetcher"]}),YUI.add("flickr-galleries-create-creator",function(g,r){"use strict";g.namespace("ModelCreators")["flickr-galleries-create"]={run:function(p,e){var t={},o=[];return t.title=p.title,t.description=p.description,t.primary_photo_id=p.photoID,t.full_result=1,o=[e.callAPI("flickr.galleries.create",t),e.getModelRegistry("gallery-models"),e.getModel("person-models",e.getViewer().nsid),e.getModel("person-galleries-models",e.getViewer().nsid),e.getModelRegistry("photo-galleries-models"),e.getModelRegistry("photo-contexts-models")],p.photoID&&o.push(e.getModel("photo-models",p.photoID)),g.Promise.all(o).then(function(e){var t,o=e[0],r=e[1],s=e[2],l=e[3],i=e[4],a=e[5],n=o.gallery.id,d=n.split("-")[1];return 6<e.length&&(t=e[6]),!!d&&(o=r.add({id:d,compoundId:n,title:o.gallery.title.content,description:o.gallery.description.content,photoPageList:t?[t]:[],photoContextList:t?[t]:[],owner:s,primary:o.gallery.primaryPhotoId,primaryPhotoSizes:g.APIHelper.response.parsePrimaryPhotoSizes(o.gallery),photoCount:o.gallery.primaryPhotoId&&t&&!t.getValue("isVideo")?1:0,videoCount:o.gallery.primaryPhotoId&&t&&t.getValue("isVideo")?1:0,viewCount:o.gallery.countViews,commentCount:o.gallery.countComments,coverPhotosData:o.gallery.coverPhotosData||[]}),l.getValue("galleriesList").prependToList(o),i.exists(p.photoID)&&!i.getValue(p.photoID,"galleries").getFromListByID(o.getValue("id"))&&(i.getValue(p.photoID,"galleries").prependToList(o),i.setValue(p.photoID,"total",i.getValue(p.photoID,"total")+1)),a.exists(p.photoID)&&!a.getValue(p.photoID,"contexts").getFromListByID(o.getValue("id"))&&(a.setValue(p.photoID,"totalGalleries",a.getValue(p.photoID,"totalGalleries")+1),a.getValue(p.photoID,"contexts").appendToList(o)),o)},g.FetcherErrorLogger(r))}}},"@VERSION@",{requires:["flickr-promise","api-helper"],optional:["gallery-models","photo-models","person-models","person-galleries-models","photo-galleries-models","photo-contexts-models"]});
