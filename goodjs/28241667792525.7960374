!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app"],e):e((t||self).firebase)}(this,function(qp){"use strict";try{!function(){var o;function e(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(!(e<t.logLevel)){var i=(new Date).toISOString();switch(e){case o.DEBUG:case o.VERBOSE:console.log.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case o.INFO:console.info.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case o.WARN:console.warn.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;case o.ERROR:console.error.apply(console,["["+i+"]  "+t.name+":"].concat(n));break;default:throw new Error("Attempted to log a message with an invalid logType (value: "+e+")")}}}qp=qp&&qp.hasOwnProperty("default")?qp.default:qp,(pi=o=o||{})[pi.DEBUG=0]="DEBUG",pi[pi.VERBOSE=1]="VERBOSE",pi[pi.INFO=2]="INFO",pi[pi.WARN=3]="WARN",pi[pi.ERROR=4]="ERROR",pi[pi.SILENT=5]="SILENT";var n=o.INFO,t=(Object.defineProperty(r.prototype,"logLevel",{get:function(){return this._logLevel},set:function(t){if(!(t in o))throw new TypeError("Invalid value assigned to `logLevel`");this._logLevel=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"logHandler",{get:function(){return this._logHandler},set:function(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t},enumerable:!0,configurable:!0}),r.prototype.debug=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.DEBUG].concat(t))},r.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.VERBOSE].concat(t))},r.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.INFO].concat(t))},r.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.WARN].concat(t))},r.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._logHandler.apply(this,[this,o.ERROR].concat(t))},r);function r(t){this.name=t,this._logLevel=n,this._logHandler=e}var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function a(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var h=function(){return(h=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function p(o,a,s,u){return new(s=s||Promise)(function(t,e){function n(t){try{i(u.next(t))}catch(t){e(t)}}function r(t){try{i(u.throw(t))}catch(t){e(t)}}function i(e){e.done?t(e.value):new s(function(t){t(e.value)}).then(n,r)}i((u=u.apply(o,a||[])).next())})}function d(n,r){var i,o,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,o&&(a=2&e[0]?o.return:e[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,e[1])).done)return a;switch(o=0,(e=a?[2&e[0],a.value]:e)[0]){case 0:case 1:a=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,o=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!a||e[1]>a[0]&&e[1]<a[3])){s.label=e[1];break}if(6===e[0]&&s.label<a[1]){s.label=a[1],a=e;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(e);break}a[2]&&s.ops.pop(),s.trys.pop();continue}e=r.call(n,s)}catch(t){e=[6,t],o=0}finally{i=a=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}function s(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}var u,l=(a(c,u=Error),c);function c(t,e){e=u.call(this,e)||this;return e.code=t,e.name="FirebaseError",Object.setPrototypeOf(e,c.prototype),Error.captureStackTrace&&Error.captureStackTrace(e,f.prototype.create),e}var f=(m.prototype.create=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var r,i=e[0]||{},o=this.service+"/"+t,t=this.errors[t],t=t?(r=i,t.replace(y,function(t,e){var n=r[e];return null!=n?n.toString():"<"+e+"?>"})):"Error",t=this.serviceName+": "+t+" ("+o+").",a=new l(o,t),s=0,u=Object.keys(i);s<u.length;s++){var c=u[s];"_"!==c.slice(-1)&&(c in a&&console.warn('Overwriting FirebaseError base field "'+c+'" can cause unexpected behavior.'),a[c]=i[c])}return a},m);function m(t,e,n){this.service=t,this.serviceName=e,this.errors=n}var y=/\{\$([^}]+)}/g,g="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},v=g;function b(t){return"string"==typeof t}function w(t){return"number"==typeof t}function S(t,e){t=t.split("."),e=e||v;for(var n=0;n<t.length;n++)if(null==(e=e[t[n]]))return null;return e}function E(){}function T(t){var e=typeof t;if("object"==e){if(!t)return"null";if(t instanceof Array)return"array";if(t instanceof Object)return e;var n=Object.prototype.toString.call(t);if("[object Window]"==n)return"object";if("[object Array]"==n||"number"==typeof t.length&&void 0!==t.splice&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("splice"))return"array";if("[object Function]"==n||void 0!==t.call&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("call"))return"function"}else if("function"==e&&void 0===t.call)return"object";return e}function I(t){return"array"==T(t)}function C(t){var e=T(t);return"array"==e||"object"==e&&"number"==typeof t.length}function D(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var N="closure_uid_"+(1e9*Math.random()>>>0),A=0;function k(t,e,n){return t.call.apply(t.bind,arguments)}function R(e,n,t){if(!e)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var t=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(t,r),e.apply(n,t)}}return function(){return e.apply(n,arguments)}}function M(t,e,n){return(M=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?k:R).apply(null,arguments)}function _(e){var n=Array.prototype.slice.call(arguments,1);return function(){var t=n.slice();return t.push.apply(t,arguments),e.apply(this,t)}}var O=Date.now||function(){return+new Date};function L(t,o){function e(){}e.prototype=o.prototype,t.N=o.prototype,t.prototype=new e,(t.prototype.constructor=t).yb=function(t,e,n){for(var r=Array(arguments.length-2),i=2;i<arguments.length;i++)r[i-2]=arguments[i];return o.prototype[e].apply(t,r)}}function P(){this.j=this.j,this.i=this.i}P.prototype.j=!1,P.prototype.la=function(){!this.j&&(this.j=!0,this.G(),0)&&(this[N]||(this[N]=++A))},P.prototype.G=function(){if(this.i)for(;this.i.length;)this.i.shift()()};var x=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if(b(t))return b(e)&&1==e.length?t.indexOf(e,0):-1;for(var n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1},q=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(t,e,n){for(var r=t.length,i=b(t)?t.split(""):t,o=0;o<r;o++)o in i&&e.call(n,i[o],o,t)};function F(){return Array.prototype.concat.apply([],arguments)}function V(t){var e=t.length;if(0<e){for(var n=Array(e),r=0;r<e;r++)n[r]=t[r];return n}return[]}function B(t){return/^[\s\xa0]*$/.test(t)}var U,Q=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function K(t,e){return-1!=t.indexOf(e)}function j(t,e){return t<e?-1:e<t?1:0}t:{var W=v.navigator;if(W){W=W.userAgent;if(W){U=W;break t}}U=""}function G(t,e,n){for(var r in t)e.call(n,t[r],r,t)}function z(t){var e,n={};for(e in t)n[e]=t[e];return n}var H="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Y(t){for(var e,n,r=1;r<arguments.length;r++){for(e in n=arguments[r])t[e]=n[e];for(var i=0;i<H.length;i++)e=H[i],Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])}}function X(t){return X[" "](t),t}X[" "]=E;var J,$=K(U,"Opera"),Z=K(U,"Trident")||K(U,"MSIE"),tt=K(U,"Edge"),et=tt||Z,nt=K(U,"Gecko")&&!(K(U.toLowerCase(),"webkit")&&!K(U,"Edge"))&&!(K(U,"Trident")||K(U,"MSIE"))&&!K(U,"Edge"),rt=K(U.toLowerCase(),"webkit")&&!K(U,"Edge");function it(){var t=v.document;return t?t.documentMode:void 0}t:{var ot="",at=(at=U,nt?/rv:([^\);]+)(\)|;)/.exec(at):tt?/Edge\/([\d\.]+)/.exec(at):Z?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(at):rt?/WebKit\/(\S+)/.exec(at):$?/(?:Version)[ \/]?(\S+)/.exec(at):void 0);if(at&&(ot=at?at[1]:""),Z){at=it();if(null!=at&&at>parseFloat(ot)){J=String(at);break t}}J=ot}var st={};function ut(s){return t=s,e=st,Object.prototype.hasOwnProperty.call(e,t)?e[t]:e[t]=function(){for(var t=0,e=Q(String(J)).split("."),n=Q(String(s)).split("."),r=Math.max(e.length,n.length),i=0;0==t&&i<r;i++){var o=e[i]||"",a=n[i]||"";do{if(o=/(\d*)(\D*)(.*)/.exec(o)||["","","",""],a=/(\d*)(\D*)(.*)/.exec(a)||["","","",""],0==o[0].length&&0==a[0].length)break;t=j(0==o[1].length?0:parseInt(o[1],10),0==a[1].length?0:parseInt(a[1],10))||j(0==o[2].length,0==a[2].length)||j(o[2],a[2]),o=o[3],a=a[3]}while(0==t)}return 0<=t}();var t,e}var ct=v.document,ht=ct&&Z?it()||("CSS1Compat"==ct.compatMode?parseInt(J,10):5):void 0,lt=!Z||9<=Number(ht),ft=Z&&!ut("9"),pt=function(){if(!v.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{v.addEventListener("test",E,e),v.removeEventListener("test",E,e)}catch(t){}return t}();function dt(t,e){this.type=t,this.a=this.target=e,this.Ja=!0}function mt(t,e){if(dt.call(this,t?t.type:""),this.relatedTarget=this.a=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.pointerId=0,this.pointerType="",this.c=null,t){var n=this.type=t.type,r=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.a=e,e=t.relatedTarget){if(nt){t:{try{X(e.nodeName);var i=!0;break t}catch(t){}i=!1}i||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType=b(t.pointerType)?t.pointerType:yt[t.pointerType]||"",(this.c=t).defaultPrevented&&this.b()}}dt.prototype.b=function(){this.Ja=!1},L(mt,dt);var yt={2:"touch",3:"pen",4:"mouse"};mt.prototype.b=function(){mt.N.b.call(this);var t=this.c;if(t.preventDefault)t.preventDefault();else if(t.returnValue=!1,ft)try{(t.ctrlKey||112<=t.keyCode&&t.keyCode<=123)&&(t.keyCode=-1)}catch(t){}};var gt="closure_listenable_"+(1e6*Math.random()|0),vt=0;function bt(t,e,n,r,i){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!r,this.da=i,this.key=++vt,this.X=this.Z=!1}function wt(t){t.X=!0,t.listener=null,t.proxy=null,t.src=null,t.da=null}function St(t){this.src=t,this.a={},this.b=0}function Et(t,e){var n,r,i,o=e.type;o in t.a&&(r=t.a[o],(n=0<=(i=x(r,e)))&&Array.prototype.splice.call(r,i,1),n&&(wt(e),0==t.a[o].length&&(delete t.a[o],t.b--)))}function Tt(t,e,n,r){for(var i=0;i<t.length;++i){var o=t[i];if(!o.X&&o.listener==e&&o.capture==!!n&&o.da==r)return i}return-1}St.prototype.add=function(t,e,n,r,i){var o=t.toString();(t=this.a[o])||(t=this.a[o]=[],this.b++);var a=Tt(t,e,r,i);return-1<a?(e=t[a],n||(e.Z=!1)):((e=new bt(e,this.src,o,!!r,i)).Z=n,t.push(e)),e};var It="closure_lm_"+(1e6*Math.random()|0),Ct={};function Dt(t,e,n,r,i){if(r&&r.once)return function t(e,n,r,i,o){if(I(n)){for(var a=0;a<n.length;a++)t(e,n[a],r,i,o);return null}return r=Lt(r),e&&e[gt]?e.Ba(n,r,D(i)?!!i.capture:!!i,o):Nt(e,n,r,!0,i,o)}(t,e,n,r,i);if(I(e)){for(var o=0;o<e.length;o++)Dt(t,e[o],n,r,i);return null}return n=Lt(n),t&&t[gt]?t.Aa(e,n,D(r)?!!r.capture:!!r,i):Nt(t,e,n,!1,r,i)}function Nt(t,e,n,r,i,o){if(!e)throw Error("Invalid event type");var a=D(i)?!!i.capture:!!i;if(a&&!lt)return null;var s,u,c=_t(t);if(c||(t[It]=c=new St(t)),(n=c.add(e,n,r,a,o)).proxy)return n;if(s=Mt,u=lt?function(t){return s.call(u.src,u.listener,t)}:function(t){if(!(t=s.call(u.src,u.listener,t)))return t},(n.proxy=r=u).src=t,r.listener=n,t.addEventListener)void 0===(i=!pt?a:i)&&(i=!1),t.addEventListener(e.toString(),r,i);else if(t.attachEvent)t.attachEvent(kt(e.toString()),r);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(r)}return n}function At(t){var e,n,r;w(t)||!t||t.X||((e=t.src)&&e[gt]?Et(e.c,t):(n=t.type,r=t.proxy,e.removeEventListener?e.removeEventListener(n,r,t.capture):e.detachEvent?e.detachEvent(kt(n),r):e.addListener&&e.removeListener&&e.removeListener(r),(n=_t(e))?(Et(n,t),0==n.b&&(n.src=null,e[It]=null)):wt(t)))}function kt(t){return t in Ct?Ct[t]:Ct[t]="on"+t}function Rt(t,e){var n=t.listener,r=t.da||t.src;return t.Z&&At(t),n.call(r,e)}function Mt(t,e){return!!t.X||Rt(t,lt?new mt(e,this):e=new mt(e||S("window.event"),this))}function _t(t){return(t=t[It])instanceof St?t:null}var Ot="__closure_events_fn_"+(1e9*Math.random()>>>0);function Lt(e){return"function"==T(e)?e:(e[Ot]||(e[Ot]=function(t){return e.handleEvent(t)}),e[Ot])}function Pt(){P.call(this),this.c=new St(this),(this.J=this).B=null}function xt(t,e,n,r){if(!(e=t.c.a[String(e)]))return!0;e=e.concat();for(var i=!0,o=0;o<e.length;++o){var a,s,u=e[o];u&&!u.X&&u.capture==n&&(a=u.listener,s=u.da||u.src,u.Z&&Et(t.c,u),i=!1!==a.call(s,r)&&i)}return i&&0!=r.Ja}L(Pt,P),Pt.prototype[gt]=!0,(Zi=Pt.prototype).addEventListener=function(t,e,n,r){Dt(this,t,e,n,r)},Zi.removeEventListener=function(t,e,n,r){!function t(e,n,r,i,o){if(I(n))for(var a=0;a<n.length;a++)t(e,n[a],r,i,o);else i=D(i)?!!i.capture:!!i,r=Lt(r),e&&e[gt]?(e=e.c,(n=String(n).toString())in e.a&&-1<(r=Tt(a=e.a[n],r,i,o))&&(wt(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete e.a[n],e.b--))):(e=e&&_t(e))&&(n=e.a[n.toString()],(r=(e=-1)<(e=n?Tt(n,r,i,o):e)?n[e]:null)&&At(r))}(this,t,e,n,r)},Zi.dispatchEvent=function(t){var e;if(n=this.B)for(e=[];n;n=n.B)e.push(n);var n=this.J,r=t.type||t;if(b(t)?t=new dt(t,n):t instanceof dt?t.target=t.target||n:(a=t,Y(t=new dt(r,n),a)),a=!0,e)for(var i=e.length-1;0<=i;i--)var o=t.a=e[i],a=xt(o,r,!0,t)&&a;if(a=xt(o=t.a=n,r,!0,t)&&a,a=xt(o,r,!1,t)&&a,e)for(i=0;i<e.length;i++)a=xt(o=t.a=e[i],r,!1,t)&&a;return a},Zi.G=function(){if(Pt.N.G.call(this),this.c){var t,e=this.c;for(t in e.a){for(var n=e.a[t],r=0;r<n.length;r++)wt(n[r]);delete e.a[t],e.b--}}this.B=null},Zi.Aa=function(t,e,n,r){return this.c.add(String(t),e,!1,n,r)},Zi.Ba=function(t,e,n,r){return this.c.add(String(t),e,!0,n,r)};var qt=v.JSON.stringify;function Ft(t,e){this.c=t,this.f=e,this.b=0,this.a=null}function Vt(){this.b=this.a=null}Ft.prototype.get=function(){var t;return 0<this.b?(this.b--,t=this.a,this.a=t.next,t.next=null):t=this.c(),t};var Bt,Ut=new Ft(function(){return new Qt},function(t){t.reset()});function Qt(){this.next=this.b=this.a=null}function Kt(t,e){var n;Bt||(n=v.Promise.resolve(void 0),Bt=function(){n.then(Gt)}),jt||(Bt(),jt=!0),Wt.add(t,e)}Vt.prototype.add=function(t,e){var n=Ut.get();n.set(t,e),this.b?this.b.next=n:this.a=n,this.b=n},Qt.prototype.set=function(t,e){this.a=t,this.b=e,this.next=null};var jt=!(Qt.prototype.reset=function(){this.next=this.b=this.a=null}),Wt=new Vt;function Gt(){for(var t,e;e=void 0,n=null,(e=Wt).a&&(n=e.a,e.a=e.a.next,e.a||(e.b=null),n.next=null),t=n;){try{t.a.call(t.b)}catch(t){!function(t){v.setTimeout(function(){throw t},0)}(t)}var n=Ut;n.f(t),n.b<100&&(n.b++,t.next=n.a,n.a=t)}jt=!1}function zt(t,e){Pt.call(this),this.b=t||1,this.a=e||v,this.f=M(this.gb,this),this.g=O()}function Ht(t){t.ba=!1,t.L&&(t.a.clearTimeout(t.L),t.L=null)}function Yt(t,e,n){if("function"==T(t))n&&(t=M(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=M(t.handleEvent,t)}return 2147483647<Number(e)?-1:v.setTimeout(t,e||0)}function Xt(t,e,n){P.call(this),this.f=null!=n?M(t,n):t,this.c=e,this.b=M(this.ab,this),this.a=[]}function Jt(t){t.U=Yt(t.b,t.c),t.f.apply(null,t.a)}function $t(t){P.call(this),this.b=t,this.a={}}L(zt,Pt),(Zi=zt.prototype).ba=!1,Zi.L=null,Zi.gb=function(){var t;this.ba&&(0<(t=O()-this.g)&&t<.8*this.b?this.L=this.a.setTimeout(this.f,this.b-t):(this.L&&(this.a.clearTimeout(this.L),this.L=null),this.dispatchEvent("tick"),this.ba&&(Ht(this),this.start())))},Zi.start=function(){this.ba=!0,this.L||(this.L=this.a.setTimeout(this.f,this.b),this.g=O())},Zi.G=function(){zt.N.G.call(this),Ht(this),delete this.a},L(Xt,P),(Zi=Xt.prototype).ea=!1,Zi.U=null,Zi.Ua=function(t){this.a=arguments,this.U?this.ea=!0:Jt(this)},Zi.G=function(){Xt.N.G.call(this),this.U&&(v.clearTimeout(this.U),this.U=null,this.ea=!1,this.a=[])},Zi.ab=function(){this.U=null,this.ea&&(this.ea=!1,Jt(this))},L($t,P);var Zt=[];function te(t,e,n,r){I(n)||(n&&(Zt[0]=n.toString()),n=Zt);for(var i=0;i<n.length;i++){var o=Dt(e,n[i],r||t.handleEvent,!1,t.b||t);if(!o)break;t.a[o.key]=o}}function ee(t){G(t.a,function(t,e){this.a.hasOwnProperty(e)&&At(t)},t),t.a={}}function ne(){}$t.prototype.G=function(){$t.N.G.call(this),ee(this)},$t.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var re=new Pt;function ie(t){dt.call(this,"serverreachability",t)}function oe(){re.dispatchEvent(new ie(re))}function ae(t){dt.call(this,"statevent",t)}function se(){re.dispatchEvent(new ae(re))}function ue(t){dt.call(this,"timingevent",t)}function ce(t,e){if("function"!=T(t))throw Error("Fn must not be null and must be a function");return v.setTimeout(function(){t()},e)}L(ie,dt),L(ae,dt),L(ue,dt);var he={NO_ERROR:0,hb:1,ob:2,nb:3,kb:4,mb:5,pb:6,Ma:7,TIMEOUT:8,sb:9},le={jb:"complete",wb:"success",Na:"error",Ma:"abort",ub:"ready",vb:"readystatechange",TIMEOUT:"timeout",qb:"incrementaldata",tb:"progress",lb:"downloadprogress",xb:"uploadprogress"};function fe(){}function pe(t){var e;return e=!(e=t.a)?t.a={}:e}function de(){}fe.prototype.a=null;var me={OPEN:"a",ib:"b",Na:"c",rb:"d"};function ye(){dt.call(this,"d")}function ge(){dt.call(this,"c")}function ve(){}function be(t,e,n){this.g=t,this.W=e,this.V=n||1,this.I=new $t(this),this.O=45e3,this.P=new zt(t=et?125:void 0),this.h=null,this.b=!1,this.l=this.D=this.f=this.F=this.v=this.R=this.i=null,this.j=[],this.a=null,this.A=0,this.c=this.w=null,this.o=-1,this.m=!1,this.J=0,this.B=null,this.s=this.S=this.H=!1}L(ye,dt),L(ge,dt),L(ve,fe);var we=new ve,Se={},Ee={};function Te(t,e,n){t.F=1,t.f=ze(Be(e)),t.l=n,t.H=!0,Ce(t,null)}function Ie(t,e,n,r){t.F=1,t.f=ze(Be(e)),t.l=null,t.H=n,Ce(t,r)}function Ce(t,e){t.v=O(),Ne(t),t.D=Be(t.f),Ge(t.D,"t",t.V),t.A=0,t.a=t.g.$(t.g.Y()?e:null),0<t.J&&(t.B=new Xt(M(t.Ka,t,t.a),t.J)),te(t.I,t.a,"readystatechange",t.eb),e=t.h?z(t.h):{},t.l?(t.w||(t.w="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.a.ca(t.D,t.w,t.l,e)):(t.w="GET",t.a.ca(t.D,t.w,null,e)),oe()}function De(t,e,n){for(var r,i,o,a=!0;!t.m&&t.A<n.length;){var s=(s=n,o=i=void 0,i=(r=t).A,-1==(o=s.indexOf("\n",i))?Ee:(i=Number(s.substring(i,o)),isNaN(i)?Se:(o+=1)+i>s.length?Ee:(s=s.substr(o,i),r.A=o+i,s)));if(s==Ee){4==e&&(t.c=4,se(),a=!1);break}if(s==Se){t.c=4,se(),a=!1;break}_e(t,s)}4==e&&0==n.length&&(t.c=1,se(),a=!1),t.b=t.b&&a,a||(Me(t),Re(t))}function Ne(t){t.R=O()+t.O,Ae(t,t.O)}function Ae(t,e){if(null!=t.i)throw Error("WatchDog timer not null");t.i=ce(M(t.bb,t),e)}function ke(t){t.i&&(v.clearTimeout(t.i),t.i=null)}function Re(t){t.g.Da()||t.m||t.g.na(t)}function Me(t){ke(t);var e=t.B;e&&"function"==typeof e.la&&e.la(),t.B=null,Ht(t.P),ee(t.I),t.a&&(e=t.a,t.a=null,e.abort(),e.la())}function _e(t,e){try{t.g.Ga(t,e),oe()}catch(t){}}function Oe(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(C(t)||b(t))q(t,e,void 0);else{if(t.K&&"function"==typeof t.K)var n=t.K();else if(t.C&&"function"==typeof t.C)n=void 0;else if(C(t)||b(t))for(var n=[],r=t.length,i=0;i<r;i++)n.push(i);else for(i in n=[],r=0,t)n[r++]=i;for(var i=(r=function(t){if(t.C&&"function"==typeof t.C)return t.C();if(b(t))return t.split("");if(C(t)){for(var e=[],n=t.length,r=0;r<n;r++)e.push(t[r]);return e}for(r in e=[],n=0,t)e[n++]=t[r];return e}(t)).length,o=0;o<i;o++)e.call(void 0,r[o],n&&n[o],t)}}function Le(t,e){this.b={},this.a=[],this.c=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(t)if(t instanceof Le)for(n=t.K(),r=0;r<n.length;r++)this.set(n[r],t.get(n[r]));else for(r in t)this.set(r,t[r])}function Pe(t,e){qe(t.b,e)&&(delete t.b[e],t.c--,t.a.length>2*t.c&&xe(t))}function xe(t){if(t.c!=t.a.length){for(var e=0,n=0;e<t.a.length;){var r=t.a[e];qe(t.b,r)&&(t.a[n++]=r),e++}t.a.length=n}if(t.c!=t.a.length){for(var i={},n=e=0;e<t.a.length;)qe(i,r=t.a[e])||(i[t.a[n++]=r]=1),e++;t.a.length=n}}function qe(t,e){return Object.prototype.hasOwnProperty.call(t,e)}(Zi=be.prototype).setTimeout=function(t){this.O=t},Zi.eb=function(t){t=t.target;var e=this.B;e&&3==Fn(t)?e.Ua():this.Ka(t)},Zi.Ka=function(t){try{if(t==this.a)t:{var e=Fn(this.a),n=this.a.ya();this.a.T();if(!(e<3||3==e&&!et&&!this.a.aa())){this.m||4!=e||7==n||oe(),ke(this);var r=this.a.T();this.o=r;var i=this.a.aa();if(this.b=200==r){if(this.S&&!this.s){e:{if(this.a){var o=Vn(this.a,"X-HTTP-Initial-Response");if(o&&!B(o)){var a=o;break e}}a=null}if(!a){this.b=!1,this.c=3,se(),Me(this),Re(this);break t}this.s=!0,_e(this,a)}this.H?(De(this,e,i),et&&this.b&&3==e&&(te(this.I,this.P,"tick",this.cb),this.P.start())):_e(this,i),4==e&&Me(this),this.b&&!this.m&&(4==e?this.g.na(this):(this.b=!1,Ne(this)))}else 400==r&&0<i.indexOf("Unknown SID")?this.c=3:this.c=0,se(),Me(this),Re(this)}}}catch(t){}},Zi.cb=function(){var t,e;this.a&&(t=Fn(this.a),e=this.a.aa(),this.A<e.length&&(ke(this),De(this,t,e),this.b&&4!=t&&Ne(this)))},Zi.cancel=function(){this.m=!0,Me(this)},Zi.bb=function(){this.i=null;var t=O();0<=t-this.R?(2!=this.F&&(oe(),se()),Me(this),this.c=2,Re(this)):Ae(this,this.R-t)},(Zi=Le.prototype).C=function(){xe(this);for(var t=[],e=0;e<this.a.length;e++)t.push(this.b[this.a[e]]);return t},Zi.K=function(){return xe(this),this.a.concat()},Zi.get=function(t,e){return qe(this.b,t)?this.b[t]:e},Zi.set=function(t,e){qe(this.b,t)||(this.c++,this.a.push(t)),this.b[t]=e},Zi.forEach=function(t,e){for(var n=this.K(),r=0;r<n.length;r++){var i=n[r],o=this.get(i);t.call(e,o,i,this)}};var Fe=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^/?#]*)@)?([^/#?]*?)(?::([0-9]+))?(?=[/#?]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function Ve(t,e){var n;this.b=this.j=this.f="",this.i=null,this.g=this.a="",this.h=!1,t instanceof Ve?(this.h=void 0!==e?e:t.h,Ue(this,t.f),this.j=t.j,Qe(this,t.b),Ke(this,t.i),this.a=t.a,je(this,un(t.c)),this.g=t.g):t&&(n=String(t).match(Fe))?(this.h=!!e,Ue(this,n[1]||"",!0),this.j=He(n[2]||""),Qe(this,n[3]||"",!0),Ke(this,n[4]),this.a=He(n[5]||"",!0),je(this,n[6]||"",!0),this.g=He(n[7]||"")):(this.h=!!e,this.c=new nn(null,this.h))}function Be(t){return new Ve(t)}function Ue(t,e,n){t.f=n?He(e,!0):e,t.f&&(t.f=t.f.replace(/:$/,""))}function Qe(t,e,n){t.b=n?He(e,!0):e}function Ke(t,e){if(e){if(e=Number(e),isNaN(e)||e<0)throw Error("Bad port number "+e);t.i=e}else t.i=null}function je(t,e,n){var r,i;e instanceof nn?(t.c=e,r=t.c,(i=t.h)&&!r.f&&(rn(r),r.c=null,r.a.forEach(function(t,e){var n=e.toLowerCase();e!=n&&(on(this,e),sn(this,n,t))},r)),r.f=i):(n||(e=Ye(e,tn)),t.c=new nn(e,t.h))}function We(t,e,n){t.c.set(e,n)}function Ge(t,e,n){I(n)||(n=[String(n)]),sn(t.c,e,n)}function ze(t){return We(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^O()).toString(36)),t}function He(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function Ye(t,e,n){return b(t)?(t=encodeURI(t).replace(e,Xe),t=n?t.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):t):null}function Xe(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}Ve.prototype.toString=function(){var t=[],e=this.f;e&&t.push(Ye(e,Je,!0),":");var n=this.b;return!n&&"file"!=e||(t.push("//"),(e=this.j)&&t.push(Ye(e,Je,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.i)&&t.push(":",String(n))),(n=this.a)&&(this.b&&"/"!=n.charAt(0)&&t.push("/"),t.push(Ye(n,"/"==n.charAt(0)?Ze:$e,!0))),(n=this.c.toString())&&t.push("?",n),(n=this.g)&&t.push("#",Ye(n,en)),t.join("")},Ve.prototype.resolve=function(t){var e=Be(this),n=!!t.f;n?Ue(e,t.f):n=!!t.j,n?e.j=t.j:n=!!t.b,n?Qe(e,t.b):n=null!=t.i;var r=t.a;if(n)Ke(e,t.i);else if(n=!!t.a)if("/"!=r.charAt(0)&&(this.b&&!this.a?r="/"+r:-1!=(i=e.a.lastIndexOf("/"))&&(r=e.a.substr(0,i+1)+r)),".."==(i=r)||"."==i)r="";else if(K(i,"./")||K(i,"/.")){for(var r=0==i.lastIndexOf("/",0),i=i.split("/"),o=[],a=0;a<i.length;){var s=i[a++];"."==s?r&&a==i.length&&o.push(""):".."==s?((1<o.length||1==o.length&&""!=o[0])&&o.pop(),r&&a==i.length&&o.push("")):(o.push(s),r=!0)}r=o.join("/")}else r=i;return n?e.a=r:n=""!==t.c.toString(),n?je(e,un(t.c)):n=!!t.g,n&&(e.g=t.g),e};var Je=/[#\/\?@]/g,$e=/[#\?:]/g,Ze=/[#\?]/g,tn=/[#\?@]/g,en=/#/g;function nn(t,e){this.b=this.a=null,this.c=t||null,this.f=!!e}function rn(o){o.a||(o.a=new Le,o.b=0,o.c&&function(t){if(t){t=t.split("&");for(var e=0;e<t.length;e++){var n,r=t[e].indexOf("="),i=null;0<=r?(n=t[e].substring(0,r),i=t[e].substring(r+1)):n=t[e],r=n,i=i?decodeURIComponent(i.replace(/\+/g," ")):"",o.add(decodeURIComponent(r.replace(/\+/g," ")),i)}}}(o.c))}function on(t,e){rn(t),e=cn(t,e),qe(t.a.b,e)&&(t.c=null,t.b-=t.a.get(e).length,Pe(t.a,e))}function an(t,e){return rn(t),e=cn(t,e),qe(t.a.b,e)}function sn(t,e,n){on(t,e),0<n.length&&(t.c=null,t.a.set(cn(t,e),V(n)),t.b+=n.length)}function un(t){var e=new nn;return e.c=t.c,t.a&&(e.a=new Le(t.a),e.b=t.b),e}function cn(t,e){return e=String(e),e=t.f?e.toLowerCase():e}function hn(t){this.a=t,this.b=this.h=null,this.g=!1,this.i=null,this.c=-1,this.l=this.f=null}function ln(t){var e,n,r=t.a.F.a;null!=r?(se(),r?(se(),Jn(t.a,t,!1)):(se(),Jn(t.a,t,!0))):(t.b=new be(t,void 0,void 0),t.b.h=t.h,r=nr(r=t.a,r.Y()?t.f:null,t.i),se(),Ge(r,"TYPE","xmlhttp"),e=t.a.j,n=t.a.I,e&&n&&We(r,e,n),Ie(t.b,r,!1,t.f))}function fn(){this.a=this.b=null}function pn(){this.a=new Le}function dn(t){var e=typeof t;return"object"==e&&t||"function"==e?"o"+(t[N]||(t[N]=++A)):e.charAt(0)+t}function mn(t,e){this.b=t,this.a=e}function yn(t){this.g=t||10,t=v.PerformanceNavigationTiming?0<(t=v.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):!!(v.ka&&v.ka.Ea&&v.ka.Ea()&&v.ka.Ea().zb),this.f=t?this.g:1,this.a=null,1<this.f&&(this.a=new pn),this.b=null,this.c=[]}(Zi=nn.prototype).add=function(t,e){rn(this),this.c=null,t=cn(this,t);var n=this.a.get(t);return n||this.a.set(t,n=[]),n.push(e),this.b+=1,this},Zi.forEach=function(n,r){rn(this),this.a.forEach(function(t,e){q(t,function(t){n.call(r,t,e,this)},this)},this)},Zi.K=function(){rn(this);for(var t=this.a.C(),e=this.a.K(),n=[],r=0;r<e.length;r++)for(var i=t[r],o=0;o<i.length;o++)n.push(e[r]);return n},Zi.C=function(t){rn(this);var e=[];if(b(t))an(this,t)&&(e=F(e,this.a.get(cn(this,t))));else{t=this.a.C();for(var n=0;n<t.length;n++)e=F(e,t[n])}return e},Zi.set=function(t,e){return rn(this),this.c=null,an(this,t=cn(this,t))&&(this.b-=this.a.get(t).length),this.a.set(t,[e]),this.b+=1,this},Zi.get=function(t,e){return t&&0<(t=this.C(t)).length?String(t[0]):e},Zi.toString=function(){if(this.c)return this.c;if(!this.a)return"";for(var t=[],e=this.a.K(),n=0;n<e.length;n++)for(var r=e[n],i=encodeURIComponent(String(r)),r=this.C(r),o=0;o<r.length;o++){var a=i;""!==r[o]&&(a+="="+encodeURIComponent(String(r[o]))),t.push(a)}return this.c=t.join("&")},L(function(){},function(){}),(Zi=hn.prototype).M=null,Zi.$=function(t){return this.a.$(t)},Zi.abort=function(){this.b&&(this.b.cancel(),this.b=null),this.c=-1},Zi.Da=function(){return!1},Zi.Ga=function(t,e){var n;if(this.c=t.o,0==this.M)if(!this.a.o&&(t=t.a)&&(n=Vn(t,"X-Client-Wire-Protocol"),this.l=n||null,this.a.j&&(t=Vn(t,"X-HTTP-Session-Id"))&&(this.a.I=t)),e){try{var r=this.a.ja.a.parse(e)}catch(t){return(e=this.a).m=this.c,void tr(e,2)}this.f=r[0]}else(e=this.a).m=this.c,tr(e,2);else 1==this.M&&(this.g?se():"11111"==e?(se(),this.g=!0,(!Z||10<=Number(ht))&&(this.c=200,this.b.cancel(),se(),Jn(this.a,this,!0))):(se(),this.g=!1))},Zi.na=function(){var t;this.c=this.b.o,this.b.b?0==this.M?(this.M=1,ln(this)):1==this.M&&(this.g?(se(),Jn(this.a,this,!0)):(se(),Jn(this.a,this,!1))):(0!=this.M&&1!=this.M||se(),(t=this.a).m=this.c,tr(t,2))},Zi.Y=function(){return this.a.Y()},Zi.ma=function(){return this.a.ma()},pn.prototype.add=function(t){this.a.set(dn(t),t)},pn.prototype.C=function(){return this.a.C()};function gn(t,e){!t.a&&(K(e,"spdy")||K(e,"quic")||K(e,"h2"))&&(t.f=t.g,t.a=new pn,t.b&&(Sn(t,t.b),t.b=null))}function vn(t){return t.b||t.a&&t.a.a.c>=t.f}function bn(t){return t.b?1:t.a?t.a.a.c:0}function wn(t,e){return t.b?t.b==e:!!t.a&&(e=dn(e),qe(t.a.a.b,e))}function Sn(t,e){t.a?t.a.add(e):t.b=e}function En(t,e){var n;t.b&&t.b==e?t.b=null:((n=t.a)&&(n=dn(e),n=qe(t.a.a.b,n)),n&&Pe(t.a.a,dn(e)))}function Tn(t){if(null!=t.b)return t.c.concat(t.b.j);if(null==t.a||0==t.a.a.c)return V(t.c);var e=t.c;return q(t.a.C(),function(t){e=e.concat(t.j)}),e}function In(){}function Cn(){this.a=new In}function Dn(t,e,n,r,i){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,i(r)}catch(t){}}yn.prototype.cancel=function(){var t;this.c=Tn(this),this.b?(this.b.cancel(),this.b=null):this.a&&0!=this.a.a.c&&(q(this.a.C(),function(t){t.cancel()}),(t=this.a.a).b={},t.a.length=0,t.c=0)},In.prototype.stringify=function(t){return v.JSON.stringify(t,void 0)},In.prototype.parse=function(t){return v.JSON.parse(t,void 0)};var Nn=v.JSON.parse;function An(t){Pt.call(this),this.headers=new Le,this.H=t||null,this.b=!1,this.s=this.a=null,this.A="",this.h=0,this.f="",this.g=this.w=this.l=this.v=!1,this.o=0,this.m=null,this.I=kn,this.D=this.F=!1}L(An,Pt);var kn="",Rn=/^https?$/i,Mn=["POST","PUT"];function _n(t){return"content-type"==t.toLowerCase()}function On(t,e){t.b=!1,t.a&&(t.g=!0,t.a.abort(),t.g=!1),t.f=e,t.h=5,Ln(t),xn(t)}function Ln(t){t.v||(t.v=!0,t.dispatchEvent("complete"),t.dispatchEvent("error"))}function Pn(t){if(t.b&&(!t.s[1]||4!=Fn(t)||2!=t.T()))if(t.l&&4==Fn(t))Yt(t.Fa,0,t);else if(t.dispatchEvent("readystatechange"),4==Fn(t)){t.b=!1;try{var e,n,r,i,o=t.T();t:switch(o){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var a=!0;break t;default:a=!1}(e=a)||((n=0===o)&&(!(i=String(t.A).match(Fe)[1]||null)&&v.self&&v.self.location&&(i=(r=v.self.location.protocol).substr(0,r.length-1)),n=!Rn.test(i?i.toLowerCase():"")),e=n),e?(t.dispatchEvent("complete"),t.dispatchEvent("success")):(t.h=6,t.f=t.za()+" ["+t.T()+"]",Ln(t))}finally{xn(t)}}}function xn(t,e){if(t.a){qn(t);var n=t.a,r=t.s[0]?E:null;t.a=null,t.s=null,e||t.dispatchEvent("ready");try{n.onreadystatechange=r}catch(t){}}}function qn(t){t.a&&t.D&&(t.a.ontimeout=null),t.m&&(v.clearTimeout(t.m),t.m=null)}function Fn(t){return t.a?t.a.readyState:0}function Vn(t,e){return t.a?t.a.getResponseHeader(e):null}function Bn(t,e,n){t:{for(r in n){var r=!1;break t}r=!0}return r?t:(o="",G(n,function(t,e){o+=e,o+=":",o+=t,o+="\r\n"}),n=o,b(t)?(e=encodeURIComponent(String(e)),(e+=n=null!=n?"="+encodeURIComponent(String(n)):"")&&((n=t.indexOf("#"))<0&&(n=t.length),i=(r=t.indexOf("?"))<0||n<r?(r=n,""):t.substring(r+1,n),n=(t=[t.substr(0,r),i,t.substr(n)])[1],t[1]=e?n?n+"&"+e:e:n,t=t[0]+(t[1]?"?"+t[1]:"")+t[2])):We(t,e,n),t);var i,o}function Un(t){this.f=[],this.F=new fn,this.ga=this.pa=this.B=this.ha=this.a=this.I=this.j=this.V=this.g=this.J=this.i=null,this.Ra=this.P=0,this.Pa=!!S("internalChannelParams.failFast",t),this.ia=this.w=this.s=this.l=this.h=this.c=null,this.oa=!0,this.m=this.ra=this.O=-1,this.S=this.v=this.A=0,this.Oa=S("internalChannelParams.baseRetryDelayMs",t)||5e3,this.Sa=S("internalChannelParams.retryDelaySeedMs",t)||1e4,this.Qa=S("internalChannelParams.forwardChannelMaxRetries",t)||2,this.qa=S("internalChannelParams.forwardChannelRequestTimeoutMs",t)||2e4,this.La=t&&t.Ab||void 0,this.D=void 0,this.R=t&&t.supportsCrossDomainXhr||!1,this.H="",this.b=new yn(t&&t.concurrentRequestLimit),this.ja=new Cn,this.o=!t||void 0===t.backgroundChannelTest||t.backgroundChannelTest,(this.W=t&&t.fastHandshake||!1)&&!this.o&&(this.o=!0),t&&t.forceLongPolling&&(this.oa=!1),this.fa=void 0}function Qn(t){var e,n;Kn(t),3==t.u&&(e=t.P++,We(n=Be(t.B),"SID",t.H),We(n,"RID",e),We(n,"TYPE","terminate"),zn(t,n),(e=new be(t,e,void 0)).F=2,e.f=ze(Be(n)),n=!1,!(n=v.navigator&&v.navigator.sendBeacon?v.navigator.sendBeacon(e.f.toString(),""):n)&&v.Image&&((new Image).src=e.f,n=!0),n||(e.a=e.g.$(null),e.a.ca(e.f)),e.v=O(),Ne(e)),er(t)}function Kn(t){t.w&&(t.w.abort(),t.w=null),t.a&&(t.a.cancel(),t.a=null),t.l&&(v.clearTimeout(t.l),t.l=null),$n(t),t.b.cancel(),t.h&&(w(t.h)&&v.clearTimeout(t.h),t.h=null)}function jn(t,e){t.f.push(new mn(t.Ra++,e)),3==t.u&&Wn(t)}function Wn(t){vn(t.b)||t.h||(t.h=!0,Kt(t.Ia,t),t.A=0)}function Gn(t,e){var n=e?e.W:t.P++,r=Be(t.B);We(r,"SID",t.H),We(r,"RID",n),We(r,"AID",t.O),zn(t,r),t.g&&t.i&&Bn(r,t.g,t.i),n=new be(t,n,t.A+1),null===t.g&&(n.h=t.i),e&&(t.f=e.j.concat(t.f)),e=Hn(t,n,1e3),n.setTimeout(Math.round(.5*t.qa)+Math.round(.5*t.qa*Math.random())),Sn(t.b,n),Te(n,r,e)}function zn(t,n){t.c&&Oe({},function(t,e){We(n,e,t)})}function Hn(t,e,n){n=Math.min(t.f.length,n);var r=t.c?M(t.c.Ta,t.c,t):null;t:for(var i=t.f,o=-1;;){var a=["count="+n];-1==o?0<n?(o=i[0].b,a.push("ofs="+o)):o=0:a.push("ofs="+o);for(var s=!0,u=0;u<n;u++){var c=i[u].b,h=i[u].a;if((c-=o)<0)o=Math.max(0,i[u].b-100),s=!1;else try{!function(t,r,e){var i=e||"";try{Oe(t,function(t,e){var n=t;D(t)&&(n=qt(t)),r.push(i+e+"="+encodeURIComponent(n))})}catch(t){throw r.push(i+"type="+encodeURIComponent("_badmap")),t}}(h,a,"req"+c+"_")}catch(t){r&&r(h)}}if(s){r=a.join("&");break t}}return t=t.f.splice(0,n),e.j=t,r}function Yn(t){t.a||t.l||(t.S=1,Kt(t.Ha,t),t.v=0)}function Xn(t){return!(t.a||t.l||3<=t.v)&&(t.S++,t.l=ce(M(t.Ha,t),Zn(t,t.v)),t.v++,1)}function Jn(t,e,n){var r=e.l;r&&gn(t.b,r),t.ia=t.oa&&n,t.m=e.c,t.B=nr(t,null,t.ha),Wn(t)}function $n(t){null!=t.s&&(v.clearTimeout(t.s),t.s=null)}function Zn(t,e){var n=t.Oa+Math.floor(Math.random()*t.Sa);return t.ma()||(n*=2),n*e}function tr(t,e){var n,r,i,o;2==e?(r=null,t.c&&(r=null),o=M(t.fb,t),r||(r=new Ve("//www.google.com/images/cleardot.gif"),v.location&&"http"==v.location.protocol||Ue(r,"https"),ze(r)),n=r.toString(),r=o,o=new ne,v.Image?((i=new Image).onload=_(Dn,o,i,"TestLoadImage: loaded",!0,r),i.onerror=_(Dn,o,i,"TestLoadImage: error",!1,r),i.onabort=_(Dn,o,i,"TestLoadImage: abort",!1,r),i.ontimeout=_(Dn,o,i,"TestLoadImage: timeout",!1,r),v.setTimeout(function(){i.ontimeout&&i.ontimeout()},1e4),i.src=n):r(!1)):se(),t.u=0,t.c&&t.c.ta(e),er(t),Kn(t)}function er(t){t.u=0,t.m=-1,t.c&&(0==Tn(t.b).length&&0==t.f.length||(t.b.c.length=0,V(t.f),t.f.length=0),t.c.sa())}function nr(t,e,n){var r,i,o,a,s,u=(o=n)instanceof Ve?Be(o):new Ve(o,void 0);return""!=u.b?(e&&Qe(u,e+"."+u.b),Ke(u,u.i)):(s=v.location,a=e?e+"."+s.hostname:s.hostname,r=s.protocol,i=a,o=+s.port,a=n,s=new Ve(null,void 0),r&&Ue(s,r),i&&Qe(s,i),o&&Ke(s,o),a&&(s.a=a),u=s),t.V&&G(t.V,function(t,e){We(u,e,t)}),e=t.j,n=t.I,e&&n&&We(u,e,n),We(u,"VER",t.wa),zn(t,u),u}function rr(){}function ir(){if(Z&&!(10<=Number(ht)))throw Error("Environmental error: no available transport.")}function or(t,e){Pt.call(this),this.a=new Un(e),this.g=t,this.m=e&&e.testUrl?e.testUrl:function(t){for(var e=t,n=1;n<arguments.length;n++){var r,i=arguments[n];0==i.lastIndexOf("/",0)?e=i:((r=""==e)||(r=0<=(r=e.length-1)&&e.indexOf("/",r)==r),e+=r?i:"/"+i)}return e}(this.g,"test"),this.b=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.a.i=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.xa&&(t?t["X-WebChannel-Client-Profile"]=e.xa:t={"X-WebChannel-Client-Profile":e.xa}),this.a.J=t,(t=e&&e.httpHeadersOverwriteParam)&&!B(t)&&(this.a.g=t),this.l=e&&e.supportsCrossDomainXhr||!1,this.h=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!B(e)&&(this.a.j=e,null!==(t=this.b)&&e in t&&e in(t=this.b)&&delete t[e]),this.f=new ur(this)}function ar(t){ye.call(this);var e=t.__sm__;if(e){t:{for(var n in e){t=n;break t}t=void 0}(this.c=t)?(t=this.c,this.data=null!==e&&t in e?e[t]:void 0):this.data=e}else this.data=t}function sr(){ge.call(this),this.status=1}function ur(t){this.a=t}(Zi=An.prototype).ca=function(t,e,n,r){if(this.a)throw Error("[goog.net.XhrIo] Object is active with another request="+this.A+"; newUri="+t);e=e?e.toUpperCase():"GET",this.A=t,this.f="",this.h=0,this.v=!1,this.b=!0,this.a=new XMLHttpRequest,this.s=this.H?pe(this.H):pe(we),this.a.onreadystatechange=M(this.Fa,this);try{this.w=!0,this.a.open(e,String(t),!0),this.w=!1}catch(t){return void On(this,t)}t=n||"";var i,o=new Le(this.headers);r&&Oe(r,function(t,e){o.set(e,t)}),r=function(t){t:{for(var e=_n,n=t.length,r=b(t)?t.split(""):t,i=0;i<n;i++)if(i in r&&e.call(void 0,r[i],i,t)){e=i;break t}e=-1}return e<0?null:b(t)?t.charAt(e):t[e]}(o.K()),n=v.FormData&&t instanceof v.FormData,0<=x(Mn,e)&&!r&&!n&&o.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),o.forEach(function(t,e){this.a.setRequestHeader(e,t)},this),this.I&&(this.a.responseType=this.I),"withCredentials"in this.a&&this.a.withCredentials!==this.F&&(this.a.withCredentials=this.F);try{qn(this),0<this.o&&((this.D=(i=this.a,Z&&ut(9)&&w(i.timeout)&&void 0!==i.ontimeout))?(this.a.timeout=this.o,this.a.ontimeout=M(this.Ca,this)):this.m=Yt(this.Ca,this.o,this)),this.l=!0,this.a.send(t),this.l=!1}catch(t){On(this,t)}},Zi.Ca=function(){this.a&&(this.f="Timed out after "+this.o+"ms, aborting",this.h=8,this.dispatchEvent("timeout"),this.abort(8))},Zi.abort=function(t){this.a&&this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1,this.h=t||7,this.dispatchEvent("complete"),this.dispatchEvent("abort"),xn(this))},Zi.G=function(){this.a&&(this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1),xn(this,!0)),An.N.G.call(this)},Zi.Fa=function(){this.j||(this.w||this.l||this.g?Pn(this):this.$a())},Zi.$a=function(){Pn(this)},Zi.T=function(){try{return 2<Fn(this)?this.a.status:-1}catch(t){return-1}},Zi.za=function(){try{return 2<Fn(this)?this.a.statusText:""}catch(t){return""}},Zi.aa=function(){try{return this.a?this.a.responseText:""}catch(t){return""}},Zi.Va=function(t){if(this.a){var e=this.a.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),Nn(e)}},Zi.ya=function(){return this.h},Zi.Ya=function(){return b(this.f)?this.f:String(this.f)},(Zi=Un.prototype).wa=8,Zi.u=1,Zi.Da=function(){return 0==this.u},Zi.Ia=function(t){if(this.h)if(this.h=null,1==this.u){if(!t){this.P=Math.floor(1e5*Math.random()),t=this.P++;var e,n=new be(this,t,void 0),r=this.i;if(this.J&&(r?Y(r=z(r),this.J):r=this.J),null===this.g&&(n.h=r),this.W)t:{for(var i=e=0;i<this.f.length;i++){var o=this.f[i];if(void 0===(o="__data__"in o.a&&b(o=o.a.__data__)?o.length:void 0))break;if(4096<(e+=o)){e=i;break t}if(4096===e||i===this.f.length-1){e=i+1;break t}}e=1e3}else e=1e3;e=Hn(this,n,e),We(i=Be(this.B),"RID",t),We(i,"CVER",22),this.o&&this.j&&We(i,"X-HTTP-Session-Id",this.j),zn(this,i),this.g&&r&&Bn(i,this.g,r),Sn(this.b,n),this.W?(We(i,"$req",e),We(i,"SID","null"),n.S=!0,Te(n,i,null)):Te(n,i,e),this.u=2}}else 3==this.u&&(t?Gn(this,t):0==this.f.length||vn(this.b)||Gn(this))},Zi.Ha=function(){this.l=null,this.a=new be(this,"rpc",this.S),null===this.g&&(this.a.h=this.i),this.a.J=0;var t=Be(this.pa);We(t,"RID","rpc"),We(t,"SID",this.H),We(t,"CI",this.ia?"0":"1"),We(t,"AID",this.O),zn(this,t),We(t,"TYPE","xmlhttp"),this.g&&this.i&&Bn(t,this.g,this.i),this.D&&this.a.setTimeout(this.D),Ie(this.a,t,!0,this.ga)},Zi.Ga=function(t,e){if(0!=this.u&&(this.a==t||wn(this.b,t)))if(this.m=t.o,!t.s&&wn(this.b,t)&&3==this.u){try{var n=this.ja.a.parse(e)}catch(t){n=null}if(I(n)&&3==n.length){if(0==(e=n)[0]){t:if(!this.l){if(this.a){if(!(this.a.v+3e3<t.v))break t;$n(this),this.a.cancel(),this.a=null}Xn(this),se()}}else this.ra=e[1],0<this.ra-this.O&&e[2]<37500&&this.ia&&0==this.v&&!this.s&&(this.s=ce(M(this.Za,this),6e3));if(bn(this.b)<=1&&this.fa){try{this.fa()}catch(t){}this.fa=void 0}}else tr(this,11)}else if(!t.s&&this.a!=t||$n(this),!B(e))for(e=n=this.ja.a.parse(e),n=0;n<e.length;n++){var r,i=e[n];this.O=i[0],i=i[1],2==this.u?"c"==i[0]?(this.H=i[1],this.ga=i[2],null!=(r=i[3])&&(this.wa=r),null!=(i=i[5])&&w(i)&&0<i&&(this.D=1.5*i),this.o&&(i=t.a)&&((r=Vn(i,"X-Client-Wire-Protocol"))&&gn(this.b,r),this.j&&(i=Vn(i,"X-HTTP-Session-Id")))&&(this.I=i,We(this.B,this.j,i)),this.u=3,this.c&&this.c.va(),i=t,this.pa=nr(this,this.Y()?this.ga:null,this.ha),i.s?(En(this.b,i),(r=this.D)&&i.setTimeout(r),i.i&&(ke(i),Ne(i)),this.a=i):Yn(this),0<this.f.length&&Wn(this)):"stop"!=i[0]&&"close"!=i[0]||tr(this,7):3==this.u&&("stop"==i[0]||"close"==i[0]?"stop"==i[0]?tr(this,7):Qn(this):"noop"!=i[0]&&this.c&&this.c.ua(i),this.v=0)}},Zi.Za=function(){null!=this.s&&(this.s=null,this.a.cancel(),this.a=null,Xn(this),se())},Zi.na=function(t){var e,n,r=null;if(this.a==t){$n(this),this.a=null;var i=2}else{if(!wn(this.b,t))return;r=t.j,En(this.b,t),i=1}if(this.m=t.o,0!=this.u)if(t.b)1==i?(r=O()-t.v,re.dispatchEvent(new ue(re,t.l&&t.l.length,this.A)),Wn(this)):Yn(this);else{var o=t.c;if(3==o||0==o&&0<this.m||(1!=i||(n=t,bn((e=this).b)>=e.b.f-(e.h?1:0)||(e.h?(e.f=n.j.concat(e.f),0):1==e.u||2==e.u||e.A>=(e.Pa?0:e.Qa)||(e.h=ce(M(e.Ia,e,n),Zn(e,e.A)),e.A++,0))))&&(2!=i||!Xn(this)))switch(r&&0<r.length&&(t=this.b,t.c=t.c.concat(r)),o){case 1:tr(this,5);break;case 4:tr(this,10);break;case 3:tr(this,6);break;default:tr(this,2)}}},Zi.fb=function(t){se()},Zi.$=function(t){if(t&&!this.R)throw Error("Can't create secondary domain capable XhrIo object.");return(t=new An(this.La)).F=this.R,t},Zi.ma=function(){return!!this.c&&!0},Zi.Y=function(){return this.R},(Zi=rr.prototype).va=function(){},Zi.ua=function(){},Zi.ta=function(){},Zi.sa=function(){},Zi.Ta=function(){},ir.prototype.a=function(t,e){return new or(t,e)},L(or,Pt),(Zi=or.prototype).addEventListener=function(t,e,n,r){or.N.addEventListener.call(this,t,e,n,r)},Zi.removeEventListener=function(t,e,n,r){or.N.removeEventListener.call(this,t,e,n,r)},Zi.Wa=function(){this.a.c=this.f,this.l&&(this.a.R=!0);var t=this.a,e=this.m,n=this.g,r=this.b||void 0;se(),t.ha=n,t.V=r||{},t.o&&(t.F.b=[],t.F.a=!1),t.w=new hn(t),null===t.g&&(t.w.h=t.i),n=e,t.g&&t.i&&(n=Bn(e,t.g,t.i)),(t=t.w).i=n,e=nr(t.a,null,t.i),se(),null!=(n=t.a.F.b)?(t.f=n[0],t.M=1,ln(t)):(Ge(e,"MODE","init"),!t.a.o&&t.a.j&&Ge(e,"X-HTTP-Session-Id",t.a.j),t.b=new be(t,void 0,void 0),t.b.h=t.h,Ie(t.b,e,!1,null),t.M=0)},Zi.close=function(){Qn(this.a)},Zi.Xa=function(t){var e;b(t)?((e={}).__data__=t,jn(this.a,e)):this.h?((e={}).__data__=qt(t),jn(this.a,e)):jn(this.a,t)},Zi.G=function(){this.a.c=null,delete this.f,Qn(this.a),delete this.a,or.N.G.call(this)},L(ar,ye),L(sr,ge),L(ur,rr),ur.prototype.va=function(){this.a.dispatchEvent("a")},ur.prototype.ua=function(t){this.a.dispatchEvent(new ar(t))},ur.prototype.ta=function(t){this.a.dispatchEvent(new sr)},ur.prototype.sa=function(){this.a.dispatchEvent("b")};var cr=_(function(t,e){function n(){}n.prototype=t.prototype;var r=new n;return t.apply(r,Array.prototype.slice.call(arguments,1)),r},ir);ir.prototype.createWebChannel=ir.prototype.a,or.prototype.send=or.prototype.Xa,or.prototype.open=or.prototype.Wa,he.NO_ERROR=0,he.TIMEOUT=8,he.HTTP_ERROR=6,le.COMPLETE="complete",(de.EventType=me).OPEN="a",me.CLOSE="b",me.ERROR="c",me.MESSAGE="d",Pt.prototype.listen=Pt.prototype.Aa,An.prototype.listenOnce=An.prototype.Ba,An.prototype.getLastError=An.prototype.Ya,An.prototype.getLastErrorCode=An.prototype.ya,An.prototype.getStatus=An.prototype.T,An.prototype.getStatusText=An.prototype.za,An.prototype.getResponseJson=An.prototype.Va,An.prototype.getResponseText=An.prototype.aa,An.prototype.send=An.prototype.ca;var hr,lr={createWebChannelTransport:cr,ErrorCode:he,EventType:le,WebChannel:de,XhrIo:An},fr=lr.createWebChannelTransport,pr=lr.ErrorCode,dr=lr.EventType,mr=lr.WebChannel,yr=lr.XhrIo,gr=qp.SDK_VERSION,vr=new t("@firebase/firestore");function br(){return vr.logLevel===o.DEBUG?hr.DEBUG:vr.logLevel===o.SILENT?hr.SILENT:hr.ERROR}function wr(t){switch(t){case hr.DEBUG:vr.logLevel=o.DEBUG;break;case hr.ERROR:vr.logLevel=o.ERROR;break;case hr.SILENT:vr.logLevel=o.SILENT;break;default:vr.error("Firestore ("+gr+"): Invalid value passed to `setLogLevel`")}}function Sr(t,e){for(var n,r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];vr.logLevel<=o.DEBUG&&(n=r.map(Tr),vr.debug.apply(vr,["Firestore ("+gr+") ["+t+"]: "+e].concat(n)))}function Er(t){for(var e,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];vr.logLevel<=o.ERROR&&(e=n.map(Tr),vr.error.apply(vr,["Firestore ("+gr+"): "+t].concat(e)))}function Tr(t){if("string"==typeof t)return t;var e=Dr.getPlatform();try{return e.formatJSON(t)}catch(e){return t}}function Ir(t){t="FIRESTORE ("+gr+") INTERNAL ASSERTION FAILED: "+t;throw Er(t),new Error(t)}function Cr(t,e){t||Ir(e)}(vs=hr={})[vs.DEBUG=0]="DEBUG",vs[vs.ERROR=1]="ERROR",vs[vs.SILENT=2]="SILENT";var Dr=(Nr.setPlatform=function(t){Nr.platform&&Ir("Platform already defined"),Nr.platform=t},Nr.getPlatform=function(){return Nr.platform||Ir("Platform not set"),Nr.platform},Nr);function Nr(){}function Ar(){return Dr.getPlatform().emptyByteString}var kr,Rr={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},Mr=(a(_r,kr=Error),_r);function _r(t,e){var n=kr.call(this,e)||this;return n.code=t,n.message=e,n.name="FirebaseError",n.toString=function(){return n.name+": [code="+n.code+"]: "+n.message},n}function Or(t,e){function n(){var t="This constructor is private.";throw e&&(t+=" ",t+=e),new Mr(Rr.INVALID_ARGUMENT,t)}for(var r in n.prototype=t.prototype,t)t.hasOwnProperty(r)&&(n[r]=t[r]);return n}function Lr(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function Pr(t,e){return void 0!==t?t:e}function xr(t,e){for(var n in t){var r;Object.prototype.hasOwnProperty.call(t,n)&&(r=Number(n),isNaN(r)||e(r,t[n]))}}function qr(t,e){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function Fr(t){for(var e in Cr(null!=t&&"object"==typeof t,"isEmpty() expects object parameter."),t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}function Vr(t,e){if(0!==e.length)throw new Mr(Rr.INVALID_ARGUMENT,"Function "+t+"() does not support arguments, but was called with "+ni(e.length,"argument")+".")}function Br(t,e,n){if(e.length!==n)throw new Mr(Rr.INVALID_ARGUMENT,"Function "+t+"() requires "+ni(n,"argument")+", but was called with "+ni(e.length,"argument")+".")}function Ur(t,e,n){if(e.length<n)throw new Mr(Rr.INVALID_ARGUMENT,"Function "+t+"() requires at least "+ni(n,"argument")+", but was called with "+ni(e.length,"argument")+".")}function Qr(t,e,n,r){if(e.length<n||e.length>r)throw new Mr(Rr.INVALID_ARGUMENT,"Function "+t+"() requires between "+n+" and "+r+" arguments, but was called with "+ni(e.length,"argument")+".")}function Kr(t,e,n,r){Yr(t,e,ei(n)+" argument",r)}function jr(t,e,n,r){void 0!==r&&Kr(t,e,n,r)}function Wr(t,e,n,r){Yr(t,e,n+" option",r)}function Gr(t,e,n,r){void 0!==r&&Wr(t,e,n,r)}function zr(t,e,n,r,i){void 0!==r&&function(t,e,n,r,i){if(!(r instanceof Array))throw new Mr(Rr.INVALID_ARGUMENT,"Function "+t+"() requires its "+e+" option to be an array, but it was: "+Jr(r));for(var o=0;o<r.length;++o)if(!i(r[o]))throw new Mr(Rr.INVALID_ARGUMENT,"Function "+t+"() requires all "+e+" elements to be "+n+", but the value at index "+o+" was: "+Jr(r[o]))}(t,e,n,r,i)}function Hr(t,e,n,r,u){void 0!==r&&function(t,e,n){for(var r=[],i=0,o=u;i<o.length;i++){var a=o[i];if(a===n)return;r.push(Jr(a))}var s=Jr(n);throw new Mr(Rr.INVALID_ARGUMENT,"Invalid value "+s+" provided to function "+t+'() for option "'+e+'". Acceptable values: '+r.join(", "))}(t,n,r)}function Yr(t,e,n,r){if(!("object"===e?Xr(r):"non-empty string"===e?"string"==typeof r&&""!==r:typeof r===e)){r=Jr(r);throw new Mr(Rr.INVALID_ARGUMENT,"Function "+t+"() requires its "+n+" to be of type "+e+", but it was: "+r)}}function Xr(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}function Jr(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return 20<t.length&&(t=t.substring(0,20)+"..."),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"!=typeof t)return"function"==typeof t?"a function":Ir("Unknown wrong type: "+typeof t);if(t instanceof Array)return"an array";t=function(t){if(t.constructor){t=/function\s+([^\s(]+)\s*\(/.exec(t.constructor.toString());if(t&&1<t.length)return t[1]}return null}(t);return t?"a custom "+t+" object":"an object"}function $r(t,e,n){if(void 0===n)throw new Mr(Rr.INVALID_ARGUMENT,"Function "+t+"() requires a valid "+ei(e)+" argument, but it was undefined.")}function Zr(n,t,r){qr(t,function(t,e){if(r.indexOf(t)<0)throw new Mr(Rr.INVALID_ARGUMENT,"Unknown option '"+t+"' passed to function "+n+"(). Available options: "+r.join(", "))})}function ti(t,e,n,r){r=Jr(r);return new Mr(Rr.INVALID_ARGUMENT,"Function "+t+"() requires its "+ei(n)+" argument to be a "+e+", but it was: "+r)}function ei(t){switch(t){case 1:return"first";case 2:return"second";case 3:return"third";default:return t+"th"}}function ni(t,e){return t+" "+e+(1===t?"":"s")}var ri=(ii.newId=function(){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="",n=0;n<20;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return Cr(20===e.length,"Invalid auto ID: "+e),e},ii);function ii(){}function oi(t,e){return t<e?-1:e<t?1:0}function ai(t,e){if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(!t[n].isEqual(e[n]))return!1;return!0}function si(t){return t+"\0"}function ui(){if("undefined"==typeof Uint8Array)throw new Mr(Rr.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}function ci(){if(!Dr.getPlatform().base64Available)throw new Mr(Rr.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}var hi=(li.fromBase64String=function(t){Br("Blob.fromBase64String",arguments,1),Kr("Blob.fromBase64String","string",1,t),ci();try{return new li(Dr.getPlatform().atob(t))}catch(t){throw new Mr(Rr.INVALID_ARGUMENT,"Failed to construct Blob from Base64 string: "+t)}},li.fromUint8Array=function(t){if(Br("Blob.fromUint8Array",arguments,1),ui(),!(t instanceof Uint8Array))throw ti("Blob.fromUint8Array","Uint8Array",1,t);return new li(Array.prototype.map.call(t,function(t){return String.fromCharCode(t)}).join(""))},li.prototype.toBase64=function(){return Br("Blob.toBase64",arguments,0),ci(),Dr.getPlatform().btoa(this._binaryString)},li.prototype.toUint8Array=function(){Br("Blob.toUint8Array",arguments,0),ui();for(var t=new Uint8Array(this._binaryString.length),e=0;e<this._binaryString.length;e++)t[e]=this._binaryString.charCodeAt(e);return t},li.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},li.prototype.isEqual=function(t){return this._binaryString===t._binaryString},li.prototype._compareTo=function(t){return oi(this._binaryString,t._binaryString)},li);function li(t){ci(),this._binaryString=t}function fi(t,e,n,r,i){this.databaseId=t,this.persistenceKey=e,this.host=n,this.ssl=r,this.forceLongPolling=i}var pi=Or(hi,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead."),di="(default)",mi=(Object.defineProperty(yi.prototype,"isDefaultDatabase",{get:function(){return this.database===di},enumerable:!0,configurable:!0}),yi.prototype.isEqual=function(t){return t instanceof yi&&t.projectId===this.projectId&&t.database===this.database},yi.prototype.compareTo=function(t){return oi(this.projectId,t.projectId)||oi(this.database,t.database)},yi);function yi(t,e){this.projectId=t,this.database=e||di}var gi=(vi.prototype.setPreviousValue=function(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue},vi.prototype.next=function(){var t=++this.previousValue;return this.writeNewSequenceNumber&&this.writeNewSequenceNumber(t),t},vi.INVALID=-1,vi);function vi(t,e){var n=this;this.previousValue=t,e&&(e.sequenceNumberHandler=function(t){return n.setPreviousValue(t)},this.writeNewSequenceNumber=function(t){return e.writeSequenceNumber(t)})}var bi="__name__",g=(Object.defineProperty(wi.prototype,"length",{get:function(){return this.len},enumerable:!0,configurable:!0}),wi.prototype.isEqual=function(t){return 0===wi.comparator(this,t)},wi.prototype.child=function(t){var e=this.segments.slice(this.offset,this.limit());return t instanceof wi?t.forEach(function(t){e.push(t)}):e.push(t),this.construct(e)},wi.prototype.limit=function(){return this.offset+this.length},wi.prototype.popFirst=function(t){return Cr(this.length>=(t=void 0===t?1:t),"Can't call popFirst() with less segments"),this.construct(this.segments,this.offset+t,this.length-t)},wi.prototype.popLast=function(){return Cr(!this.isEmpty(),"Can't call popLast() on empty path"),this.construct(this.segments,this.offset,this.length-1)},wi.prototype.firstSegment=function(){return Cr(!this.isEmpty(),"Can't call firstSegment() on empty path"),this.segments[this.offset]},wi.prototype.lastSegment=function(){return this.get(this.length-1)},wi.prototype.get=function(t){return Cr(t<this.length,"Index out of range"),this.segments[this.offset+t]},wi.prototype.isEmpty=function(){return 0===this.length},wi.prototype.isPrefixOf=function(t){if(t.length<this.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},wi.prototype.isImmediateParentOf=function(t){if(this.length+1!==t.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},wi.prototype.forEach=function(t){for(var e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])},wi.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())},wi.comparator=function(t,e){for(var n=Math.min(t.length,e.length),r=0;r<n;r++){var i=t.get(r),o=e.get(r);if(i<o)return-1;if(o<i)return 1}return t.length<e.length?-1:t.length>e.length?1:0},wi);function wi(t,e,n){void 0===e?e=0:e>t.length&&Ir("offset "+e+" out of range "+t.length),void 0===n?n=t.length-e:n>t.length-e&&Ir("length "+n+" out of range "+(t.length-e)),this.segments=t,this.offset=e,this.len=n}var Si,Ei=(a(Ti,Si=g),Ti.prototype.construct=function(t,e,n){return new Ti(t,e,n)},Ti.prototype.canonicalString=function(){return this.toArray().join("/")},Ti.prototype.toString=function(){return this.canonicalString()},Ti.fromString=function(t){if(0<=t.indexOf("//"))throw new Mr(Rr.INVALID_ARGUMENT,"Invalid path ("+t+"). Paths must not contain // in them.");return new Ti(t.split("/").filter(function(t){return 0<t.length}))},Ti.EMPTY_PATH=new Ti([]),Ti);function Ti(){return null!==Si&&Si.apply(this,arguments)||this}var Ii,Ci=/^[_a-zA-Z][_a-zA-Z0-9]*$/,Di=(a(Ni,Ii=g),Ni.prototype.construct=function(t,e,n){return new Ni(t,e,n)},Ni.isValidIdentifier=function(t){return Ci.test(t)},Ni.prototype.canonicalString=function(){return this.toArray().map(function(t){return t=t.replace("\\","\\\\").replace("`","\\`"),t=!Ni.isValidIdentifier(t)?"`"+t+"`":t}).join(".")},Ni.prototype.toString=function(){return this.canonicalString()},Ni.prototype.isKeyField=function(){return 1===this.length&&this.get(0)===bi},Ni.keyField=function(){return new Ni([bi])},Ni.fromServerFormat=function(t){for(var e=[],n="",r=0,i=function(){if(0===n.length)throw new Mr(Rr.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");e.push(n),n=""},o=!1;r<t.length;){var a=t[r];if("\\"===a){if(r+1===t.length)throw new Mr(Rr.INVALID_ARGUMENT,"Path has trailing escape character: "+t);var s=t[r+1];if("\\"!==s&&"."!==s&&"`"!==s)throw new Mr(Rr.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=s,r+=2}else"`"===a?o=!o:"."!==a||o?n+=a:i(),r++}if(i(),o)throw new Mr(Rr.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new Ni(e)},Ni.EMPTY_PATH=new Ni([]),Ni);function Ni(){return null!==Ii&&Ii.apply(this,arguments)||this}var Ai=(ki.prototype.hasCollectionId=function(t){return 2<=this.path.length&&this.path.get(this.path.length-2)===t},ki.prototype.isEqual=function(t){return null!==t&&0===Ei.comparator(this.path,t.path)},ki.prototype.toString=function(){return this.path.toString()},ki.comparator=function(t,e){return Ei.comparator(t.path,e.path)},ki.isDocumentKey=function(t){return t.length%2==0},ki.fromSegments=function(t){return new ki(new Ei(t.slice()))},ki.fromPathString=function(t){return new ki(Ei.fromString(t))},ki.EMPTY=new ki(new Ei([])),ki);function ki(t){this.path=t,Cr(ki.isDocumentKey(t),"Invalid DocumentKey with an odd number of segments: "+t.toArray().join("/"))}function Ri(){var n=this;this.promise=new Promise(function(t,e){n.resolve=t,n.reject=e})}var Mi;(ct=Mi={}).All="all",ct.ListenStreamIdle="listen_stream_idle",ct.ListenStreamConnectionBackoff="listen_stream_connection_backoff",ct.WriteStreamIdle="write_stream_idle",ct.WriteStreamConnectionBackoff="write_stream_connection_backoff",ct.OnlineStateTimeout="online_state_timeout",ct.ClientMetadataRefresh="client_metadata_refresh",ct.LruGarbageCollection="lru_garbage_collection",ct.RetryTransaction="retry_transaction";var _i=(Oi.createAndSchedule=function(t,e,n,r,i){i=new Oi(t,e,Date.now()+n,r,i);return i.start(n),i},Oi.prototype.start=function(t){var e=this;this.timerHandle=setTimeout(function(){return e.handleDelayElapsed()},t)},Oi.prototype.skipDelay=function(){return this.handleDelayElapsed()},Oi.prototype.cancel=function(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Mr(Rr.CANCELLED,"Operation cancelled"+(t?": "+t:""))))},Oi.prototype.handleDelayElapsed=function(){var e=this;this.asyncQueue.enqueueAndForget(function(){return null!==e.timerHandle?(e.clearTimeout(),e.op().then(function(t){return e.deferred.resolve(t)})):Promise.resolve()})},Oi.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)},Oi);function Oi(t,e,n,r,i){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new Ri,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.catch=this.deferred.promise.catch.bind(this.deferred.promise),this.deferred.promise.catch(function(t){})}var Li=(Object.defineProperty(Pi.prototype,"isShuttingDown",{get:function(){return this._isShuttingDown},enumerable:!0,configurable:!0}),Pi.prototype.enqueueAndForget=function(t){this.enqueue(t)},Pi.prototype.enqueueAndForgetEvenAfterShutdown=function(t){this.verifyNotFailed(),this.enqueueInternal(t)},Pi.prototype.enqueueEvenAfterShutdown=function(t){return this.verifyNotFailed(),this.enqueueInternal(t)},Pi.prototype.enqueueAndInitiateShutdown=function(e){return p(this,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return this.verifyNotFailed(),this._isShuttingDown?[3,2]:(this._isShuttingDown=!0,[4,this.enqueueEvenAfterShutdown(e)]);case 1:t.sent(),t.label=2;case 2:return[2]}})})},Pi.prototype.enqueue=function(t){return this.verifyNotFailed(),this._isShuttingDown?new Promise(function(t){}):this.enqueueInternal(t)},Pi.prototype.enqueueInternal=function(t){var n=this,e=this.tail.then(function(){return n.operationInProgress=!0,t().catch(function(t){n.failure=t,n.operationInProgress=!1;var e=t.stack||t.message||"";throw Er("INTERNAL UNHANDLED ERROR: ",e),e.indexOf("Firestore Test Simulated Error")<0&&setTimeout(function(){throw t},0),t}).then(function(t){return n.operationInProgress=!1,t})});return this.tail=e},Pi.prototype.enqueueAfterDelay=function(t,e,n){var r=this;this.verifyNotFailed(),Cr(0<=e,"Attempted to schedule an operation with a negative delay of "+e),-1<this.timerIdsToSkip.indexOf(t)&&(e=0);n=_i.createAndSchedule(this,t,e,n,function(t){return r.removeDelayedOperation(t)});return this.delayedOperations.push(n),n},Pi.prototype.verifyNotFailed=function(){this.failure&&Ir("AsyncQueue is already failed: "+(this.failure.stack||this.failure.message))},Pi.prototype.verifyOperationInProgress=function(){Cr(this.operationInProgress,"verifyOpInProgress() called when no op in progress on this queue.")},Pi.prototype.drain=function(){return this.enqueueEvenAfterShutdown(function(){return Promise.resolve()})},Pi.prototype.containsDelayedOperation=function(t){for(var e=0,n=this.delayedOperations;e<n.length;e++)if(n[e].timerId===t)return!0;return!1},Pi.prototype.runDelayedOperationsEarly=function(r){var i=this;return this.drain().then(function(){Cr(r===Mi.All||i.containsDelayedOperation(r),"Attempted to drain to missing operation "+r),i.delayedOperations.sort(function(t,e){return t.targetTimeMs-e.targetTimeMs});for(var t=0,e=i.delayedOperations;t<e.length;t++){var n=e[t];if(n.skipDelay(),r!==Mi.All&&n.timerId===r)break}return i.drain()})},Pi.prototype.skipDelaysForTimerId=function(t){this.timerIdsToSkip.push(t)},Pi.prototype.removeDelayedOperation=function(t){t=this.delayedOperations.indexOf(t);Cr(0<=t,"Delayed operation not found."),this.delayedOperations.splice(t,1)},Pi);function Pi(){this.tail=Promise.resolve(),this._isShuttingDown=!1,this.delayedOperations=[],this.failure=null,this.operationInProgress=!1,this.timerIdsToSkip=[]}var xi="",qi="",Fi="",Vi="";function Bi(t){for(var e="",n=0;n<t.length;n++)0<e.length&&(e=Ui(e)),e=function(t,e){for(var n=e,r=t.length,i=0;i<r;i++){var o=t.charAt(i);switch(o){case"\0":n+=xi+Fi;break;case xi:n+=xi+Vi;break;default:n+=o}}return n}(t.get(n),e);return Ui(e)}function Ui(t){return t+xi+qi}function Qi(t){var e=t.length;if(Cr(2<=e,"Invalid path "+t),2===e)return Cr(t.charAt(0)===xi&&t.charAt(1)===qi,"Non-empty path "+t+" had length 2"),Ei.EMPTY_PATH;for(var n=e-2,r=[],i="",o=0;o<e;){var a=t.indexOf(xi,o);switch((a<0||n<a)&&Ir('Invalid encoded resource path: "'+t+'"'),t.charAt(a+1)){case qi:var s=t.substring(o,a),u=void 0;0===i.length?u=s:(u=i+=s,i=""),r.push(u);break;case Fi:i+=t.substring(o,a),i+="\0";break;case Vi:i+=t.substring(o,a+1);break;default:Ir('Invalid encoded resource path: "'+t+'"')}o=a+2}return new Ei(r)}var Ki=(ji.now=function(){return ji.fromMillis(Date.now())},ji.fromDate=function(t){return ji.fromMillis(t.getTime())},ji.fromMillis=function(t){var e=Math.floor(t/1e3);return new ji(e,1e6*(t-1e3*e))},ji.prototype.toDate=function(){return new Date(this.toMillis())},ji.prototype.toMillis=function(){return 1e3*this.seconds+this.nanoseconds/1e6},ji.prototype._compareTo=function(t){return this.seconds===t.seconds?oi(this.nanoseconds,t.nanoseconds):oi(this.seconds,t.seconds)},ji.prototype.isEqual=function(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds},ji.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"},ji);function ji(t,e){if(this.seconds=t,(this.nanoseconds=e)<0)throw new Mr(Rr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(1e9<=e)throw new Mr(Rr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new Mr(Rr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(253402300800<=t)throw new Mr(Rr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}var Wi=(Gi.fromMicroseconds=function(t){var e=Math.floor(t/1e6);return new Gi(new Ki(e,t%1e6*1e3))},Gi.fromTimestamp=function(t){return new Gi(t)},Gi.forDeletedDoc=function(){return Gi.MIN},Gi.prototype.compareTo=function(t){return this.timestamp._compareTo(t.timestamp)},Gi.prototype.isEqual=function(t){return this.timestamp.isEqual(t.timestamp)},Gi.prototype.toMicroseconds=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3},Gi.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},Gi.prototype.toTimestamp=function(){return this.timestamp},Gi.MIN=new Gi(new Ki(0,0)),Gi);function Gi(t){this.timestamp=t}var zi=(Hi.prototype.insert=function(t,e){return new Hi(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,Ji.BLACK,null,null))},Hi.prototype.remove=function(t){return new Hi(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Ji.BLACK,null,null))},Hi.prototype.get=function(t){for(var e=this.root;!e.isEmpty();){var n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:0<n&&(e=e.right)}return null},Hi.prototype.indexOf=function(t){for(var e=0,n=this.root;!n.isEmpty();){var r=this.comparator(t,n.key);if(0===r)return e+n.left.size;n=r<0?n.left:(e+=n.left.size+1,n.right)}return-1},Hi.prototype.isEmpty=function(){return this.root.isEmpty()},Object.defineProperty(Hi.prototype,"size",{get:function(){return this.root.size},enumerable:!0,configurable:!0}),Hi.prototype.minKey=function(){return this.root.minKey()},Hi.prototype.maxKey=function(){return this.root.maxKey()},Hi.prototype.inorderTraversal=function(t){return this.root.inorderTraversal(t)},Hi.prototype.forEach=function(n){this.inorderTraversal(function(t,e){return n(t,e),!1})},Hi.prototype.toString=function(){var n=[];return this.inorderTraversal(function(t,e){return n.push(t+":"+e),!1}),"{"+n.join(", ")+"}"},Hi.prototype.reverseTraversal=function(t){return this.root.reverseTraversal(t)},Hi.prototype.getIterator=function(){return new Yi(this.root,null,this.comparator,!1)},Hi.prototype.getIteratorFrom=function(t){return new Yi(this.root,t,this.comparator,!1)},Hi.prototype.getReverseIterator=function(){return new Yi(this.root,null,this.comparator,!0)},Hi.prototype.getReverseIteratorFrom=function(t){return new Yi(this.root,t,this.comparator,!0)},Hi);function Hi(t,e){this.comparator=t,this.root=e||Ji.EMPTY}var Yi=(Xi.prototype.getNext=function(){Cr(0<this.nodeStack.length,"getNext() called on iterator when hasNext() is false.");var t=this.nodeStack.pop(),e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e},Xi.prototype.hasNext=function(){return 0<this.nodeStack.length},Xi.prototype.peek=function(){if(0===this.nodeStack.length)return null;var t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}},Xi);function Xi(t,e,n,r){this.isReverse=r,this.nodeStack=[];for(var i=1;!t.isEmpty();)if(i=e?n(t.key,e):1,r&&(i*=-1),i<0)t=this.isReverse?t.left:t.right;else{if(0===i){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}var Ji=($i.prototype.copy=function(t,e,n,r,i){return new $i(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)},$i.prototype.isEmpty=function(){return!1},$i.prototype.inorderTraversal=function(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)},$i.prototype.reverseTraversal=function(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)},$i.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()},$i.prototype.minKey=function(){return this.min().key},$i.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},$i.prototype.insert=function(t,e,n){var r=this,i=n(t,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===i?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n))).fixUp()},$i.prototype.removeMin=function(){if(this.left.isEmpty())return $i.EMPTY;var t=this;return(t=(t=!t.left.isRed()&&!t.left.left.isRed()?t.moveRedLeft():t).copy(null,null,null,t.left.removeMin(),null)).fixUp()},$i.prototype.remove=function(t,e){var n,r=this;if(e(t,r.key)<0)r=(r=!(r.left.isEmpty()||r.left.isRed()||r.left.left.isRed())?r.moveRedLeft():r).copy(null,null,null,r.left.remove(t,e),null);else{if(0===e(t,(r=!((r=r.left.isRed()?r.rotateRight():r).right.isEmpty()||r.right.isRed()||r.right.left.isRed())?r.moveRedRight():r).key)){if(r.right.isEmpty())return $i.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp()},$i.prototype.isRed=function(){return this.color},$i.prototype.fixUp=function(){var t=this;return t=(t=(t=t.right.isRed()&&!t.left.isRed()?t.rotateLeft():t).left.isRed()&&t.left.left.isRed()?t.rotateRight():t).left.isRed()&&t.right.isRed()?t.colorFlip():t},$i.prototype.moveRedLeft=function(){var t=this.colorFlip();return t=t.right.left.isRed()?(t=(t=t.copy(null,null,null,null,t.right.rotateRight())).rotateLeft()).colorFlip():t},$i.prototype.moveRedRight=function(){var t=this.colorFlip();return t=t.left.left.isRed()?(t=t.rotateRight()).colorFlip():t},$i.prototype.rotateLeft=function(){var t=this.copy(null,null,$i.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)},$i.prototype.rotateRight=function(){var t=this.copy(null,null,$i.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)},$i.prototype.colorFlip=function(){var t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)},$i.prototype.checkMaxDepth=function(){var t=this.check();return Math.pow(2,t)<=this.size+1},$i.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw Ir("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed())throw Ir("Right child of ("+this.key+","+this.value+") is red");var t=this.left.check();if(t!==this.right.check())throw Ir("Black depths differ");return t+(this.isRed()?0:1)},$i.EMPTY=null,$i.RED=!0,$i.BLACK=!1,$i);function $i(t,e,n,r,i){this.key=t,this.value=e,this.color=null!=n?n:$i.RED,this.left=null!=r?r:$i.EMPTY,this.right=null!=i?i:$i.EMPTY,this.size=this.left.size+1+this.right.size}var Zi=(Object.defineProperty(to.prototype,"key",{get:function(){throw Ir("LLRBEmptyNode has no key.")},enumerable:!0,configurable:!0}),Object.defineProperty(to.prototype,"value",{get:function(){throw Ir("LLRBEmptyNode has no value.")},enumerable:!0,configurable:!0}),Object.defineProperty(to.prototype,"color",{get:function(){throw Ir("LLRBEmptyNode has no color.")},enumerable:!0,configurable:!0}),Object.defineProperty(to.prototype,"left",{get:function(){throw Ir("LLRBEmptyNode has no left child.")},enumerable:!0,configurable:!0}),Object.defineProperty(to.prototype,"right",{get:function(){throw Ir("LLRBEmptyNode has no right child.")},enumerable:!0,configurable:!0}),to.prototype.copy=function(t,e,n,r,i){return this},to.prototype.insert=function(t,e,n){return new Ji(t,e)},to.prototype.remove=function(t,e){return this},to.prototype.isEmpty=function(){return!0},to.prototype.inorderTraversal=function(t){return!1},to.prototype.reverseTraversal=function(t){return!1},to.prototype.minKey=function(){return null},to.prototype.maxKey=function(){return null},to.prototype.isRed=function(){return!1},to.prototype.checkMaxDepth=function(){return!0},to.prototype.check=function(){return 0},to);function to(){this.size=0}Ji.EMPTY=new Zi;var eo=(no.fromMapKeys=function(t){var e=new no(t.comparator);return t.forEach(function(t){e=e.add(t)}),e},no.prototype.has=function(t){return null!==this.data.get(t)},no.prototype.first=function(){return this.data.minKey()},no.prototype.last=function(){return this.data.maxKey()},Object.defineProperty(no.prototype,"size",{get:function(){return this.data.size},enumerable:!0,configurable:!0}),no.prototype.indexOf=function(t){return this.data.indexOf(t)},no.prototype.forEach=function(n){this.data.inorderTraversal(function(t,e){return n(t),!1})},no.prototype.forEachInRange=function(t,e){for(var n=this.data.getIteratorFrom(t[0]);n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,t[1]))return;e(r.key)}},no.prototype.forEachWhile=function(t,e){for(var n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return},no.prototype.firstAfterOrEqual=function(t){t=this.data.getIteratorFrom(t);return t.hasNext()?t.getNext().key:null},no.prototype.getIterator=function(){return new ro(this.data.getIterator())},no.prototype.getIteratorFrom=function(t){return new ro(this.data.getIteratorFrom(t))},no.prototype.add=function(t){return this.copy(this.data.remove(t).insert(t,!0))},no.prototype.delete=function(t){return this.has(t)?this.copy(this.data.remove(t)):this},no.prototype.isEmpty=function(){return this.data.isEmpty()},no.prototype.unionWith=function(t){var e=this;return t.forEach(function(t){e=e.add(t)}),e},no.prototype.isEqual=function(t){if(!(t instanceof no))return!1;if(this.size!==t.size)return!1;for(var e=this.data.getIterator(),n=t.data.getIterator();e.hasNext();){var r=e.getNext().key,i=n.getNext().key;if(0!==this.comparator(r,i))return!1}return!0},no.prototype.toArray=function(){var e=[];return this.forEach(function(t){e.push(t)}),e},no.prototype.toString=function(){var e=[];return this.forEach(function(t){return e.push(t)}),"SortedSet("+e.toString()+")"},no.prototype.copy=function(t){var e=new no(this.comparator);return e.data=t,e},no);function no(t){this.comparator=t,this.data=new zi(this.comparator)}var ro=(io.prototype.getNext=function(){return this.iter.getNext().key},io.prototype.hasNext=function(){return this.iter.hasNext()},io);function io(t){this.iter=t}var oo=new zi(Ai.comparator);var ao=new zi(Ai.comparator);var so=new zi(Ai.comparator);var uo=new eo(Ai.comparator);function co(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=uo,r=0,i=t;r<i.length;r++)var o=i[r],n=n.add(o);return n}var ho=new eo(oi);var lo=(fo.prototype.applyToRemoteDocument=function(t,e,n){e&&Cr(e.key.isEqual(t),"applyToRemoteDocument: key "+t+" should match maybeDoc key\n        "+e.key);var r=n.mutationResults;Cr(r.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+r.length+").");for(var i=0;i<this.mutations.length;i++){var o,a=this.mutations[i];a.key.isEqual(t)&&(o=r[i],e=a.applyToRemoteDocument(e,o))}return e},fo.prototype.applyToLocalView=function(t,e){e&&Cr(e.key.isEqual(t),"applyToLocalDocument: key "+t+" should match maybeDoc key\n        "+e.key);for(var n=0,r=this.baseMutations;n<r.length;n++)(i=r[n]).key.isEqual(t)&&(e=i.applyToLocalView(e,e,this.localWriteTime));for(var i,o=e,a=0,s=this.mutations;a<s.length;a++)(i=s[a]).key.isEqual(t)&&(e=i.applyToLocalView(e,o,this.localWriteTime));return e},fo.prototype.applyToLocalDocumentSet=function(n){var r=this,i=n;return this.mutations.forEach(function(t){var e=r.applyToLocalView(t.key,n.get(t.key));e&&(i=i.insert(t.key,e))}),i},fo.prototype.keys=function(){return this.mutations.reduce(function(t,e){return t.add(e.key)},co())},fo.prototype.isEqual=function(t){return this.batchId===t.batchId&&ai(this.mutations,t.mutations)&&ai(this.baseMutations,t.baseMutations)},fo);function fo(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,Cr(0<(this.mutations=r).length,"Cannot create an empty mutation batch")}var po=(mo.from=function(t,e,n,r){Cr(t.mutations.length===n.length,"Mutations sent "+t.mutations.length+" must equal results received "+n.length);for(var i=so,o=t.mutations,a=0;a<o.length;a++)i=i.insert(o[a].key,n[a].version);return new mo(t,e,n,r,i)},mo);function mo(t,e,n,r,i){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.streamToken=r,this.docVersions=i}var yo=(go.prototype.catch=function(t){return this.next(void 0,t)},go.prototype.next=function(r,i){var o=this;return this.callbackAttached&&Ir("Called next() or catch() twice for PersistencePromise"),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(i,this.error):this.wrapSuccess(r,this.result):new go(function(e,n){o.nextCallback=function(t){o.wrapSuccess(r,t).next(e,n)},o.catchCallback=function(t){o.wrapFailure(i,t).next(e,n)}})},go.prototype.toPromise=function(){var n=this;return new Promise(function(t,e){n.next(t,e)})},go.prototype.wrapUserFunction=function(t){try{var e=t();return e instanceof go?e:go.resolve(e)}catch(t){return go.reject(t)}},go.prototype.wrapSuccess=function(t,e){return t?this.wrapUserFunction(function(){return t(e)}):go.resolve(e)},go.prototype.wrapFailure=function(t,e){return t?this.wrapUserFunction(function(){return t(e)}):go.reject(e)},go.resolve=function(n){return new go(function(t,e){t(n)})},go.reject=function(n){return new go(function(t,e){e(n)})},go.waitFor=function(t){return new go(function(e,n){var r=0,i=0,o=!1;t.forEach(function(t){++r,t.next(function(){++i,o&&i===r&&e()},function(t){return n(t)})}),o=!0,i===r&&e()})},go.or=function(t){for(var n=go.resolve(!1),e=0,r=t;e<r.length;e++)!function(e){n=n.next(function(t){return t?go.resolve(t):e()})}(r[e]);return n},go.forEach=function(t,n){var r=this,i=[];return t.forEach(function(t,e){i.push(n.call(r,t,e))}),this.waitFor(i)},go);function go(t){var e=this;this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(function(t){e.isDone=!0,e.result=t,e.nextCallback&&e.nextCallback(t)},function(t){e.isDone=!0,e.error=t,e.catchCallback&&e.catchCallback(t)})}var vo,bo=(wo.forUser=function(t,e,n,r){return Cr(""!==t.uid,"UserID must not be an empty string."),new wo(t.isAuthenticated()?t.uid:"",e,n,r)},wo.prototype.checkEmpty=function(t){var r=!0,e=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Io(t).iterate({index:Qs.userMutationsIndex,range:e},function(t,e,n){r=!1,n.done()}).next(function(){return r})},wo.prototype.acknowledgeBatch=function(e,t,n){return this.getMutationQueueMetadata(e).next(function(t){return t.lastStreamToken=To(n),Do(e).put(t)})},wo.prototype.getLastStreamToken=function(t){return this.getMutationQueueMetadata(t).next(function(t){return t.lastStreamToken})},wo.prototype.setLastStreamToken=function(e,n){return this.getMutationQueueMetadata(e).next(function(t){return t.lastStreamToken=To(n),Do(e).put(t)})},wo.prototype.addMutationBatch=function(u,c,h,l){var f=this,p=Co(u),d=Io(u);return d.add({}).next(function(t){Cr("number"==typeof t,"Auto-generated key is not a number");var e=new lo(t,c,h,l),n=f.serializer.toDbMutationBatch(f.userId,e);f.documentKeysByBatchId[t]=e.keys();for(var r=[],i=0,o=l;i<o.length;i++){var a=o[i],s=js.key(f.userId,a.key.path,t);r.push(d.put(n)),r.push(p.put(s,js.PLACEHOLDER)),r.push(f.indexManager.addToCollectionParentIndex(u,a.key.path.popLast()))}return yo.waitFor(r).next(function(){return e})})},wo.prototype.lookupMutationBatch=function(t,e){var n=this;return Io(t).get(e).next(function(t){return t?(Cr(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),n.serializer.fromDbMutationBatch(t)):null})},wo.prototype.lookupMutationKeys=function(t,e){var n=this;return this.documentKeysByBatchId[e]?yo.resolve(this.documentKeysByBatchId[e]):this.lookupMutationBatch(t,e).next(function(t){if(t){t=t.keys();return n.documentKeysByBatchId[e]=t}return null})},wo.prototype.getNextMutationBatchAfterBatchId=function(t,e){var r=this,i=e+1,e=IDBKeyRange.lowerBound([this.userId,i]),o=null;return Io(t).iterate({index:Qs.userMutationsIndex,range:e},function(t,e,n){e.userId===r.userId&&(Cr(e.batchId>=i,"Should have found mutation after "+i),o=r.serializer.fromDbMutationBatch(e)),n.done()}).next(function(){return o})},wo.prototype.getHighestUnacknowledgedBatchId=function(t){var e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),r=-1;return Io(t).iterate({index:Qs.userMutationsIndex,range:e,reverse:!0},function(t,e,n){r=e.batchId,n.done()}).next(function(){return r})},wo.prototype.getAllMutationBatches=function(t){var e=this,n=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Io(t).loadAll(Qs.userMutationsIndex,n).next(function(t){return t.map(function(t){return e.serializer.fromDbMutationBatch(t)})})},wo.prototype.getAllMutationBatchesAffectingDocumentKey=function(a,s){var u=this,t=js.prefixForPath(this.userId,s.path),t=IDBKeyRange.lowerBound(t),c=[];return Co(a).iterate({range:t},function(e,t,n){var r=e[0],i=e[1],o=e[2],i=Qi(i);if(r===u.userId&&s.path.isEqual(i))return Io(a).get(o).next(function(t){if(!t)throw Ir("Dangling document-mutation reference found: "+e+" which points to "+o);Cr(t.userId===u.userId,"Unexpected user '"+t.userId+"' for mutation batch "+o),c.push(u.serializer.fromDbMutationBatch(t))});n.done()}).next(function(){return c})},wo.prototype.getAllMutationBatchesAffectingDocumentKeys=function(e,t){var a=this,s=new eo(oi),n=[];return t.forEach(function(o){var t=js.prefixForPath(a.userId,o.path),t=IDBKeyRange.lowerBound(t),t=Co(e).iterate({range:t},function(t,e,n){var r=t[0],i=t[1],t=t[2],i=Qi(i);r===a.userId&&o.path.isEqual(i)?s=s.add(t):n.done()});n.push(t)}),yo.waitFor(n).next(function(){return a.lookupMutationBatches(e,s)})},wo.prototype.getAllMutationBatchesAffectingQuery=function(t,e){var o=this;Cr(!e.isDocumentQuery(),"Document queries shouldn't go down this path"),Cr(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var a=e.path,s=a.length+1,e=js.prefixForPath(this.userId,a),e=IDBKeyRange.lowerBound(e),u=new eo(oi);return Co(t).iterate({range:e},function(t,e,n){var r=t[0],i=t[1],t=t[2],i=Qi(i);r===o.userId&&a.isPrefixOf(i)?i.length===s&&(u=u.add(t)):n.done()}).next(function(){return o.lookupMutationBatches(t,u)})},wo.prototype.lookupMutationBatches=function(t,e){var n=this,r=[],i=[];return e.forEach(function(e){i.push(Io(t).get(e).next(function(t){if(null===t)throw Ir("Dangling document-mutation reference found, which points to "+e);Cr(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),r.push(n.serializer.fromDbMutationBatch(t))}))}),yo.waitFor(i).next(function(){return r})},wo.prototype.removeMutationBatch=function(e,n){var r=this;return Eo(e.simpleDbTransaction,this.userId,n).next(function(t){return r.removeCachedMutationKeys(n.batchId),yo.forEach(t,function(t){return r.referenceDelegate.removeMutationReference(e,t)})})},wo.prototype.removeCachedMutationKeys=function(t){delete this.documentKeysByBatchId[t]},wo.prototype.performConsistencyCheck=function(e){var i=this;return this.checkEmpty(e).next(function(t){if(!t)return yo.resolve();var t=IDBKeyRange.lowerBound(js.prefixForUser(i.userId)),r=[];return Co(e).iterate({range:t},function(t,e,n){t[0]===i.userId?(t=Qi(t[1]),r.push(t)):n.done()}).next(function(){Cr(0===r.length,"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+r.map(function(t){return t.canonicalString()}))})})},wo.prototype.containsKey=function(t,e){return So(t,this.userId,e)},wo.prototype.getMutationQueueMetadata=function(t){var e=this;return Do(t).get(this.userId).next(function(t){return t||new Bs(e.userId,-1,"")})},wo);function wo(t,e,n,r){this.userId=t,this.serializer=e,this.indexManager=n,this.referenceDelegate=r,this.documentKeysByBatchId={}}function So(t,o,e){var e=js.prefixForPath(o,e.path),a=e[1],e=IDBKeyRange.lowerBound(e),s=!1;return Co(t).iterate({range:e,keysOnly:!0},function(t,e,n){var r=t[0],i=t[1];t[2],r===o&&i===a&&(s=!0),n.done()}).next(function(){return s})}function Eo(t,e,n){var r=t.store(Qs.store),i=t.store(js.store),o=[],t=IDBKeyRange.only(n.batchId),a=0,t=r.iterate({range:t},function(t,e,n){return a++,n.delete()});o.push(t.next(function(){Cr(1===a,"Dangling document-mutation reference found: Missing batch "+n.batchId)}));for(var s=[],u=0,c=n.mutations;u<c.length;u++){var h=c[u],l=js.key(e,h.key.path,n.batchId);o.push(i.delete(l)),s.push(h.key)}return yo.waitFor(o).next(function(){return s})}function To(t){return t instanceof Uint8Array?(Cr("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence."),t.toString()):t}function Io(t){return xu.getStore(t,Qs.store)}function Co(t){return xu.getStore(t,js.store)}function Do(t){return xu.getStore(t,Bs.store)}(me=vo={})[me.QueryCache=0]="QueryCache",me[me.SyncEngine=1]="SyncEngine";var No=(Ao.prototype.next=function(){var t=this.nextId;return this.nextId+=2,t},Ao.prototype.after=function(t){return this.seek(t+2),this.next()},Ao.prototype.seek=function(t){Cr((1&t)===this.generatorId,"Cannot supply target ID from different generator ID"),this.nextId=t},Ao.forQueryCache=function(){return new Ao(vo.QueryCache,2)},Ao.forSyncEngine=function(){return new Ao(vo.SyncEngine)},Ao);function Ao(t,e){Cr((1&(this.generatorId=t))===t,"Generator ID "+t+" contains more than 1 reserved bits"),this.seek(void 0!==e?e:this.generatorId)}var ko="SimpleDb",Ro=(Mo.openOrCreate=function(i,t,o){return Cr(Mo.isAvailable(),"IndexedDB not supported in current environment."),Sr(ko,"Opening database:",i),new yo(function(e,n){var r=window.indexedDB.open(i,t);r.onsuccess=function(t){t=t.target.result;e(new Mo(t))},r.onblocked=function(){n(new Mr(Rr.FAILED_PRECONDITION,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=function(t){t=t.target.error;"VersionError"===t.name?n(new Mr(Rr.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):n(t)},r.onupgradeneeded=function(t){Sr(ko,'Database "'+i+'" requires upgrade from version:',t.oldVersion);var e=t.target.result,n=new Lo(r.transaction);o.createOrUpgrade(e,n,t.oldVersion,Ls).next(function(){Sr(ko,"Database upgrade to version "+Ls+" complete")})}}).toPromise()},Mo.delete=function(t){return Sr(ko,"Removing database:",t),Fo(window.indexedDB.deleteDatabase(t)).toPromise()},Mo.isAvailable=function(){if("undefined"==typeof window||null==window.indexedDB)return!1;if(void 0===window.navigator)return"YES"===process.env.USE_MOCK_PERSISTENCE;var t=s(),e=Mo.getIOSVersion(t),n=0<e&&e<10,e=Mo.getAndroidVersion(t),e=0<e&&e<4.5;return!(0<t.indexOf("MSIE ")||0<t.indexOf("Trident/")||0<t.indexOf("Edge/")||n||e)},Mo.getStore=function(t,e){return t.store(e)},Mo.getIOSVersion=function(t){t=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),t=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(t)},Mo.getAndroidVersion=function(t){t=t.match(/Android ([\d.]+)/i),t=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(t)},Mo.prototype.setVersionChangeListener=function(e){this.db.onversionchange=function(t){return e(t)}},Mo.prototype.runTransaction=function(t,e,n){var r=Lo.open(this.db,t,e),i=n(r).catch(function(t){return r.abort(t),yo.reject(t)}).toPromise();return i.catch(function(){}),r.completionPromise.then(function(){return i})},Mo.prototype.close=function(){this.db.close()},Mo);function Mo(t){this.db=t,12.2===Mo.getIOSVersion(s())&&Er("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}var _o=(Object.defineProperty(Oo.prototype,"isDone",{get:function(){return this.shouldStop},enumerable:!0,configurable:!0}),Object.defineProperty(Oo.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:!0,configurable:!0}),Object.defineProperty(Oo.prototype,"cursor",{set:function(t){this.dbCursor=t},enumerable:!0,configurable:!0}),Oo.prototype.done=function(){this.shouldStop=!0},Oo.prototype.skip=function(t){this.nextKey=t},Oo.prototype.delete=function(){return Fo(this.dbCursor.delete())},Oo);function Oo(t){this.dbCursor=t,this.shouldStop=!1,this.nextKey=null}var Lo=(Po.open=function(t,e,n){return new Po(t.transaction(n,e))},Object.defineProperty(Po.prototype,"completionPromise",{get:function(){return this.completionDeferred.promise},enumerable:!0,configurable:!0}),Po.prototype.abort=function(t){t&&this.completionDeferred.reject(t),this.aborted||(Sr(ko,"Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())},Po.prototype.store=function(t){var e=this.transaction.objectStore(t);return Cr(!!e,"Object store not part of transaction: "+t),new xo(e)},Po);function Po(t){var e=this;this.transaction=t,this.aborted=!1,this.completionDeferred=new Ri,this.transaction.oncomplete=function(){e.completionDeferred.resolve()},this.transaction.onabort=function(){t.error?e.completionDeferred.reject(t.error):e.completionDeferred.resolve()},this.transaction.onerror=function(t){t=Bo(t.target.error);e.completionDeferred.reject(t)}}var xo=(qo.prototype.put=function(t,e){return Fo(void 0!==e?(Sr(ko,"PUT",this.store.name,t,e),this.store.put(e,t)):(Sr(ko,"PUT",this.store.name,"<auto-key>",t),this.store.put(t)))},qo.prototype.add=function(t){return Sr(ko,"ADD",this.store.name,t,t),Fo(this.store.add(t))},qo.prototype.get=function(e){var n=this;return Fo(this.store.get(e)).next(function(t){return Sr(ko,"GET",n.store.name,e,t=void 0===t?null:t),t})},qo.prototype.delete=function(t){return Sr(ko,"DELETE",this.store.name,t),Fo(this.store.delete(t))},qo.prototype.count=function(){return Sr(ko,"COUNT",this.store.name),Fo(this.store.count())},qo.prototype.loadAll=function(t,e){var e=this.cursor(this.options(t,e)),n=[];return this.iterateCursor(e,function(t,e){n.push(e)}).next(function(){return n})},qo.prototype.deleteAll=function(t,e){Sr(ko,"DELETE ALL",this.store.name);e=this.options(t,e);e.keysOnly=!1;e=this.cursor(e);return this.iterateCursor(e,function(t,e,n){return n.delete()})},qo.prototype.iterate=function(t,e){e?n=t:(n={},e=t);var n=this.cursor(n);return this.iterateCursor(n,e)},qo.prototype.iterateSerial=function(r){var t=this.cursor({});return new yo(function(n,e){t.onerror=function(t){t=Bo(t.target.error);e(t)},t.onsuccess=function(t){var e=t.target.result;e?r(e.primaryKey,e.value).next(function(t){t?e.continue():n()}):n()}})},qo.prototype.iterateCursor=function(t,i){var o=[];return new yo(function(r,e){t.onerror=function(t){e(t.target.error)},t.onsuccess=function(t){var e,n=t.target.result;n?(e=new _o(n),(t=i(n.primaryKey,n.value,e))instanceof yo&&(t=t.catch(function(t){return e.done(),yo.reject(t)}),o.push(t)),e.isDone?r():null===e.skipToKey?n.continue():n.continue(e.skipToKey)):r()}}).next(function(){return yo.waitFor(o)})},qo.prototype.options=function(t,e){var n=void 0;return void 0!==t&&("string"==typeof t?n=t:(Cr(void 0===e,"3rd argument must not be defined if 2nd is a range."),e=t)),{index:n,range:e}},qo.prototype.cursor=function(t){var e="next";if(t.reverse&&(e="prev"),t.index){var n=this.store.index(t.index);return t.keysOnly?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)},qo);function qo(t){this.store=t}function Fo(t){return new yo(function(e,n){t.onsuccess=function(t){t=t.target.result;e(t)},t.onerror=function(t){t=Bo(t.target.error);n(t)}})}var Vo=!1;function Bo(t){var e=Ro.getIOSVersion(s());if(12.2<=e&&e<13){e="An internal error was encountered in the Indexed Database server";if(0<=t.message.indexOf(e)){var n=new Mr("internal","IOS_INDEXEDDB_BUG1: IndexedDb has thrown '"+e+"'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.");return Vo||(Vo=!0,setTimeout(function(){throw n},0)),n}}return t}var Uo=(Qo.prototype.allocateTargetId=function(e){var n=this;return this.retrieveMetadata(e).next(function(t){return t.highestTargetId=n.targetIdGenerator.after(t.highestTargetId),n.saveMetadata(e,t).next(function(){return t.highestTargetId})})},Qo.prototype.getLastRemoteSnapshotVersion=function(t){return this.retrieveMetadata(t).next(function(t){return Wi.fromTimestamp(new Ki(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))})},Qo.prototype.getHighestSequenceNumber=function(t){return Wo(t.simpleDbTransaction)},Qo.prototype.setTargetsMetadata=function(e,n,r){var i=this;return this.retrieveMetadata(e).next(function(t){return t.highestListenSequenceNumber=n,r&&(t.lastRemoteSnapshotVersion=r.toTimestamp()),n>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=n),i.saveMetadata(e,t)})},Qo.prototype.addQueryData=function(e,n){var r=this;return this.saveQueryData(e,n).next(function(){return r.retrieveMetadata(e).next(function(t){return t.targetCount+=1,r.updateMetadataFromQueryData(n,t),r.saveMetadata(e,t)})})},Qo.prototype.updateQueryData=function(t,e){return this.saveQueryData(t,e)},Qo.prototype.removeQueryData=function(e,t){var n=this;return this.removeMatchingKeysForTargetId(e,t.targetId).next(function(){return Ko(e).delete(t.targetId)}).next(function(){return n.retrieveMetadata(e)}).next(function(t){return Cr(0<t.targetCount,"Removing from an empty query cache"),--t.targetCount,n.saveMetadata(e,t)})},Qo.prototype.removeTargets=function(n,r,i){var o=this,a=0,s=[];return Ko(n).iterate(function(t,e){e=o.serializer.fromDbTarget(e);e.sequenceNumber<=r&&void 0===i[e.targetId]&&(a++,s.push(o.removeQueryData(n,e)))}).next(function(){return yo.waitFor(s)}).next(function(){return a})},Qo.prototype.forEachTarget=function(t,n){var r=this;return Ko(t).iterate(function(t,e){e=r.serializer.fromDbTarget(e);n(e)})},Qo.prototype.retrieveMetadata=function(t){return jo(t.simpleDbTransaction)},Qo.prototype.saveMetadata=function(t,e){return xu.getStore(t,nu.store).put(nu.key,e)},Qo.prototype.saveQueryData=function(t,e){return Ko(t).put(this.serializer.toDbTarget(e))},Qo.prototype.updateMetadataFromQueryData=function(t,e){var n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n},Qo.prototype.getQueryCount=function(t){return this.retrieveMetadata(t).next(function(t){return t.targetCount})},Qo.prototype.getQueryData=function(t,r){var i=this,e=r.canonicalId(),e=IDBKeyRange.bound([e,Number.NEGATIVE_INFINITY],[e,Number.POSITIVE_INFINITY]),o=null;return Ko(t).iterate({range:e,index:$s.queryTargetsIndexName},function(t,e,n){e=i.serializer.fromDbTarget(e);r.isEqual(e.query)&&(o=e,n.done())}).next(function(){return o})},Qo.prototype.addMatchingKeys=function(n,t,r){var i=this,o=[],a=Go(n);return t.forEach(function(t){var e=Bi(t.path);o.push(a.put(new tu(r,e))),o.push(i.referenceDelegate.addReference(n,t))}),yo.waitFor(o)},Qo.prototype.removeMatchingKeys=function(n,t,r){var i=this,o=Go(n);return yo.forEach(t,function(t){var e=Bi(t.path);return yo.waitFor([o.delete([r,e]),i.referenceDelegate.removeReference(n,t)])})},Qo.prototype.removeMatchingKeysForTargetId=function(t,e){t=Go(t),e=IDBKeyRange.bound([e],[e+1],!1,!0);return t.delete(e)},Qo.prototype.getMatchingKeysForTargetId=function(t,e){var e=IDBKeyRange.bound([e],[e+1],!1,!0),t=Go(t),r=co();return t.iterate({range:e,keysOnly:!0},function(t,e,n){t=Qi(t[1]),t=new Ai(t);r=r.add(t)}).next(function(){return r})},Qo.prototype.containsKey=function(t,e){var e=Bi(e.path),e=IDBKeyRange.bound([e],[si(e)],!1,!0),i=0;return Go(t).iterate({index:tu.documentTargetsIndex,keysOnly:!0,range:e},function(t,e,n){var r=t[0];t[1],0!==r&&(i++,n.done())}).next(function(){return 0<i})},Qo.prototype.getQueryDataForTarget=function(t,e){var n=this;return Ko(t).get(e).next(function(t){return t?n.serializer.fromDbTarget(t):null})},Qo);function Qo(t,e){this.referenceDelegate=t,this.serializer=e,this.targetIdGenerator=No.forQueryCache()}function Ko(t){return xu.getStore(t,$s.store)}function jo(t){return Ro.getStore(t,nu.store).get(nu.key).next(function(t){return Cr(null!==t,"Missing metadata row."),t})}function Wo(t){return jo(t).next(function(t){return t.highestListenSequenceNumber})}function Go(t){return xu.getStore(t,tu.store)}var zo=(Ho.fromSet=function(t){return new Ho(t)},Ho.fromArray=function(t){var e=new eo(Di.comparator);return t.forEach(function(t){return e=e.add(t)}),new Ho(e)},Ho.prototype.covers=function(e){var n=!1;return this.fields.forEach(function(t){t.isPrefixOf(e)&&(n=!0)}),n},Ho.prototype.isEqual=function(t){return this.fields.isEqual(t.fields)},Ho);function Ho(t){this.fields=t}var Yo=(Xo.prototype.isEqual=function(t){return this.field.isEqual(t.field)&&this.transform.isEqual(t.transform)},Xo);function Xo(t,e){this.field=t,this.transform=e}function Jo(t,e){this.version=t,this.transformResults=e}var $o;(cr=$o={})[cr.Set=0]="Set",cr[cr.Patch=1]="Patch",cr[cr.Transform=2]="Transform",cr[cr.Delete=3]="Delete";var Zo=(ta.exists=function(t){return new ta(void 0,t)},ta.updateTime=function(t){return new ta(t)},Object.defineProperty(ta.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!0,configurable:!0}),ta.prototype.isValidFor=function(t){return void 0!==this.updateTime?t instanceof us&&t.version.isEqual(this.updateTime):void 0!==this.exists?this.exists===t instanceof us:(Cr(this.isNone,"Precondition should be empty"),!0)},ta.prototype.isEqual=function(t){return e=this.updateTime,n=t.updateTime,(null!=e?!(!n||!e.isEqual(n)):e===n)&&this.exists===t.exists;var e,n},ta.NONE=new ta,ta);function ta(t,e){this.updateTime=t,this.exists=e,Cr(void 0===t||void 0===e,'Precondition can specify "exists" or "updateTime" but not both')}var ea=(na.prototype.verifyKeyMatches=function(t){null!=t&&Cr(t.key.isEqual(this.key),"Can only apply a mutation to a document with the same key")},na.getPostMutationVersion=function(t){return t instanceof us?t.version:Wi.MIN},na);function na(){}var ra,ia=(a(oa,ra=ea),oa.prototype.applyToRemoteDocument=function(t,e){this.verifyKeyMatches(t),Cr(null==e.transformResults,"Transform results received by SetMutation.");e=e.version;return new us(this.key,e,{hasCommittedMutations:!0},this.value)},oa.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;t=ea.getPostMutationVersion(t);return new us(this.key,t,{hasLocalMutations:!0},this.value)},oa.prototype.extractBaseValue=function(t){return null},oa.prototype.isEqual=function(t){return t instanceof oa&&this.key.isEqual(t.key)&&this.value.isEqual(t.value)&&this.precondition.isEqual(t.precondition)},oa);function oa(t,e,n){var r=ra.call(this)||this;return r.key=t,r.value=e,r.precondition=n,r.type=$o.Set,r}var aa,sa=(a(ua,aa=ea),ua.prototype.applyToRemoteDocument=function(t,e){if(this.verifyKeyMatches(t),Cr(null==e.transformResults,"Transform results received by PatchMutation."),!this.precondition.isValidFor(t))return new ds(this.key,e.version);t=this.patchDocument(t);return new us(this.key,e.version,{hasCommittedMutations:!0},t)},ua.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=ea.getPostMutationVersion(t),t=this.patchDocument(t);return new us(this.key,r,{hasLocalMutations:!0},t)},ua.prototype.extractBaseValue=function(t){return null},ua.prototype.isEqual=function(t){return t instanceof ua&&this.key.isEqual(t.key)&&this.fieldMask.isEqual(t.fieldMask)&&this.precondition.isEqual(t.precondition)},ua.prototype.patchDocument=function(t){t=t instanceof us?t.data():es.EMPTY;return this.patchObject(t)},ua.prototype.patchObject=function(n){var r=this;return this.fieldMask.fields.forEach(function(t){var e;t.isEmpty()||(e=r.data.field(t),n=null!==e?n.set(t,e):n.delete(t))}),n},ua);function ua(t,e,n,r){var i=aa.call(this)||this;return i.key=t,i.data=e,i.fieldMask=n,i.precondition=r,i.type=$o.Patch,i}var ca,ha=(a(la,ca=ea),la.prototype.applyToRemoteDocument=function(t,e){if(this.verifyKeyMatches(t),Cr(null!=e.transformResults,"Transform results missing for TransformMutation."),!this.precondition.isValidFor(t))return new ds(this.key,e.version);var n=this.requireDocument(t),t=this.serverTransformResults(t,e.transformResults),e=e.version,t=this.transformObject(n.data(),t);return new us(this.key,e,{hasCommittedMutations:!0},t)},la.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=this.requireDocument(t),e=this.localTransformResults(n,t,e),e=this.transformObject(r.data(),e);return new us(this.key,r.version,{hasLocalMutations:!0},e)},la.prototype.extractBaseValue=function(t){for(var e=null,n=0,r=this.fieldTransforms;n<r.length;n++){var i=r[n],o=t instanceof us?t.field(i.field):void 0,o=i.transform.computeBaseValue(o||null);null!=o&&(e=(null==e?es.EMPTY:e).set(i.field,o))}return e},la.prototype.isEqual=function(t){return t instanceof la&&this.key.isEqual(t.key)&&ai(this.fieldTransforms,t.fieldTransforms)&&this.precondition.isEqual(t.precondition)},la.prototype.requireDocument=function(t){Cr(t instanceof us,"Unknown MaybeDocument type "+t);return Cr(t.key.isEqual(this.key),"Can only transform a document with the same key"),t},la.prototype.serverTransformResults=function(t,e){var n=[];Cr(this.fieldTransforms.length===e.length,"server transform result count ("+e.length+") should match field transform count ("+this.fieldTransforms.length+")");for(var r=0;r<e.length;r++){var i=this.fieldTransforms[r],o=i.transform,a=null;t instanceof us&&(a=t.field(i.field)),n.push(o.applyToRemoteDocument(a,e[r]))}return n},la.prototype.localTransformResults=function(t,e,n){for(var r=[],i=0,o=this.fieldTransforms;i<o.length;i++){var a=o[i],s=a.transform,u=null;null===(u=e instanceof us?e.field(a.field):u)&&n instanceof us&&(u=n.field(a.field)),r.push(s.applyToLocalView(u,t))}return r},la.prototype.transformObject=function(t,e){Cr(e.length===this.fieldTransforms.length,"TransformResults length mismatch.");for(var n=0;n<this.fieldTransforms.length;n++){var r=this.fieldTransforms[n].field;t=t.set(r,e[n])}return t},la);function la(t,e){var n=ca.call(this)||this;return n.key=t,n.fieldTransforms=e,n.type=$o.Transform,n.precondition=Zo.exists(!0),n}var fa,pa,da,ma=(a(ya,fa=ea),ya.prototype.applyToRemoteDocument=function(t,e){return this.verifyKeyMatches(t),Cr(null==e.transformResults,"Transform results received by DeleteMutation."),new ls(this.key,e.version,{hasCommittedMutations:!0})},ya.prototype.applyToLocalView=function(t,e,n){return this.verifyKeyMatches(t),this.precondition.isValidFor(t)?(t&&Cr(t.key.isEqual(this.key),"Can only apply mutation to document with same key"),new ls(this.key,Wi.forDeletedDoc())):t},ya.prototype.extractBaseValue=function(t){return null},ya.prototype.isEqual=function(t){return t instanceof ya&&this.key.isEqual(t.key)&&this.precondition.isEqual(t.precondition)},ya);function ya(t,e){var n=fa.call(this)||this;return n.key=t,n.precondition=e,n.type=$o.Delete,n}(he=pa={})[he.NullValue=0]="NullValue",he[he.BooleanValue=1]="BooleanValue",he[he.NumberValue=2]="NumberValue",he[he.TimestampValue=3]="TimestampValue",he[he.StringValue=4]="StringValue",he[he.BlobValue=5]="BlobValue",he[he.RefValue=6]="RefValue",he[he.GeoPointValue=7]="GeoPointValue",he[he.ArrayValue=8]="ArrayValue",he[he.ObjectValue=9]="ObjectValue",(le=da={})[le.Default=0]="Default",le[le.Estimate=1]="Estimate",le[le.Previous=2]="Previous";var ga=(va.fromSnapshotOptions=function(t,e){switch(t.serverTimestamps){case"estimate":return new va(da.Estimate,e);case"previous":return new va(da.Previous,e);case"none":case void 0:return new va(da.Default,e);default:return Ir("fromSnapshotOptions() called with invalid options.")}},va);function va(t,e){this.serverTimestampBehavior=t,this.timestampsInSnapshots=e}ba.prototype.toString=function(){var t=this.value();return null===t?"null":t.toString()},ba.prototype.defaultCompareTo=function(t){return Cr(this.typeOrder!==t.typeOrder,"Default compareTo should not be used for values of same type."),oi(this.typeOrder,t.typeOrder)},lr=ba;function ba(){}var wa,Sa=(a(Ea,wa=lr),Ea.prototype.value=function(t){return null},Ea.prototype.isEqual=function(t){return t instanceof Ea},Ea.prototype.compareTo=function(t){return t instanceof Ea?0:this.defaultCompareTo(t)},Ea.INSTANCE=new Ea,Ea);function Ea(){var t=wa.call(this)||this;return t.typeOrder=pa.NullValue,t.internalValue=null,t}var Ta,Ia=(a(Ca,Ta=lr),Ca.prototype.value=function(t){return this.internalValue},Ca.prototype.isEqual=function(t){return t instanceof Ca&&this.internalValue===t.internalValue},Ca.prototype.compareTo=function(t){return t instanceof Ca?oi(this,t):this.defaultCompareTo(t)},Ca.of=function(t){return t?Ca.TRUE:Ca.FALSE},Ca.TRUE=new Ca(!0),Ca.FALSE=new Ca(!1),Ca);function Ca(t){var e=Ta.call(this)||this;return e.internalValue=t,e.typeOrder=pa.BooleanValue,e}var Da,Na=(a(Aa,Da=lr),Aa.prototype.value=function(t){return this.internalValue},Aa.prototype.compareTo=function(t){return t instanceof Aa?(e=this.internalValue,n=t.internalValue,e<n?-1:n<e?1:e===n?0:isNaN(e)?isNaN(n)?0:-1:1):this.defaultCompareTo(t);var e,n},Aa);function Aa(t){var e=Da.call(this)||this;return e.internalValue=t,e.typeOrder=pa.NumberValue,e}function ka(t,e){return t===e?0!==t||1/t==1/e:t!=t&&e!=e}var Ra,Ma=(a(_a,Ra=Na),_a.prototype.isEqual=function(t){return t instanceof _a&&ka(this.internalValue,t.internalValue)},_a);function _a(){return null!==Ra&&Ra.apply(this,arguments)||this}var Oa,La=(a(Pa,Oa=Na),Pa.prototype.isEqual=function(t){return t instanceof Pa&&ka(this.internalValue,t.internalValue)},Pa.NAN=new Pa(NaN),Pa.POSITIVE_INFINITY=new Pa(1/0),Pa.NEGATIVE_INFINITY=new Pa(-1/0),Pa);function Pa(){return null!==Oa&&Oa.apply(this,arguments)||this}var xa,qa=(a(Fa,xa=lr),Fa.prototype.value=function(t){return this.internalValue},Fa.prototype.isEqual=function(t){return t instanceof Fa&&this.internalValue===t.internalValue},Fa.prototype.compareTo=function(t){return t instanceof Fa?oi(this.internalValue,t.internalValue):this.defaultCompareTo(t)},Fa);function Fa(t){var e=xa.call(this)||this;return e.internalValue=t,e.typeOrder=pa.StringValue,e}var Va,Ba=(a(Ua,Va=lr),Ua.prototype.value=function(t){return!t||t.timestampsInSnapshots?this.internalValue:this.internalValue.toDate()},Ua.prototype.isEqual=function(t){return t instanceof Ua&&this.internalValue.isEqual(t.internalValue)},Ua.prototype.compareTo=function(t){return t instanceof Ua?this.internalValue._compareTo(t.internalValue):t instanceof Ka?-1:this.defaultCompareTo(t)},Ua);function Ua(t){var e=Va.call(this)||this;return e.internalValue=t,e.typeOrder=pa.TimestampValue,e}var Qa,Ka=(a(ja,Qa=lr),ja.prototype.value=function(t){return t&&t.serverTimestampBehavior===da.Estimate?new Ba(this.localWriteTime).value(t):t&&t.serverTimestampBehavior===da.Previous&&this.previousValue?this.previousValue.value(t):null},ja.prototype.isEqual=function(t){return t instanceof ja&&this.localWriteTime.isEqual(t.localWriteTime)},ja.prototype.compareTo=function(t){return t instanceof ja?this.localWriteTime._compareTo(t.localWriteTime):t instanceof Ba?1:this.defaultCompareTo(t)},ja.prototype.toString=function(){return"<ServerTimestamp localTime="+this.localWriteTime.toString()+">"},ja);function ja(t,e){var n=Qa.call(this)||this;return n.localWriteTime=t,n.previousValue=e,n.typeOrder=pa.TimestampValue,n}var Wa,Ga=(a(za,Wa=lr),za.prototype.value=function(t){return this.internalValue},za.prototype.isEqual=function(t){return t instanceof za&&this.internalValue.isEqual(t.internalValue)},za.prototype.compareTo=function(t){return t instanceof za?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},za);function za(t){var e=Wa.call(this)||this;return e.internalValue=t,e.typeOrder=pa.BlobValue,e}var Ha,Ya=(a(Xa,Ha=lr),Xa.prototype.value=function(t){return this.key},Xa.prototype.isEqual=function(t){return t instanceof Xa&&this.key.isEqual(t.key)&&this.databaseId.isEqual(t.databaseId)},Xa.prototype.compareTo=function(t){if(t instanceof Xa){var e=this.databaseId.compareTo(t.databaseId);return 0!==e?e:Ai.comparator(this.key,t.key)}return this.defaultCompareTo(t)},Xa);function Xa(t,e){var n=Ha.call(this)||this;return n.databaseId=t,n.key=e,n.typeOrder=pa.RefValue,n}var Ja,$a=(a(Za,Ja=lr),Za.prototype.value=function(t){return this.internalValue},Za.prototype.isEqual=function(t){return t instanceof Za&&this.internalValue.isEqual(t.internalValue)},Za.prototype.compareTo=function(t){return t instanceof Za?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},Za);function Za(t){var e=Ja.call(this)||this;return e.internalValue=t,e.typeOrder=pa.GeoPointValue,e}var ts,es=(a(ns,ts=lr),ns.prototype.value=function(n){var r={};return this.internalValue.inorderTraversal(function(t,e){r[t]=e.value(n)}),r},ns.prototype.forEach=function(t){this.internalValue.inorderTraversal(t)},ns.prototype.isEqual=function(t){if(t instanceof ns){for(var e=this.internalValue.getIterator(),n=t.internalValue.getIterator();e.hasNext()&&n.hasNext();){var r=e.getNext(),i=n.getNext();if(r.key!==i.key||!r.value.isEqual(i.value))return!1}return!e.hasNext()&&!n.hasNext()}return!1},ns.prototype.compareTo=function(t){if(t instanceof ns){for(var e=this.internalValue.getIterator(),n=t.internalValue.getIterator();e.hasNext()&&n.hasNext();){var r=e.getNext(),i=n.getNext(),i=oi(r.key,i.key)||r.value.compareTo(i.value);if(i)return i}return oi(e.hasNext(),n.hasNext())}return this.defaultCompareTo(t)},ns.prototype.set=function(t,e){if(Cr(!t.isEmpty(),"Cannot set field for empty path on ObjectValue"),1===t.length)return this.setChild(t.firstSegment(),e);var n=this.child(t.firstSegment()),e=(n=!(n instanceof ns)?ns.EMPTY:n).set(t.popFirst(),e);return this.setChild(t.firstSegment(),e)},ns.prototype.delete=function(t){if(Cr(!t.isEmpty(),"Cannot delete field for empty path on ObjectValue"),1===t.length)return new ns(this.internalValue.remove(t.firstSegment()));var e=this.child(t.firstSegment());if(e instanceof ns){e=e.delete(t.popFirst());return new ns(this.internalValue.insert(t.firstSegment(),e))}return this},ns.prototype.contains=function(t){return null!==this.field(t)},ns.prototype.field=function(t){Cr(!t.isEmpty(),"Can't get field of empty path");var e=this;return t.forEach(function(t){e=e instanceof ns?e.internalValue.get(t):null}),e},ns.prototype.fieldMask=function(){var i=new eo(Di.comparator);return this.internalValue.forEach(function(t,e){var n,r=new Di([t]);!(e instanceof ns)||(n=e.fieldMask().fields).isEmpty()?i=i.add(r):n.forEach(function(t){i=i.add(r.child(t))})}),zo.fromSet(i)},ns.prototype.toString=function(){return this.internalValue.toString()},ns.prototype.child=function(t){return this.internalValue.get(t)||void 0},ns.prototype.setChild=function(t,e){return new ns(this.internalValue.insert(t,e))},ns.EMPTY=new ns(new zi(oi)),ns);function ns(t){var e=ts.call(this)||this;return e.internalValue=t,e.typeOrder=pa.ObjectValue,e}var rs,is=(a(os,rs=lr),os.prototype.value=function(e){return this.internalValue.map(function(t){return t.value(e)})},os.prototype.contains=function(t){for(var e=0,n=this.internalValue;e<n.length;e++)if(n[e].isEqual(t))return!0;return!1},os.prototype.forEach=function(t){this.internalValue.forEach(t)},os.prototype.isEqual=function(t){if(t instanceof os){if(this.internalValue.length!==t.internalValue.length)return!1;for(var e=0;e<this.internalValue.length;e++)if(!this.internalValue[e].isEqual(t.internalValue[e]))return!1;return!0}return!1},os.prototype.compareTo=function(t){if(t instanceof os){for(var e=Math.min(this.internalValue.length,t.internalValue.length),n=0;n<e;n++){var r=this.internalValue[n].compareTo(t.internalValue[n]);if(r)return r}return oi(this.internalValue.length,t.internalValue.length)}return this.defaultCompareTo(t)},os.prototype.toString=function(){return"["+this.internalValue.map(function(t){return t.toString()}).join(",")+"]"},os);function os(t){var e=rs.call(this)||this;return e.internalValue=t,e.typeOrder=pa.ArrayValue,e}as.compareByKey=function(t,e){return Ai.comparator(t.key,e.key)},t=as;function as(t,e){this.key=t,this.version=e}var ss,us=(a(cs,ss=t),cs.prototype.field=function(t){if(this.objectValue)return this.objectValue.field(t);this.fieldValueCache||(this.fieldValueCache=new Map);var e=t.canonicalString(),n=this.fieldValueCache.get(e);return void 0===n&&(n=void 0===(t=this.getProtoField(t))?null:this.converter(t),this.fieldValueCache.set(e,n)),n},cs.prototype.data=function(){var n,r=this;return this.objectValue||(n=es.EMPTY,qr(this.proto.fields||{},function(t,e){n=n.set(new Di([t]),r.converter(e))}),this.objectValue=n,this.fieldValueCache=void 0),this.objectValue},cs.prototype.value=function(){return this.data().value()},cs.prototype.isEqual=function(t){return t instanceof cs&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.hasLocalMutations===t.hasLocalMutations&&this.hasCommittedMutations===t.hasCommittedMutations&&this.data().isEqual(t.data())},cs.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.data().toString()+", {hasLocalMutations: "+this.hasLocalMutations+"}), {hasCommittedMutations: "+this.hasCommittedMutations+"})"},Object.defineProperty(cs.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:!0,configurable:!0}),cs.prototype.getProtoField=function(t){Cr(void 0!==this.proto,"Can only call getProtoField() when proto is defined");for(var e=this.proto.fields?this.proto.fields[t.firstSegment()]:void 0,n=1;n<t.length;++n){if(!e||!e.mapValue||!e.mapValue.fields)return;e=e.mapValue.fields[t.get(n)]}return e},cs.compareByField=function(t,e,n){e=e.field(t),t=n.field(t);return null!==e&&null!==t?e.compareTo(t):Ir("Trying to compare documents on fields that don't exist")},cs);function cs(t,e,n,r,i,o){e=ss.call(this,t,e)||this;return e.objectValue=r,e.proto=i,e.converter=o,Cr(void 0!==e.objectValue||void 0!==e.proto&&void 0!==e.converter,"If objectValue is not defined, proto and converter need to be set."),e.hasLocalMutations=!!n.hasLocalMutations,e.hasCommittedMutations=!!n.hasCommittedMutations,e}var hs,ls=(a(fs,hs=t),fs.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"},Object.defineProperty(fs.prototype,"hasPendingWrites",{get:function(){return this.hasCommittedMutations},enumerable:!0,configurable:!0}),fs.prototype.isEqual=function(t){return t instanceof fs&&t.hasCommittedMutations===this.hasCommittedMutations&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},fs);function fs(t,e,n){e=hs.call(this,t,e)||this;return e.hasCommittedMutations=!(!n||!n.hasCommittedMutations),e}var ps,ds=(a(ms,ps=t),ms.prototype.toString=function(){return"UnknownDocument("+this.key+", "+this.version+")"},Object.defineProperty(ms.prototype,"hasPendingWrites",{get:function(){return!0},enumerable:!0,configurable:!0}),ms.prototype.isEqual=function(t){return t instanceof ms&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},ms);function ms(){return null!==ps&&ps.apply(this,arguments)||this}var ys=(gs.prototype.get=function(t){var e=this.mapKeyFn(t),e=this.inner[e];if(void 0!==e)for(var n=0,r=e;n<r.length;n++){var i=r[n],o=i[0],i=i[1];if(o.isEqual(t))return i}},gs.prototype.has=function(t){return void 0!==this.get(t)},gs.prototype.set=function(t,e){var n=this.mapKeyFn(t),r=this.inner[n];if(void 0!==r){for(var i=0;i<r.length;i++)if(r[i][0].isEqual(t))return void(r[i]=[t,e]);r.push([t,e])}else this.inner[n]=[[t,e]]},gs.prototype.delete=function(t){var e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(var r=0;r<n.length;r++)if(n[r][0].isEqual(t))return 1===n.length?delete this.inner[e]:n.splice(r,1),!0;return!1},gs.prototype.forEach=function(a){qr(this.inner,function(t,e){for(var n=0,r=e;n<r.length;n++){var i=r[n],o=i[0],i=i[1];a(o,i)}})},gs.prototype.isEmpty=function(){return Fr(this.inner)},gs);function gs(t){this.mapKeyFn=t,this.inner={}}var vs=(bs.prototype.addEntry=function(t){this.assertNotApplied(),this.changes.set(t.key,t)},bs.prototype.removeEntry=function(t){this.assertNotApplied(),this.changes.set(t,null)},bs.prototype.getEntry=function(t,e){this.assertNotApplied();var n=this.changes.get(e);return void 0!==n?yo.resolve(n):this.getFromCache(t,e)},bs.prototype.getEntries=function(t,e){return this.getAllFromCache(t,e)},bs.prototype.apply=function(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)},bs.prototype.assertNotApplied=function(){Cr(!this.changesApplied,"Changes have already been applied.")},bs);function bs(){this.changes=new ys(function(t){return t.toString()}),this.changesApplied=!1}var ws,Ss="The remote document changelog no longer contains all changes for all local query views. It may be necessary to rebuild these views.",Es=(Object.defineProperty(Ts.prototype,"lastProcessedDocumentChangeId",{get:function(){return this._lastProcessedDocumentChangeId},enumerable:!0,configurable:!0}),Ts.prototype.start=function(t){t=Ro.getStore(t,su.store);return this.synchronizeLastDocumentChangeId(t)},Ts.prototype.addEntry=function(t,e,n){var r=this;return Ds(t).put(As(e),n).next(function(){r.indexManager.addToCollectionParentIndex(t,e.path.popLast())})},Ts.prototype.removeEntry=function(t,e){t=Ds(t),e=As(e);return t.delete(e)},Ts.prototype.updateMetadata=function(e,n,r){var i=this;return this.getMetadata(e).next(function(t){return t.byteSize+=r,i.setMetadata(e,t).next(function(){if(i.keepDocumentChangeLog)return Ns(e).put({changes:i.serializer.toDbResourcePaths(n)})})})},Ts.prototype.getEntry=function(t,e){var n=this;return Ds(t).get(As(e)).next(function(t){return t?n.serializer.fromDbRemoteDocument(t):null})},Ts.prototype.getSizedEntry=function(t,e){var n=this;return Ds(t).get(As(e)).next(function(t){return t?{maybeDocument:n.serializer.fromDbRemoteDocument(t),size:ks(t)}:null})},Ts.prototype.getEntries=function(t,e){var n=this,r=oo;return this.forEachDbEntry(t,e,function(t,e){r=e?r.insert(t,n.serializer.fromDbRemoteDocument(e)):r.insert(t,null)}).next(function(){return r})},Ts.prototype.getSizedEntries=function(t,e){var n=this,r=oo,i=new zi(Ai.comparator);return this.forEachDbEntry(t,e,function(t,e){i=e?(r=r.insert(t,n.serializer.fromDbRemoteDocument(e)),i.insert(t,ks(e))):(r=r.insert(t,null),i.insert(t,0))}).next(function(){return{maybeDocuments:r,sizeMap:i}})},Ts.prototype.forEachDbEntry=function(t,e,i){if(e.isEmpty())return yo.resolve();var n=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),o=e.getIterator(),a=o.getNext();return Ds(t).iterate({range:n},function(t,e,n){for(var r=Ai.fromSegments(t);a&&Ai.comparator(a,r)<0;)i(a,null),a=o.getNext();a&&a.isEqual(r)&&(i(a,e),a=o.hasNext()?o.getNext():null),a?n.skip(a.path.toArray()):n.done()}).next(function(){for(;a;)i(a,null),a=o.hasNext()?o.getNext():null})},Ts.prototype.getDocumentsMatchingQuery=function(t,r){var i=this;Cr(!r.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var o=ao,a=r.path.length+1,e=r.path.toArray(),e=IDBKeyRange.lowerBound(e);return Ds(t).iterate({range:e},function(t,e,n){t.length===a&&(e=i.serializer.fromDbRemoteDocument(e),r.path.isPrefixOf(e.key.path)?e instanceof us&&r.matches(e)&&(o=o.insert(e.key,e)):n.done())}).next(function(){return o})},Ts.prototype.getNewDocumentChanges=function(n){var r=this;Cr(this.keepDocumentChangeLog,"Can only call getNewDocumentChanges() when document change log is enabled");var i=co(),o=oo,t=IDBKeyRange.lowerBound(this._lastProcessedDocumentChangeId+1),a=!0,s=Ns(n);return s.iterate({range:t},function(t,e){return a&&(a=!1,r._lastProcessedDocumentChangeId+1!==e.id)?r.synchronizeLastDocumentChangeId(s).next(function(){return yo.reject(new Mr(Rr.DATA_LOSS,Ss))}):(i=i.unionWith(r.serializer.fromDbResourcePaths(e.changes)),void(r._lastProcessedDocumentChangeId=e.id))}).next(function(){var t=[];return i.forEach(function(e){t.push(r.getEntry(n,e).next(function(t){t=t||new ls(e,Wi.forDeletedDoc());o=o.insert(e,t)}))}),yo.waitFor(t)}).next(function(){return o})},Ts.prototype.removeDocumentChangesThroughChangeId=function(t,e){e=IDBKeyRange.upperBound(e);return Ns(t).delete(e)},Ts.prototype.synchronizeLastDocumentChangeId=function(t){var r=this;return this._lastProcessedDocumentChangeId=0,t.iterate({keysOnly:!0,reverse:!0},function(t,e,n){r._lastProcessedDocumentChangeId=t,n.done()})},Ts.prototype.newChangeBuffer=function(){return new Ts.RemoteDocumentChangeBuffer(this)},Ts.prototype.getSize=function(t){return this.getMetadata(t).next(function(t){return t.byteSize})},Ts.prototype.getMetadata=function(t){return Cs(t).get(Xs.key).next(function(t){return Cr(!!t,"Missing document cache metadata"),t})},Ts.prototype.setMetadata=function(t,e){return Cs(t).put(Xs.key,e)},Ts.RemoteDocumentChangeBuffer=(a(Is,ws=vs),Is.prototype.applyChanges=function(i){var o=this,a=[],s=0,u=co();return this.changes.forEach(function(t,e){var n,r=o.documentSizes.get(t);Cr(void 0!==r,"Cannot modify a document that wasn't read (for "+t+")"),e?(e=ks(n=o.documentCache.serializer.toDbRemoteDocument(e)),s+=e-r,a.push(o.documentCache.addEntry(i,t,n))):(s-=r,a.push(o.documentCache.removeEntry(i,t))),u=u.add(t)}),a.push(this.documentCache.updateMetadata(i,u,s)),yo.waitFor(a)},Is.prototype.getFromCache=function(t,e){var n=this;return this.documentCache.getSizedEntry(t,e).next(function(t){return null===t?(n.documentSizes.set(e,0),null):(n.documentSizes.set(e,t.size),t.maybeDocument)})},Is.prototype.getAllFromCache=function(t,e){var n=this;return this.documentCache.getSizedEntries(t,e).next(function(t){var e=t.maybeDocuments;return t.sizeMap.forEach(function(t,e){n.documentSizes.set(t,e)}),e})},Is),Ts);function Ts(t,e,n){this.serializer=t,this.indexManager=e,this.keepDocumentChangeLog=n,this._lastProcessedDocumentChangeId=0}function Is(t){var e=ws.call(this)||this;return e.documentCache=t,e.documentSizes=new ys(function(t){return t.toString()}),e}function Cs(t){return xu.getStore(t,Xs.store)}function Ds(t){return xu.getStore(t,Hs.store)}function Ns(t){return xu.getStore(t,su.store)}function As(t){return t.path.toArray()}function ks(t){var e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw Ir("Unknown remote document type");e=t.noDocument}return JSON.stringify(e).length}var Rs=(Ms.prototype.addToCollectionParentIndex=function(t,e){return this.collectionParentIndex.add(e),yo.resolve()},Ms.prototype.getCollectionParents=function(t,e){return yo.resolve(this.collectionParentIndex.getEntries(e))},Ms);function Ms(){this.collectionParentIndex=new _s}var _s=(Os.prototype.add=function(t){Cr(t.length%2==1,"Expected a collection path.");var e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new eo(Ei.comparator),t=!r.has(n);return this.index[e]=r.add(n),t},Os.prototype.getEntries=function(t){return(this.index[t]||new eo(Ei.comparator)).toArray()},Os);function Os(){this.index={}}var Ls=8,Ps=(xs.prototype.createOrUpgrade=function(t,i,e,n){var r=this;Cr(e<n&&0<=e&&n<=Ls,"Unexpected schema upgrade from v"+e+" to v{toVersion}."),e<1&&1<=n&&(t.createObjectStore(Fs.store),(o=t).createObjectStore(Bs.store,{keyPath:Bs.keyPath}),o.createObjectStore(Qs.store,{keyPath:Qs.keyPath,autoIncrement:!0}).createIndex(Qs.userMutationsIndex,Qs.userMutationsKeyPath,{unique:!0}),o.createObjectStore(js.store),au(t),t.createObjectStore(Hs.store));var o,a=yo.resolve();return e<3&&3<=n&&(0!==e&&((o=t).deleteObjectStore(tu.store),o.deleteObjectStore($s.store),o.deleteObjectStore(nu.store),au(t)),a=a.next(function(){return t=i.store(nu.store),e=new nu(0,0,Wi.MIN.toTimestamp(),0),t.put(nu.key,e);var t,e})),e<4&&4<=n&&(a=(a=0!==e?a.next(function(){return n=t,(r=i).store(Qs.store).loadAll().next(function(t){n.deleteObjectStore(Qs.store),n.createObjectStore(Qs.store,{keyPath:Qs.keyPath,autoIncrement:!0}).createIndex(Qs.userMutationsIndex,Qs.userMutationsKeyPath,{unique:!0});var e=r.store(Qs.store),t=t.map(function(t){return e.put(t)});return yo.waitFor(t)});var n,r}):a).next(function(){t.createObjectStore(cu.store,{keyPath:cu.keyPath}),t.createObjectStore(su.store,{keyPath:"id",autoIncrement:!0})})),e<5&&5<=n&&(a=a.next(function(){return r.removeAcknowledgedMutations(i)})),e<6&&6<=n&&(a=a.next(function(){return t.createObjectStore(Xs.store),r.addDocumentGlobal(i)})),e<7&&7<=n&&(a=a.next(function(){return r.ensureSequenceNumbers(i)})),a=e<8&&8<=n?a.next(function(){return r.createCollectionParentIndex(t,i)}):a},xs.prototype.addDocumentGlobal=function(e){var n=0;return e.store(Hs.store).iterate(function(t,e){n+=ks(e)}).next(function(){var t=new Xs(n);return e.store(Xs.store).put(Xs.key,t)})},xs.prototype.removeAcknowledgedMutations=function(n){var r=this,t=n.store(Bs.store),i=n.store(Qs.store);return t.loadAll().next(function(t){return yo.forEach(t,function(e){var t=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return i.loadAll(Qs.userMutationsIndex,t).next(function(t){return yo.forEach(t,function(t){Cr(t.userId===e.userId,"Cannot process batch "+t.batchId+" from unexpected user");t=r.serializer.fromDbMutationBatch(t);return Eo(n,e.userId,t).next(function(){})})})})})},xs.prototype.ensureSequenceNumbers=function(t){var o=t.store(tu.store),e=t.store(Hs.store);return Wo(t).next(function(r){var i=[];return e.iterate(function(t,e){var n=new Ei(t),t=[0,Bi(n)];i.push(o.get(t).next(function(t){return t?yo.resolve():o.put(new tu(0,Bi(n),r))}))}).next(function(){return yo.waitFor(i)})})},xs.prototype.createCollectionParentIndex=function(t,e){function r(t){if(i.add(t)){var e=t.lastSegment(),t=t.popLast();return n.put({collectionId:e,parent:Bi(t)})}}t.createObjectStore(iu.store,{keyPath:iu.keyPath});var n=e.store(iu.store),i=new _s;return e.store(Hs.store).iterate({keysOnly:!0},function(t,e){return r(new Ei(t).popLast())}).next(function(){return e.store(js.store).iterate({keysOnly:!0},function(t,e){t[0];var n=t[1];return r((t[2],Qi(n)).popLast())})})},xs);function xs(t){this.serializer=t}function qs(t,e){this.seconds=t,this.nanoseconds=e}var Fs=(Vs.store="owner",Vs.key="owner",Vs);function Vs(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}var Bs=(Us.store="mutationQueues",Us.keyPath="userId",Us);function Us(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}var Qs=(Ks.store="mutations",Ks.keyPath="batchId",Ks.userMutationsIndex="userMutationsIndex",Ks.userMutationsKeyPath=["userId","batchId"],Ks);function Ks(t,e,n,r,i){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=i}var js=(Ws.prefixForUser=function(t){return[t]},Ws.prefixForPath=function(t,e){return[t,Bi(e)]},Ws.key=function(t,e,n){return[t,Bi(e),n]},Ws.store="documentMutations",Ws.PLACEHOLDER=new Ws,Ws);function Ws(){}function Gs(t,e){this.path=t,this.readTime=e}function zs(t,e){this.path=t,this.version=e}var Hs=(Ys.store="remoteDocuments",Ys);function Ys(t,e,n,r){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=r}var Xs=(Js.store="remoteDocumentGlobal",Js.key="remoteDocumentGlobalKey",Js);function Js(t){this.byteSize=t}var $s=(Zs.store="targets",Zs.keyPath="targetId",Zs.queryTargetsIndexName="queryTargetsIndex",Zs.queryTargetsKeyPath=["canonicalId","targetId"],Zs);function Zs(t,e,n,r,i,o){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=i,this.query=o}var tu=(eu.store="targetDocuments",eu.keyPath=["targetId","path"],eu.documentTargetsIndex="documentTargetsIndex",eu.documentTargetsKeyPath=["path","targetId"],eu);function eu(t,e,n){this.targetId=t,this.path=e,Cr(0===t==(void 0!==(this.sequenceNumber=n)),"A target-document row must either have targetId == 0 and a defined sequence number, or a non-zero targetId and no sequence number")}var nu=(ru.key="targetGlobalKey",ru.store="targetGlobal",ru);function ru(t,e,n,r){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=r}var iu=(ou.store="collectionParents",ou.keyPath=["collectionId","parent"],ou);function ou(t,e){this.collectionId=t,this.parent=e}function au(t){t.createObjectStore(tu.store,{keyPath:tu.keyPath}).createIndex(tu.documentTargetsIndex,tu.documentTargetsKeyPath,{unique:!0}),t.createObjectStore($s.store,{keyPath:$s.keyPath}).createIndex($s.queryTargetsIndexName,$s.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(nu.store)}var su=(uu.store="remoteDocumentChanges",uu.keyPath="id",uu);function uu(t){this.changes=t}var cu=(hu.store="clientMetadata",hu.keyPath="clientId",hu);function hu(t,e,n,r,i){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=r,this.lastProcessedDocumentChangeId=i}var lu,fu=[Bs.store,Qs.store,js.store,Hs.store,$s.store,Fs.store,nu.store,tu.store].concat([cu.store,su.store]).concat([Xs.store]).concat([iu.store]),pu=(du.prototype.addToCollectionParentIndex=function(t,e){if(Cr(e.length%2==1,"Expected a collection path."),this.collectionParentsCache.add(e)){Cr(1<=e.length,"Invalid collection path.");var n=e.lastSegment(),e=e.popLast();return mu(t).put({collectionId:n,parent:Bi(e)})}return yo.resolve()},du.prototype.getCollectionParents=function(t,i){var o=[],e=IDBKeyRange.bound([i,""],[si(i),""],!1,!0);return mu(t).loadAll(e).next(function(t){for(var e=0,n=t;e<n.length;e++){var r=n[e];if(r.collectionId!==i)break;o.push(Qi(r.parent))}return o})},du);function du(){this.collectionParentsCache=new _s}function mu(t){return xu.getStore(t,iu.store)}(g=lu={})[g.Listen=0]="Listen",g[g.ExistenceFilterMismatch=1]="ExistenceFilterMismatch",g[g.LimboResolution=2]="LimboResolution";var yu=(gu.prototype.withSequenceNumber=function(t){return new gu(this.query,this.targetId,this.purpose,t,this.snapshotVersion,this.resumeToken)},gu.prototype.withResumeToken=function(t,e){return new gu(this.query,this.targetId,this.purpose,this.sequenceNumber,e,t)},gu.prototype.isEqual=function(t){return this.targetId===t.targetId&&this.purpose===t.purpose&&this.sequenceNumber===t.sequenceNumber&&this.snapshotVersion.isEqual(t.snapshotVersion)&&this.resumeToken===t.resumeToken&&this.query.isEqual(t.query)},gu);function gu(t,e,n,r,i,o){void 0===i&&(i=Wi.MIN),void 0===o&&(o=Ar()),this.query=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.resumeToken=o}var vu=(bu.prototype.fromDbRemoteDocument=function(t){if(t.document)return this.remoteSerializer.fromDocument(t.document,!!t.hasCommittedMutations);if(t.noDocument){var e=Ai.fromSegments(t.noDocument.path),n=this.fromDbTimestamp(t.noDocument.readTime);return new ls(e,n,{hasCommittedMutations:!!t.hasCommittedMutations})}return t.unknownDocument?(e=Ai.fromSegments(t.unknownDocument.path),n=this.fromDbTimestamp(t.unknownDocument.version),new ds(e,n)):Ir("Unexpected DbRemoteDocument")},bu.prototype.toDbRemoteDocument=function(t){if(t instanceof us){var e=t.proto||this.remoteSerializer.toDocument(t),n=t.hasCommittedMutations;return new Hs(null,null,e,n)}if(t instanceof ls){var r=t.key.path.toArray(),i=this.toDbTimestamp(t.version),n=t.hasCommittedMutations;return new Hs(null,new Gs(r,i),null,n)}return t instanceof ds?(r=t.key.path.toArray(),i=this.toDbTimestamp(t.version),new Hs(new zs(r,i),null,null,!0)):Ir("Unexpected MaybeDocumment")},bu.prototype.toDbTimestamp=function(t){t=t.toTimestamp();return new qs(t.seconds,t.nanoseconds)},bu.prototype.fromDbTimestamp=function(t){t=new Ki(t.seconds,t.nanoseconds);return Wi.fromTimestamp(t)},bu.prototype.toDbMutationBatch=function(t,e){var n=this,r=e.baseMutations.map(function(t){return n.remoteSerializer.toMutation(t)}),i=e.mutations.map(function(t){return n.remoteSerializer.toMutation(t)});return new Qs(t,e.batchId,e.localWriteTime.toMillis(),r,i)},bu.prototype.fromDbMutationBatch=function(t){var e=this,n=(t.baseMutations||[]).map(function(t){return e.remoteSerializer.fromMutation(t)}),r=t.mutations.map(function(t){return e.remoteSerializer.fromMutation(t)}),i=Ki.fromMillis(t.localWriteTimeMs);return new lo(t.batchId,i,n,r)},bu.prototype.toDbResourcePaths=function(t){var e=[];return t.forEach(function(t){e.push(Bi(t.path))}),e},bu.prototype.fromDbResourcePaths=function(t){for(var e=co(),n=0,r=t;n<r.length;n++)var i=r[n],e=e.add(new Ai(Qi(i)));return e},bu.prototype.fromDbTarget=function(t){var e=this.fromDbTimestamp(t.readTime),n=void 0!==t.query.documents?this.remoteSerializer.fromDocumentsTarget(t.query):this.remoteSerializer.fromQueryTarget(t.query);return new yu(n,t.targetId,lu.Listen,t.lastListenSequenceNumber,e,t.resumeToken)},bu.prototype.toDbTarget=function(t){Cr(lu.Listen===t.purpose,"Only queries with purpose "+lu.Listen+" may be stored, got "+t.purpose);var e=this.toDbTimestamp(t.snapshotVersion),n=t.query.isDocumentQuery()?this.remoteSerializer.toDocumentsTarget(t.query):this.remoteSerializer.toQueryTarget(t.query),r=t.resumeToken instanceof Uint8Array?(Cr("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence ."),t.resumeToken.toString()):t.resumeToken;return new $s(t.targetId,t.query.canonicalId(),e,r,t.sequenceNumber,n)},bu);function bu(t){this.remoteSerializer=t}function wu(t,e){var n=t[0],r=t[1],t=e[0],e=e[1],t=oi(n,t);return 0===t?oi(r,e):t}var Su=(Eu.prototype.nextIndex=function(){return++this.previousIndex},Eu.prototype.addElement=function(t){var e=[t,this.nextIndex()];this.buffer.size<this.maxElements?this.buffer=this.buffer.add(e):wu(e,t=this.buffer.last())<0&&(this.buffer=this.buffer.delete(t).add(e))},Object.defineProperty(Eu.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!0,configurable:!0}),Eu);function Eu(t){this.maxElements=t,this.buffer=new eo(wu),this.previousIndex=0}var Tu={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Iu=(Cu.withCacheSize=function(t){return new Cu(t,Cu.DEFAULT_COLLECTION_PERCENTILE,Cu.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)},Cu.COLLECTION_DISABLED=-1,Cu.MINIMUM_CACHE_SIZE_BYTES=1048576,Cu.DEFAULT=new Cu(Cu.DEFAULT_CACHE_SIZE_BYTES=41943040,Cu.DEFAULT_COLLECTION_PERCENTILE=10,Cu.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3),Cu.DISABLED=new Cu(Cu.COLLECTION_DISABLED,0,0),Cu);function Cu(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}var Du=(Nu.prototype.start=function(){Cr(null===this.gcTask,"Cannot start an already started LruScheduler"),this.garbageCollector.params.cacheSizeCollectionThreshold!==Iu.COLLECTION_DISABLED&&this.scheduleGC()},Nu.prototype.stop=function(){this.gcTask&&(this.gcTask.cancel(),this.gcTask=null)},Object.defineProperty(Nu.prototype,"started",{get:function(){return null!==this.gcTask},enumerable:!0,configurable:!0}),Nu.prototype.scheduleGC=function(){var t=this;Cr(null===this.gcTask,"Cannot schedule GC while a task is pending");var e=this.hasRun?3e5:6e4;Sr("LruGarbageCollector","Garbage collection scheduled in "+e+"ms"),this.gcTask=this.asyncQueue.enqueueAfterDelay(Mi.LruGarbageCollection,e,function(){return t.gcTask=null,t.hasRun=!0,t.localStore.collectGarbage(t.garbageCollector).then(function(){return t.scheduleGC()}).catch(Fu)})},Nu);function Nu(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.hasRun=!1,this.gcTask=null}var Au=(ku.prototype.calculateTargetCount=function(t,e){return this.delegate.getSequenceNumberCount(t).next(function(t){return Math.floor(e/100*t)})},ku.prototype.nthSequenceNumber=function(t,e){var n=this;if(0===e)return yo.resolve(gi.INVALID);var r=new Su(e);return this.delegate.forEachTarget(t,function(t){return r.addElement(t.sequenceNumber)}).next(function(){return n.delegate.forEachOrphanedDocumentSequenceNumber(t,function(t){return r.addElement(t)})}).next(function(){return r.maxValue})},ku.prototype.removeTargets=function(t,e,n){return this.delegate.removeTargets(t,e,n)},ku.prototype.removeOrphanedDocuments=function(t,e){return this.delegate.removeOrphanedDocuments(t,e)},ku.prototype.collect=function(e,n){var r=this;return this.params.cacheSizeCollectionThreshold===Iu.COLLECTION_DISABLED?(Sr("LruGarbageCollector","Garbage collection skipped; disabled"),yo.resolve(Tu)):this.getCacheSize(e).next(function(t){return t<r.params.cacheSizeCollectionThreshold?(Sr("LruGarbageCollector","Garbage collection skipped; Cache size "+t+" is lower than threshold "+r.params.cacheSizeCollectionThreshold),Tu):r.runGarbageCollection(e,n)})},ku.prototype.getCacheSize=function(t){return this.delegate.getCacheSize(t)},ku.prototype.runGarbageCollection=function(e,n){var r,i,o,a,s,u,c,h=this,l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(function(t){return i=t>h.params.maximumSequenceNumbersToCollect?(Sr("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of "+h.params.maximumSequenceNumbersToCollect+" from "+t),h.params.maximumSequenceNumbersToCollect):t,a=Date.now(),h.nthSequenceNumber(e,i)}).next(function(t){return r=t,s=Date.now(),h.removeTargets(e,r,n)}).next(function(t){return o=t,u=Date.now(),h.removeOrphanedDocuments(e,r)}).next(function(t){return c=Date.now(),br()<=hr.DEBUG&&Sr("LruGarbageCollector","LRU Garbage Collection\n\tCounted targets in "+(a-l)+"ms\n\tDetermined least recently used "+i+" in "+(s-a)+"ms\n\tRemoved "+o+" targets in "+(u-s)+"ms\n\tRemoved "+t+" documents in "+(c-u)+"ms\nTotal Duration: "+(c-l)+"ms"),yo.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:o,documentsRemoved:t})})},ku);function ku(t,e){this.delegate=t,this.params=e}var Ru,Mu="IndexedDbPersistence",_u="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",Ou="Another tab has exclusive access to the persistence layer. To allow shared access, make sure to invoke `enablePersistence()` with `synchronizeTabs:true` in all tabs.",Lu=(a(Pu,Ru=function(){}),Pu);function Pu(t,e){var n=Ru.call(this)||this;return n.simpleDbTransaction=t,n.currentSequenceNumber=e,n}var xu=(qu.getStore=function(t,e){if(t instanceof Lu)return Ro.getStore(t.simpleDbTransaction,e);throw Ir("IndexedDbPersistence must use instances of IndexedDbTransaction")},qu.createIndexedDbPersistence=function(n){return p(this,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:if(!qu.isAvailable())throw new Mr(Rr.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");return[4,(e=new qu(n.allowTabSynchronization,n.persistenceKey,n.clientId,n.platform,n.lruParams,n.queue,n.serializer,n.sequenceNumberSyncer)).start()];case 1:return t.sent(),[2,e]}})})},qu.prototype.start=function(){var e=this;return Cr(!this.started,"IndexedDbPersistence double-started!"),Cr(null!==this.window,"Expected 'window' to be defined"),Ro.openOrCreate(this.dbName,Ls,new Ps(this.serializer)).then(function(t){return e.simpleDb=t,e.updateClientMetadataAndTryBecomePrimary()}).then(function(){return e.attachVisibilityHandler(),e.attachWindowUnloadHook(),e.scheduleClientMetadataAndPrimaryLeaseRefreshes(),e.startRemoteDocumentCache()}).then(function(){return e.simpleDb.runTransaction("readonly",[nu.store],function(t){return Wo(t).next(function(t){e.listenSequence=new gi(t,e.sequenceNumberSyncer)})})}).then(function(){e._started=!0}).catch(function(t){return e.simpleDb&&e.simpleDb.close(),Promise.reject(t)})},qu.prototype.startRemoteDocumentCache=function(){var e=this;return this.simpleDb.runTransaction("readonly",fu,function(t){return e.remoteDocumentCache.start(t)})},qu.prototype.setPrimaryStateListener=function(n){var t=this;return this.primaryStateListener=function(e){return p(t,void 0,void 0,function(){return d(this,function(t){return this.started?[2,n(e)]:[2]})})},n(this.isPrimary)},qu.prototype.setDatabaseDeletedListener=function(n){var t=this;this.simpleDb.setVersionChangeListener(function(e){return p(t,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return null!==e.newVersion?[3,2]:[4,n()];case 1:t.sent(),t.label=2;case 2:return[2]}})})})},qu.prototype.setNetworkEnabled=function(t){var e=this;this.networkEnabled!==t&&(this.networkEnabled=t,this.queue.enqueueAndForget(function(){return p(e,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return this.started?[4,this.updateClientMetadataAndTryBecomePrimary()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})}))},qu.prototype.updateClientMetadataAndTryBecomePrimary=function(){var r=this;return this.simpleDb.runTransaction("readwrite",fu,function(n){return Bu(n).put(new cu(r.clientId,Date.now(),r.networkEnabled,r.inForeground,r.remoteDocumentCache.lastProcessedDocumentChangeId)).next(function(){if(r.isPrimary)return r.verifyPrimaryLease(n).next(function(t){t||(r.isPrimary=!1,r.queue.enqueueAndForget(function(){return r.primaryStateListener(!1)}))})}).next(function(){return r.canActAsPrimary(n)}).next(function(t){var e=r.isPrimary;return r.isPrimary=t,e!==r.isPrimary&&r.queue.enqueueAndForget(function(){return r.primaryStateListener(r.isPrimary)}),e&&!r.isPrimary?r.releasePrimaryLeaseIfHeld(n):r.isPrimary?r.acquireOrExtendPrimaryLease(n):void 0})})},qu.prototype.verifyPrimaryLease=function(t){var e=this;return Vu(t).get(Fs.key).next(function(t){return yo.resolve(e.isLocalClient(t))})},qu.prototype.removeClientMetadata=function(t){return Bu(t).delete(this.clientId)},qu.prototype.maybeGarbageCollectMultiClientState=function(){return p(this,void 0,void 0,function(){var r,i,o=this;return d(this,function(t){switch(t.label){case 0:return!this.isPrimary||this.isWithinAge(this.lastGarbageCollectionTime,18e5)?[3,2]:(this.lastGarbageCollectionTime=Date.now(),i=[],[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",function(e){var n=qu.getStore(e,cu.store);return n.loadAll().next(function(t){r=o.filterActiveClients(t,18e5),i=t.filter(function(t){return-1===r.indexOf(t)})}).next(function(){return yo.forEach(i,function(t){return n.delete(t.clientId)})}).next(function(){if(0<(r=r.filter(function(t){return t.clientId!==o.clientId})).length){var t=r.map(function(t){return t.lastProcessedDocumentChangeId||0}),t=Math.min.apply(Math,t);return o.remoteDocumentCache.removeDocumentChangesThroughChangeId(e,t)}})})]);case 1:t.sent(),i.forEach(function(t){o.window.localStorage.removeItem(o.zombiedClientLocalStorageKey(t.clientId))}),t.label=2;case 2:return[2]}})})},qu.prototype.scheduleClientMetadataAndPrimaryLeaseRefreshes=function(){var t=this;this.clientMetadataRefresher=this.queue.enqueueAfterDelay(Mi.ClientMetadataRefresh,4e3,function(){return t.updateClientMetadataAndTryBecomePrimary().then(function(){return t.maybeGarbageCollectMultiClientState()}).then(function(){return t.scheduleClientMetadataAndPrimaryLeaseRefreshes()})})},qu.prototype.isLocalClient=function(t){return!!t&&t.ownerId===this.clientId},qu.prototype.canActAsPrimary=function(e){var r=this;return Vu(e).get(Fs.key).next(function(t){if(null!==t&&r.isWithinAge(t.leaseTimestampMs,5e3)&&!r.isClientZombied(t.ownerId)){if(r.isLocalClient(t)&&r.networkEnabled)return!0;if(!r.isLocalClient(t)){if(!t.allowTabSynchronization)throw new Mr(Rr.FAILED_PRECONDITION,Ou);return!1}}return!(!r.networkEnabled||!r.inForeground)||Bu(e).loadAll().next(function(t){return void 0===r.filterActiveClients(t,5e3).find(function(t){if(r.clientId!==t.clientId){var e=!r.networkEnabled&&t.networkEnabled,n=!r.inForeground&&t.inForeground,t=r.networkEnabled===t.networkEnabled;if(e||n&&t)return!0}return!1})})}).next(function(t){return r.isPrimary!==t&&Sr(Mu,"Client "+(t?"is":"is not")+" eligible for a primary lease."),t})},qu.prototype.shutdown=function(){return p(this,void 0,void 0,function(){var e=this;return d(this,function(t){switch(t.label){case 0:return this._started=!1,this.markClientZombied(),this.clientMetadataRefresher&&(this.clientMetadataRefresher.cancel(),this.clientMetadataRefresher=null),this.detachVisibilityHandler(),this.detachWindowUnloadHook(),[4,this.simpleDb.runTransaction("readwrite",[Fs.store,cu.store],function(t){return e.releasePrimaryLeaseIfHeld(t).next(function(){return e.removeClientMetadata(t)})})];case 1:return t.sent(),this.simpleDb.close(),this.removeClientZombiedEntry(),[2]}})})},qu.prototype.filterActiveClients=function(t,e){var n=this;return t.filter(function(t){return n.isWithinAge(t.updateTimeMs,e)&&!n.isClientZombied(t.clientId)})},qu.prototype.getActiveClients=function(){var e=this;return this.simpleDb.runTransaction("readonly",[cu.store],function(t){return Bu(t).loadAll().next(function(t){return e.filterActiveClients(t,18e5).map(function(t){return t.clientId})})})},qu.clearPersistence=function(n){return p(this,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:return qu.isAvailable()?(e=n+qu.MAIN_DATABASE,[4,Ro.delete(e)]):[2,Promise.resolve()];case 1:return t.sent(),[2]}})})},Object.defineProperty(qu.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),qu.prototype.getMutationQueue=function(t){return Cr(this.started,"Cannot initialize MutationQueue before persistence is started."),bo.forUser(t,this.serializer,this.indexManager,this.referenceDelegate)},qu.prototype.getQueryCache=function(){return Cr(this.started,"Cannot initialize QueryCache before persistence is started."),this.queryCache},qu.prototype.getRemoteDocumentCache=function(){return Cr(this.started,"Cannot initialize RemoteDocumentCache before persistence is started."),this.remoteDocumentCache},qu.prototype.getIndexManager=function(){return Cr(this.started,"Cannot initialize IndexManager before persistence is started."),this.indexManager},qu.prototype.runTransaction=function(n,t,r){var i=this;return Sr(Mu,"Starting transaction:",n),this.simpleDb.runTransaction("readonly"===t?"readonly":"readwrite",fu,function(e){return"readwrite-primary"===t?i.verifyPrimaryLease(e).next(function(t){if(!t)throw Er("Failed to obtain primary lease for action '"+n+"'."),i.isPrimary=!1,i.queue.enqueueAndForget(function(){return i.primaryStateListener(!1)}),new Mr(Rr.FAILED_PRECONDITION,_u);return r(new Lu(e,i.listenSequence.next()))}).next(function(t){return i.acquireOrExtendPrimaryLease(e).next(function(){return t})}):i.verifyAllowTabSynchronization(e).next(function(){return r(new Lu(e,i.listenSequence.next()))})})},qu.prototype.verifyAllowTabSynchronization=function(t){var e=this;return Vu(t).get(Fs.key).next(function(t){if(null!==t&&e.isWithinAge(t.leaseTimestampMs,5e3)&&!e.isClientZombied(t.ownerId)&&!e.isLocalClient(t)&&!t.allowTabSynchronization)throw new Mr(Rr.FAILED_PRECONDITION,Ou)})},qu.prototype.acquireOrExtendPrimaryLease=function(t){var e=new Fs(this.clientId,this.allowTabSynchronization,Date.now());return Vu(t).put(Fs.key,e)},qu.isAvailable=function(){return Ro.isAvailable()},qu.buildStoragePrefix=function(t){var e=t.databaseId.projectId;return t.databaseId.isDefaultDatabase||(e+="."+t.databaseId.database),"firestore/"+t.persistenceKey+"/"+e+"/"},qu.prototype.releasePrimaryLeaseIfHeld=function(t){var e=this,n=Vu(t);return n.get(Fs.key).next(function(t){return e.isLocalClient(t)?(Sr(Mu,"Releasing primary lease."),n.delete(Fs.key)):yo.resolve()})},qu.prototype.isWithinAge=function(t,e){var n=Date.now();return!(t<n-e||n<t&&(Er("Detected an update time that is in the future: "+t+" > "+n),1))},qu.prototype.attachVisibilityHandler=function(){var t=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.documentVisibilityHandler=function(){t.queue.enqueueAndForget(function(){return t.inForeground="visible"===t.document.visibilityState,t.updateClientMetadataAndTryBecomePrimary()})},this.document.addEventListener("visibilitychange",this.documentVisibilityHandler),this.inForeground="visible"===this.document.visibilityState)},qu.prototype.detachVisibilityHandler=function(){this.documentVisibilityHandler&&(Cr(null!==this.document&&"function"==typeof this.document.addEventListener,"Expected 'document.addEventListener' to be a function"),this.document.removeEventListener("visibilitychange",this.documentVisibilityHandler),this.documentVisibilityHandler=null)},qu.prototype.attachWindowUnloadHook=function(){var t=this;"function"==typeof this.window.addEventListener&&(this.windowUnloadHandler=function(){t.markClientZombied(),t.queue.enqueueAndForget(function(){return t.shutdown()})},this.window.addEventListener("unload",this.windowUnloadHandler))},qu.prototype.detachWindowUnloadHook=function(){this.windowUnloadHandler&&(Cr("function"==typeof this.window.removeEventListener,"Expected 'window.removeEventListener' to be a function"),this.window.removeEventListener("unload",this.windowUnloadHandler),this.windowUnloadHandler=null)},qu.prototype.isClientZombied=function(t){try{var e=null!==this.webStorage.getItem(this.zombiedClientLocalStorageKey(t));return Sr(Mu,"Client '"+t+"' "+(e?"is":"is not")+" zombied in LocalStorage"),e}catch(t){return Er(Mu,"Failed to get zombied client id.",t),!1}},qu.prototype.markClientZombied=function(){try{this.webStorage.setItem(this.zombiedClientLocalStorageKey(this.clientId),String(Date.now()))}catch(t){Er("Failed to set zombie client id.",t)}},qu.prototype.removeClientZombiedEntry=function(){try{this.webStorage.removeItem(this.zombiedClientLocalStorageKey(this.clientId))}catch(t){}},qu.prototype.zombiedClientLocalStorageKey=function(t){return"firestore_zombie_"+this.persistenceKey+"_"+t},qu.MAIN_DATABASE="main",qu);function qu(t,e,n,r,i,o,a,s){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.queue=o,this.sequenceNumberSyncer=s,this._started=!1,this.isPrimary=!1,this.networkEnabled=!0,this.windowUnloadHandler=null,this.inForeground=!1,this.documentVisibilityHandler=null,this.clientMetadataRefresher=null,this.lastGarbageCollectionTime=Number.NEGATIVE_INFINITY,this.primaryStateListener=function(t){return Promise.resolve()},this.referenceDelegate=new Uu(this,i),this.dbName=e+qu.MAIN_DATABASE,this.serializer=new vu(a),this.document=r.document,this.queryCache=new Uo(this.referenceDelegate,this.serializer),this.indexManager=new pu,this.remoteDocumentCache=new Es(this.serializer,this.indexManager,this.allowTabSynchronization),!r.window||!r.window.localStorage)throw new Mr(Rr.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");this.window=r.window,this.webStorage=this.window.localStorage}function Fu(e){return p(this,void 0,void 0,function(){return d(this,function(t){if(e.code!==Rr.FAILED_PRECONDITION||e.message!==_u)throw e;return Sr(Mu,"Unexpectedly lost primary lease"),[2]})})}function Vu(t){return t.store(Fs.store)}function Bu(t){return t.store(cu.store)}var Uu=(Qu.prototype.getSequenceNumberCount=function(t){var n=this.orphanedDocmentCount(t);return this.db.getQueryCache().getQueryCount(t).next(function(e){return n.next(function(t){return e+t})})},Qu.prototype.orphanedDocmentCount=function(t){var e=0;return this.forEachOrphanedDocumentSequenceNumber(t,function(t){e++}).next(function(){return e})},Qu.prototype.forEachTarget=function(t,e){return this.db.getQueryCache().forEachTarget(t,e)},Qu.prototype.forEachOrphanedDocumentSequenceNumber=function(t,n){return this.forEachOrphanedDocument(t,function(t,e){return n(e)})},Qu.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},Qu.prototype.addReference=Ku,Qu.prototype.removeReference=Ku,Qu.prototype.removeTargets=function(t,e,n){return this.db.getQueryCache().removeTargets(t,e,n)},Qu.prototype.removeMutationReference=Ku,Qu.prototype.isPinned=function(t,e){return this.inMemoryPins.containsKey(e)?yo.resolve(!0):(r=e,i=!1,Do(n=t).iterateSerial(function(t){return So(n,t,r).next(function(t){return t&&(i=!0),yo.resolve(!t)})}).next(function(){return i}));var n,r,i},Qu.prototype.removeOrphanedDocuments=function(n,r){var i=this,o=this.db.getRemoteDocumentCache().newChangeBuffer(),a=[],s=0;return this.forEachOrphanedDocument(n,function(e,t){t<=r&&(t=i.isPinned(n,e).next(function(t){if(!t)return s++,o.getEntry(n,e).next(function(){return o.removeEntry(e),Go(n).delete([0,Bi(e.path)])})}),a.push(t))}).next(function(){return yo.waitFor(a)}).next(function(){return o.apply(n)}).next(function(){return s})},Qu.prototype.removeTarget=function(t,e){e=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getQueryCache().updateQueryData(t,e)},Qu.prototype.updateLimboDocument=Ku,Qu.prototype.forEachOrphanedDocument=function(t,r){var i,t=Go(t),o=gi.INVALID;return t.iterate({index:tu.documentTargetsIndex},function(t,e){var n=t[0],t=(t[1],e.path),e=e.sequenceNumber;0===n?(o!==gi.INVALID&&r(new Ai(Qi(i)),o),o=e,i=t):o=gi.INVALID}).next(function(){o!==gi.INVALID&&r(new Ai(Qi(i)),o)})},Qu.prototype.getCacheSize=function(t){return this.db.getRemoteDocumentCache().getSize(t)},Qu);function Qu(t,e){this.db=t,this.inMemoryPins=null,this.garbageCollector=new Au(this,e)}function Ku(t,e){return Go(t).put((t=t.currentSequenceNumber,new tu(0,Bi(e.path),t)))}var ju=(Wu.prototype.getDocument=function(e,n){var r=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(e,n).next(function(t){return r.getDocumentInternal(e,n,t)})},Wu.prototype.getDocumentInternal=function(t,r,i){return this.remoteDocumentCache.getEntry(t,r).next(function(t){for(var e=0,n=i;e<n.length;e++)t=n[e].applyToLocalView(r,t);return t})},Wu.prototype.applyLocalMutationsToDocuments=function(t,e,i){var o=oo;return e.forEach(function(t,e){for(var n=0,r=i;n<r.length;n++)e=r[n].applyToLocalView(t,e);o=o.insert(t,e)}),o},Wu.prototype.getDocuments=function(e,t){var n=this;return this.remoteDocumentCache.getEntries(e,t).next(function(t){return n.getLocalViewOfDocuments(e,t)})},Wu.prototype.getLocalViewOfDocuments=function(e,r){var i=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,r).next(function(t){var t=i.applyLocalMutationsToDocuments(e,r,t),n=oo;return t.forEach(function(t,e){e=e||new ls(t,Wi.forDeletedDoc()),n=n.insert(t,e)}),n})},Wu.prototype.getDocumentsMatchingQuery=function(t,e){return e.isDocumentQuery()?this.getDocumentsMatchingDocumentQuery(t,e.path):e.isCollectionGroupQuery()?this.getDocumentsMatchingCollectionGroupQuery(t,e):this.getDocumentsMatchingCollectionQuery(t,e)},Wu.prototype.getDocumentsMatchingDocumentQuery=function(t,e){return this.getDocument(t,new Ai(e)).next(function(t){var e=ao;return e=t instanceof us?ao.insert(t.key,t):e})},Wu.prototype.getDocumentsMatchingCollectionGroupQuery=function(e,n){var r=this;Cr(n.path.isEmpty(),"Currently we only support collection group queries at the root.");var i=n.collectionGroup,o=ao;return this.indexManager.getCollectionParents(e,i).next(function(t){return yo.forEach(t,function(t){t=n.asCollectionQueryAtPath(t.child(i));return r.getDocumentsMatchingCollectionQuery(e,t).next(function(t){t.forEach(function(t,e){o=o.insert(t,e)})})}).next(function(){return o})})},Wu.prototype.getDocumentsMatchingCollectionQuery=function(e,n){var c,h,r=this;return this.remoteDocumentCache.getDocumentsMatchingQuery(e,n).next(function(t){return c=t,r.mutationQueue.getAllMutationBatchesAffectingQuery(e,n)}).next(function(t){return h=t,r.addMissingBaseDocuments(e,h,c).next(function(t){c=t;for(var e=0,n=h;e<n.length;e++)for(var r=n[e],i=0,o=r.mutations;i<o.length;i++){var a=o[i],s=a.key,u=c.get(s),u=a.applyToLocalView(u,u,r.localWriteTime);c=u instanceof us?c.insert(s,u):c.remove(s)}})}).next(function(){return c.forEach(function(t,e){n.matches(e)||(c=c.remove(t))}),c})},Wu.prototype.addMissingBaseDocuments=function(t,e,n){for(var r=co(),i=0,o=e;i<o.length;i++)for(var a=0,s=o[i].mutations;a<s.length;a++){var u=s[a];u instanceof sa&&null===n.get(u.key)&&(r=r.add(u.key))}var c=n;return this.remoteDocumentCache.getEntries(t,r).next(function(t){return t.forEach(function(t,e){null!==e&&e instanceof us&&(c=c.insert(t,e))}),c})},Wu);function Wu(t,e,n){this.remoteDocumentCache=t,this.mutationQueue=e,this.indexManager=n}var Gu=(zu.prototype.isEmpty=function(){return this.refsByKey.isEmpty()},zu.prototype.addReference=function(t,e){e=new Hu(t,e);this.refsByKey=this.refsByKey.add(e),this.refsByTarget=this.refsByTarget.add(e)},zu.prototype.addReferences=function(t,e){var n=this;t.forEach(function(t){return n.addReference(t,e)})},zu.prototype.removeReference=function(t,e){this.removeRef(new Hu(t,e))},zu.prototype.removeReferences=function(t,e){var n=this;t.forEach(function(t){return n.removeReference(t,e)})},zu.prototype.removeReferencesForId=function(t){var e=this,n=Ai.EMPTY,r=new Hu(n,t),t=new Hu(n,t+1),i=[];return this.refsByTarget.forEachInRange([r,t],function(t){e.removeRef(t),i.push(t.key)}),i},zu.prototype.removeAllReferences=function(){var e=this;this.refsByKey.forEach(function(t){return e.removeRef(t)})},zu.prototype.removeRef=function(t){this.refsByKey=this.refsByKey.delete(t),this.refsByTarget=this.refsByTarget.delete(t)},zu.prototype.referencesForId=function(t){var e=Ai.EMPTY,n=new Hu(e,t),t=new Hu(e,t+1),r=co();return this.refsByTarget.forEachInRange([n,t],function(t){r=r.add(t.key)}),r},zu.prototype.containsKey=function(t){var e=new Hu(t,0),e=this.refsByKey.firstAfterOrEqual(e);return null!==e&&t.isEqual(e.key)},zu);function zu(){this.refsByKey=new eo(Hu.compareByKey),this.refsByTarget=new eo(Hu.compareByTargetId)}var Hu=(Yu.compareByKey=function(t,e){return Ai.comparator(t.key,e.key)||oi(t.targetOrBatchId,e.targetOrBatchId)},Yu.compareByTargetId=function(t,e){return oi(t.targetOrBatchId,e.targetOrBatchId)||Ai.comparator(t.key,e.key)},Yu);function Yu(t,e){this.key=t,this.targetOrBatchId=e}var Xu="LocalStore",Ju=($u.prototype.handleUserChange=function(e){var y=this;return this.persistence.runTransaction("Handle user change","readonly",function(d){var m;return y.mutationQueue.getAllMutationBatches(d).next(function(t){return m=t,y.mutationQueue=y.persistence.getMutationQueue(e),y.localDocuments=new ju(y.remoteDocuments,y.mutationQueue,y.persistence.getIndexManager()),y.mutationQueue.getAllMutationBatches(d)}).next(function(t){for(var e=[],n=[],r=co(),i=0,o=m;i<o.length;i++){var a=o[i];e.push(a.batchId);for(var s=0,u=a.mutations;s<u.length;s++)var c=u[s],r=r.add(c.key)}for(var h=0,l=t;h<l.length;h++){a=l[h],n.push(a.batchId);for(var f=0,p=a.mutations;f<p.length;f++)c=p[f],r=r.add(c.key)}return y.localDocuments.getDocuments(d,r).next(function(t){return{affectedDocuments:t,removedBatchIds:e,addedBatchIds:n}})})})},$u.prototype.localWrite=function(s){var u=this,c=Ki.now(),t=s.reduce(function(t,e){return t.add(e.key)},co());return this.persistence.runTransaction("Locally write mutations","readwrite",function(a){return u.localDocuments.getDocuments(a,t).next(function(n){for(var t=[],e=0,r=s;e<r.length;e++){var i=r[e],o=i.extractBaseValue(n.get(i.key));null!=o&&t.push(new sa(i.key,o,o.fieldMask(),Zo.exists(!0)))}return u.mutationQueue.addMutationBatch(a,c,t,s).next(function(t){var e=t.applyToLocalDocumentSet(n);return{batchId:t.batchId,changes:e}})})})},$u.prototype.lookupMutationDocuments=function(t){var n=this;return this.persistence.runTransaction("Lookup mutation documents","readonly",function(e){return n.mutationQueue.lookupMutationKeys(e,t).next(function(t){return t?n.localDocuments.getDocuments(e,t):yo.resolve(null)})})},$u.prototype.acknowledgeBatch=function(r){var i=this;return this.persistence.runTransaction("Acknowledge batch","readwrite-primary",function(t){var e=r.batch.keys(),n=i.remoteDocuments.newChangeBuffer();return i.mutationQueue.acknowledgeBatch(t,r.batch,r.streamToken).next(function(){return i.applyWriteToRemoteDocuments(t,r,n)}).next(function(){return n.apply(t)}).next(function(){return i.mutationQueue.performConsistencyCheck(t)}).next(function(){return i.localDocuments.getDocuments(t,e)})})},$u.prototype.rejectBatch=function(t){var r=this;return this.persistence.runTransaction("Reject batch","readwrite-primary",function(e){var n;return r.mutationQueue.lookupMutationBatch(e,t).next(function(t){return Cr(null!==t,"Attempt to reject nonexistent batch!"),n=t.keys(),r.mutationQueue.removeMutationBatch(e,t)}).next(function(){return r.mutationQueue.performConsistencyCheck(e)}).next(function(){return r.localDocuments.getDocuments(e,n)})})},$u.prototype.getHighestUnacknowledgedBatchId=function(){var e=this;return this.persistence.runTransaction("Get highest unacknowledged batch id","readonly",function(t){return e.mutationQueue.getHighestUnacknowledgedBatchId(t)})},$u.prototype.getLastStreamToken=function(){var e=this;return this.persistence.runTransaction("Get last stream token","readonly",function(t){return e.mutationQueue.getLastStreamToken(t)})},$u.prototype.setLastStreamToken=function(e){var n=this;return this.persistence.runTransaction("Set last stream token","readwrite-primary",function(t){return n.mutationQueue.setLastStreamToken(t,e)})},$u.prototype.getLastRemoteSnapshotVersion=function(){var e=this;return this.persistence.runTransaction("Get last remote snapshot version","readonly",function(t){return e.queryCache.getLastRemoteSnapshotVersion(t)})},$u.prototype.applyRemoteEvent=function(s){var u=this,c=this.remoteDocuments.newChangeBuffer(),h=s.snapshotVersion;return this.persistence.runTransaction("Apply remote event","readwrite-primary",function(i){var o=[];xr(s.targetChanges,function(t,e){var n,r=u.queryDataByTarget[t];r&&(o.push(u.queryCache.removeMatchingKeys(i,e.removedDocuments,t).next(function(){return u.queryCache.addMatchingKeys(i,e.addedDocuments,t)})),0<(n=e.resumeToken).length&&(n=r.withResumeToken(n,h),u.queryDataByTarget[t]=n,$u.shouldPersistQueryData(r,n,e)&&o.push(u.queryCache.updateQueryData(i,n))))});var t,a=oo,n=co();return s.documentUpdates.forEach(function(t,e){n=n.add(t)}),o.push(c.getEntries(i,n).next(function(r){s.documentUpdates.forEach(function(t,e){var n=r.get(t);e instanceof ls&&e.version.isEqual(Wi.MIN)?(c.removeEntry(t),a=a.insert(t,e)):null==n||0<e.version.compareTo(n.version)||0===e.version.compareTo(n.version)&&n.hasPendingWrites?(Wi.MIN.isEqual(s.snapshotVersion)&&Er(Xu,"Cannot add a document when the remote version is zero"),c.addEntry(e),a=a.insert(t,e)):Sr(Xu,"Ignoring outdated watch update for ",t,". Current version:",n.version," Watch version:",e.version),s.resolvedLimboDocuments.has(t)&&o.push(u.persistence.referenceDelegate.updateLimboDocument(i,t))})})),h.isEqual(Wi.MIN)||(t=u.queryCache.getLastRemoteSnapshotVersion(i).next(function(t){return Cr(0<=h.compareTo(t),"Watch stream reverted to previous snapshot?? "+h+" < "+t),u.queryCache.setTargetsMetadata(i,i.currentSequenceNumber,h)}),o.push(t)),yo.waitFor(o).next(function(){return c.apply(i)}).next(function(){return u.localDocuments.getLocalViewOfDocuments(i,a)})})},$u.shouldPersistQueryData=function(t,e,n){return Cr(0<e.resumeToken.length,"Attempted to persist query data with no resume token"),0===t.resumeToken.length||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=this.RESUME_TOKEN_MAX_AGE_MICROS||0<n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size},$u.prototype.notifyLocalViewChanges=function(t){var n=this;return this.persistence.runTransaction("notifyLocalViewChanges","readwrite",function(e){return yo.forEach(t,function(t){return n.localViewReferences.addReferences(t.addedKeys,t.targetId),n.localViewReferences.removeReferences(t.removedKeys,t.targetId),yo.forEach(t.removedKeys,function(t){return n.persistence.referenceDelegate.removeReference(e,t)})})})},$u.prototype.nextMutationBatch=function(e){var n=this;return this.persistence.runTransaction("Get next mutation batch","readonly",function(t){return void 0===e&&(e=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(t,e)})},$u.prototype.readDocument=function(e){var n=this;return this.persistence.runTransaction("read document","readonly",function(t){return n.localDocuments.getDocument(t,e)})},$u.prototype.allocateQuery=function(r){var i=this;return this.persistence.runTransaction("Allocate query","readwrite",function(e){var n;return i.queryCache.getQueryData(e,r).next(function(t){return t?(n=t,yo.resolve()):i.queryCache.allocateTargetId(e).next(function(t){return n=new yu(r,t,lu.Listen,e.currentSequenceNumber),i.queryCache.addQueryData(e,n)})}).next(function(){return Cr(!i.queryDataByTarget[n.targetId],"Tried to allocate an already allocated query: "+r),i.queryDataByTarget[n.targetId]=n})})},$u.prototype.releaseQuery=function(i,o){var a=this;return this.persistence.runTransaction("Release query",o?"readwrite":"readwrite-primary",function(r){return a.queryCache.getQueryData(r,i).next(function(t){Cr(null!=t,"Tried to release nonexistent query: "+i);var e=t.targetId,n=a.queryDataByTarget[e],t=a.localViewReferences.removeReferencesForId(e);return delete a.queryDataByTarget[e],o?yo.resolve():yo.forEach(t,function(t){return a.persistence.referenceDelegate.removeReference(r,t)}).next(function(){return a.persistence.referenceDelegate.removeTarget(r,n)})})})},$u.prototype.executeQuery=function(e){var n=this;return this.persistence.runTransaction("Execute query","readonly",function(t){return n.localDocuments.getDocumentsMatchingQuery(t,e)})},$u.prototype.remoteDocumentKeys=function(e){var n=this;return this.persistence.runTransaction("Remote document keys","readonly",function(t){return n.queryCache.getMatchingKeysForTargetId(t,e)})},$u.prototype.getActiveClients=function(){return this.persistence.getActiveClients()},$u.prototype.removeCachedMutationBatchMetadata=function(t){this.mutationQueue.removeCachedMutationKeys(t)},$u.prototype.setNetworkEnabled=function(t){this.persistence.setNetworkEnabled(t)},$u.prototype.applyWriteToRemoteDocuments=function(t,i,o){var e=this,a=i.batch,n=a.keys(),s=yo.resolve();return n.forEach(function(r){s=s.next(function(){return o.getEntry(t,r)}).next(function(t){var e=t,n=i.docVersions.get(r);Cr(null!==n,"ackVersions should contain every doc in the write."),(!e||e.version.compareTo(n)<0)&&((e=a.applyToRemoteDocument(r,e,i))?o.addEntry(e):Cr(!t,"Mutation batch "+a+" applied to document "+t+" resulted in null"))})}),s.next(function(){return e.mutationQueue.removeMutationBatch(t,a)})},$u.prototype.collectGarbage=function(e){var n=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary",function(t){return e.collect(t,n.queryDataByTarget)})},$u.prototype.getQueryForTarget=function(e){var n=this;return this.queryDataByTarget[e]?Promise.resolve(this.queryDataByTarget[e].query):this.persistence.runTransaction("Get query data","readonly",function(t){return n.queryCache.getQueryDataForTarget(t,e).next(function(t){return t?t.query:null})})},$u.prototype.getNewDocumentChanges=function(){var e=this;return this.persistence.runTransaction("Get new document changes","readonly",function(t){return e.remoteDocuments.getNewDocumentChanges(t)})},$u.RESUME_TOKEN_MAX_AGE_MICROS=3e8,$u);function $u(t,e){this.persistence=t,this.localViewReferences=new Gu,this.queryDataByTarget={},Cr(t.started,"LocalStore was passed an unstarted persistence implementation"),this.persistence.referenceDelegate.setInMemoryPins(this.localViewReferences),this.mutationQueue=t.getMutationQueue(e),this.remoteDocuments=t.getRemoteDocumentCache(),this.queryCache=t.getQueryCache(),this.localDocuments=new ju(this.remoteDocuments,this.mutationQueue,this.persistence.getIndexManager())}var Zu=(tc.prototype.checkEmpty=function(t){return yo.resolve(0===this.mutationQueue.length)},tc.prototype.acknowledgeBatch=function(t,e,n){var r=e.batchId,e=this.indexOfExistingBatchId(r,"acknowledged");Cr(0===e,"Can only acknowledge the first batch in the mutation queue");e=this.mutationQueue[e];return Cr(r===e.batchId,"Queue ordering failure: expected batch "+r+", got batch "+e.batchId),this.lastStreamToken=n,yo.resolve()},tc.prototype.getLastStreamToken=function(t){return yo.resolve(this.lastStreamToken)},tc.prototype.setLastStreamToken=function(t,e){return this.lastStreamToken=e,yo.resolve()},tc.prototype.addMutationBatch=function(t,e,n,r){Cr(0!==r.length,"Mutation batches should not be empty");var i=this.nextBatchId;this.nextBatchId++,0<this.mutationQueue.length&&Cr(this.mutationQueue[this.mutationQueue.length-1].batchId<i,"Mutation batchIDs must be monotonically increasing order");n=new lo(i,e,n,r);this.mutationQueue.push(n);for(var o=0,a=r;o<a.length;o++){var s=a[o];this.batchesByDocumentKey=this.batchesByDocumentKey.add(new Hu(s.key,i)),this.indexManager.addToCollectionParentIndex(t,s.key.path.popLast())}return yo.resolve(n)},tc.prototype.lookupMutationBatch=function(t,e){return yo.resolve(this.findMutationBatch(e))},tc.prototype.lookupMutationKeys=function(t,e){e=this.findMutationBatch(e);return Cr(null!=e,"Failed to find local mutation batch."),yo.resolve(e.keys())},tc.prototype.getNextMutationBatchAfterBatchId=function(t,e){e=this.indexOfBatchId(e+1),e=e<0?0:e;return yo.resolve(this.mutationQueue.length>e?this.mutationQueue[e]:null)},tc.prototype.getHighestUnacknowledgedBatchId=function(){return yo.resolve(0===this.mutationQueue.length?-1:this.nextBatchId-1)},tc.prototype.getAllMutationBatches=function(t){return yo.resolve(this.mutationQueue.slice())},tc.prototype.getAllMutationBatchesAffectingDocumentKey=function(t,e){var n=this,r=new Hu(e,0),i=new Hu(e,Number.POSITIVE_INFINITY),o=[];return this.batchesByDocumentKey.forEachInRange([r,i],function(t){Cr(e.isEqual(t.key),"Should only iterate over a single key's batches");t=n.findMutationBatch(t.targetOrBatchId);Cr(null!==t,"Batches in the index must exist in the main table"),o.push(t)}),yo.resolve(o)},tc.prototype.getAllMutationBatchesAffectingDocumentKeys=function(t,e){var r=this,i=new eo(oi);return e.forEach(function(e){var t=new Hu(e,0),n=new Hu(e,Number.POSITIVE_INFINITY);r.batchesByDocumentKey.forEachInRange([t,n],function(t){Cr(e.isEqual(t.key),"For each key, should only iterate over a single key's batches"),i=i.add(t.targetOrBatchId)})}),yo.resolve(this.findMutationBatches(i))},tc.prototype.getAllMutationBatchesAffectingQuery=function(t,e){Cr(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var n=e.path,r=n.length+1,e=n;Ai.isDocumentKey(e)||(e=e.child(""));var e=new Hu(new Ai(e),0),i=new eo(oi);return this.batchesByDocumentKey.forEachWhile(function(t){var e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(i=i.add(t.targetOrBatchId)),!0)},e),yo.resolve(this.findMutationBatches(i))},tc.prototype.findMutationBatches=function(t){var e=this,n=[];return t.forEach(function(t){t=e.findMutationBatch(t);null!==t&&n.push(t)}),n},tc.prototype.removeMutationBatch=function(n,r){var i=this;Cr(0===this.indexOfExistingBatchId(r.batchId,"removed"),"Can only remove the first entry of the mutation queue"),this.mutationQueue.shift();var o=this.batchesByDocumentKey;return yo.forEach(r.mutations,function(t){var e=new Hu(t.key,r.batchId);return o=o.delete(e),i.referenceDelegate.removeMutationReference(n,t.key)}).next(function(){i.batchesByDocumentKey=o})},tc.prototype.removeCachedMutationKeys=function(t){},tc.prototype.containsKey=function(t,e){var n=new Hu(e,0),n=this.batchesByDocumentKey.firstAfterOrEqual(n);return yo.resolve(e.isEqual(n&&n.key))},tc.prototype.performConsistencyCheck=function(t){return 0===this.mutationQueue.length&&Cr(this.batchesByDocumentKey.isEmpty(),"Document leak -- detected dangling mutation references when queue is empty."),yo.resolve()},tc.prototype.indexOfExistingBatchId=function(t,e){t=this.indexOfBatchId(t);return Cr(0<=t&&t<this.mutationQueue.length,"Batches must exist to be "+e),t},tc.prototype.indexOfBatchId=function(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId},tc.prototype.findMutationBatch=function(t){var e=this.indexOfBatchId(t);if(e<0||e>=this.mutationQueue.length)return null;e=this.mutationQueue[e];return Cr(e.batchId===t,"If found batch must match"),e},tc);function tc(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.nextBatchId=1,this.lastStreamToken=Ar(),this.batchesByDocumentKey=new eo(Hu.compareByKey)}var ec=(nc.prototype.getTargetCount=function(t){return yo.resolve(this.targetCount)},nc.prototype.forEachTarget=function(t,n){return this.queries.forEach(function(t,e){return n(e)}),yo.resolve()},nc.prototype.getLastRemoteSnapshotVersion=function(t){return yo.resolve(this.lastRemoteSnapshotVersion)},nc.prototype.getHighestSequenceNumber=function(t){return yo.resolve(this.highestSequenceNumber)},nc.prototype.allocateTargetId=function(t){var e=this.targetIdGenerator.after(this.highestTargetId);return this.highestTargetId=e,yo.resolve(e)},nc.prototype.setTargetsMetadata=function(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.highestSequenceNumber&&(this.highestSequenceNumber=e),yo.resolve()},nc.prototype.saveQueryData=function(t){this.queries.set(t.query,t);var e=t.targetId;e>this.highestTargetId&&(this.highestTargetId=e),t.sequenceNumber>this.highestSequenceNumber&&(this.highestSequenceNumber=t.sequenceNumber)},nc.prototype.addQueryData=function(t,e){return Cr(!this.queries.has(e.query),"Adding a query that already exists"),this.saveQueryData(e),this.targetCount+=1,yo.resolve()},nc.prototype.updateQueryData=function(t,e){return Cr(this.queries.has(e.query),"Updating a non-existent query"),this.saveQueryData(e),yo.resolve()},nc.prototype.removeQueryData=function(t,e){return Cr(0<this.targetCount,"Removing a target from an empty cache"),Cr(this.queries.has(e.query),"Removing a non-existent target from the cache"),this.queries.delete(e.query),this.references.removeReferencesForId(e.targetId),--this.targetCount,yo.resolve()},nc.prototype.removeTargets=function(n,r,i){var o=this,a=0,s=[];return this.queries.forEach(function(t,e){e.sequenceNumber<=r&&!i[e.targetId]&&(o.queries.delete(t),s.push(o.removeMatchingKeysForTargetId(n,e.targetId)),a++)}),yo.waitFor(s).next(function(){return a})},nc.prototype.getQueryCount=function(t){return yo.resolve(this.targetCount)},nc.prototype.getQueryData=function(t,e){e=this.queries.get(e)||null;return yo.resolve(e)},nc.prototype.getQueryDataForTarget=function(t,e){return Ir("Not yet implemented.")},nc.prototype.addMatchingKeys=function(e,t,n){this.references.addReferences(t,n);var r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(function(t){i.push(r.addReference(e,t))}),yo.waitFor(i)},nc.prototype.removeMatchingKeys=function(e,t,n){this.references.removeReferences(t,n);var r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(function(t){i.push(r.removeReference(e,t))}),yo.waitFor(i)},nc.prototype.removeMatchingKeysForTargetId=function(t,e){return this.references.removeReferencesForId(e),yo.resolve()},nc.prototype.getMatchingKeysForTargetId=function(t,e){e=this.references.referencesForId(e);return yo.resolve(e)},nc.prototype.containsKey=function(t,e){return yo.resolve(this.references.containsKey(e))},nc);function nc(t){this.persistence=t,this.queries=new ys(function(t){return t.canonicalId()}),this.lastRemoteSnapshotVersion=Wi.MIN,this.highestTargetId=0,this.highestSequenceNumber=0,this.references=new Gu,this.targetCount=0,this.targetIdGenerator=No.forQueryCache()}var rc,ic=(oc.prototype.addEntry=function(t,e){var n=e.key,r=this.docs.get(n),i=r?r.size:0,r=this.sizer(e);return this.docs=this.docs.insert(n,{maybeDocument:e,size:r}),this.newDocumentChanges=this.newDocumentChanges.add(n),this.size+=r-i,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())},oc.prototype.removeEntry=function(t){var e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)},oc.prototype.getEntry=function(t,e){e=this.docs.get(e);return yo.resolve(e?e.maybeDocument:null)},oc.prototype.getEntries=function(t,e){var n=this,r=oo;return e.forEach(function(t){var e=n.docs.get(t);r=r.insert(t,e?e.maybeDocument:null)}),yo.resolve(r)},oc.prototype.getDocumentsMatchingQuery=function(t,e){Cr(!e.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");for(var n=ao,r=new Ai(e.path.child("")),i=this.docs.getIteratorFrom(r);i.hasNext();){var o=i.getNext(),a=o.key,o=o.value.maybeDocument;if(!e.path.isPrefixOf(a.path))break;o instanceof us&&e.matches(o)&&(n=n.insert(o.key,o))}return yo.resolve(n)},oc.prototype.forEachDocumentKey=function(t,e){return yo.forEach(this.docs,function(t){return e(t)})},oc.prototype.getNewDocumentChanges=function(t){var n=this,r=oo;return this.newDocumentChanges.forEach(function(t){var e=n.docs.get(t),e=e?e.maybeDocument:new ls(t,Wi.forDeletedDoc());r=r.insert(t,e)}),this.newDocumentChanges=co(),yo.resolve(r)},oc.prototype.newChangeBuffer=function(){return new oc.RemoteDocumentChangeBuffer(this)},oc.prototype.getSize=function(t){return yo.resolve(this.size)},oc.RemoteDocumentChangeBuffer=(a(ac,rc=vs),ac.prototype.applyChanges=function(n){var r=this,i=[];return this.changes.forEach(function(t,e){e?i.push(r.documentCache.addEntry(n,e)):r.documentCache.removeEntry(t)}),yo.waitFor(i)},ac.prototype.getFromCache=function(t,e){return this.documentCache.getEntry(t,e)},ac.prototype.getAllFromCache=function(t,e){return this.documentCache.getEntries(t,e)},ac),oc);function oc(t,e){this.indexManager=t,this.sizer=e,this.docs=new zi(Ai.comparator),this.newDocumentChanges=co(),this.size=0}function ac(t){var e=rc.call(this)||this;return e.documentCache=t,e}var sc=(uc.createLruPersistence=function(t,e,n){return new uc(t,function(t){return new fc(t,new vu(e),n)})},uc.createEagerPersistence=function(t){return new uc(t,function(t){return new hc(t)})},uc.prototype.shutdown=function(){return this._started=!1,Promise.resolve()},Object.defineProperty(uc.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),uc.prototype.getActiveClients=function(){return p(this,void 0,void 0,function(){return d(this,function(t){return[2,[this.clientId]]})})},uc.prototype.setPrimaryStateListener=function(t){return t(!0)},uc.prototype.setDatabaseDeletedListener=function(){},uc.prototype.setNetworkEnabled=function(t){},uc.prototype.getIndexManager=function(){return this.indexManager},uc.prototype.getMutationQueue=function(t){var e=this.mutationQueues[t.toKey()];return e||(e=new Zu(this.indexManager,this.referenceDelegate),this.mutationQueues[t.toKey()]=e),e},uc.prototype.getQueryCache=function(){return this.queryCache},uc.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache},uc.prototype.runTransaction=function(t,e,n){var r=this;Sr("MemoryPersistence","Starting transaction:",t);var i=new cc(this.listenSequence.next());return this.referenceDelegate.onTransactionStarted(),n(i).next(function(t){return r.referenceDelegate.onTransactionCommitted(i).next(function(){return t})}).toPromise()},uc.prototype.mutationQueuesContainKey=function(e,n){return yo.or((t=this.mutationQueues,r=[],qr(t,function(t,e){return r.push(e)}),r.map(function(t){return function(){return t.containsKey(e,n)}})));var t,r},uc);function uc(t,e){var n=this;this.clientId=t,this.mutationQueues={},this.listenSequence=new gi(0),this._started=!1,this._started=!0,this.referenceDelegate=e(this),this.queryCache=new ec(this),this.indexManager=new Rs,this.remoteDocumentCache=new ic(this.indexManager,function(t){return n.referenceDelegate.documentSize(t)})}var cc=function(t){this.currentSequenceNumber=t},hc=(Object.defineProperty(lc.prototype,"orphanedDocuments",{get:function(){if(this._orphanedDocuments)return this._orphanedDocuments;throw Ir("orphanedDocuments is only valid during a transaction.")},enumerable:!0,configurable:!0}),lc.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},lc.prototype.addReference=function(t,e){return this.orphanedDocuments.delete(e),yo.resolve()},lc.prototype.removeReference=function(t,e){return this.orphanedDocuments.add(e),yo.resolve()},lc.prototype.removeMutationReference=function(t,e){return this.orphanedDocuments.add(e),yo.resolve()},lc.prototype.removeTarget=function(t,e){var n=this,r=this.persistence.getQueryCache();return r.getMatchingKeysForTargetId(t,e.targetId).next(function(t){t.forEach(function(t){return n.orphanedDocuments.add(t)})}).next(function(){return r.removeQueryData(t,e)})},lc.prototype.onTransactionStarted=function(){this._orphanedDocuments=new Set},lc.prototype.onTransactionCommitted=function(t){var n=this,r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return yo.forEach(this.orphanedDocuments,function(e){return n.isReferenced(t,e).next(function(t){t||r.removeEntry(e)})}).next(function(){return n._orphanedDocuments=null,r.apply(t)})},lc.prototype.updateLimboDocument=function(t,e){var n=this;return this.isReferenced(t,e).next(function(t){t?n.orphanedDocuments.delete(e):n.orphanedDocuments.add(e)})},lc.prototype.documentSize=function(t){return 0},lc.prototype.isReferenced=function(t,e){var n=this;return yo.or([function(){return n.persistence.getQueryCache().containsKey(t,e)},function(){return n.persistence.mutationQueuesContainKey(t,e)},function(){return yo.resolve(n.inMemoryPins.containsKey(e))}])},lc);function lc(t){this.persistence=t,this.inMemoryPins=null,this._orphanedDocuments=null}var fc=(pc.prototype.onTransactionStarted=function(){},pc.prototype.onTransactionCommitted=function(t){return yo.resolve()},pc.prototype.forEachTarget=function(t,e){return this.persistence.getQueryCache().forEachTarget(t,e)},pc.prototype.getSequenceNumberCount=function(t){var n=this.orphanedDocumentCount(t);return this.persistence.getQueryCache().getTargetCount(t).next(function(e){return n.next(function(t){return e+t})})},pc.prototype.orphanedDocumentCount=function(t){var e=0;return this.forEachOrphanedDocumentSequenceNumber(t,function(t){e++}).next(function(){return e})},pc.prototype.forEachOrphanedDocumentSequenceNumber=function(n,r){var i=this;return yo.forEach(this.orphanedSequenceNumbers,function(t,e){return i.isPinned(n,t,e).next(function(t){return t?yo.resolve():r(e)})})},pc.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},pc.prototype.removeTargets=function(t,e,n){return this.persistence.getQueryCache().removeTargets(t,e,n)},pc.prototype.removeOrphanedDocuments=function(t,n){var r=this,i=0,e=this.persistence.getRemoteDocumentCache(),o=e.newChangeBuffer();return e.forEachDocumentKey(t,function(e){return r.isPinned(t,e,n).next(function(t){t||(i++,o.removeEntry(e))})}).next(function(){return o.apply(t)}).next(function(){return i})},pc.prototype.removeMutationReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),yo.resolve()},pc.prototype.removeTarget=function(t,e){e=e.withSequenceNumber(t.currentSequenceNumber);return this.persistence.getQueryCache().updateQueryData(t,e)},pc.prototype.addReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),yo.resolve()},pc.prototype.removeReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),yo.resolve()},pc.prototype.updateLimboDocument=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),yo.resolve()},pc.prototype.documentSize=function(t){var e,t=this.serializer.toDbRemoteDocument(t);if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw Ir("Unknown remote document type");e=t.noDocument}return JSON.stringify(e).length},pc.prototype.isPinned=function(t,e,n){var r=this;return yo.or([function(){return r.persistence.mutationQueuesContainKey(t,e)},function(){return yo.resolve(r.inMemoryPins.containsKey(e))},function(){return r.persistence.getQueryCache().containsKey(t,e)},function(){var t=r.orphanedSequenceNumbers.get(e);return yo.resolve(void 0!==t&&n<t)}])},pc.prototype.getCacheSize=function(t){return this.persistence.getRemoteDocumentCache().getSize(t)},pc);function pc(t,e,n){this.persistence=t,this.serializer=e,this.inMemoryPins=null,this.orphanedSequenceNumbers=new ys(function(t){return Bi(t.path)}),this.garbageCollector=new Au(this,n)}var ct=Number,dc=ct.MIN_SAFE_INTEGER||-(Math.pow(2,53)-1),mc=ct.MAX_SAFE_INTEGER||Math.pow(2,53)-1,yc=ct.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t};function gc(t){return null==t}function vc(t){return yc(t)&&t<=mc&&dc<=t}var bc=(wc.prototype.reset=function(){this.currentBaseMs=0},wc.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs},wc.prototype.backoffAndRun=function(t){var e=this;this.cancel();var n=Math.floor(this.currentBaseMs+this.jitterDelayMs()),r=Math.max(0,Date.now()-this.lastAttemptTime),i=Math.max(0,n-r);0<this.currentBaseMs&&Sr("ExponentialBackoff","Backing off for "+i+" ms (base delay: "+this.currentBaseMs+" ms, delay with jitter: "+n+" ms, last attempt: "+r+" ms ago)"),this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,i,function(){return e.lastAttemptTime=Date.now(),t()}),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<this.initialDelayMs&&(this.currentBaseMs=this.initialDelayMs),this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs)},wc.prototype.cancel=function(){null!==this.timerPromise&&(this.timerPromise.cancel(),this.timerPromise=null)},wc.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs},wc);function wc(t,e,n,r,i){void 0===n&&(n=1e3),void 0===r&&(r=1.5),void 0===i&&(i=6e4),this.queue=t,this.timerId=e,this.initialDelayMs=n,this.backoffFactor=r,this.maxDelayMs=i,this.currentBaseMs=0,this.timerPromise=null,this.lastAttemptTime=Date.now(),this.reset()}var Sc,Ec="PersistentStream";(Zi=Sc={})[Zi.Initial=0]="Initial",Zi[Zi.Starting=1]="Starting",Zi[Zi.Open=2]="Open",Zi[Zi.Error=3]="Error",Zi[Zi.Backoff=4]="Backoff";Tc.prototype.isStarted=function(){return this.state===Sc.Starting||this.state===Sc.Open||this.state===Sc.Backoff},Tc.prototype.isOpen=function(){return this.state===Sc.Open},Tc.prototype.start=function(){this.state!==Sc.Error?(Cr(this.state===Sc.Initial,"Already started"),this.auth()):this.performBackoff()},Tc.prototype.stop=function(){return p(this,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return this.isStarted()?[4,this.close(Sc.Initial)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},Tc.prototype.inhibitBackoff=function(){Cr(!this.isStarted(),"Can only inhibit backoff in a stopped state"),this.state=Sc.Initial,this.backoff.reset()},Tc.prototype.markIdle=function(){var t=this;this.isOpen()&&null===this.idleTimer&&(this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,6e4,function(){return t.handleIdleCloseTimer()}))},Tc.prototype.sendRequest=function(t){this.cancelIdleCheck(),this.stream.send(t)},Tc.prototype.handleIdleCloseTimer=function(){return p(this,void 0,void 0,function(){return d(this,function(t){return this.isOpen()?[2,this.close(Sc.Initial)]:[2]})})},Tc.prototype.cancelIdleCheck=function(){this.idleTimer&&(this.idleTimer.cancel(),this.idleTimer=null)},Tc.prototype.close=function(e,n){return p(this,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return Cr(this.isStarted(),"Only started streams should be closed."),Cr(e===Sc.Error||gc(n),"Can't provide an error when not in an error state."),this.cancelIdleCheck(),this.backoff.cancel(),this.closeCount++,e!==Sc.Error?this.backoff.reset():n&&n.code===Rr.RESOURCE_EXHAUSTED?(Er(n.toString()),Er("Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()):n&&n.code===Rr.UNAUTHENTICATED&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=e,[4,this.listener.onClose(n)];case 1:return t.sent(),[2]}})})},Tc.prototype.tearDown=function(){},Tc.prototype.auth=function(){var n=this;Cr(this.state===Sc.Initial,"Must be in initial state to auth"),this.state=Sc.Starting;var t=this.getCloseGuardedDispatcher(this.closeCount),e=this.closeCount;this.credentialsProvider.getToken().then(function(t){n.closeCount===e&&n.startStream(t)},function(e){t(function(){var t=new Mr(Rr.UNKNOWN,"Fetching auth token failed: "+e.message);return n.handleStreamClose(t)})})},Tc.prototype.startStream=function(t){var e=this;Cr(this.state===Sc.Starting,"Trying to start stream in a non-starting state");var n=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(t),this.stream.onOpen(function(){n(function(){return Cr(e.state===Sc.Starting,"Expected stream to be in state Starting, but was "+e.state),e.state=Sc.Open,e.listener.onOpen()})}),this.stream.onClose(function(t){n(function(){return e.handleStreamClose(t)})}),this.stream.onMessage(function(t){n(function(){return e.onMessage(t)})})},Tc.prototype.performBackoff=function(){var t=this;Cr(this.state===Sc.Error,"Should only perform backoff when in Error state"),this.state=Sc.Backoff,this.backoff.backoffAndRun(function(){return p(t,void 0,void 0,function(){return d(this,function(t){return Cr(this.state===Sc.Backoff,"Backoff elapsed but state is now: "+this.state),this.state=Sc.Initial,this.start(),Cr(this.isStarted(),"PersistentStream should have started"),[2]})})})},Tc.prototype.handleStreamClose=function(t){return Cr(this.isStarted(),"Can't handle server close on non-started stream"),Sr(Ec,"close with error: "+t),this.stream=null,this.close(Sc.Error,t)},Tc.prototype.getCloseGuardedDispatcher=function(e){var n=this;return function(t){n.queue.enqueueAndForget(function(){return n.closeCount===e?t():(Sr(Ec,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())})}},me=Tc;function Tc(t,e,n,r,i,o){this.queue=t,this.idleTimerId=n,this.connection=r,this.credentialsProvider=i,this.listener=o,this.state=Sc.Initial,this.closeCount=0,this.idleTimer=null,this.stream=null,this.backoff=new bc(t,e)}var Ic,Cc=(a(Dc,Ic=me),Dc.prototype.startRpc=function(t){return this.connection.openStream("Listen",t)},Dc.prototype.onMessage=function(t){this.backoff.reset();var e=this.serializer.fromWatchChange(t),t=this.serializer.versionFromListenResponse(t);return this.listener.onWatchChange(e,t)},Dc.prototype.watch=function(t){var e={};e.database=this.serializer.encodedDatabaseId,e.addTarget=this.serializer.toTarget(t);t=this.serializer.toListenRequestLabels(t);t&&(e.labels=t),this.sendRequest(e)},Dc.prototype.unwatch=function(t){var e={};e.database=this.serializer.encodedDatabaseId,e.removeTarget=t,this.sendRequest(e)},Dc);function Dc(t,e,n,r,i){i=Ic.call(this,t,Mi.ListenStreamConnectionBackoff,Mi.ListenStreamIdle,e,n,i)||this;return i.serializer=r,i}var Nc,Ac=(a(kc,Nc=me),Object.defineProperty(kc.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:!0,configurable:!0}),kc.prototype.start=function(){this.handshakeComplete_=!1,Nc.prototype.start.call(this)},kc.prototype.tearDown=function(){this.handshakeComplete_&&this.writeMutations([])},kc.prototype.startRpc=function(t){return this.connection.openStream("Write",t)},kc.prototype.onMessage=function(t){if(Cr(!!t.streamToken,"Got a write response without a stream token"),this.lastStreamToken=t.streamToken,this.handshakeComplete_){this.backoff.reset();var e=this.serializer.fromWriteResults(t.writeResults,t.commitTime),n=this.serializer.fromVersion(t.commitTime);return this.listener.onMutationResult(n,e)}return Cr(!t.writeResults||0===t.writeResults.length,"Got mutation results for handshake"),this.handshakeComplete_=!0,this.listener.onHandshakeComplete()},kc.prototype.writeHandshake=function(){Cr(this.isOpen(),"Writing handshake requires an opened stream"),Cr(!this.handshakeComplete_,"Handshake already completed");var t={};t.database=this.serializer.encodedDatabaseId,this.sendRequest(t)},kc.prototype.writeMutations=function(t){var e=this;Cr(this.isOpen(),"Writing mutations requires an opened stream"),Cr(this.handshakeComplete_,"Handshake must be complete before writing mutations"),Cr(0<this.lastStreamToken.length,"Trying to write mutation without a token");t={streamToken:this.lastStreamToken,writes:t.map(function(t){return e.serializer.toMutation(t)})};this.sendRequest(t)},kc);function kc(t,e,n,r,i){i=Nc.call(this,t,Mi.WriteStreamConnectionBackoff,Mi.WriteStreamIdle,e,n,i)||this;return i.serializer=r,i.handshakeComplete_=!1,i.lastStreamToken=Ar(),i}var Rc=(Mc.prototype.newPersistentWriteStream=function(t){return new Ac(this.queue,this.connection,this.credentials,this.serializer,t)},Mc.prototype.newPersistentWatchStream=function(t){return new Cc(this.queue,this.connection,this.credentials,this.serializer,t)},Mc.prototype.commit=function(t){var e=this,t={database:this.serializer.encodedDatabaseId,writes:t.map(function(t){return e.serializer.toMutation(t)})};return this.invokeRPC("Commit",t).then(function(t){return e.serializer.fromWriteResults(t.writeResults,t.commitTime)})},Mc.prototype.lookup=function(e){var i=this,t={database:this.serializer.encodedDatabaseId,documents:e.map(function(t){return i.serializer.toName(t)})};return this.invokeStreamingRPC("BatchGetDocuments",t).then(function(t){var n=oo;t.forEach(function(t){t=i.serializer.fromMaybeDocument(t);n=n.insert(t.key,t)});var r=[];return e.forEach(function(t){var e=n.get(t);Cr(!!e,"Missing entity in write response for "+t),r.push(e)}),r})},Mc.prototype.invokeRPC=function(e,n){var r=this;return this.credentials.getToken().then(function(t){return r.connection.invokeRPC(e,n,t)}).catch(function(t){throw t.code===Rr.UNAUTHENTICATED&&r.credentials.invalidateToken(),t})},Mc.prototype.invokeStreamingRPC=function(e,n){var r=this;return this.credentials.getToken().then(function(t){return r.connection.invokeStreamingRPC(e,n,t)}).catch(function(t){throw t.code===Rr.UNAUTHENTICATED&&r.credentials.invalidateToken(),t})},Mc);function Mc(t,e,n,r){this.queue=t,this.connection=e,this.credentials=n,this.serializer=r}var _c,Oc,Lc=(Pc.prototype.lookup=function(r){return p(this,void 0,void 0,function(){var e,n=this;return d(this,function(t){switch(t.label){case 0:if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new Mr(Rr.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");return[4,this.datastore.lookup(r)];case 1:return(e=t.sent()).forEach(function(t){t instanceof ls||t instanceof us?n.recordVersion(t):Ir("Document in a transaction was a "+t.constructor.name)}),[2,e]}})})},Pc.prototype.set=function(t,e){this.write(e.toMutations(t,this.precondition(t))),this.writtenDocs.add(t)},Pc.prototype.update=function(t,e){try{this.write(e.toMutations(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t)},Pc.prototype.delete=function(t){this.write([new ma(t,this.precondition(t))]),this.writtenDocs.add(t)},Pc.prototype.commit=function(){return p(this,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;if(e=this.readVersions,this.mutations.forEach(function(t){e=e.remove(t.key)}),!e.isEmpty())throw new Mr(Rr.INVALID_ARGUMENT,"Every document read in a transaction must also be written.");return[4,this.datastore.commit(this.mutations)];case 1:return t.sent(),this.committed=!0,[2]}})})},Pc.prototype.recordVersion=function(t){var e;if(t instanceof us)e=t.version;else{if(!(t instanceof ls))throw Ir("Document in a transaction was a "+t.constructor.name);e=Wi.forDeletedDoc()}var n=this.readVersions.get(t.key);if(null!==n){if(!e.isEqual(n))throw new Mr(Rr.ABORTED,"Document version changed between two reads.")}else this.readVersions=this.readVersions.insert(t.key,e)},Pc.prototype.precondition=function(t){var e=this.readVersions.get(t);return!this.writtenDocs.has(t)&&e?Zo.updateTime(e):Zo.NONE},Pc.prototype.preconditionForUpdate=function(t){var e=this.readVersions.get(t);if(this.writtenDocs.has(t)||!e)return Zo.exists(!0);if(e.isEqual(Wi.forDeletedDoc()))throw new Mr(Rr.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Zo.updateTime(e)},Pc.prototype.write=function(t){this.ensureCommitNotCalled(),this.mutations=this.mutations.concat(t)},Pc.prototype.ensureCommitNotCalled=function(){Cr(!this.committed,"A transaction object cannot be used after its update callback has been invoked.")},Pc);function Pc(t){this.datastore=t,this.readVersions=so,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}(cr=_c={})[cr.Unknown=0]="Unknown",cr[cr.Online=1]="Online",cr[cr.Offline=2]="Offline",(he=Oc={})[he.RemoteStore=0]="RemoteStore",he[he.SharedClientState=1]="SharedClientState";var xc,qc=(Fc.prototype.handleWatchStreamStart=function(){var t=this;0===this.watchStreamFailures&&(this.setAndBroadcast(_c.Unknown),Cr(null===this.onlineStateTimer,"onlineStateTimer shouldn't be started yet"),this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay(Mi.OnlineStateTimeout,1e4,function(){return t.onlineStateTimer=null,Cr(t.state===_c.Unknown,"Timer should be canceled if we transitioned to a different state."),t.logClientOfflineWarningIfNecessary("Backend didn't respond within 10 seconds."),t.setAndBroadcast(_c.Offline),Promise.resolve()}))},Fc.prototype.handleWatchStreamFailure=function(t){this.state===_c.Online?(this.setAndBroadcast(_c.Unknown),Cr(0===this.watchStreamFailures,"watchStreamFailures must be 0"),Cr(null===this.onlineStateTimer,"onlineStateTimer must be null")):(this.watchStreamFailures++,1<=this.watchStreamFailures&&(this.clearOnlineStateTimer(),this.logClientOfflineWarningIfNecessary("Connection failed 1 times. Most recent error: "+t.toString()),this.setAndBroadcast(_c.Offline)))},Fc.prototype.set=function(t){this.clearOnlineStateTimer(),this.watchStreamFailures=0,t===_c.Online&&(this.shouldWarnClientIsOffline=!1),this.setAndBroadcast(t)},Fc.prototype.setAndBroadcast=function(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))},Fc.prototype.logClientOfflineWarningIfNecessary=function(t){t="Could not reach Cloud Firestore backend. "+t+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.shouldWarnClientIsOffline?(Er(t),this.shouldWarnClientIsOffline=!1):Sr("OnlineStateTracker",t)},Fc.prototype.clearOnlineStateTimer=function(){null!==this.onlineStateTimer&&(this.onlineStateTimer.cancel(),this.onlineStateTimer=null)},Fc);function Fc(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state=_c.Unknown,this.watchStreamFailures=0,this.onlineStateTimer=null,this.shouldWarnClientIsOffline=!0}function Vc(t){switch(t){case Rr.OK:return Ir("Treated status OK as error");case Rr.CANCELLED:case Rr.UNKNOWN:case Rr.DEADLINE_EXCEEDED:case Rr.RESOURCE_EXHAUSTED:case Rr.INTERNAL:case Rr.UNAVAILABLE:case Rr.UNAUTHENTICATED:return!1;case Rr.INVALID_ARGUMENT:case Rr.NOT_FOUND:case Rr.ALREADY_EXISTS:case Rr.PERMISSION_DENIED:case Rr.FAILED_PRECONDITION:case Rr.ABORTED:case Rr.OUT_OF_RANGE:case Rr.UNIMPLEMENTED:case Rr.DATA_LOSS:return!0;default:return Ir("Unknown status code: "+t)}}function Bc(t){if(void 0===t)return Er("GRPC error has no .code"),Rr.UNKNOWN;switch(t){case xc.OK:return Rr.OK;case xc.CANCELLED:return Rr.CANCELLED;case xc.UNKNOWN:return Rr.UNKNOWN;case xc.DEADLINE_EXCEEDED:return Rr.DEADLINE_EXCEEDED;case xc.RESOURCE_EXHAUSTED:return Rr.RESOURCE_EXHAUSTED;case xc.INTERNAL:return Rr.INTERNAL;case xc.UNAVAILABLE:return Rr.UNAVAILABLE;case xc.UNAUTHENTICATED:return Rr.UNAUTHENTICATED;case xc.INVALID_ARGUMENT:return Rr.INVALID_ARGUMENT;case xc.NOT_FOUND:return Rr.NOT_FOUND;case xc.ALREADY_EXISTS:return Rr.ALREADY_EXISTS;case xc.PERMISSION_DENIED:return Rr.PERMISSION_DENIED;case xc.FAILED_PRECONDITION:return Rr.FAILED_PRECONDITION;case xc.ABORTED:return Rr.ABORTED;case xc.OUT_OF_RANGE:return Rr.OUT_OF_RANGE;case xc.UNIMPLEMENTED:return Rr.UNIMPLEMENTED;case xc.DATA_LOSS:return Rr.DATA_LOSS;default:return Ir("Unknown status code: "+t)}}(le=xc={})[le.OK=0]="OK",le[le.CANCELLED=1]="CANCELLED",le[le.UNKNOWN=2]="UNKNOWN",le[le.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",le[le.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",le[le.NOT_FOUND=5]="NOT_FOUND",le[le.ALREADY_EXISTS=6]="ALREADY_EXISTS",le[le.PERMISSION_DENIED=7]="PERMISSION_DENIED",le[le.UNAUTHENTICATED=16]="UNAUTHENTICATED",le[le.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",le[le.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",le[le.ABORTED=10]="ABORTED",le[le.OUT_OF_RANGE=11]="OUT_OF_RANGE",le[le.UNIMPLEMENTED=12]="UNIMPLEMENTED",le[le.INTERNAL=13]="INTERNAL",le[le.UNAVAILABLE=14]="UNAVAILABLE",le[le.DATA_LOSS=15]="DATA_LOSS";var Uc,Qc,Kc=(jc.emptySet=function(t){return new jc(t.comparator)},jc.prototype.has=function(t){return null!=this.keyedMap.get(t)},jc.prototype.get=function(t){return this.keyedMap.get(t)},jc.prototype.first=function(){return this.sortedSet.minKey()},jc.prototype.last=function(){return this.sortedSet.maxKey()},jc.prototype.isEmpty=function(){return this.sortedSet.isEmpty()},jc.prototype.indexOf=function(t){t=this.keyedMap.get(t);return t?this.sortedSet.indexOf(t):-1},Object.defineProperty(jc.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!0,configurable:!0}),jc.prototype.forEach=function(n){this.sortedSet.inorderTraversal(function(t,e){return n(t),!1})},jc.prototype.add=function(t){var e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))},jc.prototype.delete=function(t){var e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this},jc.prototype.isEqual=function(t){if(!(t instanceof jc))return!1;if(this.size!==t.size)return!1;for(var e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();e.hasNext();){var r=e.getNext().key,i=n.getNext().key;if(!r.isEqual(i))return!1}return!0},jc.prototype.toString=function(){var e=[];return this.forEach(function(t){e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"},jc.prototype.copy=function(t,e){var n=new jc;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n},jc);function jc(n){this.comparator=n?function(t,e){return n(t,e)||Ai.comparator(t.key,e.key)}:function(t,e){return Ai.comparator(t.key,e.key)},this.keyedMap=ao,this.sortedSet=new zi(this.comparator)}(lr=Uc={})[lr.Added=0]="Added",lr[lr.Removed=1]="Removed",lr[lr.Modified=2]="Modified",lr[lr.Metadata=3]="Metadata",(t=Qc={})[t.Local=0]="Local",t[t.Synced=1]="Synced";var Wc=(Gc.prototype.track=function(t){var e=t.doc.key,n=this.changeMap.get(e);!n||t.type!==Uc.Added&&n.type===Uc.Metadata?this.changeMap=this.changeMap.insert(e,t):t.type===Uc.Metadata&&n.type!==Uc.Removed?this.changeMap=this.changeMap.insert(e,{type:n.type,doc:t.doc}):t.type===Uc.Modified&&n.type===Uc.Modified?this.changeMap=this.changeMap.insert(e,{type:Uc.Modified,doc:t.doc}):t.type===Uc.Modified&&n.type===Uc.Added?this.changeMap=this.changeMap.insert(e,{type:Uc.Added,doc:t.doc}):t.type===Uc.Removed&&n.type===Uc.Added?this.changeMap=this.changeMap.remove(e):t.type===Uc.Removed&&n.type===Uc.Modified?this.changeMap=this.changeMap.insert(e,{type:Uc.Removed,doc:n.doc}):t.type===Uc.Added&&n.type===Uc.Removed?this.changeMap=this.changeMap.insert(e,{type:Uc.Modified,doc:t.doc}):Ir("unsupported combination of changes: "+JSON.stringify(t)+" after "+JSON.stringify(n))},Gc.prototype.getChanges=function(){var n=[];return this.changeMap.inorderTraversal(function(t,e){n.push(e)}),n},Gc);function Gc(){this.changeMap=new zi(Ai.comparator)}var zc=(Hc.fromInitialDocuments=function(t,e,n,r){var i=[];return e.forEach(function(t){i.push({type:Uc.Added,doc:t})}),new Hc(t,e,Kc.emptySet(e),i,n,r,!0,!1)},Object.defineProperty(Hc.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:!0,configurable:!0}),Hc.prototype.isEqual=function(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&this.query.isEqual(t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;var e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(var r=0;r<e.length;r++)if(e[r].type!==n[r].type||!e[r].doc.isEqual(n[r].doc))return!1;return!0},Hc);function Hc(t,e,n,r,i,o,a,s){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=s}var Yc=(Xc.createSynthesizedRemoteEventForCurrentChange=function(t,e){var n=((n={})[t]=Jc.createSynthesizedTargetChangeForCurrentChange(t,e),n);return new Xc(Wi.MIN,n,ho,oo,co())},Xc);function Xc(t,e,n,r,i){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}var Jc=($c.createSynthesizedTargetChangeForCurrentChange=function(t,e){return new $c(Ar(),e,co(),co(),co())},$c);function $c(t,e,n,r,i){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}function Zc(t,e,n,r){this.updatedTargetIds=t,this.removedTargetIds=e,this.key=n,this.newDoc=r}function th(t,e){this.targetId=t,this.existenceFilter=e}var eh;(g=eh={})[g.NoChange=0]="NoChange",g[g.Added=1]="Added",g[g.Removed=2]="Removed",g[g.Current=3]="Current",g[g.Reset=4]="Reset";function nh(t,e,n,r){void 0===n&&(n=Ar()),void 0===r&&(r=null),this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r}var rh=(Object.defineProperty(ih.prototype,"current",{get:function(){return this._current},enumerable:!0,configurable:!0}),Object.defineProperty(ih.prototype,"resumeToken",{get:function(){return this._resumeToken},enumerable:!0,configurable:!0}),Object.defineProperty(ih.prototype,"isPending",{get:function(){return 0!==this.pendingResponses},enumerable:!0,configurable:!0}),Object.defineProperty(ih.prototype,"hasPendingChanges",{get:function(){return this._hasPendingChanges},enumerable:!0,configurable:!0}),ih.prototype.updateResumeToken=function(t){0<t.length&&(this._hasPendingChanges=!0,this._resumeToken=t)},ih.prototype.toTargetChange=function(){var n=co(),r=co(),i=co();return this.documentChanges.forEach(function(t,e){switch(e){case Uc.Added:n=n.add(t);break;case Uc.Modified:r=r.add(t);break;case Uc.Removed:i=i.add(t);break;default:Ir("Encountered invalid change type: "+e)}}),new Jc(this._resumeToken,this._current,n,r,i)},ih.prototype.clearPendingChanges=function(){this._hasPendingChanges=!1,this.documentChanges=uh()},ih.prototype.addDocumentChange=function(t,e){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.insert(t,e)},ih.prototype.removeDocumentChange=function(t){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.remove(t)},ih.prototype.recordPendingTargetRequest=function(){this.pendingResponses+=1},ih.prototype.recordTargetResponse=function(){--this.pendingResponses},ih.prototype.markCurrent=function(){this._hasPendingChanges=!0,this._current=!0},ih);function ih(){this.pendingResponses=0,this.documentChanges=uh(),this._resumeToken=Ar(),this._current=!1,this._hasPendingChanges=!0}var oh=(ah.prototype.handleDocumentChange=function(t){for(var e=0,n=t.updatedTargetIds;e<n.length;e++){var r=n[e];t.newDoc instanceof us?this.addDocumentToTarget(r,t.newDoc):t.newDoc instanceof ls&&this.removeDocumentFromTarget(r,t.key,t.newDoc)}for(var i=0,o=t.removedTargetIds;i<o.length;i++)r=o[i],this.removeDocumentFromTarget(r,t.key,t.newDoc)},ah.prototype.handleTargetChange=function(n){var r=this;this.forEachTarget(n,function(t){var e=r.ensureTargetState(t);switch(n.state){case eh.NoChange:r.isActiveTarget(t)&&e.updateResumeToken(n.resumeToken);break;case eh.Added:e.recordTargetResponse(),e.isPending||e.clearPendingChanges(),e.updateResumeToken(n.resumeToken);break;case eh.Removed:e.recordTargetResponse(),e.isPending||r.removeTarget(t),Cr(!n.cause,"WatchChangeAggregator does not handle errored targets");break;case eh.Current:r.isActiveTarget(t)&&(e.markCurrent(),e.updateResumeToken(n.resumeToken));break;case eh.Reset:r.isActiveTarget(t)&&(r.resetTarget(t),e.updateResumeToken(n.resumeToken));break;default:Ir("Unknown target watch change state: "+n.state)}})},ah.prototype.forEachTarget=function(t,e){0<t.targetIds.length?t.targetIds.forEach(e):xr(this.targetStates,e)},ah.prototype.handleExistenceFilter=function(t){var e=t.targetId,n=t.existenceFilter.count,t=this.queryDataForActiveTarget(e);t&&((t=t.query).isDocumentQuery()?0===n?(t=new Ai(t.path),this.removeDocumentFromTarget(e,t,new ls(t,Wi.forDeletedDoc()))):Cr(1===n,"Single document existence filter with count: "+n):this.getCurrentDocumentCountForTarget(e)!==n&&(this.resetTarget(e),this.pendingTargetResets=this.pendingTargetResets.add(e)))},ah.prototype.createRemoteEvent=function(r){var i=this,o={};xr(this.targetStates,function(t,e){var n=i.queryDataForActiveTarget(t);n&&(e.current&&n.query.isDocumentQuery()&&(n=new Ai(n.query.path),null!==i.pendingDocumentUpdates.get(n)||i.targetContainsDocument(t,n)||i.removeDocumentFromTarget(t,n,new ls(n,r))),e.hasPendingChanges&&(o[t]=e.toTargetChange(),e.clearPendingChanges()))});var a=co();this.pendingDocumentTargetMapping.forEach(function(t,e){var n=!0;e.forEachWhile(function(t){t=i.queryDataForActiveTarget(t);return!t||t.purpose===lu.LimboResolution||(n=!1)}),n&&(a=a.add(t))});var t=new Yc(r,o,this.pendingTargetResets,this.pendingDocumentUpdates,a);return this.pendingDocumentUpdates=oo,this.pendingDocumentTargetMapping=sh(),this.pendingTargetResets=new eo(oi),t},ah.prototype.addDocumentToTarget=function(t,e){var n;this.isActiveTarget(t)&&(n=this.targetContainsDocument(t,e.key)?Uc.Modified:Uc.Added,this.ensureTargetState(t).addDocumentChange(e.key,n),this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(e.key,e),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e.key,this.ensureDocumentTargetMapping(e.key).add(t)))},ah.prototype.removeDocumentFromTarget=function(t,e,n){var r;this.isActiveTarget(t)&&(r=this.ensureTargetState(t),this.targetContainsDocument(t,e)?r.addDocumentChange(e,Uc.Removed):r.removeDocumentChange(e),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e,this.ensureDocumentTargetMapping(e).delete(t)),n&&(this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(e,n)))},ah.prototype.removeTarget=function(t){delete this.targetStates[t]},ah.prototype.getCurrentDocumentCountForTarget=function(t){var e=this.ensureTargetState(t).toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size},ah.prototype.recordPendingTargetRequest=function(t){this.ensureTargetState(t).recordPendingTargetRequest()},ah.prototype.ensureTargetState=function(t){return this.targetStates[t]||(this.targetStates[t]=new rh),this.targetStates[t]},ah.prototype.ensureDocumentTargetMapping=function(t){var e=this.pendingDocumentTargetMapping.get(t);return e||(e=new eo(oi),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(t,e)),e},ah.prototype.isActiveTarget=function(t){var e=null!==this.queryDataForActiveTarget(t);return e||Sr("WatchChangeAggregator","Detected inactive target",t),e},ah.prototype.queryDataForActiveTarget=function(t){var e=this.targetStates[t];return e&&e.isPending?null:this.metadataProvider.getQueryDataForTarget(t)},ah.prototype.resetTarget=function(e){var n=this;Cr(!this.targetStates[e].isPending,"Should only reset active targets"),this.targetStates[e]=new rh,this.metadataProvider.getRemoteKeysForTarget(e).forEach(function(t){n.removeDocumentFromTarget(e,t,null)})},ah.prototype.targetContainsDocument=function(t,e){return this.metadataProvider.getRemoteKeysForTarget(t).has(e)},ah);function ah(t){this.metadataProvider=t,this.targetStates={},this.pendingDocumentUpdates=oo,this.pendingDocumentTargetMapping=sh(),this.pendingTargetResets=new eo(oi)}function sh(){return new zi(Ai.comparator)}function uh(){return new zi(Ai.comparator)}var ch="RemoteStore",hh=(lh.prototype.start=function(){return this.enableNetwork()},lh.prototype.enableNetwork=function(){return p(this,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:return this.networkEnabled=!0,this.canUseNetwork()?(e=this.writeStream,[4,this.localStore.getLastStreamToken()]):[3,3];case 1:return e.lastStreamToken=t.sent(),this.shouldStartWatchStream()?this.startWatchStream():this.onlineStateTracker.set(_c.Unknown),[4,this.fillWritePipeline()];case 2:t.sent(),t.label=3;case 3:return[2]}})})},lh.prototype.disableNetwork=function(){return p(this,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(_c.Offline),[2]}})})},lh.prototype.disableNetworkInternal=function(){return p(this,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return[4,this.writeStream.stop()];case 1:return t.sent(),[4,this.watchStream.stop()];case 2:return t.sent(),0<this.writePipeline.length&&(Sr(ch,"Stopping write stream with "+this.writePipeline.length+" pending writes"),this.writePipeline=[]),this.cleanUpWatchStreamState(),[2]}})})},lh.prototype.shutdown=function(){return p(this,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return Sr(ch,"RemoteStore shutting down."),this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.connectivityMonitor.shutdown(),this.onlineStateTracker.set(_c.Unknown),[2]}})})},lh.prototype.listen=function(t){Cr(!Lr(this.listenTargets,t.targetId),"listen called with duplicate targetId!"),this.listenTargets[t.targetId]=t,this.shouldStartWatchStream()?this.startWatchStream():this.watchStream.isOpen()&&this.sendWatchRequest(t)},lh.prototype.unlisten=function(t){Cr(Lr(this.listenTargets,t),"unlisten called without assigned target ID!"),delete this.listenTargets[t],this.watchStream.isOpen()&&this.sendUnwatchRequest(t),Fr(this.listenTargets)&&(this.watchStream.isOpen()?this.watchStream.markIdle():this.canUseNetwork()&&this.onlineStateTracker.set(_c.Unknown))},lh.prototype.getQueryDataForTarget=function(t){return this.listenTargets[t]||null},lh.prototype.getRemoteKeysForTarget=function(t){return this.syncEngine.getRemoteKeysForTarget(t)},lh.prototype.sendWatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t.targetId),this.watchStream.watch(t)},lh.prototype.sendUnwatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t),this.watchStream.unwatch(t)},lh.prototype.startWatchStream=function(){Cr(this.shouldStartWatchStream(),"startWatchStream() called when shouldStartWatchStream() is false."),this.watchChangeAggregator=new oh(this),this.watchStream.start(),this.onlineStateTracker.handleWatchStreamStart()},lh.prototype.shouldStartWatchStream=function(){return this.canUseNetwork()&&!this.watchStream.isStarted()&&!Fr(this.listenTargets)},lh.prototype.canUseNetwork=function(){return this.isPrimary&&this.networkEnabled},lh.prototype.cleanUpWatchStreamState=function(){this.watchChangeAggregator=null},lh.prototype.onWatchStreamOpen=function(){return p(this,void 0,void 0,function(){var n=this;return d(this,function(t){return xr(this.listenTargets,function(t,e){n.sendWatchRequest(e)}),[2]})})},lh.prototype.onWatchStreamClose=function(e){return p(this,void 0,void 0,function(){return d(this,function(t){return void 0===e&&Cr(!this.shouldStartWatchStream(),"Watch stream was stopped gracefully while still needed."),this.cleanUpWatchStreamState(),this.shouldStartWatchStream()?(this.onlineStateTracker.handleWatchStreamFailure(e),this.startWatchStream()):this.onlineStateTracker.set(_c.Unknown),[2]})})},lh.prototype.onWatchStreamChange=function(n,r){return p(this,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:return this.onlineStateTracker.set(_c.Online),n instanceof nh&&n.state===eh.Removed&&n.cause?[2,this.handleTargetError(n)]:(n instanceof Zc?this.watchChangeAggregator.handleDocumentChange(n):n instanceof th?this.watchChangeAggregator.handleExistenceFilter(n):(Cr(n instanceof nh,"Expected watchChange to be an instance of WatchTargetChange"),this.watchChangeAggregator.handleTargetChange(n)),r.isEqual(Wi.MIN)?[3,3]:[4,this.localStore.getLastRemoteSnapshotVersion()]);case 1:return e=t.sent(),0<=r.compareTo(e)?[4,this.raiseWatchSnapshot(r)]:[3,3];case 2:t.sent(),t.label=3;case 3:return[2]}})})},lh.prototype.raiseWatchSnapshot=function(r){var i=this;Cr(!r.isEqual(Wi.MIN),"Can't raise event for unknown SnapshotVersion");var t=this.watchChangeAggregator.createRemoteEvent(r);return xr(t.targetChanges,function(t,e){var n;0<e.resumeToken.length&&((n=i.listenTargets[t])&&(i.listenTargets[t]=n.withResumeToken(e.resumeToken,r)))}),t.targetMismatches.forEach(function(t){var e=i.listenTargets[t];e&&(i.listenTargets[t]=e.withResumeToken(Ar(),e.snapshotVersion),i.sendUnwatchRequest(t),e=new yu(e.query,t,lu.ExistenceFilterMismatch,e.sequenceNumber),i.sendWatchRequest(e))}),this.syncEngine.applyRemoteEvent(t)},lh.prototype.handleTargetError=function(t){var n=this;Cr(!!t.cause,"Handling target error without a cause");var r=t.cause,i=Promise.resolve();return t.targetIds.forEach(function(e){i=i.then(function(){return p(n,void 0,void 0,function(){return d(this,function(t){return Lr(this.listenTargets,e)?(delete this.listenTargets[e],this.watchChangeAggregator.removeTarget(e),[2,this.syncEngine.rejectListen(e,r)]):[2]})})})}),i},lh.prototype.fillWritePipeline=function(){return p(this,void 0,void 0,function(){var e,n;return d(this,function(t){switch(t.label){case 0:return this.canAddToWritePipeline()?(e=0<this.writePipeline.length?this.writePipeline[this.writePipeline.length-1].batchId:-1,[4,this.localStore.nextMutationBatch(e)]):[3,4];case 1:return null!==(n=t.sent())?[3,2]:(0===this.writePipeline.length&&this.writeStream.markIdle(),[3,4]);case 2:return this.addToWritePipeline(n),[4,this.fillWritePipeline()];case 3:t.sent(),t.label=4;case 4:return this.shouldStartWriteStream()&&this.startWriteStream(),[2]}})})},lh.prototype.canAddToWritePipeline=function(){return this.canUseNetwork()&&this.writePipeline.length<10},lh.prototype.outstandingWrites=function(){return this.writePipeline.length},lh.prototype.addToWritePipeline=function(t){Cr(this.canAddToWritePipeline(),"addToWritePipeline called when pipeline is full"),this.writePipeline.push(t),this.writeStream.isOpen()&&this.writeStream.handshakeComplete&&this.writeStream.writeMutations(t.mutations)},lh.prototype.shouldStartWriteStream=function(){return this.canUseNetwork()&&!this.writeStream.isStarted()&&0<this.writePipeline.length},lh.prototype.startWriteStream=function(){Cr(this.shouldStartWriteStream(),"startWriteStream() called when shouldStartWriteStream() is false."),this.writeStream.start()},lh.prototype.onWriteStreamOpen=function(){return p(this,void 0,void 0,function(){return d(this,function(t){return this.writeStream.writeHandshake(),[2]})})},lh.prototype.onWriteHandshakeComplete=function(){var r=this;return this.localStore.setLastStreamToken(this.writeStream.lastStreamToken).then(function(){for(var t=0,e=r.writePipeline;t<e.length;t++){var n=e[t];r.writeStream.writeMutations(n.mutations)}}).catch(Fu)},lh.prototype.onMutationResult=function(t,e){var n=this;Cr(0<this.writePipeline.length,"Got result for empty write pipeline");var r=this.writePipeline.shift(),e=po.from(r,t,e,this.writeStream.lastStreamToken);return this.syncEngine.applySuccessfulWrite(e).then(function(){return n.fillWritePipeline()})},lh.prototype.onWriteStreamClose=function(n){return p(this,void 0,void 0,function(){var e=this;return d(this,function(t){return void 0===n&&Cr(!this.shouldStartWriteStream(),"Write stream was stopped gracefully while still needed."),n&&0<this.writePipeline.length?[2,(this.writeStream.handshakeComplete?this.handleWriteError(n):this.handleHandshakeError(n)).then(function(){e.shouldStartWriteStream()&&e.startWriteStream()})]:[2]})})},lh.prototype.handleHandshakeError=function(e){return p(this,void 0,void 0,function(){return d(this,function(t){return Vc(e.code)?(Sr(ch,"RemoteStore error before completed handshake; resetting stream token: ",this.writeStream.lastStreamToken),this.writeStream.lastStreamToken=Ar(),[2,this.localStore.setLastStreamToken(Ar()).catch(Fu)]):[2]})})},lh.prototype.handleWriteError=function(i){return p(this,void 0,void 0,function(){var n,r=this;return d(this,function(t){return Vc(e=i.code)&&e!==Rr.ABORTED?(n=this.writePipeline.shift(),this.writeStream.inhibitBackoff(),[2,this.syncEngine.rejectFailedWrite(n.batchId,i).then(function(){return r.fillWritePipeline()})]):[2];var e})})},lh.prototype.createTransaction=function(){return new Lc(this.datastore)},lh.prototype.restartNetwork=function(){return p(this,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(_c.Unknown),[4,this.enableNetwork()];case 2:return t.sent(),[2]}})})},lh.prototype.handleCredentialChange=function(){return p(this,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return this.canUseNetwork()?(Sr(ch,"RemoteStore restarting streams for new credential"),[4,this.restartNetwork()]):[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},lh.prototype.applyPrimaryState=function(e){return p(this,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return(this.isPrimary=e)&&this.networkEnabled?[4,this.enableNetwork()]:[3,2];case 1:return t.sent(),[3,4];case 2:return e?[3,4]:[4,this.disableNetworkInternal()];case 3:t.sent(),this.onlineStateTracker.set(_c.Unknown),t.label=4;case 4:return[2]}})})},lh);function lh(t,e,n,r,i){var o=this;this.localStore=t,this.datastore=e,this.writePipeline=[],this.listenTargets={},this.watchChangeAggregator=null,this.networkEnabled=!1,this.isPrimary=!1,this.connectivityMonitor=i,this.connectivityMonitor.addCallback(function(t){n.enqueueAndForget(function(){return p(o,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return this.canUseNetwork()?(Sr(ch,"Restarting streams for network reachability change."),[4,this.restartNetwork()]):[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})})}),this.onlineStateTracker=new qc(n,r),this.watchStream=this.datastore.newPersistentWatchStream({onOpen:this.onWatchStreamOpen.bind(this),onClose:this.onWatchStreamClose.bind(this),onWatchChange:this.onWatchStreamChange.bind(this)}),this.writeStream=this.datastore.newPersistentWriteStream({onOpen:this.onWriteStreamOpen.bind(this),onClose:this.onWriteStreamClose.bind(this),onHandshakeComplete:this.onWriteHandshakeComplete.bind(this),onMutationResult:this.onMutationResult.bind(this)})}var fh=(Object.defineProperty(ph.prototype,"latitude",{get:function(){return this._lat},enumerable:!0,configurable:!0}),Object.defineProperty(ph.prototype,"longitude",{get:function(){return this._long},enumerable:!0,configurable:!0}),ph.prototype.isEqual=function(t){return this._lat===t._lat&&this._long===t._long},ph.prototype._compareTo=function(t){return oi(this._lat,t._lat)||oi(this._long,t._long)},ph);function ph(t,e){if(Br("GeoPoint",arguments,2),Kr("GeoPoint","number",1,t),Kr("GeoPoint","number",2,e),!isFinite(t)||t<-90||90<t)throw new Mr(Rr.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||180<e)throw new Mr(Rr.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}var dh=(mh.atPath=function(t){return new mh(t)},Object.defineProperty(mh.prototype,"orderBy",{get:function(){if(null===this.memoizedOrderBy){var t=this.getInequalityFilterField(),e=this.getFirstOrderByField();if(null!==t&&null===e)t.isKeyField()?this.memoizedOrderBy=[Qh]:this.memoizedOrderBy=[new Bh(t),Qh];else{Cr(null===t||null!==e&&t.isEqual(e),"First orderBy should match inequality field.");for(var n=!(this.memoizedOrderBy=[]),r=0,i=this.explicitOrderBy;r<i.length;r++){var o=i[r];this.memoizedOrderBy.push(o),o.field.isKeyField()&&(n=!0)}n||(e=0<this.explicitOrderBy.length?this.explicitOrderBy[this.explicitOrderBy.length-1].dir:xh.ASCENDING,this.memoizedOrderBy.push(e===xh.ASCENDING?Qh:Kh))}}return this.memoizedOrderBy},enumerable:!0,configurable:!0}),mh.prototype.addFilter=function(t){Cr(null==this.getInequalityFilterField()||!(t instanceof bh)||!t.isInequality()||t.field.isEqual(this.getInequalityFilterField()),"Query must only have one inequality field."),Cr(!this.isDocumentQuery(),"No filtering allowed for document query");t=this.filters.concat([t]);return new mh(this.path,this.collectionGroup,this.explicitOrderBy.slice(),t,this.limit,this.startAt,this.endAt)},mh.prototype.addOrderBy=function(t){Cr(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");t=this.explicitOrderBy.concat([t]);return new mh(this.path,this.collectionGroup,t,this.filters.slice(),this.limit,this.startAt,this.endAt)},mh.prototype.withLimit=function(t){return new mh(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),t,this.startAt,this.endAt)},mh.prototype.withStartAt=function(t){return new mh(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,t,this.endAt)},mh.prototype.withEndAt=function(t){return new mh(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,t)},mh.prototype.asCollectionQueryAtPath=function(t){return new mh(t,null,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,this.endAt)},mh.prototype.canonicalId=function(){if(null===this.memoizedCanonicalId){var t=this.path.canonicalString();this.isCollectionGroupQuery()&&(t+="|cg:"+this.collectionGroup),t+="|f:";for(var e=0,n=this.filters;e<n.length;e++)t+=n[e].canonicalId(),t+=",";t+="|ob:";for(var r=0,i=this.orderBy;r<i.length;r++)t+=i[r].canonicalId(),t+=",";gc(this.limit)||(t+="|l:",t+=this.limit),this.startAt&&(t+="|lb:",t+=this.startAt.canonicalId()),this.endAt&&(t+="|ub:",t+=this.endAt.canonicalId()),this.memoizedCanonicalId=t}return this.memoizedCanonicalId},mh.prototype.toString=function(){var t="Query("+this.path.canonicalString();return this.isCollectionGroupQuery()&&(t+=" collectionGroup="+this.collectionGroup),0<this.filters.length&&(t+=", filters: ["+this.filters.join(", ")+"]"),gc(this.limit)||(t+=", limit: "+this.limit),0<this.explicitOrderBy.length&&(t+=", orderBy: ["+this.explicitOrderBy.join(", ")+"]"),this.startAt&&(t+=", startAt: "+this.startAt.canonicalId()),this.endAt&&(t+=", endAt: "+this.endAt.canonicalId()),t+")"},mh.prototype.isEqual=function(t){if(this.limit!==t.limit)return!1;if(this.orderBy.length!==t.orderBy.length)return!1;for(var e=0;e<this.orderBy.length;e++)if(!this.orderBy[e].isEqual(t.orderBy[e]))return!1;if(this.filters.length!==t.filters.length)return!1;for(e=0;e<this.filters.length;e++)if(!this.filters[e].isEqual(t.filters[e]))return!1;return this.collectionGroup===t.collectionGroup&&!!this.path.isEqual(t.path)&&!(null!==this.startAt?!this.startAt.isEqual(t.startAt):null!==t.startAt)&&(null!==this.endAt?this.endAt.isEqual(t.endAt):null===t.endAt)},mh.prototype.docComparator=function(t,e){for(var n=!1,r=0,i=this.orderBy;r<i.length;r++){var o=i[r],a=o.compare(t,e);if(0!==a)return a;n=n||o.field.isKeyField()}return Cr(n,"orderBy used that doesn't compare on key field"),0},mh.prototype.matches=function(t){return this.matchesPathAndCollectionGroup(t)&&this.matchesOrderBy(t)&&this.matchesFilters(t)&&this.matchesBounds(t)},mh.prototype.hasLimit=function(){return!gc(this.limit)},mh.prototype.getFirstOrderByField=function(){return 0<this.explicitOrderBy.length?this.explicitOrderBy[0].field:null},mh.prototype.getInequalityFilterField=function(){for(var t=0,e=this.filters;t<e.length;t++){var n=e[t];if(n instanceof bh&&n.isInequality())return n.field}return null},mh.prototype.findFilterOperator=function(t){for(var e=0,n=this.filters;e<n.length;e++){var r=n[e];if(r instanceof bh&&0<=t.indexOf(r.op))return r.op}return null},mh.prototype.isDocumentQuery=function(){return Ai.isDocumentKey(this.path)&&null===this.collectionGroup&&0===this.filters.length},mh.prototype.isCollectionGroupQuery=function(){return null!==this.collectionGroup},mh.prototype.matchesPathAndCollectionGroup=function(t){var e=t.key.path;return null!==this.collectionGroup?t.key.hasCollectionId(this.collectionGroup)&&this.path.isPrefixOf(e):Ai.isDocumentKey(this.path)?this.path.isEqual(e):this.path.isImmediateParentOf(e)},mh.prototype.matchesOrderBy=function(t){for(var e=0,n=this.explicitOrderBy;e<n.length;e++){var r=n[e];if(!r.field.isKeyField()&&null===t.field(r.field))return!1}return!0},mh.prototype.matchesFilters=function(t){for(var e=0,n=this.filters;e<n.length;e++)if(!n[e].matches(t))return!1;return!0},mh.prototype.matchesBounds=function(t){return!(this.startAt&&!this.startAt.sortsBeforeDocument(this.orderBy,t)||this.endAt&&this.endAt.sortsBeforeDocument(this.orderBy,t))},mh.prototype.assertValidBound=function(t){Cr(t.position.length<=this.orderBy.length,"Bound is longer than orderBy")},mh);function mh(t,e,n,r,i,o,a){void 0===e&&(e=null),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=null),void 0===o&&(o=null),void 0===a&&(a=null),this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.startAt=o,this.endAt=a,this.memoizedCanonicalId=null,this.memoizedOrderBy=null,this.startAt&&this.assertValidBound(this.startAt),this.endAt&&this.assertValidBound(this.endAt)}var yh=(gh.fromString=function(t){switch(t){case"<":return gh.LESS_THAN;case"<=":return gh.LESS_THAN_OR_EQUAL;case"==":return gh.EQUAL;case">=":return gh.GREATER_THAN_OR_EQUAL;case">":return gh.GREATER_THAN;case"array-contains":return gh.ARRAY_CONTAINS;case"in":return gh.IN;case"array-contains-any":return gh.ARRAY_CONTAINS_ANY;default:return Ir("Unknown FieldFilter operator: "+t)}},gh.prototype.toString=function(){return this.name},gh.prototype.isEqual=function(t){return this.name===t.name},gh.LESS_THAN=new gh("<"),gh.LESS_THAN_OR_EQUAL=new gh("<="),gh.EQUAL=new gh("=="),gh.GREATER_THAN=new gh(">"),gh.GREATER_THAN_OR_EQUAL=new gh(">="),gh.ARRAY_CONTAINS=new gh("array-contains"),gh.IN=new gh("in"),gh.ARRAY_CONTAINS_ANY=new gh("array-contains-any"),gh);function gh(t){this.name=t}var vh,bh=(a(wh,vh=function(){}),wh.create=function(t,e,n){if(t.isKeyField())return e===yh.IN?(Cr(n instanceof is,"Comparing on key with IN, but filter value not an ArrayValue"),Cr(n.internalValue.every(function(t){return t instanceof Ya}),"Comparing on key with IN, but an array value was not a RefValue"),new Ch(t,n)):(Cr(n instanceof Ya,"Comparing on key, but filter value not a RefValue"),Cr(e!==yh.ARRAY_CONTAINS&&e!==yh.ARRAY_CONTAINS_ANY,"'"+e.toString()+"' queries don't make sense on document keys."),new Eh(t,e,n));if(n.isEqual(Sa.INSTANCE)){if(e!==yh.EQUAL)throw new Mr(Rr.INVALID_ARGUMENT,"Invalid query. Null supports only equality comparisons.");return new wh(t,e,n)}if(n.isEqual(La.NAN)){if(e!==yh.EQUAL)throw new Mr(Rr.INVALID_ARGUMENT,"Invalid query. NaN supports only equality comparisons.");return new wh(t,e,n)}return e===yh.ARRAY_CONTAINS?new Ah(t,n):e===yh.IN?(Cr(n instanceof is,"IN filter has invalid value: "+n.toString()),new Mh(t,n)):e===yh.ARRAY_CONTAINS_ANY?(Cr(n instanceof is,"ARRAY_CONTAINS_ANY filter has invalid value: "+n.toString()),new Lh(t,n)):new wh(t,e,n)},wh.prototype.matches=function(t){t=t.field(this.field);return null!==t&&this.value.typeOrder===t.typeOrder&&this.matchesComparison(t.compareTo(this.value))},wh.prototype.matchesComparison=function(t){switch(this.op){case yh.LESS_THAN:return t<0;case yh.LESS_THAN_OR_EQUAL:return t<=0;case yh.EQUAL:return 0===t;case yh.GREATER_THAN:return 0<t;case yh.GREATER_THAN_OR_EQUAL:return 0<=t;default:return Ir("Unknown FieldFilter operator: "+this.op)}},wh.prototype.isInequality=function(){return 0<=[yh.LESS_THAN,yh.LESS_THAN_OR_EQUAL,yh.GREATER_THAN,yh.GREATER_THAN_OR_EQUAL].indexOf(this.op)},wh.prototype.canonicalId=function(){return this.field.canonicalString()+this.op.toString()+this.value.toString()},wh.prototype.isEqual=function(t){return t instanceof wh&&this.op.isEqual(t.op)&&this.field.isEqual(t.field)&&this.value.isEqual(t.value)},wh.prototype.toString=function(){return this.field.canonicalString()+" "+this.op+" "+this.value.value()},wh);function wh(t,e,n){var r=vh.call(this)||this;return r.field=t,r.op=e,r.value=n,r}var Sh,Eh=(a(Th,Sh=bh),Th.prototype.matches=function(t){var e=this.value,e=Ai.comparator(t.key,e.key);return this.matchesComparison(e)},Th);function Th(){return null!==Sh&&Sh.apply(this,arguments)||this}var Ih,Ch=(a(Dh,Ih=bh),Dh.prototype.matches=function(e){return this.value.internalValue.some(function(t){return e.key.isEqual(t.key)})},Dh);function Dh(t,e){t=Ih.call(this,t,yh.IN,e)||this;return t.value=e,t}var Nh,Ah=(a(kh,Nh=bh),kh.prototype.matches=function(t){t=t.field(this.field);return t instanceof is&&t.contains(this.value)},kh);function kh(t,e){return Nh.call(this,t,yh.ARRAY_CONTAINS,e)||this}var Rh,Mh=(a(_h,Rh=bh),_h.prototype.matches=function(t){var e=this.value,t=t.field(this.field);return null!==t&&e.contains(t)},_h);function _h(t,e){t=Rh.call(this,t,yh.IN,e)||this;return t.value=e,t}var Oh,Lh=(a(Ph,Oh=bh),Ph.prototype.matches=function(t){var e=this,t=t.field(this.field);return t instanceof is&&t.internalValue.some(function(t){return e.value.contains(t)})},Ph);function Ph(t,e){t=Oh.call(this,t,yh.ARRAY_CONTAINS_ANY,e)||this;return t.value=e,t}var xh=(qh.prototype.toString=function(){return this.name},qh.ASCENDING=new qh("asc"),qh.DESCENDING=new qh("desc"),qh);function qh(t){this.name=t}var Fh=(Vh.prototype.canonicalId=function(){for(var t=this.before?"b:":"a:",e=0,n=this.position;e<n.length;e++)t+=n[e].toString();return t},Vh.prototype.sortsBeforeDocument=function(t,e){Cr(this.position.length<=t.length,"Bound has more components than query's orderBy");for(var n=0,r=0;r<this.position.length;r++){var i,o=t[r],a=this.position[r],n=o.field.isKeyField()?(Cr(a instanceof Ya,"Bound has a non-key value where the key path is being used."),Ai.comparator(a.key,e.key)):(Cr(null!==(i=e.field(o.field)),"Field should exist since document matched the orderBy already."),a.compareTo(i));if(o.dir===xh.DESCENDING&&(n*=-1),0!==n)break}return this.before?n<=0:n<0},Vh.prototype.isEqual=function(t){if(null===t)return!1;if(this.before!==t.before||this.position.length!==t.position.length)return!1;for(var e=0;e<this.position.length;e++){var n=this.position[e],r=t.position[e];if(!n.isEqual(r))return!1}return!0},Vh);function Vh(t,e){this.position=t,this.before=e}var Bh=(Uh.prototype.compare=function(t,e){var n=this.isKeyOrderBy?us.compareByKey(t,e):us.compareByField(this.field,t,e);switch(this.dir){case xh.ASCENDING:return n;case xh.DESCENDING:return-1*n;default:return Ir("Unknown direction: "+this.dir)}},Uh.prototype.canonicalId=function(){return this.field.canonicalString()+this.dir.toString()},Uh.prototype.toString=function(){return this.field.canonicalString()+" ("+this.dir+")"},Uh.prototype.isEqual=function(t){return this.dir===t.dir&&this.field.isEqual(t.field)},Uh);function Uh(t,e){this.field=t,void 0===e&&(e=xh.ASCENDING),this.dir=e,this.isKeyOrderBy=t.isKeyField()}var Qh=new Bh(Di.keyField(),xh.ASCENDING),Kh=new Bh(Di.keyField(),xh.DESCENDING),jh=(Wh.prototype.applyToLocalView=function(t,e){return new Ka(e,t)},Wh.prototype.applyToRemoteDocument=function(t,e){return e},Wh.prototype.computeBaseValue=function(t){return null},Wh.prototype.isEqual=function(t){return t instanceof Wh},Wh.instance=new Wh,Wh);function Wh(){}var Gh=(zh.prototype.applyToLocalView=function(t,e){return this.apply(t)},zh.prototype.applyToRemoteDocument=function(t,e){return this.apply(t)},zh.prototype.apply=function(t){for(var n=$h(t),e=0,r=this.elements;e<r.length;e++)!function(e){n.find(function(t){return t.isEqual(e)})||n.push(e)}(r[e]);return new is(n)},zh.prototype.computeBaseValue=function(t){return null},zh.prototype.isEqual=function(t){return t instanceof zh&&ai(t.elements,this.elements)},zh);function zh(t){this.elements=t}var Hh=(Yh.prototype.applyToLocalView=function(t,e){return this.apply(t)},Yh.prototype.applyToRemoteDocument=function(t,e){return this.apply(t)},Yh.prototype.apply=function(t){for(var n=$h(t),e=0,r=this.elements;e<r.length;e++)!function(e){n=n.filter(function(t){return!t.isEqual(e)})}(r[e]);return new is(n)},Yh.prototype.computeBaseValue=function(t){return null},Yh.prototype.isEqual=function(t){return t instanceof Yh&&ai(t.elements,this.elements)},Yh);function Yh(t){this.elements=t}var Xh=(Jh.prototype.applyToLocalView=function(t,e){t=this.computeBaseValue(t);if(t instanceof Ma&&this.operand instanceof Ma){var n=t.internalValue+this.operand.internalValue;return new Ma(n)}return n=t.internalValue+this.operand.internalValue,new La(n)},Jh.prototype.applyToRemoteDocument=function(t,e){return Cr(null!==e,"Didn't receive transformResult for NUMERIC_ADD transform"),e},Jh.prototype.computeBaseValue=function(t){return t instanceof Na?t:new Ma(0)},Jh.prototype.isEqual=function(t){return t instanceof Jh&&this.operand.isEqual(t.operand)},Jh);function Jh(t){this.operand=t}function $h(t){return t instanceof is?t.internalValue.slice():[]}var Zh=(tl.prototype.isEqual=function(t){return t&&t.count===this.count},tl);function tl(t){this.count=t}var el=((vs={})[xh.ASCENDING.name]="ASCENDING",vs[xh.DESCENDING.name]="DESCENDING",vs),nl=((ct={})[yh.LESS_THAN.name]="LESS_THAN",ct[yh.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL",ct[yh.GREATER_THAN.name]="GREATER_THAN",ct[yh.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL",ct[yh.EQUAL.name]="EQUAL",ct[yh.ARRAY_CONTAINS.name]="ARRAY_CONTAINS",ct[yh.IN.name]="IN",ct[yh.ARRAY_CONTAINS_ANY.name]="ARRAY_CONTAINS_ANY",ct),rl=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function il(t,e){Cr(!gc(t),e+" is missing")}function ol(t){return"number"==typeof t?t:"string"==typeof t?Number(t):Ir("can't parse "+t)}var al=(sl.prototype.emptyByteString=function(){return this.options.useProto3Json?"":new Uint8Array(0)},sl.prototype.unsafeCastProtoByteString=function(t){return t},sl.prototype.fromRpcStatus=function(t){var e=void 0===t.code?Rr.UNKNOWN:Bc(t.code);return new Mr(e,t.message||"")},sl.prototype.toInt32Value=function(t){return gc(t)?void 0:{value:t}},sl.prototype.fromInt32Value=function(t){return gc(t="object"==typeof t?t.value:t)?null:t},sl.prototype.toTimestamp=function(t){return{seconds:""+t.seconds,nanos:t.nanoseconds}},sl.prototype.fromTimestamp=function(t){if("string"==typeof t)return this.fromIso8601String(t);Cr(!!t,"Cannot deserialize null or undefined timestamp.");var e=ol(t.seconds||"0"),t=t.nanos||0;return new Ki(e,t)},sl.prototype.fromIso8601String=function(t){var e=0,n=rl.exec(t);Cr(!!n,"invalid timestamp: "+t),n[1]&&(n=((n=n[1])+"000000000").substr(0,9),e=Number(n));t=new Date(t),t=Math.floor(t.getTime()/1e3);return new Ki(t,e)},sl.prototype.toBytes=function(t){return this.options.useProto3Json?t.toBase64():this.unsafeCastProtoByteString(t.toUint8Array())},sl.prototype.fromBlob=function(t){return"string"==typeof t?(Cr(this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),hi.fromBase64String(t)):(Cr(!this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),hi.fromUint8Array(t))},sl.prototype.toVersion=function(t){return this.toTimestamp(t.toTimestamp())},sl.prototype.fromVersion=function(t){return Cr(!!t,"Trying to deserialize version that isn't set"),Wi.fromTimestamp(this.fromTimestamp(t))},sl.prototype.toResourceName=function(t,e){return this.fullyQualifiedPrefixPath(t).child("documents").child(e).canonicalString()},sl.prototype.fromResourceName=function(t){t=Ei.fromString(t);return Cr(this.isValidResourceName(t),"Tried to deserialize invalid key "+t.toString()),t},sl.prototype.toName=function(t){return this.toResourceName(this.databaseId,t.path)},sl.prototype.fromName=function(t){t=this.fromResourceName(t);return Cr(t.get(1)===this.databaseId.projectId,"Tried to deserialize key from different project: "+t.get(1)+" vs "+this.databaseId.projectId),Cr(!t.get(3)&&!this.databaseId.database||t.get(3)===this.databaseId.database,"Tried to deserialize key from different database: "+t.get(3)+" vs "+this.databaseId.database),new Ai(this.extractLocalPathFromResourceName(t))},sl.prototype.toQueryPath=function(t){return this.toResourceName(this.databaseId,t)},sl.prototype.fromQueryPath=function(t){t=this.fromResourceName(t);return 4===t.length?Ei.EMPTY_PATH:this.extractLocalPathFromResourceName(t)},Object.defineProperty(sl.prototype,"encodedDatabaseId",{get:function(){return new Ei(["projects",this.databaseId.projectId,"databases",this.databaseId.database]).canonicalString()},enumerable:!0,configurable:!0}),sl.prototype.fullyQualifiedPrefixPath=function(t){return new Ei(["projects",t.projectId,"databases",t.database])},sl.prototype.extractLocalPathFromResourceName=function(t){return Cr(4<t.length&&"documents"===t.get(4),"tried to deserialize invalid key "+t.toString()),t.popFirst(5)},sl.prototype.isValidResourceName=function(t){return 4<=t.length&&"projects"===t.get(0)&&"databases"===t.get(2)},sl.prototype.toValue=function(t){if(t instanceof Sa)return{nullValue:"NULL_VALUE"};if(t instanceof Ia)return{booleanValue:t.value()};if(t instanceof Ma)return{integerValue:""+t.value()};if(t instanceof La){var e=t.value();if(this.options.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:t.value()}}return t instanceof qa?{stringValue:t.value()}:t instanceof es?{mapValue:this.toMapValue(t)}:t instanceof is?{arrayValue:this.toArrayValue(t)}:t instanceof Ba?{timestampValue:this.toTimestamp(t.internalValue)}:t instanceof $a?{geoPointValue:{latitude:t.value().latitude,longitude:t.value().longitude}}:t instanceof Ga?{bytesValue:this.toBytes(t.value())}:t instanceof Ya?{referenceValue:this.toResourceName(t.databaseId,t.key.path)}:Ir("Unknown FieldValue "+JSON.stringify(t))},sl.prototype.fromValue=function(t){var e=this;if("nullValue"in t)return Sa.INSTANCE;if("booleanValue"in t)return Ia.of(t.booleanValue);if("integerValue"in t)return new Ma(ol(t.integerValue));if("doubleValue"in t){if(this.options.useProto3Json){if("NaN"===t.doubleValue)return La.NAN;if("Infinity"===t.doubleValue)return La.POSITIVE_INFINITY;if("-Infinity"===t.doubleValue)return La.NEGATIVE_INFINITY}return new La(t.doubleValue)}if("stringValue"in t)return new qa(t.stringValue);if("mapValue"in t)return this.fromFields(t.mapValue.fields||{});if("arrayValue"in t){il(t.arrayValue,"arrayValue");var n=t.arrayValue.values||[];return new is(n.map(function(t){return e.fromValue(t)}))}if("timestampValue"in t)return il(t.timestampValue,"timestampValue"),new Ba(this.fromTimestamp(t.timestampValue));if("geoPointValue"in t){il(t.geoPointValue,"geoPointValue");var n=t.geoPointValue.latitude||0,r=t.geoPointValue.longitude||0;return new $a(new fh(n,r))}if("bytesValue"in t){il(t.bytesValue,"bytesValue");var i=this.fromBlob(t.bytesValue);return new Ga(i)}if("referenceValue"in t){il(t.referenceValue,"referenceValue");r=this.fromResourceName(t.referenceValue),i=new mi(r.get(1),r.get(3)),r=new Ai(this.extractLocalPathFromResourceName(r));return new Ya(i,r)}return Ir("Unknown Value proto "+JSON.stringify(t))},sl.prototype.toMutationDocument=function(t,e){return{name:this.toName(t),fields:this.toFields(e)}},sl.prototype.toDocument=function(t){return Cr(!t.hasLocalMutations,"Can't serialize documents with mutations."),{name:this.toName(t.key),fields:this.toFields(t.data()),updateTime:this.toTimestamp(t.version.toTimestamp())}},sl.prototype.fromDocument=function(t,e){var n=this,r=this.fromName(t.name),i=this.fromVersion(t.updateTime);return new us(r,i,{hasCommittedMutations:!!e},void 0,t,function(t){return n.fromValue(t)})},sl.prototype.toFields=function(t){var n=this,r={};return t.forEach(function(t,e){r[t]=n.toValue(e)}),r},sl.prototype.fromFields=function(t){var n=this,r=es.EMPTY;return qr(t,function(t,e){r=r.set(new Di([t]),n.fromValue(e))}),r},sl.prototype.toMapValue=function(t){return{fields:this.toFields(t)}},sl.prototype.toArrayValue=function(t){var e=this,n=[];return t.forEach(function(t){n.push(e.toValue(t))}),{values:n}},sl.prototype.fromFound=function(t){var e=this;Cr(!!t.found,"Tried to deserialize a found document from a missing document."),il(t.found.name,"doc.found.name"),il(t.found.updateTime,"doc.found.updateTime");var n=this.fromName(t.found.name),r=this.fromVersion(t.found.updateTime);return new us(n,r,{},void 0,t.found,function(t){return e.fromValue(t)})},sl.prototype.fromMissing=function(t){Cr(!!t.missing,"Tried to deserialize a missing document from a found document."),Cr(!!t.readTime,"Tried to deserialize a missing document without a read time.");var e=this.fromName(t.missing),t=this.fromVersion(t.readTime);return new ls(e,t)},sl.prototype.fromMaybeDocument=function(t){return"found"in t?this.fromFound(t):"missing"in t?this.fromMissing(t):Ir("invalid batch get response: "+JSON.stringify(t))},sl.prototype.toWatchTargetChangeState=function(t){switch(t){case eh.Added:return"ADD";case eh.Current:return"CURRENT";case eh.NoChange:return"NO_CHANGE";case eh.Removed:return"REMOVE";case eh.Reset:return"RESET";default:return Ir("Unknown WatchTargetChangeState: "+t)}},sl.prototype.toTestWatchChange=function(t){if(t instanceof th)return{filter:{count:t.existenceFilter.count,targetId:t.targetId}};if(t instanceof Zc){if(t.newDoc instanceof us){var e=t.newDoc;return{documentChange:{document:{name:this.toName(e.key),fields:this.toFields(e.data()),updateTime:this.toVersion(e.version)},targetIds:t.updatedTargetIds,removedTargetIds:t.removedTargetIds}}}if(t.newDoc instanceof ls)return e=t.newDoc,{documentDelete:{document:this.toName(e.key),readTime:this.toVersion(e.version),removedTargetIds:t.removedTargetIds}};if(null===t.newDoc)return{documentRemove:{document:this.toName(t.key),removedTargetIds:t.removedTargetIds}}}if(t instanceof nh){e=void 0;return t.cause&&(e={code:function(t){if(void 0===t)return xc.OK;switch(t){case Rr.OK:return xc.OK;case Rr.CANCELLED:return xc.CANCELLED;case Rr.UNKNOWN:return xc.UNKNOWN;case Rr.DEADLINE_EXCEEDED:return xc.DEADLINE_EXCEEDED;case Rr.RESOURCE_EXHAUSTED:return xc.RESOURCE_EXHAUSTED;case Rr.INTERNAL:return xc.INTERNAL;case Rr.UNAVAILABLE:return xc.UNAVAILABLE;case Rr.UNAUTHENTICATED:return xc.UNAUTHENTICATED;case Rr.INVALID_ARGUMENT:return xc.INVALID_ARGUMENT;case Rr.NOT_FOUND:return xc.NOT_FOUND;case Rr.ALREADY_EXISTS:return xc.ALREADY_EXISTS;case Rr.PERMISSION_DENIED:return xc.PERMISSION_DENIED;case Rr.FAILED_PRECONDITION:return xc.FAILED_PRECONDITION;case Rr.ABORTED:return xc.ABORTED;case Rr.OUT_OF_RANGE:return xc.OUT_OF_RANGE;case Rr.UNIMPLEMENTED:return xc.UNIMPLEMENTED;case Rr.DATA_LOSS:return xc.DATA_LOSS;default:return Ir("Unknown status code: "+t)}}(t.cause.code),message:t.cause.message}),{targetChange:{targetChangeType:this.toWatchTargetChangeState(t.state),targetIds:t.targetIds,resumeToken:this.unsafeCastProtoByteString(t.resumeToken),cause:e}}}return Ir("Unrecognized watch change: "+JSON.stringify(t))},sl.prototype.fromWatchChange=function(t){var e=this;if("targetChange"in t){il(t.targetChange,"targetChange");var n=this.fromWatchTargetChangeState(t.targetChange.targetChangeType||"NO_CHANGE"),r=t.targetChange.targetIds||[],i=t.targetChange.resumeToken||this.emptyByteString(),o=t.targetChange.cause,o=o&&this.fromRpcStatus(o),o=new nh(n,r,i,o||null)}else if("documentChange"in t){il(t.documentChange,"documentChange"),il(t.documentChange.document,"documentChange.name"),il(t.documentChange.document.name,"documentChange.document.name"),il(t.documentChange.document.updateTime,"documentChange.document.updateTime");var a=t.documentChange,s=this.fromName(a.document.name),u=this.fromVersion(a.document.updateTime),c=new us(s,u,{},void 0,a.document,function(t){return e.fromValue(t)}),h=a.targetIds||[],a=a.removedTargetIds||[];o=new Zc(h,a,c.key,c)}else if("documentDelete"in t){il(t.documentDelete,"documentDelete"),il(t.documentDelete.document,"documentDelete.document");h=t.documentDelete,s=this.fromName(h.document),u=h.readTime?this.fromVersion(h.readTime):Wi.forDeletedDoc(),c=new ls(s,u),a=h.removedTargetIds||[];o=new Zc([],a,c.key,c)}else if("documentRemove"in t){il(t.documentRemove,"documentRemove"),il(t.documentRemove.document,"documentRemove");c=t.documentRemove;s=this.fromName(c.document),a=c.removedTargetIds||[],o=new Zc([],a,s,null)}else{if(!("filter"in t))return Ir("Unknown change type "+JSON.stringify(t));il(t.filter,"filter"),il(t.filter.targetId,"filter.targetId");s=t.filter,t=s.count||0,t=new Zh(t),s=s.targetId;o=new th(s,t)}return o},sl.prototype.fromWatchTargetChangeState=function(t){return"NO_CHANGE"===t?eh.NoChange:"ADD"===t?eh.Added:"REMOVE"===t?eh.Removed:"CURRENT"===t?eh.Current:"RESET"===t?eh.Reset:Ir("Got unexpected TargetChange.state: "+t)},sl.prototype.versionFromListenResponse=function(t){if(!("targetChange"in t))return Wi.MIN;t=t.targetChange;return(!t.targetIds||!t.targetIds.length)&&t.readTime?this.fromVersion(t.readTime):Wi.MIN},sl.prototype.toMutation=function(t){var e,n=this;if(t instanceof ia)e={update:this.toMutationDocument(t.key,t.value)};else if(t instanceof ma)e={delete:this.toName(t.key)};else if(t instanceof sa)e={update:this.toMutationDocument(t.key,t.data),updateMask:this.toDocumentMask(t.fieldMask)};else{if(!(t instanceof ha))return Ir("Unknown mutation type "+t.type);e={transform:{document:this.toName(t.key),fieldTransforms:t.fieldTransforms.map(function(t){return n.toFieldTransform(t)})}}}return t.precondition.isNone||(e.currentDocument=this.toPrecondition(t.precondition)),e},sl.prototype.fromMutation=function(t){var e=this,n=t.currentDocument?this.fromPrecondition(t.currentDocument):Zo.NONE;if(t.update){il(t.update.name,"name");var r=this.fromName(t.update.name),i=this.fromFields(t.update.fields||{});if(t.updateMask){var o=this.fromDocumentMask(t.updateMask);return new sa(r,i,o,n)}return new ia(r,i,n)}if(t.delete)return r=this.fromName(t.delete),new ma(r,n);if(t.transform){r=this.fromName(t.transform.document),i=t.transform.fieldTransforms.map(function(t){return e.fromFieldTransform(t)});return Cr(!0===n.exists,'Transforms only support precondition "exists == true"'),new ha(r,i)}return Ir("unknown mutation proto: "+JSON.stringify(t))},sl.prototype.toPrecondition=function(t){return Cr(!t.isNone,"Can't serialize an empty precondition"),void 0!==t.updateTime?{updateTime:this.toVersion(t.updateTime)}:void 0!==t.exists?{exists:t.exists}:Ir("Unknown precondition")},sl.prototype.fromPrecondition=function(t){return void 0!==t.updateTime?Zo.updateTime(this.fromVersion(t.updateTime)):void 0!==t.exists?Zo.exists(t.exists):Zo.NONE},sl.prototype.fromWriteResult=function(t,e){var n=this,r=t.updateTime?this.fromVersion(t.updateTime):this.fromVersion(e),e=null;return t.transformResults&&0<t.transformResults.length&&(e=t.transformResults.map(function(t){return n.fromValue(t)})),new Jo(r,e)},sl.prototype.fromWriteResults=function(t,e){var n=this;return t&&0<t.length?(Cr(void 0!==e,"Received a write result without a commit time"),t.map(function(t){return n.fromWriteResult(t,e)})):[]},sl.prototype.toFieldTransform=function(t){var e=this,n=t.transform;if(n instanceof jh)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof Gh)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements.map(function(t){return e.toValue(t)})}};if(n instanceof Hh)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements.map(function(t){return e.toValue(t)})}};if(n instanceof Xh)return{fieldPath:t.field.canonicalString(),increment:this.toValue(n.operand)};throw Ir("Unknown transform: "+t.transform)},sl.prototype.fromFieldTransform=function(t){var e,n=this,r=null;"setToServerValue"in t?(Cr("REQUEST_TIME"===t.setToServerValue,"Unknown server value transform proto: "+JSON.stringify(t)),r=jh.instance):"appendMissingElements"in t?(e=t.appendMissingElements.values||[],r=new Gh(e.map(function(t){return n.fromValue(t)}))):"removeAllFromArray"in t?(e=t.removeAllFromArray.values||[],r=new Hh(e.map(function(t){return n.fromValue(t)}))):"increment"in t?(Cr((e=this.fromValue(t.increment))instanceof Na,"NUMERIC_ADD transform requires a NumberValue"),r=new Xh(e)):Ir("Unknown transform proto: "+JSON.stringify(t));t=Di.fromServerFormat(t.fieldPath);return new Yo(t,r)},sl.prototype.toDocumentsTarget=function(t){return{documents:[this.toQueryPath(t.path)]}},sl.prototype.fromDocumentsTarget=function(t){var e=t.documents.length;Cr(1===e,"DocumentsTarget contained other than 1 document: "+e);t=t.documents[0];return dh.atPath(this.fromQueryPath(t))},sl.prototype.toQueryTarget=function(t){var e={structuredQuery:{}},n=t.path;null!==t.collectionGroup?(Cr(n.length%2==0,"Collection Group queries should be within a document path or root."),e.parent=this.toQueryPath(n),e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(Cr(n.length%2!=0,"Document queries with filters are not supported."),e.parent=this.toQueryPath(n.popLast()),e.structuredQuery.from=[{collectionId:n.lastSegment()}]);n=this.toFilter(t.filters);n&&(e.structuredQuery.where=n);n=this.toOrder(t.orderBy);n&&(e.structuredQuery.orderBy=n);n=this.toInt32Value(t.limit);return void 0!==n&&(e.structuredQuery.limit=n),t.startAt&&(e.structuredQuery.startAt=this.toCursor(t.startAt)),t.endAt&&(e.structuredQuery.endAt=this.toCursor(t.endAt)),e},sl.prototype.fromQueryTarget=function(t){var e=this.fromQueryPath(t.parent),n=t.structuredQuery,r=n.from?n.from.length:0,i=null;0<r&&(Cr(1===r,"StructuredQuery.from with more than one collection is not supported."),(s=n.from[0]).allDescendants?i=s.collectionId:e=e.child(s.collectionId));var o=[];n.where&&(o=this.fromFilter(n.where));var a=[];n.orderBy&&(a=this.fromOrder(n.orderBy));t=null;n.limit&&(t=this.fromInt32Value(n.limit));r=null;n.startAt&&(r=this.fromCursor(n.startAt));var s=null;return n.endAt&&(s=this.fromCursor(n.endAt)),new dh(e,i,a,o,t,r,s)},sl.prototype.toListenRequestLabels=function(t){t=this.toLabel(t.purpose);return null==t?null:{"goog-listen-tags":t}},sl.prototype.toLabel=function(t){switch(t){case lu.Listen:return null;case lu.ExistenceFilterMismatch:return"existence-filter-mismatch";case lu.LimboResolution:return"limbo-document";default:return Ir("Unrecognized query purpose: "+t)}},sl.prototype.toTarget=function(t){var e=t.query;return(e=e.isDocumentQuery()?{documents:this.toDocumentsTarget(e)}:{query:this.toQueryTarget(e)}).targetId=t.targetId,0<t.resumeToken.length&&(e.resumeToken=this.unsafeCastProtoByteString(t.resumeToken)),e},sl.prototype.toFilter=function(t){var e=this;if(0!==t.length){t=t.map(function(t){return t instanceof bh?e.toUnaryOrFieldFilter(t):Ir("Unrecognized filter: "+JSON.stringify(t))});return 1===t.length?t[0]:{compositeFilter:{op:"AND",filters:t}}}},sl.prototype.fromFilter=function(t){var e=this;return t?void 0!==t.unaryFilter?[this.fromUnaryFilter(t)]:void 0!==t.fieldFilter?[this.fromFieldFilter(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map(function(t){return e.fromFilter(t)}).reduce(function(t,e){return t.concat(e)}):Ir("Unknown filter: "+JSON.stringify(t)):[]},sl.prototype.toOrder=function(t){var e=this;if(0!==t.length)return t.map(function(t){return e.toPropertyOrder(t)})},sl.prototype.fromOrder=function(t){var e=this;return t.map(function(t){return e.fromPropertyOrder(t)})},sl.prototype.toCursor=function(t){var e=this;return{before:t.before,values:t.position.map(function(t){return e.toValue(t)})}},sl.prototype.fromCursor=function(t){var e=this,n=!!t.before,t=t.values.map(function(t){return e.fromValue(t)});return new Fh(t,n)},sl.prototype.toDirection=function(t){return el[t.name]},sl.prototype.fromDirection=function(t){switch(t){case"ASCENDING":return xh.ASCENDING;case"DESCENDING":return xh.DESCENDING;default:return}},sl.prototype.toOperatorName=function(t){return nl[t.name]},sl.prototype.fromOperatorName=function(t){switch(t){case"EQUAL":return yh.EQUAL;case"GREATER_THAN":return yh.GREATER_THAN;case"GREATER_THAN_OR_EQUAL":return yh.GREATER_THAN_OR_EQUAL;case"LESS_THAN":return yh.LESS_THAN;case"LESS_THAN_OR_EQUAL":return yh.LESS_THAN_OR_EQUAL;case"ARRAY_CONTAINS":return yh.ARRAY_CONTAINS;case"IN":return yh.IN;case"ARRAY_CONTAINS_ANY":return yh.ARRAY_CONTAINS_ANY;case"OPERATOR_UNSPECIFIED":return Ir("Unspecified operator");default:return Ir("Unknown operator")}},sl.prototype.toFieldPathReference=function(t){return{fieldPath:t.canonicalString()}},sl.prototype.fromFieldPathReference=function(t){return Di.fromServerFormat(t.fieldPath)},sl.prototype.toPropertyOrder=function(t){return{field:this.toFieldPathReference(t.field),direction:this.toDirection(t.dir)}},sl.prototype.fromPropertyOrder=function(t){return new Bh(this.fromFieldPathReference(t.field),this.fromDirection(t.direction))},sl.prototype.fromFieldFilter=function(t){return bh.create(this.fromFieldPathReference(t.fieldFilter.field),this.fromOperatorName(t.fieldFilter.op),this.fromValue(t.fieldFilter.value))},sl.prototype.toUnaryOrFieldFilter=function(t){if(t.op===yh.EQUAL){if(t.value.isEqual(La.NAN))return{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NAN"}};if(t.value.isEqual(Sa.INSTANCE))return{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NULL"}}}return{fieldFilter:{field:this.toFieldPathReference(t.field),op:this.toOperatorName(t.op),value:this.toValue(t.value)}}},sl.prototype.fromUnaryFilter=function(t){switch(t.unaryFilter.op){case"IS_NAN":var e=this.fromFieldPathReference(t.unaryFilter.field);return bh.create(e,yh.EQUAL,La.NAN);case"IS_NULL":e=this.fromFieldPathReference(t.unaryFilter.field);return bh.create(e,yh.EQUAL,Sa.INSTANCE);case"OPERATOR_UNSPECIFIED":return Ir("Unspecified filter");default:return Ir("Unknown filter")}},sl.prototype.toDocumentMask=function(t){var e=[];return t.fields.forEach(function(t){return e.push(t.canonicalString())}),{fieldPaths:e}},sl.prototype.fromDocumentMask=function(t){t=(t.fieldPaths||[]).map(function(t){return Di.fromServerFormat(t)});return zo.fromArray(t)},sl);function sl(t,e){this.databaseId=t,this.options=e}function ul(){this.viewSnap=null,this.targetId=0,this.listeners=[]}var cl=(hl.prototype.listen=function(t){var e=t.query,n=!1,r=this.queries.get(e);return r||(n=!0,r=new ul,this.queries.set(e,r)),r.listeners.push(t),Cr(!t.applyOnlineStateChange(this.onlineState),"applyOnlineStateChange() shouldn't raise an event for brand-new listeners."),!r.viewSnap||t.onViewSnapshot(r.viewSnap)&&this.raiseSnapshotsInSyncEvent(),n?this.syncEngine.listen(e).then(function(t){return r.targetId=t}):Promise.resolve(r.targetId)},hl.prototype.unlisten=function(o){return p(this,void 0,void 0,function(){var e,n,r,i;return d(this,function(t){return e=o.query,n=!1,(r=this.queries.get(e))&&0<=(i=r.listeners.indexOf(o))&&(r.listeners.splice(i,1),n=0===r.listeners.length),n?(this.queries.delete(e),[2,this.syncEngine.unlisten(e)]):[2]})})},hl.prototype.onWatchChange=function(t){for(var e=!1,n=0,r=t;n<r.length;n++){var i=r[n],o=i.query,o=this.queries.get(o);if(o){for(var a=0,s=o.listeners;a<s.length;a++)s[a].onViewSnapshot(i)&&(e=!0);o.viewSnap=i}}e&&this.raiseSnapshotsInSyncEvent()},hl.prototype.onWatchError=function(t,e){var n=this.queries.get(t);if(n)for(var r=0,i=n.listeners;r<i.length;r++)i[r].onError(e);this.queries.delete(t)},hl.prototype.onOnlineStateChange=function(i){this.onlineState=i;var o=!1;this.queries.forEach(function(t,e){for(var n=0,r=e.listeners;n<r.length;n++)r[n].applyOnlineStateChange(i)&&(o=!0)}),o&&this.raiseSnapshotsInSyncEvent()},hl.prototype.addSnapshotsInSyncListener=function(t){this.snapshotsInSyncListeners.add(t),t.next()},hl.prototype.removeSnapshotsInSyncListener=function(t){this.snapshotsInSyncListeners.delete(t)},hl.prototype.raiseSnapshotsInSyncEvent=function(){this.snapshotsInSyncListeners.forEach(function(t){t.next()})},hl);function hl(t){this.syncEngine=t,this.queries=new ys(function(t){return t.canonicalId()}),this.onlineState=_c.Unknown,this.snapshotsInSyncListeners=new Set,this.syncEngine.subscribe(this)}var ll=(fl.prototype.onViewSnapshot=function(t){if(Cr(0<t.docChanges.length||t.syncStateChanged,"We got a new snapshot with no changes?"),!this.options.includeMetadataChanges){for(var e=[],n=0,r=t.docChanges;n<r.length;n++){var i=r[n];i.type!==Uc.Metadata&&e.push(i)}t=new zc(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}var o=!1;return this.raisedInitialEvent?this.shouldRaiseEvent(t)&&(this.queryObserver.next(t),o=!0):this.shouldRaiseInitialEvent(t,this.onlineState)&&(this.raiseInitialEvent(t),o=!0),this.snap=t,o},fl.prototype.onError=function(t){this.queryObserver.error(t)},fl.prototype.applyOnlineStateChange=function(t){this.onlineState=t;var e=!1;return this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,t)&&(this.raiseInitialEvent(this.snap),e=!0),e},fl.prototype.shouldRaiseInitialEvent=function(t,e){return Cr(!this.raisedInitialEvent,"Determining whether to raise first event but already had first event"),!t.fromCache||(this.options.waitForSyncWhenOnline&&e!==_c.Offline?(Cr(t.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!t.docs.isEmpty()||e===_c.Offline)},fl.prototype.shouldRaiseEvent=function(t){if(0<t.docChanges.length)return!0;var e=this.snap&&this.snap.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges},fl.prototype.raiseInitialEvent=function(t){Cr(!this.raisedInitialEvent,"Trying to raise initial events for second time"),t=zc.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.raisedInitialEvent=!0,this.queryObserver.next(t)},fl);function fl(t,e,n){this.query=t,this.queryObserver=e,this.raisedInitialEvent=!1,this.snap=null,this.onlineState=_c.Unknown,this.options=n||{}}var pl=(dl.fromSnapshot=function(t,e){for(var n=co(),r=co(),i=0,o=e.docChanges;i<o.length;i++){var a=o[i];switch(a.type){case Uc.Added:n=n.add(a.doc.key);break;case Uc.Removed:r=r.add(a.doc.key)}}return new dl(t,n,r)},dl);function dl(t,e,n){this.targetId=t,this.addedKeys=e,this.removedKeys=n}function ml(t){this.key=t}function yl(t){this.key=t}var gl=(Object.defineProperty(vl.prototype,"syncedDocuments",{get:function(){return this._syncedDocuments},enumerable:!0,configurable:!0}),vl.prototype.computeDocChanges=function(t,e){var a=this,s=e?e.changeSet:new Wc,u=(e||this).documentSet,c=(e||this).mutatedKeys,h=u,l=!1,f=this.query.hasLimit()&&u.size===this.query.limit?u.last():null;if(t.inorderTraversal(function(t,e){var n=u.get(t),r=e instanceof us?e:null;r&&(Cr(t.isEqual(r.key),"Mismatching keys found in document changes: "+t+" != "+r.key),r=a.query.matches(r)?r:null);var i=!!n&&a.mutatedKeys.has(n.key),o=!!r&&(r.hasLocalMutations||a.mutatedKeys.has(r.key)&&r.hasCommittedMutations),e=!1;n&&r?n.data().isEqual(r.data())?i!==o&&(s.track({type:Uc.Metadata,doc:r}),e=!0):a.shouldWaitForSyncedDocument(n,r)||(s.track({type:Uc.Modified,doc:r}),e=!0,f&&0<a.query.docComparator(r,f)&&(l=!0)):!n&&r?(s.track({type:Uc.Added,doc:r}),e=!0):n&&!r&&(s.track({type:Uc.Removed,doc:n}),e=!0,f&&(l=!0)),e&&(c=r?(h=h.add(r),o?c.add(t):c.delete(t)):(h=h.delete(t),c.delete(t)))}),this.query.hasLimit())for(;h.size>this.query.limit;){var n=h.last(),h=h.delete(n.key),c=c.delete(n.key);s.track({type:Uc.Removed,doc:n})}return Cr(!l||!e,"View was refilled using docs that themselves needed refilling."),{documentSet:h,changeSet:s,needsRefill:l,mutatedKeys:c}},vl.prototype.shouldWaitForSyncedDocument=function(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations},vl.prototype.applyChanges=function(t,e,n){var o=this;Cr(!t.needsRefill,"Cannot apply changes that need a refill");var r=this.documentSet;this.documentSet=t.documentSet,this.mutatedKeys=t.mutatedKeys;var i=t.changeSet.getChanges();i.sort(function(t,e){return r=t.type,i=e.type,n(r)-n(i)||o.query.docComparator(t.doc,e.doc);function n(t){switch(t){case Uc.Added:return 1;case Uc.Modified:case Uc.Metadata:return 2;case Uc.Removed:return 0;default:return Ir("Unknown ChangeType: "+t)}}var r,i}),this.applyTargetChange(n);var a=e?this.updateLimboDocuments():[],n=0===this.limboDocuments.size&&this.current?Qc.Synced:Qc.Local,e=n!==this.syncState;return this.syncState=n,0!==i.length||e?{snapshot:new zc(this.query,t.documentSet,r,i,t.mutatedKeys,n===Qc.Local,e,!1),limboChanges:a}:{limboChanges:a}},vl.prototype.applyOnlineStateChange=function(t){return this.current&&t===_c.Offline?(this.current=!1,this.applyChanges({documentSet:this.documentSet,changeSet:new Wc,mutatedKeys:this.mutatedKeys,needsRefill:!1},!1)):{limboChanges:[]}},vl.prototype.shouldBeInLimbo=function(t){return!this._syncedDocuments.has(t)&&!!this.documentSet.has(t)&&!this.documentSet.get(t).hasLocalMutations},vl.prototype.applyTargetChange=function(t){var e=this;t&&(t.addedDocuments.forEach(function(t){return e._syncedDocuments=e._syncedDocuments.add(t)}),t.modifiedDocuments.forEach(function(t){return Cr(e._syncedDocuments.has(t),"Modified document "+t+" not found in view.")}),t.removedDocuments.forEach(function(t){return e._syncedDocuments=e._syncedDocuments.delete(t)}),this.current=t.current)},vl.prototype.updateLimboDocuments=function(){var e=this;if(!this.current)return[];var n=this.limboDocuments;this.limboDocuments=co(),this.documentSet.forEach(function(t){e.shouldBeInLimbo(t.key)&&(e.limboDocuments=e.limboDocuments.add(t.key))});var r=[];return n.forEach(function(t){e.limboDocuments.has(t)||r.push(new yl(t))}),this.limboDocuments.forEach(function(t){n.has(t)||r.push(new ml(t))}),r},vl.prototype.synchronizeWithPersistedState=function(t,e){this._syncedDocuments=e,this.limboDocuments=co();t=this.computeDocChanges(t);return this.applyChanges(t,!0)},vl.prototype.computeInitialSnapshot=function(){return zc.fromInitialDocuments(this.query,this.documentSet,this.mutatedKeys,this.syncState===Qc.Local)},vl);function vl(t,e){this.query=t,this._syncedDocuments=e,this.syncState=null,this.current=!1,this.limboDocuments=co(),this.mutatedKeys=co(),this.documentSet=new Kc(t.docComparator.bind(t))}var bl=(wl.prototype.run=function(){this.runWithBackOff()},wl.prototype.runWithBackOff=function(){var t=this;this.backoff.backoffAndRun(function(){return p(t,void 0,void 0,function(){var e,n,r=this;return d(this,function(t){return e=this.remoteStore.createTransaction(),(n=this.tryRunUpdateFunction(e))&&n.then(function(t){r.asyncQueue.enqueueAndForget(function(){return e.commit().then(function(){r.deferred.resolve(t)}).catch(function(t){r.handleTransactionError(t)})})}).catch(function(t){r.handleTransactionError(t)}),[2]})})})},wl.prototype.tryRunUpdateFunction=function(t){try{var e=this.updateFunction(t);return!gc(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}},wl.prototype.handleTransactionError=function(t){var e=this;0<this.retries&&this.isRetryableTransactionError(t)?(--this.retries,this.asyncQueue.enqueueAndForget(function(){return e.runWithBackOff(),Promise.resolve()})):this.deferred.reject(t)},wl.prototype.isRetryableTransactionError=function(t){if("FirebaseError"!==t.name)return!1;t=t.code;return"aborted"===t||"failed-precondition"===t||!Vc(t)},wl);function wl(t,e,n,r){this.asyncQueue=t,this.remoteStore=e,this.updateFunction=n,this.deferred=r,this.retries=5,this.backoff=new bc(this.asyncQueue,Mi.RetryTransaction)}function Sl(t,e,n){this.query=t,this.targetId=e,this.view=n}function El(t){this.key=t,this.receivedDocument=!1}var Tl="SyncEngine",Il=(Object.defineProperty(Cl.prototype,"isPrimaryClient",{get:function(){return!0===this.isPrimary},enumerable:!0,configurable:!0}),Cl.prototype.subscribe=function(t){Cr(null!==t,"SyncEngine listener cannot be null"),Cr(null===this.syncEngineListener,"SyncEngine already has a subscriber."),this.syncEngineListener=t},Cl.prototype.listen=function(o){return p(this,void 0,void 0,function(){var e,n,r,i;return d(this,function(t){switch(t.label){case 0:return this.assertSubscribed("listen()"),(i=this.queryViewsByQuery.get(o))?(e=i.targetId,this.sharedClientState.addLocalQueryTarget(e),n=i.view.computeInitialSnapshot(),[3,4]):[3,1];case 1:return[4,this.localStore.allocateQuery(o)];case 2:return r=t.sent(),i=this.sharedClientState.addLocalQueryTarget(r.targetId),e=r.targetId,[4,this.initializeViewAndComputeSnapshot(r,"current"===i)];case 3:n=t.sent(),this.isPrimary&&this.remoteStore.listen(r),t.label=4;case 4:return this.syncEngineListener.onWatchChange([n]),[2,e]}})})},Cl.prototype.initializeViewAndComputeSnapshot=function(a,s){return p(this,void 0,void 0,function(){var e,n,r,i,o;return d(this,function(t){switch(t.label){case 0:return e=a.query,[4,this.localStore.executeQuery(e)];case 1:return n=t.sent(),[4,this.localStore.remoteDocumentKeys(a.targetId)];case 2:return i=t.sent(),o=new gl(e,i),r=o.computeDocChanges(n),i=Jc.createSynthesizedTargetChangeForCurrentChange(a.targetId,s&&this.onlineState!==_c.Offline),Cr(0===(i=o.applyChanges(r,!0===this.isPrimary,i)).limboChanges.length,"View returned limbo docs before target ack from the server."),Cr(!!i.snapshot,"applyChanges for new view should always return a snapshot"),o=new Sl(e,a.targetId,o),this.queryViewsByQuery.set(e,o),this.queryViewsByTarget[a.targetId]=o,[2,i.snapshot]}})})},Cl.prototype.synchronizeViewAndComputeSnapshot=function(r){return p(this,void 0,void 0,function(){var e,n;return d(this,function(t){switch(t.label){case 0:return[4,this.localStore.executeQuery(r.query)];case 1:return e=t.sent(),[4,this.localStore.remoteDocumentKeys(r.targetId)];case 2:return n=t.sent(),n=r.view.synchronizeWithPersistedState(e,n),this.isPrimary&&this.updateTrackedLimbos(r.targetId,n.limboChanges),[2,n]}})})},Cl.prototype.unlisten=function(r){return p(this,void 0,void 0,function(){var e,n=this;return d(this,function(t){switch(t.label){case 0:return this.assertSubscribed("unlisten()"),Cr(!!(e=this.queryViewsByQuery.get(r)),"Trying to unlisten on query not found:"+r),this.isPrimary?(this.sharedClientState.removeLocalQueryTarget(e.targetId),this.sharedClientState.isActiveQueryTarget(e.targetId)?[3,2]:[4,this.localStore.releaseQuery(r,!1).then(function(){n.sharedClientState.clearQueryState(e.targetId),n.remoteStore.unlisten(e.targetId),n.removeAndCleanupQuery(e)}).catch(Fu)]):[3,3];case 1:t.sent(),t.label=2;case 2:return[3,5];case 3:return this.removeAndCleanupQuery(e),[4,this.localStore.releaseQuery(r,!0)];case 4:t.sent(),t.label=5;case 5:return[2]}})})},Cl.prototype.write=function(n,r){return p(this,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:return this.assertSubscribed("write()"),[4,this.localStore.localWrite(n)];case 1:return e=t.sent(),this.sharedClientState.addPendingMutation(e.batchId),this.addMutationCallback(e.batchId,r),[4,this.emitNewSnapsAndNotifyLocalStore(e.changes)];case 2:return t.sent(),[4,this.remoteStore.fillWritePipeline()];case 3:return t.sent(),[2]}})})},Cl.prototype.runTransaction=function(t,e,n){new bl(t,this.remoteStore,e,n).run()},Cl.prototype.applyRemoteEvent=function(r){return p(this,void 0,void 0,function(){var e,n=this;return d(this,function(t){switch(t.label){case 0:this.assertSubscribed("applyRemoteEvent()"),t.label=1;case 1:return t.trys.push([1,4,,6]),[4,this.localStore.applyRemoteEvent(r)];case 2:return e=t.sent(),qr(r.targetChanges,function(t,e){t=n.limboResolutionsByTarget[Number(t)];t&&(Cr(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1,"Limbo resolution for single document contains multiple changes."),0<e.addedDocuments.size?t.receivedDocument=!0:0<e.modifiedDocuments.size?Cr(t.receivedDocument,"Received change for limbo target document without add."):0<e.removedDocuments.size&&(Cr(t.receivedDocument,"Received remove for limbo target document without add."),t.receivedDocument=!1))}),[4,this.emitNewSnapsAndNotifyLocalStore(e,r)];case 3:return t.sent(),[3,6];case 4:return[4,Fu(t.sent())];case 5:return t.sent(),[3,6];case 6:return[2]}})})},Cl.prototype.applyOnlineStateChange=function(n,t){var r;(this.isPrimary&&t===Oc.RemoteStore||!this.isPrimary&&t===Oc.SharedClientState)&&(this.assertSubscribed("applyOnlineStateChange()"),r=[],this.queryViewsByQuery.forEach(function(t,e){e=e.view.applyOnlineStateChange(n);Cr(0===e.limboChanges.length,"OnlineState should not affect limbo documents."),e.snapshot&&r.push(e.snapshot)}),this.syncEngineListener.onOnlineStateChange(n),this.syncEngineListener.onWatchChange(r),this.onlineState=n,this.isPrimary&&this.sharedClientState.setOnlineState(n))},Cl.prototype.rejectListen=function(o,a){return p(this,void 0,void 0,function(){var e,n,r,i=this;return d(this,function(t){switch(t.label){case 0:return this.assertSubscribed("rejectListens()"),this.sharedClientState.updateQueryState(o,"rejected",a),e=this.limboResolutionsByTarget[o],(n=e&&e.key)?(this.limboTargetsByKey=this.limboTargetsByKey.remove(n),delete this.limboResolutionsByTarget[o],e=(e=new zi(Ai.comparator)).insert(n,new ls(n,Wi.forDeletedDoc())),n=co().add(n),n=new Yc(Wi.MIN,{},new eo(oi),e,n),[2,this.applyRemoteEvent(n)]):[3,1];case 1:return Cr(!!(r=this.queryViewsByTarget[o]),"Unknown targetId: "+o),[4,this.localStore.releaseQuery(r.query,!1).then(function(){return i.removeAndCleanupQuery(r)}).catch(Fu)];case 2:t.sent(),this.syncEngineListener.onWatchError(r.query,a),t.label=3;case 3:return[2]}})})},Cl.prototype.applyBatchState=function(n,r,i){return p(this,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:return this.assertSubscribed("applyBatchState()"),[4,this.localStore.lookupMutationDocuments(n)];case 1:return null===(e=t.sent())?(Sr(Tl,"Cannot apply mutation batch with id: "+n),[2]):"pending"!==r?[3,3]:[4,this.remoteStore.fillWritePipeline()];case 2:return t.sent(),[3,4];case 3:"acknowledged"===r||"rejected"===r?(this.processUserCallback(n,i||null),this.localStore.removeCachedMutationBatchMetadata(n)):Ir("Unknown batchState: "+r),t.label=4;case 4:return[4,this.emitNewSnapsAndNotifyLocalStore(e)];case 5:return t.sent(),[2]}})})},Cl.prototype.applySuccessfulWrite=function(r){return p(this,void 0,void 0,function(){var e,n;return d(this,function(t){switch(t.label){case 0:this.assertSubscribed("applySuccessfulWrite()"),e=r.batch.batchId,this.processUserCallback(e,null),this.triggerPendingWritesCallbacks(e),t.label=1;case 1:return t.trys.push([1,4,,6]),[4,this.localStore.acknowledgeBatch(r)];case 2:return n=t.sent(),this.sharedClientState.updateMutationState(e,"acknowledged"),[4,this.emitNewSnapsAndNotifyLocalStore(n)];case 3:return t.sent(),[3,6];case 4:return[4,Fu(t.sent())];case 5:return t.sent(),[3,6];case 6:return[2]}})})},Cl.prototype.rejectFailedWrite=function(n,r){return p(this,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:this.assertSubscribed("rejectFailedWrite()"),this.processUserCallback(n,r),this.triggerPendingWritesCallbacks(n),t.label=1;case 1:return t.trys.push([1,4,,6]),[4,this.localStore.rejectBatch(n)];case 2:return e=t.sent(),this.sharedClientState.updateMutationState(n,"rejected",r),[4,this.emitNewSnapsAndNotifyLocalStore(e)];case 3:return t.sent(),[3,6];case 4:return[4,Fu(t.sent())];case 5:return t.sent(),[3,6];case 6:return[2]}})})},Cl.prototype.registerPendingWritesCallback=function(r){return p(this,void 0,void 0,function(){var e,n;return d(this,function(t){switch(t.label){case 0:return this.remoteStore.canUseNetwork()||Sr(Tl,"The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled."),[4,this.localStore.getHighestUnacknowledgedBatchId()];case 1:return-1===(e=t.sent())?r.resolve():((n=this.pendingWritesCallbacks.get(e)||[]).push(r),this.pendingWritesCallbacks.set(e,n)),[2]}})})},Cl.prototype.triggerPendingWritesCallbacks=function(t){(this.pendingWritesCallbacks.get(t)||[]).forEach(function(t){t.resolve()}),this.pendingWritesCallbacks.delete(t)},Cl.prototype.rejectOutstandingPendingWritesCallbacks=function(e){this.pendingWritesCallbacks.forEach(function(t){t.forEach(function(t){t.reject(new Mr(Rr.CANCELLED,e))})}),this.pendingWritesCallbacks.clear()},Cl.prototype.addMutationCallback=function(t,e){var n=(n=(n=this.mutationUserCallbacks[this.currentUser.toKey()])||new zi(oi)).insert(t,e);this.mutationUserCallbacks[this.currentUser.toKey()]=n},Cl.prototype.processUserCallback=function(t,e){var n,r=this.mutationUserCallbacks[this.currentUser.toKey()];r&&((n=r.get(t))&&(Cr(t===r.minKey(),"Mutation callbacks processed out-of-order?"),e?n.reject(e):n.resolve(),r=r.remove(t)),this.mutationUserCallbacks[this.currentUser.toKey()]=r)},Cl.prototype.removeAndCleanupQuery=function(t){var e,n=this;this.sharedClientState.removeLocalQueryTarget(t.targetId),this.queryViewsByQuery.delete(t.query),delete this.queryViewsByTarget[t.targetId],this.isPrimary&&(e=this.limboDocumentRefs.referencesForId(t.targetId),this.limboDocumentRefs.removeReferencesForId(t.targetId),e.forEach(function(t){n.limboDocumentRefs.containsKey(t)||n.removeLimboTarget(t)}))},Cl.prototype.removeLimboTarget=function(t){var e=this.limboTargetsByKey.get(t);null!==e&&(this.remoteStore.unlisten(e),this.limboTargetsByKey=this.limboTargetsByKey.remove(t),delete this.limboResolutionsByTarget[e])},Cl.prototype.updateTrackedLimbos=function(t,e){for(var n=0,r=e;n<r.length;n++){var i=r[n];i instanceof ml?(this.limboDocumentRefs.addReference(i.key,t),this.trackLimboChange(i)):i instanceof yl?(Sr(Tl,"Document no longer in limbo: "+i.key),this.limboDocumentRefs.removeReference(i.key,t),this.limboDocumentRefs.containsKey(i.key)||this.removeLimboTarget(i.key)):Ir("Unknown limbo change: "+JSON.stringify(i))}},Cl.prototype.trackLimboChange=function(t){var e,n=t.key;this.limboTargetsByKey.get(n)||(Sr(Tl,"New document in limbo: "+n),e=this.limboTargetIdGenerator.next(),t=dh.atPath(n.path),this.limboResolutionsByTarget[e]=new El(n),this.remoteStore.listen(new yu(t,e,lu.LimboResolution,gi.INVALID)),this.limboTargetsByKey=this.limboTargetsByKey.insert(n,e))},Cl.prototype.currentLimboDocs=function(){return this.limboTargetsByKey},Cl.prototype.emitNewSnapsAndNotifyLocalStore=function(a,s){return p(this,void 0,void 0,function(){var r,i,e,o=this;return d(this,function(t){switch(t.label){case 0:return r=[],i=[],e=[],this.queryViewsByQuery.forEach(function(t,n){e.push(Promise.resolve().then(function(){var e=n.view.computeDocChanges(a);return e.needsRefill?o.localStore.executeQuery(n.query).then(function(t){return n.view.computeDocChanges(t,e)}):e}).then(function(t){var e=s&&s.targetChanges[n.targetId],e=n.view.applyChanges(t,!0===o.isPrimary,e);o.updateTrackedLimbos(n.targetId,e.limboChanges),e.snapshot&&(o.isPrimary&&o.sharedClientState.updateQueryState(n.targetId,e.snapshot.fromCache?"not-current":"current"),r.push(e.snapshot),e=pl.fromSnapshot(n.targetId,e.snapshot),i.push(e))}))}),[4,Promise.all(e)];case 1:return t.sent(),this.syncEngineListener.onWatchChange(r),[4,this.localStore.notifyLocalViewChanges(i)];case 2:return t.sent(),[2]}})})},Cl.prototype.assertSubscribed=function(t){Cr(null!==this.syncEngineListener,"Trying to call "+t+" before calling subscribe().")},Cl.prototype.handleCredentialChange=function(n){return p(this,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:return e=!this.currentUser.isEqual(n),this.currentUser=n,e?(this.rejectOutstandingPendingWritesCallbacks("'waitForPendingWrites' promise is rejected due to a user change."),[4,this.localStore.handleUserChange(n)]):[3,3];case 1:return e=t.sent(),this.sharedClientState.handleUserChange(n,e.removedBatchIds,e.addedBatchIds),[4,this.emitNewSnapsAndNotifyLocalStore(e.affectedDocuments)];case 2:t.sent(),t.label=3;case 3:return[4,this.remoteStore.handleCredentialChange()];case 4:return t.sent(),[2]}})})},Cl.prototype.applyPrimaryState=function(u){return p(this,void 0,void 0,function(){var e,n,r,i,o,a,s=this;return d(this,function(t){switch(t.label){case 0:return!0!==u||!0===this.isPrimary?[3,3]:(this.isPrimary=!0,[4,this.remoteStore.applyPrimaryState(!0)]);case 1:return t.sent(),e=this.sharedClientState.getAllActiveQueryTargets(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(e.toArray())];case 2:for(e=t.sent(),n=0,r=e;n<r.length;n++)i=r[n],this.remoteStore.listen(i);return[3,7];case 3:return!1!==u||!1===this.isPrimary?[3,7]:(this.isPrimary=!1,o=[],a=Promise.resolve(),xr(this.queryViewsByTarget,function(t,e){s.sharedClientState.isLocalQueryTarget(t)?o.push(t):a=a.then(function(){return s.unlisten(e.query)}),s.remoteStore.unlisten(e.targetId)}),[4,a]);case 4:return t.sent(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(o)];case 5:return t.sent(),this.resetLimboDocuments(),[4,this.remoteStore.applyPrimaryState(!1)];case 6:t.sent(),t.label=7;case 7:return[2]}})})},Cl.prototype.resetLimboDocuments=function(){var e=this;xr(this.limboResolutionsByTarget,function(t){e.remoteStore.unlisten(t)}),this.limboDocumentRefs.removeAllReferences(),this.limboResolutionsByTarget=[],this.limboTargetsByKey=new zi(Ai.comparator)},Cl.prototype.synchronizeQueryViewsAndRaiseSnapshots=function(c){return p(this,void 0,void 0,function(){var e,n,r,i,o,a,s,u;return d(this,function(t){switch(t.label){case 0:e=[],n=[],r=0,i=c,t.label=1;case 1:return r<i.length?(o=i[r],a=void 0,(s=this.queryViewsByTarget[o])?[4,this.localStore.releaseQuery(s.query,!0)]:[3,5]):[3,11];case 2:return t.sent(),[4,this.localStore.allocateQuery(s.query)];case 3:return a=t.sent(),[4,this.synchronizeViewAndComputeSnapshot(s)];case 4:return(u=t.sent()).snapshot&&n.push(u.snapshot),[3,9];case 5:return Cr(!0===this.isPrimary,"A secondary tab should never have an active query without an active view."),[4,this.localStore.getQueryForTarget(o)];case 6:return Cr(!!(u=t.sent()),"Query data for target "+o+" not found"),[4,this.localStore.allocateQuery(u)];case 7:return a=t.sent(),[4,this.initializeViewAndComputeSnapshot(a,!1)];case 8:t.sent(),t.label=9;case 9:e.push(a),t.label=10;case 10:return r++,[3,1];case 11:return this.syncEngineListener.onWatchChange(n),[2,e]}})})},Cl.prototype.getActiveClients=function(){return this.localStore.getActiveClients()},Cl.prototype.applyTargetState=function(s,u,c){return p(this,void 0,void 0,function(){var n,r,i,o,a;return d(this,function(t){switch(t.label){case 0:if(this.isPrimary)return Sr(Tl,"Ignoring unexpected query state notification."),[2];if(!this.queryViewsByTarget[s])return[3,11];switch(u){case"current":case"not-current":return[3,1];case"rejected":return[3,8]}return[3,10];case 1:return t.trys.push([1,4,,8]),[4,this.localStore.getNewDocumentChanges()];case 2:return n=t.sent(),r=Yc.createSynthesizedRemoteEventForCurrentChange(s,"current"===u),[4,this.emitNewSnapsAndNotifyLocalStore(n,r)];case 3:return t.sent(),[3,11];case 4:return(e=i=t.sent()).code===Rr.DATA_LOSS&&e.message===Ss?(o=[],xr(this.queryViewsByTarget,function(t){return o.push(t)}),[4,this.synchronizeQueryViewsAndRaiseSnapshots(o)]):[3,6];case 5:return t.sent(),[3,7];case 6:throw i;case 7:return[3,8];case 8:return a=this.queryViewsByTarget[s],this.removeAndCleanupQuery(a),[4,this.localStore.releaseQuery(a.query,!0)];case 9:return t.sent(),this.syncEngineListener.onWatchError(a.query,c),[3,11];case 10:Ir("Unexpected target state: "+u),t.label=11;case 11:return[2]}var e})})},Cl.prototype.applyActiveTargetsChange=function(l,f){return p(this,void 0,void 0,function(){var e,n,r,i,o,a,s,u,c,h=this;return d(this,function(t){switch(t.label){case 0:if(!this.isPrimary)return[2];e=0,n=l,t.label=1;case 1:return e<n.length?(c=n[e],Cr(!this.queryViewsByTarget[c],"Trying to add an already active target"),[4,this.localStore.getQueryForTarget(c)]):[3,6];case 2:return Cr(!!(r=t.sent()),"Query data for active target "+c+" not found"),[4,this.localStore.allocateQuery(r)];case 3:return i=t.sent(),[4,this.initializeViewAndComputeSnapshot(i,!1)];case 4:t.sent(),this.remoteStore.listen(i),t.label=5;case 5:return e++,[3,1];case 6:o=function(e){var n;return d(this,function(t){switch(t.label){case 0:return(n=a.queryViewsByTarget[e])?[4,a.localStore.releaseQuery(n.query,!1).then(function(){h.remoteStore.unlisten(e),h.removeAndCleanupQuery(n)}).catch(Fu)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})},a=this,s=0,u=f,t.label=7;case 7:return s<u.length?(c=u[s],[5,o(c)]):[3,10];case 8:t.sent(),t.label=9;case 9:return s++,[3,7];case 10:return[2]}})})},Cl.prototype.enableNetwork=function(){return this.localStore.setNetworkEnabled(!0),this.remoteStore.enableNetwork()},Cl.prototype.disableNetwork=function(){return this.localStore.setNetworkEnabled(!1),this.remoteStore.disableNetwork()},Cl.prototype.getRemoteKeysForTarget=function(t){var e=this.limboResolutionsByTarget[t];return e&&e.receivedDocument?co().add(e.key):this.queryViewsByTarget[t]?this.queryViewsByTarget[t].view.syncedDocuments:co()},Cl);function Cl(t,e,n,r){this.localStore=t,this.remoteStore=e,this.sharedClientState=n,this.currentUser=r,this.syncEngineListener=null,this.queryViewsByQuery=new ys(function(t){return t.canonicalId()}),this.queryViewsByTarget={},this.limboTargetsByKey=new zi(Ai.comparator),this.limboResolutionsByTarget={},this.limboDocumentRefs=new Gu,this.mutationUserCallbacks={},this.pendingWritesCallbacks=new Map,this.limboTargetIdGenerator=No.forSyncEngine(),this.isPrimary=void 0,this.onlineState=_c.Unknown}var Dl=(Nl.prototype.isAuthenticated=function(){return null!=this.uid},Nl.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"},Nl.prototype.isEqual=function(t){return t.uid===this.uid},Nl.UNAUTHENTICATED=new Nl(null),Nl.GOOGLE_CREDENTIALS=new Nl("google-credentials-uid"),Nl.FIRST_PARTY=new Nl("first-party-uid"),Nl);function Nl(t){this.uid=t}var Al="SharedClientState",kl="firestore_clients",Rl="firestore_mutations",Ml="firestore_targets",_l=(Ol.fromWebStorageEntry=function(t,e,n){var r=JSON.parse(n),i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error),o=void 0;return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(o=new Mr(r.error.code,r.error.message)),i?new Ol(t,e,r.state,o):(Er(Al,"Failed to parse mutation state for ID '"+e+"': "+n),null)},Ol.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},Ol);function Ol(t,e,n,r){this.user=t,this.batchId=e,this.state=n,Cr(void 0!==(this.error=r)==("rejected"===n),"MutationMetadata must contain an error iff state is 'rejected'")}var Ll=(Pl.fromWebStorageEntry=function(t,e){var n=JSON.parse(e),r="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error),i=void 0;return r&&n.error&&(r="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(i=new Mr(n.error.code,n.error.message)),r?new Pl(t,n.state,i):(Er(Al,"Failed to parse target state for ID '"+t+"': "+e),null)},Pl.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},Pl);function Pl(t,e,n){this.targetId=t,this.state=e,Cr(void 0!==(this.error=n)==("rejected"===e),"QueryTargetMetadata must contain an error iff state is 'rejected'")}var xl=(ql.fromWebStorageEntry=function(t,e){for(var n=JSON.parse(e),r="object"==typeof n&&n.activeTargetIds instanceof Array,i=ho,o=0;r&&o<n.activeTargetIds.length;++o)r=vc(n.activeTargetIds[o]),i=i.add(n.activeTargetIds[o]);return r?new ql(t,i):(Er(Al,"Failed to parse client data for instance '"+t+"': "+e),null)},ql);function ql(t,e){this.clientId=t,this.activeTargetIds=e}var Fl=(Vl.fromWebStorageEntry=function(t){var e=JSON.parse(t);return"object"==typeof e&&e.onlineState in _c&&"string"==typeof e.clientId?new Vl(e.clientId,_c[e.onlineState]):(Er(Al,"Failed to parse online state: "+t),null)},Vl);function Vl(t,e){this.clientId=t,this.onlineState=e}var Bl=(Ul.prototype.addQueryTarget=function(t){Cr(!this.activeTargetIds.has(t),"Target with ID '"+t+"' already active."),this.activeTargetIds=this.activeTargetIds.add(t)},Ul.prototype.removeQueryTarget=function(t){this.activeTargetIds=this.activeTargetIds.delete(t)},Ul.prototype.toWebStorageJSON=function(){var t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)},Ul);function Ul(){this.activeTargetIds=ho}var Ql=(Kl.isAvailable=function(t){return!(!t.window||null==t.window.localStorage)},Kl.prototype.start=function(){return p(this,void 0,void 0,function(){var e,n,r,i,o,a,s,u,c,h,l=this;return d(this,function(t){switch(t.label){case 0:return Cr(!this.started,"WebStorageSharedClientState already started"),Cr(null!==this.syncEngine,"syncEngine property must be set before calling start()"),Cr(null!==this.onlineStateHandler,"onlineStateHandler property must be set before calling start()"),[4,this.syncEngine.getActiveClients()];case 1:for(a=t.sent(),e=0,n=a;e<n.length;e++)(r=n[e])!==this.localClientId&&(i=this.getItem(this.toWebStorageClientStateKey(r)))&&(o=xl.fromWebStorageEntry(r,i))&&(this.activeClients[o.clientId]=o);for(this.persistClientState(),(a=this.storage.getItem(this.onlineStateKey))&&(s=this.fromWebStorageOnlineState(a))&&this.handleOnlineStateEvent(s),u=0,c=this.earlyEvents;u<c.length;u++)h=c[u],this.handleWebStorageEvent(h);return this.earlyEvents=[],this.platform.window.addEventListener("unload",function(){return l.shutdown()}),this.started=!0,[2]}})})},Kl.prototype.writeSequenceNumber=function(t){this.setItem(this.sequenceNumberKey,JSON.stringify(t))},Kl.prototype.getAllActiveQueryTargets=function(){var n=ho;return qr(this.activeClients,function(t,e){n=n.unionWith(e.activeTargetIds)}),n},Kl.prototype.isActiveQueryTarget=function(t){for(var e in this.activeClients)if(this.activeClients.hasOwnProperty(e)&&this.activeClients[e].activeTargetIds.has(t))return!0;return!1},Kl.prototype.addPendingMutation=function(t){this.persistMutationState(t,"pending")},Kl.prototype.updateMutationState=function(t,e,n){this.persistMutationState(t,e,n),this.removeMutationState(t)},Kl.prototype.addLocalQueryTarget=function(t){var e,n="not-current";return this.isActiveQueryTarget(t)&&(!(e=this.storage.getItem(this.toWebStorageQueryTargetMetadataKey(t)))||(e=Ll.fromWebStorageEntry(t,e))&&(n=e.state)),this.localClientState.addQueryTarget(t),this.persistClientState(),n},Kl.prototype.removeLocalQueryTarget=function(t){this.localClientState.removeQueryTarget(t),this.persistClientState()},Kl.prototype.isLocalQueryTarget=function(t){return this.localClientState.activeTargetIds.has(t)},Kl.prototype.clearQueryState=function(t){this.removeItem(this.toWebStorageQueryTargetMetadataKey(t))},Kl.prototype.updateQueryState=function(t,e,n){this.persistQueryTargetState(t,e,n)},Kl.prototype.handleUserChange=function(t,e,n){var r=this;e.forEach(function(t){r.removeMutationState(t)}),this.currentUser=t,n.forEach(function(t){r.addPendingMutation(t)})},Kl.prototype.setOnlineState=function(t){this.persistOnlineState(t)},Kl.prototype.shutdown=function(){this.started&&(this.platform.window.removeEventListener("storage",this.storageListener),this.removeItem(this.localClientStorageKey),this.started=!1)},Kl.prototype.getItem=function(t){var e=this.storage.getItem(t);return Sr(Al,"READ",t,e),e},Kl.prototype.setItem=function(t,e){Sr(Al,"SET",t,e),this.storage.setItem(t,e)},Kl.prototype.removeItem=function(t){Sr(Al,"REMOVE",t),this.storage.removeItem(t)},Kl.prototype.handleWebStorageEvent=function(o){var t=this;o.storageArea===this.storage&&(Sr(Al,"EVENT",o.key,o.newValue),o.key!==this.localClientStorageKey?this.queue.enqueueAndForget(function(){return p(t,void 0,void 0,function(){var e,n,r,i;return d(this,function(t){if(!this.started)return this.earlyEvents.push(o),[2];if(null===o.key)return[2];if(this.clientStateKeyRe.test(o.key)){if(null==o.newValue)return i=this.fromWebStorageClientStateKey(o.key),[2,this.handleClientStateEvent(i,null)];if(i=this.fromWebStorageClientState(o.key,o.newValue))return[2,this.handleClientStateEvent(i.clientId,i)]}else if(this.mutationBatchKeyRe.test(o.key)){if(null!==o.newValue&&(e=this.fromWebStorageMutationMetadata(o.key,o.newValue)))return[2,this.handleMutationBatchEvent(e)]}else if(this.queryTargetKeyRe.test(o.key)){if(null!==o.newValue&&(n=this.fromWebStorageQueryTargetMetadata(o.key,o.newValue)))return[2,this.handleQueryTargetEvent(n)]}else if(o.key===this.onlineStateKey){if(null!==o.newValue&&(r=this.fromWebStorageOnlineState(o.newValue)))return[2,this.handleOnlineStateEvent(r)]}else o.key===this.sequenceNumberKey&&(Cr(!!this.sequenceNumberHandler,"Missing sequenceNumberHandler"),(i=function(t){var e=gi.INVALID;if(null!=t)try{var n=JSON.parse(t);Cr("number"==typeof n,"Found non-numeric sequence number"),e=n}catch(t){Er(Al,"Failed to read sequence number from WebStorage",t)}return e}(o.newValue))!==gi.INVALID&&this.sequenceNumberHandler(i));return[2]})})}):Er("Received WebStorage notification for local change. Another client might have garbage-collected our state"))},Object.defineProperty(Kl.prototype,"localClientState",{get:function(){return this.activeClients[this.localClientId]},enumerable:!0,configurable:!0}),Kl.prototype.persistClientState=function(){this.setItem(this.localClientStorageKey,this.localClientState.toWebStorageJSON())},Kl.prototype.persistMutationState=function(t,e,n){n=new _l(this.currentUser,t,e,n),t=this.toWebStorageMutationBatchKey(t);this.setItem(t,n.toWebStorageJSON())},Kl.prototype.removeMutationState=function(t){t=this.toWebStorageMutationBatchKey(t);this.removeItem(t)},Kl.prototype.persistOnlineState=function(t){t={clientId:this.localClientId,onlineState:_c[t]};this.storage.setItem(this.onlineStateKey,JSON.stringify(t))},Kl.prototype.persistQueryTargetState=function(t,e,n){var r=this.toWebStorageQueryTargetMetadataKey(t),n=new Ll(t,e,n);this.setItem(r,n.toWebStorageJSON())},Kl.prototype.toWebStorageClientStateKey=function(t){return Cr(-1===t.indexOf("_"),"Client key cannot contain '_', but was '"+t+"'"),kl+"_"+this.persistenceKey+"_"+t},Kl.prototype.toWebStorageQueryTargetMetadataKey=function(t){return Ml+"_"+this.persistenceKey+"_"+t},Kl.prototype.toWebStorageMutationBatchKey=function(t){t=Rl+"_"+this.persistenceKey+"_"+t;return this.currentUser.isAuthenticated()&&(t+="_"+this.currentUser.uid),t},Kl.prototype.fromWebStorageClientStateKey=function(t){t=this.clientStateKeyRe.exec(t);return t?t[1]:null},Kl.prototype.fromWebStorageClientState=function(t,e){var n=this.fromWebStorageClientStateKey(t);return Cr(null!==n,"Cannot parse client state key '"+t+"'"),xl.fromWebStorageEntry(n,e)},Kl.prototype.fromWebStorageMutationMetadata=function(t,e){var n=this.mutationBatchKeyRe.exec(t);Cr(null!==n,"Cannot parse mutation batch key '"+t+"'");t=Number(n[1]),n=void 0!==n[2]?n[2]:null;return _l.fromWebStorageEntry(new Dl(n),t,e)},Kl.prototype.fromWebStorageQueryTargetMetadata=function(t,e){var n=this.queryTargetKeyRe.exec(t);Cr(null!==n,"Cannot parse query target key '"+t+"'");n=Number(n[1]);return Ll.fromWebStorageEntry(n,e)},Kl.prototype.fromWebStorageOnlineState=function(t){return Fl.fromWebStorageEntry(t)},Kl.prototype.handleMutationBatchEvent=function(e){return p(this,void 0,void 0,function(){return d(this,function(t){return e.user.uid!==this.currentUser.uid?(Sr(Al,"Ignoring mutation for non-active user "+e.user.uid),[2]):[2,this.syncEngine.applyBatchState(e.batchId,e.state,e.error)]})})},Kl.prototype.handleQueryTargetEvent=function(t){return this.syncEngine.applyTargetState(t.targetId,t.state,t.error)},Kl.prototype.handleClientStateEvent=function(t,e){var n=this,r=this.getAllActiveQueryTargets();e?this.activeClients[t]=e:delete this.activeClients[t];var i=this.getAllActiveQueryTargets(),o=[],a=[];return i.forEach(function(e){return p(n,void 0,void 0,function(){return d(this,function(t){return r.has(e)||o.push(e),[2]})})}),r.forEach(function(e){return p(n,void 0,void 0,function(){return d(this,function(t){return i.has(e)||a.push(e),[2]})})}),this.syncEngine.applyActiveTargetsChange(o,a)},Kl.prototype.handleOnlineStateEvent=function(t){this.activeClients[t.clientId]&&this.onlineStateHandler(t.onlineState)},Kl);function Kl(t,e,n,r,i){if(this.queue=t,this.platform=e,this.persistenceKey=n,this.localClientId=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.activeClients={},this.storageListener=this.handleWebStorageEvent.bind(this),this.started=!1,this.earlyEvents=[],!Kl.isAvailable(this.platform))throw new Mr(Rr.UNIMPLEMENTED,"LocalStorage is not available on this platform.");r=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.platform.window.localStorage,this.currentUser=i,this.localClientStorageKey=this.toWebStorageClientStateKey(this.localClientId),this.sequenceNumberKey="firestore_sequence_number_"+n,this.activeClients[this.localClientId]=new Bl,this.clientStateKeyRe=new RegExp("^"+kl+"_"+r+"_([^_]*)$"),this.mutationBatchKeyRe=new RegExp("^"+Rl+"_"+r+"_(\\d+)(?:_(.*))?$"),this.queryTargetKeyRe=new RegExp("^"+Ml+"_"+r+"_(\\d+)$"),this.onlineStateKey="firestore_online_state_"+n,this.platform.window.addEventListener("storage",this.storageListener)}var jl=(Wl.prototype.addPendingMutation=function(t){},Wl.prototype.updateMutationState=function(t,e,n){},Wl.prototype.addLocalQueryTarget=function(t){return this.localState.addQueryTarget(t),this.queryState[t]||"not-current"},Wl.prototype.updateQueryState=function(t,e,n){this.queryState[t]=e},Wl.prototype.removeLocalQueryTarget=function(t){this.localState.removeQueryTarget(t)},Wl.prototype.isLocalQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},Wl.prototype.clearQueryState=function(t){delete this.queryState[t]},Wl.prototype.getAllActiveQueryTargets=function(){return this.localState.activeTargetIds},Wl.prototype.isActiveQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},Wl.prototype.start=function(){return this.localState=new Bl,Promise.resolve()},Wl.prototype.handleUserChange=function(t,e,n){},Wl.prototype.setOnlineState=function(t){},Wl.prototype.shutdown=function(){},Wl.prototype.writeSequenceNumber=function(t){},Wl);function Wl(){this.localState=new Bl,this.queryState={},this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null}var Gl="FirestoreClient",zl=(Hl.prototype.lruParams=function(){return Iu.withCacheSize(this.cacheSizeBytes)},Hl);function Hl(t,e){this.cacheSizeBytes=t,this.synchronizeTabs=e}function Yl(){}var Xl=(Jl.prototype.start=function(t){var n=this;this.verifyNotTerminated();var r=new Ri,i=new Ri,o=!1;return this.credentials.setChangeListener(function(e){o?n.asyncQueue.enqueueAndForget(function(){return n.handleCredentialChange(e)}):(o=!0,n.initializePersistence(t,i,e).then(function(t){return n.initializeRest(e,t)}).then(r.resolve,r.reject))}),this.asyncQueue.enqueueAndForget(function(){return r.promise}),i.promise},Jl.prototype.enableNetwork=function(){var t=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue(function(){return t.syncEngine.enableNetwork()})},Jl.prototype.initializePersistence=function(t,e,n){var r=this;return t instanceof zl?this.startIndexedDbPersistence(n,t).then(function(t){return e.resolve(),t}).catch(function(t){if(e.reject(t),!r.canFallback(t))throw t;return console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),r.startMemoryPersistence()}):(e.resolve(),this.startMemoryPersistence())},Jl.prototype.canFallback=function(t){return t instanceof Mr?t.code===Rr.FAILED_PRECONDITION||t.code===Rr.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code},Jl.prototype.verifyNotTerminated=function(){if(this.asyncQueue.isShuttingDown)throw new Mr(Rr.FAILED_PRECONDITION,"The client has already been terminated.")},Jl.prototype.startIndexedDbPersistence=function(n,r){var t=this,i=xu.buildStoragePrefix(this.databaseInfo),o=new al(this.databaseInfo.databaseId,{useProto3Json:!0});return Promise.resolve().then(function(){return p(t,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:if(r.synchronizeTabs&&!Ql.isAvailable(this.platform))throw new Mr(Rr.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");return e=r.lruParams(),this.sharedClientState=r.synchronizeTabs?new Ql(this.asyncQueue,this.platform,i,this.clientId,n):new jl,[4,xu.createIndexedDbPersistence({allowTabSynchronization:r.synchronizeTabs,persistenceKey:i,clientId:this.clientId,platform:this.platform,queue:this.asyncQueue,serializer:o,lruParams:e,sequenceNumberSyncer:this.sharedClientState})];case 1:return e=t.sent(),[2,(this.persistence=e).referenceDelegate.garbageCollector]}})})})},Jl.prototype.startMemoryPersistence=function(){return this.persistence=sc.createEagerPersistence(this.clientId),this.sharedClientState=new jl,Promise.resolve(null)},Jl.prototype.initializeRest=function(s,u){var t=this;return Sr(Gl,"Initializing. user=",s.uid),this.platform.loadConnection(this.databaseInfo).then(function(a){return p(t,void 0,void 0,function(){var e,n,r,i,o=this;return d(this,function(t){switch(t.label){case 0:return this.localStore=new Ju(this.persistence,s),u&&(this.lruScheduler=new Du(u,this.asyncQueue,this.localStore)),e=this.platform.newConnectivityMonitor(),i=this.platform.newSerializer(this.databaseInfo.databaseId),n=new Rc(this.asyncQueue,a,this.credentials,i),r=function(t){return o.syncEngine.applyOnlineStateChange(t,Oc.RemoteStore)},i=function(t){return o.syncEngine.applyOnlineStateChange(t,Oc.SharedClientState)},this.remoteStore=new hh(this.localStore,n,this.asyncQueue,r,e),this.syncEngine=new Il(this.localStore,this.remoteStore,this.sharedClientState,s),this.sharedClientState.onlineStateHandler=i,this.remoteStore.syncEngine=this.syncEngine,this.sharedClientState.syncEngine=this.syncEngine,this.eventMgr=new cl(this.syncEngine),[4,this.sharedClientState.start()];case 1:return t.sent(),[4,this.remoteStore.start()];case 2:return t.sent(),[4,this.persistence.setPrimaryStateListener(function(e){return p(o,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return[4,this.syncEngine.applyPrimaryState(e)];case 1:return t.sent(),this.lruScheduler&&(e&&!this.lruScheduler.started?this.lruScheduler.start():e||this.lruScheduler.stop()),[2]}})})})];case 3:return t.sent(),[4,this.persistence.setDatabaseDeletedListener(function(){return p(o,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return[4,this.terminate()];case 1:return t.sent(),[2]}})})})];case 4:return t.sent(),[2]}})})})},Jl.prototype.handleCredentialChange=function(t){return this.asyncQueue.verifyOperationInProgress(),Sr(Gl,"Credential Changed. Current user: "+t.uid),this.syncEngine.handleCredentialChange(t)},Jl.prototype.disableNetwork=function(){var t=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue(function(){return t.syncEngine.disableNetwork()})},Jl.prototype.terminate=function(){var t=this;return this.asyncQueue.enqueueAndInitiateShutdown(function(){return p(t,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return this.lruScheduler&&this.lruScheduler.stop(),[4,this.remoteStore.shutdown()];case 1:return t.sent(),[4,this.sharedClientState.shutdown()];case 2:return t.sent(),[4,this.persistence.shutdown()];case 3:return t.sent(),this.credentials.removeChangeListener(),[2]}})})})},Jl.prototype.waitForPendingWrites=function(){var t=this;this.verifyNotTerminated();var e=new Ri;return this.asyncQueue.enqueueAndForget(function(){return t.syncEngine.registerPendingWritesCallback(e)}),e.promise},Jl.prototype.listen=function(t,e,n){var r=this;this.verifyNotTerminated();var i=new ll(t,e,n);return this.asyncQueue.enqueueAndForget(function(){return r.eventMgr.listen(i)}),i},Jl.prototype.unlisten=function(t){var e=this;this.clientTerminated||this.asyncQueue.enqueueAndForget(function(){return e.eventMgr.unlisten(t)})},Jl.prototype.getDocumentFromLocalCache=function(t){var e=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue(function(){return e.localStore.readDocument(t)}).then(function(t){if(t instanceof us)return t;if(t instanceof ls)return null;throw new Mr(Rr.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")})},Jl.prototype.getDocumentsFromLocalCache=function(n){var t=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue(function(){return t.localStore.executeQuery(n)}).then(function(t){var e=co(),e=new gl(n,e),t=e.computeDocChanges(t);return e.applyChanges(t,!1).snapshot})},Jl.prototype.write=function(t){var e=this;this.verifyNotTerminated();var n=new Ri;return this.asyncQueue.enqueueAndForget(function(){return e.syncEngine.write(t,n)}),n.promise},Jl.prototype.databaseId=function(){return this.databaseInfo.databaseId},Jl.prototype.addSnapshotsInSyncListener=function(t){var e=this;this.verifyNotTerminated(),this.asyncQueue.enqueueAndForget(function(){return e.eventMgr.addSnapshotsInSyncListener(t),Promise.resolve()})},Jl.prototype.removeSnapshotsInSyncListener=function(t){this.clientTerminated||this.eventMgr.removeSnapshotsInSyncListener(t)},Object.defineProperty(Jl.prototype,"clientTerminated",{get:function(){return this.asyncQueue.isShuttingDown},enumerable:!0,configurable:!0}),Jl.prototype.transaction=function(t){var e=this;this.verifyNotTerminated();var n=new Ri;return this.asyncQueue.enqueueAndForget(function(){return e.syncEngine.runTransaction(e.asyncQueue,t,n),Promise.resolve()}),n.promise},Jl);function Jl(t,e,n,r){this.platform=t,this.databaseInfo=e,this.credentials=n,this.asyncQueue=r,this.clientId=ri.newId()}var $l=(Zl.prototype.next=function(t){this.scheduleEvent(this.observer.next,t)},Zl.prototype.error=function(t){this.scheduleEvent(this.observer.error,t)},Zl.prototype.mute=function(){this.muted=!0},Zl.prototype.scheduleEvent=function(t,e){var n=this;this.muted||setTimeout(function(){n.muted||t(e)},0)},Zl);function Zl(t){this.observer=t,this.muted=!1}var tf=(ef.documentId=function(){return ef._DOCUMENT_ID},ef.prototype.isEqual=function(t){if(!(t instanceof ef))throw ti("isEqual","FieldPath",1,t);return this._internalPath.isEqual(t._internalPath)},ef._DOCUMENT_ID=new ef(Di.keyField().canonicalString()),ef);function ef(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];!function(){if(!(t instanceof Array)||t.length<1)throw new Mr(Rr.INVALID_ARGUMENT,"Function FieldPath() requires its fieldNames argument to be an array with at least 1 element.")}();for(var n=0;n<t.length;++n)if(Kr("FieldPath","string",n,t[n]),0===t[n].length)throw new Mr(Rr.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Di(t)}function nf(t,e){this.user=e,this.type="OAuth",this.authHeaders={Authorization:"Bearer "+t}}var rf=new RegExp("[~\\*/\\[\\]]"),of=(af.prototype.getToken=function(){return Promise.resolve(null)},af.prototype.invalidateToken=function(){},af.prototype.setChangeListener=function(t){Cr(!this.changeListener,"Can only call setChangeListener() once."),(this.changeListener=t)(Dl.UNAUTHENTICATED)},af.prototype.removeChangeListener=function(){Cr(null!==this.changeListener,"removeChangeListener() when no listener registered"),this.changeListener=null},af);function af(){this.changeListener=null}var sf=(uf.prototype.getToken=function(){var e=this;Cr(null!=this.tokenListener,"getToken cannot be called after listener removed.");var n=this.tokenCounter,t=this.forceRefresh;return this.forceRefresh=!1,this.app.INTERNAL.getToken(t).then(function(t){if(e.tokenCounter!==n)throw new Mr(Rr.ABORTED,"getToken aborted due to token change.");return t?(Cr("string"==typeof t.accessToken,"Invalid tokenData returned from getToken():"+t),new nf(t.accessToken,e.currentUser)):null})},uf.prototype.invalidateToken=function(){this.forceRefresh=!0},uf.prototype.setChangeListener=function(t){Cr(!this.changeListener,"Can only call setChangeListener() once."),(this.changeListener=t)(this.currentUser)},uf.prototype.removeChangeListener=function(){Cr(null!=this.tokenListener,"removeChangeListener() called twice"),Cr(null!==this.changeListener,"removeChangeListener() called when no listener registered"),this.app.INTERNAL.removeAuthTokenListener(this.tokenListener),this.tokenListener=null,this.changeListener=null},uf.prototype.getUser=function(){var t=this.app.INTERNAL.getUid();return Cr(null===t||"string"==typeof t,"Received invalid UID: "+t),new Dl(t)},uf);function uf(t){var e=this;this.app=t,this.tokenListener=null,this.currentUser=Dl.UNAUTHENTICATED,this.tokenCounter=0,this.changeListener=null,this.forceRefresh=!1,this.tokenListener=function(){e.tokenCounter++,e.currentUser=e.getUser(),e.changeListener&&e.changeListener(e.currentUser)},this.currentUser=this.getUser(),this.tokenCounter=0,this.app.INTERNAL.addAuthTokenListener(this.tokenListener)}var cf=(Object.defineProperty(hf.prototype,"authHeaders",{get:function(){var t={"X-Goog-AuthUser":this.sessionIndex},e=this.gapi.auth.getAuthHeaderValueForFirstParty([]);return e&&(t.Authorization=e),t},enumerable:!0,configurable:!0}),hf);function hf(t,e){this.gapi=t,this.sessionIndex=e,this.type="FirstParty",this.user=Dl.FIRST_PARTY}var lf=(ff.prototype.getToken=function(){return Promise.resolve(new cf(this.gapi,this.sessionIndex))},ff.prototype.setChangeListener=function(t){t(Dl.FIRST_PARTY)},ff.prototype.removeChangeListener=function(){},ff.prototype.invalidateToken=function(){},ff);function ff(t,e){this.gapi=t,this.sessionIndex=e}function pf(i){return function(){if("object"==typeof i&&null!==i)for(var t=i,e=0,n=["next","error","complete"];e<n.length;e++){var r=n[e];if(r in t&&"function"==typeof t[r])return 1}}()}var df=(mf.delete=function(){return Vr("FieldValue.delete",arguments),gf.instance},mf.serverTimestamp=function(){return Vr("FieldValue.serverTimestamp",arguments),wf.instance},mf.arrayUnion=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return Ur("FieldValue.arrayUnion",arguments,1),new Tf(t)},mf.arrayRemove=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return Ur("FieldValue.arrayRemove",arguments,1),new Df(t)},mf.increment=function(t){return Kr("FieldValue.increment","number",1,t),Br("FieldValue.increment",arguments,1),new kf(t)},mf.prototype.isEqual=function(t){return this===t},mf);function mf(t){this._methodName=t}var yf,gf=(a(vf,yf=df),vf.instance=new vf,vf);function vf(){return yf.call(this,"FieldValue.delete")||this}var bf,wf=(a(Sf,bf=df),Sf.instance=new Sf,Sf);function Sf(){return bf.call(this,"FieldValue.serverTimestamp")||this}var Ef,Tf=(a(If,Ef=df),If);function If(t){var e=Ef.call(this,"FieldValue.arrayUnion")||this;return e._elements=t,e}var Cf,Df=(a(Nf,Cf=df),Nf);function Nf(t){var e=Cf.call(this,"FieldValue.arrayRemove")||this;return e._elements=t,e}var Af,kf=(a(Rf,Af=df),Rf);function Rf(t){var e=Af.call(this,"FieldValue.increment")||this;return e._operand=t,e}var Zi=Or(df,"Use FieldValue.<field>() instead."),Mf=/^__.*__$/,_f=(Of.prototype.toMutations=function(t,e){var n=[];return null!==this.fieldMask?n.push(new sa(t,this.data,this.fieldMask,e)):n.push(new ia(t,this.data,e)),0<this.fieldTransforms.length&&n.push(new ha(t,this.fieldTransforms)),n},Of);function Of(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}var Lf,Pf=(xf.prototype.toMutations=function(t,e){e=[new sa(t,this.data,this.fieldMask,e)];return 0<this.fieldTransforms.length&&e.push(new ha(t,this.fieldTransforms)),e},xf);function xf(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}function qf(t){switch(t){case Lf.Set:case Lf.MergeSet:case Lf.Update:return 1;case Lf.Argument:return;default:throw Ir("Unexpected case for UserDataSource: "+t)}}(me=Lf={})[me.Set=0]="Set",me[me.Update=1]="Update",me[me.MergeSet=2]="MergeSet",me[me.Argument=3]="Argument";var Ff=(Vf.prototype.childContextForField=function(t){var e=null==this.path?null:this.path.child(t),e=new Vf(this.dataSource,this.methodName,e,!1,this.fieldTransforms,this.fieldMask);return e.validatePathSegment(t),e},Vf.prototype.childContextForFieldPath=function(t){t=null==this.path?null:this.path.child(t),t=new Vf(this.dataSource,this.methodName,t,!1,this.fieldTransforms,this.fieldMask);return t.validatePath(),t},Vf.prototype.childContextForArray=function(t){return new Vf(this.dataSource,this.methodName,null,!0,this.fieldTransforms,this.fieldMask)},Vf.prototype.createError=function(t){var e=null===this.path||this.path.isEmpty()?"":" (found in field "+this.path.toString()+")";return new Mr(Rr.INVALID_ARGUMENT,"Function "+this.methodName+"() called with invalid data. "+t+e)},Vf.prototype.contains=function(e){return void 0!==this.fieldMask.find(function(t){return e.isPrefixOf(t)})||void 0!==this.fieldTransforms.find(function(t){return e.isPrefixOf(t.field)})},Vf.prototype.validatePath=function(){if(null!==this.path)for(var t=0;t<this.path.length;t++)this.validatePathSegment(this.path.get(t))},Vf.prototype.validatePathSegment=function(t){if(qf(this.dataSource)&&Mf.test(t))throw this.createError("Document fields cannot begin and end with __")},Vf);function Vf(t,e,n,r,i,o){this.dataSource=t,this.methodName=e,this.path=n,this.arrayElement=r,void 0===i&&this.validatePath(),this.arrayElement=void 0!==r&&r,this.fieldTransforms=i||[],this.fieldMask=o||[]}var Bf=function(t,e){this.databaseId=t,this.key=e},Uf=(Qf.prototype.parseSetData=function(t,e){t=new Ff(Lf.Set,t,Di.EMPTY_PATH);jf("Data must be an object, but it was:",t,e);e=this.parseData(e,t);return new _f(e,null,t.fieldTransforms)},Qf.prototype.parseMergeData=function(t,e,n){var r=new Ff(Lf.MergeSet,t,Di.EMPTY_PATH);jf("Data must be an object, but it was:",r,e);var i,o,e=this.parseData(e,r);if(n){for(var a=new eo(Di.comparator),s=0,u=n;s<u.length;s++){var c=u[s],h=void 0;if(c instanceof tf)h=c._internalPath;else{if("string"!=typeof c)throw Ir("Expected stringOrFieldPath to be a string or a FieldPath");h=Gf(t,c)}if(!r.contains(h))throw new Mr(Rr.INVALID_ARGUMENT,"Field '"+h+"' is specified in your field mask but missing from your input data.");a=a.add(h)}i=zo.fromSet(a),o=r.fieldTransforms.filter(function(t){return i.covers(t.field)})}else i=zo.fromArray(r.fieldMask),o=r.fieldTransforms;return new _f(e,i,o)},Qf.prototype.parseUpdateData=function(r,t){var i=this,o=new Ff(Lf.Update,r,Di.EMPTY_PATH);jf("Data must be an object, but it was:",o,t);var a=new eo(Di.comparator),s=es.EMPTY;qr(t,function(t,e){var n=Gf(r,t),t=o.childContextForFieldPath(n);(e=i.runPreConverter(e,t))instanceof gf?a=a.add(n):null!=(t=i.parseData(e,t))&&(a=a.add(n),s=s.set(n,t))});t=zo.fromSet(a);return new Pf(s,t,o.fieldTransforms)},Qf.prototype.parseUpdateVarargs=function(t,e,n,r){var i=new Ff(Lf.Update,t,Di.EMPTY_PATH),o=[Wf(t,e)],a=[n];if(r.length%2!=0)throw new Mr(Rr.INVALID_ARGUMENT,"Function "+t+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var s=0;s<r.length;s+=2)o.push(Wf(t,r[s])),a.push(r[s+1]);for(var u=new eo(Di.comparator),c=es.EMPTY,s=0;s<o.length;++s){var h=o[s],l=i.childContextForFieldPath(h),f=this.runPreConverter(a[s],l);f instanceof gf?u=u.add(h):null!=(l=this.parseData(f,l))&&(u=u.add(h),c=c.set(h,l))}n=zo.fromSet(u);return new Pf(c,n,i.fieldTransforms)},Qf.prototype.parseQueryValue=function(t,e){t=new Ff(Lf.Argument,t,Di.EMPTY_PATH),e=this.parseData(e,t);return Cr(null!=e,"Parsed data should not be null."),Cr(0===t.fieldTransforms.length,"Field transforms should have been disallowed."),e},Qf.prototype.runPreConverter=function(t,e){try{return this.preConverter(t)}catch(t){var n=zf(t);throw e.createError(n)}},Qf.prototype.parseData=function(t,e){if(Kf(t=this.runPreConverter(t,e)))return jf("Unsupported field value:",e,t),this.parseObject(t,e);if(t instanceof df)return this.parseSentinelFieldValue(t,e),null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.arrayElement)throw e.createError("Nested arrays are not supported");return this.parseArray(t,e)}return this.parseScalarValue(t,e)},Qf.prototype.parseObject=function(t,n){var r=this,i=new zi(oi);return Fr(t)?n.path&&0<n.path.length&&n.fieldMask.push(n.path):qr(t,function(t,e){e=r.parseData(e,n.childContextForField(t));null!=e&&(i=i.insert(t,e))}),new es(i)},Qf.prototype.parseArray=function(t,e){for(var n=[],r=0,i=0,o=t;i<o.length;i++){var a=o[i],a=this.parseData(a,e.childContextForArray(r));null==a&&(a=Sa.INSTANCE),n.push(a),r++}return new is(n)},Qf.prototype.parseSentinelFieldValue=function(t,e){if(!qf(e.dataSource))throw e.createError(t._methodName+"() can only be used with update() and set()");if(null===e.path)throw e.createError(t._methodName+"() is not currently supported inside arrays");if(t instanceof gf){if(e.dataSource!==Lf.MergeSet)throw e.dataSource===Lf.Update?(Cr(0<e.path.length,"FieldValue.delete() at the top level should have already been handled."),e.createError("FieldValue.delete() can only appear at the top level of your update data")):e.createError("FieldValue.delete() cannot be used with set() unless you pass {merge:true}");e.fieldMask.push(e.path)}else{var n,r,i;t instanceof wf?e.fieldTransforms.push(new Yo(e.path,jh.instance)):t instanceof Tf?(r=this.parseArrayTransformElements(t._methodName,t._elements),n=new Gh(r),e.fieldTransforms.push(new Yo(e.path,n))):t instanceof Df?(r=this.parseArrayTransformElements(t._methodName,t._elements),i=new Hh(r),e.fieldTransforms.push(new Yo(e.path,i))):t instanceof kf?(i=this.parseQueryValue("FieldValue.increment",t._operand),i=new Xh(i),e.fieldTransforms.push(new Yo(e.path,i))):Ir("Unknown FieldValue type: "+t)}},Qf.prototype.parseScalarValue=function(t,e){if(null===t)return Sa.INSTANCE;if("number"==typeof t)return new(vc(t)?Ma:La)(t);if("boolean"==typeof t)return Ia.of(t);if("string"==typeof t)return new qa(t);if(t instanceof Date)return new Ba(Ki.fromDate(t));if(t instanceof Ki)return new Ba(new Ki(t.seconds,1e3*Math.floor(t.nanoseconds/1e3)));if(t instanceof fh)return new $a(t);if(t instanceof hi)return new Ga(t);if(t instanceof Bf)return new Ya(t.databaseId,t.key);throw e.createError("Unsupported field value: "+Jr(t))},Qf.prototype.parseArrayTransformElements=function(r,t){var i=this;return t.map(function(t,e){var n=new Ff(Lf.Argument,r,Di.EMPTY_PATH);return i.parseData(t,n.childContextForArray(e))})},Qf);function Qf(t){this.preConverter=t}function Kf(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof Ki||t instanceof fh||t instanceof hi||t instanceof Bf||t instanceof df)}function jf(t,e,n){if(!Kf(n)||!Xr(n)){n=Jr(n);throw"an object"===n?e.createError(t+" a custom object"):e.createError(t+" "+n)}}function Wf(t,e){if(e instanceof tf)return e._internalPath;if("string"==typeof e)return Gf(t,e);throw new Mr(Rr.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. Field path arguments must be of type string or FieldPath.")}function Gf(t,e){try{return function(e){if(0<=e.search(rf))throw new Mr(Rr.INVALID_ARGUMENT,"Invalid field path ("+e+"). Paths must not contain '~', '*', '/', '[', or ']'");try{return new(tf.bind.apply(tf,[void 0].concat(e.split("."))))}catch(t){throw new Mr(Rr.INVALID_ARGUMENT,"Invalid field path ("+e+"). Paths must not be empty, begin with '.', end with '.', or contain '..'")}}(e)._internalPath}catch(e){var n=zf(e);throw new Mr(Rr.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. "+n)}}function zf(t){return t instanceof Error?t.message:t.toString()}var Hf=Iu.COLLECTION_DISABLED,Yf=(Xf.prototype.isEqual=function(t){return this.host===t.host&&this.ssl===t.ssl&&this.timestampsInSnapshots===t.timestampsInSnapshots&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.forceLongPolling===t.forceLongPolling},Xf);function Xf(t){if(void 0===t.host){if(void 0!==t.ssl)throw new Mr(Rr.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else Wr("settings","non-empty string","host",t.host),this.host=t.host,Gr("settings","boolean","ssl",t.ssl),this.ssl=Pr(t.ssl,!0);if(Zr("settings",t,["host","ssl","credentials","timestampsInSnapshots","cacheSizeBytes","experimentalForceLongPolling"]),Gr("settings","object","credentials",t.credentials),this.credentials=t.credentials,Gr("settings","boolean","timestampsInSnapshots",t.timestampsInSnapshots),!0===t.timestampsInSnapshots?Er("\n  The timestampsInSnapshots setting now defaults to true and you no\n  longer need to explicitly set it. In a future release, the setting\n  will be removed entirely and so it is recommended that you remove it\n  from your firestore.settings() call now."):!1===t.timestampsInSnapshots&&Er("\n  The timestampsInSnapshots setting will soon be removed. YOU MUST UPDATE\n  YOUR CODE.\n\n  To hide this warning, stop using the timestampsInSnapshots setting in your\n  firestore.settings({ ... }) call.\n\n  Once you remove the setting, Timestamps stored in Cloud Firestore will be\n  read back as Firebase Timestamp objects instead of as system Date objects.\n  So you will also need to update code expecting a Date to instead expect a\n  Timestamp. For example:\n\n  // Old:\n  const date = snapshot.get('created_at');\n  // New:\n  const timestamp = snapshot.get('created_at'); const date =\n  timestamp.toDate();\n\n  Please audit all existing usages of Date when you enable the new\n  behavior."),this.timestampsInSnapshots=Pr(t.timestampsInSnapshots,!0),Gr("settings","number","cacheSizeBytes",t.cacheSizeBytes),void 0===t.cacheSizeBytes)this.cacheSizeBytes=Iu.DEFAULT_CACHE_SIZE_BYTES;else{if(t.cacheSizeBytes!==Hf&&t.cacheSizeBytes<Iu.MINIMUM_CACHE_SIZE_BYTES)throw new Mr(Rr.INVALID_ARGUMENT,"cacheSizeBytes must be at least "+Iu.MINIMUM_CACHE_SIZE_BYTES);this.cacheSizeBytes=t.cacheSizeBytes}Gr("settings","boolean","experimentalForceLongPolling",t.experimentalForceLongPolling),this.forceLongPolling=void 0!==t.experimentalForceLongPolling&&t.experimentalForceLongPolling}var Jf=($f.prototype.settings=function(t){if(Br("Firestore.settings",arguments,1),Kr("Firestore.settings","object",1,t),Lr(t,"persistence"))throw new Mr(Rr.INVALID_ARGUMENT,'"persistence" is now specified with a separate call to firestore.enablePersistence().');t=new Yf(t);if(this._firestoreClient&&!this._settings.isEqual(t))throw new Mr(Rr.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only call settings() before calling any other methods on a Firestore object.");void 0!==(this._settings=t).credentials&&(this._credentials=function(t){if(!t)return new of;switch(t.type){case"gapi":var e=t.client;return Cr(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty),"unexpected gapi interface"),new lf(e,t.sessionIndex||"0");case"provider":return t.client;default:throw new Mr(Rr.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}(t.credentials))},$f.prototype.enableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.enableNetwork()},$f.prototype.disableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.disableNetwork()},$f.prototype.enablePersistence=function(t){if(this._firestoreClient)throw new Mr(Rr.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only call enablePersistence() before calling any other methods on a Firestore object.");var e=!1;return t&&(void 0!==t.experimentalTabSynchronization&&Er("The 'experimentalTabSynchronization' setting has been renamed to 'synchronizeTabs'. In a future release, the setting will be removed and it is recommended that you update your firestore.enablePersistence() call to use 'synchronizeTabs'."),e=Pr(void 0!==t.synchronizeTabs?t.synchronizeTabs:t.experimentalTabSynchronization,!1)),this.configureClient(new zl(this._settings.cacheSizeBytes,e))},$f.prototype.clearPersistence=function(){var t=this,n=xu.buildStoragePrefix(this.makeDatabaseInfo()),r=new Ri;return this._queue.enqueueAndForgetEvenAfterShutdown(function(){return p(t,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:if(t.trys.push([0,2,,3]),void 0!==this._firestoreClient&&!this._firestoreClient.clientTerminated)throw new Mr(Rr.FAILED_PRECONDITION,"Persistence cannot be cleared after this Firestore instance is initialized.");return[4,xu.clearPersistence(n)];case 1:return t.sent(),r.resolve(),[3,3];case 2:return e=t.sent(),r.reject(e),[3,3];case 3:return[2]}})})}),r.promise},$f.prototype.terminate=function(){return this.app._removeServiceInstance("firestore"),this.INTERNAL.delete()},Object.defineProperty($f.prototype,"_isTerminated",{get:function(){return this.ensureClientConfigured(),this._firestoreClient.clientTerminated},enumerable:!0,configurable:!0}),$f.prototype.waitForPendingWrites=function(){return this.ensureClientConfigured(),this._firestoreClient.waitForPendingWrites()},$f.prototype.onSnapshotsInSync=function(t){return this.ensureClientConfigured(),pf(t)?this.onSnapshotsInSyncInternal(t):(Kr("Firestore.onSnapshotsInSync","function",1,t),this.onSnapshotsInSyncInternal({next:t}))},$f.prototype.onSnapshotsInSyncInternal=function(t){var e=this,n=new $l({next:function(){t.next&&t.next()},error:function(t){throw Ir("Uncaught Error in onSnapshotsInSync")}});return this._firestoreClient.addSnapshotsInSyncListener(n),function(){n.mute(),e._firestoreClient.removeSnapshotsInSyncListener(n)}},$f.prototype.ensureClientConfigured=function(){return this._firestoreClient||this.configureClient(new Yl),this._firestoreClient},$f.prototype.makeDatabaseInfo=function(){return new fi(this._databaseId,this._persistenceKey,this._settings.host,this._settings.ssl,this._settings.forceLongPolling)},$f.prototype.configureClient=function(t){Cr(!!this._settings.host,"FirestoreSettings.host is not set"),Cr(!this._firestoreClient,"configureClient() called multiple times");var e=this.makeDatabaseInfo();return this._firestoreClient=new Xl(Dr.getPlatform(),e,this._credentials,this._queue),this._firestoreClient.start(t)},$f.prototype.createDataConverter=function(r){return new Uf(function(t){if(t instanceof rp){var e=r,n=t.firestore._databaseId;if(!n.isEqual(e))throw new Mr(Rr.INVALID_ARGUMENT,"Document reference is for database "+n.projectId+"/"+n.database+" but should be for database "+e.projectId+"/"+e.database);return new Bf(r,t._key)}return t})},$f.databaseIdFromApp=function(t){t=t.options;if(!Lr(t,"projectId"))throw new Mr(Rr.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');t=t.projectId;if(!t||"string"!=typeof t)throw new Mr(Rr.INVALID_ARGUMENT,"projectId must be a string in FirebaseApp.options");return new mi(t)},Object.defineProperty($f.prototype,"app",{get:function(){if(!this._firebaseApp)throw new Mr(Rr.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._firebaseApp},enumerable:!0,configurable:!0}),$f.prototype.collection=function(t){return Br("Firestore.collection",arguments,1),Kr("Firestore.collection","non-empty string",1,t),this.ensureClientConfigured(),new gp(Ei.fromString(t),this)},$f.prototype.doc=function(t){return Br("Firestore.doc",arguments,1),Kr("Firestore.doc","non-empty string",1,t),this.ensureClientConfigured(),rp.forPath(Ei.fromString(t),this)},$f.prototype.collectionGroup=function(t){if(Br("Firestore.collectionGroup",arguments,1),Kr("Firestore.collectionGroup","non-empty string",1,t),0<=t.indexOf("/"))throw new Mr(Rr.INVALID_ARGUMENT,"Invalid collection ID '"+t+"' passed to function Firestore.collectionGroup(). Collection IDs must not contain '/'.");return this.ensureClientConfigured(),new fp(new dh(Ei.EMPTY_PATH,t),this)},$f.prototype.runTransaction=function(e){var n=this;return Br("Firestore.runTransaction",arguments,1),Kr("Firestore.runTransaction","function",1,e),this.ensureClientConfigured().transaction(function(t){return e(new Zf(n,t))})},$f.prototype.batch=function(){return this.ensureClientConfigured(),new ep(this)},Object.defineProperty($f,"logLevel",{get:function(){switch(br()){case hr.DEBUG:return"debug";case hr.ERROR:return"error";case hr.SILENT:return"silent";default:return Ir("Unknown log level: "+br())}},enumerable:!0,configurable:!0}),$f.setLogLevel=function(t){switch(Br("Firestore.setLogLevel",arguments,1),Kr("Firestore.setLogLevel","non-empty string",1,t),t){case"debug":wr(hr.DEBUG);break;case"error":wr(hr.ERROR);break;case"silent":wr(hr.SILENT);break;default:throw new Mr(Rr.INVALID_ARGUMENT,"Invalid log level: "+t)}},$f.prototype._areTimestampsInSnapshotsEnabled=function(){return this._settings.timestampsInSnapshots},$f);function $f(t){var e=this;if(this._firebaseApp=null,this._queue=new Li,this.INTERNAL={delete:function(){return p(e,void 0,void 0,function(){return d(this,function(t){switch(t.label){case 0:return this.ensureClientConfigured(),[4,this._firestoreClient.terminate()];case 1:return t.sent(),[2]}})})}},"object"==typeof t.options){var n=t;this._firebaseApp=n,this._databaseId=$f.databaseIdFromApp(n),this._persistenceKey=n.name,this._credentials=new sf(n)}else{t=t;if(!t.projectId)throw new Mr(Rr.INVALID_ARGUMENT,"Must provide projectId");this._databaseId=new mi(t.projectId,t.database),this._persistenceKey="[DEFAULT]",this._credentials=new of}this._settings=new Yf({}),this._dataConverter=this.createDataConverter(this._databaseId)}var Zf=(tp.prototype.get=function(t){var e=this;Br("Transaction.get",arguments,1);var n=Ep("Transaction.get",t,this._firestore);return this._transaction.lookup([n._key]).then(function(t){if(!t||1!==t.length)return Ir("Mismatch in docs returned from document lookup.");t=t[0];if(t instanceof ls)return new sp(e._firestore,n._key,null,!1,!1);if(t instanceof us)return new sp(e._firestore,n._key,t,!1,!1);throw Ir("BatchGetDocumentsRequest returned unexpected document type: "+t.constructor.name)})},tp.prototype.set=function(t,e,n){Qr("Transaction.set",arguments,2,3);t=Ep("Transaction.set",t,this._firestore),e=(n=bp("Transaction.set",n)).merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("Transaction.set",e,n.mergeFields):this._firestore._dataConverter.parseSetData("Transaction.set",e);return this._transaction.set(t._key,e),this},tp.prototype.update=function(t,e,n){for(var r,i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return e="string"==typeof e||e instanceof tf?(Ur("Transaction.update",arguments,3),r=Ep("Transaction.update",t,this._firestore),this._firestore._dataConverter.parseUpdateVarargs("Transaction.update",e,n,i)):(Br("Transaction.update",arguments,2),r=Ep("Transaction.update",t,this._firestore),this._firestore._dataConverter.parseUpdateData("Transaction.update",e)),this._transaction.update(r._key,e),this},tp.prototype.delete=function(t){Br("Transaction.delete",arguments,1);t=Ep("Transaction.delete",t,this._firestore);return this._transaction.delete(t._key),this},tp);function tp(t,e){this._firestore=t,this._transaction=e}var ep=(np.prototype.set=function(t,e,n){Qr("WriteBatch.set",arguments,2,3),this.verifyNotCommitted();t=Ep("WriteBatch.set",t,this._firestore),e=(n=bp("WriteBatch.set",n)).merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("WriteBatch.set",e,n.mergeFields):this._firestore._dataConverter.parseSetData("WriteBatch.set",e);return this._mutations=this._mutations.concat(e.toMutations(t._key,Zo.NONE)),this},np.prototype.update=function(t,e,n){for(var r,i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return this.verifyNotCommitted(),e="string"==typeof e||e instanceof tf?(Ur("WriteBatch.update",arguments,3),r=Ep("WriteBatch.update",t,this._firestore),this._firestore._dataConverter.parseUpdateVarargs("WriteBatch.update",e,n,i)):(Br("WriteBatch.update",arguments,2),r=Ep("WriteBatch.update",t,this._firestore),this._firestore._dataConverter.parseUpdateData("WriteBatch.update",e)),this._mutations=this._mutations.concat(e.toMutations(r._key,Zo.exists(!0))),this},np.prototype.delete=function(t){Br("WriteBatch.delete",arguments,1),this.verifyNotCommitted();t=Ep("WriteBatch.delete",t,this._firestore);return this._mutations=this._mutations.concat(new ma(t._key,Zo.NONE)),this},np.prototype.commit=function(){return p(this,void 0,void 0,function(){return d(this,function(t){return this.verifyNotCommitted(),this._committed=!0,0<this._mutations.length?[2,this._firestore.ensureClientConfigured().write(this._mutations)]:[2]})})},np.prototype.verifyNotCommitted=function(){if(this._committed)throw new Mr(Rr.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},np);function np(t){this._firestore=t,this._mutations=[],this._committed=!1}var rp=(ip.forPath=function(t,e){if(t.length%2!=0)throw new Mr(Rr.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+t.canonicalString()+" has "+t.length);return new ip(new Ai(t),e)},Object.defineProperty(ip.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(ip.prototype,"parent",{get:function(){return new gp(this._key.path.popLast(),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(ip.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!0,configurable:!0}),ip.prototype.collection=function(t){if(Br("DocumentReference.collection",arguments,1),Kr("DocumentReference.collection","non-empty string",1,t),!t)throw new Mr(Rr.INVALID_ARGUMENT,"Must provide a non-empty collection name to collection()");t=Ei.fromString(t);return new gp(this._key.path.child(t),this.firestore)},ip.prototype.isEqual=function(t){if(!(t instanceof ip))throw ti("isEqual","DocumentReference",1,t);return this.firestore===t.firestore&&this._key.isEqual(t._key)},ip.prototype.set=function(t,e){Qr("DocumentReference.set",arguments,1,2);t=(e=bp("DocumentReference.set",e)).merge||e.mergeFields?this.firestore._dataConverter.parseMergeData("DocumentReference.set",t,e.mergeFields):this.firestore._dataConverter.parseSetData("DocumentReference.set",t);return this._firestoreClient.write(t.toMutations(this._key,Zo.NONE))},ip.prototype.update=function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];return t="string"==typeof t||t instanceof tf?(Ur("DocumentReference.update",arguments,2),this.firestore._dataConverter.parseUpdateVarargs("DocumentReference.update",t,e,n)):(Br("DocumentReference.update",arguments,1),this.firestore._dataConverter.parseUpdateData("DocumentReference.update",t)),this._firestoreClient.write(t.toMutations(this._key,Zo.exists(!0)))},ip.prototype.delete=function(){return Br("DocumentReference.delete",arguments,0),this._firestoreClient.write([new ma(this._key,Zo.NONE)])},ip.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];Qr("DocumentReference.onSnapshot",arguments,1,4);var n={includeMetadataChanges:!1},r=0;"object"!=typeof t[r]||pf(t[r])||(Zr("DocumentReference.onSnapshot",n=t[r],["includeMetadataChanges"]),Gr("DocumentReference.onSnapshot","boolean","includeMetadataChanges",n.includeMetadataChanges),r++);n={includeMetadataChanges:n.includeMetadataChanges},r=pf(t[r])?t[r]:(Kr("DocumentReference.onSnapshot","function",r,t[r]),jr("DocumentReference.onSnapshot","function",r+1,t[r+1]),jr("DocumentReference.onSnapshot","function",r+2,t[r+2]),{next:t[r],error:t[r+1],complete:t[r+2]});return this.onSnapshotInternal(n,r)},ip.prototype.onSnapshotInternal=function(t,n){var r=this,e=function(t){console.error("Uncaught Error in onSnapshot:",t)};n.error&&(e=n.error.bind(n));var i=new $l({next:function(t){var e;n.next&&(Cr(t.docs.size<=1,"Too many documents returned on a document query"),e=t.docs.get(r._key),n.next(new sp(r.firestore,r._key,e,t.fromCache,t.hasPendingWrites)))},error:e}),o=this._firestoreClient.listen(dh.atPath(this._key.path),i,t);return function(){i.mute(),r._firestoreClient.unlisten(o)}},ip.prototype.get=function(n){var r=this;return Qr("DocumentReference.get",arguments,0,1),Sp("DocumentReference.get",n),new Promise(function(e,t){n&&"cache"===n.source?r.firestore.ensureClientConfigured().getDocumentFromLocalCache(r._key).then(function(t){e(new sp(r.firestore,r._key,t,!0,t instanceof us&&t.hasLocalMutations))},t):r.getViaSnapshotListener(e,t,n)})},ip.prototype.getViaSnapshotListener=function(e,n,r){var i=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(t){i(),!t.exists&&t.metadata.fromCache?n(new Mr(Rr.UNAVAILABLE,"Failed to get document because the client is offline.")):t.exists&&t.metadata.fromCache&&r&&"server"===r.source?n(new Mr(Rr.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):e(t)},error:n})},ip);function ip(t,e){this._key=t,this.firestore=e,this._firestoreClient=this.firestore.ensureClientConfigured()}var op=(ap.prototype.isEqual=function(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache},ap);function ap(t,e){this.hasPendingWrites=t,this.fromCache=e}var sp=(up.prototype.data=function(t){return Qr("DocumentSnapshot.data",arguments,0,1),t=wp("DocumentSnapshot.data",t),this._document?this.convertObject(this._document.data(),ga.fromSnapshotOptions(t,this._firestore._areTimestampsInSnapshotsEnabled())):void 0},up.prototype.get=function(t,e){if(Qr("DocumentSnapshot.get",arguments,1,2),e=wp("DocumentSnapshot.get",e),this._document){t=this._document.data().field(Wf("DocumentSnapshot.get",t));if(null!==t)return this.convertValue(t,ga.fromSnapshotOptions(e,this._firestore._areTimestampsInSnapshotsEnabled()))}},Object.defineProperty(up.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(up.prototype,"ref",{get:function(){return new rp(this._key,this._firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(up.prototype,"exists",{get:function(){return null!==this._document},enumerable:!0,configurable:!0}),Object.defineProperty(up.prototype,"metadata",{get:function(){return new op(this._hasPendingWrites,this._fromCache)},enumerable:!0,configurable:!0}),up.prototype.isEqual=function(t){if(!(t instanceof up))throw ti("isEqual","DocumentSnapshot",1,t);return this._firestore===t._firestore&&this._fromCache===t._fromCache&&this._key.isEqual(t._key)&&(null===this._document?null===t._document:this._document.isEqual(t._document))},up.prototype.convertObject=function(t,n){var r=this,i={};return t.forEach(function(t,e){i[t]=r.convertValue(e,n)}),i},up.prototype.convertValue=function(t,e){if(t instanceof es)return this.convertObject(t,e);if(t instanceof is)return this.convertArray(t,e);if(t instanceof Ya){var n=t.value(e),r=this._firestore.ensureClientConfigured().databaseId();return t.databaseId.isEqual(r)||Er("Document "+this._key.path+" contains a document reference within a different database ("+t.databaseId.projectId+"/"+t.databaseId.database+") which is not supported. It will be treated as a reference in the current database ("+r.projectId+"/"+r.database+") instead."),new rp(n,this._firestore)}return t.value(e)},up.prototype.convertArray=function(t,e){var n=this;return t.internalValue.map(function(t){return n.convertValue(t,e)})},up);function up(t,e,n,r,i){this._firestore=t,this._key=e,this._document=n,this._fromCache=r,this._hasPendingWrites=i}var cp,hp=(a(lp,cp=sp),lp.prototype.data=function(t){t=cp.prototype.data.call(this,t);return Cr("object"==typeof t,"Document in a QueryDocumentSnapshot should exist"),t},lp);function lp(){return null!==cp&&cp.apply(this,arguments)||this}var fp=(pp.prototype.where=function(t,e,n){Br("Query.where",arguments,3),$r("Query.where",3,n),"in"!==e&&"array-contains-any"!==e&&function(t,e){if(!t.some(function(t){return t===e}))throw new Mr(Rr.INVALID_ARGUMENT,"Invalid value "+Jr(e)+" provided to function Query.where() for its "+ei(2)+" argument. Acceptable values: "+t.join(", "))}(["<","<=","==",">=",">","array-contains"],e);t=Wf("Query.where",t),e=yh.fromString(e);if(t.isKeyField()){if(e===yh.ARRAY_CONTAINS||e===yh.ARRAY_CONTAINS_ANY)throw new Mr(Rr.INVALID_ARGUMENT,"Invalid Query. You can't perform '"+e.toString()+"' queries on FieldPath.documentId().");if(e===yh.IN){this.validateDisjunctiveFilterElements(n,e);for(var r=[],i=0,o=n;i<o.length;i++){var a=o[i];r.push(this.parseDocumentIdValue(a))}s=new is(r)}else s=this.parseDocumentIdValue(n)}else e!==yh.IN&&e!==yh.ARRAY_CONTAINS_ANY||this.validateDisjunctiveFilterElements(n,e),s=this.firestore._dataConverter.parseQueryValue("Query.where",n);var s=bh.create(t,e,s);return this.validateNewFilter(s),new pp(this._query.addFilter(s),this.firestore)},pp.prototype.orderBy=function(t,e){if(Qr("Query.orderBy",arguments,1,2),jr("Query.orderBy","non-empty string",2,e),void 0===e||"asc"===e)n=xh.ASCENDING;else{if("desc"!==e)throw new Mr(Rr.INVALID_ARGUMENT,"Function Query.orderBy() has unknown direction '"+e+"', expected 'asc' or 'desc'.");n=xh.DESCENDING}if(null!==this._query.startAt)throw new Mr(Rr.INVALID_ARGUMENT,"Invalid query. You must not call Query.startAt() or Query.startAfter() before calling Query.orderBy().");if(null!==this._query.endAt)throw new Mr(Rr.INVALID_ARGUMENT,"Invalid query. You must not call Query.endAt() or Query.endBefore() before calling Query.orderBy().");var t=Wf("Query.orderBy",t),n=new Bh(t,n);return this.validateNewOrderBy(n),new pp(this._query.addOrderBy(n),this.firestore)},pp.prototype.limit=function(t){if(Br("Query.limit",arguments,1),Kr("Query.limit","number",1,t),t<=0)throw new Mr(Rr.INVALID_ARGUMENT,"Invalid Query. Query limit ("+t+") is invalid. Limit must be positive.");return new pp(this._query.withLimit(t),this.firestore)},pp.prototype.startAt=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];Ur("Query.startAt",arguments,1);t=this.boundFromDocOrFields("Query.startAt",t,e,!0);return new pp(this._query.withStartAt(t),this.firestore)},pp.prototype.startAfter=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];Ur("Query.startAfter",arguments,1);t=this.boundFromDocOrFields("Query.startAfter",t,e,!1);return new pp(this._query.withStartAt(t),this.firestore)},pp.prototype.endBefore=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];Ur("Query.endBefore",arguments,1);t=this.boundFromDocOrFields("Query.endBefore",t,e,!0);return new pp(this._query.withEndAt(t),this.firestore)},pp.prototype.endAt=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];Ur("Query.endAt",arguments,1);t=this.boundFromDocOrFields("Query.endAt",t,e,!1);return new pp(this._query.withEndAt(t),this.firestore)},pp.prototype.isEqual=function(t){if(!(t instanceof pp))throw ti("isEqual","Query",1,t);return this.firestore===t.firestore&&this._query.isEqual(t._query)},pp.prototype.boundFromDocOrFields=function(t,e,n,r){if($r(t,1,e),e instanceof sp){if(0<n.length)throw new Mr(Rr.INVALID_ARGUMENT,"Too many arguments provided to "+t+"().");var i=e;if(!i.exists)throw new Mr(Rr.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+t+"().");return this.boundFromDocument(t,i._document,r)}n=[e].concat(n);return this.boundFromFields(t,n,r)},pp.prototype.boundFromDocument=function(t,e,n){for(var r=[],i=0,o=this._query.orderBy;i<o.length;i++){var a=o[i];if(a.field.isKeyField())r.push(new Ya(this.firestore._databaseId,e.key));else{var s=e.field(a.field);if(s instanceof Ka)throw new Mr(Rr.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+a.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===s){a=a.field.canonicalString();throw new Mr(Rr.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+a+"' (used as the orderBy) does not exist.")}r.push(s)}}return new Fh(r,n)},pp.prototype.boundFromFields=function(t,e,n){var r=this._query.explicitOrderBy;if(e.length>r.length)throw new Mr(Rr.INVALID_ARGUMENT,"Too many arguments provided to "+t+"(). The number of arguments must be less than or equal to the number of Query.orderBy() clauses");for(var i=[],o=0;o<e.length;o++){var a=e[o];if(r[o].field.isKeyField()){if("string"!=typeof a)throw new Mr(Rr.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+t+"(), but got a "+typeof a);if(!this._query.isCollectionGroupQuery()&&-1!==a.indexOf("/"))throw new Mr(Rr.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to "+t+"() must be a plain document ID, but '"+a+"' contains a slash.");var s=this._query.path.child(Ei.fromString(a));if(!Ai.isDocumentKey(s))throw new Mr(Rr.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to "+t+"() must result in a valid document path, but '"+s+"' is not because it contains an odd number of segments.");s=new Ai(s);i.push(new Ya(this.firestore._databaseId,s))}else{a=this.firestore._dataConverter.parseQueryValue(t,a);i.push(a)}}return new Fh(i,n)},pp.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];Qr("Query.onSnapshot",arguments,1,4);var n={},r=0;return"object"!=typeof t[r]||pf(t[r])||(Zr("Query.onSnapshot",n=t[r],["includeMetadataChanges"]),Gr("Query.onSnapshot","boolean","includeMetadataChanges",n.includeMetadataChanges),r++),r=pf(t[r])?t[r]:(Kr("Query.onSnapshot","function",r,t[r]),jr("Query.onSnapshot","function",r+1,t[r+1]),jr("Query.onSnapshot","function",r+2,t[r+2]),{next:t[r],error:t[r+1],complete:t[r+2]}),this.onSnapshotInternal(n,r)},pp.prototype.onSnapshotInternal=function(t,e){var n=this,r=function(t){console.error("Uncaught Error in onSnapshot:",t)};e.error&&(r=e.error.bind(e));var i=new $l({next:function(t){e.next&&e.next(new dp(n.firestore,n._query,t))},error:r}),o=this.firestore.ensureClientConfigured(),a=o.listen(this._query,i,t);return function(){i.mute(),o.unlisten(a)}},pp.prototype.get=function(n){var r=this;return Qr("Query.get",arguments,0,1),Sp("Query.get",n),new Promise(function(e,t){n&&"cache"===n.source?r.firestore.ensureClientConfigured().getDocumentsFromLocalCache(r._query).then(function(t){e(new dp(r.firestore,r._query,t))},t):r.getViaSnapshotListener(e,t,n)})},pp.prototype.getViaSnapshotListener=function(e,n,r){var i=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(t){i(),t.metadata.fromCache&&r&&"server"===r.source?n(new Mr(Rr.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):e(t)},error:n})},pp.prototype.parseDocumentIdValue=function(t){if("string"==typeof t){if(""===t)throw new Mr(Rr.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!this._query.isCollectionGroupQuery()&&-1!==t.indexOf("/"))throw new Mr(Rr.INVALID_ARGUMENT,"Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '"+t+"' contains a '/' character.");var e=this._query.path.child(Ei.fromString(t));if(!Ai.isDocumentKey(e))throw new Mr(Rr.INVALID_ARGUMENT,"Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '"+e+"' is not because it has an odd number of segments ("+e.length+").");return new Ya(this.firestore._databaseId,new Ai(e))}if(t instanceof rp)return new Ya(this.firestore._databaseId,t._key);throw new Mr(Rr.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: "+Jr(t)+".")},pp.prototype.validateDisjunctiveFilterElements=function(t,e){if(!Array.isArray(t)||0===t.length)throw new Mr(Rr.INVALID_ARGUMENT,"Invalid Query. A non-empty array is required for '"+e.toString()+"' filters.");if(10<t.length)throw new Mr(Rr.INVALID_ARGUMENT,"Invalid Query. '"+e.toString()+"' filters support a maximum of 10 elements in the value array.");if(0<=t.indexOf(null))throw new Mr(Rr.INVALID_ARGUMENT,"Invalid Query. '"+e.toString()+"' filters cannot contain 'null' in the value array.");if(0<t.filter(function(t){return Number.isNaN(t)}).length)throw new Mr(Rr.INVALID_ARGUMENT,"Invalid Query. '"+e.toString()+"' filters cannot contain 'NaN' in the value array.")},pp.prototype.validateNewFilter=function(t){if(t instanceof bh){var e=[yh.ARRAY_CONTAINS,yh.ARRAY_CONTAINS_ANY],n=[yh.IN,yh.ARRAY_CONTAINS_ANY],r=0<=e.indexOf(t.op),i=0<=n.indexOf(t.op);if(t.isInequality()){var o=this._query.getInequalityFilterField();if(null!==o&&!o.isEqual(t.field))throw new Mr(Rr.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, >, or >=) must be on the same field. But you have inequality filters on '"+o.toString()+"' and '"+t.field.toString()+"'");o=this._query.getFirstOrderByField();null!==o&&this.validateOrderByAndInequalityMatch(t.field,o)}else if(i||r){o=null;if(null!=(o=null===(o=i?this._query.findFilterOperator(n):o)&&r?this._query.findFilterOperator(e):o))throw o===t.op?new Mr(Rr.INVALID_ARGUMENT,"Invalid query. You cannot use more than one '"+t.op.toString()+"' filter."):new Mr(Rr.INVALID_ARGUMENT,"Invalid query. You cannot use '"+t.op.toString()+"' filters with '"+o.toString()+"' filters.")}}},pp.prototype.validateNewOrderBy=function(t){var e;null!==this._query.getFirstOrderByField()||null!==(e=this._query.getInequalityFilterField())&&this.validateOrderByAndInequalityMatch(e,t.field)},pp.prototype.validateOrderByAndInequalityMatch=function(t,e){if(!e.isEqual(t))throw new Mr(Rr.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, >, or >=) on field '"+t.toString()+"' and so you must also use '"+t.toString()+"' as your first Query.orderBy(), but your first Query.orderBy() is on field '"+e.toString()+"' instead.")},pp);function pp(t,e){this._query=t,this.firestore=e}var dp=(Object.defineProperty(mp.prototype,"docs",{get:function(){var e=[];return this.forEach(function(t){return e.push(t)}),e},enumerable:!0,configurable:!0}),Object.defineProperty(mp.prototype,"empty",{get:function(){return this._snapshot.docs.isEmpty()},enumerable:!0,configurable:!0}),Object.defineProperty(mp.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!0,configurable:!0}),mp.prototype.forEach=function(e,n){var r=this;Qr("QuerySnapshot.forEach",arguments,1,2),Kr("QuerySnapshot.forEach","function",1,e),this._snapshot.docs.forEach(function(t){e.call(n,r.convertToDocumentImpl(t))})},Object.defineProperty(mp.prototype,"query",{get:function(){return new fp(this._originalQuery,this._firestore)},enumerable:!0,configurable:!0}),mp.prototype.docChanges=function(t){t&&(Zr("QuerySnapshot.docChanges",t,["includeMetadataChanges"]),Gr("QuerySnapshot.docChanges","boolean","includeMetadataChanges",t.includeMetadataChanges));t=!(!t||!t.includeMetadataChanges);if(t&&this._snapshot.excludesMetadataChanges)throw new Mr(Rr.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(i,e,o){if(o.oldDocs.isEmpty()){var n,r=0;return o.docChanges.map(function(t){var e=new hp(i,t.doc.key,t.doc,o.fromCache,o.mutatedKeys.has(t.doc.key));return Cr(t.type===Uc.Added,"Invalid event type for first snapshot"),Cr(!n||o.query.docComparator(n,t.doc)<0,"Got added events in wrong order"),n=t.doc,{type:"added",doc:e,oldIndex:-1,newIndex:r++}})}var a=o.oldDocs;return o.docChanges.filter(function(t){return e||t.type!==Uc.Metadata}).map(function(t){var e=new hp(i,t.doc.key,t.doc,o.fromCache,o.mutatedKeys.has(t.doc.key)),n=-1,r=-1;return t.type!==Uc.Added&&(Cr(0<=(n=a.indexOf(t.doc.key)),"Index for document not found"),a=a.delete(t.doc.key)),t.type!==Uc.Removed&&(r=(a=a.add(t.doc)).indexOf(t.doc.key)),{type:function(t){switch(t){case Uc.Added:return"added";case Uc.Modified:case Uc.Metadata:return"modified";case Uc.Removed:return"removed";default:return Ir("Unknown change type: "+t)}}(t.type),doc:e,oldIndex:n,newIndex:r}})}(this._firestore,t,this._snapshot),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges},mp.prototype.isEqual=function(t){if(!(t instanceof mp))throw ti("isEqual","QuerySnapshot",1,t);return this._firestore===t._firestore&&this._originalQuery.isEqual(t._originalQuery)&&this._snapshot.isEqual(t._snapshot)},mp.prototype.convertToDocumentImpl=function(t){return new hp(this._firestore,t.key,t,this.metadata.fromCache,this._snapshot.mutatedKeys.has(t.key))},mp);function mp(t,e,n){this._firestore=t,this._originalQuery=e,this._snapshot=n,this._cachedChanges=null,this._cachedChangesIncludeMetadataChanges=null,this.metadata=new op(n.hasPendingWrites,n.fromCache)}["length","forEach","map"].concat("undefined"!=typeof Symbol?[Symbol.iterator]:[]).forEach(function(t){try{Object.defineProperty(dp.prototype.docChanges,t,{get:function(){throw new Mr(Rr.INVALID_ARGUMENT,'QuerySnapshot.docChanges has been changed from a property into a method, so usages like "querySnapshot.docChanges" should become "querySnapshot.docChanges()"')}})}catch(t){}});var yp,gp=(a(vp,yp=fp),Object.defineProperty(vp.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(vp.prototype,"parent",{get:function(){var t=this._query.path.popLast();return t.isEmpty()?null:new rp(new Ai(t),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(vp.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!0,configurable:!0}),vp.prototype.doc=function(t){if(Qr("CollectionReference.doc",arguments,0,1),Kr("CollectionReference.doc","non-empty string",1,t=0===arguments.length?ri.newId():t),""===t)throw new Mr(Rr.INVALID_ARGUMENT,"Document path must be a non-empty string");t=Ei.fromString(t);return rp.forPath(this._query.path.child(t),this.firestore)},vp.prototype.add=function(t){Br("CollectionReference.add",arguments,1),Kr("CollectionReference.add","object",1,t);var e=this.doc();return e.set(t).then(function(){return e})},vp);function vp(t,e){e=yp.call(this,dh.atPath(t),e)||this;if(t.length%2!=1)throw new Mr(Rr.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+t.canonicalString()+" has "+t.length);return e}function bp(t,e){if(void 0===e)return{merge:!1};if(Zr(t,e,["merge","mergeFields"]),Gr(t,"boolean","merge",e.merge),zr(t,"mergeFields","a string or a FieldPath",e.mergeFields,function(t){return"string"==typeof t||t instanceof tf}),void 0!==e.mergeFields&&void 0!==e.merge)throw new Mr(Rr.INVALID_ARGUMENT,"Invalid options passed to function "+t+'(): You cannot specify both "merge" and "mergeFields".');return e}function wp(t,e){return void 0===e?{}:(Zr(t,e,["serverTimestamps"]),Hr(t,0,"serverTimestamps",e.serverTimestamps,["estimate","previous","none"]),e)}function Sp(t,e){jr(t,"object",1,e),e&&(Zr(t,e,["source"]),Hr(t,0,"source",e.source,["default","server","cache"]))}function Ep(t,e,n){if(e instanceof rp){if(e.firestore!==n)throw new Mr(Rr.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}throw ti(t,"DocumentReference",1,e)}var cr=Or(Jf,"Use firebase.firestore() instead."),he=Or(Zf,"Use firebase.firestore().runTransaction() instead."),le=Or(ep,"Use firebase.firestore().batch() instead."),lr=Or(rp,"Use firebase.firestore().doc() instead."),t=Or(sp),g=Or(hp),vs=Or(fp),ct=Or(dp),me=Or(gp,"Use firebase.firestore().collection() instead."),Tp={Firestore:cr,GeoPoint:fh,Timestamp:Ki,Blob:pi,Transaction:he,WriteBatch:le,DocumentReference:lr,DocumentSnapshot:t,Query:vs,QueryDocumentSnapshot:g,QuerySnapshot:ct,CollectionReference:me,FieldPath:tf,FieldValue:Zi,setLogLevel:Jf.setLogLevel,CACHE_SIZE_UNLIMITED:Hf};var Ip=(Cp.prototype.addCallback=function(t){},Cp.prototype.shutdown=function(){},Cp);function Cp(){}var Dp="ConnectivityMonitor",Np=(Ap.prototype.addCallback=function(t){this.callbacks.push(t)},Ap.prototype.shutdown=function(){window.removeEventListener("online",this.networkAvailableListener),window.removeEventListener("offline",this.networkUnavailableListener)},Ap.prototype.configureNetworkMonitoring=function(){window.addEventListener("online",this.networkAvailableListener),window.addEventListener("offline",this.networkUnavailableListener)},Ap.prototype.onNetworkAvailable=function(){Sr(Dp,"Network connectivity changed: AVAILABLE");for(var t=0,e=this.callbacks;t<e.length;t++)(0,e[t])(0)},Ap.prototype.onNetworkUnavailable=function(){Sr(Dp,"Network connectivity changed: UNAVAILABLE");for(var t=0,e=this.callbacks;t<e.length;t++)(0,e[t])(1)},Ap.isAvailable=function(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener},Ap);function Ap(){var t=this;this.networkAvailableListener=function(){return t.onNetworkAvailable()},this.networkUnavailableListener=function(){return t.onNetworkUnavailable()},this.callbacks=[],this.configureNetworkMonitoring()}var kp=(Rp.prototype.onOpen=function(t){Cr(!this.wrappedOnOpen,"Called onOpen on stream twice!"),this.wrappedOnOpen=t},Rp.prototype.onClose=function(t){Cr(!this.wrappedOnClose,"Called onClose on stream twice!"),this.wrappedOnClose=t},Rp.prototype.onMessage=function(t){Cr(!this.wrappedOnMessage,"Called onMessage on stream twice!"),this.wrappedOnMessage=t},Rp.prototype.close=function(){this.closeFn()},Rp.prototype.send=function(t){this.sendFn(t)},Rp.prototype.callOnOpen=function(){Cr(void 0!==this.wrappedOnOpen,"Cannot call onOpen because no callback was set"),this.wrappedOnOpen()},Rp.prototype.callOnClose=function(t){Cr(void 0!==this.wrappedOnClose,"Cannot call onClose because no callback was set"),this.wrappedOnClose(t)},Rp.prototype.callOnMessage=function(t){Cr(void 0!==this.wrappedOnMessage,"Cannot call onMessage because no callback was set"),this.wrappedOnMessage(t)},Rp);function Rp(t){this.sendFn=t.sendFn,this.closeFn=t.closeFn}var Mp="Connection",_p={BatchGetDocuments:"batchGet",Commit:"commit"},Op="gl-js/ fire/"+gr,Lp=(Pp.prototype.modifyHeadersForRequest=function(t,e){if(e)for(var n in e.authHeaders)e.authHeaders.hasOwnProperty(n)&&(t[n]=e.authHeaders[n]);t["X-Goog-Api-Client"]=Op},Pp.prototype.invokeRPC=function(u,n,r){var i=this,c=this.makeUrl(u);return new Promise(function(o,a){var s=new yr;s.listenOnce(dr.COMPLETE,function(){try{switch(s.getLastErrorCode()){case pr.NO_ERROR:var t=s.getResponseJson();Sr(Mp,"XHR received:",JSON.stringify(t)),o(t);break;case pr.TIMEOUT:Sr(Mp,'RPC "'+u+'" timed out'),a(new Mr(Rr.DEADLINE_EXCEEDED,"Request time out"));break;case pr.HTTP_ERROR:var e,n,r=s.getStatus();Sr(Mp,'RPC "'+u+'" failed with status:',r,"response text:",s.getResponseText()),0<r?(e=s.getResponseJson().error)&&e.status&&e.message?(i=e.status.toLowerCase().replace("_","-"),n=0<=Object.values(Rr).indexOf(i)?i:Rr.UNKNOWN,a(new Mr(n,e.message))):a(new Mr(Rr.UNKNOWN,"Server responded with status "+s.getStatus())):(Sr(Mp,'RPC "'+u+'" failed'),a(new Mr(Rr.UNAVAILABLE,"Connection failed.")));break;default:Ir('RPC "'+u+'" failed with unanticipated webchannel error '+s.getLastErrorCode()+": "+s.getLastError()+", giving up.")}}finally{Sr(Mp,'RPC "'+u+'" completed.')}var i});var t=h({},n);delete t.database;var e=JSON.stringify(t);Sr(Mp,"XHR sending: ",c+" "+e);t={"Content-Type":"text/plain"};i.modifyHeadersForRequest(t,r),s.send(c,"POST",e,t,15)})},Pp.prototype.invokeStreamingRPC=function(t,e,n){return this.invokeRPC(t,e,n)},Pp.prototype.openStream=function(t,e){var n=[this.baseUrl,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=fr(),t={backgroundChannelTest:!0,httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling};this.modifyHeadersForRequest(t.initMessageHeaders,e),"object"==typeof navigator&&"ReactNative"===navigator.product||(t.httpHeadersOverwriteParam="$httpHeaders");n=n.join("");function i(t,e){o.listen(t,function(t){try{e(t)}catch(t){setTimeout(function(){throw t},0)}})}Sr(Mp,"Creating WebChannel: "+n+" "+t);var o=r.createWebChannel(n,t),a=!1,s=!1,u=new kp({sendFn:function(t){s?Sr(Mp,"Not sending because WebChannel is closed:",t):(a||(Sr(Mp,"Opening WebChannel transport."),o.open(),a=!0),Sr(Mp,"WebChannel sending:",t),o.send(t))},closeFn:function(){return o.close()}});return i(mr.EventType.OPEN,function(){s||Sr(Mp,"WebChannel transport opened.")}),i(mr.EventType.CLOSE,function(){s||(s=!0,Sr(Mp,"WebChannel transport closed"),u.callOnClose())}),i(mr.EventType.ERROR,function(t){s||(s=!0,Sr(Mp,"WebChannel transport errored:",t),u.callOnClose(new Mr(Rr.UNAVAILABLE,"The operation could not be completed")))}),i(mr.EventType.MESSAGE,function(t){var e,n,r,i;s||(Cr(!!(e=t.data[0]),"Got a webchannel message without data."),(n=e.error||e[0]&&e[0].error)?(Sr(Mp,"WebChannel received error:",n),r=n.status,i=function(){var t=xc[r];if(void 0!==t)return Bc(t)}(),t=n.message,void 0===i&&(i=Rr.INTERNAL,t="Unknown error status: "+r+" with message "+n.message),s=!0,u.callOnClose(new Mr(i,t)),o.close()):(Sr(Mp,"WebChannel received:",e),u.callOnMessage(e)))}),setTimeout(function(){u.callOnOpen()},0),u},Pp.prototype.makeUrl=function(t){var e=_p[t];Cr(void 0!==e,"Unknown REST mapping for: "+t);t=[this.baseUrl,"/","v1"];return t.push("/projects/"),t.push(this.databaseId.projectId),t.push("/databases/"),t.push(this.databaseId.database),t.push("/documents"),t.push(":"),t.push(e),t.join("")},Pp);function Pp(t){this.databaseId=t.databaseId;var e=t.ssl?"https":"http";this.baseUrl=e+"://"+t.host,this.forceLongPolling=t.forceLongPolling}Object.defineProperty(xp.prototype,"document",{get:function(){return"undefined"!=typeof document?document:null},enumerable:!0,configurable:!0}),Object.defineProperty(xp.prototype,"window",{get:function(){return"undefined"!=typeof window?window:null},enumerable:!0,configurable:!0}),xp.prototype.loadConnection=function(t){return Promise.resolve(new Lp(t))},xp.prototype.newConnectivityMonitor=function(){return new(Np.isAvailable()?Np:Ip)},xp.prototype.newSerializer=function(t){return new al(t,{useProto3Json:!0})},xp.prototype.formatJSON=function(t){return JSON.stringify(t)},xp.prototype.atob=function(t){return atob(t)},xp.prototype.btoa=function(t){return btoa(t)},Zi=xp;function xp(){this.emptyByteString="",this.base64Available="undefined"!=typeof atob}Dr.setPlatform(new Zi),qp.INTERNAL.registerService("firestore",function(t){return new Jf(t)},function(t){Cr("object"==typeof t,"shallowCopy() expects object parameter.");var e,n={};for(e in t)Object.prototype.hasOwnProperty.call(t,e)&&(n[e]=t[e]);return n}(Tp))}.apply(this,arguments)}catch(t){throw console.error(t),new Error("Cannot instantiate firebase-firestore - be sure to load firebase-app.js first.")}});
